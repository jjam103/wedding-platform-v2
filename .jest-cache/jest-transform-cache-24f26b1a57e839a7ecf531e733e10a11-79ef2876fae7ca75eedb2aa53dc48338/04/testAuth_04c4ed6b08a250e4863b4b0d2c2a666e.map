{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/helpers/testAuth.ts"],"sourcesContent":["/**\n * Test Authentication Helpers\n * \n * Utilities for handling authentication in tests.\n * Provides helpers for creating authenticated requests, managing sessions, and testing auth flows.\n */\n\nimport { createTestClient, createAndSignInTestUser, type TestUser } from './testDb';\n\n/**\n * Create an authenticated fetch request for API testing\n * \n * @param url - API endpoint URL\n * @param options - Fetch options\n * @param accessToken - Access token for authentication\n * @returns Fetch response\n */\nexport async function authenticatedFetch(\n  url: string,\n  options: RequestInit = {},\n  accessToken: string\n): Promise<Response> {\n  const headers = new Headers(options.headers);\n  headers.set('Authorization', `Bearer ${accessToken}`);\n  headers.set('Content-Type', 'application/json');\n  \n  return fetch(url, {\n    ...options,\n    headers,\n  });\n}\n\n/**\n * Create an authenticated API request for testing\n * \n * @param path - API path (e.g., '/api/admin/guests')\n * @param options - Request options\n * @param accessToken - Access token for authentication\n * @returns Response object\n */\nexport async function authenticatedApiRequest(\n  path: string,\n  options: {\n    method?: string;\n    body?: any;\n    headers?: Record<string, string>;\n  } = {},\n  accessToken: string\n): Promise<Response> {\n  const { method = 'GET', body, headers = {} } = options;\n  \n  const url = `http://localhost:3000${path}`;\n  \n  return authenticatedFetch(\n    url,\n    {\n      method,\n      headers: {\n        ...headers,\n        Authorization: `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n      },\n      body: body ? JSON.stringify(body) : undefined,\n    },\n    accessToken\n  );\n}\n\n/**\n * Create a mock authenticated request for route handler testing\n * \n * @param path - Request path\n * @param options - Request options\n * @param accessToken - Access token for authentication\n * @returns Request object\n */\nexport function createAuthenticatedRequest(\n  path: string,\n  options: {\n    method?: string;\n    body?: any;\n    searchParams?: Record<string, string>;\n  } = {},\n  accessToken: string\n): Request {\n  const { method = 'GET', body, searchParams = {} } = options;\n  \n  const url = new URL(path, 'http://localhost:3000');\n  Object.entries(searchParams).forEach(([key, value]) => {\n    url.searchParams.set(key, value);\n  });\n  \n  const headers = new Headers({\n    'Content-Type': 'application/json',\n    'Authorization': `Bearer ${accessToken}`,\n  });\n  \n  return new Request(url.toString(), {\n    method,\n    headers,\n    body: body ? JSON.stringify(body) : undefined,\n  });\n}\n\n/**\n * Create an unauthenticated request for testing auth failures\n * \n * @param path - Request path\n * @param options - Request options\n * @returns Request object\n */\nexport function createUnauthenticatedRequest(\n  path: string,\n  options: {\n    method?: string;\n    body?: any;\n    searchParams?: Record<string, string>;\n  } = {}\n): Request {\n  const { method = 'GET', body, searchParams = {} } = options;\n  \n  const url = new URL(path, 'http://localhost:3000');\n  Object.entries(searchParams).forEach(([key, value]) => {\n    url.searchParams.set(key, value);\n  });\n  \n  const headers = new Headers({\n    'Content-Type': 'application/json',\n  });\n  \n  return new Request(url.toString(), {\n    method,\n    headers,\n    body: body ? JSON.stringify(body) : undefined,\n  });\n}\n\n/**\n * Test authentication context for managing auth state in tests\n */\nexport class TestAuthContext {\n  private user: TestUser | null = null;\n  \n  /**\n   * Sign in and store user context\n   */\n  async signIn(): Promise<TestUser> {\n    this.user = await createAndSignInTestUser();\n    return this.user;\n  }\n  \n  /**\n   * Get current user\n   */\n  getUser(): TestUser | null {\n    return this.user;\n  }\n  \n  /**\n   * Get access token\n   */\n  getAccessToken(): string {\n    if (!this.user?.accessToken) {\n      throw new Error('No authenticated user. Call signIn() first.');\n    }\n    return this.user.accessToken;\n  }\n  \n  /**\n   * Create authenticated request\n   */\n  createRequest(\n    path: string,\n    options: {\n      method?: string;\n      body?: any;\n      searchParams?: Record<string, string>;\n    } = {}\n  ): Request {\n    return createAuthenticatedRequest(path, options, this.getAccessToken());\n  }\n  \n  /**\n   * Make authenticated API request\n   */\n  async apiRequest(\n    path: string,\n    options: {\n      method?: string;\n      body?: any;\n      headers?: Record<string, string>;\n    } = {}\n  ): Promise<Response> {\n    return authenticatedApiRequest(path, options, this.getAccessToken());\n  }\n  \n  /**\n   * Sign out and clear context\n   */\n  signOut(): void {\n    this.user = null;\n  }\n  \n  /**\n   * Check if authenticated\n   */\n  isAuthenticated(): boolean {\n    return this.user !== null && this.user.accessToken !== undefined;\n  }\n}\n\n/**\n * Create a test auth context\n */\nexport function createTestAuthContext(): TestAuthContext {\n  return new TestAuthContext();\n}\n\n/**\n * Helper to run a test with authenticated context\n */\nexport async function withAuthContext<T>(\n  fn: (auth: TestAuthContext) => Promise<T>\n): Promise<T> {\n  const auth = createTestAuthContext();\n  await auth.signIn();\n  \n  try {\n    return await fn(auth);\n  } finally {\n    auth.signOut();\n  }\n}\n\n/**\n * Mock session for testing components that use useSession\n */\nexport function createMockSession(user?: Partial<TestUser>) {\n  return {\n    user: {\n      id: user?.id || 'test-user-id',\n      email: user?.email || 'test@example.com',\n      aud: 'authenticated',\n      role: 'authenticated',\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n    },\n    access_token: user?.accessToken || 'mock-access-token',\n    refresh_token: 'mock-refresh-token',\n    expires_at: Date.now() + 3600000, // 1 hour from now\n    expires_in: 3600,\n    token_type: 'bearer',\n  };\n}\n\n/**\n * Mock auth state for testing\n */\nexport function createMockAuthState(authenticated: boolean = true) {\n  if (!authenticated) {\n    return {\n      session: null,\n      user: null,\n      loading: false,\n    };\n  }\n  \n  return {\n    session: createMockSession(),\n    user: {\n      id: 'test-user-id',\n      email: 'test@example.com',\n      aud: 'authenticated',\n      role: 'authenticated',\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n    },\n    loading: false,\n  };\n}\n\n/**\n * Wait for authentication to complete\n * Useful for tests that need to wait for async auth operations\n */\nexport async function waitForAuth(ms: number = 100): Promise<void> {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Verify a request has valid authentication\n */\nexport function hasValidAuth(request: Request): boolean {\n  const authHeader = request.headers.get('Authorization');\n  return authHeader !== null && authHeader.startsWith('Bearer ');\n}\n\n/**\n * Extract access token from request\n */\nexport function extractAccessToken(request: Request): string | null {\n  const authHeader = request.headers.get('Authorization');\n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\n    return null;\n  }\n  return authHeader.substring(7); // Remove 'Bearer ' prefix\n}\n\n/**\n * Create a request with expired token for testing token expiration\n */\nexport function createExpiredTokenRequest(\n  path: string,\n  options: {\n    method?: string;\n    body?: any;\n  } = {}\n): Request {\n  const { method = 'GET', body } = options;\n  \n  const url = new URL(path, 'http://localhost:3000');\n  \n  const headers = new Headers({\n    'Content-Type': 'application/json',\n    'Authorization': 'Bearer expired-token',\n  });\n  \n  return new Request(url.toString(), {\n    method,\n    headers,\n    body: body ? JSON.stringify(body) : undefined,\n  });\n}\n\n/**\n * Create a request with invalid token for testing token validation\n */\nexport function createInvalidTokenRequest(\n  path: string,\n  options: {\n    method?: string;\n    body?: any;\n  } = {}\n): Request {\n  const { method = 'GET', body } = options;\n  \n  const url = new URL(path, 'http://localhost:3000');\n  \n  const headers = new Headers({\n    'Content-Type': 'application/json',\n    'Authorization': 'Bearer invalid-token-format',\n  });\n  \n  return new Request(url.toString(), {\n    method,\n    headers,\n    body: body ? JSON.stringify(body) : undefined,\n  });\n}\n"],"names":["TestAuthContext","authenticatedApiRequest","authenticatedFetch","createAuthenticatedRequest","createExpiredTokenRequest","createInvalidTokenRequest","createMockAuthState","createMockSession","createTestAuthContext","createUnauthenticatedRequest","extractAccessToken","hasValidAuth","waitForAuth","withAuthContext","url","options","accessToken","headers","Headers","set","fetch","path","method","body","Authorization","JSON","stringify","undefined","searchParams","URL","Object","entries","forEach","key","value","Request","toString","signIn","user","createAndSignInTestUser","getUser","getAccessToken","Error","createRequest","apiRequest","signOut","isAuthenticated","fn","auth","id","email","aud","role","created_at","Date","toISOString","updated_at","access_token","refresh_token","expires_at","now","expires_in","token_type","authenticated","session","loading","ms","Promise","resolve","setTimeout","request","authHeader","get","startsWith","substring"],"mappings":"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"}