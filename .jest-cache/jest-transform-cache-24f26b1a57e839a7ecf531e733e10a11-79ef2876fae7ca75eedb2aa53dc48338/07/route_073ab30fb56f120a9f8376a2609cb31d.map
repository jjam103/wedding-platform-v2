{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/guests/[id]/auth-method/route.ts"],"sourcesContent":["import { createAuthenticatedClient } from '@/lib/supabaseServer';\nimport { NextResponse } from 'next/server';\nimport { z } from 'zod';\n\n/**\n * PUT /api/admin/guests/[id]/auth-method\n * \n * Updates authentication method for a specific guest\n * \n * Requirements: 22.3\n */\n\nconst updateAuthMethodSchema = z.object({\n  auth_method: z.enum(['email_matching', 'magic_link']),\n});\n\nfunction getStatusCode(errorCode: string): number {\n  const statusMap: Record<string, number> = {\n    'VALIDATION_ERROR': 400,\n    'UNAUTHORIZED': 401,\n    'FORBIDDEN': 403,\n    'NOT_FOUND': 404,\n    'GUEST_NOT_FOUND': 404,\n    'DATABASE_ERROR': 500,\n    'INTERNAL_ERROR': 500,\n  };\n  return statusMap[errorCode] || 500;\n}\n\nexport async function PUT(\n  request: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // Await params (Next.js 15 requirement)\n    const { id } = await params;\n\n    // 1. AUTHENTICATION\n    const supabase = await createAuthenticatedClient();\n    const {\n      data: { session },\n      error: authError,\n    } = await supabase.auth.getSession();\n\n    if (authError || !session) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n\n    // 2. VALIDATION\n    // Validate guest ID\n    const idValidation = z.string().uuid().safeParse(id);\n    if (!idValidation.success) {\n      return NextResponse.json(\n        { success: false, error: { code: 'VALIDATION_ERROR', message: 'Invalid guest ID format' } },\n        { status: 400 }\n      );\n    }\n\n    // Validate request body\n    const body = await request.json();\n    const validation = updateAuthMethodSchema.safeParse(body);\n\n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid request data',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    // 3. SERVICE CALL\n    const { data: guest, error: updateError } = await supabase\n      .from('guests')\n      .update({ auth_method: validation.data.auth_method })\n      .eq('id', id)\n      .select()\n      .single();\n\n    if (updateError) {\n      if (updateError.code === 'PGRST116') {\n        return NextResponse.json(\n          { success: false, error: { code: 'GUEST_NOT_FOUND', message: 'Guest not found' } },\n          { status: 404 }\n        );\n      }\n      return NextResponse.json(\n        {\n          success: false,\n          error: { code: 'DATABASE_ERROR', message: 'Failed to update guest', details: updateError },\n        },\n        { status: 500 }\n      );\n    }\n\n    // 4. RESPONSE\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          id: guest.id,\n          auth_method: guest.auth_method,\n          email: guest.email,\n          first_name: guest.first_name,\n          last_name: guest.last_name,\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('API Error:', { path: request.url, method: request.method, error });\n    return NextResponse.json(\n      { success: false, error: { code: 'INTERNAL_ERROR', message: 'An unexpected error occurred' } },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["PUT","updateAuthMethodSchema","z","object","auth_method","enum","getStatusCode","errorCode","statusMap","request","params","id","supabase","createAuthenticatedClient","data","session","error","authError","auth","getSession","NextResponse","json","success","code","message","status","idValidation","string","uuid","safeParse","body","validation","details","issues","guest","updateError","from","update","eq","select","single","email","first_name","last_name","console","path","url","method"],"mappings":"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"}