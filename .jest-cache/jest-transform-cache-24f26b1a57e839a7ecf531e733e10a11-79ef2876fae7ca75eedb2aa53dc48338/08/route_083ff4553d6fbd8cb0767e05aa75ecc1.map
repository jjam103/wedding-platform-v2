{"version":3,"names":["cov_73lu7p2uy","actualCoverage","s","GET","request","f","cookieStore","_headers","cookies","supabase","_ssr","createServerClient","process","env","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","getAll","setAll","cookiesToSet","forEach","name","value","options","set","data","user","error","authError","auth","getUser","b","_server","NextResponse","json","success","code","message","status","userData","userError","from","select","eq","id","single","includes","role","metrics","totalGuests","rsvpResponseRate","totalBudget","upcomingEvents","pendingPhotos","capacityAlerts","count","guestCount","head","totalRsvps","respondedRsvps","neq","vendors","reduce","sum","v","base_cost","upcomingCount","gte","Date","toISOString","pendingCount","activities","not","alertCount","activity","rsvpCount","capacity","Error"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/metrics/route.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr';\nimport { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\n\ninterface DashboardMetrics {\n  totalGuests: number;\n  rsvpResponseRate: number;\n  totalBudget: number;\n  upcomingEvents: number;\n  pendingPhotos: number;\n  capacityAlerts: number;\n}\n\n/**\n * GET /api/admin/metrics\n * \n * Fetches dashboard metrics for the admin portal including:\n * - Total guest count\n * - RSVP response rate\n * - Total budget\n * - Upcoming events count\n * - Pending photos count\n * - Capacity alerts count\n */\nexport async function GET(request: Request): Promise<NextResponse> {\n  try {\n    // 1. Auth check\n    const cookieStore = await cookies();\n    const supabase = createServerClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n      {\n        cookies: {\n          getAll() {\n            return cookieStore.getAll();\n          },\n          setAll(cookiesToSet) {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options);\n            });\n          },\n        },\n      }\n    );\n\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n\n    // 2. Verify user is admin/host\n    const { data: userData, error: userError } = await supabase\n      .from('users')\n      .select('role')\n      .eq('id', user.id)\n      .single();\n\n    if (userError || !userData || !['super_admin', 'host'].includes(userData.role)) {\n      return NextResponse.json(\n        { success: false, error: { code: 'FORBIDDEN', message: 'Admin access required' } },\n        { status: 403 }\n      );\n    }\n\n    // 3. Fetch metrics\n    const metrics: DashboardMetrics = {\n      totalGuests: 0,\n      rsvpResponseRate: 0,\n      totalBudget: 0,\n      upcomingEvents: 0,\n      pendingPhotos: 0,\n      capacityAlerts: 0,\n    };\n\n    // Total guests\n    const { count: guestCount } = await supabase\n      .from('guests')\n      .select('*', { count: 'exact', head: true });\n    metrics.totalGuests = guestCount || 0;\n\n    // RSVP response rate\n    const { count: totalRsvps } = await supabase\n      .from('rsvps')\n      .select('*', { count: 'exact', head: true });\n    \n    const { count: respondedRsvps } = await supabase\n      .from('rsvps')\n      .select('*', { count: 'exact', head: true })\n      .neq('status', 'pending');\n\n    if (totalRsvps && totalRsvps > 0) {\n      metrics.rsvpResponseRate = ((respondedRsvps || 0) / totalRsvps) * 100;\n    }\n\n    // Total budget (sum of vendor costs)\n    const { data: vendors } = await supabase\n      .from('vendors')\n      .select('base_cost');\n    \n    if (vendors) {\n      metrics.totalBudget = vendors.reduce((sum, v) => sum + (v.base_cost || 0), 0);\n    }\n\n    // Upcoming events (events in the future)\n    const { count: upcomingCount } = await supabase\n      .from('events')\n      .select('*', { count: 'exact', head: true })\n      .gte('start_date', new Date().toISOString())\n      .eq('status', 'published');\n    metrics.upcomingEvents = upcomingCount || 0;\n\n    // Pending photos\n    const { count: pendingCount } = await supabase\n      .from('photos')\n      .select('*', { count: 'exact', head: true })\n      .eq('moderation_status', 'pending');\n    metrics.pendingPhotos = pendingCount || 0;\n\n    // Capacity alerts (activities at 90%+ capacity)\n    const { data: activities } = await supabase\n      .from('activities')\n      .select('id, capacity')\n      .not('capacity', 'is', null);\n\n    if (activities) {\n      let alertCount = 0;\n      for (const activity of activities) {\n        const { count: rsvpCount } = await supabase\n          .from('rsvps')\n          .select('*', { count: 'exact', head: true })\n          .eq('activity_id', activity.id)\n          .eq('status', 'attending');\n\n        if (rsvpCount && activity.capacity && rsvpCount >= activity.capacity * 0.9) {\n          alertCount++;\n        }\n      }\n      metrics.capacityAlerts = alertCount;\n    }\n\n    return NextResponse.json({ success: true, data: metrics }, { status: 200 });\n  } catch (error) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'INTERNAL_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}