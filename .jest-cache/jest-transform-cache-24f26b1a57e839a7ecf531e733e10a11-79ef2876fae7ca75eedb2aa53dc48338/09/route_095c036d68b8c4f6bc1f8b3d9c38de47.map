{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/guests/bulk-auth-method/route.ts"],"sourcesContent":["import { createAuthenticatedClient } from '@/lib/supabaseServer';\nimport { NextResponse } from 'next/server';\nimport { z } from 'zod';\n\n/**\n * POST /api/admin/guests/bulk-auth-method\n * \n * Updates authentication method for multiple guests\n * \n * Requirements: 22.7\n */\n\nconst bulkUpdateAuthMethodSchema = z.object({\n  guest_ids: z.array(z.string().uuid()).min(1).max(100),\n  auth_method: z.enum(['email_matching', 'magic_link']),\n  send_notification: z.boolean().optional().default(false),\n});\n\nfunction getStatusCode(errorCode: string): number {\n  const statusMap: Record<string, number> = {\n    'VALIDATION_ERROR': 400,\n    'UNAUTHORIZED': 401,\n    'FORBIDDEN': 403,\n    'DATABASE_ERROR': 500,\n    'INTERNAL_ERROR': 500,\n  };\n  return statusMap[errorCode] || 500;\n}\n\nexport async function POST(request: Request) {\n  try {\n    // 1. AUTHENTICATION\n    const supabase = await createAuthenticatedClient();\n    const {\n      data: { session },\n      error: authError,\n    } = await supabase.auth.getSession();\n\n    if (authError || !session) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n\n    // 2. VALIDATION\n    const body = await request.json();\n    const validation = bulkUpdateAuthMethodSchema.safeParse(body);\n\n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid request data',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    const { guest_ids, auth_method, send_notification } = validation.data;\n\n    // 3. SERVICE CALL\n    // Update all guests in a single query\n    const { data: updatedGuests, error: updateError } = await supabase\n      .from('guests')\n      .update({ auth_method })\n      .in('id', guest_ids)\n      .select('id, email, first_name, last_name, auth_method');\n\n    if (updateError) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: { code: 'DATABASE_ERROR', message: 'Failed to update guests', details: updateError },\n        },\n        { status: 500 }\n      );\n    }\n\n    // TODO: Send notification emails if requested (Task 8.3)\n    // This will be implemented when email system is enhanced\n    if (send_notification && updatedGuests && updatedGuests.length > 0) {\n      // Future: Send email notifications to guests about auth method change\n      console.log(`Would send notifications to ${updatedGuests.length} guests about auth method change`);\n    }\n\n    // 4. RESPONSE\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          updated_count: updatedGuests?.length || 0,\n          guests: updatedGuests || [],\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('API Error:', { path: request.url, method: request.method, error });\n    return NextResponse.json(\n      { success: false, error: { code: 'INTERNAL_ERROR', message: 'An unexpected error occurred' } },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["POST","bulkUpdateAuthMethodSchema","z","object","guest_ids","array","string","uuid","min","max","auth_method","enum","send_notification","boolean","optional","default","getStatusCode","errorCode","statusMap","request","supabase","createAuthenticatedClient","data","session","error","authError","auth","getSession","NextResponse","json","success","code","message","status","body","validation","safeParse","details","issues","updatedGuests","updateError","from","update","in","select","length","console","log","updated_count","guests","path","url","method"],"mappings":"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"}