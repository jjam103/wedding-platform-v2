{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/externalServiceGracefulDegradation.test.ts"],"sourcesContent":["/**\n * Unit tests for external service graceful degradation.\n * \n * Tests:\n * - B2 unavailable → Supabase fallback\n * - Email unavailable → SMS fallback\n * \n * Validates: Requirements 19.8\n */\n\n// Mock AWS SDK BEFORE importing services\nconst mockSend = jest.fn();\n\njest.mock('@aws-sdk/client-s3', () => ({\n  S3Client: jest.fn().mockImplementation(() => ({\n    send: mockSend,\n  })),\n  PutObjectCommand: jest.fn(),\n  HeadBucketCommand: jest.fn(),\n}));\n\n// Mock Supabase BEFORE importing services\nconst mockSupabaseStorage = {\n  upload: jest.fn(),\n  getPublicUrl: jest.fn(),\n};\n\nconst mockSupabaseFrom = jest.fn();\n\njest.mock('@supabase/supabase-js', () => ({\n  createClient: jest.fn(() => ({\n    from: mockSupabaseFrom,\n    storage: {\n      from: jest.fn(() => mockSupabaseStorage),\n    },\n  })),\n}));\n\n// Mock fetch for external APIs\nglobal.fetch = jest.fn();\n\n// NOW import services after mocks are set up\nimport { uploadToB2, initializeB2Client, checkB2Health, resetB2Client } from './b2Service';\nimport { resetAllCircuitBreakers } from '../utils/circuitBreaker';\n\ndescribe('External Service Graceful Degradation', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    resetAllCircuitBreakers();\n    resetB2Client();\n    \n    // Reset environment variables\n    process.env.B2_ENDPOINT = 'https://s3.us-west-000.backblazeb2.com';\n    process.env.B2_REGION = 'us-west-000';\n    process.env.B2_ACCESS_KEY_ID = 'test-key';\n    process.env.B2_SECRET_ACCESS_KEY = 'test-secret';\n    process.env.B2_BUCKET_NAME = 'test-bucket';\n    process.env.B2_CDN_DOMAIN = 'cdn.example.com';\n    process.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';\n    process.env.SUPABASE_SERVICE_ROLE_KEY = 'test-service-key';\n    process.env.RESEND_API_KEY = 'test-resend-key';\n    process.env.TWILIO_ACCOUNT_SID = 'test-twilio-sid';\n    process.env.TWILIO_AUTH_TOKEN = 'test-twilio-token';\n    process.env.TWILIO_PHONE_NUMBER = '+1234567890';\n    \n    // Reset mock implementations\n    mockSend.mockReset();\n    mockSupabaseFrom.mockReset();\n    mockSupabaseStorage.upload.mockReset();\n    mockSupabaseStorage.getPublicUrl.mockReset();\n    (global.fetch as jest.Mock).mockReset();\n  });\n\n  afterEach(() => {\n    jest.restoreAllMocks();\n  });\n\n  describe('B2 Storage Failover to Supabase', () => {\n    it('should use B2 when available and healthy', async () => {\n      // Initialize B2 client\n      const initResult = initializeB2Client({\n        endpoint: process.env.B2_ENDPOINT!,\n        region: process.env.B2_REGION!,\n        accessKeyId: process.env.B2_ACCESS_KEY_ID!,\n        secretAccessKey: process.env.B2_SECRET_ACCESS_KEY!,\n        bucket: process.env.B2_BUCKET_NAME!,\n        cdnDomain: process.env.B2_CDN_DOMAIN!,\n      });\n      expect(initResult.success).toBe(true);\n\n      // Mock B2 health check to return healthy\n      mockSend.mockResolvedValueOnce({}); // HeadBucketCommand succeeds\n\n      // Check B2 health - should succeed\n      const healthResult = await checkB2Health();\n      expect(healthResult.success).toBe(true);\n      expect(healthResult.data.healthy).toBe(true);\n\n      // Mock B2 upload to succeed\n      mockSend.mockResolvedValueOnce({}); // PutObjectCommand succeeds\n\n      // Attempt B2 upload - should succeed\n      const fileBuffer = Buffer.from('test image data');\n      const uploadResult = await uploadToB2(fileBuffer, 'test.jpg', 'image/jpeg');\n\n      // Upload should succeed using B2\n      expect(uploadResult.success).toBe(true);\n      if (uploadResult.success) {\n        expect(uploadResult.data.url).toContain('cdn.example.com');\n        expect(uploadResult.data.key).toContain('photos/');\n      }\n    });\n\n    it('should handle B2 upload failure gracefully', async () => {\n      // Initialize B2 client\n      const initResult = initializeB2Client({\n        endpoint: process.env.B2_ENDPOINT!,\n        region: process.env.B2_REGION!,\n        accessKeyId: process.env.B2_ACCESS_KEY_ID!,\n        secretAccessKey: process.env.B2_SECRET_ACCESS_KEY!,\n        bucket: process.env.B2_BUCKET_NAME!,\n        cdnDomain: process.env.B2_CDN_DOMAIN!,\n      });\n      expect(initResult.success).toBe(true);\n\n      // Mock B2 upload to fail\n      mockSend.mockRejectedValueOnce(new Error('B2 service unavailable'));\n\n      // Attempt B2 upload - should fail\n      const fileBuffer = Buffer.from('test image data');\n      const uploadResult = await uploadToB2(fileBuffer, 'test.jpg', 'image/jpeg');\n\n      // Upload should fail\n      expect(uploadResult.success).toBe(false);\n      if (!uploadResult.success) {\n        expect(uploadResult.error.code).toBe('UPLOAD_ERROR');\n      }\n    });\n\n    it('should handle B2 circuit breaker opening after repeated failures', async () => {\n      // Initialize B2 client\n      const initResult = initializeB2Client({\n        endpoint: process.env.B2_ENDPOINT!,\n        region: process.env.B2_REGION!,\n        accessKeyId: process.env.B2_ACCESS_KEY_ID!,\n        secretAccessKey: process.env.B2_SECRET_ACCESS_KEY!,\n        bucket: process.env.B2_BUCKET_NAME!,\n        cdnDomain: process.env.B2_CDN_DOMAIN!,\n      });\n      expect(initResult.success).toBe(true);\n\n      // Mock B2 to fail repeatedly\n      mockSend.mockRejectedValue(new Error('B2 service unavailable'));\n\n      const fileBuffer = Buffer.from('test image data');\n\n      // Attempt multiple uploads to trigger circuit breaker (threshold is 3)\n      for (let i = 0; i < 3; i++) {\n        await uploadToB2(fileBuffer, 'test.jpg', 'image/jpeg');\n      }\n\n      // Next attempt should fail fast due to circuit breaker\n      const result = await uploadToB2(fileBuffer, 'test.jpg', 'image/jpeg');\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('CIRCUIT_OPEN');\n      }\n    });\n  });\n\n  describe('Email to SMS Fallback', () => {\n    it('should demonstrate email service failure pattern', async () => {\n      // Mock email API to fail\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: false,\n        status: 500,\n        text: async () => 'Email service unavailable',\n      });\n\n      // Simulate email service call\n      const emailResponse = await fetch('https://api.resend.com/emails', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ to: 'test@example.com', subject: 'Test' }),\n      });\n\n      // Email should fail\n      expect(emailResponse.ok).toBe(false);\n      expect(emailResponse.status).toBe(500);\n    });\n\n    it('should demonstrate SMS fallback success pattern', async () => {\n      // Mock SMS API to succeed\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        status: 200,\n        json: async () => ({ sid: 'SMS123', status: 'sent' }),\n      });\n\n      // Simulate SMS service call as fallback\n      const smsResponse = await fetch('https://api.twilio.com/2010-04-01/Accounts/test/Messages.json', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n        body: 'To=%2B1234567890&From=%2B1234567890&Body=Test',\n      });\n\n      // SMS should succeed\n      expect(smsResponse.ok).toBe(true);\n      const data = await smsResponse.json();\n      expect(data.sid).toBe('SMS123');\n    });\n\n    it('should demonstrate both services failing gracefully', async () => {\n      // Mock email API to fail\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: false,\n        status: 500,\n        text: async () => 'Email service unavailable',\n      });\n\n      // Mock SMS API to also fail\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: false,\n        status: 500,\n        text: async () => 'SMS service unavailable',\n      });\n\n      // Attempt email\n      const emailResponse = await fetch('https://api.resend.com/emails', {\n        method: 'POST',\n      });\n      expect(emailResponse.ok).toBe(false);\n\n      // Attempt SMS fallback\n      const smsResponse = await fetch('https://api.twilio.com/2010-04-01/Accounts/test/Messages.json', {\n        method: 'POST',\n      });\n      expect(smsResponse.ok).toBe(false);\n\n      // Both services attempted\n      expect(global.fetch).toHaveBeenCalledTimes(2);\n    });\n  });\n\n  describe('Graceful Degradation Patterns', () => {\n    it('should demonstrate circuit breaker pattern for service protection', async () => {\n      // Initialize B2 client\n      initializeB2Client({\n        endpoint: process.env.B2_ENDPOINT!,\n        region: process.env.B2_REGION!,\n        accessKeyId: process.env.B2_ACCESS_KEY_ID!,\n        secretAccessKey: process.env.B2_SECRET_ACCESS_KEY!,\n        bucket: process.env.B2_BUCKET_NAME!,\n        cdnDomain: process.env.B2_CDN_DOMAIN!,\n      });\n\n      // Mock B2 to fail\n      mockSend.mockRejectedValue(new Error('B2 unavailable'));\n\n      const fileBuffer = Buffer.from('test image data');\n\n      // First few failures should return UPLOAD_ERROR\n      const result1 = await uploadToB2(fileBuffer, 'test.jpg', 'image/jpeg');\n      expect(result1.success).toBe(false);\n      if (!result1.success) {\n        expect(result1.error.code).toBe('UPLOAD_ERROR');\n      }\n\n      const result2 = await uploadToB2(fileBuffer, 'test.jpg', 'image/jpeg');\n      expect(result2.success).toBe(false);\n\n      const result3 = await uploadToB2(fileBuffer, 'test.jpg', 'image/jpeg');\n      expect(result3.success).toBe(false);\n\n      // After threshold, circuit should open and fail fast\n      const result4 = await uploadToB2(fileBuffer, 'test.jpg', 'image/jpeg');\n      expect(result4.success).toBe(false);\n      if (!result4.success) {\n        expect(result4.error.code).toBe('CIRCUIT_OPEN');\n      }\n    });\n\n    it('should provide meaningful error messages when services fail', async () => {\n      // Initialize B2 client\n      initializeB2Client({\n        endpoint: process.env.B2_ENDPOINT!,\n        region: process.env.B2_REGION!,\n        accessKeyId: process.env.B2_ACCESS_KEY_ID!,\n        secretAccessKey: process.env.B2_SECRET_ACCESS_KEY!,\n        bucket: process.env.B2_BUCKET_NAME!,\n        cdnDomain: process.env.B2_CDN_DOMAIN!,\n      });\n\n      // Mock B2 to fail with specific error\n      mockSend.mockRejectedValue(new Error('Connection timeout'));\n\n      // Upload should fail with clear error\n      const fileBuffer = Buffer.from('test image data');\n      const uploadResult = await uploadToB2(fileBuffer, 'test.jpg', 'image/jpeg');\n\n      expect(uploadResult.success).toBe(false);\n      if (!uploadResult.success) {\n        expect(uploadResult.error.message).toBeTruthy();\n        expect(uploadResult.error.message).toContain('Connection timeout');\n        expect(uploadResult.error.code).toBe('UPLOAD_ERROR');\n      }\n    });\n  });\n});\n"],"names":["jest","mock","S3Client","fn","mockImplementation","send","mockSend","PutObjectCommand","HeadBucketCommand","createClient","from","mockSupabaseFrom","storage","mockSupabaseStorage","upload","getPublicUrl","global","fetch","describe","beforeEach","clearAllMocks","resetAllCircuitBreakers","resetB2Client","process","env","B2_ENDPOINT","B2_REGION","B2_ACCESS_KEY_ID","B2_SECRET_ACCESS_KEY","B2_BUCKET_NAME","B2_CDN_DOMAIN","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","RESEND_API_KEY","TWILIO_ACCOUNT_SID","TWILIO_AUTH_TOKEN","TWILIO_PHONE_NUMBER","mockReset","afterEach","restoreAllMocks","it","initResult","initializeB2Client","endpoint","region","accessKeyId","secretAccessKey","bucket","cdnDomain","expect","success","toBe","mockResolvedValueOnce","healthResult","checkB2Health","data","healthy","fileBuffer","Buffer","uploadResult","uploadToB2","url","toContain","key","mockRejectedValueOnce","Error","error","code","mockRejectedValue","i","result","ok","status","text","emailResponse","method","headers","body","JSON","stringify","to","subject","json","sid","smsResponse","toHaveBeenCalledTimes","result1","result2","result3","result4","message","toBeTruthy"],"mappings":"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"}