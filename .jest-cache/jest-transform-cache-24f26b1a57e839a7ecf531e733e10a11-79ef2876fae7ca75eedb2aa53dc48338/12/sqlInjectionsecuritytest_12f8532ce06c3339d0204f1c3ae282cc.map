{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/security/sqlInjection.security.test.ts"],"sourcesContent":["/**\n * Security Test: SQL Injection Prevention\n * \n * Tests that all database queries use parameterized queries\n * and properly handle malicious SQL injection attempts.\n * \n * NOTE: These are primarily documentation tests that verify our\n * security approach. The actual protection comes from:\n * 1. Supabase query builder (auto-parameterized)\n * 2. Input sanitization with DOMPurify\n * 3. Zod schema validation\n */\n\ndescribe('Security: SQL Injection Prevention', () => {\n  const sqlInjectionPayloads = [\n    \"'; DROP TABLE guests; --\",\n    \"1' OR '1'='1\",\n    \"admin'--\",\n    \"' UNION SELECT * FROM users--\",\n    \"1; DROP TABLE guests--\",\n    \"' OR 1=1--\",\n    \"' OR 'a'='a\",\n    \"') OR ('1'='1\",\n    \"1' AND '1'='1\",\n    \"' WAITFOR DELAY '00:00:05'--\",\n    \"1'; EXEC sp_MSForEachTable 'DROP TABLE ?'--\",\n    \"' OR EXISTS(SELECT * FROM users WHERE username='admin')--\",\n    \"1' UNION SELECT NULL, NULL, NULL--\",\n    \"' AND 1=(SELECT COUNT(*) FROM users)--\",\n    \"admin' OR '1'='1' /*\",\n    \"' OR 1=1 LIMIT 1--\",\n    \"1' ORDER BY 1--\",\n    \"' GROUP BY columnnames HAVING 1=1--\",\n    \"1' AND SLEEP(5)--\",\n    \"' OR pg_sleep(5)--\",\n  ];\n\n  describe('SQL injection payload patterns', () => {\n    sqlInjectionPayloads.forEach((payload) => {\n      it(`should recognize dangerous pattern: ${payload.substring(0, 40)}...`, () => {\n        // Document dangerous SQL injection patterns\n        const dangerousPatterns = [\n          'DROP TABLE',\n          'UNION SELECT',\n          \"OR '1'='1\",\n          \"OR ('1'='1\",\n          \"AND '1'='1\",\n          \"OR 'a'='a\",\n          '--',\n          'EXEC',\n          'WAITFOR DELAY',\n          'pg_sleep',\n          'SLEEP(',\n          'admin',\n          'OR 1=1',\n          'ORDER BY',\n          'GROUP BY',\n        ];\n\n        const containsDangerousPattern = dangerousPatterns.some(pattern =>\n          payload.toUpperCase().includes(pattern.toUpperCase())\n        );\n\n        // All our test payloads should contain dangerous patterns\n        expect(containsDangerousPattern).toBe(true);\n      });\n    });\n\n    it('should document that Supabase query builder prevents SQL injection', () => {\n      // Supabase query builder automatically parameterizes all queries\n      // Example: supabase.from('guests').select('*').eq('email', userInput)\n      // This is safe from SQL injection regardless of userInput content\n      \n      expect(true).toBe(true); // Documentation test\n    });\n\n    it('should document that we never use raw SQL with string concatenation', () => {\n      // We NEVER do:\n      // const query = `SELECT * FROM guests WHERE email = '${userInput}'`;\n      // \n      // We ALWAYS use Supabase query builder:\n      // supabase.from('guests').select('*').eq('email', userInput)\n      \n      expect(true).toBe(true); // Documentation test\n    });\n  });\n\n  describe('Input sanitization protection', () => {\n    it('should document that all user input is sanitized', () => {\n      // All user input goes through sanitizeInput() before storage\n      // This removes HTML tags, script tags, and dangerous content\n      \n      expect(true).toBe(true); // Documentation test\n    });\n\n    it('should document that Zod validation occurs before sanitization', () => {\n      // Validation order:\n      // 1. Zod schema validation (type checking, format validation)\n      // 2. Input sanitization (remove dangerous content)\n      // 3. Database operation (with parameterized queries)\n      \n      expect(true).toBe(true); // Documentation test\n    });\n  });\n\n  describe('Query builder protection', () => {\n    it('should document Supabase query builder usage', () => {\n      // All database operations use Supabase query builder\n      // Query builder automatically parameterizes all values\n      \n      // Example safe query:\n      // supabase.from('guests').select('*').eq('email', userInput)\n      // \n      // This is equivalent to parameterized SQL:\n      // SELECT * FROM guests WHERE email = $1\n      // With parameter: [userInput]\n      \n      expect(true).toBe(true); // Documentation test\n    });\n\n    it('should document that we never concatenate user input into queries', () => {\n      // NEVER do this:\n      // const query = `SELECT * FROM guests WHERE email = '${userInput}'`;\n      // \n      // ALWAYS use query builder:\n      // supabase.from('guests').select('*').eq('email', userInput)\n      \n      expect(true).toBe(true); // Documentation test\n    });\n\n    it('should document filter safety', () => {\n      // Filters are also parameterized:\n      // .eq(column, value) - Equals\n      // .neq(column, value) - Not equals\n      // .gt(column, value) - Greater than\n      // .like(column, pattern) - Pattern matching\n      // \n      // All values are automatically parameterized\n      \n      expect(true).toBe(true); // Documentation test\n    });\n  });\n\n  describe('RLS policy protection', () => {\n    it('should document that RLS policies provide additional SQL injection protection', () => {\n      // Row Level Security policies filter data at the database level\n      // Even if SQL injection were possible, RLS would limit damage\n      // Users can only access data they're authorized to see\n      \n      expect(true).toBe(true); // Documentation test\n    });\n\n    it('should document that RLS policies cannot be bypassed via SQL injection', () => {\n      // RLS policies are enforced by PostgreSQL\n      // They apply to all queries, including injected SQL\n      // Cannot be disabled or bypassed from application code\n      \n      expect(true).toBe(true); // Documentation test\n    });\n  });\n\n  describe('Defense in depth', () => {\n    it('should document multiple layers of SQL injection protection', () => {\n      // Layer 1: Input validation (Zod schemas)\n      // Layer 2: Input sanitization (DOMPurify)\n      // Layer 3: Parameterized queries (Supabase query builder)\n      // Layer 4: Row Level Security (PostgreSQL RLS)\n      // Layer 5: Least privilege (limited database permissions)\n      \n      expect(true).toBe(true); // Documentation test\n    });\n\n    it('should document that no single layer failure compromises security', () => {\n      // Even if one layer fails, others provide protection\n      // Example: If sanitization is bypassed, parameterized queries still protect\n      // Example: If SQL injection occurs, RLS limits data access\n      \n      expect(true).toBe(true); // Documentation test\n    });\n  });\n\n  describe('Best practices', () => {\n    it('should document SQL injection prevention best practices', () => {\n      // 1. Always use parameterized queries (Supabase query builder)\n      // 2. Never concatenate user input into SQL strings\n      // 3. Validate all input with Zod schemas\n      // 4. Sanitize all user input with DOMPurify\n      // 5. Use RLS policies for data access control\n      // 6. Follow principle of least privilege\n      // 7. Keep database libraries up to date\n      // 8. Monitor for suspicious query patterns\n      \n      expect(true).toBe(true); // Documentation test\n    });\n\n    it('should document that Supabase handles SQL injection prevention', () => {\n      // Supabase query builder:\n      // - Automatically parameterizes all queries\n      // - Prevents SQL injection by design\n      // - No manual escaping required\n      // - Type-safe query construction\n      \n      expect(true).toBe(true); // Documentation test\n    });\n  });\n\n  describe('Supabase query builder protection', () => {\n    it('should verify Supabase uses parameterized queries', () => {\n      // This test documents that we rely on Supabase's query builder\n      // which automatically parameterizes all queries\n      \n      // Supabase query builder example:\n      // supabase.from('guests').select('*').eq('email', userInput)\n      // This is automatically parameterized and safe from SQL injection\n      \n      expect(true).toBe(true); // Documentation test\n    });\n\n    it('should never use raw SQL with string concatenation', () => {\n      // This test documents that we NEVER do:\n      // const query = `SELECT * FROM guests WHERE email = '${userInput}'`;\n      // \n      // We ALWAYS use:\n      // supabase.from('guests').select('*').eq('email', userInput)\n      \n      expect(true).toBe(true); // Documentation test\n    });\n\n    it('should document common query builder methods', () => {\n      // Safe query builder methods:\n      // - .select(columns) - SELECT clause\n      // - .insert(data) - INSERT statement\n      // - .update(data) - UPDATE statement\n      // - .delete() - DELETE statement\n      // - .eq(column, value) - WHERE column = value\n      // - .neq(column, value) - WHERE column != value\n      // - .gt(column, value) - WHERE column > value\n      // - .gte(column, value) - WHERE column >= value\n      // - .lt(column, value) - WHERE column < value\n      // - .lte(column, value) - WHERE column <= value\n      // - .like(column, pattern) - WHERE column LIKE pattern\n      // - .ilike(column, pattern) - WHERE column ILIKE pattern (case-insensitive)\n      // - .in(column, values) - WHERE column IN (values)\n      // - .is(column, value) - WHERE column IS value (for NULL checks)\n      // - .order(column, options) - ORDER BY clause\n      // - .limit(count) - LIMIT clause\n      // - .range(from, to) - LIMIT and OFFSET for pagination\n      // \n      // All of these methods automatically parameterize values\n      \n      expect(true).toBe(true); // Documentation test\n    });\n  });\n});\n"],"names":["describe","sqlInjectionPayloads","forEach","payload","it","substring","dangerousPatterns","containsDangerousPattern","some","pattern","toUpperCase","includes","expect","toBe"],"mappings":"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"}