{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/authService.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport type { Result } from '@/types';\nimport { success, error, unauthorizedError, unknownError } from '@/utils/errors';\nimport { ERROR_CODES } from '@/types';\n\n/**\n * Authentication service for managing user authentication with Supabase Auth.\n * Supports email/password and magic link authentication methods.\n */\n\nexport interface LoginCredentials {\n  email: string;\n  password: string;\n}\n\nexport interface MagicLinkRequest {\n  email: string;\n  redirectTo?: string;\n}\n\nexport interface AuthSession {\n  user: {\n    id: string;\n    email: string;\n    role: 'super_admin' | 'host' | 'guest';\n  };\n  accessToken: string;\n  refreshToken: string;\n  expiresAt: number;\n}\n\nexport interface User {\n  id: string;\n  email: string;\n  role: 'super_admin' | 'host' | 'guest';\n  created_at: string;\n  last_login: string;\n}\n\n/**\n * Creates a Supabase client for authentication operations.\n * \n * @returns Configured Supabase client\n * @throws Error if required environment variables are missing\n */\nfunction createAuthClient() {\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n  if (!supabaseUrl || !supabaseAnonKey) {\n    throw new Error(\n      'Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY'\n    );\n  }\n\n  return createClient(supabaseUrl, supabaseAnonKey);\n}\n\n/**\n * Logs in a user with email and password.\n * \n * @param credentials - User email and password\n * @returns Result containing auth session or error details\n * \n * @example\n * const result = await authService.loginWithPassword({\n *   email: 'user@example.com',\n *   password: 'securePassword123'\n * });\n * \n * if (result.success) {\n *   console.log('Logged in:', result.data.user.email);\n * }\n */\nexport async function loginWithPassword(\n  credentials: LoginCredentials\n): Promise<Result<AuthSession>> {\n  try {\n    const supabase = createAuthClient();\n\n    const { data, error: authError } = await supabase.auth.signInWithPassword({\n      email: credentials.email,\n      password: credentials.password,\n    });\n\n    if (authError) {\n      return error(\n        ERROR_CODES.INVALID_CREDENTIALS,\n        'Invalid email or password',\n        authError\n      );\n    }\n\n    if (!data.session || !data.user) {\n      return unauthorizedError('Failed to create session');\n    }\n\n    // Fetch user role from users table\n    const { data: userData, error: userError } = await supabase\n      .from('users')\n      .select('role')\n      .eq('id', data.user.id)\n      .single();\n\n    if (userError || !userData) {\n      // Default to guest role if user record doesn't exist yet\n      const role = 'guest';\n      \n      return success({\n        user: {\n          id: data.user.id,\n          email: data.user.email!,\n          role,\n        },\n        accessToken: data.session.access_token,\n        refreshToken: data.session.refresh_token,\n        expiresAt: data.session.expires_at || 0,\n      });\n    }\n\n    return success({\n      user: {\n        id: data.user.id,\n        email: data.user.email!,\n        role: userData.role,\n      },\n      accessToken: data.session.access_token,\n      refreshToken: data.session.refresh_token,\n      expiresAt: data.session.expires_at || 0,\n    });\n  } catch (err) {\n    return unknownError(err);\n  }\n}\n\n/**\n * Sends a magic link to the user's email for passwordless authentication.\n * \n * @param request - Email and optional redirect URL\n * @returns Result indicating success or error\n * \n * @example\n * const result = await authService.sendMagicLink({\n *   email: 'user@example.com',\n *   redirectTo: 'https://example.com/dashboard'\n * });\n */\nexport async function sendMagicLink(\n  request: MagicLinkRequest\n): Promise<Result<{ message: string }>> {\n  try {\n    const supabase = createAuthClient();\n\n    const { error: authError } = await supabase.auth.signInWithOtp({\n      email: request.email,\n      options: {\n        emailRedirectTo: request.redirectTo,\n      },\n    });\n\n    if (authError) {\n      return error(\n        ERROR_CODES.EXTERNAL_SERVICE_ERROR,\n        'Failed to send magic link',\n        authError\n      );\n    }\n\n    return success({\n      message: 'Magic link sent successfully. Please check your email.',\n    });\n  } catch (err) {\n    return unknownError(err);\n  }\n}\n\n/**\n * Verifies and retrieves the current session.\n * \n * @returns Result containing auth session or error if no valid session\n * \n * @example\n * const result = await authService.getSession();\n * if (result.success) {\n *   console.log('Current user:', result.data.user.email);\n * }\n */\nexport async function getSession(): Promise<Result<AuthSession>> {\n  try {\n    const supabase = createAuthClient();\n\n    const { data, error: sessionError } = await supabase.auth.getSession();\n\n    if (sessionError) {\n      return error(\n        ERROR_CODES.SESSION_EXPIRED,\n        'Session expired or invalid',\n        sessionError\n      );\n    }\n\n    if (!data.session || !data.session.user) {\n      return unauthorizedError('No active session');\n    }\n\n    // Fetch user role from users table\n    const { data: userData, error: userError } = await supabase\n      .from('users')\n      .select('role')\n      .eq('id', data.session.user.id)\n      .single();\n\n    const role = userData?.role || 'guest';\n\n    return success({\n      user: {\n        id: data.session.user.id,\n        email: data.session.user.email!,\n        role,\n      },\n      accessToken: data.session.access_token,\n      refreshToken: data.session.refresh_token,\n      expiresAt: data.session.expires_at || 0,\n    });\n  } catch (err) {\n    return unknownError(err);\n  }\n}\n\n/**\n * Refreshes an expired session using a refresh token.\n * \n * @param refreshToken - The refresh token from the previous session\n * @returns Result containing new auth session or error\n * \n * @example\n * const result = await authService.refreshSession(oldRefreshToken);\n */\nexport async function refreshSession(\n  refreshToken: string\n): Promise<Result<AuthSession>> {\n  try {\n    const supabase = createAuthClient();\n\n    const { data, error: refreshError } = await supabase.auth.refreshSession({\n      refresh_token: refreshToken,\n    });\n\n    if (refreshError) {\n      return error(\n        ERROR_CODES.SESSION_EXPIRED,\n        'Failed to refresh session',\n        refreshError\n      );\n    }\n\n    if (!data.session || !data.user) {\n      return unauthorizedError('Failed to refresh session');\n    }\n\n    // Fetch user role\n    const { data: userData, error: userError } = await supabase\n      .from('users')\n      .select('role')\n      .eq('id', data.user.id)\n      .single();\n\n    const role = userData?.role || 'guest';\n\n    return success({\n      user: {\n        id: data.user.id,\n        email: data.user.email!,\n        role,\n      },\n      accessToken: data.session.access_token,\n      refreshToken: data.session.refresh_token,\n      expiresAt: data.session.expires_at || 0,\n    });\n  } catch (err) {\n    return unknownError(err);\n  }\n}\n\n/**\n * Logs out the current user and invalidates the session.\n * \n * @returns Result indicating success or error\n * \n * @example\n * const result = await authService.logout();\n * if (result.success) {\n *   console.log('Logged out successfully');\n * }\n */\nexport async function logout(): Promise<Result<{ message: string }>> {\n  try {\n    const supabase = createAuthClient();\n\n    const { error: signOutError } = await supabase.auth.signOut();\n\n    if (signOutError) {\n      return error(\n        ERROR_CODES.UNKNOWN_ERROR,\n        'Failed to logout',\n        signOutError\n      );\n    }\n\n    return success({ message: 'Logged out successfully' });\n  } catch (err) {\n    return unknownError(err);\n  }\n}\n\n/**\n * Checks if a session is expired based on the expiration timestamp.\n * \n * @param expiresAt - Unix timestamp of session expiration\n * @returns True if session is expired, false otherwise\n */\nexport function isSessionExpired(expiresAt: number): boolean {\n  return Date.now() / 1000 >= expiresAt;\n}\n\n/**\n * Gets the current user from an active session.\n * \n * @returns Result containing user data or error if not authenticated\n */\nexport async function getCurrentUser(): Promise<Result<User>> {\n  try {\n    const sessionResult = await getSession();\n    \n    if (!sessionResult.success) {\n      return sessionResult;\n    }\n\n    const supabase = createAuthClient();\n    const { data, error: userError } = await supabase\n      .from('users')\n      .select('*')\n      .eq('id', sessionResult.data.user.id)\n      .single();\n\n    if (userError || !data) {\n      return error(\n        ERROR_CODES.NOT_FOUND,\n        'User not found',\n        userError\n      );\n    }\n\n    return success(data);\n  } catch (err) {\n    return unknownError(err);\n  }\n}\n"],"names":["getCurrentUser","getSession","isSessionExpired","loginWithPassword","logout","refreshSession","sendMagicLink","createAuthClient","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","supabaseAnonKey","NEXT_PUBLIC_SUPABASE_ANON_KEY","Error","createClient","credentials","supabase","data","error","authError","auth","signInWithPassword","email","password","ERROR_CODES","INVALID_CREDENTIALS","session","user","unauthorizedError","userData","userError","from","select","eq","id","single","role","success","accessToken","access_token","refreshToken","refresh_token","expiresAt","expires_at","err","unknownError","request","signInWithOtp","options","emailRedirectTo","redirectTo","EXTERNAL_SERVICE_ERROR","message","sessionError","SESSION_EXPIRED","refreshError","signOutError","signOut","UNKNOWN_ERROR","Date","now","sessionResult","NOT_FOUND"],"mappings":"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"}