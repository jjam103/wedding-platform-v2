{"version":3,"names":["config","cov_2gve3ijhet","f","s","middleware","request","pathname","nextUrl","b","startsWith","_server","NextResponse","next","requiresAdmin","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","supabaseAnonKey","NEXT_PUBLIC_SUPABASE_ANON_KEY","console","error","redirectToLogin","response","headers","supabase","_ssr","createServerClient","cookies","getAll","setAll","cookiesToSet","forEach","name","value","options","set","data","user","auth","getUser","log","message","id","userData","userError","from","select","eq","single","redirectToUnauthorized","allowedRoles","includes","role","json","success","code","status","loginUrl","URL","url","searchParams","redirect","unauthorizedUrl","matcher"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/middleware.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport type { NextRequest } from 'next/server';\nimport { createServerClient } from '@supabase/ssr';\n\n/**\n * Middleware for protecting routes with authentication and role-based access control.\n * \n * Protected routes:\n * - /admin/* - Requires super_admin or host role\n * - /api/admin/* - Requires super_admin or host role\n * \n * Public routes:\n * - /auth/* - Authentication pages\n * - / - Home page\n * - /api/auth/* - Authentication API endpoints\n */\n\nexport async function middleware(request: NextRequest) {\n  const { pathname } = request.nextUrl;\n\n  // Skip middleware for public routes\n  if (\n    pathname.startsWith('/auth') ||\n    pathname === '/' ||\n    pathname.startsWith('/api/auth') ||\n    pathname.startsWith('/_next') ||\n    pathname.startsWith('/static')\n  ) {\n    return NextResponse.next();\n  }\n\n  // Check if route requires admin access\n  const requiresAdmin = pathname.startsWith('/admin') || pathname.startsWith('/api/admin');\n\n  if (requiresAdmin) {\n    try {\n      const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n      const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n      if (!supabaseUrl || !supabaseAnonKey) {\n        console.error('Missing Supabase environment variables');\n        return redirectToLogin(request);\n      }\n\n      let response = NextResponse.next({\n        request: {\n          headers: request.headers,\n        },\n      });\n\n      // Create Supabase client for middleware\n      const supabase = createServerClient(\n        supabaseUrl,\n        supabaseAnonKey,\n        {\n          cookies: {\n            getAll() {\n              return request.cookies.getAll();\n            },\n            setAll(cookiesToSet) {\n              cookiesToSet.forEach(({ name, value, options }) => {\n                request.cookies.set(name, value);\n                response.cookies.set(name, value, options);\n              });\n            },\n          },\n        }\n      );\n\n      const { data: { user }, error } = await supabase.auth.getUser();\n\n      if (error || !user) {\n        console.log('[Middleware] No user found:', error?.message);\n        return redirectToLogin(request);\n      }\n\n      console.log('[Middleware] User authenticated:', user.id);\n\n      // Fetch user role from users table\n      const { data: userData, error: userError } = await supabase\n        .from('users')\n        .select('role')\n        .eq('id', user.id)\n        .single();\n\n      console.log('[Middleware] User data query result:', { userData, userError });\n\n      if (userError || !userData) {\n        console.log('[Middleware] Failed to fetch user role:', userError?.message);\n        return redirectToUnauthorized(request);\n      }\n\n      // Check if user has required role for admin routes\n      const allowedRoles = ['super_admin', 'host'];\n      if (!allowedRoles.includes(userData.role)) {\n        console.log('[Middleware] User role not allowed:', userData.role);\n        return redirectToUnauthorized(request);\n      }\n\n      console.log('[Middleware] Access granted for role:', userData.role);\n\n      // User is authorized, return response with updated cookies\n      return response;\n    } catch (error) {\n      console.error('Middleware error:', error);\n      return redirectToLogin(request);\n    }\n  }\n\n  // For non-admin routes, just continue\n  return NextResponse.next();\n}\n\n/**\n * Redirects to login page with return URL (for page requests).\n * Returns JSON error for API requests.\n */\nfunction redirectToLogin(request: NextRequest): NextResponse {\n  // For API routes, return JSON error instead of redirect\n  if (request.nextUrl.pathname.startsWith('/api/')) {\n    return NextResponse.json(\n      { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n      { status: 401 }\n    );\n  }\n  \n  const loginUrl = new URL('/auth/login', request.url);\n  loginUrl.searchParams.set('returnTo', request.nextUrl.pathname);\n  return NextResponse.redirect(loginUrl);\n}\n\n/**\n * Redirects to unauthorized page (for page requests).\n * Returns JSON error for API requests.\n */\nfunction redirectToUnauthorized(request: NextRequest): NextResponse {\n  // For API routes, return JSON error instead of redirect\n  if (request.nextUrl.pathname.startsWith('/api/')) {\n    return NextResponse.json(\n      { success: false, error: { code: 'FORBIDDEN', message: 'Insufficient permissions' } },\n      { status: 403 }\n    );\n  }\n  \n  const unauthorizedUrl = new URL('/auth/unauthorized', request.url);\n  return NextResponse.redirect(unauthorizedUrl);\n}\n\nexport const config = {\n  matcher: [\n    /*\n     * Match all request paths except:\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     * - public folder\n     */\n    '/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',\n  ],\n};\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}