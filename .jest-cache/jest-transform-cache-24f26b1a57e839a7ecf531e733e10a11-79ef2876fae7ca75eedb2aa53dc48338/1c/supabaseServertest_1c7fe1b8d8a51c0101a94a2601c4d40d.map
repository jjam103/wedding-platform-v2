{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/lib/supabaseServer.test.ts"],"sourcesContent":["/**\n * Unit tests for Supabase Server Client utilities\n * \n * Tests server-side Supabase client creation with async cookies handling.\n */\n\nimport { describe, it, expect, jest, beforeEach } from '@jest/globals';\n\n// Mock Next.js headers\njest.mock('next/headers', () => ({\n  cookies: jest.fn(),\n}));\n\n// Mock Supabase SSR\njest.mock('@supabase/ssr', () => ({\n  createServerClient: jest.fn(),\n}));\n\ndescribe('supabaseServer', () => {\n  let mockCookieStore: any;\n  let mockSupabaseClient: any;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n\n    // Setup mock cookie store\n    mockCookieStore = {\n      getAll: jest.fn().mockReturnValue([]),\n      set: jest.fn(),\n    };\n\n    // Setup mock Supabase client\n    mockSupabaseClient = {\n      auth: {\n        getSession: jest.fn(),\n        getUser: jest.fn(),\n      },\n      from: jest.fn(),\n    };\n\n    // Mock cookies() to return our mock store\n    const { cookies } = require('next/headers');\n    (cookies as jest.Mock).mockResolvedValue(mockCookieStore);\n\n    // Mock createServerClient to return our mock client\n    const { createServerClient } = require('@supabase/ssr');\n    (createServerClient as jest.Mock).mockReturnValue(mockSupabaseClient);\n  });\n\n  describe('createAuthenticatedClient', () => {\n    it('should create Supabase client with cookie handling', async () => {\n      const { createServerClient } = require('@supabase/ssr');\n      const { createAuthenticatedClient } = require('./supabaseServer');\n      \n      await createAuthenticatedClient();\n      \n      expect(createServerClient).toHaveBeenCalledWith(\n        process.env.NEXT_PUBLIC_SUPABASE_URL,\n        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,\n        expect.objectContaining({\n          cookies: expect.objectContaining({\n            getAll: expect.any(Function),\n            setAll: expect.any(Function),\n          }),\n        })\n      );\n    });\n\n    it('should return Supabase client instance', async () => {\n      const { createAuthenticatedClient } = require('./supabaseServer');\n      \n      const client = await createAuthenticatedClient();\n      \n      expect(client).toBeDefined();\n      expect(client).toBe(mockSupabaseClient);\n    });\n\n    it('should await cookies() before creating client', async () => {\n      const { cookies } = require('next/headers');\n      const { createAuthenticatedClient } = require('./supabaseServer');\n      \n      await createAuthenticatedClient();\n      \n      expect(cookies).toHaveBeenCalled();\n    });\n\n    it('should handle cookie getAll correctly', async () => {\n      const mockCookies = [\n        { name: 'session', value: 'abc123' },\n        { name: 'refresh', value: 'xyz789' },\n      ];\n      mockCookieStore.getAll.mockReturnValue(mockCookies);\n      \n      const { createAuthenticatedClient } = require('./supabaseServer');\n      await createAuthenticatedClient();\n      \n      const { createServerClient } = require('@supabase/ssr');\n      const cookiesConfig = (createServerClient as jest.Mock).mock.calls[0][2].cookies;\n      \n      const result = cookiesConfig.getAll();\n      expect(result).toEqual(mockCookies);\n    });\n\n    it('should handle cookie setAll correctly', async () => {\n      const { createAuthenticatedClient } = require('./supabaseServer');\n      await createAuthenticatedClient();\n      \n      const { createServerClient } = require('@supabase/ssr');\n      const cookiesConfig = (createServerClient as jest.Mock).mock.calls[0][2].cookies;\n      \n      const cookiesToSet = [\n        { name: 'session', value: 'new123', options: {} },\n        { name: 'refresh', value: 'new789', options: {} },\n      ];\n      \n      cookiesConfig.setAll(cookiesToSet);\n      \n      expect(mockCookieStore.set).toHaveBeenCalledTimes(2);\n      expect(mockCookieStore.set).toHaveBeenCalledWith('session', 'new123', {});\n      expect(mockCookieStore.set).toHaveBeenCalledWith('refresh', 'new789', {});\n    });\n\n    it('should handle cookie setting errors gracefully', async () => {\n      mockCookieStore.set.mockImplementation(() => {\n        throw new Error('Cookie setting failed');\n      });\n      \n      const { createAuthenticatedClient } = require('./supabaseServer');\n      await createAuthenticatedClient();\n      \n      const { createServerClient } = require('@supabase/ssr');\n      const cookiesConfig = (createServerClient as jest.Mock).mock.calls[0][2].cookies;\n      \n      const cookiesToSet = [\n        { name: 'session', value: 'new123', options: {} },\n      ];\n      \n      // Should not throw error\n      expect(() => {\n        cookiesConfig.setAll(cookiesToSet);\n      }).not.toThrow();\n    });\n\n    it('should log error when cookie setting fails', async () => {\n      const consoleErrorSpy = jest.spyOn(console, 'error').mockImplementation();\n      mockCookieStore.set.mockImplementation(() => {\n        throw new Error('Cookie setting failed');\n      });\n      \n      const { createAuthenticatedClient } = require('./supabaseServer');\n      await createAuthenticatedClient();\n      \n      const { createServerClient } = require('@supabase/ssr');\n      const cookiesConfig = (createServerClient as jest.Mock).mock.calls[0][2].cookies;\n      \n      const cookiesToSet = [\n        { name: 'session', value: 'new123', options: {} },\n      ];\n      \n      cookiesConfig.setAll(cookiesToSet);\n      \n      expect(consoleErrorSpy).toHaveBeenCalledWith(\n        'Error setting cookies:',\n        expect.any(Error)\n      );\n      \n      consoleErrorSpy.mockRestore();\n    });\n\n    it('should handle empty cookie array', async () => {\n      mockCookieStore.getAll.mockReturnValue([]);\n      \n      const { createAuthenticatedClient } = require('./supabaseServer');\n      await createAuthenticatedClient();\n      \n      const { createServerClient } = require('@supabase/ssr');\n      const cookiesConfig = (createServerClient as jest.Mock).mock.calls[0][2].cookies;\n      \n      const result = cookiesConfig.getAll();\n      expect(result).toEqual([]);\n    });\n\n    it('should handle setting empty cookie array', async () => {\n      const { createAuthenticatedClient } = require('./supabaseServer');\n      await createAuthenticatedClient();\n      \n      const { createServerClient } = require('@supabase/ssr');\n      const cookiesConfig = (createServerClient as jest.Mock).mock.calls[0][2].cookies;\n      \n      cookiesConfig.setAll([]);\n      \n      expect(mockCookieStore.set).not.toHaveBeenCalled();\n    });\n\n    it('should handle cookies with options', async () => {\n      const { createAuthenticatedClient } = require('./supabaseServer');\n      await createAuthenticatedClient();\n      \n      const { createServerClient } = require('@supabase/ssr');\n      const cookiesConfig = (createServerClient as jest.Mock).mock.calls[0][2].cookies;\n      \n      const cookiesToSet = [\n        {\n          name: 'session',\n          value: 'abc123',\n          options: {\n            httpOnly: true,\n            secure: true,\n            sameSite: 'lax' as const,\n            maxAge: 3600,\n          },\n        },\n      ];\n      \n      cookiesConfig.setAll(cookiesToSet);\n      \n      expect(mockCookieStore.set).toHaveBeenCalledWith(\n        'session',\n        'abc123',\n        {\n          httpOnly: true,\n          secure: true,\n          sameSite: 'lax',\n          maxAge: 3600,\n        }\n      );\n    });\n\n    it('should work with authenticated session', async () => {\n      mockSupabaseClient.auth.getSession.mockResolvedValue({\n        data: {\n          session: {\n            user: { id: 'user-123', email: 'test@example.com' },\n            access_token: 'token-123',\n          },\n        },\n        error: null,\n      });\n      \n      const { createAuthenticatedClient } = require('./supabaseServer');\n      const client = await createAuthenticatedClient();\n      \n      const { data } = await client.auth.getSession();\n      \n      expect(data.session).toBeDefined();\n      expect(data.session.user.id).toBe('user-123');\n    });\n\n    it('should work without authenticated session', async () => {\n      mockSupabaseClient.auth.getSession.mockResolvedValue({\n        data: { session: null },\n        error: null,\n      });\n      \n      const { createAuthenticatedClient } = require('./supabaseServer');\n      const client = await createAuthenticatedClient();\n      \n      const { data } = await client.auth.getSession();\n      \n      expect(data.session).toBeNull();\n    });\n  });\n\n  describe('environment variable handling', () => {\n    it('should use NEXT_PUBLIC_SUPABASE_URL from environment', async () => {\n      process.env.NEXT_PUBLIC_SUPABASE_URL = 'https://custom.supabase.co';\n      \n      const { createServerClient } = require('@supabase/ssr');\n      const { createAuthenticatedClient } = require('./supabaseServer');\n      \n      await createAuthenticatedClient();\n      \n      expect(createServerClient).toHaveBeenCalledWith(\n        'https://custom.supabase.co',\n        expect.any(String),\n        expect.any(Object)\n      );\n    });\n\n    it('should use NEXT_PUBLIC_SUPABASE_ANON_KEY from environment', async () => {\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY = 'custom-anon-key';\n      \n      const { createServerClient } = require('@supabase/ssr');\n      const { createAuthenticatedClient } = require('./supabaseServer');\n      \n      await createAuthenticatedClient();\n      \n      expect(createServerClient).toHaveBeenCalledWith(\n        expect.any(String),\n        'custom-anon-key',\n        expect.any(Object)\n      );\n    });\n  });\n});\n"],"names":["jest","mock","cookies","fn","createServerClient","describe","mockCookieStore","mockSupabaseClient","beforeEach","clearAllMocks","getAll","mockReturnValue","set","auth","getSession","getUser","from","require","mockResolvedValue","it","createAuthenticatedClient","expect","toHaveBeenCalledWith","process","env","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","objectContaining","any","Function","setAll","client","toBeDefined","toBe","toHaveBeenCalled","mockCookies","name","value","cookiesConfig","calls","result","toEqual","cookiesToSet","options","toHaveBeenCalledTimes","mockImplementation","Error","not","toThrow","consoleErrorSpy","spyOn","console","mockRestore","httpOnly","secure","sameSite","maxAge","data","session","user","id","email","access_token","error","toBeNull","String","Object"],"mappings":"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"}