{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/guests/[id]/rsvps/route.ts"],"sourcesContent":["import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\n\n/**\n * GET /api/admin/guests/[id]/rsvps\n * \n * Get all RSVPs for a guest (activities, events, accommodations)\n * \n * @param request - Next.js request object\n * @param params - Route parameters containing guest ID\n * @returns Guest RSVPs with capacity information\n */\nexport async function GET(\n  request: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // 1. Auth check\n    const supabase = createRouteHandlerClient({ cookies });\n    const {\n      data: { session },\n      error: authError,\n    } = await supabase.auth.getSession();\n\n    if (authError || !session) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: { code: 'UNAUTHORIZED', message: 'Authentication required' },\n        },\n        { status: 401 }\n      );\n    }\n\n    // 2. Get guest ID from params\n    const { id: guestId } = await params;\n\n    if (!guestId) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: { code: 'VALIDATION_ERROR', message: 'Guest ID is required' },\n        },\n        { status: 400 }\n      );\n    }\n\n    // 3. Fetch activity RSVPs with capacity info\n    const { data: activityRSVPs, error: activityError } = await supabase\n      .from('activity_rsvps')\n      .select(\n        `\n        id,\n        status,\n        guest_count,\n        dietary_restrictions,\n        activities (\n          id,\n          title,\n          date,\n          time,\n          location,\n          capacity,\n          requires_guest_count,\n          requires_dietary_info\n        )\n      `\n      )\n      .eq('guest_id', guestId);\n\n    if (activityError) {\n      console.error('Error fetching activity RSVPs:', activityError);\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'DATABASE_ERROR',\n            message: 'Failed to fetch activity RSVPs',\n            details: activityError,\n          },\n        },\n        { status: 500 }\n      );\n    }\n\n    // 4. Fetch event RSVPs\n    const { data: eventRSVPs, error: eventError } = await supabase\n      .from('event_rsvps')\n      .select(\n        `\n        id,\n        status,\n        events (\n          id,\n          title,\n          date,\n          time,\n          location\n        )\n      `\n      )\n      .eq('guest_id', guestId);\n\n    if (eventError) {\n      console.error('Error fetching event RSVPs:', eventError);\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'DATABASE_ERROR',\n            message: 'Failed to fetch event RSVPs',\n            details: eventError,\n          },\n        },\n        { status: 500 }\n      );\n    }\n\n    // 5. Fetch accommodation assignments\n    const { data: accommodations, error: accommodationError } = await supabase\n      .from('guest_accommodations')\n      .select(\n        `\n        id,\n        check_in_date,\n        check_out_date,\n        room_types (\n          id,\n          name,\n          accommodations (\n            id,\n            name,\n            location\n          )\n        )\n      `\n      )\n      .eq('guest_id', guestId);\n\n    if (accommodationError) {\n      console.error('Error fetching accommodations:', accommodationError);\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'DATABASE_ERROR',\n            message: 'Failed to fetch accommodations',\n            details: accommodationError,\n          },\n        },\n        { status: 500 }\n      );\n    }\n\n    // 6. Calculate capacity remaining for each activity\n    const activitiesWithCapacity = await Promise.all(\n      (activityRSVPs || []).map(async (rsvp: any) => {\n        const activity = rsvp.activities;\n        if (!activity || !activity.capacity) {\n          return {\n            id: rsvp.id,\n            name: activity?.title || 'Unknown Activity',\n            type: 'activity' as const,\n            status: rsvp.status || 'pending',\n            guestCount: rsvp.guest_count,\n            dietaryRestrictions: rsvp.dietary_restrictions,\n            requiresGuestCount: activity?.requires_guest_count || false,\n            requiresDietaryInfo: activity?.requires_dietary_info || false,\n            date: activity?.date,\n            time: activity?.time,\n            location: activity?.location,\n          };\n        }\n\n        // Count attending RSVPs for this activity\n        const { count, error: countError } = await supabase\n          .from('activity_rsvps')\n          .select('*', { count: 'exact', head: true })\n          .eq('activity_id', activity.id)\n          .eq('status', 'attending');\n\n        if (countError) {\n          console.error('Error counting RSVPs:', countError);\n        }\n\n        const capacityRemaining = activity.capacity - (count || 0);\n\n        return {\n          id: rsvp.id,\n          name: activity.title,\n          type: 'activity' as const,\n          status: rsvp.status || 'pending',\n          guestCount: rsvp.guest_count,\n          dietaryRestrictions: rsvp.dietary_restrictions,\n          capacity: activity.capacity,\n          capacityRemaining,\n          requiresGuestCount: activity.requires_guest_count || false,\n          requiresDietaryInfo: activity.requires_dietary_info || false,\n          date: activity.date,\n          time: activity.time,\n          location: activity.location,\n        };\n      })\n    );\n\n    // 7. Format event RSVPs\n    const formattedEvents = (eventRSVPs || []).map((rsvp: any) => ({\n      id: rsvp.id,\n      name: rsvp.events?.title || 'Unknown Event',\n      type: 'event' as const,\n      status: rsvp.status || 'pending',\n      date: rsvp.events?.date,\n      time: rsvp.events?.time,\n      location: rsvp.events?.location,\n    }));\n\n    // 8. Format accommodations\n    const formattedAccommodations = (accommodations || []).map((acc: any) => ({\n      id: acc.id,\n      name: `${acc.room_types?.accommodations?.name || 'Unknown'} - ${acc.room_types?.name || 'Unknown Room'}`,\n      type: 'accommodation' as const,\n      status: 'attending' as const, // Accommodations are always \"attending\" if assigned\n      date: acc.check_in_date,\n      location: acc.room_types?.accommodations?.location,\n    }));\n\n    // 9. Return formatted data\n    return NextResponse.json({\n      success: true,\n      data: {\n        activities: activitiesWithCapacity,\n        events: formattedEvents,\n        accommodations: formattedAccommodations,\n      },\n    });\n  } catch (error) {\n    console.error('Error in GET /api/admin/guests/[id]/rsvps:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'UNKNOWN_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error occurred',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["GET","request","params","supabase","createRouteHandlerClient","cookies","data","session","error","authError","auth","getSession","NextResponse","json","success","code","message","status","id","guestId","activityRSVPs","activityError","from","select","eq","console","details","eventRSVPs","eventError","accommodations","accommodationError","activitiesWithCapacity","Promise","all","map","rsvp","activity","activities","capacity","name","title","type","guestCount","guest_count","dietaryRestrictions","dietary_restrictions","requiresGuestCount","requires_guest_count","requiresDietaryInfo","requires_dietary_info","date","time","location","count","countError","head","capacityRemaining","formattedEvents","events","formattedAccommodations","acc","room_types","check_in_date","Error"],"mappings":"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"}