{"version":3,"names":["DELETE","cov_m3sv95cbk","f","s","PUT","request","params","id","supabase","_authhelpersnextjs","createRouteHandlerClient","cookies","_headers","data","session","error","authError","auth","getSession","b","_server","NextResponse","json","success","code","message","status","body","validation","_emailSchemas","updateEmailTemplateSchema","safeParse","details","issues","result","_emailService","updateTemplate","statusCode","emailsUsingTemplate","checkError","from","select","eq","limit","length","deleteTemplate"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/emails/templates/[id]/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { cookies } from 'next/headers';\nimport * as emailService from '@/services/emailService';\nimport { updateEmailTemplateSchema } from '@/schemas/emailSchemas';\n\n/**\n * PUT /api/admin/emails/templates/[id]\n * Updates an email template\n * Requirements: 17.4\n */\nexport async function PUT(\n  request: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // Await params for Next.js 15+\n    const { id } = await params;\n    \n    // 1. Auth check\n    const supabase = createRouteHandlerClient({ cookies });\n    const { data: { session }, error: authError } = await supabase.auth.getSession();\n    \n    if (authError || !session) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n\n    // 2. Parse and validate\n    const body = await request.json();\n    const validation = updateEmailTemplateSchema.safeParse(body);\n    \n    if (!validation.success) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: { \n            code: 'VALIDATION_ERROR', \n            message: 'Invalid request', \n            details: validation.error.issues \n          } \n        },\n        { status: 400 }\n      );\n    }\n\n    // 3. Call service\n    const result = await emailService.updateTemplate(id, validation.data);\n\n    // 4. Return response\n    if (result.success) {\n      return NextResponse.json(result, { status: 200 });\n    } else {\n      const statusCode = result.error.code === 'VALIDATION_ERROR' ? 400 \n                       : result.error.code === 'NOT_FOUND' ? 404 \n                       : 500;\n      return NextResponse.json(result, { status: statusCode });\n    }\n  } catch (error) {\n    return NextResponse.json(\n      { success: false, error: { code: 'INTERNAL_ERROR', message: 'Internal server error' } },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * DELETE /api/admin/emails/templates/[id]\n * Deletes an email template\n * Requirements: 17.7, 17.8\n */\nexport async function DELETE(\n  request: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // Await params for Next.js 15+\n    const { id } = await params;\n    \n    // 1. Auth check\n    const supabase = createRouteHandlerClient({ cookies });\n    const { data: { session }, error: authError } = await supabase.auth.getSession();\n    \n    if (authError || !session) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n\n    // 2. Check if template is in use (prevent deletion)\n    // This would require checking email_history table for references\n    const { data: emailsUsingTemplate, error: checkError } = await supabase\n      .from('email_logs')\n      .select('id')\n      .eq('template_id', id)\n      .limit(1);\n\n    if (checkError) {\n      return NextResponse.json(\n        { success: false, error: { code: 'DATABASE_ERROR', message: checkError.message } },\n        { status: 500 }\n      );\n    }\n\n    if (emailsUsingTemplate && emailsUsingTemplate.length > 0) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: { \n            code: 'TEMPLATE_IN_USE', \n            message: 'Cannot delete template that has been used to send emails' \n          } \n        },\n        { status: 409 }\n      );\n    }\n\n    // 3. Call service\n    const result = await emailService.deleteTemplate(id);\n\n    // 4. Return response\n    if (result.success) {\n      return NextResponse.json(result, { status: 200 });\n    } else {\n      const statusCode = result.error.code === 'NOT_FOUND' ? 404 : 500;\n      return NextResponse.json(result, { status: statusCode });\n    }\n  } catch (error) {\n    return NextResponse.json(\n      { success: false, error: { code: 'INTERNAL_ERROR', message: 'Internal server error' } },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}