{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/admin/locations/page.tsx"],"sourcesContent":["'use client';\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { CollapsibleForm } from '@/components/admin/CollapsibleForm';\nimport { DataTable } from '@/components/ui/DataTable';\nimport type { Location, LocationWithChildren } from '@/schemas/locationSchemas';\nimport { createLocationSchema } from '@/schemas/locationSchemas';\n\ninterface LocationManagementPageProps {}\n\nexport default function LocationManagementPage({}: LocationManagementPageProps) {\n  const [locations, setLocations] = useState<LocationWithChildren[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [isFormOpen, setIsFormOpen] = useState(false);\n  const [editingLocation, setEditingLocation] = useState<Location | null>(null);\n  const [searchQuery, setSearchQuery] = useState('');\n  const [expandedNodes, setExpandedNodes] = useState<Set<string>>(new Set());\n\n  // Load locations hierarchy\n  const loadLocations = useCallback(async () => {\n    setLoading(true);\n    setError(null);\n    try {\n      const response = await fetch('/api/admin/locations');\n      const result = await response.json();\n      \n      if (result.success) {\n        setLocations(result.data);\n        setError(null);\n      } else {\n        setError(result.error.message);\n        setLocations([]); // Keep locations as empty array on error\n      }\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to load locations');\n      setLocations([]); // Keep locations as empty array on error\n    } finally {\n      setLoading(false);\n    }\n  }, []);\n\n  useEffect(() => {\n    loadLocations();\n  }, [loadLocations]);\n\n  // Handle form submission\n  const handleSubmit = useCallback(async (data: any) => {\n    try {\n      const url = editingLocation\n        ? `/api/admin/locations/${editingLocation.id}`\n        : '/api/admin/locations';\n      const method = editingLocation ? 'PUT' : 'POST';\n\n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(data),\n      });\n\n      const result = await response.json();\n\n      if (result.success) {\n        await loadLocations();\n        setIsFormOpen(false);\n        setEditingLocation(null);\n        setError(null);\n      } else {\n        setError(result.error.message);\n      }\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to save location');\n    }\n  }, [editingLocation, loadLocations]);\n\n  // Handle delete\n  const handleDelete = useCallback(async (id: string) => {\n    if (!confirm('Are you sure you want to delete this location? Child locations will become orphaned.')) {\n      return;\n    }\n\n    try {\n      const response = await fetch(`/api/admin/locations/${id}`, {\n        method: 'DELETE',\n      });\n\n      const result = await response.json();\n\n      if (result.success) {\n        await loadLocations();\n      } else {\n        alert(result.error.message);\n      }\n    } catch (err) {\n      alert(err instanceof Error ? err.message : 'Failed to delete location');\n    }\n  }, [loadLocations]);\n\n  // Handle edit\n  const handleEdit = useCallback((location: Location) => {\n    setEditingLocation(location);\n    setIsFormOpen(true);\n  }, []);\n\n  // Toggle node expansion\n  const toggleNode = useCallback((id: string) => {\n    setExpandedNodes((prev) => {\n      const next = new Set(prev);\n      if (next.has(id)) {\n        next.delete(id);\n      } else {\n        next.add(id);\n      }\n      return next;\n    });\n  }, []);\n\n  // Render tree node\n  const renderTreeNode = useCallback((location: LocationWithChildren, level: number = 0): React.JSX.Element => {\n    const hasChildren = location.children && location.children.length > 0;\n    const isExpanded = expandedNodes.has(location.id);\n    const indent = level * 24;\n\n    return (\n      <div key={location.id} className=\"border-b border-gray-200\">\n        <div\n          className=\"flex items-center py-3 px-4 hover:bg-gray-50\"\n          style={{ paddingLeft: `${indent + 16}px` }}\n        >\n          {hasChildren && (\n            <button\n              onClick={() => toggleNode(location.id)}\n              className=\"mr-2 text-gray-500 hover:text-gray-700\"\n              aria-label={isExpanded ? 'Collapse' : 'Expand'}\n            >\n              {isExpanded ? '‚ñº' : '‚ñ∂'}\n            </button>\n          )}\n          {!hasChildren && <span className=\"mr-2 w-4\" />}\n          \n          <span className=\"mr-2\">üìç</span>\n          \n          <div className=\"flex-1\">\n            <div className=\"font-medium text-gray-900\">{location.name}</div>\n            {location.address && (\n              <div className=\"text-sm text-gray-500\">{location.address}</div>\n            )}\n          </div>\n\n          <div className=\"flex gap-2\">\n            <button\n              onClick={() => handleEdit(location)}\n              className=\"px-3 py-1 text-sm text-blue-600 hover:text-blue-800\"\n            >\n              Edit\n            </button>\n            <button\n              onClick={() => handleDelete(location.id)}\n              className=\"px-3 py-1 text-sm text-red-600 hover:text-red-800\"\n            >\n              Delete\n            </button>\n          </div>\n        </div>\n\n        {hasChildren && isExpanded && (\n          <div>\n            {location.children.map((child) => renderTreeNode(child, level + 1))}\n          </div>\n        )}\n      </div>\n    );\n  }, [expandedNodes, toggleNode, handleEdit, handleDelete]);\n\n  // Filter locations by search query\n  const filterLocations = useCallback((locs: LocationWithChildren[], query: string): LocationWithChildren[] => {\n    if (!query) return locs;\n\n    const filtered: LocationWithChildren[] = [];\n    const lowerQuery = query.toLowerCase();\n\n    for (const loc of locs) {\n      const matches = \n        loc.name.toLowerCase().includes(lowerQuery) ||\n        (loc.address && loc.address.toLowerCase().includes(lowerQuery)) ||\n        (loc.description && loc.description.toLowerCase().includes(lowerQuery));\n\n      const filteredChildren = filterLocations(loc.children, query);\n\n      if (matches || filteredChildren.length > 0) {\n        filtered.push({\n          ...loc,\n          children: filteredChildren,\n        });\n      }\n    }\n\n    return filtered;\n  }, []);\n\n  const filteredLocations = filterLocations(locations, searchQuery);\n\n  // Form fields\n  const formFields = [\n    {\n      name: 'name',\n      label: 'Location Name',\n      type: 'text' as const,\n      required: true,\n      placeholder: 'e.g., Tamarindo Beach',\n    },\n    {\n      name: 'parentLocationId',\n      label: 'Parent Location',\n      type: 'select' as const,\n      required: false,\n      options: [\n        { value: '', label: 'None (Root Location)' },\n        ...flattenLocations(locations).map((loc) => ({\n          value: loc.id,\n          label: loc.name,\n        })),\n      ],\n    },\n    {\n      name: 'address',\n      label: 'Address',\n      type: 'text' as const,\n      required: false,\n      placeholder: 'e.g., Tamarindo, Guanacaste, Costa Rica',\n    },\n    {\n      name: 'description',\n      label: 'Description',\n      type: 'textarea' as const,\n      required: false,\n      placeholder: 'Optional description',\n    },\n  ];\n\n  return (\n    <div className=\"p-6\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-2xl font-bold text-gray-900\">Locations</h1>\n        <p className=\"text-gray-600\">Manage location hierarchy</p>\n      </div>\n\n      {error && (\n        <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-md text-red-800\">\n          {error}\n        </div>\n      )}\n\n      <div className=\"mb-4 flex gap-4\">\n        <input\n          type=\"text\"\n          placeholder=\"Search locations...\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          className=\"flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n        />\n        <button\n          onClick={() => {\n            setEditingLocation(null);\n            setIsFormOpen(!isFormOpen);\n          }}\n          className=\"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700\"\n        >\n          {isFormOpen ? 'Cancel' : '+ Add Location'}\n        </button>\n      </div>\n\n      <CollapsibleForm\n        title={editingLocation ? 'Edit Location' : 'Add New Location'}\n        fields={formFields}\n        schema={createLocationSchema}\n        onSubmit={handleSubmit}\n        onCancel={() => {\n          setIsFormOpen(false);\n          setEditingLocation(null);\n        }}\n        initialData={editingLocation || undefined}\n        isOpen={isFormOpen}\n        onToggle={() => setIsFormOpen(!isFormOpen)}\n      />\n\n      <div className=\"mt-6 bg-white rounded-lg shadow\">\n        {loading ? (\n          <div className=\"p-8 text-center text-gray-500\">Loading locations...</div>\n        ) : filteredLocations.length === 0 ? (\n          <div className=\"p-8 text-center text-gray-500\">\n            {searchQuery ? 'No locations match your search' : 'No locations yet. Add your first location above.'}\n          </div>\n        ) : (\n          <div>\n            {filteredLocations.map((location) => renderTreeNode(location))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\n// Helper function to flatten location hierarchy\nfunction flattenLocations(locations: LocationWithChildren[]): Location[] {\n  const result: Location[] = [];\n  \n  function traverse(locs: LocationWithChildren[]) {\n    for (const loc of locs) {\n      result.push(loc);\n      if (loc.children && loc.children.length > 0) {\n        traverse(loc.children);\n      }\n    }\n  }\n  \n  traverse(locations);\n  return result;\n}\n"],"names":["LocationManagementPage","locations","setLocations","useState","loading","setLoading","error","setError","isFormOpen","setIsFormOpen","editingLocation","setEditingLocation","searchQuery","setSearchQuery","expandedNodes","setExpandedNodes","Set","loadLocations","useCallback","response","fetch","result","json","success","data","message","err","Error","useEffect","handleSubmit","url","id","method","headers","body","JSON","stringify","handleDelete","confirm","alert","handleEdit","location","toggleNode","prev","next","has","delete","add","renderTreeNode","level","hasChildren","children","length","isExpanded","indent","div","className","style","paddingLeft","button","onClick","aria-label","span","name","address","map","child","filterLocations","locs","query","filtered","lowerQuery","toLowerCase","loc","matches","includes","description","filteredChildren","push","filteredLocations","formFields","label","type","required","placeholder","options","value","flattenLocations","h1","p","input","onChange","e","target","CollapsibleForm","title","fields","schema","createLocationSchema","onSubmit","onCancel","initialData","undefined","isOpen","onToggle","traverse"],"mappings":"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"}