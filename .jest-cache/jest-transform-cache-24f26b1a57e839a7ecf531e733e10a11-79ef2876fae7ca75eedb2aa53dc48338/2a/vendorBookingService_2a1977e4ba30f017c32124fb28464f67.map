{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/vendorBookingService.ts"],"sourcesContent":["/**\n * Vendor Booking Service\n * \n * Handles vendor-to-activity/event associations and cost propagation\n * when vendor information changes.\n * \n * Requirements: 8.2, 8.4, 8.9, 8.10\n */\n\nimport { createClient } from '@supabase/supabase-js';\nimport {\n  createVendorBookingSchema,\n  updateVendorBookingSchema,\n  vendorBookingFilterSchema,\n  type CreateVendorBookingDTO,\n  type UpdateVendorBookingDTO,\n  type VendorBookingFilterDTO,\n  type VendorBooking,\n  type PaginatedVendorBookings,\n  type VendorBookingWithDetails,\n} from '../schemas/vendorBookingSchemas';\nimport { sanitizeInput } from '../utils/sanitization';\n\n// Result type for consistent error handling\ntype Result<T> =\n  | { success: true; data: T }\n  | { success: false; error: { code: string; message: string; details?: unknown } };\n\n// Initialize Supabase client\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n);\n\n/**\n * Creates a new vendor booking linking a vendor to an activity or event.\n * \n * @param data - Booking data including vendor ID, activity/event ID, and booking date\n * @returns Result containing the created booking or error details\n * \n * @example\n * const result = await vendorBookingService.create({\n *   vendorId: 'vendor-uuid',\n *   activityId: 'activity-uuid',\n *   bookingDate: '2025-06-15',\n * });\n */\nexport async function create(data: CreateVendorBookingDTO): Promise<Result<VendorBooking>> {\n  try {\n    // 1. Validate\n    const validation = createVendorBookingSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize user input\n    const sanitized = {\n      ...validation.data,\n      notes: validation.data.notes ? sanitizeInput(validation.data.notes) : null,\n    };\n\n    // 3. Database operation\n    const { data: booking, error } = await supabase\n      .from('vendor_bookings')\n      .insert({\n        vendor_id: sanitized.vendorId,\n        activity_id: sanitized.activityId,\n        event_id: sanitized.eventId,\n        booking_date: sanitized.bookingDate,\n        guest_count: sanitized.guestCount,\n        pricing_model: sanitized.pricingModel,\n        total_cost: sanitized.totalCost,\n        host_subsidy: sanitized.hostSubsidy,\n        notes: sanitized.notes,\n      })\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return {\n      success: true,\n      data: mapBookingFromDb(booking),\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Retrieves a vendor booking by ID.\n * \n * @param id - Booking UUID\n * @returns Result containing the booking or error details\n */\nexport async function get(id: string): Promise<Result<VendorBooking>> {\n  try {\n    const { data: booking, error } = await supabase\n      .from('vendor_bookings')\n      .select('*')\n      .eq('id', id)\n      .single();\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        return {\n          success: false,\n          error: {\n            code: 'NOT_FOUND',\n            message: 'Vendor booking not found',\n          },\n        };\n      }\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return {\n      success: true,\n      data: mapBookingFromDb(booking),\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Updates an existing vendor booking.\n * \n * @param id - Booking UUID\n * @param data - Partial booking data to update\n * @returns Result containing the updated booking or error details\n */\nexport async function update(id: string, data: UpdateVendorBookingDTO): Promise<Result<VendorBooking>> {\n  try {\n    // 1. Validate\n    const validation = updateVendorBookingSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize user input\n    const sanitized: Record<string, unknown> = {};\n    if (validation.data.notes !== undefined) {\n      sanitized.notes = validation.data.notes ? sanitizeInput(validation.data.notes) : null;\n    }\n    if (validation.data.vendorId !== undefined) {\n      sanitized.vendor_id = validation.data.vendorId;\n    }\n    if (validation.data.activityId !== undefined) {\n      sanitized.activity_id = validation.data.activityId;\n    }\n    if (validation.data.eventId !== undefined) {\n      sanitized.event_id = validation.data.eventId;\n    }\n    if (validation.data.bookingDate !== undefined) {\n      sanitized.booking_date = validation.data.bookingDate;\n    }\n    if (validation.data.guestCount !== undefined) {\n      sanitized.guest_count = validation.data.guestCount;\n    }\n    if (validation.data.pricingModel !== undefined) {\n      sanitized.pricing_model = validation.data.pricingModel;\n    }\n    if (validation.data.totalCost !== undefined) {\n      sanitized.total_cost = validation.data.totalCost;\n    }\n    if (validation.data.hostSubsidy !== undefined) {\n      sanitized.host_subsidy = validation.data.hostSubsidy;\n    }\n\n    // 3. Database operation\n    const { data: booking, error } = await supabase\n      .from('vendor_bookings')\n      .update(sanitized)\n      .eq('id', id)\n      .select()\n      .single();\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        return {\n          success: false,\n          error: {\n            code: 'NOT_FOUND',\n            message: 'Vendor booking not found',\n          },\n        };\n      }\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return {\n      success: true,\n      data: mapBookingFromDb(booking),\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Deletes a vendor booking from the system.\n * \n * @param id - Booking UUID\n * @returns Result indicating success or error details\n */\nexport async function deleteBooking(id: string): Promise<Result<void>> {\n  try {\n    const { error } = await supabase\n      .from('vendor_bookings')\n      .delete()\n      .eq('id', id);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Lists vendor bookings with optional filtering and pagination.\n * \n * @param filters - Optional filters for vendor, activity, event, and pagination\n * @returns Result containing paginated booking list or error details\n */\nexport async function list(filters: VendorBookingFilterDTO = {}): Promise<Result<PaginatedVendorBookings>> {\n  try {\n    // Validate filters\n    const validation = vendorBookingFilterSchema.safeParse(filters);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid filters',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    const { vendorId, activityId, eventId, page = 1, pageSize = 50 } = validation.data;\n\n    // Build query\n    let query = supabase.from('vendor_bookings').select('*', { count: 'exact' });\n\n    if (vendorId) {\n      query = query.eq('vendor_id', vendorId);\n    }\n    if (activityId) {\n      query = query.eq('activity_id', activityId);\n    }\n    if (eventId) {\n      query = query.eq('event_id', eventId);\n    }\n\n    // Apply pagination\n    const from = (page - 1) * pageSize;\n    const to = from + pageSize - 1;\n    query = query.range(from, to).order('booking_date', { ascending: true });\n\n    const { data: bookings, error, count } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    const total = count || 0;\n    const totalPages = Math.ceil(total / pageSize);\n\n    return {\n      success: true,\n      data: {\n        bookings: bookings.map(mapBookingFromDb),\n        total,\n        page,\n        pageSize,\n        totalPages,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Gets vendor bookings with full details including vendor and activity/event names.\n * \n * @param filters - Optional filters for vendor, activity, event\n * @returns Result containing bookings with details or error details\n */\nexport async function listWithDetails(filters: VendorBookingFilterDTO = {}): Promise<Result<VendorBookingWithDetails[]>> {\n  try {\n    // Validate filters\n    const validation = vendorBookingFilterSchema.safeParse(filters);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid filters',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    const { vendorId, activityId, eventId } = validation.data;\n\n    // Build query with joins\n    let query = supabase\n      .from('vendor_bookings')\n      .select(`\n        *,\n        vendors (id, name, category),\n        activities (id, name),\n        events (id, name)\n      `);\n\n    if (vendorId) {\n      query = query.eq('vendor_id', vendorId);\n    }\n    if (activityId) {\n      query = query.eq('activity_id', activityId);\n    }\n    if (eventId) {\n      query = query.eq('event_id', eventId);\n    }\n\n    const { data: bookings, error } = await query.order('booking_date', { ascending: true });\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    const bookingsWithDetails: VendorBookingWithDetails[] = bookings.map((booking: any) => ({\n      id: booking.id,\n      vendorId: booking.vendor_id,\n      vendorName: booking.vendors?.name || 'Unknown',\n      vendorCategory: booking.vendors?.category || 'other',\n      activityId: booking.activity_id,\n      activityName: booking.activities?.name || null,\n      eventId: booking.event_id,\n      eventName: booking.events?.name || null,\n      bookingDate: booking.booking_date,\n      guestCount: booking.guest_count,\n      pricingModel: booking.pricing_model,\n      totalCost: booking.total_cost,\n      hostSubsidy: booking.host_subsidy,\n      notes: booking.notes,\n      createdAt: booking.created_at,\n    }));\n\n    return {\n      success: true,\n      data: bookingsWithDetails,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Gets all bookings for a specific vendor.\n * \n * @param vendorId - Vendor UUID\n * @returns Result containing vendor's bookings or error details\n */\nexport async function getVendorBookings(vendorId: string): Promise<Result<VendorBookingWithDetails[]>> {\n  return listWithDetails({ vendorId });\n}\n\n/**\n * Gets all bookings for a specific activity.\n * \n * @param activityId - Activity UUID\n * @returns Result containing activity's bookings or error details\n */\nexport async function getActivityBookings(activityId: string): Promise<Result<VendorBookingWithDetails[]>> {\n  return listWithDetails({ activityId });\n}\n\n/**\n * Gets all bookings for a specific event.\n * \n * @param eventId - Event UUID\n * @returns Result containing event's bookings or error details\n */\nexport async function getEventBookings(eventId: string): Promise<Result<VendorBookingWithDetails[]>> {\n  return listWithDetails({ eventId });\n}\n\n/**\n * Propagates vendor cost changes to all related bookings.\n * This is called when a vendor's cost is updated to ensure\n * budget calculations reflect the new cost.\n * \n * @param vendorId - Vendor UUID\n * @returns Result indicating success or error details\n */\nexport async function propagateVendorCostChange(vendorId: string): Promise<Result<void>> {\n  try {\n    // Get all bookings for this vendor\n    const bookingsResult = await getVendorBookings(vendorId);\n    if (!bookingsResult.success) {\n      return bookingsResult as Result<void>;\n    }\n\n    // Note: In a real implementation, this would trigger recalculation\n    // of budget totals for all activities/events associated with this vendor.\n    // For now, we just return success as the budget service will\n    // recalculate on-demand when requested.\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Maps database booking record to VendorBooking type.\n */\nfunction mapBookingFromDb(dbBooking: any): VendorBooking {\n  return {\n    id: dbBooking.id,\n    vendorId: dbBooking.vendor_id,\n    activityId: dbBooking.activity_id,\n    eventId: dbBooking.event_id,\n    bookingDate: dbBooking.booking_date,\n    guestCount: dbBooking.guest_count,\n    pricingModel: dbBooking.pricing_model,\n    totalCost: dbBooking.total_cost,\n    hostSubsidy: dbBooking.host_subsidy,\n    notes: dbBooking.notes,\n    createdAt: dbBooking.created_at,\n  };\n}\n"],"names":["create","deleteBooking","get","getActivityBookings","getEventBookings","getVendorBookings","list","listWithDetails","propagateVendorCostChange","update","supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","data","validation","createVendorBookingSchema","safeParse","success","error","code","message","details","issues","sanitized","notes","sanitizeInput","booking","from","insert","vendor_id","vendorId","activity_id","activityId","event_id","eventId","booking_date","bookingDate","guest_count","guestCount","pricing_model","pricingModel","total_cost","totalCost","host_subsidy","hostSubsidy","select","single","mapBookingFromDb","Error","id","eq","updateVendorBookingSchema","undefined","delete","filters","vendorBookingFilterSchema","page","pageSize","query","count","to","range","order","ascending","bookings","total","totalPages","Math","ceil","map","bookingsWithDetails","vendorName","vendors","name","vendorCategory","category","activityName","activities","eventName","events","createdAt","created_at","bookingsResult","dbBooking"],"mappings":"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"}