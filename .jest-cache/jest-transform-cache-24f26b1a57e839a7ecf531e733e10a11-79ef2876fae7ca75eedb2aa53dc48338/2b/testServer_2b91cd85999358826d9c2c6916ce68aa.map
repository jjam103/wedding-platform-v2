{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/helpers/testServer.ts"],"sourcesContent":["/**\n * Test Server Utilities\n * \n * Utilities for starting and managing a real Next.js dev server for integration tests.\n * This allows testing against actual API routes instead of mocked implementations.\n */\n\nimport { spawn, ChildProcess } from 'child_process';\n\nlet serverProcess: ChildProcess | null = null;\nconst SERVER_PORT = 3001; // Use different port than dev server\nconst SERVER_URL = `http://localhost:${SERVER_PORT}`;\n\n/**\n * Wait for server to be ready by polling the health endpoint\n */\nasync function waitForServer(maxAttempts = 30, delayMs = 1000): Promise<void> {\n  for (let i = 0; i < maxAttempts; i++) {\n    try {\n      const response = await fetch(`${SERVER_URL}/api/health`);\n      if (response.ok) {\n        console.log('‚úÖ Test server is ready');\n        return;\n      }\n    } catch (error) {\n      // Server not ready yet, continue waiting\n    }\n    \n    await new Promise(resolve => setTimeout(resolve, delayMs));\n  }\n  \n  throw new Error(`Server did not start after ${maxAttempts} attempts`);\n}\n\n/**\n * Start Next.js dev server for testing\n */\nexport async function startTestServer(): Promise<string> {\n  if (serverProcess) {\n    console.log('‚ö†Ô∏è  Test server already running');\n    return SERVER_URL;\n  }\n  \n  console.log('üöÄ Starting test server...');\n  \n  serverProcess = spawn('npm', ['run', 'dev', '--', '-p', SERVER_PORT.toString()], {\n    stdio: 'pipe',\n    env: {\n      ...process.env,\n      NODE_ENV: 'test',\n      PORT: SERVER_PORT.toString(),\n    },\n  });\n  \n  // Log server output for debugging\n  serverProcess.stdout?.on('data', (data) => {\n    const output = data.toString();\n    if (output.includes('Ready') || output.includes('started')) {\n      console.log('üì° Server output:', output.trim());\n    }\n  });\n  \n  serverProcess.stderr?.on('data', (data) => {\n    console.error('‚ùå Server error:', data.toString());\n  });\n  \n  serverProcess.on('error', (error) => {\n    console.error('‚ùå Failed to start server:', error);\n  });\n  \n  // Wait for server to be ready\n  await waitForServer();\n  \n  return SERVER_URL;\n}\n\n/**\n * Stop the test server\n */\nexport async function stopTestServer(): Promise<void> {\n  if (!serverProcess) {\n    return;\n  }\n  \n  console.log('üõë Stopping test server...');\n  \n  return new Promise((resolve) => {\n    if (!serverProcess) {\n      resolve();\n      return;\n    }\n    \n    serverProcess.on('exit', () => {\n      serverProcess = null;\n      console.log('‚úÖ Test server stopped');\n      resolve();\n    });\n    \n    // Try graceful shutdown first\n    serverProcess.kill('SIGTERM');\n    \n    // Force kill after 5 seconds if still running\n    setTimeout(() => {\n      if (serverProcess) {\n        serverProcess.kill('SIGKILL');\n      }\n    }, 5000);\n  });\n}\n\n/**\n * Make authenticated request to test server\n */\nexport async function authenticatedRequest(\n  path: string,\n  options: RequestInit = {}\n): Promise<Response> {\n  // TODO: Implement authentication\n  // For now, just make the request\n  const url = `${SERVER_URL}${path}`;\n  return fetch(url, options);\n}\n\n/**\n * Get test server URL\n */\nexport function getTestServerUrl(): string {\n  return SERVER_URL;\n}\n\n/**\n * Check if test server is running\n */\nexport function isTestServerRunning(): boolean {\n  return serverProcess !== null;\n}\n"],"names":["authenticatedRequest","getTestServerUrl","isTestServerRunning","startTestServer","stopTestServer","serverProcess","SERVER_PORT","SERVER_URL","waitForServer","maxAttempts","delayMs","i","response","fetch","ok","console","log","error","Promise","resolve","setTimeout","Error","spawn","toString","stdio","env","process","NODE_ENV","PORT","stdout","on","data","output","includes","trim","stderr","kill","path","options","url"],"mappings":"AAAA;;;;;CAKC;;;;;;;;;;;QA4GqBA;eAAAA;;QAaNC;eAAAA;;QAOAC;eAAAA;;QAhGMC;eAAAA;;QA0CAC;eAAAA;;;+BAxEc;AAEpC,IAAIC,gBAAqC;AACzC,MAAMC,cAAc,MAAM,qCAAqC;AAC/D,MAAMC,aAAa,CAAC,iBAAiB,EAAED,aAAa;AAEpD;;CAEC,GACD,eAAeE,cAAcC,cAAc,EAAE,EAAEC,UAAU,IAAI;IAC3D,IAAK,IAAIC,IAAI,GAAGA,IAAIF,aAAaE,IAAK;QACpC,IAAI;YACF,MAAMC,WAAW,MAAMC,MAAM,GAAGN,WAAW,WAAW,CAAC;YACvD,IAAIK,SAASE,EAAE,EAAE;gBACfC,QAAQC,GAAG,CAAC;gBACZ;YACF;QACF,EAAE,OAAOC,OAAO;QACd,yCAAyC;QAC3C;QAEA,MAAM,IAAIC,QAAQC,CAAAA,UAAWC,WAAWD,SAAST;IACnD;IAEA,MAAM,IAAIW,MAAM,CAAC,2BAA2B,EAAEZ,YAAY,SAAS,CAAC;AACtE;AAKO,eAAeN;IACpB,IAAIE,eAAe;QACjBU,QAAQC,GAAG,CAAC;QACZ,OAAOT;IACT;IAEAQ,QAAQC,GAAG,CAAC;IAEZX,gBAAgBiB,IAAAA,oBAAK,EAAC,OAAO;QAAC;QAAO;QAAO;QAAM;QAAMhB,YAAYiB,QAAQ;KAAG,EAAE;QAC/EC,OAAO;QACPC,KAAK;YACH,GAAGC,QAAQD,GAAG;YACdE,UAAU;YACVC,MAAMtB,YAAYiB,QAAQ;QAC5B;IACF;IAEA,kCAAkC;IAClClB,cAAcwB,MAAM,EAAEC,GAAG,QAAQ,CAACC;QAChC,MAAMC,SAASD,KAAKR,QAAQ;QAC5B,IAAIS,OAAOC,QAAQ,CAAC,YAAYD,OAAOC,QAAQ,CAAC,YAAY;YAC1DlB,QAAQC,GAAG,CAAC,qBAAqBgB,OAAOE,IAAI;QAC9C;IACF;IAEA7B,cAAc8B,MAAM,EAAEL,GAAG,QAAQ,CAACC;QAChChB,QAAQE,KAAK,CAAC,mBAAmBc,KAAKR,QAAQ;IAChD;IAEAlB,cAAcyB,EAAE,CAAC,SAAS,CAACb;QACzBF,QAAQE,KAAK,CAAC,6BAA6BA;IAC7C;IAEA,8BAA8B;IAC9B,MAAMT;IAEN,OAAOD;AACT;AAKO,eAAeH;IACpB,IAAI,CAACC,eAAe;QAClB;IACF;IAEAU,QAAQC,GAAG,CAAC;IAEZ,OAAO,IAAIE,QAAQ,CAACC;QAClB,IAAI,CAACd,eAAe;YAClBc;YACA;QACF;QAEAd,cAAcyB,EAAE,CAAC,QAAQ;YACvBzB,gBAAgB;YAChBU,QAAQC,GAAG,CAAC;YACZG;QACF;QAEA,8BAA8B;QAC9Bd,cAAc+B,IAAI,CAAC;QAEnB,8CAA8C;QAC9ChB,WAAW;YACT,IAAIf,eAAe;gBACjBA,cAAc+B,IAAI,CAAC;YACrB;QACF,GAAG;IACL;AACF;AAKO,eAAepC,qBACpBqC,IAAY,EACZC,UAAuB,CAAC,CAAC;IAEzB,iCAAiC;IACjC,iCAAiC;IACjC,MAAMC,MAAM,GAAGhC,aAAa8B,MAAM;IAClC,OAAOxB,MAAM0B,KAAKD;AACpB;AAKO,SAASrC;IACd,OAAOM;AACT;AAKO,SAASL;IACd,OAAOG,kBAAkB;AAC3B"}