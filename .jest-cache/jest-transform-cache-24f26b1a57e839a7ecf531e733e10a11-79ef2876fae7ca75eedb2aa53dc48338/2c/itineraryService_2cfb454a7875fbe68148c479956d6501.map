{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/itineraryService.ts"],"sourcesContent":["import type { Result } from '@/types';\n\n// Lazy load supabase to avoid initialization issues in tests\nlet _supabase: any = null;\nfunction getSupabase() {\n  if (!_supabase) {\n    const { supabase } = require('@/lib/supabase');\n    _supabase = supabase;\n  }\n  return _supabase;\n}\n\ninterface ItineraryEvent {\n  id: string;\n  name: string;\n  type: 'event' | 'activity';\n  date: string;\n  time: string;\n  location?: string;\n  description?: string;\n  rsvp_status?: string;\n}\n\ninterface AccommodationDetails {\n  accommodation_name?: string;\n  room_type?: string;\n  check_in?: string;\n  check_out?: string;\n  address?: string;\n}\n\ninterface TransportationDetails {\n  airport_code?: string;\n  flight_number?: string;\n  arrival_date?: string;\n  departure_date?: string;\n}\n\ninterface Itinerary {\n  guest_id: string;\n  guest_name: string;\n  events: ItineraryEvent[];\n  accommodation?: AccommodationDetails;\n  transportation?: TransportationDetails;\n  generated_at: string;\n}\n\n/**\n * Itinerary Service\n * \n * Handles personalized itinerary generation and caching for guests.\n * \n * Requirements: 13.10, 18.3, 18.4\n */\n\n/**\n * Generates a personalized itinerary for a guest.\n * \n * @param guestId - The guest's ID\n * @returns Result containing the generated itinerary\n * \n * Requirements: 13.10\n */\nexport async function generateItinerary(guestId: string): Promise<Result<Itinerary>> {\n  try {\n    const supabase = getSupabase();\n    \n    // Get guest information\n    const { data: guest, error: guestError } = await supabase\n      .from('guests')\n      .select('*')\n      .eq('id', guestId)\n      .single();\n    \n    if (guestError || !guest) {\n      return {\n        success: false,\n        error: {\n          code: 'GUEST_NOT_FOUND',\n          message: 'Guest not found',\n          details: guestError,\n        },\n      };\n    }\n    \n    // Get events visible to this guest\n    const { data: events, error: eventsError } = await supabase\n      .from('events')\n      .select('id, name, event_type, start_date, end_date, location_id, description')\n      .eq('status', 'published')\n      .or(`visibility.cs.{${guest.guest_type}},visibility.eq.{}`)\n      .order('start_date', { ascending: true });\n    \n    if (eventsError) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: eventsError.message,\n          details: eventsError,\n        },\n      };\n    }\n    \n    // Get activities visible to this guest\n    const { data: activities, error: activitiesError } = await supabase\n      .from('activities')\n      .select('id, name, activity_type, start_time, end_time, location_id, description')\n      .eq('status', 'published')\n      .or(`visibility.cs.{${guest.guest_type}},visibility.eq.{}`)\n      .order('start_time', { ascending: true });\n    \n    if (activitiesError) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: activitiesError.message,\n          details: activitiesError,\n        },\n      };\n    }\n    \n    // Get RSVPs for this guest\n    const { data: rsvps, error: rsvpsError } = await supabase\n      .from('rsvps')\n      .select('event_id, activity_id, status')\n      .eq('guest_id', guestId);\n    \n    if (rsvpsError) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: rsvpsError.message,\n          details: rsvpsError,\n        },\n      };\n    }\n    \n    // Create RSVP lookup map\n    const rsvpMap = new Map<string, string>();\n    rsvps?.forEach((rsvp: any) => {\n      if (rsvp.event_id) {\n        rsvpMap.set(`event-${rsvp.event_id}`, rsvp.status);\n      }\n      if (rsvp.activity_id) {\n        rsvpMap.set(`activity-${rsvp.activity_id}`, rsvp.status);\n      }\n    });\n    \n    // Combine events and activities\n    const itineraryEvents: ItineraryEvent[] = [\n      ...(events || []).map((event: any) => ({\n        id: event.id,\n        name: event.name,\n        type: 'event' as const,\n        date: event.start_date,\n        time: event.start_date,\n        location: event.location_id,\n        description: event.description,\n        rsvp_status: rsvpMap.get(`event-${event.id}`),\n      })),\n      ...(activities || []).map((activity: any) => ({\n        id: activity.id,\n        name: activity.name,\n        type: 'activity' as const,\n        date: activity.start_time,\n        time: activity.start_time,\n        location: activity.location_id,\n        description: activity.description,\n        rsvp_status: rsvpMap.get(`activity-${activity.id}`),\n      })),\n    ].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());\n    \n    // Get accommodation details\n    const { data: roomAssignment } = await supabase\n      .from('room_assignments')\n      .select(`\n        check_in,\n        check_out,\n        room_types (\n          name,\n          accommodations (\n            name,\n            address\n          )\n        )\n      `)\n      .eq('guest_id', guestId)\n      .maybeSingle();\n    \n    const accommodation: AccommodationDetails | undefined = roomAssignment\n      ? {\n          accommodation_name: (roomAssignment.room_types as any)?.accommodations?.name,\n          room_type: (roomAssignment.room_types as any)?.name,\n          check_in: roomAssignment.check_in,\n          check_out: roomAssignment.check_out,\n          address: (roomAssignment.room_types as any)?.accommodations?.address,\n        }\n      : undefined;\n    \n    // Get transportation details\n    const transportation: TransportationDetails = {\n      airport_code: guest.airport_code,\n      flight_number: guest.flight_number,\n      arrival_date: guest.arrival_date,\n      departure_date: guest.departure_date,\n    };\n    \n    const itinerary: Itinerary = {\n      guest_id: guestId,\n      guest_name: `${guest.first_name} ${guest.last_name}`,\n      events: itineraryEvents,\n      accommodation,\n      transportation,\n      generated_at: new Date().toISOString(),\n    };\n    \n    return { success: true, data: itinerary };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Caches an itinerary for offline access.\n * \n * @param guestId - The guest's ID\n * @param itinerary - The itinerary to cache\n * @returns Result indicating success or failure\n * \n * Requirements: 18.3, 18.4\n */\nexport async function cacheItinerary(\n  guestId: string,\n  itinerary: Itinerary\n): Promise<Result<void>> {\n  try {\n    // Store in localStorage for PWA offline access\n    if (typeof window !== 'undefined' && window.localStorage) {\n      const cacheKey = `itinerary-${guestId}`;\n      window.localStorage.setItem(cacheKey, JSON.stringify(itinerary));\n      \n      return { success: true, data: undefined };\n    }\n    \n    return {\n      success: false,\n      error: {\n        code: 'STORAGE_UNAVAILABLE',\n        message: 'Local storage is not available',\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Retrieves a cached itinerary.\n * \n * @param guestId - The guest's ID\n * @returns Result containing the cached itinerary or null if not found\n * \n * Requirements: 18.3, 18.4\n */\nexport async function getCachedItinerary(\n  guestId: string\n): Promise<Result<Itinerary | null>> {\n  try {\n    // Retrieve from localStorage\n    if (typeof window !== 'undefined' && window.localStorage) {\n      const cacheKey = `itinerary-${guestId}`;\n      const cached = window.localStorage.getItem(cacheKey);\n      \n      if (cached) {\n        const itinerary = JSON.parse(cached) as Itinerary;\n        return { success: true, data: itinerary };\n      }\n      \n      return { success: true, data: null };\n    }\n    \n    return {\n      success: false,\n      error: {\n        code: 'STORAGE_UNAVAILABLE',\n        message: 'Local storage is not available',\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Invalidates the cached itinerary for a guest.\n * \n * @param guestId - The guest's ID\n * @returns Result indicating success or failure\n */\nexport async function invalidateCache(guestId: string): Promise<Result<void>> {\n  try {\n    if (typeof window !== 'undefined' && window.localStorage) {\n      const cacheKey = `itinerary-${guestId}`;\n      window.localStorage.removeItem(cacheKey);\n      \n      return { success: true, data: undefined };\n    }\n    \n    return {\n      success: false,\n      error: {\n        code: 'STORAGE_UNAVAILABLE',\n        message: 'Local storage is not available',\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n"],"names":["cacheItinerary","generateItinerary","getCachedItinerary","invalidateCache","_supabase","getSupabase","supabase","require","guestId","data","guest","error","guestError","from","select","eq","single","success","code","message","details","events","eventsError","or","guest_type","order","ascending","activities","activitiesError","rsvps","rsvpsError","rsvpMap","Map","forEach","rsvp","event_id","set","status","activity_id","itineraryEvents","map","event","id","name","type","date","start_date","time","location","location_id","description","rsvp_status","get","activity","start_time","sort","a","b","Date","getTime","roomAssignment","maybeSingle","accommodation","accommodation_name","room_types","accommodations","room_type","check_in","check_out","address","undefined","transportation","airport_code","flight_number","arrival_date","departure_date","itinerary","guest_id","guest_name","first_name","last_name","generated_at","toISOString","Error","window","localStorage","cacheKey","setItem","JSON","stringify","cached","getItem","parse","removeItem"],"mappings":"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"}