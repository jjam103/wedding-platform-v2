{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/b2Service.ts"],"sourcesContent":["import { S3Client, PutObjectCommand, HeadBucketCommand } from '@aws-sdk/client-s3';\nimport { sanitizeInput, sanitizeRichText } from \"../utils/sanitization\";\nimport { getCircuitBreaker } from '../utils/circuitBreaker';\nimport { retryWithBackoff, RetryPresets } from '../utils/retry';\n\ntype Result<T> = \n  | { success: true; data: T } \n  | { success: false; error: { code: string; message: string; details?: any } };\n\ninterface B2Config {\n  endpoint: string;\n  region: string;\n  accessKeyId: string;\n  secretAccessKey: string;\n  bucket: string;\n  cdnDomain: string;\n}\n\ninterface UploadResult {\n  url: string;\n  key: string;\n}\n\ninterface HealthCheckResult {\n  healthy: boolean;\n  lastChecked: Date;\n  error?: string;\n}\n\nlet s3Client: S3Client | null = null;\nlet healthStatus: HealthCheckResult = {\n  healthy: false,\n  lastChecked: new Date(0),\n};\n\n/**\n * Validates B2 environment variables are present and properly configured.\n * \n * @returns Result indicating if configuration is valid\n */\nexport function validateB2Config(): Result<B2Config> {\n  const requiredVars = {\n    endpoint: process.env.B2_ENDPOINT,\n    region: process.env.B2_REGION,\n    accessKeyId: process.env.B2_ACCESS_KEY_ID,\n    secretAccessKey: process.env.B2_SECRET_ACCESS_KEY,\n    bucket: process.env.B2_BUCKET_NAME,\n    cdnDomain: process.env.B2_CDN_DOMAIN || process.env.CLOUDFLARE_CDN_URL,\n  };\n\n  const missing: string[] = [];\n  if (!requiredVars.endpoint) missing.push('B2_ENDPOINT');\n  if (!requiredVars.region) missing.push('B2_REGION');\n  if (!requiredVars.accessKeyId) missing.push('B2_ACCESS_KEY_ID');\n  if (!requiredVars.secretAccessKey) missing.push('B2_SECRET_ACCESS_KEY');\n  if (!requiredVars.bucket) missing.push('B2_BUCKET_NAME');\n  if (!requiredVars.cdnDomain) missing.push('B2_CDN_DOMAIN or CLOUDFLARE_CDN_URL');\n\n  if (missing.length > 0) {\n    return {\n      success: false,\n      error: {\n        code: 'CONFIGURATION_ERROR',\n        message: `Missing required B2 environment variables: ${missing.join(', ')}`,\n        details: { missing },\n      },\n    };\n  }\n\n  return {\n    success: true,\n    data: requiredVars as B2Config,\n  };\n}\n\n/**\n * Initializes the B2 S3-compatible client with configuration.\n * \n * @param config - B2 configuration including endpoint, credentials, and CDN domain\n * @returns Result indicating success or configuration error\n */\nexport function initializeB2Client(config: B2Config): Result<void> {\n  try {\n    if (!config.endpoint || !config.accessKeyId || !config.secretAccessKey || !config.bucket) {\n      const missing: string[] = [];\n      if (!config.endpoint) missing.push('endpoint');\n      if (!config.accessKeyId) missing.push('accessKeyId');\n      if (!config.secretAccessKey) missing.push('secretAccessKey');\n      if (!config.bucket) missing.push('bucket');\n\n      return {\n        success: false,\n        error: {\n          code: 'CONFIGURATION_ERROR',\n          message: `Missing required B2 configuration: ${missing.join(', ')}`,\n          details: { missing },\n        },\n      };\n    }\n\n    s3Client = new S3Client({\n      endpoint: config.endpoint,\n      region: config.region,\n      credentials: {\n        accessKeyId: config.accessKeyId,\n        secretAccessKey: config.secretAccessKey,\n      },\n      forcePathStyle: true, // Required for B2 S3-compatible API\n    });\n\n    console.log('✅ B2 client initialized successfully', {\n      endpoint: config.endpoint,\n      region: config.region,\n      bucket: config.bucket,\n      cdnDomain: config.cdnDomain,\n    });\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    console.error('❌ Failed to initialize B2 client:', error);\n    return {\n      success: false,\n      error: {\n        code: 'INITIALIZATION_ERROR',\n        message: error instanceof Error ? error.message : 'Failed to initialize B2 client',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Uploads a file to Backblaze B2 storage using S3-compatible API.\n * Includes circuit breaker protection and automatic retry with exponential backoff.\n * \n * @param file - File buffer to upload\n * @param fileName - Name for the file (will be sanitized)\n * @param contentType - MIME type of the file\n * @returns Result containing the CDN URL and storage key\n * \n * @example\n * const result = await uploadToB2(fileBuffer, 'photo.jpg', 'image/jpeg');\n * if (result.success) {\n *   console.log('Photo URL:', result.data.url);\n * }\n */\nexport async function uploadToB2(\n  file: Buffer,\n  fileName: string,\n  contentType: string\n): Promise<Result<UploadResult>> {\n  // Get circuit breaker for B2 service\n  const circuitBreaker = getCircuitBreaker('b2-storage', {\n    failureThreshold: 3,\n    successThreshold: 2,\n    timeout: 60000, // 1 minute\n  });\n\n  // Execute with circuit breaker protection\n  return await circuitBreaker.execute(async () => {\n    try {\n      if (!s3Client) {\n        console.error('❌ B2 upload failed: Client not initialized');\n        console.error('   Call initializeB2Client() with valid configuration first');\n        console.error('   Required env vars: B2_ENDPOINT, B2_REGION, B2_ACCESS_KEY_ID, B2_SECRET_ACCESS_KEY, B2_BUCKET_NAME, B2_CDN_DOMAIN');\n        \n        return {\n          success: false,\n          error: {\n            code: 'CLIENT_NOT_INITIALIZED',\n            message: 'B2 client not initialized. Call initializeB2Client first.',\n            details: {\n              hint: 'Check that all required B2 environment variables are set',\n            },\n          },\n        };\n      }\n\n      // Sanitize filename to prevent path traversal\n      const sanitizedFileName = sanitizeInput(fileName).replace(/[^a-zA-Z0-9._-]/g, '_');\n\n      // Generate unique key with timestamp\n      const timestamp = Date.now();\n      const key = `photos/${timestamp}-${sanitizedFileName}`;\n\n      const command = new PutObjectCommand({\n        Bucket: process.env.B2_BUCKET_NAME || '',\n        Key: key,\n        Body: file,\n        ContentType: contentType,\n        CacheControl: 'public, max-age=31536000', // 1 year cache\n      });\n\n      await s3Client.send(command);\n\n      // Generate Cloudflare CDN URL\n      // When using virtual-host style CNAME (bucket.s3.region.backblazeb2.com),\n      // the URL format is just: https://cdn.domain.com/{key}\n      const cdnDomain = process.env.B2_CDN_DOMAIN || '';\n      const url = `https://${cdnDomain}/${key}`;\n\n      return {\n        success: true,\n        data: { url, key },\n      };\n    } catch (error) {\n      return {\n        success: false,\n        error: {\n          code: 'UPLOAD_ERROR',\n          message: error instanceof Error ? error.message : 'Failed to upload to B2',\n          details: error,\n        },\n      };\n    }\n  });\n}\n\n/**\n * Performs a health check on the B2 storage service.\n * Checks if the bucket is accessible and updates the health status.\n * Includes retry logic for transient failures.\n * \n * @returns Result containing the health check status\n * \n * @example\n * const result = await checkB2Health();\n * if (result.success && result.data.healthy) {\n *   console.log('B2 storage is healthy');\n * }\n */\nexport async function checkB2Health(): Promise<Result<HealthCheckResult>> {\n  try {\n    if (!s3Client) {\n      healthStatus = {\n        healthy: false,\n        lastChecked: new Date(),\n        error: 'B2 client not initialized',\n      };\n      return { success: true, data: healthStatus };\n    }\n\n    const command = new HeadBucketCommand({\n      Bucket: process.env.B2_BUCKET_NAME || '',\n    });\n\n    await s3Client.send(command);\n\n    healthStatus = {\n      healthy: true,\n      lastChecked: new Date(),\n    };\n\n    return { success: true, data: healthStatus };\n  } catch (error) {\n    healthStatus = {\n      healthy: false,\n      lastChecked: new Date(),\n      error: error instanceof Error ? error.message : 'Health check failed',\n    };\n\n    return { success: true, data: healthStatus };\n  }\n}\n\n/**\n * Gets the current health status of B2 storage.\n * Returns cached status without performing a new check.\n * \n * @returns Current health status\n */\nexport function getB2HealthStatus(): HealthCheckResult {\n  return healthStatus;\n}\n\n/**\n * Generates a Cloudflare CDN URL for a given B2 storage key.\n * Assumes Cloudflare CNAME points to virtual-host style B2 endpoint.\n * \n * @param key - Storage key (path) of the file\n * @returns CDN URL for the file\n * \n * @example\n * const url = generateCDNUrl('photos/1234567890-photo.jpg');\n * // Returns: https://cdn.example.com/photos/1234567890-photo.jpg\n * \n * @note Requires Cloudflare CNAME to point to:\n *       bucket-name.s3.region.backblazeb2.com (virtual-host style)\n */\nexport function generateCDNUrl(key: string): string {\n  const cdnDomain = process.env.B2_CDN_DOMAIN || '';\n  // Virtual-host style: CNAME points to bucket.s3.region.backblazeb2.com\n  // So URL is just: https://cdn.domain.com/{key}\n  return `https://${cdnDomain}/${key}`;\n}\n\n/**\n * Checks if B2 storage is currently healthy based on the last health check.\n * If the last check was more than 5 minutes ago, performs a new check.\n * \n * @returns Result indicating if B2 is healthy\n */\nexport async function isB2Healthy(): Promise<Result<boolean>> {\n  const now = new Date();\n  const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);\n\n  // If last check was more than 5 minutes ago, perform new check\n  if (healthStatus.lastChecked < fiveMinutesAgo) {\n    const checkResult = await checkB2Health();\n    if (!checkResult.success) {\n      return checkResult;\n    }\n  }\n\n  return { success: true, data: healthStatus.healthy };\n}\n\n/**\n * Resets the B2 client and health status.\n * Used primarily for testing purposes.\n */\nexport function resetB2Client(): void {\n  s3Client = null;\n  healthStatus = {\n    healthy: false,\n    lastChecked: new Date(0),\n  };\n}\n"],"names":["checkB2Health","generateCDNUrl","getB2HealthStatus","initializeB2Client","isB2Healthy","resetB2Client","uploadToB2","validateB2Config","s3Client","healthStatus","healthy","lastChecked","Date","requiredVars","endpoint","process","env","B2_ENDPOINT","region","B2_REGION","accessKeyId","B2_ACCESS_KEY_ID","secretAccessKey","B2_SECRET_ACCESS_KEY","bucket","B2_BUCKET_NAME","cdnDomain","B2_CDN_DOMAIN","CLOUDFLARE_CDN_URL","missing","push","length","success","error","code","message","join","details","data","config","S3Client","credentials","forcePathStyle","console","log","undefined","Error","file","fileName","contentType","circuitBreaker","getCircuitBreaker","failureThreshold","successThreshold","timeout","execute","hint","sanitizedFileName","sanitizeInput","replace","timestamp","now","key","command","PutObjectCommand","Bucket","Key","Body","ContentType","CacheControl","send","url","HeadBucketCommand","fiveMinutesAgo","getTime","checkResult"],"mappings":"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"}