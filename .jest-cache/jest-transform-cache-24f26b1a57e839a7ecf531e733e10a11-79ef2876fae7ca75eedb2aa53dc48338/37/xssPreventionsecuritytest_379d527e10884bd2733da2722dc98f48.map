{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/security/xssPrevention.security.test.ts"],"sourcesContent":["/**\n * Security Test: XSS Prevention\n * \n * Tests that all user inputs are properly sanitized to prevent\n * Cross-Site Scripting (XSS) attacks.\n */\n\nimport { sanitizeInput, sanitizeRichText } from '@/utils/sanitization';\n\ndescribe('Security: XSS Prevention', () => {\n  describe('sanitizeInput', () => {\n    const xssPayloads = [\n      '<script>alert(\"xss\")</script>',\n      '<img src=x onerror=alert(1)>',\n      'javascript:alert(1)',\n      '<svg onload=alert(1)>',\n      '<iframe src=\"javascript:alert(1)\">',\n      '<body onload=alert(1)>',\n      '<input onfocus=alert(1) autofocus>',\n      '<select onfocus=alert(1) autofocus>',\n      '<textarea onfocus=alert(1) autofocus>',\n      '<keygen onfocus=alert(1) autofocus>',\n      '<video><source onerror=\"alert(1)\">',\n      '<audio src=x onerror=alert(1)>',\n      '<details open ontoggle=alert(1)>',\n      '<marquee onstart=alert(1)>',\n      '\"><script>alert(1)</script>',\n      '\\'><script>alert(1)</script>',\n      '<script>alert(String.fromCharCode(88,83,83))</script>',\n      '<img src=\"javascript:alert(1)\">',\n      '<img src=`javascript:alert(1)`>',\n      '<img src=JaVaScRiPt:alert(1)>',\n      '<img \"\"\"><script>alert(1)</script>\">',\n      '<img src=x:alert(alt) onerror=eval(src) alt=xss>',\n      '`\"\\'><img src=xxx:x onerror=alert(1)>',\n      '<svg><script>alert(1)</script></svg>',\n      '<svg><animate onbegin=alert(1) attributeName=x dur=1s>',\n      '<object data=\"javascript:alert(1)\">',\n      '<embed src=\"javascript:alert(1)\">',\n      '<form action=\"javascript:alert(1)\"><input type=\"submit\">',\n      '<link rel=\"stylesheet\" href=\"javascript:alert(1)\">',\n      '<style>@import \"javascript:alert(1)\";</style>',\n      '<meta http-equiv=\"refresh\" content=\"0;url=javascript:alert(1)\">',\n    ];\n\n    xssPayloads.forEach((payload) => {\n      it(`should sanitize: ${payload.substring(0, 50)}...`, () => {\n        const sanitized = sanitizeInput(payload);\n        \n        // Should not contain dangerous tags or attributes\n        expect(sanitized).not.toContain('<script');\n        expect(sanitized).not.toContain('onerror=');\n        expect(sanitized).not.toContain('onload=');\n        expect(sanitized).not.toContain('onfocus=');\n        expect(sanitized).not.toContain('onmouseover=');\n        expect(sanitized).not.toContain('<iframe');\n        expect(sanitized).not.toContain('<object');\n        expect(sanitized).not.toContain('<embed');\n        \n        // Note: Some payloads like \"javascript:alert(1)\" may remain as plain text\n        // but cannot execute as JavaScript when properly handled in HTML context\n        // The key is preventing execution, not necessarily removing all text\n      });\n    });\n\n    it('should preserve safe text content', () => {\n      const safeText = 'Hello, World! This is safe text.';\n      expect(sanitizeInput(safeText)).toBe(safeText);\n    });\n\n    it('should trim whitespace', () => {\n      expect(sanitizeInput('  Hello  ')).toBe('Hello');\n    });\n\n    it('should handle empty strings', () => {\n      expect(sanitizeInput('')).toBe('');\n    });\n\n    it('should handle null and undefined', () => {\n      expect(sanitizeInput(null as any)).toBe('');\n      expect(sanitizeInput(undefined as any)).toBe('');\n    });\n\n    it('should remove all HTML tags', () => {\n      const html = '<p>Hello <strong>World</strong></p>';\n      const sanitized = sanitizeInput(html);\n      expect(sanitized).not.toContain('<p>');\n      expect(sanitized).not.toContain('<strong>');\n      expect(sanitized).toContain('Hello');\n      expect(sanitized).toContain('World');\n    });\n\n    it('should handle nested XSS attempts', () => {\n      const nested = '<<SCRIPT>alert(\"XSS\");//<</SCRIPT>';\n      const sanitized = sanitizeInput(nested);\n      expect(sanitized).not.toContain('<script');\n      expect(sanitized).not.toContain('<SCRIPT');\n      // Note: After tag removal, \"alert\" text may remain but cannot execute\n      // The key is preventing script tag execution, not removing all text\n    });\n\n    it('should handle encoded XSS attempts', () => {\n      const encoded = '&lt;script&gt;alert(\"xss\")&lt;/script&gt;';\n      const sanitized = sanitizeInput(encoded);\n      // Encoded entities are safe - they won't execute as JavaScript\n      // The sanitizer may keep them encoded or decode and re-encode\n      expect(sanitized).not.toContain('<script>');\n      expect(sanitized).not.toContain('</script>');\n    });\n  });\n\n  describe('sanitizeRichText', () => {\n    it('should allow safe HTML tags', () => {\n      const safeHtml = '<p>Hello <strong>World</strong></p>';\n      const sanitized = sanitizeRichText(safeHtml);\n      expect(sanitized).toContain('<p>');\n      expect(sanitized).toContain('<strong>');\n      expect(sanitized).toContain('Hello');\n    });\n\n    it('should remove dangerous tags from rich text', () => {\n      const dangerousHtml = '<p>Hello</p><script>alert(\"xss\")</script>';\n      const sanitized = sanitizeRichText(dangerousHtml);\n      expect(sanitized).toContain('<p>');\n      expect(sanitized).toContain('Hello');\n      expect(sanitized).not.toContain('<script>');\n      expect(sanitized).not.toContain('alert');\n    });\n\n    it('should remove event handlers from allowed tags', () => {\n      const htmlWithEvents = '<p onclick=\"alert(1)\">Click me</p>';\n      const sanitized = sanitizeRichText(htmlWithEvents);\n      expect(sanitized).not.toContain('onclick');\n      expect(sanitized).not.toContain('alert');\n      expect(sanitized).toContain('Click me');\n    });\n\n    it('should allow safe links', () => {\n      const linkHtml = '<a href=\"https://example.com\">Link</a>';\n      const sanitized = sanitizeRichText(linkHtml);\n      expect(sanitized).toContain('<a');\n      expect(sanitized).toContain('href');\n      expect(sanitized).toContain('https://example.com');\n    });\n\n    it('should remove javascript: protocol from links', () => {\n      const jsLink = '<a href=\"javascript:alert(1)\">Click</a>';\n      const sanitized = sanitizeRichText(jsLink);\n      expect(sanitized).not.toContain('javascript:');\n      expect(sanitized).not.toContain('alert');\n    });\n\n    it('should allow lists', () => {\n      const listHtml = '<ul><li>Item 1</li><li>Item 2</li></ul>';\n      const sanitized = sanitizeRichText(listHtml);\n      expect(sanitized).toContain('<ul>');\n      expect(sanitized).toContain('<li>');\n      expect(sanitized).toContain('Item 1');\n    });\n  });\n\n  describe('Context-specific sanitization', () => {\n    it('should sanitize guest names', () => {\n      const maliciousName = '<script>alert(\"xss\")</script>John';\n      const sanitized = sanitizeInput(maliciousName);\n      expect(sanitized).not.toContain('<script>');\n      expect(sanitized).toContain('John');\n    });\n\n    it('should sanitize email subjects', () => {\n      const maliciousSubject = 'Important<script>alert(1)</script>';\n      const sanitized = sanitizeInput(maliciousSubject);\n      expect(sanitized).not.toContain('<script>');\n      expect(sanitized).toContain('Important');\n    });\n\n    it('should sanitize photo captions', () => {\n      const maliciousCaption = 'Beautiful sunset<img src=x onerror=alert(1)>';\n      const sanitized = sanitizeInput(maliciousCaption);\n      expect(sanitized).not.toContain('<img');\n      expect(sanitized).not.toContain('onerror');\n      expect(sanitized).toContain('Beautiful sunset');\n    });\n\n    it('should sanitize dietary restrictions', () => {\n      const maliciousDietary = 'Vegetarian<iframe src=\"javascript:alert(1)\">';\n      const sanitized = sanitizeInput(maliciousDietary);\n      expect(sanitized).not.toContain('<iframe');\n      expect(sanitized).not.toContain('javascript:');\n      expect(sanitized).toContain('Vegetarian');\n    });\n\n    it('should sanitize activity descriptions (rich text)', () => {\n      const description = '<p>Join us for <strong>dinner</strong></p><script>alert(1)</script>';\n      const sanitized = sanitizeRichText(description);\n      expect(sanitized).toContain('<p>');\n      expect(sanitized).toContain('<strong>');\n      expect(sanitized).not.toContain('<script>');\n    });\n  });\n\n  describe('Edge cases', () => {\n    it('should handle very long strings', () => {\n      const longString = 'a'.repeat(10000) + '<script>alert(1)</script>';\n      const sanitized = sanitizeInput(longString);\n      expect(sanitized).not.toContain('<script>');\n      expect(sanitized.length).toBeGreaterThan(0);\n    });\n\n    it('should handle special characters', () => {\n      const specialChars = '!@#$%^&*()_+-=[]{}|;:,.<>?';\n      const sanitized = sanitizeInput(specialChars);\n      // Special characters may be HTML-encoded for safety\n      // The key is they cannot be used for XSS attacks\n      expect(sanitized).toBeDefined();\n      expect(sanitized.length).toBeGreaterThan(0);\n    });\n\n    it('should handle unicode characters', () => {\n      const unicode = 'ä½ å¥½ä¸–ç•Œ ðŸŒ Ù…Ø±Ø­Ø¨Ø§';\n      const sanitized = sanitizeInput(unicode);\n      expect(sanitized).toBe(unicode);\n    });\n\n    it('should handle mixed content', () => {\n      const mixed = 'Normal text <script>alert(1)</script> more text';\n      const sanitized = sanitizeInput(mixed);\n      expect(sanitized).not.toContain('<script>');\n      expect(sanitized).toContain('Normal text');\n      expect(sanitized).toContain('more text');\n    });\n\n    it('should handle malformed HTML', () => {\n      const malformed = '<p>Unclosed paragraph<script>alert(1)';\n      const sanitized = sanitizeInput(malformed);\n      expect(sanitized).not.toContain('<script>');\n      expect(sanitized).not.toContain('alert');\n    });\n  });\n});\n"],"names":["describe","xssPayloads","forEach","payload","it","substring","sanitized","sanitizeInput","expect","not","toContain","safeText","toBe","undefined","html","nested","encoded","safeHtml","sanitizeRichText","dangerousHtml","htmlWithEvents","linkHtml","jsLink","listHtml","maliciousName","maliciousSubject","maliciousCaption","maliciousDietary","description","longString","repeat","length","toBeGreaterThan","specialChars","toBeDefined","unicode","mixed","malformed"],"mappings":"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"}