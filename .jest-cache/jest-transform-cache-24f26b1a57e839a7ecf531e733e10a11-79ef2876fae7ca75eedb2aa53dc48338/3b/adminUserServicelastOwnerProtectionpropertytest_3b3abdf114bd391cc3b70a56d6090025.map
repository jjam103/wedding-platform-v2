{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/adminUserService.lastOwnerProtection.property.test.ts"],"sourcesContent":["/**\n * Property-Based Test: Last Owner Protection\n * \n * Feature: destination-wedding-platform\n * Property 12: Last Owner Protection\n * \n * Validates: Requirements 3.10\n * \n * Property: The system MUST prevent deletion or deactivation of the last active owner account\n * to ensure there is always at least one owner who can manage the system.\n */\n\nimport * as fc from 'fast-check';\nimport { adminUserService } from './adminUserService';\nimport { createClient } from '@/lib/supabaseServer';\n\n// Mock dependencies\njest.mock('@/lib/supabaseServer');\n\nconst mockSupabase = {\n  from: jest.fn().mockReturnThis(),\n  select: jest.fn().mockReturnThis(),\n  update: jest.fn().mockReturnThis(),\n  delete: jest.fn().mockReturnThis(),\n  eq: jest.fn().mockReturnThis(),\n  single: jest.fn(),\n};\n\ndescribe('Feature: destination-wedding-platform, Property 12: Last Owner Protection', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (createClient as jest.Mock).mockReturnValue(mockSupabase);\n  });\n\n  it('should prevent deactivation of last active owner', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.uuid(),\n        async (ownerId) => {\n          // Arrange: Mock last active owner\n          mockSupabase.single\n            .mockResolvedValueOnce({\n              data: {\n                id: ownerId,\n                email: 'owner@example.com',\n                role: 'owner',\n                status: 'active',\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString(),\n              },\n              error: null,\n            })\n            .mockResolvedValueOnce({\n              count: 1, // Only 1 active owner\n              error: null,\n            });\n\n          // Act: Attempt to deactivate last owner\n          const result = await adminUserService.deactivate(ownerId);\n\n          // Assert: Should fail with FORBIDDEN error\n          expect(result.success).toBe(false);\n          expect(result.error?.code).toBe('FORBIDDEN');\n          expect(result.error?.message).toContain('last owner');\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should prevent deletion of last active owner', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.uuid(),\n        async (ownerId) => {\n          // Arrange: Mock last active owner\n          mockSupabase.single.mockResolvedValueOnce({\n            data: {\n              id: ownerId,\n              email: 'owner@example.com',\n              role: 'owner',\n              status: 'active',\n              created_at: new Date().toISOString(),\n              updated_at: new Date().toISOString(),\n            },\n            error: null,\n          });\n\n          mockSupabase.select.mockReturnValueOnce({\n            eq: jest.fn().mockReturnThis(),\n            single: jest.fn().mockResolvedValue({\n              count: 1, // Only 1 active owner\n              error: null,\n            }),\n          });\n\n          // Act: Attempt to delete last owner\n          const result = await adminUserService.delete(ownerId);\n\n          // Assert: Should fail with FORBIDDEN error\n          expect(result.success).toBe(false);\n          expect(result.error?.code).toBe('FORBIDDEN');\n          expect(result.error?.message).toContain('last owner');\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should allow deactivation when multiple active owners exist', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.uuid(),\n        fc.integer({ min: 2, max: 10 }), // Number of active owners\n        async (ownerId, ownerCount) => {\n          // Arrange: Mock owner with multiple active owners\n          mockSupabase.single\n            .mockResolvedValueOnce({\n              data: {\n                id: ownerId,\n                email: 'owner@example.com',\n                role: 'owner',\n                status: 'active',\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString(),\n              },\n              error: null,\n            })\n            .mockResolvedValueOnce({\n              count: ownerCount, // Multiple active owners\n              error: null,\n            })\n            .mockResolvedValueOnce({\n              data: {\n                id: ownerId,\n                email: 'owner@example.com',\n                role: 'owner',\n                status: 'inactive',\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString(),\n              },\n              error: null,\n            });\n\n          // Act: Deactivate owner\n          const result = await adminUserService.deactivate(ownerId);\n\n          // Assert: Should succeed\n          expect(result.success).toBe(true);\n          expect(result.data?.status).toBe('inactive');\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should allow deletion when multiple active owners exist', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.uuid(),\n        fc.integer({ min: 2, max: 10 }), // Number of active owners\n        async (ownerId, ownerCount) => {\n          // Arrange: Mock owner with multiple active owners\n          mockSupabase.single.mockResolvedValueOnce({\n            data: {\n              id: ownerId,\n              email: 'owner@example.com',\n              role: 'owner',\n              status: 'active',\n              created_at: new Date().toISOString(),\n              updated_at: new Date().toISOString(),\n            },\n            error: null,\n          });\n\n          mockSupabase.select.mockReturnValueOnce({\n            eq: jest.fn().mockReturnThis(),\n            single: jest.fn().mockResolvedValue({\n              count: ownerCount, // Multiple active owners\n              error: null,\n            }),\n          });\n\n          mockSupabase.delete.mockReturnValueOnce({\n            eq: jest.fn().mockResolvedValue({\n              error: null,\n            }),\n          });\n\n          // Act: Delete owner\n          const result = await adminUserService.delete(ownerId);\n\n          // Assert: Should succeed\n          expect(result.success).toBe(true);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should allow deactivation of non-owner admin users regardless of count', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.uuid(),\n        fc.integer({ min: 0, max: 10 }), // Number of active owners (doesn't matter)\n        async (adminId, ownerCount) => {\n          // Arrange: Mock non-owner admin user\n          mockSupabase.single\n            .mockResolvedValueOnce({\n              data: {\n                id: adminId,\n                email: 'admin@example.com',\n                role: 'admin', // Not an owner\n                status: 'active',\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString(),\n              },\n              error: null,\n            })\n            .mockResolvedValueOnce({\n              count: ownerCount,\n              error: null,\n            })\n            .mockResolvedValueOnce({\n              data: {\n                id: adminId,\n                email: 'admin@example.com',\n                role: 'admin',\n                status: 'inactive',\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString(),\n              },\n              error: null,\n            });\n\n          // Act: Deactivate admin user\n          const result = await adminUserService.deactivate(adminId);\n\n          // Assert: Should succeed (not an owner, so no protection needed)\n          expect(result.success).toBe(true);\n          expect(result.data?.status).toBe('inactive');\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should count only active owners for protection check', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.uuid(),\n        fc.integer({ min: 1, max: 5 }), // Number of inactive owners\n        async (ownerId, inactiveOwnerCount) => {\n          // Arrange: Mock last active owner (with inactive owners present)\n          mockSupabase.single\n            .mockResolvedValueOnce({\n              data: {\n                id: ownerId,\n                email: 'owner@example.com',\n                role: 'owner',\n                status: 'active',\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString(),\n              },\n              error: null,\n            })\n            .mockResolvedValueOnce({\n              count: 1, // Only 1 ACTIVE owner (inactive owners don't count)\n              error: null,\n            });\n\n          // Act: Attempt to deactivate last active owner\n          const result = await adminUserService.deactivate(ownerId);\n\n          // Assert: Should fail even if inactive owners exist\n          expect(result.success).toBe(false);\n          expect(result.error?.code).toBe('FORBIDDEN');\n          expect(result.error?.message).toContain('last owner');\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should handle edge case of exactly 2 active owners', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.tuple(fc.uuid(), fc.uuid()).filter(([id1, id2]) => id1 !== id2),\n        async ([owner1Id, owner2Id]) => {\n          // Arrange: Mock first owner with exactly 2 active owners\n          mockSupabase.single\n            .mockResolvedValueOnce({\n              data: {\n                id: owner1Id,\n                email: 'owner1@example.com',\n                role: 'owner',\n                status: 'active',\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString(),\n              },\n              error: null,\n            })\n            .mockResolvedValueOnce({\n              count: 2, // Exactly 2 active owners\n              error: null,\n            })\n            .mockResolvedValueOnce({\n              data: {\n                id: owner1Id,\n                email: 'owner1@example.com',\n                role: 'owner',\n                status: 'inactive',\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString(),\n              },\n              error: null,\n            });\n\n          // Act: Deactivate first owner (leaving 1 active)\n          const result1 = await adminUserService.deactivate(owner1Id);\n\n          // Assert: Should succeed (still 1 active owner remaining)\n          expect(result1.success).toBe(true);\n\n          // Now mock second owner as last active owner\n          mockSupabase.single\n            .mockResolvedValueOnce({\n              data: {\n                id: owner2Id,\n                email: 'owner2@example.com',\n                role: 'owner',\n                status: 'active',\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString(),\n              },\n              error: null,\n            })\n            .mockResolvedValueOnce({\n              count: 1, // Now only 1 active owner\n              error: null,\n            });\n\n          // Act: Attempt to deactivate last owner\n          const result2 = await adminUserService.deactivate(owner2Id);\n\n          // Assert: Should fail (last owner)\n          expect(result2.success).toBe(false);\n          expect(result2.error?.code).toBe('FORBIDDEN');\n        }\n      ),\n      { numRuns: 50 } // Fewer runs due to complex setup\n    );\n  });\n});\n"],"names":["jest","mock","mockSupabase","from","fn","mockReturnThis","select","update","delete","eq","single","describe","beforeEach","clearAllMocks","createClient","mockReturnValue","it","fc","assert","asyncProperty","uuid","ownerId","mockResolvedValueOnce","data","id","email","role","status","created_at","Date","toISOString","updated_at","error","count","result","adminUserService","deactivate","expect","success","toBe","code","message","toContain","numRuns","mockReturnValueOnce","mockResolvedValue","integer","min","max","ownerCount","adminId","inactiveOwnerCount","tuple","filter","id1","id2","owner1Id","owner2Id","result1","result2"],"mappings":"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"}