{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/property/capacityConstraintEnforcement.property.test.ts"],"sourcesContent":["/**\n * Property-Based Test: Capacity Constraint Enforcement\n * \n * Feature: guest-portal-and-admin-enhancements\n * Property 5: Capacity Constraint Enforcement\n * \n * Description:\n * For any RSVP update that would cause an activity to exceed its capacity,\n * the update SHALL be rejected with a validation error\n * \n * Validates: Requirements 2.9, 10.7\n * \n * Test Strategy:\n * - Generate activities with various capacities\n * - Generate RSVP scenarios that would exceed capacity\n * - Verify rejection with appropriate error\n * - Verify acceptance when within capacity\n */\n\nimport * as fc from 'fast-check';\nimport { uuidArbitrary } from '../helpers/arbitraries';\n\ndescribe('Feature: guest-portal-and-admin-enhancements, Property 5: Capacity Constraint Enforcement', () => {\n  /**\n   * Arbitrary for activity with capacity\n   */\n  const activityWithCapacityArbitrary = fc.record({\n    id: uuidArbitrary,\n    name: fc.string({ minLength: 1, maxLength: 100 }),\n    capacity: fc.integer({ min: 1, max: 500 }),\n    currentAttendees: fc.integer({ min: 0, max: 500 }),\n  }).filter((activity) => activity.currentAttendees <= activity.capacity);\n\n  /**\n   * Arbitrary for RSVP update\n   */\n  const rsvpUpdateArbitrary = fc.record({\n    guestId: uuidArbitrary,\n    activityId: uuidArbitrary,\n    status: fc.constantFrom<'pending' | 'attending' | 'maybe' | 'declined'>(\n      'pending',\n      'attending',\n      'maybe',\n      'declined'\n    ),\n    guestCount: fc.integer({ min: 1, max: 10 }),\n  });\n\n  /**\n   * Validate RSVP update against capacity\n   */\n  function validateRSVPCapacity(\n    activity: { capacity: number; currentAttendees: number },\n    rsvpUpdate: { status: string; guestCount: number },\n    previousStatus: string = 'pending',\n    previousGuestCount: number = 0\n  ): { success: boolean; error?: { code: string; message: string } } {\n    // Only check capacity for 'attending' status\n    if (rsvpUpdate.status !== 'attending') {\n      return { success: true };\n    }\n\n    // Calculate the change in attendees\n    const previousCount = previousStatus === 'attending' ? previousGuestCount : 0;\n    const newCount = rsvpUpdate.guestCount;\n    const attendeeChange = newCount - previousCount;\n\n    // Check if update would exceed capacity\n    const newTotal = activity.currentAttendees + attendeeChange;\n\n    if (newTotal > activity.capacity) {\n      return {\n        success: false,\n        error: {\n          code: 'CAPACITY_EXCEEDED',\n          message: `Activity capacity exceeded. Capacity: ${activity.capacity}, Current: ${activity.currentAttendees}, Requested: ${newCount}`,\n        },\n      };\n    }\n\n    return { success: true };\n  }\n\n  it('should reject RSVP updates that would exceed activity capacity', () => {\n    fc.assert(\n      fc.property(activityWithCapacityArbitrary, rsvpUpdateArbitrary, (activity, rsvpUpdate) => {\n        // Create scenario where update would exceed capacity\n        const remainingCapacity = activity.capacity - activity.currentAttendees;\n        const excessiveGuestCount = remainingCapacity + fc.sample(fc.integer({ min: 1, max: 10 }), 1)[0];\n\n        const result = validateRSVPCapacity(\n          activity,\n          { ...rsvpUpdate, status: 'attending', guestCount: excessiveGuestCount }\n        );\n\n        // Should be rejected\n        expect(result.success).toBe(false);\n        expect(result.error).toBeDefined();\n        expect(result.error?.code).toBe('CAPACITY_EXCEEDED');\n      }),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should accept RSVP updates that are within activity capacity', () => {\n    fc.assert(\n      fc.property(activityWithCapacityArbitrary, rsvpUpdateArbitrary, (activity, rsvpUpdate) => {\n        // Create scenario where update is within capacity\n        const remainingCapacity = activity.capacity - activity.currentAttendees;\n        if (remainingCapacity <= 0) {\n          return; // Skip if no capacity available\n        }\n\n        const validGuestCount = fc.sample(fc.integer({ min: 1, max: remainingCapacity }), 1)[0];\n\n        const result = validateRSVPCapacity(\n          activity,\n          { ...rsvpUpdate, status: 'attending', guestCount: validGuestCount }\n        );\n\n        // Should be accepted\n        expect(result.success).toBe(true);\n        expect(result.error).toBeUndefined();\n      }),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should allow RSVP updates for non-attending statuses regardless of capacity', () => {\n    fc.assert(\n      fc.property(activityWithCapacityArbitrary, rsvpUpdateArbitrary, (activity, rsvpUpdate) => {\n        // Test with non-attending statuses\n        const nonAttendingStatuses: Array<'pending' | 'maybe' | 'declined'> = ['pending', 'maybe', 'declined'];\n\n        for (const status of nonAttendingStatuses) {\n          const result = validateRSVPCapacity(\n            activity,\n            { ...rsvpUpdate, status, guestCount: 1000 } // Intentionally large number\n          );\n\n          // Should be accepted regardless of capacity\n          expect(result.success).toBe(true);\n          expect(result.error).toBeUndefined();\n        }\n      }),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should correctly calculate capacity when updating existing RSVP', () => {\n    fc.assert(\n      fc.property(\n        activityWithCapacityArbitrary,\n        fc.integer({ min: 1, max: 10 }),\n        fc.integer({ min: 1, max: 10 }),\n        (activity, previousGuestCount, newGuestCount) => {\n          // Ensure previous RSVP is within capacity\n          if (activity.currentAttendees < previousGuestCount) {\n            return; // Skip invalid scenario\n          }\n\n          // Update from attending to attending with different guest count\n          const result = validateRSVPCapacity(\n            activity,\n            { status: 'attending', guestCount: newGuestCount },\n            'attending',\n            previousGuestCount\n          );\n\n          // Calculate expected outcome\n          const attendeeChange = newGuestCount - previousGuestCount;\n          const newTotal = activity.currentAttendees + attendeeChange;\n          const shouldSucceed = newTotal <= activity.capacity;\n\n          expect(result.success).toBe(shouldSucceed);\n          if (!shouldSucceed) {\n            expect(result.error?.code).toBe('CAPACITY_EXCEEDED');\n          }\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should handle edge case: exactly at capacity', () => {\n    fc.assert(\n      fc.property(fc.integer({ min: 1, max: 500 }), (capacity) => {\n        const activity = {\n          capacity,\n          currentAttendees: capacity, // Already at capacity\n        };\n\n        // Try to add one more attendee\n        const result = validateRSVPCapacity(activity, {\n          status: 'attending',\n          guestCount: 1,\n        });\n\n        // Should be rejected\n        expect(result.success).toBe(false);\n        expect(result.error?.code).toBe('CAPACITY_EXCEEDED');\n      }),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should handle edge case: one spot remaining', () => {\n    fc.assert(\n      fc.property(fc.integer({ min: 2, max: 500 }), (capacity) => {\n        const activity = {\n          capacity,\n          currentAttendees: capacity - 1, // One spot remaining\n        };\n\n        // Try to add exactly one attendee\n        const result = validateRSVPCapacity(activity, {\n          status: 'attending',\n          guestCount: 1,\n        });\n\n        // Should be accepted\n        expect(result.success).toBe(true);\n        expect(result.error).toBeUndefined();\n      }),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should handle changing from attending to declined (frees up capacity)', () => {\n    fc.assert(\n      fc.property(\n        activityWithCapacityArbitrary,\n        fc.integer({ min: 1, max: 10 }),\n        (activity, previousGuestCount) => {\n          // Ensure previous RSVP is within current attendees\n          if (activity.currentAttendees < previousGuestCount) {\n            return; // Skip invalid scenario\n          }\n\n          // Change from attending to declined\n          const result = validateRSVPCapacity(\n            activity,\n            { status: 'declined', guestCount: 0 },\n            'attending',\n            previousGuestCount\n          );\n\n          // Should always be accepted (declining frees up capacity)\n          expect(result.success).toBe(true);\n          expect(result.error).toBeUndefined();\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should provide clear error message with capacity details', () => {\n    fc.assert(\n      fc.property(activityWithCapacityArbitrary, (activity) => {\n        const remainingCapacity = activity.capacity - activity.currentAttendees;\n        const excessiveGuestCount = remainingCapacity + 5;\n\n        const result = validateRSVPCapacity(activity, {\n          status: 'attending',\n          guestCount: excessiveGuestCount,\n        });\n\n        if (!result.success && result.error) {\n          // Error message should include capacity information\n          expect(result.error.message).toContain(activity.capacity.toString());\n          expect(result.error.message).toContain(activity.currentAttendees.toString());\n          expect(result.error.message).toContain(excessiveGuestCount.toString());\n        }\n      }),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should handle zero capacity activities', () => {\n    const activity = {\n      capacity: 0,\n      currentAttendees: 0,\n    };\n\n    const result = validateRSVPCapacity(activity, {\n      status: 'attending',\n      guestCount: 1,\n    });\n\n    // Should be rejected\n    expect(result.success).toBe(false);\n    expect(result.error?.code).toBe('CAPACITY_EXCEEDED');\n  });\n\n  it('should be idempotent - multiple validations with same input produce same result', () => {\n    fc.assert(\n      fc.property(activityWithCapacityArbitrary, rsvpUpdateArbitrary, (activity, rsvpUpdate) => {\n        const result1 = validateRSVPCapacity(activity, rsvpUpdate);\n        const result2 = validateRSVPCapacity(activity, rsvpUpdate);\n\n        // Results should be identical\n        expect(result1.success).toBe(result2.success);\n        expect(result1.error?.code).toBe(result2.error?.code);\n      }),\n      { numRuns: 100 }\n    );\n  });\n});\n"],"names":["describe","activityWithCapacityArbitrary","fc","record","id","uuidArbitrary","name","string","minLength","maxLength","capacity","integer","min","max","currentAttendees","filter","activity","rsvpUpdateArbitrary","guestId","activityId","status","constantFrom","guestCount","validateRSVPCapacity","rsvpUpdate","previousStatus","previousGuestCount","success","previousCount","newCount","attendeeChange","newTotal","error","code","message","it","assert","property","remainingCapacity","excessiveGuestCount","sample","result","expect","toBe","toBeDefined","numRuns","validGuestCount","toBeUndefined","nonAttendingStatuses","newGuestCount","shouldSucceed","toContain","toString","result1","result2"],"mappings":"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"}