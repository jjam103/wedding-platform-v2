{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/emailQueueService.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport type { Result } from '@/types';\nimport { ERROR_CODES } from '@/types';\nimport { sendEmail } from './emailService';\nimport { executeCronJob, type CronJobResult } from './cronService';\n\n// Initialize Supabase client for database operations\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\n/**\n * Processes scheduled emails that are due to be sent.\n * This function should be called by a scheduled cron job.\n * \n * @returns Result containing processing statistics\n * \n * Requirements: 22.4, 12.5\n * \n * @example\n * // Run every minute to process scheduled emails\n * await processScheduledEmails();\n */\nexport async function processScheduledEmails(): Promise<Result<CronJobResult>> {\n  return executeCronJob('scheduled_email_processing', async () => {\n    try {\n      // Get all scheduled emails that are due to be sent\n      const { data: scheduledEmails, error: fetchError } = await supabase\n        .from('scheduled_emails')\n        .select('*')\n        .eq('status', 'pending')\n        .lte('scheduled_at', new Date().toISOString())\n        .order('scheduled_at', { ascending: true })\n        .limit(100); // Process in batches\n\n      if (fetchError) {\n        throw new Error(`Failed to fetch scheduled emails: ${fetchError.message}`);\n      }\n\n      if (!scheduledEmails || scheduledEmails.length === 0) {\n        return {\n          itemsProcessed: 0,\n          itemsFailed: 0,\n        };\n      }\n\n      let sent = 0;\n      let failed = 0;\n\n      // Process each scheduled email\n      for (const scheduledEmail of scheduledEmails) {\n        try {\n          // Mark as processing\n          await supabase\n            .from('scheduled_emails')\n            .update({ status: 'processing' })\n            .eq('id', scheduledEmail.id);\n\n          // Send the email\n          const emailResult = await sendEmail({\n            to: scheduledEmail.recipient_email,\n            subject: scheduledEmail.subject,\n            html: scheduledEmail.html,\n            text: scheduledEmail.text,\n            template_id: scheduledEmail.template_id,\n          });\n\n          if (emailResult.success) {\n            // Mark as sent\n            await supabase\n              .from('scheduled_emails')\n              .update({\n                status: 'sent',\n                sent_at: new Date().toISOString(),\n              })\n              .eq('id', scheduledEmail.id);\n\n            sent++;\n          } else {\n            // Mark as failed\n            await supabase\n              .from('scheduled_emails')\n              .update({\n                status: 'failed',\n                error_message: emailResult.error.message,\n              })\n              .eq('id', scheduledEmail.id);\n\n            failed++;\n            console.error(\n              `Failed to send scheduled email ${scheduledEmail.id}:`,\n              emailResult.error\n            );\n          }\n        } catch (error) {\n          // Mark as failed\n          await supabase\n            .from('scheduled_emails')\n            .update({\n              status: 'failed',\n              error_message: error instanceof Error ? error.message : 'Unknown error',\n            })\n            .eq('id', scheduledEmail.id);\n\n          failed++;\n          console.error(`Error processing scheduled email ${scheduledEmail.id}:`, error);\n        }\n      }\n\n      return {\n        itemsProcessed: sent,\n        itemsFailed: failed,\n      };\n    } catch (error) {\n      throw new Error(\n        `Email queue processing failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n      );\n    }\n  });\n}\n\n/**\n * Gets statistics about scheduled emails.\n * \n * @returns Result containing scheduled email statistics\n */\nexport async function getScheduledEmailStats(): Promise<\n  Result<{\n    pending: number;\n    processing: number;\n    sent: number;\n    failed: number;\n    total: number;\n  }>\n> {\n  try {\n    const { data: emails, error } = await supabase\n      .from('scheduled_emails')\n      .select('status');\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: 'Failed to fetch scheduled email statistics',\n          details: error,\n        },\n      };\n    }\n\n    const stats = {\n      pending: emails.filter((e) => e.status === 'pending').length,\n      processing: emails.filter((e) => e.status === 'processing').length,\n      sent: emails.filter((e) => e.status === 'sent').length,\n      failed: emails.filter((e) => e.status === 'failed').length,\n      total: emails.length,\n    };\n\n    return { success: true, data: stats };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Retries failed scheduled emails.\n * \n * @param maxRetries - Maximum number of retry attempts (default: 3)\n * @returns Result containing retry statistics\n */\nexport async function retryFailedScheduledEmails(\n  maxRetries: number = 3\n): Promise<Result<{ retried: number; failed: number }>> {\n  try {\n    // Get failed emails that haven't exceeded max retries\n    const { data: failedEmails, error: fetchError } = await supabase\n      .from('scheduled_emails')\n      .select('*')\n      .eq('status', 'failed')\n      .or(`retry_count.is.null,retry_count.lt.${maxRetries}`)\n      .limit(50); // Process in batches\n\n    if (fetchError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: 'Failed to fetch failed emails',\n          details: fetchError,\n        },\n      };\n    }\n\n    if (!failedEmails || failedEmails.length === 0) {\n      return { success: true, data: { retried: 0, failed: 0 } };\n    }\n\n    let retried = 0;\n    let failed = 0;\n\n    for (const email of failedEmails) {\n      const retryCount = (email.retry_count || 0) + 1;\n\n      // Update retry count and reset to pending\n      await supabase\n        .from('scheduled_emails')\n        .update({\n          status: 'pending',\n          retry_count: retryCount,\n          error_message: null,\n        })\n        .eq('id', email.id);\n\n      retried++;\n    }\n\n    return { success: true, data: { retried, failed } };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Cancels a scheduled email before it's sent.\n * \n * @param emailId - Scheduled email ID\n * @returns Result indicating success or error\n */\nexport async function cancelScheduledEmail(emailId: string): Promise<Result<void>> {\n  try {\n    const { error } = await supabase\n      .from('scheduled_emails')\n      .update({ status: 'cancelled' })\n      .eq('id', emailId)\n      .eq('status', 'pending'); // Only cancel if still pending\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: 'Failed to cancel scheduled email',\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n"],"names":["cancelScheduledEmail","getScheduledEmailStats","processScheduledEmails","retryFailedScheduledEmails","supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","executeCronJob","data","scheduledEmails","error","fetchError","from","select","eq","lte","Date","toISOString","order","ascending","limit","Error","message","length","itemsProcessed","itemsFailed","sent","failed","scheduledEmail","update","status","id","emailResult","sendEmail","to","recipient_email","subject","html","text","template_id","success","sent_at","error_message","console","emails","code","ERROR_CODES","DATABASE_ERROR","details","stats","pending","filter","e","processing","total","UNKNOWN_ERROR","maxRetries","failedEmails","or","retried","email","retryCount","retry_count","emailId","undefined"],"mappings":"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"}