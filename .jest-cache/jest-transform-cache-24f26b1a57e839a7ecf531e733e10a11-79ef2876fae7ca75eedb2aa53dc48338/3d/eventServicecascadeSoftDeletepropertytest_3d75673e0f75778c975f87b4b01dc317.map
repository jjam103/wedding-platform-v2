{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/eventService.cascadeSoftDelete.property.test.ts"],"sourcesContent":["/**\n * Property-Based Test: Event Cascade Soft Deletion\n * Feature: guest-portal-and-admin-enhancements\n * Property 31: Event Cascade Deletion\n * \n * Validates: Requirements 29.1\n * \n * Property: When an event is soft deleted, all associated activities and RSVPs\n * must also be soft deleted with the same timestamp.\n */\n\nimport * as fc from 'fast-check';\nimport { deleteEvent, restoreEvent, create as createEvent } from './eventService';\nimport { create as createActivity } from './activityService';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ndescribe('Feature: guest-portal-and-admin-enhancements, Property 31: Event Cascade Deletion', () => {\n  beforeEach(async () => {\n    // Clean up test data\n    await supabase.from('rsvps').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  afterAll(async () => {\n    // Final cleanup\n    await supabase.from('rsvps').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  it('should soft delete all activities when event is soft deleted', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.record({\n          eventName: fc.string({ minLength: 1, maxLength: 100 }),\n          activityCount: fc.integer({ min: 1, max: 5 }),\n        }),\n        async ({ eventName, activityCount }) => {\n          // Create event\n          const eventResult = await createEvent({\n            name: eventName,\n            date: new Date().toISOString().split('T')[0],\n          });\n\n          if (!eventResult.success) {\n            throw new Error('Failed to create event');\n          }\n\n          const eventId = eventResult.data.id;\n\n          // Create activities\n          const activityIds: string[] = [];\n          for (let i = 0; i < activityCount; i++) {\n            const activityResult = await createActivity({\n              name: `Activity ${i}`,\n              event_id: eventId,\n              date: new Date().toISOString().split('T')[0],\n              activity_type: 'activity',\n            });\n\n            if (activityResult.success) {\n              activityIds.push(activityResult.data.id);\n            }\n          }\n\n          // Soft delete event\n          const deleteResult = await deleteEvent(eventId, { permanent: false });\n          expect(deleteResult.success).toBe(true);\n\n          // Verify event is soft deleted\n          const { data: event } = await supabase\n            .from('events')\n            .select('deleted_at')\n            .eq('id', eventId)\n            .single();\n\n          expect(event?.deleted_at).not.toBeNull();\n\n          // Verify all activities are soft deleted\n          const { data: activities } = await supabase\n            .from('activities')\n            .select('id, deleted_at')\n            .eq('event_id', eventId);\n\n          expect(activities).toHaveLength(activityIds.length);\n          activities?.forEach((activity) => {\n            expect(activity.deleted_at).not.toBeNull();\n          });\n\n          // Cleanup\n          await deleteEvent(eventId, { permanent: true });\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should restore all activities when event is restored', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.record({\n          eventName: fc.string({ minLength: 1, maxLength: 100 }),\n          activityCount: fc.integer({ min: 1, max: 3 }),\n        }),\n        async ({ eventName, activityCount }) => {\n          // Create event\n          const eventResult = await createEvent({\n            name: eventName,\n            date: new Date().toISOString().split('T')[0],\n          });\n\n          if (!eventResult.success) {\n            throw new Error('Failed to create event');\n          }\n\n          const eventId = eventResult.data.id;\n\n          // Create activities\n          const activityIds: string[] = [];\n          for (let i = 0; i < activityCount; i++) {\n            const activityResult = await createActivity({\n              name: `Activity ${i}`,\n              event_id: eventId,\n              date: new Date().toISOString().split('T')[0],\n              activity_type: 'activity',\n            });\n\n            if (activityResult.success) {\n              activityIds.push(activityResult.data.id);\n            }\n          }\n\n          // Soft delete event\n          await deleteEvent(eventId, { permanent: false });\n\n          // Restore event\n          const restoreResult = await restoreEvent(eventId);\n          expect(restoreResult.success).toBe(true);\n\n          // Verify event is restored\n          const { data: event } = await supabase\n            .from('events')\n            .select('deleted_at')\n            .eq('id', eventId)\n            .single();\n\n          expect(event?.deleted_at).toBeNull();\n\n          // Verify all activities are restored\n          const { data: activities } = await supabase\n            .from('activities')\n            .select('id, deleted_at')\n            .eq('event_id', eventId);\n\n          expect(activities).toHaveLength(activityIds.length);\n          activities?.forEach((activity) => {\n            expect(activity.deleted_at).toBeNull();\n          });\n\n          // Cleanup\n          await deleteEvent(eventId, { permanent: true });\n        }\n      ),\n      { numRuns: 50 }\n    );\n  });\n});\n"],"names":["supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","describe","beforeEach","from","delete","neq","afterAll","it","fc","assert","asyncProperty","record","eventName","string","minLength","maxLength","activityCount","integer","min","max","eventResult","createEvent","name","date","Date","toISOString","split","success","Error","eventId","data","id","activityIds","i","activityResult","createActivity","event_id","activity_type","push","deleteResult","deleteEvent","permanent","expect","toBe","event","select","eq","single","deleted_at","not","toBeNull","activities","toHaveLength","length","forEach","activity","numRuns","restoreResult","restoreEvent"],"mappings":"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"}