{"version":3,"names":["cov_10k0sculs5","actualCoverage","s","POST","emailMatchSchema","_zod","z","object","email","string","request","f","body","json","validation","safeParse","success","b","_server","NextResponse","error","code","message","details","issues","status","_sanitization","sanitizeInput","data","toLowerCase","supabase","_supabase","createSupabaseClient","guest","guestError","from","select","eq","single","sessionToken","Array","crypto","getRandomValues","Uint8Array","map","toString","padStart","join","expiresAt","Date","now","session","sessionError","insert","guest_id","id","token","expires_at","toISOString","ip_address","headers","get","user_agent","console","cookieStore","_headers","cookies","set","httpOnly","secure","process","env","NODE_ENV","sameSite","maxAge","path","action","entity_type","entity_id","auth_method","guestId","groupId","group_id","firstName","first_name","lastName","last_name","Error"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/auth/guest/email-match/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { cookies } from 'next/headers';\nimport { createSupabaseClient } from '@/lib/supabase';\nimport { z } from 'zod';\nimport { sanitizeInput } from '@/utils/sanitization';\n\n/**\n * Email Matching Authentication API Route\n * \n * Authenticates guests by matching their login email to their guest record email.\n * Creates a guest session on successful match and sets an HTTP-only session cookie.\n * \n * Requirements: 5.2, 22.4\n * Task: 5.1\n */\n\nconst emailMatchSchema = z.object({\n  email: z.string().email('Invalid email format'),\n});\n\n/**\n * POST /api/auth/guest/email-match\n * \n * Authenticates a guest using email matching.\n * \n * @param request - Request containing email in body\n * @returns Success response with guest ID and group ID, or error response\n */\nexport async function POST(request: Request) {\n  try {\n    // 1. Parse and validate request body\n    const body = await request.json();\n    const validation = emailMatchSchema.safeParse(body);\n    \n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid email format',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n    \n    // 2. Sanitize email input\n    const email = sanitizeInput(validation.data.email.toLowerCase());\n    \n    // 3. Create Supabase client\n    const supabase = createSupabaseClient();\n    \n    // 4. Find guest by email with email_matching auth method\n    const { data: guest, error: guestError } = await supabase\n      .from('guests')\n      .select('id, email, group_id, first_name, last_name, auth_method')\n      .eq('email', email)\n      .eq('auth_method', 'email_matching')\n      .single();\n    \n    if (guestError || !guest) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'NOT_FOUND',\n            message: 'Email not found or not configured for email matching authentication',\n          },\n        },\n        { status: 404 }\n      );\n    }\n    \n    // 5. Generate session token (32 bytes)\n    const sessionToken = Array.from(crypto.getRandomValues(new Uint8Array(32)))\n      .map(b => b.toString(16).padStart(2, '0'))\n      .join('');\n    \n    // 6. Create session record in database\n    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours\n    \n    const { data: session, error: sessionError } = await supabase\n      .from('guest_sessions')\n      .insert({\n        guest_id: guest.id,\n        token: sessionToken,\n        expires_at: expiresAt.toISOString(),\n        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || 'unknown',\n        user_agent: request.headers.get('user-agent') || 'unknown',\n      })\n      .select()\n      .single();\n    \n    if (sessionError || !session) {\n      console.error('Failed to create guest session:', sessionError);\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'SESSION_ERROR',\n            message: 'Failed to create session',\n          },\n        },\n        { status: 500 }\n      );\n    }\n    \n    // 7. Set HTTP-only session cookie\n    const cookieStore = await cookies();\n    cookieStore.set('guest_session', sessionToken, {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === 'production',\n      sameSite: 'lax',\n      maxAge: 60 * 60 * 24, // 24 hours\n      path: '/',\n    });\n    \n    // 8. Log authentication event\n    await supabase.from('audit_logs').insert({\n      action: 'guest_login',\n      entity_type: 'guest',\n      entity_id: guest.id,\n      details: {\n        auth_method: 'email_matching',\n        email: guest.email,\n        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || 'unknown',\n      },\n    });\n    \n    // 9. Return success response\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          guestId: guest.id,\n          groupId: guest.group_id,\n          firstName: guest.first_name,\n          lastName: guest.last_name,\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('Email matching authentication error:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'UNKNOWN_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error occurred',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}