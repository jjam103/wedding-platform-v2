{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/softDeleteFiltering.property.test.ts"],"sourcesContent":["/**\n * Property-Based Test: Soft Delete Filtering\n * Feature: guest-portal-and-admin-enhancements\n * Property 32: Soft Delete Filtering\n * \n * Validates: Requirements 29.8\n * \n * Property: Soft-deleted records must not appear in guest-facing queries.\n * Only active records (deleted_at IS NULL) should be returned.\n */\n\nimport * as fc from 'fast-check';\nimport { createContentPage, deleteContentPage } from './contentPagesService';\nimport { create as createEvent, deleteEvent } from './eventService';\nimport { create as createActivity, deleteActivity } from './activityService';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ndescribe('Feature: guest-portal-and-admin-enhancements, Property 32: Soft Delete Filtering', () => {\n  beforeEach(async () => {\n    // Clean up test data\n    await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  afterAll(async () => {\n    // Final cleanup\n    await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  it('should not return soft-deleted content pages in guest queries', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.record({\n          activeCount: fc.integer({ min: 1, max: 5 }),\n          deletedCount: fc.integer({ min: 1, max: 5 }),\n        }),\n        async ({ activeCount, deletedCount }) => {\n          const activeIds: string[] = [];\n          const deletedIds: string[] = [];\n\n          // Create active content pages\n          for (let i = 0; i < activeCount; i++) {\n            const result = await createContentPage({\n              title: `Active Page ${i}`,\n              status: 'published',\n            });\n\n            if (result.success) {\n              activeIds.push(result.data.id);\n            }\n          }\n\n          // Create and soft delete content pages\n          for (let i = 0; i < deletedCount; i++) {\n            const result = await createContentPage({\n              title: `Deleted Page ${i}`,\n              status: 'published',\n            });\n\n            if (result.success) {\n              deletedIds.push(result.data.id);\n              await deleteContentPage(result.data.id, { permanent: false });\n            }\n          }\n\n          // Query for published content pages (guest query)\n          const { data: pages } = await supabase\n            .from('content_pages')\n            .select('id')\n            .eq('status', 'published')\n            .is('deleted_at', null);\n\n          // Verify only active pages are returned\n          expect(pages).toHaveLength(activeIds.length);\n          const returnedIds = pages?.map((p) => p.id) || [];\n          activeIds.forEach((id) => {\n            expect(returnedIds).toContain(id);\n          });\n          deletedIds.forEach((id) => {\n            expect(returnedIds).not.toContain(id);\n          });\n\n          // Cleanup\n          for (const id of activeIds) {\n            await deleteContentPage(id, { permanent: true });\n          }\n          for (const id of deletedIds) {\n            await deleteContentPage(id, { permanent: true });\n          }\n        }\n      ),\n      { numRuns: 50 }\n    );\n  });\n\n  it('should not return soft-deleted events in guest queries', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.record({\n          activeCount: fc.integer({ min: 1, max: 5 }),\n          deletedCount: fc.integer({ min: 1, max: 5 }),\n        }),\n        async ({ activeCount, deletedCount }) => {\n          const activeIds: string[] = [];\n          const deletedIds: string[] = [];\n\n          // Create active events\n          for (let i = 0; i < activeCount; i++) {\n            const result = await createEvent({\n              name: `Active Event ${i}`,\n              date: new Date().toISOString().split('T')[0],\n            });\n\n            if (result.success) {\n              activeIds.push(result.data.id);\n            }\n          }\n\n          // Create and soft delete events\n          for (let i = 0; i < deletedCount; i++) {\n            const result = await createEvent({\n              name: `Deleted Event ${i}`,\n              date: new Date().toISOString().split('T')[0],\n            });\n\n            if (result.success) {\n              deletedIds.push(result.data.id);\n              await deleteEvent(result.data.id, { permanent: false });\n            }\n          }\n\n          // Query for events (guest query)\n          const { data: events } = await supabase\n            .from('events')\n            .select('id')\n            .is('deleted_at', null);\n\n          // Verify only active events are returned\n          expect(events?.length).toBeGreaterThanOrEqual(activeIds.length);\n          const returnedIds = events?.map((e) => e.id) || [];\n          activeIds.forEach((id) => {\n            expect(returnedIds).toContain(id);\n          });\n          deletedIds.forEach((id) => {\n            expect(returnedIds).not.toContain(id);\n          });\n\n          // Cleanup\n          for (const id of activeIds) {\n            await deleteEvent(id, { permanent: true });\n          }\n          for (const id of deletedIds) {\n            await deleteEvent(id, { permanent: true });\n          }\n        }\n      ),\n      { numRuns: 50 }\n    );\n  });\n\n  it('should not return soft-deleted activities in guest queries', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.record({\n          activeCount: fc.integer({ min: 1, max: 5 }),\n          deletedCount: fc.integer({ min: 1, max: 5 }),\n        }),\n        async ({ activeCount, deletedCount }) => {\n          const activeIds: string[] = [];\n          const deletedIds: string[] = [];\n\n          // Create active activities\n          for (let i = 0; i < activeCount; i++) {\n            const result = await createActivity({\n              name: `Active Activity ${i}`,\n              date: new Date().toISOString().split('T')[0],\n              activity_type: 'activity',\n            });\n\n            if (result.success) {\n              activeIds.push(result.data.id);\n            }\n          }\n\n          // Create and soft delete activities\n          for (let i = 0; i < deletedCount; i++) {\n            const result = await createActivity({\n              name: `Deleted Activity ${i}`,\n              date: new Date().toISOString().split('T')[0],\n              activity_type: 'activity',\n            });\n\n            if (result.success) {\n              deletedIds.push(result.data.id);\n              await deleteActivity(result.data.id, { permanent: false });\n            }\n          }\n\n          // Query for activities (guest query)\n          const { data: activities } = await supabase\n            .from('activities')\n            .select('id')\n            .is('deleted_at', null);\n\n          // Verify only active activities are returned\n          expect(activities?.length).toBeGreaterThanOrEqual(activeIds.length);\n          const returnedIds = activities?.map((a) => a.id) || [];\n          activeIds.forEach((id) => {\n            expect(returnedIds).toContain(id);\n          });\n          deletedIds.forEach((id) => {\n            expect(returnedIds).not.toContain(id);\n          });\n\n          // Cleanup\n          for (const id of activeIds) {\n            await deleteActivity(id, { permanent: true });\n          }\n          for (const id of deletedIds) {\n            await deleteActivity(id, { permanent: true });\n          }\n        }\n      ),\n      { numRuns: 50 }\n    );\n  });\n});\n"],"names":["supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","describe","beforeEach","from","delete","neq","afterAll","it","fc","assert","asyncProperty","record","activeCount","integer","min","max","deletedCount","activeIds","deletedIds","i","result","createContentPage","title","status","success","push","data","id","deleteContentPage","permanent","pages","select","eq","is","expect","toHaveLength","length","returnedIds","map","p","forEach","toContain","not","numRuns","createEvent","name","date","Date","toISOString","split","deleteEvent","events","toBeGreaterThanOrEqual","e","createActivity","activity_type","deleteActivity","activities","a"],"mappings":"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"}