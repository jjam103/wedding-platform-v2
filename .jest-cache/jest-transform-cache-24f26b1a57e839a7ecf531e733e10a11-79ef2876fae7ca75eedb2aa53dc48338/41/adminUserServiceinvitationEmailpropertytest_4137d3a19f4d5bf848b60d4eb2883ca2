8efd2e83b172a99fc7e3ec8223545c8b
/**
 * Property-Based Test: Invitation Email Sending
 * 
 * Feature: destination-wedding-platform
 * Property 9: Invitation Email Sending
 * 
 * Validates: Requirements 3.2
 * 
 * Property: When an admin user is created, an invitation email MUST be sent
 * to the provided email address with account setup instructions.
 */ "use strict";
// Mock dependencies
jest.mock('@/lib/supabaseServer');
jest.mock('./emailService');
Object.defineProperty(exports, "__esModule", {
    value: true
});
const _fastcheck = /*#__PURE__*/ _interop_require_wildcard(require("fast-check"));
const _adminUserService = require("./adminUserService");
const _emailService = /*#__PURE__*/ _interop_require_wildcard(require("./emailService"));
const _supabaseServer = require("../lib/supabaseServer");
function _getRequireWildcardCache(nodeInterop) {
    if (typeof WeakMap !== "function") return null;
    var cacheBabelInterop = new WeakMap();
    var cacheNodeInterop = new WeakMap();
    return (_getRequireWildcardCache = function(nodeInterop) {
        return nodeInterop ? cacheNodeInterop : cacheBabelInterop;
    })(nodeInterop);
}
function _interop_require_wildcard(obj, nodeInterop) {
    if (!nodeInterop && obj && obj.__esModule) {
        return obj;
    }
    if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
        return {
            default: obj
        };
    }
    var cache = _getRequireWildcardCache(nodeInterop);
    if (cache && cache.has(obj)) {
        return cache.get(obj);
    }
    var newObj = {
        __proto__: null
    };
    var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;
    for(var key in obj){
        if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) {
            var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;
            if (desc && (desc.get || desc.set)) {
                Object.defineProperty(newObj, key, desc);
            } else {
                newObj[key] = obj[key];
            }
        }
    }
    newObj.default = obj;
    if (cache) {
        cache.set(obj, newObj);
    }
    return newObj;
}
const mockSupabase = {
    from: jest.fn().mockReturnThis(),
    select: jest.fn().mockReturnThis(),
    insert: jest.fn().mockReturnThis(),
    eq: jest.fn().mockReturnThis(),
    single: jest.fn()
};
describe('Feature: destination-wedding-platform, Property 9: Invitation Email Sending', ()=>{
    beforeEach(()=>{
        jest.clearAllMocks();
        _supabaseServer.createClient.mockReturnValue(mockSupabase);
    });
    it('should send invitation email when admin user is created', async ()=>{
        await _fastcheck.assert(_fastcheck.asyncProperty(_fastcheck.record({
            email: _fastcheck.emailAddress(),
            role: _fastcheck.constantFrom('admin', 'owner')
        }), _fastcheck.uuid(), async (adminData, invitedBy)=>{
            // Arrange: Mock database to return no existing user
            mockSupabase.single.mockResolvedValueOnce({
                data: null,
                error: null
            });
            // Mock successful admin user creation
            const createdAdmin = {
                id: _fastcheck.sample(_fastcheck.uuid(), 1)[0],
                email: adminData.email,
                role: adminData.role,
                status: 'active',
                invited_by: invitedBy,
                invited_at: new Date().toISOString(),
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            mockSupabase.single.mockResolvedValueOnce({
                data: createdAdmin,
                error: null
            });
            // Mock email service
            const mockSendEmail = jest.fn().mockResolvedValue({
                success: true,
                data: {
                    id: 'email-123'
                }
            });
            _emailService.sendEmail = mockSendEmail;
            // Act: Create admin user
            const result = await _adminUserService.adminUserService.create(adminData, invitedBy);
            // Assert: Email should be sent
            expect(result.success).toBe(true);
            // Verify email was sent with correct parameters
            expect(mockSendEmail).toHaveBeenCalledWith(expect.objectContaining({
                to: adminData.email,
                subject: expect.stringContaining('invited'),
                html: expect.stringContaining('set up your account')
            }));
            // Verify email contains role information
            const emailCall = mockSendEmail.mock.calls[0][0];
            expect(emailCall.html).toContain(adminData.role === 'owner' ? 'Owner' : 'Admin');
            // Verify email contains setup link
            expect(emailCall.html).toContain('/auth/admin/setup');
        }), {
            numRuns: 100
        });
    });
    it('should include correct role in invitation email', async ()=>{
        await _fastcheck.assert(_fastcheck.asyncProperty(_fastcheck.emailAddress(), _fastcheck.constantFrom('admin', 'owner'), _fastcheck.uuid(), async (email, role, invitedBy)=>{
            // Arrange
            mockSupabase.single.mockResolvedValueOnce({
                data: null,
                error: null
            }).mockResolvedValueOnce({
                data: {
                    id: _fastcheck.sample(_fastcheck.uuid(), 1)[0],
                    email,
                    role,
                    status: 'active',
                    invited_by: invitedBy,
                    invited_at: new Date().toISOString(),
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                },
                error: null
            });
            const mockSendEmail = jest.fn().mockResolvedValue({
                success: true,
                data: {
                    id: 'email-123'
                }
            });
            _emailService.sendEmail = mockSendEmail;
            // Act
            await _adminUserService.adminUserService.create({
                email,
                role
            }, invitedBy);
            // Assert: Email should contain correct role
            const emailCall = mockSendEmail.mock.calls[0][0];
            const expectedRoleText = role === 'owner' ? 'Owner' : 'Admin';
            expect(emailCall.html).toContain(expectedRoleText);
        }), {
            numRuns: 100
        });
    });
    it('should not fail admin creation if email sending fails', async ()=>{
        await _fastcheck.assert(_fastcheck.asyncProperty(_fastcheck.record({
            email: _fastcheck.emailAddress(),
            role: _fastcheck.constantFrom('admin', 'owner')
        }), _fastcheck.uuid(), async (adminData, invitedBy)=>{
            // Arrange: Mock successful database operations
            mockSupabase.single.mockResolvedValueOnce({
                data: null,
                error: null
            }).mockResolvedValueOnce({
                data: {
                    id: _fastcheck.sample(_fastcheck.uuid(), 1)[0],
                    email: adminData.email,
                    role: adminData.role,
                    status: 'active',
                    invited_by: invitedBy,
                    invited_at: new Date().toISOString(),
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                },
                error: null
            });
            // Mock email service failure
            const mockSendEmail = jest.fn().mockResolvedValue({
                success: false,
                error: {
                    code: 'EMAIL_SERVICE_ERROR',
                    message: 'Failed to send email'
                }
            });
            _emailService.sendEmail = mockSendEmail;
            // Act: Create admin user
            const result = await _adminUserService.adminUserService.create(adminData, invitedBy);
            // Assert: Admin creation should still succeed
            expect(result.success).toBe(true);
            expect(result.data).toBeDefined();
            expect(result.data?.email).toBe(adminData.email);
        }), {
            numRuns: 100
        });
    });
    it('should send invitation email with expiry information', async ()=>{
        await _fastcheck.assert(_fastcheck.asyncProperty(_fastcheck.emailAddress(), _fastcheck.constantFrom('admin', 'owner'), _fastcheck.uuid(), async (email, role, invitedBy)=>{
            // Arrange
            mockSupabase.single.mockResolvedValueOnce({
                data: null,
                error: null
            }).mockResolvedValueOnce({
                data: {
                    id: _fastcheck.sample(_fastcheck.uuid(), 1)[0],
                    email,
                    role,
                    status: 'active',
                    invited_by: invitedBy,
                    invited_at: new Date().toISOString(),
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                },
                error: null
            });
            const mockSendEmail = jest.fn().mockResolvedValue({
                success: true,
                data: {
                    id: 'email-123'
                }
            });
            _emailService.sendEmail = mockSendEmail;
            // Act
            await _adminUserService.adminUserService.create({
                email,
                role
            }, invitedBy);
            // Assert: Email should mention expiry
            const emailCall = mockSendEmail.mock.calls[0][0];
            expect(emailCall.html).toMatch(/expires in \d+ days/i);
        }), {
            numRuns: 100
        });
    });
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9qYXJvbi9EZXNrdG9wL3dlZGRpbmctcGxhdGZvcm0tdjIvc2VydmljZXMvYWRtaW5Vc2VyU2VydmljZS5pbnZpdGF0aW9uRW1haWwucHJvcGVydHkudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFByb3BlcnR5LUJhc2VkIFRlc3Q6IEludml0YXRpb24gRW1haWwgU2VuZGluZ1xuICogXG4gKiBGZWF0dXJlOiBkZXN0aW5hdGlvbi13ZWRkaW5nLXBsYXRmb3JtXG4gKiBQcm9wZXJ0eSA5OiBJbnZpdGF0aW9uIEVtYWlsIFNlbmRpbmdcbiAqIFxuICogVmFsaWRhdGVzOiBSZXF1aXJlbWVudHMgMy4yXG4gKiBcbiAqIFByb3BlcnR5OiBXaGVuIGFuIGFkbWluIHVzZXIgaXMgY3JlYXRlZCwgYW4gaW52aXRhdGlvbiBlbWFpbCBNVVNUIGJlIHNlbnRcbiAqIHRvIHRoZSBwcm92aWRlZCBlbWFpbCBhZGRyZXNzIHdpdGggYWNjb3VudCBzZXR1cCBpbnN0cnVjdGlvbnMuXG4gKi9cblxuaW1wb3J0ICogYXMgZmMgZnJvbSAnZmFzdC1jaGVjayc7XG5pbXBvcnQgeyBhZG1pblVzZXJTZXJ2aWNlIH0gZnJvbSAnLi9hZG1pblVzZXJTZXJ2aWNlJztcbmltcG9ydCAqIGFzIGVtYWlsU2VydmljZSBmcm9tICcuL2VtYWlsU2VydmljZSc7XG5pbXBvcnQgeyBjcmVhdGVDbGllbnQgfSBmcm9tICdAL2xpYi9zdXBhYmFzZVNlcnZlcic7XG5cbi8vIE1vY2sgZGVwZW5kZW5jaWVzXG5qZXN0Lm1vY2soJ0AvbGliL3N1cGFiYXNlU2VydmVyJyk7XG5qZXN0Lm1vY2soJy4vZW1haWxTZXJ2aWNlJyk7XG5cbmNvbnN0IG1vY2tTdXBhYmFzZSA9IHtcbiAgZnJvbTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gIHNlbGVjdDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gIGluc2VydDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gIGVxOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgc2luZ2xlOiBqZXN0LmZuKCksXG59O1xuXG5kZXNjcmliZSgnRmVhdHVyZTogZGVzdGluYXRpb24td2VkZGluZy1wbGF0Zm9ybSwgUHJvcGVydHkgOTogSW52aXRhdGlvbiBFbWFpbCBTZW5kaW5nJywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgICAoY3JlYXRlQ2xpZW50IGFzIGplc3QuTW9jaykubW9ja1JldHVyblZhbHVlKG1vY2tTdXBhYmFzZSk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgc2VuZCBpbnZpdGF0aW9uIGVtYWlsIHdoZW4gYWRtaW4gdXNlciBpcyBjcmVhdGVkJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGZjLmFzc2VydChcbiAgICAgIGZjLmFzeW5jUHJvcGVydHkoXG4gICAgICAgIGZjLnJlY29yZCh7XG4gICAgICAgICAgZW1haWw6IGZjLmVtYWlsQWRkcmVzcygpLFxuICAgICAgICAgIHJvbGU6IGZjLmNvbnN0YW50RnJvbSgnYWRtaW4nIGFzIGNvbnN0LCAnb3duZXInIGFzIGNvbnN0KSxcbiAgICAgICAgfSksXG4gICAgICAgIGZjLnV1aWQoKSxcbiAgICAgICAgYXN5bmMgKGFkbWluRGF0YSwgaW52aXRlZEJ5KSA9PiB7XG4gICAgICAgICAgLy8gQXJyYW5nZTogTW9jayBkYXRhYmFzZSB0byByZXR1cm4gbm8gZXhpc3RpbmcgdXNlclxuICAgICAgICAgIG1vY2tTdXBhYmFzZS5zaW5nbGUubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHtcbiAgICAgICAgICAgIGRhdGE6IG51bGwsXG4gICAgICAgICAgICBlcnJvcjogbnVsbCxcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIC8vIE1vY2sgc3VjY2Vzc2Z1bCBhZG1pbiB1c2VyIGNyZWF0aW9uXG4gICAgICAgICAgY29uc3QgY3JlYXRlZEFkbWluID0ge1xuICAgICAgICAgICAgaWQ6IGZjLnNhbXBsZShmYy51dWlkKCksIDEpWzBdLFxuICAgICAgICAgICAgZW1haWw6IGFkbWluRGF0YS5lbWFpbCxcbiAgICAgICAgICAgIHJvbGU6IGFkbWluRGF0YS5yb2xlLFxuICAgICAgICAgICAgc3RhdHVzOiAnYWN0aXZlJyxcbiAgICAgICAgICAgIGludml0ZWRfYnk6IGludml0ZWRCeSxcbiAgICAgICAgICAgIGludml0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgbW9ja1N1cGFiYXNlLnNpbmdsZS5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuICAgICAgICAgICAgZGF0YTogY3JlYXRlZEFkbWluLFxuICAgICAgICAgICAgZXJyb3I6IG51bGwsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICAvLyBNb2NrIGVtYWlsIHNlcnZpY2VcbiAgICAgICAgICBjb25zdCBtb2NrU2VuZEVtYWlsID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICBkYXRhOiB7IGlkOiAnZW1haWwtMTIzJyB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIChlbWFpbFNlcnZpY2UgYXMgYW55KS5zZW5kRW1haWwgPSBtb2NrU2VuZEVtYWlsO1xuXG4gICAgICAgICAgLy8gQWN0OiBDcmVhdGUgYWRtaW4gdXNlclxuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGFkbWluVXNlclNlcnZpY2UuY3JlYXRlKGFkbWluRGF0YSwgaW52aXRlZEJ5KTtcblxuICAgICAgICAgIC8vIEFzc2VydDogRW1haWwgc2hvdWxkIGJlIHNlbnRcbiAgICAgICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XG4gICAgICAgICAgXG4gICAgICAgICAgLy8gVmVyaWZ5IGVtYWlsIHdhcyBzZW50IHdpdGggY29ycmVjdCBwYXJhbWV0ZXJzXG4gICAgICAgICAgZXhwZWN0KG1vY2tTZW5kRW1haWwpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgICB0bzogYWRtaW5EYXRhLmVtYWlsLFxuICAgICAgICAgICAgICBzdWJqZWN0OiBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnaW52aXRlZCcpLFxuICAgICAgICAgICAgICBodG1sOiBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnc2V0IHVwIHlvdXIgYWNjb3VudCcpLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgLy8gVmVyaWZ5IGVtYWlsIGNvbnRhaW5zIHJvbGUgaW5mb3JtYXRpb25cbiAgICAgICAgICBjb25zdCBlbWFpbENhbGwgPSBtb2NrU2VuZEVtYWlsLm1vY2suY2FsbHNbMF1bMF07XG4gICAgICAgICAgZXhwZWN0KGVtYWlsQ2FsbC5odG1sKS50b0NvbnRhaW4oXG4gICAgICAgICAgICBhZG1pbkRhdGEucm9sZSA9PT0gJ293bmVyJyA/ICdPd25lcicgOiAnQWRtaW4nXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIC8vIFZlcmlmeSBlbWFpbCBjb250YWlucyBzZXR1cCBsaW5rXG4gICAgICAgICAgZXhwZWN0KGVtYWlsQ2FsbC5odG1sKS50b0NvbnRhaW4oJy9hdXRoL2FkbWluL3NldHVwJyk7XG4gICAgICAgIH1cbiAgICAgICksXG4gICAgICB7IG51bVJ1bnM6IDEwMCB9XG4gICAgKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBpbmNsdWRlIGNvcnJlY3Qgcm9sZSBpbiBpbnZpdGF0aW9uIGVtYWlsJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGZjLmFzc2VydChcbiAgICAgIGZjLmFzeW5jUHJvcGVydHkoXG4gICAgICAgIGZjLmVtYWlsQWRkcmVzcygpLFxuICAgICAgICBmYy5jb25zdGFudEZyb20oJ2FkbWluJyBhcyBjb25zdCwgJ293bmVyJyBhcyBjb25zdCksXG4gICAgICAgIGZjLnV1aWQoKSxcbiAgICAgICAgYXN5bmMgKGVtYWlsLCByb2xlLCBpbnZpdGVkQnkpID0+IHtcbiAgICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgICAgbW9ja1N1cGFiYXNlLnNpbmdsZVxuICAgICAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IGRhdGE6IG51bGwsIGVycm9yOiBudWxsIH0pXG4gICAgICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHtcbiAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgIGlkOiBmYy5zYW1wbGUoZmMudXVpZCgpLCAxKVswXSxcbiAgICAgICAgICAgICAgICBlbWFpbCxcbiAgICAgICAgICAgICAgICByb2xlLFxuICAgICAgICAgICAgICAgIHN0YXR1czogJ2FjdGl2ZScsXG4gICAgICAgICAgICAgICAgaW52aXRlZF9ieTogaW52aXRlZEJ5LFxuICAgICAgICAgICAgICAgIGludml0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBlcnJvcjogbnVsbCxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgY29uc3QgbW9ja1NlbmRFbWFpbCA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgZGF0YTogeyBpZDogJ2VtYWlsLTEyMycgfSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICAoZW1haWxTZXJ2aWNlIGFzIGFueSkuc2VuZEVtYWlsID0gbW9ja1NlbmRFbWFpbDtcblxuICAgICAgICAgIC8vIEFjdFxuICAgICAgICAgIGF3YWl0IGFkbWluVXNlclNlcnZpY2UuY3JlYXRlKHsgZW1haWwsIHJvbGUgfSwgaW52aXRlZEJ5KTtcblxuICAgICAgICAgIC8vIEFzc2VydDogRW1haWwgc2hvdWxkIGNvbnRhaW4gY29ycmVjdCByb2xlXG4gICAgICAgICAgY29uc3QgZW1haWxDYWxsID0gbW9ja1NlbmRFbWFpbC5tb2NrLmNhbGxzWzBdWzBdO1xuICAgICAgICAgIGNvbnN0IGV4cGVjdGVkUm9sZVRleHQgPSByb2xlID09PSAnb3duZXInID8gJ093bmVyJyA6ICdBZG1pbic7XG4gICAgICAgICAgZXhwZWN0KGVtYWlsQ2FsbC5odG1sKS50b0NvbnRhaW4oZXhwZWN0ZWRSb2xlVGV4dCk7XG4gICAgICAgIH1cbiAgICAgICksXG4gICAgICB7IG51bVJ1bnM6IDEwMCB9XG4gICAgKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBub3QgZmFpbCBhZG1pbiBjcmVhdGlvbiBpZiBlbWFpbCBzZW5kaW5nIGZhaWxzJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGZjLmFzc2VydChcbiAgICAgIGZjLmFzeW5jUHJvcGVydHkoXG4gICAgICAgIGZjLnJlY29yZCh7XG4gICAgICAgICAgZW1haWw6IGZjLmVtYWlsQWRkcmVzcygpLFxuICAgICAgICAgIHJvbGU6IGZjLmNvbnN0YW50RnJvbSgnYWRtaW4nIGFzIGNvbnN0LCAnb3duZXInIGFzIGNvbnN0KSxcbiAgICAgICAgfSksXG4gICAgICAgIGZjLnV1aWQoKSxcbiAgICAgICAgYXN5bmMgKGFkbWluRGF0YSwgaW52aXRlZEJ5KSA9PiB7XG4gICAgICAgICAgLy8gQXJyYW5nZTogTW9jayBzdWNjZXNzZnVsIGRhdGFiYXNlIG9wZXJhdGlvbnNcbiAgICAgICAgICBtb2NrU3VwYWJhc2Uuc2luZ2xlXG4gICAgICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgZGF0YTogbnVsbCwgZXJyb3I6IG51bGwgfSlcbiAgICAgICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgaWQ6IGZjLnNhbXBsZShmYy51dWlkKCksIDEpWzBdLFxuICAgICAgICAgICAgICAgIGVtYWlsOiBhZG1pbkRhdGEuZW1haWwsXG4gICAgICAgICAgICAgICAgcm9sZTogYWRtaW5EYXRhLnJvbGUsXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnYWN0aXZlJyxcbiAgICAgICAgICAgICAgICBpbnZpdGVkX2J5OiBpbnZpdGVkQnksXG4gICAgICAgICAgICAgICAgaW52aXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIGVycm9yOiBudWxsLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAvLyBNb2NrIGVtYWlsIHNlcnZpY2UgZmFpbHVyZVxuICAgICAgICAgIGNvbnN0IG1vY2tTZW5kRW1haWwgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICBlcnJvcjoge1xuICAgICAgICAgICAgICBjb2RlOiAnRU1BSUxfU0VSVklDRV9FUlJPUicsXG4gICAgICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gc2VuZCBlbWFpbCcsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIChlbWFpbFNlcnZpY2UgYXMgYW55KS5zZW5kRW1haWwgPSBtb2NrU2VuZEVtYWlsO1xuXG4gICAgICAgICAgLy8gQWN0OiBDcmVhdGUgYWRtaW4gdXNlclxuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGFkbWluVXNlclNlcnZpY2UuY3JlYXRlKGFkbWluRGF0YSwgaW52aXRlZEJ5KTtcblxuICAgICAgICAgIC8vIEFzc2VydDogQWRtaW4gY3JlYXRpb24gc2hvdWxkIHN0aWxsIHN1Y2NlZWRcbiAgICAgICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICAgIGV4cGVjdChyZXN1bHQuZGF0YT8uZW1haWwpLnRvQmUoYWRtaW5EYXRhLmVtYWlsKTtcbiAgICAgICAgfVxuICAgICAgKSxcbiAgICAgIHsgbnVtUnVuczogMTAwIH1cbiAgICApO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHNlbmQgaW52aXRhdGlvbiBlbWFpbCB3aXRoIGV4cGlyeSBpbmZvcm1hdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBmYy5hc3NlcnQoXG4gICAgICBmYy5hc3luY1Byb3BlcnR5KFxuICAgICAgICBmYy5lbWFpbEFkZHJlc3MoKSxcbiAgICAgICAgZmMuY29uc3RhbnRGcm9tKCdhZG1pbicgYXMgY29uc3QsICdvd25lcicgYXMgY29uc3QpLFxuICAgICAgICBmYy51dWlkKCksXG4gICAgICAgIGFzeW5jIChlbWFpbCwgcm9sZSwgaW52aXRlZEJ5KSA9PiB7XG4gICAgICAgICAgLy8gQXJyYW5nZVxuICAgICAgICAgIG1vY2tTdXBhYmFzZS5zaW5nbGVcbiAgICAgICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoeyBkYXRhOiBudWxsLCBlcnJvcjogbnVsbCB9KVxuICAgICAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG4gICAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICBpZDogZmMuc2FtcGxlKGZjLnV1aWQoKSwgMSlbMF0sXG4gICAgICAgICAgICAgICAgZW1haWwsXG4gICAgICAgICAgICAgICAgcm9sZSxcbiAgICAgICAgICAgICAgICBzdGF0dXM6ICdhY3RpdmUnLFxuICAgICAgICAgICAgICAgIGludml0ZWRfYnk6IGludml0ZWRCeSxcbiAgICAgICAgICAgICAgICBpbnZpdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgZXJyb3I6IG51bGwsXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgIGNvbnN0IG1vY2tTZW5kRW1haWwgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIGRhdGE6IHsgaWQ6ICdlbWFpbC0xMjMnIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgKGVtYWlsU2VydmljZSBhcyBhbnkpLnNlbmRFbWFpbCA9IG1vY2tTZW5kRW1haWw7XG5cbiAgICAgICAgICAvLyBBY3RcbiAgICAgICAgICBhd2FpdCBhZG1pblVzZXJTZXJ2aWNlLmNyZWF0ZSh7IGVtYWlsLCByb2xlIH0sIGludml0ZWRCeSk7XG5cbiAgICAgICAgICAvLyBBc3NlcnQ6IEVtYWlsIHNob3VsZCBtZW50aW9uIGV4cGlyeVxuICAgICAgICAgIGNvbnN0IGVtYWlsQ2FsbCA9IG1vY2tTZW5kRW1haWwubW9jay5jYWxsc1swXVswXTtcbiAgICAgICAgICBleHBlY3QoZW1haWxDYWxsLmh0bWwpLnRvTWF0Y2goL2V4cGlyZXMgaW4gXFxkKyBkYXlzL2kpO1xuICAgICAgICB9XG4gICAgICApLFxuICAgICAgeyBudW1SdW5zOiAxMDAgfVxuICAgICk7XG4gIH0pO1xufSk7XG4iXSwibmFtZXMiOlsiamVzdCIsIm1vY2siLCJtb2NrU3VwYWJhc2UiLCJmcm9tIiwiZm4iLCJtb2NrUmV0dXJuVGhpcyIsInNlbGVjdCIsImluc2VydCIsImVxIiwic2luZ2xlIiwiZGVzY3JpYmUiLCJiZWZvcmVFYWNoIiwiY2xlYXJBbGxNb2NrcyIsImNyZWF0ZUNsaWVudCIsIm1vY2tSZXR1cm5WYWx1ZSIsIml0IiwiZmMiLCJhc3NlcnQiLCJhc3luY1Byb3BlcnR5IiwicmVjb3JkIiwiZW1haWwiLCJlbWFpbEFkZHJlc3MiLCJyb2xlIiwiY29uc3RhbnRGcm9tIiwidXVpZCIsImFkbWluRGF0YSIsImludml0ZWRCeSIsIm1vY2tSZXNvbHZlZFZhbHVlT25jZSIsImRhdGEiLCJlcnJvciIsImNyZWF0ZWRBZG1pbiIsImlkIiwic2FtcGxlIiwic3RhdHVzIiwiaW52aXRlZF9ieSIsImludml0ZWRfYXQiLCJEYXRlIiwidG9JU09TdHJpbmciLCJjcmVhdGVkX2F0IiwidXBkYXRlZF9hdCIsIm1vY2tTZW5kRW1haWwiLCJtb2NrUmVzb2x2ZWRWYWx1ZSIsInN1Y2Nlc3MiLCJlbWFpbFNlcnZpY2UiLCJzZW5kRW1haWwiLCJyZXN1bHQiLCJhZG1pblVzZXJTZXJ2aWNlIiwiY3JlYXRlIiwiZXhwZWN0IiwidG9CZSIsInRvSGF2ZUJlZW5DYWxsZWRXaXRoIiwib2JqZWN0Q29udGFpbmluZyIsInRvIiwic3ViamVjdCIsInN0cmluZ0NvbnRhaW5pbmciLCJodG1sIiwiZW1haWxDYWxsIiwiY2FsbHMiLCJ0b0NvbnRhaW4iLCJudW1SdW5zIiwiZXhwZWN0ZWRSb2xlVGV4dCIsImNvZGUiLCJtZXNzYWdlIiwidG9CZURlZmluZWQiLCJ0b01hdGNoIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7OztDQVVDO0FBT0Qsb0JBQW9CO0FBQ3BCQSxLQUFLQyxJQUFJLENBQUM7QUFDVkQsS0FBS0MsSUFBSSxDQUFDOzs7O21FQVBVO2tDQUNhO3NFQUNIO2dDQUNEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFNN0IsTUFBTUMsZUFB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