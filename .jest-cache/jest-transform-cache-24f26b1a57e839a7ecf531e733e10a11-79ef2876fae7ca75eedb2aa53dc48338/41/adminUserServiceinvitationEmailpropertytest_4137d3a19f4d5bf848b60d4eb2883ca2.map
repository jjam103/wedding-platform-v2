{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/adminUserService.invitationEmail.property.test.ts"],"sourcesContent":["/**\n * Property-Based Test: Invitation Email Sending\n * \n * Feature: destination-wedding-platform\n * Property 9: Invitation Email Sending\n * \n * Validates: Requirements 3.2\n * \n * Property: When an admin user is created, an invitation email MUST be sent\n * to the provided email address with account setup instructions.\n */\n\nimport * as fc from 'fast-check';\nimport { adminUserService } from './adminUserService';\nimport * as emailService from './emailService';\nimport { createClient } from '@/lib/supabaseServer';\n\n// Mock dependencies\njest.mock('@/lib/supabaseServer');\njest.mock('./emailService');\n\nconst mockSupabase = {\n  from: jest.fn().mockReturnThis(),\n  select: jest.fn().mockReturnThis(),\n  insert: jest.fn().mockReturnThis(),\n  eq: jest.fn().mockReturnThis(),\n  single: jest.fn(),\n};\n\ndescribe('Feature: destination-wedding-platform, Property 9: Invitation Email Sending', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (createClient as jest.Mock).mockReturnValue(mockSupabase);\n  });\n\n  it('should send invitation email when admin user is created', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.record({\n          email: fc.emailAddress(),\n          role: fc.constantFrom('admin' as const, 'owner' as const),\n        }),\n        fc.uuid(),\n        async (adminData, invitedBy) => {\n          // Arrange: Mock database to return no existing user\n          mockSupabase.single.mockResolvedValueOnce({\n            data: null,\n            error: null,\n          });\n\n          // Mock successful admin user creation\n          const createdAdmin = {\n            id: fc.sample(fc.uuid(), 1)[0],\n            email: adminData.email,\n            role: adminData.role,\n            status: 'active',\n            invited_by: invitedBy,\n            invited_at: new Date().toISOString(),\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString(),\n          };\n\n          mockSupabase.single.mockResolvedValueOnce({\n            data: createdAdmin,\n            error: null,\n          });\n\n          // Mock email service\n          const mockSendEmail = jest.fn().mockResolvedValue({\n            success: true,\n            data: { id: 'email-123' },\n          });\n          (emailService as any).sendEmail = mockSendEmail;\n\n          // Act: Create admin user\n          const result = await adminUserService.create(adminData, invitedBy);\n\n          // Assert: Email should be sent\n          expect(result.success).toBe(true);\n          \n          // Verify email was sent with correct parameters\n          expect(mockSendEmail).toHaveBeenCalledWith(\n            expect.objectContaining({\n              to: adminData.email,\n              subject: expect.stringContaining('invited'),\n              html: expect.stringContaining('set up your account'),\n            })\n          );\n\n          // Verify email contains role information\n          const emailCall = mockSendEmail.mock.calls[0][0];\n          expect(emailCall.html).toContain(\n            adminData.role === 'owner' ? 'Owner' : 'Admin'\n          );\n\n          // Verify email contains setup link\n          expect(emailCall.html).toContain('/auth/admin/setup');\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should include correct role in invitation email', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.emailAddress(),\n        fc.constantFrom('admin' as const, 'owner' as const),\n        fc.uuid(),\n        async (email, role, invitedBy) => {\n          // Arrange\n          mockSupabase.single\n            .mockResolvedValueOnce({ data: null, error: null })\n            .mockResolvedValueOnce({\n              data: {\n                id: fc.sample(fc.uuid(), 1)[0],\n                email,\n                role,\n                status: 'active',\n                invited_by: invitedBy,\n                invited_at: new Date().toISOString(),\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString(),\n              },\n              error: null,\n            });\n\n          const mockSendEmail = jest.fn().mockResolvedValue({\n            success: true,\n            data: { id: 'email-123' },\n          });\n          (emailService as any).sendEmail = mockSendEmail;\n\n          // Act\n          await adminUserService.create({ email, role }, invitedBy);\n\n          // Assert: Email should contain correct role\n          const emailCall = mockSendEmail.mock.calls[0][0];\n          const expectedRoleText = role === 'owner' ? 'Owner' : 'Admin';\n          expect(emailCall.html).toContain(expectedRoleText);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should not fail admin creation if email sending fails', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.record({\n          email: fc.emailAddress(),\n          role: fc.constantFrom('admin' as const, 'owner' as const),\n        }),\n        fc.uuid(),\n        async (adminData, invitedBy) => {\n          // Arrange: Mock successful database operations\n          mockSupabase.single\n            .mockResolvedValueOnce({ data: null, error: null })\n            .mockResolvedValueOnce({\n              data: {\n                id: fc.sample(fc.uuid(), 1)[0],\n                email: adminData.email,\n                role: adminData.role,\n                status: 'active',\n                invited_by: invitedBy,\n                invited_at: new Date().toISOString(),\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString(),\n              },\n              error: null,\n            });\n\n          // Mock email service failure\n          const mockSendEmail = jest.fn().mockResolvedValue({\n            success: false,\n            error: {\n              code: 'EMAIL_SERVICE_ERROR',\n              message: 'Failed to send email',\n            },\n          });\n          (emailService as any).sendEmail = mockSendEmail;\n\n          // Act: Create admin user\n          const result = await adminUserService.create(adminData, invitedBy);\n\n          // Assert: Admin creation should still succeed\n          expect(result.success).toBe(true);\n          expect(result.data).toBeDefined();\n          expect(result.data?.email).toBe(adminData.email);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should send invitation email with expiry information', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.emailAddress(),\n        fc.constantFrom('admin' as const, 'owner' as const),\n        fc.uuid(),\n        async (email, role, invitedBy) => {\n          // Arrange\n          mockSupabase.single\n            .mockResolvedValueOnce({ data: null, error: null })\n            .mockResolvedValueOnce({\n              data: {\n                id: fc.sample(fc.uuid(), 1)[0],\n                email,\n                role,\n                status: 'active',\n                invited_by: invitedBy,\n                invited_at: new Date().toISOString(),\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString(),\n              },\n              error: null,\n            });\n\n          const mockSendEmail = jest.fn().mockResolvedValue({\n            success: true,\n            data: { id: 'email-123' },\n          });\n          (emailService as any).sendEmail = mockSendEmail;\n\n          // Act\n          await adminUserService.create({ email, role }, invitedBy);\n\n          // Assert: Email should mention expiry\n          const emailCall = mockSendEmail.mock.calls[0][0];\n          expect(emailCall.html).toMatch(/expires in \\d+ days/i);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n});\n"],"names":["jest","mock","mockSupabase","from","fn","mockReturnThis","select","insert","eq","single","describe","beforeEach","clearAllMocks","createClient","mockReturnValue","it","fc","assert","asyncProperty","record","email","emailAddress","role","constantFrom","uuid","adminData","invitedBy","mockResolvedValueOnce","data","error","createdAdmin","id","sample","status","invited_by","invited_at","Date","toISOString","created_at","updated_at","mockSendEmail","mockResolvedValue","success","emailService","sendEmail","result","adminUserService","create","expect","toBe","toHaveBeenCalledWith","objectContaining","to","subject","stringContaining","html","emailCall","calls","toContain","numRuns","expectedRoleText","code","message","toBeDefined","toMatch"],"mappings":"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"}