{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/regression/sectionsColumnsRls.regression.test.ts"],"sourcesContent":["/**\n * Sections & Columns RLS Regression Test\n * \n * This test validates Row-Level Security (RLS) policies for the sections and columns tables.\n * Tests ensure that:\n * - Admins can create, read, update, and delete sections with real auth\n * - Admins can create, read, update, and delete columns with real auth\n * - Guests can only read sections and columns\n * - Guests cannot create, update, or delete sections or columns\n * - Sections are properly filtered by page_type and page_id\n * - RLS doesn't cause \"permission denied for table users\" errors\n * - Deleting a section cascades to its columns\n * - Service role can bypass RLS for admin operations\n * \n * Validates: Requirements 1.2, 1.3, 1.4 (Security Testing)\n */\n\nimport { createAndSignInTestUser, deleteTestUser, createServiceClient, createTestClient, type TestUser } from '../helpers/testDb';\nimport { cleanupByIds } from '../helpers/cleanup';\n\ndescribe('Sections & Columns RLS Regression Tests', () => {\n  let adminUser: TestUser | null = null;\n  let guestUser: TestUser | null = null;\n  let authSetupFailed = false;\n  const createdIds: Map<string, string[]> = new Map();\n  \n  // Helper to track created entities for cleanup\n  const trackEntity = (table: string, id: string) => {\n    const ids = createdIds.get(table) || [];\n    ids.push(id);\n    createdIds.set(table, ids);\n  };\n  \n  beforeAll(async () => {\n    try {\n      // Create admin user (with host role)\n      adminUser = await createAndSignInTestUser({\n        email: `admin-${Date.now()}@test.com`,\n        password: 'test123',\n        role: 'host'\n      });\n      \n      // Create guest user (regular user)\n      guestUser = await createAndSignInTestUser({\n        email: `guest-${Date.now()}@test.com`,\n        password: 'test123',\n        role: 'guest'\n      });\n      \n      console.log('✅ Test users created for sections & columns RLS tests');\n    } catch (error) {\n      console.warn('⚠️  Failed to create test users:', error instanceof Error ? error.message : error);\n      authSetupFailed = true;\n    }\n  }, 30000);\n  \n  afterAll(async () => {\n    // Clean up created entities\n    for (const [table, ids] of createdIds.entries()) {\n      if (ids.length > 0) {\n        await cleanupByIds(table, ids);\n      }\n    }\n    \n    // Clean up test users\n    if (adminUser?.id) {\n      try {\n        await deleteTestUser(adminUser.id);\n        console.log('✅ Admin user cleaned up');\n      } catch (error) {\n        console.warn('⚠️  Failed to clean up admin user:', error);\n      }\n    }\n    \n    if (guestUser?.id) {\n      try {\n        await deleteTestUser(guestUser.id);\n        console.log('✅ Guest user cleaned up');\n      } catch (error) {\n        console.warn('⚠️  Failed to clean up guest user:', error);\n      }\n    }\n  }, 10000);\n  \n  describe('Admin Section Operations with Real Auth', () => {\n    it('should allow admin to create section with real auth (not service role)', async () => {\n      if (authSetupFailed || !adminUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const client = createTestClient(adminUser.accessToken);\n      \n      const sectionData = {\n        page_type: 'event',\n        page_id: '123e4567-e89b-12d3-a456-426614174000',\n        title: 'Test Section',\n        display_order: 0,\n      };\n      \n      const { data, error } = await client\n        .from('sections')\n        .insert(sectionData)\n        .select()\n        .single();\n      \n      // Should not get RLS error\n      expect(error).toBeNull();\n      expect(data).toBeDefined();\n      \n      if (data) {\n        expect(data.page_type).toBe('event');\n        expect(data.page_id).toBe(sectionData.page_id);\n        expect(data.title).toBe('Test Section');\n        trackEntity('sections', data.id);\n      }\n    });\n\n    \n    it('should allow admin to create columns for section', async () => {\n      if (authSetupFailed || !adminUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const serviceClient = createServiceClient();\n      const client = createTestClient(adminUser.accessToken);\n      \n      // Create section using service role\n      const { data: section } = await serviceClient\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174001',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      if (!section) {\n        console.log('⏭️  Skipping: Could not create test section');\n        return;\n      }\n      \n      trackEntity('sections', section.id);\n      \n      // Admin should be able to create columns\n      const columnData = {\n        section_id: section.id,\n        column_number: 1,\n        content_type: 'rich_text',\n        content_data: { html: '<p>Test content</p>' },\n      };\n      \n      const { data: column, error } = await client\n        .from('columns')\n        .insert(columnData)\n        .select()\n        .single();\n      \n      expect(error).toBeNull();\n      expect(column).toBeDefined();\n      \n      if (column) {\n        expect(column.section_id).toBe(section.id);\n        expect(column.column_number).toBe(1);\n        expect(column.content_type).toBe('rich_text');\n        trackEntity('columns', column.id);\n      }\n    });\n\n    \n    it('should allow admin to update section title', async () => {\n      if (authSetupFailed || !adminUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const serviceClient = createServiceClient();\n      const client = createTestClient(adminUser.accessToken);\n      \n      // Create section using service role\n      const { data: section } = await serviceClient\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174002',\n          title: 'Original Title',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      if (!section) {\n        console.log('⏭️  Skipping: Could not create test section');\n        return;\n      }\n      \n      trackEntity('sections', section.id);\n      \n      // Admin should be able to update section\n      const { data: updatedSection, error } = await client\n        .from('sections')\n        .update({ title: 'Updated Title' })\n        .eq('id', section.id)\n        .select()\n        .single();\n      \n      expect(error).toBeNull();\n      expect(updatedSection).toBeDefined();\n      \n      if (updatedSection) {\n        expect(updatedSection.title).toBe('Updated Title');\n      }\n    });\n    \n    it('should allow admin to update column content', async () => {\n      if (authSetupFailed || !adminUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const serviceClient = createServiceClient();\n      const client = createTestClient(adminUser.accessToken);\n      \n      // Create section and column using service role\n      const { data: section } = await serviceClient\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174003',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      if (!section) {\n        console.log('⏭️  Skipping: Could not create test section');\n        return;\n      }\n      \n      trackEntity('sections', section.id);\n      \n      const { data: column } = await serviceClient\n        .from('columns')\n        .insert({\n          section_id: section.id,\n          column_number: 1,\n          content_type: 'rich_text',\n          content_data: { html: '<p>Original content</p>' },\n        })\n        .select()\n        .single();\n      \n      if (!column) {\n        console.log('⏭️  Skipping: Could not create test column');\n        return;\n      }\n      \n      trackEntity('columns', column.id);\n      \n      // Admin should be able to update column\n      const { data: updatedColumn, error } = await client\n        .from('columns')\n        .update({ content_data: { html: '<p>Updated content</p>' } })\n        .eq('id', column.id)\n        .select()\n        .single();\n      \n      expect(error).toBeNull();\n      expect(updatedColumn).toBeDefined();\n      \n      if (updatedColumn) {\n        expect(updatedColumn.content_data).toEqual({ html: '<p>Updated content</p>' });\n      }\n    });\n\n    \n    it('should allow admin to delete section (cascades to columns)', async () => {\n      if (authSetupFailed || !adminUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const serviceClient = createServiceClient();\n      const client = createTestClient(adminUser.accessToken);\n      \n      // Create section and column using service role\n      const { data: section } = await serviceClient\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174004',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      if (!section) {\n        console.log('⏭️  Skipping: Could not create test section');\n        return;\n      }\n      \n      const { data: column } = await serviceClient\n        .from('columns')\n        .insert({\n          section_id: section.id,\n          column_number: 1,\n          content_type: 'rich_text',\n          content_data: { html: '<p>Test content</p>' },\n        })\n        .select()\n        .single();\n      \n      if (!column) {\n        console.log('⏭️  Skipping: Could not create test column');\n        return;\n      }\n      \n      // Admin should be able to delete section\n      const { error } = await client\n        .from('sections')\n        .delete()\n        .eq('id', section.id);\n      \n      expect(error).toBeNull();\n      \n      // Verify section is deleted\n      const { data: deletedSection } = await serviceClient\n        .from('sections')\n        .select('*')\n        .eq('id', section.id)\n        .single();\n      \n      expect(deletedSection).toBeNull();\n      \n      // Verify column is also deleted (cascade)\n      const { data: deletedColumn } = await serviceClient\n        .from('columns')\n        .select('*')\n        .eq('id', column.id)\n        .single();\n      \n      expect(deletedColumn).toBeNull();\n    });\n  });\n\n  \n  describe('Guest Section and Column Access Restrictions', () => {\n    it('should allow guest to read sections and columns', async () => {\n      if (authSetupFailed || !guestUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const serviceClient = createServiceClient();\n      const client = createTestClient(guestUser.accessToken);\n      \n      // Create section and column using service role\n      const { data: section } = await serviceClient\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174005',\n          title: 'Guest Readable Section',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      if (section) {\n        trackEntity('sections', section.id);\n      }\n      \n      const { data: column } = await serviceClient\n        .from('columns')\n        .insert({\n          section_id: section!.id,\n          column_number: 1,\n          content_type: 'rich_text',\n          content_data: { html: '<p>Guest readable content</p>' },\n        })\n        .select()\n        .single();\n      \n      if (column) {\n        trackEntity('columns', column.id);\n      }\n      \n      // Guest should be able to read sections\n      const { data: sections, error: sectionsError } = await client\n        .from('sections')\n        .select('*')\n        .eq('page_type', 'event');\n      \n      expect(sectionsError).toBeNull();\n      expect(sections).toBeDefined();\n      expect(Array.isArray(sections)).toBe(true);\n      \n      // Guest should be able to read columns\n      const { data: columns, error: columnsError } = await client\n        .from('columns')\n        .select('*')\n        .eq('section_id', section!.id);\n      \n      expect(columnsError).toBeNull();\n      expect(columns).toBeDefined();\n      expect(Array.isArray(columns)).toBe(true);\n    });\n\n    \n    it('should prevent guest from creating sections', async () => {\n      if (authSetupFailed || !guestUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const client = createTestClient(guestUser.accessToken);\n      \n      const sectionData = {\n        page_type: 'event',\n        page_id: '123e4567-e89b-12d3-a456-426614174006',\n        title: 'Guest Created Section',\n        display_order: 0,\n      };\n      \n      const { data, error } = await client\n        .from('sections')\n        .insert(sectionData)\n        .select()\n        .single();\n      \n      // Guest should NOT be able to create sections\n      expect(data === null || error !== null).toBe(true);\n    });\n    \n    it('should prevent guest from updating sections', async () => {\n      if (authSetupFailed || !guestUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const serviceClient = createServiceClient();\n      const client = createTestClient(guestUser.accessToken);\n      \n      // Create section using service role\n      const { data: section } = await serviceClient\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174007',\n          title: 'Original Title',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      if (!section) {\n        console.log('⏭️  Skipping: Could not create test section');\n        return;\n      }\n      \n      trackEntity('sections', section.id);\n      \n      // Guest should NOT be able to update section\n      const { data, error } = await client\n        .from('sections')\n        .update({ title: 'Guest Updated Title' })\n        .eq('id', section.id)\n        .select()\n        .single();\n      \n      // Should fail or return no data\n      expect(data === null || error !== null).toBe(true);\n    });\n    \n    it('should prevent guest from deleting sections', async () => {\n      if (authSetupFailed || !guestUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const serviceClient = createServiceClient();\n      const client = createTestClient(guestUser.accessToken);\n      \n      // Create section using service role\n      const { data: section } = await serviceClient\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174008',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      if (!section) {\n        console.log('⏭️  Skipping: Could not create test section');\n        return;\n      }\n      \n      trackEntity('sections', section.id);\n      \n      // Guest should NOT be able to delete section\n      const { error } = await client\n        .from('sections')\n        .delete()\n        .eq('id', section.id);\n      \n      // Should fail with error\n      expect(error).not.toBeNull();\n      \n      // Verify section still exists\n      const { data: existingSection } = await serviceClient\n        .from('sections')\n        .select('*')\n        .eq('id', section.id)\n        .single();\n      \n      expect(existingSection).not.toBeNull();\n    });\n\n    \n    it('should prevent guest from creating columns', async () => {\n      if (authSetupFailed || !guestUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const serviceClient = createServiceClient();\n      const client = createTestClient(guestUser.accessToken);\n      \n      // Create section using service role\n      const { data: section } = await serviceClient\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174009',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      if (!section) {\n        console.log('⏭️  Skipping: Could not create test section');\n        return;\n      }\n      \n      trackEntity('sections', section.id);\n      \n      // Guest should NOT be able to create columns\n      const columnData = {\n        section_id: section.id,\n        column_number: 1,\n        content_type: 'rich_text',\n        content_data: { html: '<p>Guest created content</p>' },\n      };\n      \n      const { data, error } = await client\n        .from('columns')\n        .insert(columnData)\n        .select()\n        .single();\n      \n      // Should fail or return no data\n      expect(data === null || error !== null).toBe(true);\n    });\n    \n    it('should prevent guest from updating columns', async () => {\n      if (authSetupFailed || !guestUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const serviceClient = createServiceClient();\n      const client = createTestClient(guestUser.accessToken);\n      \n      // Create section and column using service role\n      const { data: section } = await serviceClient\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174010',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      if (!section) {\n        console.log('⏭️  Skipping: Could not create test section');\n        return;\n      }\n      \n      trackEntity('sections', section.id);\n      \n      const { data: column } = await serviceClient\n        .from('columns')\n        .insert({\n          section_id: section.id,\n          column_number: 1,\n          content_type: 'rich_text',\n          content_data: { html: '<p>Original content</p>' },\n        })\n        .select()\n        .single();\n      \n      if (!column) {\n        console.log('⏭️  Skipping: Could not create test column');\n        return;\n      }\n      \n      trackEntity('columns', column.id);\n      \n      // Guest should NOT be able to update column\n      const { data, error } = await client\n        .from('columns')\n        .update({ content_data: { html: '<p>Guest updated content</p>' } })\n        .eq('id', column.id)\n        .select()\n        .single();\n      \n      // Should fail or return no data\n      expect(data === null || error !== null).toBe(true);\n    });\n\n    \n    it('should prevent guest from deleting columns', async () => {\n      if (authSetupFailed || !guestUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const serviceClient = createServiceClient();\n      const client = createTestClient(guestUser.accessToken);\n      \n      // Create section and column using service role\n      const { data: section } = await serviceClient\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174011',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      if (!section) {\n        console.log('⏭️  Skipping: Could not create test section');\n        return;\n      }\n      \n      trackEntity('sections', section.id);\n      \n      const { data: column } = await serviceClient\n        .from('columns')\n        .insert({\n          section_id: section.id,\n          column_number: 1,\n          content_type: 'rich_text',\n          content_data: { html: '<p>Test content</p>' },\n        })\n        .select()\n        .single();\n      \n      if (!column) {\n        console.log('⏭️  Skipping: Could not create test column');\n        return;\n      }\n      \n      trackEntity('columns', column.id);\n      \n      // Guest should NOT be able to delete column\n      const { error } = await client\n        .from('columns')\n        .delete()\n        .eq('id', column.id);\n      \n      // Should fail with error\n      expect(error).not.toBeNull();\n      \n      // Verify column still exists\n      const { data: existingColumn } = await serviceClient\n        .from('columns')\n        .select('*')\n        .eq('id', column.id)\n        .single();\n      \n      expect(existingColumn).not.toBeNull();\n    });\n  });\n\n  \n  describe('Section Filtering by Page Type and ID', () => {\n    it('should filter sections by page_type and page_id', async () => {\n      if (authSetupFailed || !adminUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const serviceClient = createServiceClient();\n      const client = createTestClient(adminUser.accessToken);\n      \n      const testPageId1 = '123e4567-e89b-12d3-a456-426614174012';\n      const testPageId2 = '123e4567-e89b-12d3-a456-426614174013';\n      \n      // Create sections with different page types and IDs\n      const sections = [\n        {\n          page_type: 'event',\n          page_id: testPageId1,\n          title: 'Event Section 1',\n          display_order: 0,\n        },\n        {\n          page_type: 'event',\n          page_id: testPageId2,\n          title: 'Event Section 2',\n          display_order: 0,\n        },\n        {\n          page_type: 'activity',\n          page_id: testPageId1,\n          title: 'Activity Section',\n          display_order: 0,\n        },\n        {\n          page_type: 'accommodation',\n          page_id: testPageId1,\n          title: 'Accommodation Section',\n          display_order: 0,\n        },\n      ];\n      \n      const { data: createdSections } = await serviceClient\n        .from('sections')\n        .insert(sections)\n        .select();\n      \n      if (createdSections) {\n        createdSections.forEach(section => trackEntity('sections', section.id));\n      }\n      \n      // Filter by page_type = 'event'\n      const { data: eventSections, error: eventError } = await client\n        .from('sections')\n        .select('*')\n        .eq('page_type', 'event');\n      \n      expect(eventError).toBeNull();\n      expect(eventSections).toBeDefined();\n      expect(Array.isArray(eventSections)).toBe(true);\n      \n      if (eventSections && eventSections.length > 0) {\n        eventSections.forEach(section => {\n          expect(section.page_type).toBe('event');\n        });\n      }\n      \n      // Filter by page_type = 'event' AND page_id = testPageId1\n      const { data: filteredSections, error: filteredError } = await client\n        .from('sections')\n        .select('*')\n        .eq('page_type', 'event')\n        .eq('page_id', testPageId1);\n      \n      expect(filteredError).toBeNull();\n      expect(filteredSections).toBeDefined();\n      \n      if (filteredSections && filteredSections.length > 0) {\n        filteredSections.forEach(section => {\n          expect(section.page_type).toBe('event');\n          expect(section.page_id).toBe(testPageId1);\n        });\n      }\n      \n      // Filter by page_type = 'activity'\n      const { data: activitySections, error: activityError } = await client\n        .from('sections')\n        .select('*')\n        .eq('page_type', 'activity')\n        .eq('page_id', testPageId1);\n      \n      expect(activityError).toBeNull();\n      expect(activitySections).toBeDefined();\n      \n      if (activitySections && activitySections.length > 0) {\n        activitySections.forEach(section => {\n          expect(section.page_type).toBe('activity');\n          expect(section.page_id).toBe(testPageId1);\n        });\n      }\n    });\n  });\n\n  \n  describe('RLS Error Prevention', () => {\n    it('should not cause \"permission denied for table users\" errors with real auth', async () => {\n      if (authSetupFailed || !adminUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const client = createTestClient(adminUser.accessToken);\n      \n      // Perform various operations that should not cause permission errors\n      const { error: selectSectionsError } = await client\n        .from('sections')\n        .select('*')\n        .limit(10);\n      \n      const { error: selectColumnsError } = await client\n        .from('columns')\n        .select('*')\n        .limit(10);\n      \n      const { error: insertSectionError } = await client\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174014',\n          title: 'Permission Test Section',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      // Should not get permission denied errors\n      expect(selectSectionsError).toBeNull();\n      expect(selectColumnsError).toBeNull();\n      expect(insertSectionError).toBeNull();\n      \n      if (insertSectionError === null) {\n        // Track for cleanup if insert succeeded\n        const { data } = await client\n          .from('sections')\n          .select('id')\n          .eq('page_id', '123e4567-e89b-12d3-a456-426614174014')\n          .single();\n        \n        if (data) {\n          trackEntity('sections', data.id);\n        }\n      }\n    });\n    \n    it('should not reference users table in RLS policies', async () => {\n      if (authSetupFailed || !adminUser?.accessToken) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const client = createTestClient(adminUser.accessToken);\n      \n      // This test validates that RLS policies don't cause \"permission denied for table users\"\n      // by attempting operations that would trigger such errors if policies were misconfigured\n      \n      const { error: createError } = await client\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174015',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      // Should not contain \"permission denied\" or \"users\" in error message\n      if (createError) {\n        expect(createError.message).not.toContain('permission denied');\n        expect(createError.message).not.toContain('users');\n      } else {\n        // Track for cleanup if insert succeeded\n        const { data } = await client\n          .from('sections')\n          .select('id')\n          .eq('page_id', '123e4567-e89b-12d3-a456-426614174015')\n          .single();\n        \n        if (data) {\n          trackEntity('sections', data.id);\n        }\n      }\n    });\n  });\n\n  \n  describe('Service Role Bypass', () => {\n    it('should allow service role to bypass RLS for sections and columns', async () => {\n      if (authSetupFailed || !adminUser?.id) {\n        console.log('⏭️  Skipping: Authentication not configured');\n        return;\n      }\n      \n      const serviceClient = createServiceClient();\n      \n      // Service role should be able to create section without RLS restrictions\n      const { data: section, error: sectionError } = await serviceClient\n        .from('sections')\n        .insert({\n          page_type: 'event',\n          page_id: '123e4567-e89b-12d3-a456-426614174016',\n          title: 'Service Role Test Section',\n          display_order: 0,\n        })\n        .select()\n        .single();\n      \n      expect(sectionError).toBeNull();\n      expect(section).toBeDefined();\n      \n      if (section) {\n        trackEntity('sections', section.id);\n        \n        // Service role should be able to create column\n        const { data: column, error: columnError } = await serviceClient\n          .from('columns')\n          .insert({\n            section_id: section.id,\n            column_number: 1,\n            content_type: 'rich_text',\n            content_data: { html: '<p>Service role content</p>' },\n          })\n          .select()\n          .single();\n        \n        expect(columnError).toBeNull();\n        expect(column).toBeDefined();\n        \n        if (column) {\n          trackEntity('columns', column.id);\n          \n          // Service role should be able to read any section\n          const { data: readSection, error: readSectionError } = await serviceClient\n            .from('sections')\n            .select('*')\n            .eq('id', section.id)\n            .single();\n          \n          expect(readSectionError).toBeNull();\n          expect(readSection).toBeDefined();\n          \n          // Service role should be able to read any column\n          const { data: readColumn, error: readColumnError } = await serviceClient\n            .from('columns')\n            .select('*')\n            .eq('id', column.id)\n            .single();\n          \n          expect(readColumnError).toBeNull();\n          expect(readColumn).toBeDefined();\n          \n          // Service role should be able to update any section\n          const { data: updatedSection, error: updateSectionError } = await serviceClient\n            .from('sections')\n            .update({ title: 'Updated by service role' })\n            .eq('id', section.id)\n            .select()\n            .single();\n          \n          expect(updateSectionError).toBeNull();\n          expect(updatedSection).toBeDefined();\n          \n          // Service role should be able to update any column\n          const { data: updatedColumn, error: updateColumnError } = await serviceClient\n            .from('columns')\n            .update({ content_data: { html: '<p>Updated by service role</p>' } })\n            .eq('id', column.id)\n            .select()\n            .single();\n          \n          expect(updateColumnError).toBeNull();\n          expect(updatedColumn).toBeDefined();\n          \n          // Service role should be able to delete any column\n          const { error: deleteColumnError } = await serviceClient\n            .from('columns')\n            .delete()\n            .eq('id', column.id);\n          \n          expect(deleteColumnError).toBeNull();\n          \n          // Service role should be able to delete any section\n          const { error: deleteSectionError } = await serviceClient\n            .from('sections')\n            .delete()\n            .eq('id', section.id);\n          \n          expect(deleteSectionError).toBeNull();\n        }\n      }\n    });\n  });\n});\n\n\n/**\n * TEST IMPLEMENTATION NOTES\n * \n * These tests validate RLS policies for the sections and columns tables:\n * \n * 1. **Admin Operations**: Create, read, update, delete with real auth\n * 2. **Column Management**: Admin can manage columns for sections\n * 3. **Cascade Deletion**: Deleting section cascades to columns\n * 4. **Guest Restrictions**: Guests can only read sections and columns\n * 5. **Guest Limitations**: Guests cannot create, update, or delete\n * 6. **Filtering**: Sections filtered by page_type and page_id\n * 7. **Error Prevention**: No \"permission denied for table users\" errors\n * 8. **Service Role**: Service role can bypass RLS for admin operations\n * \n * Key Testing Patterns:\n * - Uses real authentication (not service role for user operations)\n * - Tests both admin and guest user roles\n * - Verifies cascade deletion from sections to columns\n * - Checks page_type and page_id filtering\n * - Validates RLS doesn't cause permission errors\n * - Confirms service role can bypass RLS\n * - Cleans up test data after execution\n * \n * What These Tests Catch:\n * - Missing RLS policies on sections/columns tables\n * - Incorrect RLS policy logic\n * - Permission denied errors with real auth\n * - Guests modifying sections/columns they shouldn't\n * - Filtering issues with page_type/page_id\n * - Cascade deletion not working properly\n * - RLS policies referencing users table incorrectly\n * \n * Validates: Requirements 1.2, 1.3, 1.4\n */\n"],"names":["describe","adminUser","guestUser","authSetupFailed","createdIds","Map","trackEntity","table","id","ids","get","push","set","beforeAll","createAndSignInTestUser","email","Date","now","password","role","console","log","error","warn","Error","message","afterAll","entries","length","cleanupByIds","deleteTestUser","it","accessToken","client","createTestClient","sectionData","page_type","page_id","title","display_order","data","from","insert","select","single","expect","toBeNull","toBeDefined","toBe","serviceClient","createServiceClient","section","columnData","section_id","column_number","content_type","content_data","html","column","updatedSection","update","eq","updatedColumn","toEqual","delete","deletedSection","deletedColumn","sections","sectionsError","Array","isArray","columns","columnsError","not","existingSection","existingColumn","testPageId1","testPageId2","createdSections","forEach","eventSections","eventError","filteredSections","filteredError","activitySections","activityError","selectSectionsError","limit","selectColumnsError","insertSectionError","createError","toContain","sectionError","columnError","readSection","readSectionError","readColumn","readColumnError","updateSectionError","updateColumnError","deleteColumnError","deleteSectionError"],"mappings":"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"}