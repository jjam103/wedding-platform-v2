f1d3c5cce91181a5cc249e7b9ef47194
/**
 * Unit Tests: Reference Checking
 * 
 * Tests reference detection and dependent record counting.
 */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
const _referenceChecking = require("./referenceChecking");
const _contentPagesService = require("../services/contentPagesService");
const _eventService = require("../services/eventService");
const _activityService = require("../services/activityService");
const _sectionsService = require("../services/sectionsService");
const _supabasejs = require("@supabase/supabase-js");
const supabase = (0, _supabasejs.createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);
describe('Reference Checking', ()=>{
    beforeEach(async ()=>{
        // Clean up test data
        await supabase.from('columns').delete().neq('id', '00000000-0000-0000-0000-000000000000');
        await supabase.from('sections').delete().neq('id', '00000000-0000-0000-0000-000000000000');
        await supabase.from('rsvps').delete().neq('id', '00000000-0000-0000-0000-000000000000');
        await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');
        await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');
        await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');
    });
    afterAll(async ()=>{
        // Final cleanup
        await supabase.from('columns').delete().neq('id', '00000000-0000-0000-0000-000000000000');
        await supabase.from('sections').delete().neq('id', '00000000-0000-0000-0000-000000000000');
        await supabase.from('rsvps').delete().neq('id', '00000000-0000-0000-0000-000000000000');
        await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');
        await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');
        await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');
    });
    describe('checkContentPageReferences', ()=>{
        it('should return no references for page without sections', async ()=>{
            // Create content page
            const pageResult = await (0, _contentPagesService.createContentPage)({
                title: 'Test Page',
                status: 'draft'
            });
            expect(pageResult.success).toBe(true);
            if (!pageResult.success) return;
            const pageId = pageResult.data.id;
            // Check references
            const result = await (0, _referenceChecking.checkContentPageReferences)(pageId);
            expect(result.hasReferences).toBe(false);
            expect(result.dependentRecords.length).toBe(0);
            expect(result.totalCount).toBe(0);
            // Cleanup
            await supabase.from('content_pages').delete().eq('id', pageId);
        });
        it('should detect sections as dependent records', async ()=>{
            // Create content page
            const pageResult = await (0, _contentPagesService.createContentPage)({
                title: 'Test Page',
                status: 'draft'
            });
            expect(pageResult.success).toBe(true);
            if (!pageResult.success) return;
            const pageId = pageResult.data.id;
            // Create sections
            await (0, _sectionsService.createSection)({
                page_type: 'custom',
                page_id: pageId,
                title: 'Section 1',
                display_order: 0
            });
            await (0, _sectionsService.createSection)({
                page_type: 'custom',
                page_id: pageId,
                title: 'Section 2',
                display_order: 1
            });
            // Check references
            const result = await (0, _referenceChecking.checkContentPageReferences)(pageId);
            expect(result.hasReferences).toBe(true);
            expect(result.dependentRecords.length).toBeGreaterThan(0);
            const sectionsRecord = result.dependentRecords.find((r)=>r.type === 'section');
            expect(sectionsRecord).toBeDefined();
            expect(sectionsRecord?.count).toBe(2);
            // Cleanup
            await supabase.from('sections').delete().eq('page_id', pageId);
            await supabase.from('content_pages').delete().eq('id', pageId);
        });
    });
    describe('checkEventReferences', ()=>{
        it('should return no references for event without activities', async ()=>{
            // Create event
            const eventResult = await (0, _eventService.create)({
                name: 'Test Event',
                date: new Date().toISOString().split('T')[0]
            });
            expect(eventResult.success).toBe(true);
            if (!eventResult.success) return;
            const eventId = eventResult.data.id;
            // Check references
            const result = await (0, _referenceChecking.checkEventReferences)(eventId);
            expect(result.hasReferences).toBe(false);
            expect(result.dependentRecords.length).toBe(0);
            expect(result.totalCount).toBe(0);
            // Cleanup
            await supabase.from('events').delete().eq('id', eventId);
        });
        it('should detect activities as dependent records', async ()=>{
            // Create event
            const eventResult = await (0, _eventService.create)({
                name: 'Test Event',
                date: new Date().toISOString().split('T')[0]
            });
            expect(eventResult.success).toBe(true);
            if (!eventResult.success) return;
            const eventId = eventResult.data.id;
            // Create activities
            await (0, _activityService.create)({
                name: 'Activity 1',
                event_id: eventId,
                date: new Date().toISOString().split('T')[0],
                activity_type: 'activity'
            });
            await (0, _activityService.create)({
                name: 'Activity 2',
                event_id: eventId,
                date: new Date().toISOString().split('T')[0],
                activity_type: 'activity'
            });
            // Check references
            const result = await (0, _referenceChecking.checkEventReferences)(eventId);
            expect(result.hasReferences).toBe(true);
            expect(result.dependentRecords.length).toBeGreaterThan(0);
            const activitiesRecord = result.dependentRecords.find((r)=>r.type === 'activity');
            expect(activitiesRecord).toBeDefined();
            expect(activitiesRecord?.count).toBe(2);
            // Cleanup
            await supabase.from('activities').delete().eq('event_id', eventId);
            await supabase.from('events').delete().eq('id', eventId);
        });
    });
    describe('checkActivityReferences', ()=>{
        it('should return no references for activity without RSVPs', async ()=>{
            // Create activity
            const activityResult = await (0, _activityService.create)({
                name: 'Test Activity',
                date: new Date().toISOString().split('T')[0],
                activity_type: 'activity'
            });
            expect(activityResult.success).toBe(true);
            if (!activityResult.success) return;
            const activityId = activityResult.data.id;
            // Check references
            const result = await (0, _referenceChecking.checkActivityReferences)(activityId);
            expect(result.hasReferences).toBe(false);
            expect(result.dependentRecords.length).toBe(0);
            expect(result.totalCount).toBe(0);
            // Cleanup
            await supabase.from('activities').delete().eq('id', activityId);
        });
    });
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9qYXJvbi9EZXNrdG9wL3dlZGRpbmctcGxhdGZvcm0tdjIvdXRpbHMvcmVmZXJlbmNlQ2hlY2tpbmcudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFVuaXQgVGVzdHM6IFJlZmVyZW5jZSBDaGVja2luZ1xuICogXG4gKiBUZXN0cyByZWZlcmVuY2UgZGV0ZWN0aW9uIGFuZCBkZXBlbmRlbnQgcmVjb3JkIGNvdW50aW5nLlxuICovXG5cbmltcG9ydCB7XG4gIGNoZWNrQ29udGVudFBhZ2VSZWZlcmVuY2VzLFxuICBjaGVja0V2ZW50UmVmZXJlbmNlcyxcbiAgY2hlY2tBY3Rpdml0eVJlZmVyZW5jZXMsXG59IGZyb20gJy4vcmVmZXJlbmNlQ2hlY2tpbmcnO1xuaW1wb3J0IHsgY3JlYXRlQ29udGVudFBhZ2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9jb250ZW50UGFnZXNTZXJ2aWNlJztcbmltcG9ydCB7IGNyZWF0ZSBhcyBjcmVhdGVFdmVudCB9IGZyb20gJy4uL3NlcnZpY2VzL2V2ZW50U2VydmljZSc7XG5pbXBvcnQgeyBjcmVhdGUgYXMgY3JlYXRlQWN0aXZpdHkgfSBmcm9tICcuLi9zZXJ2aWNlcy9hY3Rpdml0eVNlcnZpY2UnO1xuaW1wb3J0IHsgY3JlYXRlU2VjdGlvbiB9IGZyb20gJy4uL3NlcnZpY2VzL3NlY3Rpb25zU2VydmljZSc7XG5pbXBvcnQgeyBjcmVhdGVDbGllbnQgfSBmcm9tICdAc3VwYWJhc2Uvc3VwYWJhc2UtanMnO1xuXG5jb25zdCBzdXBhYmFzZSA9IGNyZWF0ZUNsaWVudChcbiAgcHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfU1VQQUJBU0VfVVJMISxcbiAgcHJvY2Vzcy5lbnYuU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWSFcbik7XG5cbmRlc2NyaWJlKCdSZWZlcmVuY2UgQ2hlY2tpbmcnLCAoKSA9PiB7XG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIC8vIENsZWFuIHVwIHRlc3QgZGF0YVxuICAgIGF3YWl0IHN1cGFiYXNlLmZyb20oJ2NvbHVtbnMnKS5kZWxldGUoKS5uZXEoJ2lkJywgJzAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCcpO1xuICAgIGF3YWl0IHN1cGFiYXNlLmZyb20oJ3NlY3Rpb25zJykuZGVsZXRlKCkubmVxKCdpZCcsICcwMDAwMDAwMC0wMDAwLTAwMDAtMDAwMC0wMDAwMDAwMDAwMDAnKTtcbiAgICBhd2FpdCBzdXBhYmFzZS5mcm9tKCdyc3ZwcycpLmRlbGV0ZSgpLm5lcSgnaWQnLCAnMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwJyk7XG4gICAgYXdhaXQgc3VwYWJhc2UuZnJvbSgnYWN0aXZpdGllcycpLmRlbGV0ZSgpLm5lcSgnaWQnLCAnMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwJyk7XG4gICAgYXdhaXQgc3VwYWJhc2UuZnJvbSgnZXZlbnRzJykuZGVsZXRlKCkubmVxKCdpZCcsICcwMDAwMDAwMC0wMDAwLTAwMDAtMDAwMC0wMDAwMDAwMDAwMDAnKTtcbiAgICBhd2FpdCBzdXBhYmFzZS5mcm9tKCdjb250ZW50X3BhZ2VzJykuZGVsZXRlKCkubmVxKCdpZCcsICcwMDAwMDAwMC0wMDAwLTAwMDAtMDAwMC0wMDAwMDAwMDAwMDAnKTtcbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgIC8vIEZpbmFsIGNsZWFudXBcbiAgICBhd2FpdCBzdXBhYmFzZS5mcm9tKCdjb2x1bW5zJykuZGVsZXRlKCkubmVxKCdpZCcsICcwMDAwMDAwMC0wMDAwLTAwMDAtMDAwMC0wMDAwMDAwMDAwMDAnKTtcbiAgICBhd2FpdCBzdXBhYmFzZS5mcm9tKCdzZWN0aW9ucycpLmRlbGV0ZSgpLm5lcSgnaWQnLCAnMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwJyk7XG4gICAgYXdhaXQgc3VwYWJhc2UuZnJvbSgncnN2cHMnKS5kZWxldGUoKS5uZXEoJ2lkJywgJzAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCcpO1xuICAgIGF3YWl0IHN1cGFiYXNlLmZyb20oJ2FjdGl2aXRpZXMnKS5kZWxldGUoKS5uZXEoJ2lkJywgJzAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCcpO1xuICAgIGF3YWl0IHN1cGFiYXNlLmZyb20oJ2V2ZW50cycpLmRlbGV0ZSgpLm5lcSgnaWQnLCAnMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwJyk7XG4gICAgYXdhaXQgc3VwYWJhc2UuZnJvbSgnY29udGVudF9wYWdlcycpLmRlbGV0ZSgpLm5lcSgnaWQnLCAnMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwJyk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjaGVja0NvbnRlbnRQYWdlUmVmZXJlbmNlcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBubyByZWZlcmVuY2VzIGZvciBwYWdlIHdpdGhvdXQgc2VjdGlvbnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDcmVhdGUgY29udGVudCBwYWdlXG4gICAgICBjb25zdCBwYWdlUmVzdWx0ID0gYXdhaXQgY3JlYXRlQ29udGVudFBhZ2Uoe1xuICAgICAgICB0aXRsZTogJ1Rlc3QgUGFnZScsXG4gICAgICAgIHN0YXR1czogJ2RyYWZ0JyxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QocGFnZVJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgaWYgKCFwYWdlUmVzdWx0LnN1Y2Nlc3MpIHJldHVybjtcblxuICAgICAgY29uc3QgcGFnZUlkID0gcGFnZVJlc3VsdC5kYXRhLmlkO1xuXG4gICAgICAvLyBDaGVjayByZWZlcmVuY2VzXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjaGVja0NvbnRlbnRQYWdlUmVmZXJlbmNlcyhwYWdlSWQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0Lmhhc1JlZmVyZW5jZXMpLnRvQmUoZmFsc2UpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5kZXBlbmRlbnRSZWNvcmRzLmxlbmd0aCkudG9CZSgwKTtcbiAgICAgIGV4cGVjdChyZXN1bHQudG90YWxDb3VudCkudG9CZSgwKTtcblxuICAgICAgLy8gQ2xlYW51cFxuICAgICAgYXdhaXQgc3VwYWJhc2UuZnJvbSgnY29udGVudF9wYWdlcycpLmRlbGV0ZSgpLmVxKCdpZCcsIHBhZ2VJZCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGRldGVjdCBzZWN0aW9ucyBhcyBkZXBlbmRlbnQgcmVjb3JkcycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENyZWF0ZSBjb250ZW50IHBhZ2VcbiAgICAgIGNvbnN0IHBhZ2VSZXN1bHQgPSBhd2FpdCBjcmVhdGVDb250ZW50UGFnZSh7XG4gICAgICAgIHRpdGxlOiAnVGVzdCBQYWdlJyxcbiAgICAgICAgc3RhdHVzOiAnZHJhZnQnLFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChwYWdlUmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XG4gICAgICBpZiAoIXBhZ2VSZXN1bHQuc3VjY2VzcykgcmV0dXJuO1xuXG4gICAgICBjb25zdCBwYWdlSWQgPSBwYWdlUmVzdWx0LmRhdGEuaWQ7XG5cbiAgICAgIC8vIENyZWF0ZSBzZWN0aW9uc1xuICAgICAgYXdhaXQgY3JlYXRlU2VjdGlvbih7XG4gICAgICAgIHBhZ2VfdHlwZTogJ2N1c3RvbScsXG4gICAgICAgIHBhZ2VfaWQ6IHBhZ2VJZCxcbiAgICAgICAgdGl0bGU6ICdTZWN0aW9uIDEnLFxuICAgICAgICBkaXNwbGF5X29yZGVyOiAwLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IGNyZWF0ZVNlY3Rpb24oe1xuICAgICAgICBwYWdlX3R5cGU6ICdjdXN0b20nLFxuICAgICAgICBwYWdlX2lkOiBwYWdlSWQsXG4gICAgICAgIHRpdGxlOiAnU2VjdGlvbiAyJyxcbiAgICAgICAgZGlzcGxheV9vcmRlcjogMSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDaGVjayByZWZlcmVuY2VzXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjaGVja0NvbnRlbnRQYWdlUmVmZXJlbmNlcyhwYWdlSWQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0Lmhhc1JlZmVyZW5jZXMpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QocmVzdWx0LmRlcGVuZGVudFJlY29yZHMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgICBcbiAgICAgIGNvbnN0IHNlY3Rpb25zUmVjb3JkID0gcmVzdWx0LmRlcGVuZGVudFJlY29yZHMuZmluZCgocikgPT4gci50eXBlID09PSAnc2VjdGlvbicpO1xuICAgICAgZXhwZWN0KHNlY3Rpb25zUmVjb3JkKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHNlY3Rpb25zUmVjb3JkPy5jb3VudCkudG9CZSgyKTtcblxuICAgICAgLy8gQ2xlYW51cFxuICAgICAgYXdhaXQgc3VwYWJhc2UuZnJvbSgnc2VjdGlvbnMnKS5kZWxldGUoKS5lcSgncGFnZV9pZCcsIHBhZ2VJZCk7XG4gICAgICBhd2FpdCBzdXBhYmFzZS5mcm9tKCdjb250ZW50X3BhZ2VzJykuZGVsZXRlKCkuZXEoJ2lkJywgcGFnZUlkKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NoZWNrRXZlbnRSZWZlcmVuY2VzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIG5vIHJlZmVyZW5jZXMgZm9yIGV2ZW50IHdpdGhvdXQgYWN0aXZpdGllcycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENyZWF0ZSBldmVudFxuICAgICAgY29uc3QgZXZlbnRSZXN1bHQgPSBhd2FpdCBjcmVhdGVFdmVudCh7XG4gICAgICAgIG5hbWU6ICdUZXN0IEV2ZW50JyxcbiAgICAgICAgZGF0ZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF0sXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KGV2ZW50UmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XG4gICAgICBpZiAoIWV2ZW50UmVzdWx0LnN1Y2Nlc3MpIHJldHVybjtcblxuICAgICAgY29uc3QgZXZlbnRJZCA9IGV2ZW50UmVzdWx0LmRhdGEuaWQ7XG5cbiAgICAgIC8vIENoZWNrIHJlZmVyZW5jZXNcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNoZWNrRXZlbnRSZWZlcmVuY2VzKGV2ZW50SWQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0Lmhhc1JlZmVyZW5jZXMpLnRvQmUoZmFsc2UpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5kZXBlbmRlbnRSZWNvcmRzLmxlbmd0aCkudG9CZSgwKTtcbiAgICAgIGV4cGVjdChyZXN1bHQudG90YWxDb3VudCkudG9CZSgwKTtcblxuICAgICAgLy8gQ2xlYW51cFxuICAgICAgYXdhaXQgc3VwYWJhc2UuZnJvbSgnZXZlbnRzJykuZGVsZXRlKCkuZXEoJ2lkJywgZXZlbnRJZCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGRldGVjdCBhY3Rpdml0aWVzIGFzIGRlcGVuZGVudCByZWNvcmRzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ3JlYXRlIGV2ZW50XG4gICAgICBjb25zdCBldmVudFJlc3VsdCA9IGF3YWl0IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgbmFtZTogJ1Rlc3QgRXZlbnQnLFxuICAgICAgICBkYXRlOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QoZXZlbnRSZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcbiAgICAgIGlmICghZXZlbnRSZXN1bHQuc3VjY2VzcykgcmV0dXJuO1xuXG4gICAgICBjb25zdCBldmVudElkID0gZXZlbnRSZXN1bHQuZGF0YS5pZDtcblxuICAgICAgLy8gQ3JlYXRlIGFjdGl2aXRpZXNcbiAgICAgIGF3YWl0IGNyZWF0ZUFjdGl2aXR5KHtcbiAgICAgICAgbmFtZTogJ0FjdGl2aXR5IDEnLFxuICAgICAgICBldmVudF9pZDogZXZlbnRJZCxcbiAgICAgICAgZGF0ZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF0sXG4gICAgICAgIGFjdGl2aXR5X3R5cGU6ICdhY3Rpdml0eScsXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgY3JlYXRlQWN0aXZpdHkoe1xuICAgICAgICBuYW1lOiAnQWN0aXZpdHkgMicsXG4gICAgICAgIGV2ZW50X2lkOiBldmVudElkLFxuICAgICAgICBkYXRlOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSxcbiAgICAgICAgYWN0aXZpdHlfdHlwZTogJ2FjdGl2aXR5JyxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDaGVjayByZWZlcmVuY2VzXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjaGVja0V2ZW50UmVmZXJlbmNlcyhldmVudElkKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5oYXNSZWZlcmVuY2VzKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5kZXBlbmRlbnRSZWNvcmRzLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgICAgXG4gICAgICBjb25zdCBhY3Rpdml0aWVzUmVjb3JkID0gcmVzdWx0LmRlcGVuZGVudFJlY29yZHMuZmluZCgocikgPT4gci50eXBlID09PSAnYWN0aXZpdHknKTtcbiAgICAgIGV4cGVjdChhY3Rpdml0aWVzUmVjb3JkKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGFjdGl2aXRpZXNSZWNvcmQ/LmNvdW50KS50b0JlKDIpO1xuXG4gICAgICAvLyBDbGVhbnVwXG4gICAgICBhd2FpdCBzdXBhYmFzZS5mcm9tKCdhY3Rpdml0aWVzJykuZGVsZXRlKCkuZXEoJ2V2ZW50X2lkJywgZXZlbnRJZCk7XG4gICAgICBhd2FpdCBzdXBhYmFzZS5mcm9tKCdldmVudHMnKS5kZWxldGUoKS5lcSgnaWQnLCBldmVudElkKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NoZWNrQWN0aXZpdHlSZWZlcmVuY2VzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIG5vIHJlZmVyZW5jZXMgZm9yIGFjdGl2aXR5IHdpdGhvdXQgUlNWUHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDcmVhdGUgYWN0aXZpdHlcbiAgICAgIGNvbnN0IGFjdGl2aXR5UmVzdWx0ID0gYXdhaXQgY3JlYXRlQWN0aXZpdHkoe1xuICAgICAgICBuYW1lOiAnVGVzdCBBY3Rpdml0eScsXG4gICAgICAgIGRhdGU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zcGxpdCgnVCcpWzBdLFxuICAgICAgICBhY3Rpdml0eV90eXBlOiAnYWN0aXZpdHknLFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChhY3Rpdml0eVJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgaWYgKCFhY3Rpdml0eVJlc3VsdC5zdWNjZXNzKSByZXR1cm47XG5cbiAgICAgIGNvbnN0IGFjdGl2aXR5SWQgPSBhY3Rpdml0eVJlc3VsdC5kYXRhLmlkO1xuXG4gICAgICAvLyBDaGVjayByZWZlcmVuY2VzXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjaGVja0FjdGl2aXR5UmVmZXJlbmNlcyhhY3Rpdml0eUlkKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5oYXNSZWZlcmVuY2VzKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZGVwZW5kZW50UmVjb3Jkcy5sZW5ndGgpLnRvQmUoMCk7XG4gICAgICBleHBlY3QocmVzdWx0LnRvdGFsQ291bnQpLnRvQmUoMCk7XG5cbiAgICAgIC8vIENsZWFudXBcbiAgICAgIGF3YWl0IHN1cGFiYXNlLmZyb20oJ2FjdGl2aXRpZXMnKS5kZWxldGUoKS5lcSgnaWQnLCBhY3Rpdml0eUlkKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJuYW1lcyI6WyJzdXBhYmFzZSIsImNyZWF0ZUNsaWVudCIsInByb2Nlc3MiLCJlbnYiLCJORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwiLCJTVVBBQkFTRV9TRVJWSUNFX1JPTEVfS0VZIiwiZGVzY3JpYmUiLCJiZWZvcmVFYWNoIiwiZnJvbSIsImRlbGV0ZSIsIm5lcSIsImFmdGVyQWxsIiwiaXQiLCJwYWdlUmVzdWx0IiwiY3JlYXRlQ29udGVudFBhZ2UiLCJ0aXRsZSIsInN0YXR1cyIsImV4cGVjdCIsInN1Y2Nlc3MiLCJ0b0JlIiwicGFnZUlkIiwiZGF0YSIsImlkIiwicmVzdWx0IiwiY2hlY2tDb250ZW50UGFnZVJlZmVyZW5jZXMiLCJoYXNSZWZlcmVuY2VzIiwiZGVwZW5kZW50UmVjb3JkcyIsImxlbmd0aCIsInRvdGFsQ291bnQiLCJlcSIsImNyZWF0ZVNlY3Rpb24iLCJwYWdlX3R5cGUiLCJwYWdlX2lkIiwiZGlzcGxheV9vcmRlciIsInRvQmVHcmVhdGVyVGhhbiIsInNlY3Rpb25zUmVjb3JkIiwiZmluZCIsInIiLCJ0eXBlIiwidG9CZURlZmluZWQiLCJjb3VudCIsImV2ZW50UmVzdWx0IiwiY3JlYXRlRXZlbnQiLCJuYW1lIiwiZGF0ZSIsIkRhdGUiLCJ0b0lTT1N0cmluZyIsInNwbGl0IiwiZXZlbnRJZCIsImNoZWNrRXZlbnRSZWZlcmVuY2VzIiwiY3JlYXRlQWN0aXZpdHkiLCJldmVudF9pZCIsImFjdGl2aXR5X3R5cGUiLCJhY3Rpdml0aWVzUmVjb3JkIiwiYWN0aXZpdHlSZXN1bHQiLCJhY3Rpdml0eUlkIiwiY2hlY2tBY3Rpdml0eVJlZmVyZW5jZXMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0NBSUM7Ozs7bUNBTU07cUNBQzJCOzhCQUNJO2lDQUNHO2lDQUNYOzRCQUNEO0FBRTdCLE1BQU1BLFdBQVdDLElBQUFBLHdCQUFZLEVBQzNCQyxRQUFRQyxHQUFHLENBQUNDLHdCQUF3QixFQUNwQ0YsUUFBUUMsR0FBRyxDQUFDRSx5QkFBeUI7QUFHdkNDLFNBQVMsc0JBQXNCO0lBQzdCQyxXQUFXO1FBQ1QscUJBQXFCO1FBQ3JCLE1BQU1QLFNBQVNRLElBQUksQ0FBQyxXQUFXQyxNQUFNLEdBQUdDLEdBQUcsQ0FBQyxNQUFNO1FBQ2xELE1BQU1W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