{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/utils/referenceChecking.test.ts"],"sourcesContent":["/**\n * Unit Tests: Reference Checking\n * \n * Tests reference detection and dependent record counting.\n */\n\nimport {\n  checkContentPageReferences,\n  checkEventReferences,\n  checkActivityReferences,\n} from './referenceChecking';\nimport { createContentPage } from '../services/contentPagesService';\nimport { create as createEvent } from '../services/eventService';\nimport { create as createActivity } from '../services/activityService';\nimport { createSection } from '../services/sectionsService';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ndescribe('Reference Checking', () => {\n  beforeEach(async () => {\n    // Clean up test data\n    await supabase.from('columns').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('sections').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('rsvps').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  afterAll(async () => {\n    // Final cleanup\n    await supabase.from('columns').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('sections').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('rsvps').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  describe('checkContentPageReferences', () => {\n    it('should return no references for page without sections', async () => {\n      // Create content page\n      const pageResult = await createContentPage({\n        title: 'Test Page',\n        status: 'draft',\n      });\n\n      expect(pageResult.success).toBe(true);\n      if (!pageResult.success) return;\n\n      const pageId = pageResult.data.id;\n\n      // Check references\n      const result = await checkContentPageReferences(pageId);\n\n      expect(result.hasReferences).toBe(false);\n      expect(result.dependentRecords.length).toBe(0);\n      expect(result.totalCount).toBe(0);\n\n      // Cleanup\n      await supabase.from('content_pages').delete().eq('id', pageId);\n    });\n\n    it('should detect sections as dependent records', async () => {\n      // Create content page\n      const pageResult = await createContentPage({\n        title: 'Test Page',\n        status: 'draft',\n      });\n\n      expect(pageResult.success).toBe(true);\n      if (!pageResult.success) return;\n\n      const pageId = pageResult.data.id;\n\n      // Create sections\n      await createSection({\n        page_type: 'custom',\n        page_id: pageId,\n        title: 'Section 1',\n        display_order: 0,\n      });\n\n      await createSection({\n        page_type: 'custom',\n        page_id: pageId,\n        title: 'Section 2',\n        display_order: 1,\n      });\n\n      // Check references\n      const result = await checkContentPageReferences(pageId);\n\n      expect(result.hasReferences).toBe(true);\n      expect(result.dependentRecords.length).toBeGreaterThan(0);\n      \n      const sectionsRecord = result.dependentRecords.find((r) => r.type === 'section');\n      expect(sectionsRecord).toBeDefined();\n      expect(sectionsRecord?.count).toBe(2);\n\n      // Cleanup\n      await supabase.from('sections').delete().eq('page_id', pageId);\n      await supabase.from('content_pages').delete().eq('id', pageId);\n    });\n  });\n\n  describe('checkEventReferences', () => {\n    it('should return no references for event without activities', async () => {\n      // Create event\n      const eventResult = await createEvent({\n        name: 'Test Event',\n        date: new Date().toISOString().split('T')[0],\n      });\n\n      expect(eventResult.success).toBe(true);\n      if (!eventResult.success) return;\n\n      const eventId = eventResult.data.id;\n\n      // Check references\n      const result = await checkEventReferences(eventId);\n\n      expect(result.hasReferences).toBe(false);\n      expect(result.dependentRecords.length).toBe(0);\n      expect(result.totalCount).toBe(0);\n\n      // Cleanup\n      await supabase.from('events').delete().eq('id', eventId);\n    });\n\n    it('should detect activities as dependent records', async () => {\n      // Create event\n      const eventResult = await createEvent({\n        name: 'Test Event',\n        date: new Date().toISOString().split('T')[0],\n      });\n\n      expect(eventResult.success).toBe(true);\n      if (!eventResult.success) return;\n\n      const eventId = eventResult.data.id;\n\n      // Create activities\n      await createActivity({\n        name: 'Activity 1',\n        event_id: eventId,\n        date: new Date().toISOString().split('T')[0],\n        activity_type: 'activity',\n      });\n\n      await createActivity({\n        name: 'Activity 2',\n        event_id: eventId,\n        date: new Date().toISOString().split('T')[0],\n        activity_type: 'activity',\n      });\n\n      // Check references\n      const result = await checkEventReferences(eventId);\n\n      expect(result.hasReferences).toBe(true);\n      expect(result.dependentRecords.length).toBeGreaterThan(0);\n      \n      const activitiesRecord = result.dependentRecords.find((r) => r.type === 'activity');\n      expect(activitiesRecord).toBeDefined();\n      expect(activitiesRecord?.count).toBe(2);\n\n      // Cleanup\n      await supabase.from('activities').delete().eq('event_id', eventId);\n      await supabase.from('events').delete().eq('id', eventId);\n    });\n  });\n\n  describe('checkActivityReferences', () => {\n    it('should return no references for activity without RSVPs', async () => {\n      // Create activity\n      const activityResult = await createActivity({\n        name: 'Test Activity',\n        date: new Date().toISOString().split('T')[0],\n        activity_type: 'activity',\n      });\n\n      expect(activityResult.success).toBe(true);\n      if (!activityResult.success) return;\n\n      const activityId = activityResult.data.id;\n\n      // Check references\n      const result = await checkActivityReferences(activityId);\n\n      expect(result.hasReferences).toBe(false);\n      expect(result.dependentRecords.length).toBe(0);\n      expect(result.totalCount).toBe(0);\n\n      // Cleanup\n      await supabase.from('activities').delete().eq('id', activityId);\n    });\n  });\n});\n"],"names":["supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","describe","beforeEach","from","delete","neq","afterAll","it","pageResult","createContentPage","title","status","expect","success","toBe","pageId","data","id","result","checkContentPageReferences","hasReferences","dependentRecords","length","totalCount","eq","createSection","page_type","page_id","display_order","toBeGreaterThan","sectionsRecord","find","r","type","toBeDefined","count","eventResult","createEvent","name","date","Date","toISOString","split","eventId","checkEventReferences","createActivity","event_id","activity_type","activitiesRecord","activityResult","activityId","checkActivityReferences"],"mappings":"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"}