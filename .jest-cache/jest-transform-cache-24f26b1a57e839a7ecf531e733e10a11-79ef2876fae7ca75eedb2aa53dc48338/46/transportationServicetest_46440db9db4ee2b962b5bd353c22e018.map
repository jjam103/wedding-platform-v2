{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/transportationService.test.ts"],"sourcesContent":["import { createMockSupabaseClient } from '../__tests__/helpers/mockSupabase';\n\n// Mock the supabase lib at the module level - MUST be before service import\nconst mockSupabase = createMockSupabaseClient();\njest.mock('@/lib/supabase', () => ({\n  supabase: mockSupabase,\n}));\n\n// Mock sanitization utilities\njest.mock('../utils/sanitization', () => ({\n  sanitizeInput: jest.fn((input: string) => input?.trim() || ''),\n  sanitizeRichText: jest.fn((input: string) => input?.trim() || ''),\n}));\n\n// Mock types and error codes\njest.mock('../types', () => ({\n  ERROR_CODES: {\n    VALIDATION_ERROR: 'VALIDATION_ERROR',\n    DATABASE_ERROR: 'DATABASE_ERROR',\n    UNKNOWN_ERROR: 'UNKNOWN_ERROR',\n  },\n}));\n\n// Mock schemas with proper validation logic\nconst mockFlightInfoSafeParse = jest.fn((data) => {\n  // Basic validation for flight info\n  if (!data.guest_id || !data.airport_code) {\n    return { success: false, error: { issues: ['Invalid data'] } };\n  }\n  if (data.guest_id === 'invalid-uuid') {\n    return { success: false, error: { issues: ['Invalid UUID'] } };\n  }\n  if (data.airport_code === 'INVALID') {\n    return { success: false, error: { issues: ['Invalid airport code'] } };\n  }\n  return { success: true, data };\n});\n\nconst mockManifestSafeParse = jest.fn((data) => {\n  // Always return success for manifest creation in tests\n  return { success: true, data };\n});\n\njest.mock('../schemas/transportationSchemas', () => ({\n  flightInfoSchema: {\n    get safeParse() {\n      return mockFlightInfoSafeParse;\n    },\n  },\n  createTransportationManifestSchema: {\n    get safeParse() {\n      return mockManifestSafeParse;\n    },\n  },\n  updateTransportationManifestSchema: {\n    safeParse: jest.fn((data) => ({ success: true, data })),\n  },\n}));\n\n// Import service AFTER mocks are set up\nimport {\n  updateFlightInfo,\n  getFlightsByAirport,\n  generateArrivalManifest,\n  generateDepartureManifest,\n  assignGuestsToShuttle,\n  calculateVehicleRequirements,\n  generateDriverSheet,\n  calculateShuttleCosts,\n  createManifest,\n  _setSupabaseForTesting,\n  _resetSupabaseForTesting,\n} from './transportationService';\n\nimport { describe, it, expect, jest, beforeEach } from '@jest/globals';\nimport type { FlightInfoDTO } from '../schemas/transportationSchemas';\n\ndescribe('transportationService', () => {\n  beforeEach(() => {\n    // Reset only the from mock, not all mocks\n    mockSupabase.from.mockReset();\n    // Set the mock supabase client for testing\n    _setSupabaseForTesting(mockSupabase);\n  });\n\n  describe('updateFlightInfo', () => {\n    const validFlightInfo: FlightInfoDTO = {\n      guest_id: '123e4567-e89b-12d3-a456-426614174000',\n      airport_code: 'SJO',\n      flight_number: 'AA123',\n      airline: 'American Airlines',\n      arrival_time: '2025-06-01T14:30:00Z',\n      departure_time: '2025-06-08T16:45:00Z',\n    };\n\n    it('should return success when flight info is updated successfully', async () => {\n      // Mock successful update\n      mockSupabase.from.mockReturnValue({\n        update: jest.fn().mockReturnValue({\n          eq: jest.fn().mockResolvedValue({ error: null }),\n        }),\n      });\n\n      const result = await updateFlightInfo(\n        validFlightInfo.guest_id,\n        validFlightInfo\n      );\n\n      expect(result.success).toBe(true);\n      expect(mockSupabase.from).toHaveBeenCalledWith('guests');\n    });\n\n    it('should return VALIDATION_ERROR when guest_id is invalid', async () => {\n      const invalidFlightInfo = { ...validFlightInfo, guest_id: 'invalid-uuid' };\n      \n      const result = await updateFlightInfo(\n        invalidFlightInfo.guest_id,\n        invalidFlightInfo\n      );\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n      }\n    });\n\n    it('should return VALIDATION_ERROR when airport_code is invalid', async () => {\n      const invalidFlightInfo = { ...validFlightInfo, airport_code: 'INVALID' as any };\n      \n      const result = await updateFlightInfo(\n        validFlightInfo.guest_id,\n        invalidFlightInfo\n      );\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n      }\n    });\n\n    it('should return DATABASE_ERROR when update fails', async () => {\n      // Mock database error\n      mockSupabase.from.mockReturnValue({\n        update: jest.fn().mockReturnValue({\n          eq: jest.fn().mockResolvedValue({ error: { message: 'Connection failed' } }),\n        }),\n      });\n\n      const result = await updateFlightInfo(\n        validFlightInfo.guest_id,\n        validFlightInfo\n      );\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n\n    it('should sanitize flight_number and airline to prevent XSS attacks', async () => {\n      const maliciousFlightInfo = {\n        ...validFlightInfo,\n        flight_number: 'AA123  ', // Valid but with extra whitespace\n        airline: 'American Airlines  ', // Valid but with extra whitespace\n      };\n\n      // Mock successful update\n      const mockUpdate = jest.fn().mockReturnValue({\n        eq: jest.fn().mockResolvedValue({ error: null }),\n      });\n      mockSupabase.from.mockReturnValue({ update: mockUpdate });\n\n      const result = await updateFlightInfo(\n        validFlightInfo.guest_id,\n        maliciousFlightInfo\n      );\n\n      expect(result.success).toBe(true);\n      \n      // Verify the update was called with sanitized data (trimmed)\n      expect(mockUpdate).toHaveBeenCalledWith(\n        expect.objectContaining({\n          flight_number: 'AA123', // Should be trimmed\n          airport_code: 'SJO',\n        })\n      );\n    });\n  });\n\n  describe('getFlightsByAirport', () => {\n    it('should return success with flight information when flights exist', async () => {\n      const mockGuests = [\n        {\n          id: 'guest-1',\n          airport_code: 'SJO',\n          flight_number: 'AA123',\n          arrival_date: '2025-06-01',\n          departure_date: '2025-06-08',\n        },\n        {\n          id: 'guest-2',\n          airport_code: 'SJO',\n          flight_number: 'UA456',\n          arrival_date: '2025-06-02',\n          departure_date: '2025-06-09',\n        },\n      ];\n\n      // Mock successful query\n      mockSupabase.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            not: jest.fn().mockResolvedValue({ data: mockGuests, error: null }),\n          }),\n        }),\n      });\n\n      const result = await getFlightsByAirport('SJO');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(2);\n        expect(result.data[0].guest_id).toBe('guest-1');\n        expect(result.data[0].airport_code).toBe('SJO');\n        expect(result.data[0].flight_number).toBe('AA123');\n      }\n    });\n\n    it('should return empty array when no flights found', async () => {\n      // Mock empty result\n      mockSupabase.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            not: jest.fn().mockResolvedValue({ data: [], error: null }),\n          }),\n        }),\n      });\n\n      const result = await getFlightsByAirport('LIR');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(0);\n      }\n    });\n\n    it('should return DATABASE_ERROR when query fails', async () => {\n      // Mock database error\n      mockSupabase.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            not: jest.fn().mockResolvedValue({ data: null, error: { message: 'Connection failed' } }),\n          }),\n        }),\n      });\n\n      const result = await getFlightsByAirport('SJO');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n  });\n\n  describe('createManifest', () => {\n    it('should create a manifest successfully', async () => {\n      const manifestData = {\n        manifest_type: 'arrival' as const,\n        date: '2025-06-01',\n        time_window_start: '10:00:00',\n        time_window_end: '12:00:00',\n        guest_ids: ['123e4567-e89b-12d3-a456-426614174001', '123e4567-e89b-12d3-a456-426614174002'],\n      };\n\n      const mockManifest = {\n        id: 'manifest-1',\n        ...manifestData,\n        created_at: '2024-01-01T00:00:00Z',\n        updated_at: '2024-01-01T00:00:00Z',\n      };\n\n      mockSupabase.from.mockReturnValue({\n        insert: jest.fn().mockReturnValue({\n          select: jest.fn().mockReturnValue({\n            single: jest.fn().mockResolvedValue({ data: mockManifest, error: null }),\n          }),\n        }),\n      });\n\n      const result = await createManifest(manifestData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('manifest-1');\n      }\n    });\n  });\n\n  describe('generateArrivalManifest', () => {\n    it('should return success with manifests when guests are arriving', async () => {\n      const mockGuests = [\n        {\n          id: '123e4567-e89b-12d3-a456-426614174001',\n          first_name: 'John',\n          last_name: 'Doe',\n          arrival_date: '2025-06-01',\n          arrival_time: '10:30:00',\n          airport_code: 'SJO',\n          flight_number: 'AA123',\n        },\n        {\n          id: '123e4567-e89b-12d3-a456-426614174002',\n          first_name: 'Jane',\n          last_name: 'Smith',\n          arrival_date: '2025-06-01',\n          arrival_time: '11:45:00',\n          airport_code: 'SJO',\n          flight_number: 'UA456',\n        },\n      ];\n\n      const mockManifest = {\n        id: 'manifest-1',\n        manifest_type: 'arrival' as const,\n        date: '2025-06-01',\n        time_window_start: '10:00:00',\n        time_window_end: '12:00:00',\n        guest_ids: ['123e4567-e89b-12d3-a456-426614174001', '123e4567-e89b-12d3-a456-426614174002'],\n        created_at: '2024-01-01T00:00:00Z',\n        updated_at: '2024-01-01T00:00:00Z',\n      };\n\n      // Mock the guests query and manifest creation\n      mockSupabase.from.mockImplementation((table: string) => {\n        if (table === 'guests') {\n          return {\n            select: jest.fn().mockReturnValue({\n              eq: jest.fn().mockReturnValue({\n                not: jest.fn().mockResolvedValue({ data: mockGuests, error: null }),\n              }),\n            }),\n          };\n        } else if (table === 'transportation_manifests') {\n          return {\n            insert: jest.fn().mockReturnValue({\n              select: jest.fn().mockReturnValue({\n                single: jest.fn().mockResolvedValue({ data: mockManifest, error: null }),\n              }),\n            }),\n          };\n        }\n        // Default return for any other table\n        return {\n          select: jest.fn().mockReturnValue({\n            eq: jest.fn().mockReturnValue({\n              not: jest.fn().mockResolvedValue({ data: [], error: null }),\n            }),\n          }),\n          insert: jest.fn().mockReturnValue({\n            select: jest.fn().mockReturnValue({\n              single: jest.fn().mockResolvedValue({ data: null, error: { message: 'Unexpected table' } }),\n            }),\n          }),\n        };\n      });\n\n      const date = new Date('2025-06-01');\n      const result = await generateArrivalManifest(date, 2);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(1);\n        expect(result.data[0]).toEqual(expect.objectContaining({\n          manifest_type: 'arrival',\n          guest_ids: expect.arrayContaining(['123e4567-e89b-12d3-a456-426614174001', '123e4567-e89b-12d3-a456-426614174002']),\n        }));\n      }\n    });\n\n    it('should return empty array when no guests are arriving', async () => {\n      // Mock empty guests query\n      mockSupabase.from.mockImplementation((table: string) => {\n        if (table === 'guests') {\n          return {\n            select: jest.fn().mockReturnValue({\n              eq: jest.fn().mockReturnValue({\n                not: jest.fn().mockResolvedValue({ data: [], error: null }),\n              }),\n            }),\n          };\n        }\n        return {};\n      });\n\n      const date = new Date('2025-06-01');\n      const result = await generateArrivalManifest(date);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(0);\n      }\n    });\n\n    it('should return DATABASE_ERROR when guests query fails', async () => {\n      // Mock database error\n      mockSupabase.from.mockImplementation((table: string) => {\n        if (table === 'guests') {\n          return {\n            select: jest.fn().mockReturnValue({\n              eq: jest.fn().mockReturnValue({\n                not: jest.fn().mockResolvedValue({ data: null, error: { message: 'Connection failed' } }),\n              }),\n            }),\n          };\n        }\n        return {};\n      });\n\n      const date = new Date('2025-06-01');\n      const result = await generateArrivalManifest(date);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n  });\n\n  describe('generateDepartureManifest', () => {\n    it('should return success with manifests when guests are departing', async () => {\n      const mockGuests = [\n        {\n          id: '123e4567-e89b-12d3-a456-426614174001',\n          first_name: 'John',\n          last_name: 'Doe',\n          departure_date: '2025-06-08',\n          departure_time: '14:30:00',\n          airport_code: 'SJO',\n          flight_number: 'AA789',\n        },\n      ];\n\n      const mockManifest = {\n        id: 'manifest-1',\n        manifest_type: 'departure' as const,\n        date: '2025-06-08',\n        time_window_start: '14:00:00',\n        time_window_end: '16:00:00',\n        guest_ids: ['123e4567-e89b-12d3-a456-426614174001'],\n        created_at: '2024-01-01T00:00:00Z',\n        updated_at: '2024-01-01T00:00:00Z',\n      };\n\n      // Mock the guests query and manifest creation\n      mockSupabase.from.mockImplementation((table: string) => {\n        if (table === 'guests') {\n          return {\n            select: jest.fn().mockReturnValue({\n              eq: jest.fn().mockReturnValue({\n                not: jest.fn().mockResolvedValue({ data: mockGuests, error: null }),\n              }),\n            }),\n          };\n        } else if (table === 'transportation_manifests') {\n          return {\n            insert: jest.fn().mockReturnValue({\n              select: jest.fn().mockReturnValue({\n                single: jest.fn().mockResolvedValue({ data: mockManifest, error: null }),\n              }),\n            }),\n          };\n        }\n        // Default return for any other table\n        return {\n          select: jest.fn().mockReturnValue({\n            eq: jest.fn().mockReturnValue({\n              not: jest.fn().mockResolvedValue({ data: [], error: null }),\n            }),\n          }),\n          insert: jest.fn().mockReturnValue({\n            select: jest.fn().mockReturnValue({\n              single: jest.fn().mockResolvedValue({ data: null, error: { message: 'Unexpected table' } }),\n            }),\n          }),\n        };\n      });\n\n      const date = new Date('2025-06-08');\n      const result = await generateDepartureManifest(date, 2);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(1);\n        expect(result.data[0].manifest_type).toBe('departure');\n        expect(result.data[0].guest_ids).toContain('123e4567-e89b-12d3-a456-426614174001');\n      }\n    });\n  });\n\n  describe('assignGuestsToShuttle', () => {\n    it('should return success when guests are assigned successfully', async () => {\n      const currentManifest = {\n        guest_ids: ['guest-1'],\n      };\n\n      // Use implementation to handle different operations on same table\n      let operationCount = 0;\n      mockSupabase.from.mockImplementation((table: string) => {\n        if (table === 'transportation_manifests') {\n          operationCount++;\n          if (operationCount === 1) {\n            // First call - select\n            return {\n              select: jest.fn().mockReturnValue({\n                eq: jest.fn().mockReturnValue({\n                  single: jest.fn().mockResolvedValue({ data: currentManifest, error: null }),\n                }),\n              }),\n            };\n          } else {\n            // Second call - update\n            return {\n              update: jest.fn().mockReturnValue({\n                eq: jest.fn().mockResolvedValue({ error: null }),\n              }),\n            };\n          }\n        }\n        return {};\n      });\n\n      const result = await assignGuestsToShuttle(\n        'manifest-1',\n        ['guest-2', 'guest-3']\n      );\n\n      expect(result.success).toBe(true);\n    });\n\n    it('should prevent duplicate guest assignments', async () => {\n      const currentManifest = {\n        guest_ids: ['guest-1', 'guest-2'],\n      };\n\n      const mockUpdate = jest.fn().mockReturnValue({\n        eq: jest.fn().mockResolvedValue({ error: null }),\n      });\n\n      // Use implementation to handle different operations on same table\n      let operationCount = 0;\n      mockSupabase.from.mockImplementation((table: string) => {\n        if (table === 'transportation_manifests') {\n          operationCount++;\n          if (operationCount === 1) {\n            // First call - select\n            return {\n              select: jest.fn().mockReturnValue({\n                eq: jest.fn().mockReturnValue({\n                  single: jest.fn().mockResolvedValue({ data: currentManifest, error: null }),\n                }),\n              }),\n            };\n          } else {\n            // Second call - update\n            return {\n              update: mockUpdate,\n            };\n          }\n        }\n        return {};\n      });\n\n      const result = await assignGuestsToShuttle(\n        'manifest-1',\n        ['guest-2', 'guest-3'] // guest-2 is already assigned\n      );\n\n      expect(result.success).toBe(true);\n      expect(mockUpdate).toHaveBeenCalledWith(\n        expect.objectContaining({\n          guest_ids: ['guest-1', 'guest-2', 'guest-3'], // No duplicates\n        })\n      );\n    });\n\n    it('should return DATABASE_ERROR when manifest fetch fails', async () => {\n      // Mock database error on select\n      mockSupabase.from.mockImplementation((table: string) => {\n        if (table === 'transportation_manifests') {\n          return {\n            select: jest.fn().mockReturnValue({\n              eq: jest.fn().mockReturnValue({\n                single: jest.fn().mockResolvedValue({ data: null, error: { message: 'Manifest not found' } }),\n              }),\n            }),\n          };\n        }\n        return {};\n      });\n\n      const result = await assignGuestsToShuttle(\n        'nonexistent-manifest',\n        ['guest-1']\n      );\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n  });\n\n  describe('calculateVehicleRequirements', () => {\n    it('should return success with vehicle requirements for small group', async () => {\n      const result = await calculateVehicleRequirements(3);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(1);\n        expect(result.data[0].vehicle_type).toBe('sedan');\n        expect(result.data[0].quantity_needed).toBe(1);\n        expect(result.data[0].estimated_cost).toBe(50);\n      }\n    });\n\n    it('should return success with optimal vehicle mix for large group', async () => {\n      const result = await calculateVehicleRequirements(75);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        // Should use 1 bus (50 guests) + 1 minibus (15 guests) + 1 van (8 guests) + 1 sedan (4 guests)\n        // Total capacity: 50 + 15 + 8 + 4 = 77 (covers 75 guests)\n        const busReq = result.data.find(req => req.vehicle_type === 'bus');\n        const minibusReq = result.data.find(req => req.vehicle_type === 'minibus');\n        \n        expect(busReq).toBeDefined();\n        expect(busReq?.quantity_needed).toBe(1);\n        expect(minibusReq).toBeDefined();\n        expect(minibusReq?.quantity_needed).toBe(1);\n      }\n    });\n\n    it('should return success with empty array for zero guests', async () => {\n      const result = await calculateVehicleRequirements(0);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(0);\n      }\n    });\n\n    it('should return VALIDATION_ERROR for negative guest count', async () => {\n      const result = await calculateVehicleRequirements(-5);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n      }\n    });\n  });\n\n  describe('generateDriverSheet', () => {\n    it('should return success with driver sheet when manifest exists', async () => {\n      const mockManifest = {\n        id: 'manifest-1',\n        date: '2025-06-01',\n        time_window_start: '10:00:00',\n        time_window_end: '12:00:00',\n        manifest_type: 'arrival',\n        vehicle_type: 'van',\n        driver_name: 'Carlos Rodriguez',\n        driver_phone: '+506-1234-5678',\n        guest_ids: ['guest-1', 'guest-2'],\n      };\n\n      const mockGuests = [\n        {\n          id: 'guest-1',\n          first_name: 'John',\n          last_name: 'Doe',\n          flight_number: 'AA123',\n          phone: '+1-555-0123',\n          notes: 'Vegetarian meal',\n        },\n        {\n          id: 'guest-2',\n          first_name: 'Jane',\n          last_name: 'Smith',\n          flight_number: 'UA456',\n          phone: '+1-555-0456',\n          notes: null,\n        },\n      ];\n\n      mockSupabase.from\n        .mockReturnValueOnce({\n          select: jest.fn().mockReturnValue({\n            eq: jest.fn().mockReturnValue({\n              single: jest.fn().mockResolvedValue({ data: mockManifest, error: null }),\n            }),\n          }),\n        })\n        .mockReturnValueOnce({\n          select: jest.fn().mockReturnValue({\n            in: jest.fn().mockResolvedValue({ data: mockGuests, error: null }),\n          }),\n        });\n\n      const result = await generateDriverSheet('manifest-1');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.manifest_id).toBe('manifest-1');\n        expect(result.data.date).toBe('2025-06-01');\n        expect(result.data.time_window).toBe('10:00:00 - 12:00:00');\n        expect(result.data.driver_name).toBe('Carlos Rodriguez');\n        expect(result.data.guests).toHaveLength(2);\n        expect(result.data.guests[0].name).toBe('John Doe');\n        expect(result.data.guests[0].flight_number).toBe('AA123');\n        expect(result.data.total_guests).toBe(2);\n        expect(result.data.pickup_location).toBe('Airport');\n        expect(result.data.dropoff_locations).toEqual(['Hotel']);\n      }\n    });\n\n    it('should return DATABASE_ERROR when manifest not found', async () => {\n      mockSupabase.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            single: jest.fn().mockResolvedValue({ data: null, error: { message: 'Manifest not found' } }),\n          }),\n        }),\n      });\n\n      const result = await generateDriverSheet('nonexistent-manifest');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n  });\n\n  describe('calculateShuttleCosts', () => {\n    it('should return success with total cost for manifests', async () => {\n      const manifests = [\n        {\n          id: 'manifest-1',\n          manifest_type: 'arrival' as const,\n          date: '2025-06-01',\n          time_window_start: '10:00:00',\n          time_window_end: '12:00:00',\n          guest_ids: ['guest-1', 'guest-2', 'guest-3'], // 3 guests = 1 sedan ($50)\n          notes: undefined,\n          created_at: '2024-01-01T00:00:00Z',\n          updated_at: '2024-01-01T00:00:00Z',\n        },\n        {\n          id: 'manifest-2',\n          manifest_type: 'departure' as const,\n          date: '2025-06-08',\n          time_window_start: '14:00:00',\n          time_window_end: '16:00:00',\n          guest_ids: ['guest-4', 'guest-5'], // 2 guests = 1 sedan ($50)\n          notes: undefined,\n          created_at: '2024-01-01T00:00:00Z',\n          updated_at: '2024-01-01T00:00:00Z',\n        },\n      ];\n\n      const result = await calculateShuttleCosts(manifests);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toBe(100); // $50 + $50\n      }\n    });\n\n    it('should return success with zero cost for empty manifests', async () => {\n      const result = await calculateShuttleCosts([]);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toBe(0);\n      }\n    });\n  });\n});"],"names":["mockSupabase","createMockSupabaseClient","jest","mock","supabase","sanitizeInput","fn","input","trim","sanitizeRichText","ERROR_CODES","VALIDATION_ERROR","DATABASE_ERROR","UNKNOWN_ERROR","mockFlightInfoSafeParse","data","guest_id","airport_code","success","error","issues","mockManifestSafeParse","flightInfoSchema","safeParse","createTransportationManifestSchema","updateTransportationManifestSchema","describe","beforeEach","from","mockReset","_setSupabaseForTesting","validFlightInfo","flight_number","airline","arrival_time","departure_time","it","mockReturnValue","update","eq","mockResolvedValue","result","updateFlightInfo","expect","toBe","toHaveBeenCalledWith","invalidFlightInfo","code","message","maliciousFlightInfo","mockUpdate","objectContaining","mockGuests","id","arrival_date","departure_date","select","not","getFlightsByAirport","toHaveLength","manifestData","manifest_type","date","time_window_start","time_window_end","guest_ids","mockManifest","created_at","updated_at","insert","single","createManifest","first_name","last_name","mockImplementation","table","Date","generateArrivalManifest","toEqual","arrayContaining","generateDepartureManifest","toContain","currentManifest","operationCount","assignGuestsToShuttle","calculateVehicleRequirements","vehicle_type","quantity_needed","estimated_cost","busReq","find","req","minibusReq","toBeDefined","driver_name","driver_phone","phone","notes","mockReturnValueOnce","in","generateDriverSheet","manifest_id","time_window","guests","name","total_guests","pickup_location","dropoff_locations","manifests","undefined","calculateShuttleCosts"],"mappings":"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"}