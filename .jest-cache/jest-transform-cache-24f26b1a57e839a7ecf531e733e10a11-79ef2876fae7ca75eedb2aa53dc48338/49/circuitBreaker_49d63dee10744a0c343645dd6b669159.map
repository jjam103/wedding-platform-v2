{"version":3,"names":["CircuitBreaker","cov_2owwd350t1","f","s","getAllCircuitBreakerStats","getCircuitBreaker","resetAllCircuitBreakers","constructor","config","state","failures","successes","lastFailureTime","lastSuccessTime","nextAttemptTime","getStats","reset","execute","fn","b","now","Date","success","error","code","message","details","waitTime","result","onSuccess","onFailure","Error","successThreshold","timeout","failureThreshold","circuitBreakers","Map","serviceName","has","defaultConfig","resetTimeout","set","get","forEach","breaker","stats"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/utils/circuitBreaker.ts"],"sourcesContent":["import type { Result } from '@/types';\n\n/**\n * Circuit breaker states.\n */\nexport type CircuitState = 'closed' | 'open' | 'half-open';\n\n/**\n * Circuit breaker configuration.\n */\nexport interface CircuitBreakerConfig {\n  failureThreshold: number; // Number of failures before opening circuit\n  successThreshold: number; // Number of successes in half-open before closing\n  timeout: number; // Time in ms before attempting to close circuit\n  resetTimeout?: number; // Time in ms to reset failure count\n}\n\n/**\n * Circuit breaker statistics.\n */\nexport interface CircuitBreakerStats {\n  state: CircuitState;\n  failures: number;\n  successes: number;\n  lastFailureTime: number | null;\n  lastSuccessTime: number | null;\n  nextAttemptTime: number | null;\n}\n\n/**\n * Circuit breaker implementation for protecting external service calls.\n * \n * States:\n * - Closed: Normal operation, requests pass through\n * - Open: Too many failures, requests fail fast\n * - Half-Open: Testing if service recovered, limited requests pass through\n * \n * @example\n * const breaker = new CircuitBreaker({\n *   failureThreshold: 5,\n *   successThreshold: 2,\n *   timeout: 60000,\n * });\n * \n * const result = await breaker.execute(async () => {\n *   return await externalService.call();\n * });\n */\nexport class CircuitBreaker {\n  private state: CircuitState = 'closed';\n  private failures: number = 0;\n  private successes: number = 0;\n  private lastFailureTime: number | null = null;\n  private lastSuccessTime: number | null = null;\n  private nextAttemptTime: number | null = null;\n  private config: CircuitBreakerConfig;\n\n  constructor(config: CircuitBreakerConfig) {\n    this.config = config;\n  }\n\n  /**\n   * Gets current circuit breaker statistics.\n   */\n  public getStats(): CircuitBreakerStats {\n    return {\n      state: this.state,\n      failures: this.failures,\n      successes: this.successes,\n      lastFailureTime: this.lastFailureTime,\n      lastSuccessTime: this.lastSuccessTime,\n      nextAttemptTime: this.nextAttemptTime,\n    };\n  }\n\n  /**\n   * Resets the circuit breaker to closed state.\n   */\n  public reset(): void {\n    this.state = 'closed';\n    this.failures = 0;\n    this.successes = 0;\n    this.lastFailureTime = null;\n    this.lastSuccessTime = null;\n    this.nextAttemptTime = null;\n  }\n\n  /**\n   * Executes a function with circuit breaker protection.\n   * \n   * @param fn - Async function to execute\n   * @returns Result from the function or circuit breaker error\n   */\n  public async execute<T>(fn: () => Promise<Result<T>>): Promise<Result<T>> {\n    // Check if circuit is open\n    if (this.state === 'open') {\n      const now = Date.now();\n      \n      // Check if timeout has elapsed\n      if (this.nextAttemptTime && now < this.nextAttemptTime) {\n        return {\n          success: false,\n          error: {\n            code: 'CIRCUIT_OPEN',\n            message: 'Circuit breaker is open, request blocked',\n            details: {\n              nextAttemptTime: this.nextAttemptTime,\n              waitTime: this.nextAttemptTime - now,\n            },\n          },\n        };\n      }\n      \n      // Timeout elapsed, transition to half-open\n      this.state = 'half-open';\n      this.successes = 0;\n    }\n\n    try {\n      // Execute the function\n      const result = await fn();\n\n      if (result.success) {\n        this.onSuccess();\n      } else {\n        this.onFailure();\n      }\n\n      return result;\n    } catch (error) {\n      this.onFailure();\n      \n      return {\n        success: false,\n        error: {\n          code: 'EXECUTION_ERROR',\n          message: error instanceof Error ? error.message : 'Execution failed',\n          details: error,\n        },\n      };\n    }\n  }\n\n  /**\n   * Handles successful execution.\n   */\n  private onSuccess(): void {\n    this.lastSuccessTime = Date.now();\n    this.failures = 0;\n\n    if (this.state === 'half-open') {\n      this.successes++;\n      \n      // If enough successes in half-open, close the circuit\n      if (this.successes >= this.config.successThreshold) {\n        this.state = 'closed';\n        this.successes = 0;\n        this.nextAttemptTime = null;\n      }\n    }\n  }\n\n  /**\n   * Handles failed execution.\n   */\n  private onFailure(): void {\n    this.lastFailureTime = Date.now();\n    this.failures++;\n\n    if (this.state === 'half-open') {\n      // Any failure in half-open reopens the circuit\n      this.state = 'open';\n      this.successes = 0;\n      this.nextAttemptTime = Date.now() + this.config.timeout;\n    } else if (this.state === 'closed') {\n      // Check if failure threshold reached\n      if (this.failures >= this.config.failureThreshold) {\n        this.state = 'open';\n        this.nextAttemptTime = Date.now() + this.config.timeout;\n      }\n    }\n  }\n}\n\n/**\n * Global circuit breakers for external services.\n */\nconst circuitBreakers = new Map<string, CircuitBreaker>();\n\n/**\n * Gets or creates a circuit breaker for a service.\n * \n * @param serviceName - Name of the external service\n * @param config - Circuit breaker configuration\n * @returns Circuit breaker instance\n */\nexport function getCircuitBreaker(\n  serviceName: string,\n  config?: Partial<CircuitBreakerConfig>\n): CircuitBreaker {\n  if (!circuitBreakers.has(serviceName)) {\n    const defaultConfig: CircuitBreakerConfig = {\n      failureThreshold: 5,\n      successThreshold: 2,\n      timeout: 60000, // 1 minute\n      resetTimeout: 300000, // 5 minutes\n    };\n\n    circuitBreakers.set(\n      serviceName,\n      new CircuitBreaker({ ...defaultConfig, ...config })\n    );\n  }\n\n  return circuitBreakers.get(serviceName)!;\n}\n\n/**\n * Resets all circuit breakers.\n * Useful for testing or manual recovery.\n */\nexport function resetAllCircuitBreakers(): void {\n  circuitBreakers.forEach((breaker) => breaker.reset());\n}\n\n/**\n * Gets statistics for all circuit breakers.\n */\nexport function getAllCircuitBreakerStats(): Record<string, CircuitBreakerStats> {\n  const stats: Record<string, CircuitBreakerStats> = {};\n  \n  circuitBreakers.forEach((breaker, serviceName) => {\n    stats[serviceName] = breaker.getStats();\n  });\n  \n  return stats;\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MAgDaA,eAAA;IAAA;IAAAC,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;WAAAH,cAAA;;MAoLGI,0BAAA;IAAA;IAAAH,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;WAAAC,yBAAA;;MAhCAC,kBAAA;IAAA;IAAAJ,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;WAAAE,iBAAA;;MAyBAC,wBAAA;IAAA;IAAAL,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;WAAAG,uBAAA;;;AA7KT,MAAMN,cAAA;EASXO,YAAYC,MAA4B,EAAE;IAAA;IAAAP,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;SARlCM,KAAA,GAAsB;IAAA;IAAAR,cAAA,GAAAE,CAAA;SACtBO,QAAA,GAAmB;IAAA;IAAAT,cAAA,GAAAE,CAAA;SACnBQ,SAAA,GAAoB;IAAA;IAAAV,cAAA,GAAAE,CAAA;SACpBS,eAAA,GAAiC;IAAA;IAAAX,cAAA,GAAAE,CAAA;SACjCU,eAAA,GAAiC;IAAA;IAAAZ,cAAA,GAAAE,CAAA;SACjCW,eAAA,GAAiC;IAAA;IAAAb,cAAA,GAAAE,CAAA;IAIvC,IAAI,CAACK,MAAM,GAAGA,MAAA;EAChB;EAEA;;;EAGAO,QAAOA,CAAA,EAAgC;IAAA;IAAAd,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;IACrC,OAAO;MACLM,KAAA,EAAO,IAAI,CAACA,KAAK;MACjBC,QAAA,EAAU,IAAI,CAACA,QAAQ;MACvBC,SAAA,EAAW,IAAI,CAACA,SAAS;MACzBC,eAAA,EAAiB,IAAI,CAACA,eAAe;MACrCC,eAAA,EAAiB,IAAI,CAACA,eAAe;MACrCC,eAAA,EAAiB,IAAI,CAACA;IACxB;EACF;EAEA;;;EAGAE,KAAOA,CAAA,EAAc;IAAA;IAAAf,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;IACnB,IAAI,CAACM,KAAK,GAAG;IAAA;IAAAR,cAAA,GAAAE,CAAA;IACb,IAAI,CAACO,QAAQ,GAAG;IAAA;IAAAT,cAAA,GAAAE,CAAA;IAChB,IAAI,CAACQ,SAAS,GAAG;IAAA;IAAAV,cAAA,GAAAE,CAAA;IACjB,IAAI,CAACS,eAAe,GAAG;IAAA;IAAAX,cAAA,GAAAE,CAAA;IACvB,IAAI,CAACU,eAAe,GAAG;IAAA;IAAAZ,cAAA,GAAAE,CAAA;IACvB,IAAI,CAACW,eAAe,GAAG;EACzB;EAEA;;;;;;EAMA,MAAaG,QAAWC,EAA4B,EAAsB;IAAA;IAAAjB,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;IACxE;IACA,IAAI,IAAI,CAACM,KAAK,KAAK,QAAQ;MAAA;MAAAR,cAAA,GAAAkB,CAAA;MACzB,MAAMC,GAAA;MAAA;MAAA,CAAAnB,cAAA,GAAAE,CAAA,QAAMkB,IAAA,CAAKD,GAAG;MAEpB;MAAA;MAAAnB,cAAA,GAAAE,CAAA;MACA;MAAI;MAAA,CAAAF,cAAA,GAAAkB,CAAA,cAAI,CAACL,eAAe;MAAA;MAAA,CAAAb,cAAA,GAAAkB,CAAA,UAAIC,GAAA,GAAM,IAAI,CAACN,eAAe,GAAE;QAAA;QAAAb,cAAA,GAAAkB,CAAA;QAAAlB,cAAA,GAAAE,CAAA;QACtD,OAAO;UACLmB,OAAA,EAAS;UACTC,KAAA,EAAO;YACLC,IAAA,EAAM;YACNC,OAAA,EAAS;YACTC,OAAA,EAAS;cACPZ,eAAA,EAAiB,IAAI,CAACA,eAAe;cACrCa,QAAA,EAAU,IAAI,CAACb,eAAe,GAAGM;YACnC;UACF;QACF;MACF;MAAA;MAAA;QAAAnB,cAAA,GAAAkB,CAAA;MAAA;MAEA;MAAAlB,cAAA,GAAAE,CAAA;MACA,IAAI,CAACM,KAAK,GAAG;MAAA;MAAAR,cAAA,GAAAE,CAAA;MACb,IAAI,CAACQ,SAAS,GAAG;IACnB;IAAA;IAAA;MAAAV,cAAA,GAAAkB,CAAA;IAAA;IAAAlB,cAAA,GAAAE,CAAA;IAEA,IAAI;MACF;MACA,MAAMyB,MAAA;MAAA;MAAA,CAAA3B,cAAA,GAAAE,CAAA,QAAS,MAAMe,EAAA;MAAA;MAAAjB,cAAA,GAAAE,CAAA;MAErB,IAAIyB,MAAA,CAAON,OAAO,EAAE;QAAA;QAAArB,cAAA,GAAAkB,CAAA;QAAAlB,cAAA,GAAAE,CAAA;QAClB,IAAI,CAAC0B,SAAS;MAChB,OAAO;QAAA;QAAA5B,cAAA,GAAAkB,CAAA;QAAAlB,cAAA,GAAAE,CAAA;QACL,IAAI,CAAC2B,SAAS;MAChB;MAAA;MAAA7B,cAAA,GAAAE,CAAA;MAEA,OAAOyB,MAAA;IACT,EAAE,OAAOL,KAAA,EAAO;MAAA;MAAAtB,cAAA,GAAAE,CAAA;MACd,IAAI,CAAC2B,SAAS;MAAA;MAAA7B,cAAA,GAAAE,CAAA;MAEd,OAAO;QACLmB,OAAA,EAAS;QACTC,KAAA,EAAO;UACLC,IAAA,EAAM;UACNC,OAAA,EAASF,KAAA,YAAiBQ,KAAA;UAAA;UAAA,CAAA9B,cAAA,GAAAkB,CAAA,UAAQI,KAAA,CAAME,OAAO;UAAA;UAAA,CAAAxB,cAAA,GAAAkB,CAAA,UAAG;UAClDO,OAAA,EAASH;QACX;MACF;IACF;EACF;EAEA;;;EAGAM,SAAQA,CAAA,EAAkB;IAAA;IAAA5B,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;IACxB,IAAI,CAACU,eAAe,GAAGQ,IAAA,CAAKD,GAAG;IAAA;IAAAnB,cAAA,GAAAE,CAAA;IAC/B,IAAI,CAACO,QAAQ,GAAG;IAAA;IAAAT,cAAA,GAAAE,CAAA;IAEhB,IAAI,IAAI,CAACM,KAAK,KAAK,aAAa;MAAA;MAAAR,cAAA,GAAAkB,CAAA;MAAAlB,cAAA,GAAAE,CAAA;MAC9B,IAAI,CAACQ,SAAS;MAEd;MAAA;MAAAV,cAAA,GAAAE,CAAA;MACA,IAAI,IAAI,CAACQ,SAAS,IAAI,IAAI,CAACH,MAAM,CAACwB,gBAAgB,EAAE;QAAA;QAAA/B,cAAA,GAAAkB,CAAA;QAAAlB,cAAA,GAAAE,CAAA;QAClD,IAAI,CAACM,KAAK,GAAG;QAAA;QAAAR,cAAA,GAAAE,CAAA;QACb,IAAI,CAACQ,SAAS,GAAG;QAAA;QAAAV,cAAA,GAAAE,CAAA;QACjB,IAAI,CAACW,eAAe,GAAG;MACzB;MAAA;MAAA;QAAAb,cAAA,GAAAkB,CAAA;MAAA;IACF;IAAA;IAAA;MAAAlB,cAAA,GAAAkB,CAAA;IAAA;EACF;EAEA;;;EAGAW,SAAQA,CAAA,EAAkB;IAAA;IAAA7B,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;IACxB,IAAI,CAACS,eAAe,GAAGS,IAAA,CAAKD,GAAG;IAAA;IAAAnB,cAAA,GAAAE,CAAA;IAC/B,IAAI,CAACO,QAAQ;IAAA;IAAAT,cAAA,GAAAE,CAAA;IAEb,IAAI,IAAI,CAACM,KAAK,KAAK,aAAa;MAAA;MAAAR,cAAA,GAAAkB,CAAA;MAAAlB,cAAA,GAAAE,CAAA;MAC9B;MACA,IAAI,CAACM,KAAK,GAAG;MAAA;MAAAR,cAAA,GAAAE,CAAA;MACb,IAAI,CAACQ,SAAS,GAAG;MAAA;MAAAV,cAAA,GAAAE,CAAA;MACjB,IAAI,CAACW,eAAe,GAAGO,IAAA,CAAKD,GAAG,KAAK,IAAI,CAACZ,MAAM,CAACyB,OAAO;IACzD,OAAO;MAAA;MAAAhC,cAAA,GAAAkB,CAAA;MAAAlB,cAAA,GAAAE,CAAA;MAAA,IAAI,IAAI,CAACM,KAAK,KAAK,UAAU;QAAA;QAAAR,cAAA,GAAAkB,CAAA;QAAAlB,cAAA,GAAAE,CAAA;QAClC;QACA,IAAI,IAAI,CAACO,QAAQ,IAAI,IAAI,CAACF,MAAM,CAAC0B,gBAAgB,EAAE;UAAA;UAAAjC,cAAA,GAAAkB,CAAA;UAAAlB,cAAA,GAAAE,CAAA;UACjD,IAAI,CAACM,KAAK,GAAG;UAAA;UAAAR,cAAA,GAAAE,CAAA;UACb,IAAI,CAACW,eAAe,GAAGO,IAAA,CAAKD,GAAG,KAAK,IAAI,CAACZ,MAAM,CAACyB,OAAO;QACzD;QAAA;QAAA;UAAAhC,cAAA,GAAAkB,CAAA;QAAA;MACF;MAAA;MAAA;QAAAlB,cAAA,GAAAkB,CAAA;MAAA;IAAA;EACF;AACF;AAEA;;;AAGA,MAAMgB,eAAA;AAAA;AAAA,CAAAlC,cAAA,GAAAE,CAAA,QAAkB,IAAIiC,GAAA;AASrB,SAAS/B,kBACdgC,WAAmB,EACnB7B,MAAsC;EAAA;EAAAP,cAAA,GAAAC,CAAA;EAAAD,cAAA,GAAAE,CAAA;EAEtC,IAAI,CAACgC,eAAA,CAAgBG,GAAG,CAACD,WAAA,GAAc;IAAA;IAAApC,cAAA,GAAAkB,CAAA;IACrC,MAAMoB,aAAA;IAAA;IAAA,CAAAtC,cAAA,GAAAE,CAAA,QAAsC;MAC1C+B,gBAAA,EAAkB;MAClBF,gBAAA,EAAkB;MAClBC,OAAA,EAAS;MACTO,YAAA,EAAc;IAChB;IAAA;IAAAvC,cAAA,GAAAE,CAAA;IAEAgC,eAAA,CAAgBM,GAAG,CACjBJ,WAAA,EACA,IAAIrC,cAAA,CAAe;MAAE,GAAGuC,aAAa;MAAE,GAAG/B;IAAO;EAErD;EAAA;EAAA;IAAAP,cAAA,GAAAkB,CAAA;EAAA;EAAAlB,cAAA,GAAAE,CAAA;EAEA,OAAOgC,eAAA,CAAgBO,GAAG,CAACL,WAAA;AAC7B;AAMO,SAAS/B,wBAAA;EAAA;EAAAL,cAAA,GAAAC,CAAA;EAAAD,cAAA,GAAAE,CAAA;EACdgC,eAAA,CAAgBQ,OAAO,CAAEC,OAAA,IAAY;IAAA;IAAA3C,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;IAAA,OAAAyC,OAAA,CAAQ5B,KAAK;EAAA;AACpD;AAKO,SAASZ,0BAAA;EAAA;EAAAH,cAAA,GAAAC,CAAA;EACd,MAAM2C,KAAA;EAAA;EAAA,CAAA5C,cAAA,GAAAE,CAAA,QAA6C,CAAC;EAAA;EAAAF,cAAA,GAAAE,CAAA;EAEpDgC,eAAA,CAAgBQ,OAAO,CAAC,CAACC,OAAA,EAASP,WAAA;IAAA;IAAApC,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;IAChC0C,KAAK,CAACR,WAAA,CAAY,GAAGO,OAAA,CAAQ7B,QAAQ;EACvC;EAAA;EAAAd,cAAA,GAAAE,CAAA;EAEA,OAAO0C,KAAA;AACT","ignoreList":[]}