{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/lib/queryOptimization.ts"],"sourcesContent":["/**\n * Database Query Optimization Utilities\n * \n * Provides utilities for:\n * - Selecting only needed fields\n * - Implementing pagination (50 items per page default)\n * - Query performance monitoring\n * \n * Requirements: 20.1, 20.4\n */\n\nimport type { SupabaseClient } from '@supabase/supabase-js';\n\n/**\n * Default page size for pagination\n */\nexport const DEFAULT_PAGE_SIZE = 50;\n\n/**\n * Maximum page size to prevent performance issues\n */\nexport const MAX_PAGE_SIZE = 100;\n\n/**\n * Pagination parameters\n */\nexport interface PaginationParams {\n  page?: number;\n  pageSize?: number;\n}\n\n/**\n * Pagination result\n */\nexport interface PaginatedResult<T> {\n  data: T[];\n  pagination: {\n    page: number;\n    pageSize: number;\n    totalCount: number;\n    totalPages: number;\n    hasNextPage: boolean;\n    hasPreviousPage: boolean;\n  };\n}\n\n/**\n * Calculate pagination range for Supabase queries\n * \n * @param page - Page number (1-indexed)\n * @param pageSize - Number of items per page\n * @returns Object with from and to indices for Supabase range()\n */\nexport function calculatePaginationRange(\n  page: number = 1,\n  pageSize: number = DEFAULT_PAGE_SIZE\n): { from: number; to: number } {\n  // Validate and constrain inputs\n  const validPage = Math.max(1, page);\n  const validPageSize = Math.min(Math.max(1, pageSize), MAX_PAGE_SIZE);\n\n  const from = (validPage - 1) * validPageSize;\n  const to = from + validPageSize - 1;\n\n  return { from, to };\n}\n\n/**\n * Build paginated result object\n * \n * @param data - Query result data\n * @param totalCount - Total count from query\n * @param page - Current page number\n * @param pageSize - Items per page\n * @returns Paginated result with metadata\n */\nexport function buildPaginatedResult<T>(\n  data: T[],\n  totalCount: number,\n  page: number = 1,\n  pageSize: number = DEFAULT_PAGE_SIZE\n): PaginatedResult<T> {\n  const validPage = Math.max(1, page);\n  const validPageSize = Math.min(Math.max(1, pageSize), MAX_PAGE_SIZE);\n  const totalPages = Math.ceil(totalCount / validPageSize);\n\n  return {\n    data,\n    pagination: {\n      page: validPage,\n      pageSize: validPageSize,\n      totalCount,\n      totalPages,\n      hasNextPage: validPage < totalPages,\n      hasPreviousPage: validPage > 1,\n    },\n  };\n}\n\n/**\n * Execute paginated query with automatic range calculation\n * \n * @param query - Supabase query builder\n * @param params - Pagination parameters\n * @returns Paginated result\n */\nexport async function executePaginatedQuery<T>(\n  query: any,\n  params: PaginationParams = {}\n): Promise<PaginatedResult<T>> {\n  const { page = 1, pageSize = DEFAULT_PAGE_SIZE } = params;\n  const { from, to } = calculatePaginationRange(page, pageSize);\n\n  const { data, error, count } = await query\n    .range(from, to);\n\n  if (error) {\n    throw new Error(`Query failed: ${error.message}`);\n  }\n\n  return buildPaginatedResult(data || [], count || 0, page, pageSize);\n}\n\n/**\n * Field selection utilities\n */\n\n/**\n * Common field selections for different entities\n * Selecting only needed fields improves query performance\n */\nexport const FIELD_SELECTIONS = {\n  // Guest list view - minimal fields\n  guestList: 'id, first_name, last_name, email, age_type, guest_type, group_id',\n  \n  // Guest detail view - all fields\n  guestDetail: '*',\n  \n  // Event list view\n  eventList: 'id, slug, title, event_type, event_date, event_time, is_active, location_id',\n  \n  // Event detail view\n  eventDetail: '*',\n  \n  // Activity list view\n  activityList: 'id, slug, title, activity_type, activity_date, activity_time, capacity, cost_per_person',\n  \n  // Activity detail view\n  activityDetail: '*',\n  \n  // Content page list view\n  contentPageList: 'id, slug, title, status, created_at, updated_at',\n  \n  // Content page detail view\n  contentPageDetail: '*',\n  \n  // Location list view\n  locationList: 'id, name, address, parent_location_id',\n  \n  // Location detail view\n  locationDetail: '*',\n  \n  // Vendor list view\n  vendorList: 'id, name, category, cost, payment_status',\n  \n  // Vendor detail view\n  vendorDetail: '*',\n  \n  // Photo list view\n  photoList: 'id, photo_url, caption, moderation_status, page_type, page_id, created_at',\n  \n  // Photo detail view\n  photoDetail: '*',\n  \n  // Audit log list view\n  auditLogList: 'id, timestamp, user_id, action, entity_type, entity_id, description',\n  \n  // Audit log detail view\n  auditLogDetail: '*',\n} as const;\n\n/**\n * Query performance monitoring\n */\n\ninterface QueryMetrics {\n  queryName: string;\n  startTime: number;\n  endTime: number;\n  duration: number;\n  recordCount: number;\n}\n\nconst queryMetrics: QueryMetrics[] = [];\n\n/**\n * Start monitoring a query\n * \n * @param queryName - Name of the query for identification\n * @returns Start time\n */\nexport function startQueryMonitoring(queryName: string): number {\n  return performance.now();\n}\n\n/**\n * End monitoring a query and log metrics\n * \n * @param queryName - Name of the query\n * @param startTime - Start time from startQueryMonitoring\n * @param recordCount - Number of records returned\n */\nexport function endQueryMonitoring(\n  queryName: string,\n  startTime: number,\n  recordCount: number\n): void {\n  const endTime = performance.now();\n  const duration = endTime - startTime;\n\n  const metrics: QueryMetrics = {\n    queryName,\n    startTime,\n    endTime,\n    duration,\n    recordCount,\n  };\n\n  queryMetrics.push(metrics);\n\n  // Log slow queries (> 500ms)\n  if (duration > 500) {\n    console.warn(`Slow query detected: ${queryName} took ${duration.toFixed(2)}ms`);\n  }\n\n  // Keep only last 100 metrics\n  if (queryMetrics.length > 100) {\n    queryMetrics.shift();\n  }\n}\n\n/**\n * Get query performance metrics\n * \n * @returns Array of query metrics\n */\nexport function getQueryMetrics(): QueryMetrics[] {\n  return [...queryMetrics];\n}\n\n/**\n * Get average query duration by name\n * \n * @param queryName - Name of the query\n * @returns Average duration in milliseconds\n */\nexport function getAverageQueryDuration(queryName: string): number {\n  const relevantMetrics = queryMetrics.filter(m => m.queryName === queryName);\n  \n  if (relevantMetrics.length === 0) {\n    return 0;\n  }\n\n  const totalDuration = relevantMetrics.reduce((sum, m) => sum + m.duration, 0);\n  return totalDuration / relevantMetrics.length;\n}\n\n/**\n * Clear query metrics\n */\nexport function clearQueryMetrics(): void {\n  queryMetrics.length = 0;\n}\n\n/**\n * Index recommendations for frequently queried fields\n * \n * These indexes should be created in the database for optimal performance:\n * \n * Guests table:\n * - CREATE INDEX idx_guests_group_id ON guests(group_id);\n * - CREATE INDEX idx_guests_email ON guests(email);\n * - CREATE INDEX idx_guests_last_name ON guests(last_name);\n * \n * Events table:\n * - CREATE INDEX idx_events_slug ON events(slug);\n * - CREATE INDEX idx_events_event_date ON events(event_date);\n * - CREATE INDEX idx_events_location_id ON events(location_id);\n * - CREATE INDEX idx_events_is_active ON events(is_active);\n * \n * Activities table:\n * - CREATE INDEX idx_activities_slug ON activities(slug);\n * - CREATE INDEX idx_activities_activity_date ON activities(activity_date);\n * - CREATE INDEX idx_activities_event_id ON activities(event_id);\n * \n * Content Pages table:\n * - CREATE INDEX idx_content_pages_slug ON content_pages(slug);\n * - CREATE INDEX idx_content_pages_status ON content_pages(status);\n * \n * Sections table:\n * - CREATE INDEX idx_sections_page_type_page_id ON sections(page_type, page_id);\n * - CREATE INDEX idx_sections_display_order ON sections(display_order);\n * \n * Locations table:\n * - CREATE INDEX idx_locations_parent_location_id ON locations(parent_location_id);\n * \n * Photos table:\n * - CREATE INDEX idx_photos_moderation_status ON photos(moderation_status);\n * - CREATE INDEX idx_photos_page_type_page_id ON photos(page_type, page_id);\n * \n * Audit Logs table:\n * - CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);\n * - CREATE INDEX idx_audit_logs_entity_type ON audit_logs(entity_type);\n * - CREATE INDEX idx_audit_logs_timestamp ON audit_logs(timestamp DESC);\n * \n * RSVPs table:\n * - CREATE INDEX idx_rsvps_guest_id ON rsvps(guest_id);\n * - CREATE INDEX idx_rsvps_activity_id ON rsvps(activity_id);\n * - CREATE INDEX idx_rsvps_event_id ON rsvps(event_id);\n */\n"],"names":["DEFAULT_PAGE_SIZE","FIELD_SELECTIONS","MAX_PAGE_SIZE","buildPaginatedResult","calculatePaginationRange","clearQueryMetrics","endQueryMonitoring","executePaginatedQuery","getAverageQueryDuration","getQueryMetrics","startQueryMonitoring","page","pageSize","validPage","Math","max","validPageSize","min","from","to","data","totalCount","totalPages","ceil","pagination","hasNextPage","hasPreviousPage","query","params","error","count","range","Error","message","guestList","guestDetail","eventList","eventDetail","activityList","activityDetail","contentPageList","contentPageDetail","locationList","locationDetail","vendorList","vendorDetail","photoList","photoDetail","auditLogList","auditLogDetail","queryMetrics","queryName","performance","now","startTime","recordCount","endTime","duration","metrics","push","console","warn","toFixed","length","shift","relevantMetrics","filter","m","totalDuration","reduce","sum"],"mappings":"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"}