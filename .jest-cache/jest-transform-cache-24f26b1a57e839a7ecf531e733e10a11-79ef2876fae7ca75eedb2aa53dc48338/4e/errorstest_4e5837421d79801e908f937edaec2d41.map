{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/utils/errors.test.ts"],"sourcesContent":["import * as fc from 'fast-check';\nimport {\n  success,\n  error,\n  validationError,\n  databaseError,\n  unauthorizedError,\n  notFoundError,\n  unknownError,\n  getErrorCodeFromStatus,\n  getStatusFromErrorCode,\n} from './errors';\nimport { ERROR_CODES } from '@/types';\n\ndescribe('Error Handling Utilities', () => {\n  describe('success', () => {\n    it('should create a success Result with data', () => {\n      const data = { id: '123', name: 'Test' };\n      const result = success(data);\n      \n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toEqual(data);\n      }\n    });\n  });\n\n  describe('error', () => {\n    it('should create an error Result with code and message', () => {\n      const result = error(ERROR_CODES.VALIDATION_ERROR, 'Test error');\n      \n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.VALIDATION_ERROR);\n        expect(result.error.message).toBe('Test error');\n      }\n    });\n\n    it('should include optional details', () => {\n      const details = { field: 'email', issue: 'invalid format' };\n      const result = error(ERROR_CODES.VALIDATION_ERROR, 'Test error', details);\n      \n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.details).toEqual(details);\n      }\n    });\n  });\n\n  describe('validationError', () => {\n    it('should create a validation error with default message', () => {\n      const result = validationError();\n      \n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.VALIDATION_ERROR);\n        expect(result.error.message).toBe('Validation failed');\n      }\n    });\n\n    it('should create a validation error with custom message', () => {\n      const result = validationError('Custom validation error');\n      \n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.message).toBe('Custom validation error');\n      }\n    });\n  });\n\n  describe('HTTP status code mapping', () => {\n    it('should map error codes to correct HTTP status codes', () => {\n      expect(getStatusFromErrorCode(ERROR_CODES.VALIDATION_ERROR)).toBe(400);\n      expect(getStatusFromErrorCode(ERROR_CODES.UNAUTHORIZED)).toBe(401);\n      expect(getStatusFromErrorCode(ERROR_CODES.FORBIDDEN)).toBe(403);\n      expect(getStatusFromErrorCode(ERROR_CODES.NOT_FOUND)).toBe(404);\n      expect(getStatusFromErrorCode(ERROR_CODES.CONFLICT)).toBe(409);\n      expect(getStatusFromErrorCode(ERROR_CODES.EXTERNAL_SERVICE_ERROR)).toBe(503);\n    });\n\n    it('should map HTTP status codes to error codes', () => {\n      expect(getErrorCodeFromStatus(400)).toBe(ERROR_CODES.VALIDATION_ERROR);\n      expect(getErrorCodeFromStatus(401)).toBe(ERROR_CODES.UNAUTHORIZED);\n      expect(getErrorCodeFromStatus(403)).toBe(ERROR_CODES.FORBIDDEN);\n      expect(getErrorCodeFromStatus(404)).toBe(ERROR_CODES.NOT_FOUND);\n      expect(getErrorCodeFromStatus(409)).toBe(ERROR_CODES.CONFLICT);\n      expect(getErrorCodeFromStatus(503)).toBe(ERROR_CODES.EXTERNAL_SERVICE_ERROR);\n    });\n  });\n});\n\n/**\n * Feature: destination-wedding-platform, Property 6: XSS and Injection Prevention (partial - error handling)\n * Validates: Requirements 4.18, 18.2\n * \n * This property test ensures that error handling utilities properly handle\n * malicious input without exposing vulnerabilities or breaking the error handling flow.\n */\ndescribe('Property Test: XSS and Injection Prevention in Error Handling', () => {\n  // Arbitrary for generating malicious strings\n  const maliciousInputArbitrary = fc.oneof(\n    fc.constant('<script>alert(\"xss\")</script>'),\n    fc.constant('\"; DROP TABLE guests; --'),\n    fc.constant('<img src=x onerror=alert(1)>'),\n    fc.constant('javascript:alert(1)'),\n    fc.constant('<svg onload=alert(1)>'),\n    fc.constant(\"' OR '1'='1\"),\n    fc.constant('${alert(1)}'),\n    fc.constant('{{constructor.constructor(\"alert(1)\")()}}'),\n    fc.string().map(s => `${s}<script>alert(1)</script>`),\n    fc.string().map(s => `${s}'; DROP TABLE users; --`)\n  );\n\n  it('should safely handle malicious input in error messages', () => {\n    fc.assert(\n      fc.property(maliciousInputArbitrary, (maliciousInput) => {\n        // Create error with malicious message\n        const result = error(ERROR_CODES.VALIDATION_ERROR, maliciousInput);\n        \n        // Verify error structure is maintained\n        expect(result.success).toBe(false);\n        \n        if (!result.success) {\n          // Error message should be stored as-is (sanitization happens at display time)\n          expect(result.error.message).toBe(maliciousInput);\n          expect(result.error.code).toBe(ERROR_CODES.VALIDATION_ERROR);\n          \n          // Verify the error object is serializable (no code injection)\n          const serialized = JSON.stringify(result);\n          expect(() => JSON.parse(serialized)).not.toThrow();\n          \n          // Verify serialization produces valid JSON structure\n          const parsed = JSON.parse(serialized);\n          expect(parsed.success).toBe(false);\n          expect(parsed.error).toBeDefined();\n          expect(parsed.error.code).toBe(ERROR_CODES.VALIDATION_ERROR);\n          \n          // The message is stored as-is - sanitization should happen at display time\n          // This is correct behavior for error handling\n          expect(parsed.error.message).toBe(maliciousInput);\n        }\n      }),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should safely handle malicious input in error details', () => {\n    fc.assert(\n      fc.property(maliciousInputArbitrary, (maliciousInput) => {\n        const details = {\n          field: maliciousInput,\n          value: maliciousInput,\n          nested: { data: maliciousInput },\n        };\n        \n        const result = error(ERROR_CODES.VALIDATION_ERROR, 'Test error', details);\n        \n        expect(result.success).toBe(false);\n        \n        if (!result.success) {\n          // Details should be stored as-is\n          expect(result.error.details).toEqual(details);\n          \n          // Verify serialization safety\n          const serialized = JSON.stringify(result);\n          expect(() => JSON.parse(serialized)).not.toThrow();\n        }\n      }),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should handle all error types with malicious input', () => {\n    fc.assert(\n      fc.property(maliciousInputArbitrary, (maliciousInput) => {\n        const errorFunctions = [\n          () => validationError(maliciousInput),\n          () => databaseError(maliciousInput),\n          () => unauthorizedError(maliciousInput),\n          () => notFoundError(maliciousInput),\n        ];\n        \n        errorFunctions.forEach(fn => {\n          const result = fn();\n          expect(result.success).toBe(false);\n          \n          if (!result.success) {\n            // Verify error structure is maintained\n            expect(result.error.code).toBeDefined();\n            expect(result.error.message).toBeDefined();\n            \n            // Verify serialization safety\n            expect(() => JSON.stringify(result)).not.toThrow();\n          }\n        });\n      }),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should handle unknown errors with malicious Error objects', () => {\n    fc.assert(\n      fc.property(maliciousInputArbitrary, (maliciousInput) => {\n        const maliciousError = new Error(maliciousInput);\n        const result = unknownError(maliciousError);\n        \n        expect(result.success).toBe(false);\n        \n        if (!result.success) {\n          expect(result.error.code).toBe(ERROR_CODES.UNKNOWN_ERROR);\n          expect(result.error.message).toBe(maliciousInput);\n          \n          // Verify serialization safety\n          const serialized = JSON.stringify(result);\n          expect(() => JSON.parse(serialized)).not.toThrow();\n        }\n      }),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should maintain type safety with any input', () => {\n    fc.assert(\n      fc.property(\n        fc.anything(),\n        fc.string(),\n        (data, message) => {\n          // Success case\n          const successResult = success(data);\n          expect(successResult.success).toBe(true);\n          if (successResult.success) {\n            expect(successResult.data).toBe(data);\n          }\n          \n          // Error case\n          const errorResult = error(ERROR_CODES.VALIDATION_ERROR, message, data);\n          expect(errorResult.success).toBe(false);\n          if (!errorResult.success) {\n            expect(errorResult.error.details).toBe(data);\n          }\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n});\n"],"names":["describe","it","data","id","name","result","success","expect","toBe","toEqual","error","ERROR_CODES","VALIDATION_ERROR","code","message","details","field","issue","validationError","getStatusFromErrorCode","UNAUTHORIZED","FORBIDDEN","NOT_FOUND","CONFLICT","EXTERNAL_SERVICE_ERROR","getErrorCodeFromStatus","maliciousInputArbitrary","fc","oneof","constant","string","map","s","assert","property","maliciousInput","serialized","JSON","stringify","parse","not","toThrow","parsed","toBeDefined","numRuns","value","nested","errorFunctions","databaseError","unauthorizedError","notFoundError","forEach","fn","maliciousError","Error","unknownError","UNKNOWN_ERROR","anything","successResult","errorResult"],"mappings":"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"}