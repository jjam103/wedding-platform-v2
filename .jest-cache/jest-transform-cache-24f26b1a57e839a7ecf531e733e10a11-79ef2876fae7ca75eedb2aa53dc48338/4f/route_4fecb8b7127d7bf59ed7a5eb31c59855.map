{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/auth/create-user/route.ts"],"sourcesContent":["import { createAuthenticatedClient } from '@/lib/supabaseServer';\nimport { NextResponse } from 'next/server';\n\nexport async function POST(request: Request) {\n  try {\n    const { userId, email, role } = await request.json();\n\n    if (!userId || !email || !role) {\n      return NextResponse.json(\n        { error: 'Missing required fields' },\n        { status: 400 }\n      );\n    }\n\n    // Create Supabase client with secret key to bypass RLS\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n    const supabaseSecretKey = process.env.SUPABASE_SECRET_KEY;\n\n    if (!supabaseUrl || !supabaseSecretKey) {\n      console.error('Missing Supabase environment variables');\n      return NextResponse.json(\n        { error: 'Server configuration error' },\n        { status: 500 }\n      );\n    }\n\n    // Use secret key client to bypass RLS\n    const { createClient } = await import('@supabase/supabase-js');\n    const supabaseAdmin = createClient(supabaseUrl, supabaseSecretKey, {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    });\n\n    // Wait a moment for auth.users to be created\n    await new Promise(resolve => setTimeout(resolve, 1000));\n\n    // Verify user exists in auth.users first\n    const { data: authUser, error: authError } = await supabaseAdmin.auth.admin.getUserById(userId);\n    \n    if (authError || !authUser) {\n      console.error('User not found in auth.users:', authError);\n      // Try again after another delay\n      await new Promise(resolve => setTimeout(resolve, 2000));\n      const { data: retryAuthUser, error: retryAuthError } = await supabaseAdmin.auth.admin.getUserById(userId);\n      \n      if (retryAuthError || !retryAuthUser) {\n        return NextResponse.json(\n          { error: 'User not found in authentication system' },\n          { status: 404 }\n        );\n      }\n    }\n\n    // Insert user record\n    const { error: insertError } = await supabaseAdmin\n      .from('users')\n      .insert({\n        id: userId,\n        email: email,\n        role: role,\n      });\n\n    if (insertError) {\n      console.error('Error inserting user:', insertError);\n      return NextResponse.json(\n        { error: 'Failed to create user record', details: insertError.message },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({ success: true });\n  } catch (error) {\n    console.error('Unexpected error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["POST","request","userId","email","role","json","NextResponse","error","status","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","supabaseSecretKey","SUPABASE_SECRET_KEY","console","createClient","supabaseAdmin","auth","autoRefreshToken","persistSession","Promise","resolve","setTimeout","data","authUser","authError","admin","getUserById","retryAuthUser","retryAuthError","insertError","from","insert","id","details","message","success"],"mappings":";;;;+BAGsBA;;;eAAAA;;;wBAFO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEtB,eAAeA,KAAKC,OAAgB;IACzC,IAAI;QACF,MAAM,EAAEC,MAAM,EAAEC,KAAK,EAAEC,IAAI,EAAE,GAAG,MAAMH,QAAQI,IAAI;QAElD,IAAI,CAACH,UAAU,CAACC,SAAS,CAACC,MAAM;YAC9B,OAAOE,oBAAY,CAACD,IAAI,CACtB;gBAAEE,OAAO;YAA0B,GACnC;gBAAEC,QAAQ;YAAI;QAElB;QAEA,uDAAuD;QACvD,MAAMC,cAAcC,QAAQC,GAAG,CAACC,wBAAwB;QACxD,MAAMC,oBAAoBH,QAAQC,GAAG,CAACG,mBAAmB;QAEzD,IAAI,CAACL,eAAe,CAACI,mBAAmB;YACtCE,QAAQR,KAAK,CAAC;YACd,OAAOD,oBAAY,CAACD,IAAI,CACtB;gBAAEE,OAAO;YAA6B,GACtC;gBAAEC,QAAQ;YAAI;QAElB;QAEA,sCAAsC;QACtC,MAAM,EAAEQ,YAAY,EAAE,GAAG,MAAM,mEAAA,QAAO;QACtC,MAAMC,gBAAgBD,aAAaP,aAAaI,mBAAmB;YACjEK,MAAM;gBACJC,kBAAkB;gBAClBC,gBAAgB;YAClB;QACF;QAEA,6CAA6C;QAC7C,MAAM,IAAIC,QAAQC,CAAAA,UAAWC,WAAWD,SAAS;QAEjD,yCAAyC;QACzC,MAAM,EAAEE,MAAMC,QAAQ,EAAElB,OAAOmB,SAAS,EAAE,GAAG,MAAMT,cAAcC,IAAI,CAACS,KAAK,CAACC,WAAW,CAAC1B;QAExF,IAAIwB,aAAa,CAACD,UAAU;YAC1BV,QAAQR,KAAK,CAAC,iCAAiCmB;YAC/C,gCAAgC;YAChC,MAAM,IAAIL,QAAQC,CAAAA,UAAWC,WAAWD,SAAS;YACjD,MAAM,EAAEE,MAAMK,aAAa,EAAEtB,OAAOuB,cAAc,EAAE,GAAG,MAAMb,cAAcC,IAAI,CAACS,KAAK,CAACC,WAAW,CAAC1B;YAElG,IAAI4B,kBAAkB,CAACD,eAAe;gBACpC,OAAOvB,oBAAY,CAACD,IAAI,CACtB;oBAAEE,OAAO;gBAA0C,GACnD;oBAAEC,QAAQ;gBAAI;YAElB;QACF;QAEA,qBAAqB;QACrB,MAAM,EAAED,OAAOwB,WAAW,EAAE,GAAG,MAAMd,cAClCe,IAAI,CAAC,SACLC,MAAM,CAAC;YACNC,IAAIhC;YACJC,OAAOA;YACPC,MAAMA;QACR;QAEF,IAAI2B,aAAa;YACfhB,QAAQR,KAAK,CAAC,yBAAyBwB;YACvC,OAAOzB,oBAAY,CAACD,IAAI,CACtB;gBAAEE,OAAO;gBAAgC4B,SAASJ,YAAYK,OAAO;YAAC,GACtE;gBAAE5B,QAAQ;YAAI;QAElB;QAEA,OAAOF,oBAAY,CAACD,IAAI,CAAC;YAAEgC,SAAS;QAAK;IAC3C,EAAE,OAAO9B,OAAO;QACdQ,QAAQR,KAAK,CAAC,qBAAqBA;QACnC,OAAOD,oBAAY,CAACD,IAAI,CACtB;YAAEE,OAAO;QAAwB,GACjC;YAAEC,QAAQ;QAAI;IAElB;AACF"}