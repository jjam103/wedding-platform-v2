{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/guests/[id]/rsvps/[rsvpId]/route.ts"],"sourcesContent":["import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\nimport { z } from 'zod';\n\nconst updateRSVPSchema = z.object({\n  status: z.enum(['attending', 'declined', 'maybe', 'pending']).optional(),\n  guestCount: z.number().int().min(1).max(10).optional(),\n  dietaryRestrictions: z.string().max(500).optional(),\n});\n\n/**\n * PUT /api/admin/guests/[id]/rsvps/[rsvpId]\n * \n * Update an RSVP status, guest count, or dietary restrictions\n * \n * @param request - Next.js request object\n * @param params - Route parameters containing guest ID and RSVP ID\n * @returns Updated RSVP with capacity information\n */\nexport async function PUT(\n  request: Request,\n  { params }: { params: Promise<{ id: string; rsvpId: string }> }\n) {\n  try {\n    // 1. Auth check\n    const supabase = createRouteHandlerClient({ cookies });\n    const {\n      data: { session },\n      error: authError,\n    } = await supabase.auth.getSession();\n\n    if (authError || !session) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: { code: 'UNAUTHORIZED', message: 'Authentication required' },\n        },\n        { status: 401 }\n      );\n    }\n\n    // 2. Get params\n    const { id: guestId, rsvpId } = await params;\n\n    if (!guestId || !rsvpId) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Guest ID and RSVP ID are required',\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    // 3. Parse and validate request body\n    const body = await request.json();\n    const validation = updateRSVPSchema.safeParse(body);\n\n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid request data',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    const { status, guestCount, dietaryRestrictions } = validation.data;\n\n    // 4. Get the RSVP to determine type (activity or event)\n    // Try activity_rsvps first\n    const { data: activityRSVP, error: activityError } = await supabase\n      .from('activity_rsvps')\n      .select('*, activities(id, capacity)')\n      .eq('id', rsvpId)\n      .eq('guest_id', guestId)\n      .single();\n\n    if (!activityError && activityRSVP) {\n      // This is an activity RSVP\n      const activity = activityRSVP.activities;\n\n      // 5. Capacity validation for activities\n      if (status === 'attending' && activity?.capacity) {\n        // Count current attending RSVPs (excluding this one)\n        const { count, error: countError } = await supabase\n          .from('activity_rsvps')\n          .select('*', { count: 'exact', head: true })\n          .eq('activity_id', activity.id)\n          .eq('status', 'attending')\n          .neq('id', rsvpId);\n\n        if (countError) {\n          console.error('Error counting RSVPs:', countError);\n          return NextResponse.json(\n            {\n              success: false,\n              error: {\n                code: 'DATABASE_ERROR',\n                message: 'Failed to check capacity',\n                details: countError,\n              },\n            },\n            { status: 500 }\n          );\n        }\n\n        const capacityRemaining = activity.capacity - (count || 0);\n\n        if (capacityRemaining <= 0) {\n          return NextResponse.json(\n            {\n              success: false,\n              error: {\n                code: 'CAPACITY_EXCEEDED',\n                message: 'Activity is at full capacity',\n              },\n            },\n            { status: 409 }\n          );\n        }\n      }\n\n      // 6. Update activity RSVP\n      const updateData: any = {};\n      if (status !== undefined) updateData.status = status;\n      if (guestCount !== undefined) updateData.guest_count = guestCount;\n      if (dietaryRestrictions !== undefined)\n        updateData.dietary_restrictions = dietaryRestrictions;\n\n      const { data: updatedRSVP, error: updateError } = await supabase\n        .from('activity_rsvps')\n        .update(updateData)\n        .eq('id', rsvpId)\n        .eq('guest_id', guestId)\n        .select('*, activities(id, title, capacity)')\n        .single();\n\n      if (updateError) {\n        console.error('Error updating activity RSVP:', updateError);\n        return NextResponse.json(\n          {\n            success: false,\n            error: {\n              code: 'DATABASE_ERROR',\n              message: 'Failed to update RSVP',\n              details: updateError,\n            },\n          },\n          { status: 500 }\n        );\n      }\n\n      // 7. Calculate updated capacity\n      const { count: newCount, error: newCountError } = await supabase\n        .from('activity_rsvps')\n        .select('*', { count: 'exact', head: true })\n        .eq('activity_id', updatedRSVP.activities.id)\n        .eq('status', 'attending');\n\n      if (newCountError) {\n        console.error('Error counting RSVPs:', newCountError);\n      }\n\n      const capacityRemaining = updatedRSVP.activities.capacity\n        ? updatedRSVP.activities.capacity - (newCount || 0)\n        : undefined;\n\n      return NextResponse.json({\n        success: true,\n        data: {\n          id: updatedRSVP.id,\n          status: updatedRSVP.status,\n          guestCount: updatedRSVP.guest_count,\n          dietaryRestrictions: updatedRSVP.dietary_restrictions,\n          capacity: updatedRSVP.activities.capacity,\n          capacityRemaining,\n        },\n      });\n    }\n\n    // Try event_rsvps\n    const { data: eventRSVP, error: eventError } = await supabase\n      .from('event_rsvps')\n      .select('*')\n      .eq('id', rsvpId)\n      .eq('guest_id', guestId)\n      .single();\n\n    if (!eventError && eventRSVP) {\n      // This is an event RSVP\n      // Events don't have capacity constraints or guest counts\n\n      if (status === undefined) {\n        return NextResponse.json(\n          {\n            success: false,\n            error: {\n              code: 'VALIDATION_ERROR',\n              message: 'Status is required for event RSVPs',\n            },\n          },\n          { status: 400 }\n        );\n      }\n\n      const { data: updatedRSVP, error: updateError } = await supabase\n        .from('event_rsvps')\n        .update({ status })\n        .eq('id', rsvpId)\n        .eq('guest_id', guestId)\n        .select()\n        .single();\n\n      if (updateError) {\n        console.error('Error updating event RSVP:', updateError);\n        return NextResponse.json(\n          {\n            success: false,\n            error: {\n              code: 'DATABASE_ERROR',\n              message: 'Failed to update RSVP',\n              details: updateError,\n            },\n          },\n          { status: 500 }\n        );\n      }\n\n      return NextResponse.json({\n        success: true,\n        data: {\n          id: updatedRSVP.id,\n          status: updatedRSVP.status,\n        },\n      });\n    }\n\n    // RSVP not found\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'NOT_FOUND',\n          message: 'RSVP not found',\n        },\n      },\n      { status: 404 }\n    );\n  } catch (error) {\n    console.error('Error in PUT /api/admin/guests/[id]/rsvps/[rsvpId]:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'UNKNOWN_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error occurred',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["PUT","updateRSVPSchema","z","object","status","enum","optional","guestCount","number","int","min","max","dietaryRestrictions","string","request","params","supabase","createRouteHandlerClient","cookies","data","session","error","authError","auth","getSession","NextResponse","json","success","code","message","id","guestId","rsvpId","body","validation","safeParse","details","issues","activityRSVP","activityError","from","select","eq","single","activity","activities","capacity","count","countError","head","neq","console","capacityRemaining","updateData","undefined","guest_count","dietary_restrictions","updatedRSVP","updateError","update","newCount","newCountError","eventRSVP","eventError","Error"],"mappings":"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"}