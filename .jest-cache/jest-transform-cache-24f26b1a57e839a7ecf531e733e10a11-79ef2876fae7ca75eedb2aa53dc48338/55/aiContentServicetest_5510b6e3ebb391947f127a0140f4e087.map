{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/aiContentService.test.ts"],"sourcesContent":["import {\n  extractContentFromUrl,\n  validateExtractedContent,\n  sanitizeExtractedText,\n  sanitizeExtractedRichText,\n} from './aiContentService';\nimport { createMockSupabaseClient } from '../__tests__/helpers/mockSupabase';\n\n// Mock external dependencies\njest.mock('@google/generative-ai');\njest.mock('../utils/sanitization', () => ({\n  sanitizeInput: jest.fn((input) => {\n    if (!input || typeof input !== 'string') return '';\n    return input.replace(/<script[^>]*>.*?<\\/script>/gi, '');\n  }),\n  sanitizeRichText: jest.fn((input) => {\n    if (!input || typeof input !== 'string') return '';\n    return input.replace(/<script[^>]*>.*?<\\/script>/gi, '');\n  }),\n}));\n\n// Mock fetch globally\nglobal.fetch = jest.fn();\n\ndescribe('aiContentService', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (global.fetch as jest.Mock).mockClear();\n  });\n\n  describe('sanitizeExtractedText', () => {\n    it('should return sanitized text when valid input provided', () => {\n      const result = sanitizeExtractedText('Hello <script>alert(\"xss\")</script>World');\n      expect(result).toBe('Hello World');\n    });\n\n    it('should return empty string when input is null', () => {\n      const result = sanitizeExtractedText(null as any);\n      expect(result).toBe('');\n    });\n\n    it('should return empty string when input is undefined', () => {\n      const result = sanitizeExtractedText(undefined as any);\n      expect(result).toBe('');\n    });\n\n    it('should return empty string when input is not a string', () => {\n      const result = sanitizeExtractedText(123 as any);\n      expect(result).toBe('');\n    });\n  });\n\n  describe('sanitizeExtractedRichText', () => {\n    it('should return sanitized HTML when valid input provided', () => {\n      const result = sanitizeExtractedRichText('<p>Hello <script>alert(\"xss\")</script>World</p>');\n      expect(result).toBe('<p>Hello World</p>');\n    });\n\n    it('should return empty string when input is null', () => {\n      const result = sanitizeExtractedRichText(null as any);\n      expect(result).toBe('');\n    });\n\n    it('should return empty string when input is undefined', () => {\n      const result = sanitizeExtractedRichText(undefined as any);\n      expect(result).toBe('');\n    });\n\n    it('should return empty string when input is not a string', () => {\n      const result = sanitizeExtractedRichText(123 as any);\n      expect(result).toBe('');\n    });\n  });\n\n  describe('validateExtractedContent', () => {\n    it('should return success when valid activity data provided', () => {\n      const validActivityData = {\n        name: 'Beach Volleyball',\n        description: 'Fun beach activity',\n        activityType: 'activity',\n        startTime: '2024-01-01T10:00:00Z',\n        capacity: 20,\n        costPerPerson: 25,\n        adultsOnly: false,\n        plusOneAllowed: true,\n      };\n\n      const result = validateExtractedContent('activity', validActivityData);\n      expect(result.success).toBe(true);\n    });\n\n    it('should return VALIDATION_ERROR when invalid activity data provided', () => {\n      const invalidActivityData = {\n        name: '', // Invalid: empty name\n        activityType: 'activity',\n      };\n\n      const result = validateExtractedContent('activity', invalidActivityData);\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n      }\n    });\n\n    it('should return success when valid accommodation data provided', () => {\n      const validAccommodationData = {\n        name: 'Beach Resort',\n        description: 'Luxury beachfront resort',\n        address: '123 Beach Road, Costa Rica',\n      };\n\n      const result = validateExtractedContent('accommodation', validAccommodationData);\n      expect(result.success).toBe(true);\n    });\n\n    it('should return success when valid vendor data provided', () => {\n      const validVendorData = {\n        name: 'Costa Rica Photography',\n        category: 'photography',\n        contactName: 'John Doe',\n        email: 'john@example.com',\n        phone: '+1234567890',\n        pricingModel: 'flat_rate',\n        baseCost: 2500,\n        notes: 'Professional wedding photography',\n      };\n\n      const result = validateExtractedContent('vendor', validVendorData);\n      expect(result.success).toBe(true);\n    });\n\n    it('should return INVALID_CONTENT_TYPE when unsupported content type provided', () => {\n      const result = validateExtractedContent('invalid' as any, {});\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('INVALID_CONTENT_TYPE');\n      }\n    });\n\n    it('should return VALIDATION_ERROR when validation throws error', () => {\n      const result = validateExtractedContent('activity', null);\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n      }\n    });\n  });\n\n  describe('extractContentFromUrl', () => {\n    beforeEach(() => {\n      // Mock environment variable\n      process.env.GEMINI_API_KEY = 'test-api-key';\n    });\n\n    afterEach(() => {\n      delete process.env.GEMINI_API_KEY;\n    });\n\n    it('should return VALIDATION_ERROR when invalid URL provided', async () => {\n      const result = await extractContentFromUrl({\n        url: 'invalid-url',\n        contentType: 'activity',\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n      }\n    });\n\n    it('should return CONFIGURATION_ERROR when GEMINI_API_KEY not set', async () => {\n      delete process.env.GEMINI_API_KEY;\n\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        headers: {\n          get: jest.fn().mockReturnValue('text/html'),\n        },\n        text: jest.fn().mockResolvedValue('<html><body>Test content</body></html>'),\n      });\n\n      const result = await extractContentFromUrl({\n        url: 'https://example.com',\n        contentType: 'activity',\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('CONFIGURATION_ERROR');\n      }\n    });\n\n    it('should return FETCH_ERROR when URL fetch fails', async () => {\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: false,\n        status: 404,\n        statusText: 'Not Found',\n      });\n\n      const result = await extractContentFromUrl({\n        url: 'https://example.com',\n        contentType: 'activity',\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('FETCH_ERROR');\n      }\n    });\n\n    it('should return INVALID_CONTENT_TYPE when non-HTML content returned', async () => {\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        headers: {\n          get: jest.fn().mockReturnValue('application/json'),\n        },\n      });\n\n      const result = await extractContentFromUrl({\n        url: 'https://example.com',\n        contentType: 'activity',\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('INVALID_CONTENT_TYPE');\n      }\n    });\n\n    it('should return CONTENT_TOO_LARGE when content exceeds 1MB', async () => {\n      const largeContent = 'x'.repeat(1024 * 1024 + 1); // 1MB + 1 byte\n\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        headers: {\n          get: jest.fn().mockReturnValue('text/html'),\n        },\n        text: jest.fn().mockResolvedValue(largeContent),\n      });\n\n      const result = await extractContentFromUrl({\n        url: 'https://example.com',\n        contentType: 'activity',\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('CONTENT_TOO_LARGE');\n      }\n    });\n\n    it('should return TIMEOUT when fetch times out', async () => {\n      (global.fetch as jest.Mock).mockImplementationOnce(() => {\n        return new Promise((_, reject) => {\n          setTimeout(() => {\n            const error = new Error('Request timed out');\n            error.name = 'AbortError';\n            reject(error);\n          }, 100);\n        });\n      });\n\n      const result = await extractContentFromUrl({\n        url: 'https://example.com',\n        contentType: 'activity',\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('TIMEOUT');\n      }\n    });\n\n    it('should return EXTERNAL_SERVICE_ERROR when AI service fails', async () => {\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        headers: {\n          get: jest.fn().mockReturnValue('text/html'),\n        },\n        text: jest.fn().mockResolvedValue('<html><body>Test content</body></html>'),\n      });\n\n      // Mock GoogleGenerativeAI to throw error\n      const { GoogleGenerativeAI } = require('@google/generative-ai');\n      GoogleGenerativeAI.mockImplementation(() => ({\n        getGenerativeModel: () => ({\n          generateContent: () => {\n            throw new Error('AI service error');\n          },\n        }),\n      }));\n\n      const result = await extractContentFromUrl({\n        url: 'https://example.com',\n        contentType: 'activity',\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('EXTERNAL_SERVICE_ERROR');\n      }\n    });\n  });\n});"],"names":["jest","mock","sanitizeInput","fn","input","replace","sanitizeRichText","global","fetch","describe","beforeEach","clearAllMocks","mockClear","it","result","sanitizeExtractedText","expect","toBe","undefined","sanitizeExtractedRichText","validActivityData","name","description","activityType","startTime","capacity","costPerPerson","adultsOnly","plusOneAllowed","validateExtractedContent","success","invalidActivityData","error","code","validAccommodationData","address","validVendorData","category","contactName","email","phone","pricingModel","baseCost","notes","process","env","GEMINI_API_KEY","afterEach","extractContentFromUrl","url","contentType","mockResolvedValueOnce","ok","headers","get","mockReturnValue","text","mockResolvedValue","status","statusText","largeContent","repeat","mockImplementationOnce","Promise","_","reject","setTimeout","Error","GoogleGenerativeAI","require","mockImplementation","getGenerativeModel","generateContent"],"mappings":"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"}