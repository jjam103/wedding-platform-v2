{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/contentPagesService.cascadeSoftDelete.property.test.ts"],"sourcesContent":["/**\n * Property-Based Test: Content Page Cascade Soft Deletion\n * Feature: guest-portal-and-admin-enhancements\n * Property 30: Content Page Cascade Deletion\n * \n * Validates: Requirements 29.1, 29.2\n * \n * Property: When a content page is soft deleted, all associated sections and columns\n * must also be soft deleted with the same timestamp.\n */\n\nimport * as fc from 'fast-check';\nimport { deleteContentPage, restoreContentPage, createContentPage } from './contentPagesService';\nimport { createSection } from './sectionsService';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ndescribe('Feature: guest-portal-and-admin-enhancements, Property 30: Content Page Cascade Deletion', () => {\n  beforeEach(async () => {\n    // Clean up test data\n    await supabase.from('columns').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('sections').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  afterAll(async () => {\n    // Final cleanup\n    await supabase.from('columns').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('sections').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  it('should soft delete all sections and columns when content page is soft deleted', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.record({\n          pageTitle: fc.string({ minLength: 1, maxLength: 100 }),\n          sectionCount: fc.integer({ min: 1, max: 5 }),\n        }),\n        async ({ pageTitle, sectionCount }) => {\n          // Create content page\n          const pageResult = await createContentPage({\n            title: pageTitle,\n            status: 'draft',\n          });\n\n          if (!pageResult.success) {\n            throw new Error('Failed to create content page');\n          }\n\n          const pageId = pageResult.data.id;\n\n          // Create sections\n          const sectionIds: string[] = [];\n          for (let i = 0; i < sectionCount; i++) {\n            const sectionResult = await createSection({\n              page_type: 'custom',\n              page_id: pageId,\n              title: `Section ${i}`,\n              display_order: i,\n            });\n\n            if (sectionResult.success) {\n              sectionIds.push(sectionResult.data.id);\n            }\n          }\n\n          // Soft delete content page\n          const deleteResult = await deleteContentPage(pageId, { permanent: false });\n          expect(deleteResult.success).toBe(true);\n\n          // Verify content page is soft deleted\n          const { data: page } = await supabase\n            .from('content_pages')\n            .select('deleted_at')\n            .eq('id', pageId)\n            .single();\n\n          expect(page?.deleted_at).not.toBeNull();\n\n          // Verify all sections are soft deleted\n          const { data: sections } = await supabase\n            .from('sections')\n            .select('id, deleted_at')\n            .eq('page_type', 'custom')\n            .eq('page_id', pageId);\n\n          expect(sections).toHaveLength(sectionIds.length);\n          sections?.forEach((section) => {\n            expect(section.deleted_at).not.toBeNull();\n          });\n\n          // Verify all columns are soft deleted\n          if (sectionIds.length > 0) {\n            const { data: columns } = await supabase\n              .from('columns')\n              .select('id, deleted_at')\n              .in('section_id', sectionIds);\n\n            columns?.forEach((column) => {\n              expect(column.deleted_at).not.toBeNull();\n            });\n          }\n\n          // Cleanup\n          await deleteContentPage(pageId, { permanent: true });\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should restore all sections and columns when content page is restored', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.record({\n          pageTitle: fc.string({ minLength: 1, maxLength: 100 }),\n          sectionCount: fc.integer({ min: 1, max: 3 }),\n        }),\n        async ({ pageTitle, sectionCount }) => {\n          // Create content page\n          const pageResult = await createContentPage({\n            title: pageTitle,\n            status: 'draft',\n          });\n\n          if (!pageResult.success) {\n            throw new Error('Failed to create content page');\n          }\n\n          const pageId = pageResult.data.id;\n\n          // Create sections\n          const sectionIds: string[] = [];\n          for (let i = 0; i < sectionCount; i++) {\n            const sectionResult = await createSection({\n              page_type: 'custom',\n              page_id: pageId,\n              title: `Section ${i}`,\n              display_order: i,\n            });\n\n            if (sectionResult.success) {\n              sectionIds.push(sectionResult.data.id);\n            }\n          }\n\n          // Soft delete content page\n          await deleteContentPage(pageId, { permanent: false });\n\n          // Restore content page\n          const restoreResult = await restoreContentPage(pageId);\n          expect(restoreResult.success).toBe(true);\n\n          // Verify content page is restored\n          const { data: page } = await supabase\n            .from('content_pages')\n            .select('deleted_at')\n            .eq('id', pageId)\n            .single();\n\n          expect(page?.deleted_at).toBeNull();\n\n          // Verify all sections are restored\n          const { data: sections } = await supabase\n            .from('sections')\n            .select('id, deleted_at')\n            .eq('page_type', 'custom')\n            .eq('page_id', pageId);\n\n          expect(sections).toHaveLength(sectionIds.length);\n          sections?.forEach((section) => {\n            expect(section.deleted_at).toBeNull();\n          });\n\n          // Verify all columns are restored\n          if (sectionIds.length > 0) {\n            const { data: columns } = await supabase\n              .from('columns')\n              .select('id, deleted_at')\n              .in('section_id', sectionIds);\n\n            columns?.forEach((column) => {\n              expect(column.deleted_at).toBeNull();\n            });\n          }\n\n          // Cleanup\n          await deleteContentPage(pageId, { permanent: true });\n        }\n      ),\n      { numRuns: 50 }\n    );\n  });\n});\n"],"names":["supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","describe","beforeEach","from","delete","neq","afterAll","it","fc","assert","asyncProperty","record","pageTitle","string","minLength","maxLength","sectionCount","integer","min","max","pageResult","createContentPage","title","status","success","Error","pageId","data","id","sectionIds","i","sectionResult","createSection","page_type","page_id","display_order","push","deleteResult","deleteContentPage","permanent","expect","toBe","page","select","eq","single","deleted_at","not","toBeNull","sections","toHaveLength","length","forEach","section","columns","in","column","numRuns","restoreResult","restoreContentPage"],"mappings":"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"}