{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/regression/photoStorage.regression.test.ts"],"sourcesContent":["/**\n * Regression Test Suite: Photo Storage Failover\n * \n * Tests photo storage failover mechanisms to prevent regressions in:\n * - B2 storage health checks\n * - Automatic failover to Supabase\n * - URL consistency\n * - Storage type tracking\n * - Fallback recovery\n * \n * Requirements: 21.4\n */\n\n// Mock environment variables before any imports\nprocess.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';\nprocess.env.SUPABASE_SERVICE_ROLE_KEY = 'test-service-role-key';\nprocess.env.B2_ENDPOINT = 'https://s3.us-west-002.backblazeb2.com';\nprocess.env.B2_REGION = 'us-west-002';\nprocess.env.B2_BUCKET = 'test-bucket';\nprocess.env.B2_ACCESS_KEY_ID = 'test-access-key';\nprocess.env.B2_SECRET_ACCESS_KEY = 'test-secret-key';\nprocess.env.CLOUDFLARE_CDN_URL = 'https://cdn.example.com';\n\n// Mock Supabase client\njest.mock('@supabase/supabase-js', () => ({\n  createClient: jest.fn(() => ({\n    from: jest.fn().mockReturnThis(),\n    select: jest.fn().mockReturnThis(),\n    insert: jest.fn().mockReturnThis(),\n    update: jest.fn().mockReturnThis(),\n    eq: jest.fn().mockReturnThis(),\n    single: jest.fn(),\n    storage: {\n      from: jest.fn().mockReturnThis(),\n      upload: jest.fn(),\n      getPublicUrl: jest.fn(),\n    },\n  })),\n}));\n\n// Mock B2 service\njest.mock('@/services/b2Service', () => ({\n  b2Service: {\n    checkHealth: jest.fn(),\n    upload: jest.fn(),\n    getPublicUrl: jest.fn(),\n  },\n}));\n\n// Now import services after mocks are set up\nimport { photoService } from '@/services/photoService';\nimport { b2Service } from '@/services/b2Service';\n\ndescribe('Regression: Photo Storage Failover', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n  });\n\n  describe('B2 Storage Health Checks', () => {\n    it('should detect healthy B2 storage', async () => {\n      (b2Service.checkHealth as jest.Mock).mockResolvedValue({\n        success: true,\n        data: { healthy: true, responseTime: 150 },\n      });\n\n      const result = await b2Service.checkHealth();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.healthy).toBe(true);\n      }\n    });\n\n    it('should detect unhealthy B2 storage', async () => {\n      (b2Service.checkHealth as jest.Mock).mockResolvedValue({\n        success: false,\n        error: { code: 'STORAGE_UNAVAILABLE', message: 'Connection timeout' },\n      });\n\n      const result = await b2Service.checkHealth();\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('STORAGE_UNAVAILABLE');\n      }\n    });\n\n    it('should handle network timeouts', async () => {\n      (b2Service.checkHealth as jest.Mock).mockRejectedValue(\n        new Error('Network timeout')\n      );\n\n      try {\n        await b2Service.checkHealth();\n      } catch (error) {\n        expect(error).toBeDefined();\n      }\n    });\n  });\n\n  describe('Automatic Failover to Supabase', () => {\n    it('should use B2 when healthy', async () => {\n      (b2Service.checkHealth as jest.Mock).mockResolvedValue({\n        success: true,\n        data: { healthy: true },\n      });\n\n      (b2Service.upload as jest.Mock).mockResolvedValue({\n        success: true,\n        data: {\n          url: 'https://cdn.example.com/photo.jpg',\n          storageType: 'b2',\n        },\n      });\n\n      mockSupabase.single.mockResolvedValue({\n        data: {\n          id: 'photo-1',\n          photoUrl: 'https://cdn.example.com/photo.jpg',\n          storageType: 'b2',\n        },\n        error: null,\n      });\n\n      const mockFile = new File(['photo'], 'photo.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result = await photoService.upload(mockFile, 'user-1', {\n        pageType: 'memory',\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.storageType).toBe('b2');\n        expect(result.data.photoUrl).toContain('cdn.example.com');\n      }\n    });\n\n    it('should failover to Supabase when B2 unhealthy', async () => {\n      (b2Service.checkHealth as jest.Mock).mockResolvedValue({\n        success: false,\n        error: { code: 'STORAGE_UNAVAILABLE', message: 'B2 down' },\n      });\n\n      mockSupabase.storage.upload.mockResolvedValue({\n        data: { path: 'photos/photo.jpg' },\n        error: null,\n      });\n\n      mockSupabase.storage.getPublicUrl.mockReturnValue({\n        data: { publicUrl: 'https://supabase.co/storage/photos/photo.jpg' },\n      });\n\n      mockSupabase.single.mockResolvedValue({\n        data: {\n          id: 'photo-1',\n          photoUrl: 'https://supabase.co/storage/photos/photo.jpg',\n          storageType: 'supabase',\n        },\n        error: null,\n      });\n\n      const mockFile = new File(['photo'], 'photo.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result = await photoService.upload(mockFile, 'user-1', {\n        pageType: 'memory',\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.storageType).toBe('supabase');\n        expect(result.data.photoUrl).toContain('supabase.co');\n      }\n    });\n\n    it('should retry B2 upload on transient failure', async () => {\n      (b2Service.checkHealth as jest.Mock).mockResolvedValue({\n        success: true,\n        data: { healthy: true },\n      });\n\n      (b2Service.upload as jest.Mock)\n        .mockResolvedValueOnce({\n          success: false,\n          error: { code: 'NETWORK_ERROR', message: 'Temporary failure' },\n        })\n        .mockResolvedValueOnce({\n          success: true,\n          data: {\n            url: 'https://cdn.example.com/photo.jpg',\n            storageType: 'b2',\n          },\n        });\n\n      mockSupabase.single.mockResolvedValue({\n        data: {\n          id: 'photo-1',\n          photoUrl: 'https://cdn.example.com/photo.jpg',\n          storageType: 'b2',\n        },\n        error: null,\n      });\n\n      const mockFile = new File(['photo'], 'photo.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result = await photoService.upload(mockFile, 'user-1', {\n        pageType: 'memory',\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.storageType).toBe('b2');\n      }\n    });\n  });\n\n  describe('URL Consistency', () => {\n    it('should use CDN URL for B2 storage', async () => {\n      (b2Service.checkHealth as jest.Mock).mockResolvedValue({\n        success: true,\n        data: { healthy: true },\n      });\n\n      (b2Service.upload as jest.Mock).mockResolvedValue({\n        success: true,\n        data: {\n          url: 'https://cdn.cloudflare.com/photo.jpg',\n          storageType: 'b2',\n        },\n      });\n\n      mockSupabase.single.mockResolvedValue({\n        data: {\n          id: 'photo-1',\n          photoUrl: 'https://cdn.cloudflare.com/photo.jpg',\n          storageType: 'b2',\n        },\n        error: null,\n      });\n\n      const mockFile = new File(['photo'], 'photo.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result = await photoService.upload(mockFile, 'user-1', {\n        pageType: 'memory',\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.photoUrl).toMatch(/^https:\\/\\/cdn\\./);\n      }\n    });\n\n    it('should use Supabase URL for Supabase storage', async () => {\n      (b2Service.checkHealth as jest.Mock).mockResolvedValue({\n        success: false,\n        error: { code: 'STORAGE_UNAVAILABLE', message: 'B2 down' },\n      });\n\n      mockSupabase.storage.upload.mockResolvedValue({\n        data: { path: 'photos/photo.jpg' },\n        error: null,\n      });\n\n      mockSupabase.storage.getPublicUrl.mockReturnValue({\n        data: { publicUrl: 'https://project.supabase.co/storage/photos/photo.jpg' },\n      });\n\n      mockSupabase.single.mockResolvedValue({\n        data: {\n          id: 'photo-1',\n          photoUrl: 'https://project.supabase.co/storage/photos/photo.jpg',\n          storageType: 'supabase',\n        },\n        error: null,\n      });\n\n      const mockFile = new File(['photo'], 'photo.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result = await photoService.upload(mockFile, 'user-1', {\n        pageType: 'memory',\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.photoUrl).toContain('supabase.co');\n      }\n    });\n  });\n\n  describe('Storage Type Tracking', () => {\n    it('should track B2 storage type in database', async () => {\n      (b2Service.checkHealth as jest.Mock).mockResolvedValue({\n        success: true,\n        data: { healthy: true },\n      });\n\n      (b2Service.upload as jest.Mock).mockResolvedValue({\n        success: true,\n        data: {\n          url: 'https://cdn.example.com/photo.jpg',\n          storageType: 'b2',\n        },\n      });\n\n      mockSupabase.single.mockResolvedValue({\n        data: {\n          id: 'photo-1',\n          storageType: 'b2',\n        },\n        error: null,\n      });\n\n      const mockFile = new File(['photo'], 'photo.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result = await photoService.upload(mockFile, 'user-1', {\n        pageType: 'memory',\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.storageType).toBe('b2');\n      }\n    });\n\n    it('should track Supabase storage type in database', async () => {\n      (b2Service.checkHealth as jest.Mock).mockResolvedValue({\n        success: false,\n        error: { code: 'STORAGE_UNAVAILABLE', message: 'B2 down' },\n      });\n\n      mockSupabase.storage.upload.mockResolvedValue({\n        data: { path: 'photos/photo.jpg' },\n        error: null,\n      });\n\n      mockSupabase.storage.getPublicUrl.mockReturnValue({\n        data: { publicUrl: 'https://supabase.co/storage/photos/photo.jpg' },\n      });\n\n      mockSupabase.single.mockResolvedValue({\n        data: {\n          id: 'photo-1',\n          storageType: 'supabase',\n        },\n        error: null,\n      });\n\n      const mockFile = new File(['photo'], 'photo.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result = await photoService.upload(mockFile, 'user-1', {\n        pageType: 'memory',\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.storageType).toBe('supabase');\n      }\n    });\n  });\n\n  describe('Fallback Recovery', () => {\n    it('should recover to B2 when it becomes healthy again', async () => {\n      // First upload: B2 unhealthy, use Supabase\n      (b2Service.checkHealth as jest.Mock).mockResolvedValueOnce({\n        success: false,\n        error: { code: 'STORAGE_UNAVAILABLE', message: 'B2 down' },\n      });\n\n      mockSupabase.storage.upload.mockResolvedValue({\n        data: { path: 'photos/photo1.jpg' },\n        error: null,\n      });\n\n      mockSupabase.storage.getPublicUrl.mockReturnValue({\n        data: { publicUrl: 'https://supabase.co/storage/photos/photo1.jpg' },\n      });\n\n      mockSupabase.single.mockResolvedValueOnce({\n        data: {\n          id: 'photo-1',\n          storageType: 'supabase',\n        },\n        error: null,\n      });\n\n      const mockFile1 = new File(['photo1'], 'photo1.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result1 = await photoService.upload(mockFile1, 'user-1', {\n        pageType: 'memory',\n      });\n\n      expect(result1.success && result1.data.storageType).toBe('supabase');\n\n      // Second upload: B2 healthy again, use B2\n      (b2Service.checkHealth as jest.Mock).mockResolvedValueOnce({\n        success: true,\n        data: { healthy: true },\n      });\n\n      (b2Service.upload as jest.Mock).mockResolvedValue({\n        success: true,\n        data: {\n          url: 'https://cdn.example.com/photo2.jpg',\n          storageType: 'b2',\n        },\n      });\n\n      mockSupabase.single.mockResolvedValueOnce({\n        data: {\n          id: 'photo-2',\n          storageType: 'b2',\n        },\n        error: null,\n      });\n\n      const mockFile2 = new File(['photo2'], 'photo2.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result2 = await photoService.upload(mockFile2, 'user-1', {\n        pageType: 'memory',\n      });\n\n      expect(result2.success && result2.data.storageType).toBe('b2');\n    });\n  });\n\n  describe('Error Handling', () => {\n    it('should handle both storage systems failing', async () => {\n      (b2Service.checkHealth as jest.Mock).mockResolvedValue({\n        success: false,\n        error: { code: 'STORAGE_UNAVAILABLE', message: 'B2 down' },\n      });\n\n      mockSupabase.storage.upload.mockResolvedValue({\n        data: null,\n        error: { message: 'Supabase storage unavailable' },\n      });\n\n      const mockFile = new File(['photo'], 'photo.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result = await photoService.upload(mockFile, 'user-1', {\n        pageType: 'memory',\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('STORAGE_UNAVAILABLE');\n      }\n    });\n  });\n});\n"],"names":["jest","mock","createClient","fn","from","mockReturnThis","select","insert","update","eq","single","storage","upload","getPublicUrl","b2Service","checkHealth","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","B2_ENDPOINT","B2_REGION","B2_BUCKET","B2_ACCESS_KEY_ID","B2_SECRET_ACCESS_KEY","CLOUDFLARE_CDN_URL","describe","beforeEach","clearAllMocks","it","mockResolvedValue","success","data","healthy","responseTime","result","expect","toBe","error","code","message","mockRejectedValue","Error","toBeDefined","url","storageType","mockSupabase","id","photoUrl","mockFile","File","type","photoService","pageType","toContain","path","mockReturnValue","publicUrl","mockResolvedValueOnce","toMatch","mockFile1","result1","mockFile2","result2"],"mappings":";AAuBA,uBAAuB;AACvBA,KAAKC,IAAI,CAAC,yBAAyB,IAAO,CAAA;QACxCC,cAAcF,KAAKG,EAAE,CAAC,IAAO,CAAA;gBAC3BC,MAAMJ,KAAKG,EAAE,GAAGE,cAAc;gBAC9BC,QAAQN,KAAKG,EAAE,GAAGE,cAAc;gBAChCE,QAAQP,KAAKG,EAAE,GAAGE,cAAc;gBAChCG,QAAQR,KAAKG,EAAE,GAAGE,cAAc;gBAChCI,IAAIT,KAAKG,EAAE,GAAGE,cAAc;gBAC5BK,QAAQV,KAAKG,EAAE;gBACfQ,SAAS;oBACPP,MAAMJ,KAAKG,EAAE,GAAGE,cAAc;oBAC9BO,QAAQZ,KAAKG,EAAE;oBACfU,cAAcb,KAAKG,EAAE;gBACvB;YACF,CAAA;IACF,CAAA;AAEA,kBAAkB;AAClBH,KAAKC,IAAI,CAAC,wBAAwB,IAAO,CAAA;QACvCa,WAAW;YACTC,aAAaf,KAAKG,EAAE;YACpBS,QAAQZ,KAAKG,EAAE;YACfU,cAAcb,KAAKG,EAAE;QACvB;IACF,CAAA;;;;8BAG6B;2BACH;AAnD1B;;;;;;;;;;;CAWC,GAED,gDAAgD;AAChDa,QAAQC,GAAG,CAACC,wBAAwB,GAAG;AACvCF,QAAQC,GAAG,CAACE,yBAAyB,GAAG;AACxCH,QAAQC,GAAG,CAACG,WAAW,GAAG;AAC1BJ,QAAQC,GAAG,CAACI,SAAS,GAAG;AACxBL,QAAQC,GAAG,CAACK,SAAS,GAAG;AACxBN,QAAQC,GAAG,CAACM,gBAAgB,GAAG;AAC/BP,QAAQC,GAAG,CAACO,oBAAoB,GAAG;AACnCR,QAAQC,GAAG,CAACQ,kBAAkB,GAAG;AAgCjCC,SAAS,sCAAsC;IAC7CC,WAAW;QACT3B,KAAK4B,aAAa;IACpB;IAEAF,SAAS,4BAA4B;QACnCG,GAAG,oCAAoC;YACpCf,oBAAS,CAACC,WAAW,CAAee,iBAAiB,CAAC;gBACrDC,SAAS;gBACTC,MAAM;oBAAEC,SAAS;oBAAMC,cAAc;gBAAI;YAC3C;YAEA,MAAMC,SAAS,MAAMrB,oBAAS,CAACC,WAAW;YAE1CqB,OAAOD,OAAOJ,OAAO,EAAEM,IAAI,CAAC;YAC5B,IAAIF,OAAOJ,OAAO,EAAE;gBAClBK,OAAOD,OAAOH,IAAI,CAACC,OAAO,EAAEI,IAAI,CAAC;YACnC;QACF;QAEAR,GAAG,sCAAsC;YACtCf,oBAAS,CAACC,WAAW,CAAee,iBAAiB,CAAC;gBACrDC,SAAS;gBACTO,OAAO;oBAAEC,MAAM;oBAAuBC,SAAS;gBAAqB;YACtE;YAEA,MAAML,SAAS,MAAMrB,oBAAS,CAACC,WAAW;YAE1CqB,OAAOD,OAAOJ,OAAO,EAAEM,IAAI,CAAC;YAC5B,IAAI,CAACF,OAAOJ,OAAO,EAAE;gBACnBK,OAAOD,OAAOG,KAAK,CAACC,IAAI,EAAEF,IAAI,CAAC;YACjC;QACF;QAEAR,GAAG,kCAAkC;YAClCf,oBAAS,CAACC,WAAW,CAAe0B,iBAAiB,CACpD,IAAIC,MAAM;YAGZ,IAAI;gBACF,MAAM5B,oBAAS,CAACC,WAAW;YAC7B,EAAE,OAAOuB,OAAO;gBACdF,OAAOE,OAAOK,WAAW;YAC3B;QACF;IACF;IAEAjB,SAAS,kCAAkC;QACzCG,GAAG,8BAA8B;YAC9Bf,oBAAS,CAACC,WAAW,CAAee,iBAAiB,CAAC;gBACrDC,SAAS;gBACTC,MAAM;oBAAEC,SAAS;gBAAK;YACxB;YAECnB,oBAAS,CAACF,MAAM,CAAekB,iBAAiB,CAAC;gBAChDC,SAAS;gBACTC,MAAM;oBACJY,KAAK;oBACLC,aAAa;gBACf;YACF;YAEAC,aAAapC,MAAM,CAACoB,iBAAiB,CAAC;gBACpCE,MAAM;oBACJe,IAAI;oBACJC,UAAU;oBACVH,aAAa;gBACf;gBACAP,OAAO;YACT;YAEA,MAAMW,WAAW,IAAIC,KAAK;gBAAC;aAAQ,EAAE,aAAa;gBAChDC,MAAM;YACR;YAEA,MAAMhB,SAAS,MAAMiB,0BAAY,CAACxC,MAAM,CAACqC,UAAU,UAAU;gBAC3DI,UAAU;YACZ;YAEAjB,OAAOD,OAAOJ,OAAO,EAAEM,IAAI,CAAC;YAC5B,IAAIF,OAAOJ,OAAO,EAAE;gBAClBK,OAAOD,OAAOH,IAAI,CAACa,WAAW,EAAER,IAAI,CAAC;gBACrCD,OAAOD,OAAOH,IAAI,CAACgB,QAAQ,EAAEM,SAAS,CAAC;YACzC;QACF;QAEAzB,GAAG,iDAAiD;YACjDf,oBAAS,CAACC,WAAW,CAAee,iBAAiB,CAAC;gBACrDC,SAAS;gBACTO,OAAO;oBAAEC,MAAM;oBAAuBC,SAAS;gBAAU;YAC3D;YAEAM,aAAanC,OAAO,CAACC,MAAM,CAACkB,iBAAiB,CAAC;gBAC5CE,MAAM;oBAAEuB,MAAM;gBAAmB;gBACjCjB,OAAO;YACT;YAEAQ,aAAanC,OAAO,CAACE,YAAY,CAAC2C,eAAe,CAAC;gBAChDxB,MAAM;oBAAEyB,WAAW;gBAA+C;YACpE;YAEAX,aAAapC,MAAM,CAACoB,iBAAiB,CAAC;gBACpCE,MAAM;oBACJe,IAAI;oBACJC,UAAU;oBACVH,aAAa;gBACf;gBACAP,OAAO;YACT;YAEA,MAAMW,WAAW,IAAIC,KAAK;gBAAC;aAAQ,EAAE,aAAa;gBAChDC,MAAM;YACR;YAEA,MAAMhB,SAAS,MAAMiB,0BAAY,CAACxC,MAAM,CAACqC,UAAU,UAAU;gBAC3DI,UAAU;YACZ;YAEAjB,OAAOD,OAAOJ,OAAO,EAAEM,IAAI,CAAC;YAC5B,IAAIF,OAAOJ,OAAO,EAAE;gBAClBK,OAAOD,OAAOH,IAAI,CAACa,WAAW,EAAER,IAAI,CAAC;gBACrCD,OAAOD,OAAOH,IAAI,CAACgB,QAAQ,EAAEM,SAAS,CAAC;YACzC;QACF;QAEAzB,GAAG,+CAA+C;YAC/Cf,oBAAS,CAACC,WAAW,CAAee,iBAAiB,CAAC;gBACrDC,SAAS;gBACTC,MAAM;oBAAEC,SAAS;gBAAK;YACxB;YAECnB,oBAAS,CAACF,MAAM,CACd8C,qBAAqB,CAAC;gBACrB3B,SAAS;gBACTO,OAAO;oBAAEC,MAAM;oBAAiBC,SAAS;gBAAoB;YAC/D,GACCkB,qBAAqB,CAAC;gBACrB3B,SAAS;gBACTC,MAAM;oBACJY,KAAK;oBACLC,aAAa;gBACf;YACF;YAEFC,aAAapC,MAAM,CAACoB,iBAAiB,CAAC;gBACpCE,MAAM;oBACJe,IAAI;oBACJC,UAAU;oBACVH,aAAa;gBACf;gBACAP,OAAO;YACT;YAEA,MAAMW,WAAW,IAAIC,KAAK;gBAAC;aAAQ,EAAE,aAAa;gBAChDC,MAAM;YACR;YAEA,MAAMhB,SAAS,MAAMiB,0BAAY,CAACxC,MAAM,CAACqC,UAAU,UAAU;gBAC3DI,UAAU;YACZ;YAEAjB,OAAOD,OAAOJ,OAAO,EAAEM,IAAI,CAAC;YAC5B,IAAIF,OAAOJ,OAAO,EAAE;gBAClBK,OAAOD,OAAOH,IAAI,CAACa,WAAW,EAAER,IAAI,CAAC;YACvC;QACF;IACF;IAEAX,SAAS,mBAAmB;QAC1BG,GAAG,qCAAqC;YACrCf,oBAAS,CAACC,WAAW,CAAee,iBAAiB,CAAC;gBACrDC,SAAS;gBACTC,MAAM;oBAAEC,SAAS;gBAAK;YACxB;YAECnB,oBAAS,CAACF,MAAM,CAAekB,iBAAiB,CAAC;gBAChDC,SAAS;gBACTC,MAAM;oBACJY,KAAK;oBACLC,aAAa;gBACf;YACF;YAEAC,aAAapC,MAAM,CAACoB,iBAAiB,CAAC;gBACpCE,MAAM;oBACJe,IAAI;oBACJC,UAAU;oBACVH,aAAa;gBACf;gBACAP,OAAO;YACT;YAEA,MAAMW,WAAW,IAAIC,KAAK;gBAAC;aAAQ,EAAE,aAAa;gBAChDC,MAAM;YACR;YAEA,MAAMhB,SAAS,MAAMiB,0BAAY,CAACxC,MAAM,CAACqC,UAAU,UAAU;gBAC3DI,UAAU;YACZ;YAEAjB,OAAOD,OAAOJ,OAAO,EAAEM,IAAI,CAAC;YAC5B,IAAIF,OAAOJ,OAAO,EAAE;gBAClBK,OAAOD,OAAOH,IAAI,CAACgB,QAAQ,EAAEW,OAAO,CAAC;YACvC;QACF;QAEA9B,GAAG,gDAAgD;YAChDf,oBAAS,CAACC,WAAW,CAAee,iBAAiB,CAAC;gBACrDC,SAAS;gBACTO,OAAO;oBAAEC,MAAM;oBAAuBC,SAAS;gBAAU;YAC3D;YAEAM,aAAanC,OAAO,CAACC,MAAM,CAACkB,iBAAiB,CAAC;gBAC5CE,MAAM;oBAAEuB,MAAM;gBAAmB;gBACjCjB,OAAO;YACT;YAEAQ,aAAanC,OAAO,CAACE,YAAY,CAAC2C,eAAe,CAAC;gBAChDxB,MAAM;oBAAEyB,WAAW;gBAAuD;YAC5E;YAEAX,aAAapC,MAAM,CAACoB,iBAAiB,CAAC;gBACpCE,MAAM;oBACJe,IAAI;oBACJC,UAAU;oBACVH,aAAa;gBACf;gBACAP,OAAO;YACT;YAEA,MAAMW,WAAW,IAAIC,KAAK;gBAAC;aAAQ,EAAE,aAAa;gBAChDC,MAAM;YACR;YAEA,MAAMhB,SAAS,MAAMiB,0BAAY,CAACxC,MAAM,CAACqC,UAAU,UAAU;gBAC3DI,UAAU;YACZ;YAEAjB,OAAOD,OAAOJ,OAAO,EAAEM,IAAI,CAAC;YAC5B,IAAIF,OAAOJ,OAAO,EAAE;gBAClBK,OAAOD,OAAOH,IAAI,CAACgB,QAAQ,EAAEM,SAAS,CAAC;YACzC;QACF;IACF;IAEA5B,SAAS,yBAAyB;QAChCG,GAAG,4CAA4C;YAC5Cf,oBAAS,CAACC,WAAW,CAAee,iBAAiB,CAAC;gBACrDC,SAAS;gBACTC,MAAM;oBAAEC,SAAS;gBAAK;YACxB;YAECnB,oBAAS,CAACF,MAAM,CAAekB,iBAAiB,CAAC;gBAChDC,SAAS;gBACTC,MAAM;oBACJY,KAAK;oBACLC,aAAa;gBACf;YACF;YAEAC,aAAapC,MAAM,CAACoB,iBAAiB,CAAC;gBACpCE,MAAM;oBACJe,IAAI;oBACJF,aAAa;gBACf;gBACAP,OAAO;YACT;YAEA,MAAMW,WAAW,IAAIC,KAAK;gBAAC;aAAQ,EAAE,aAAa;gBAChDC,MAAM;YACR;YAEA,MAAMhB,SAAS,MAAMiB,0BAAY,CAACxC,MAAM,CAACqC,UAAU,UAAU;gBAC3DI,UAAU;YACZ;YAEAjB,OAAOD,OAAOJ,OAAO,EAAEM,IAAI,CAAC;YAC5B,IAAIF,OAAOJ,OAAO,EAAE;gBAClBK,OAAOD,OAAOH,IAAI,CAACa,WAAW,EAAER,IAAI,CAAC;YACvC;QACF;QAEAR,GAAG,kDAAkD;YAClDf,oBAAS,CAACC,WAAW,CAAee,iBAAiB,CAAC;gBACrDC,SAAS;gBACTO,OAAO;oBAAEC,MAAM;oBAAuBC,SAAS;gBAAU;YAC3D;YAEAM,aAAanC,OAAO,CAACC,MAAM,CAACkB,iBAAiB,CAAC;gBAC5CE,MAAM;oBAAEuB,MAAM;gBAAmB;gBACjCjB,OAAO;YACT;YAEAQ,aAAanC,OAAO,CAACE,YAAY,CAAC2C,eAAe,CAAC;gBAChDxB,MAAM;oBAAEyB,WAAW;gBAA+C;YACpE;YAEAX,aAAapC,MAAM,CAACoB,iBAAiB,CAAC;gBACpCE,MAAM;oBACJe,IAAI;oBACJF,aAAa;gBACf;gBACAP,OAAO;YACT;YAEA,MAAMW,WAAW,IAAIC,KAAK;gBAAC;aAAQ,EAAE,aAAa;gBAChDC,MAAM;YACR;YAEA,MAAMhB,SAAS,MAAMiB,0BAAY,CAACxC,MAAM,CAACqC,UAAU,UAAU;gBAC3DI,UAAU;YACZ;YAEAjB,OAAOD,OAAOJ,OAAO,EAAEM,IAAI,CAAC;YAC5B,IAAIF,OAAOJ,OAAO,EAAE;gBAClBK,OAAOD,OAAOH,IAAI,CAACa,WAAW,EAAER,IAAI,CAAC;YACvC;QACF;IACF;IAEAX,SAAS,qBAAqB;QAC5BG,GAAG,sDAAsD;YACvD,2CAA2C;YAC1Cf,oBAAS,CAACC,WAAW,CAAe2C,qBAAqB,CAAC;gBACzD3B,SAAS;gBACTO,OAAO;oBAAEC,MAAM;oBAAuBC,SAAS;gBAAU;YAC3D;YAEAM,aAAanC,OAAO,CAACC,MAAM,CAACkB,iBAAiB,CAAC;gBAC5CE,MAAM;oBAAEuB,MAAM;gBAAoB;gBAClCjB,OAAO;YACT;YAEAQ,aAAanC,OAAO,CAACE,YAAY,CAAC2C,eAAe,CAAC;gBAChDxB,MAAM;oBAAEyB,WAAW;gBAAgD;YACrE;YAEAX,aAAapC,MAAM,CAACgD,qBAAqB,CAAC;gBACxC1B,MAAM;oBACJe,IAAI;oBACJF,aAAa;gBACf;gBACAP,OAAO;YACT;YAEA,MAAMsB,YAAY,IAAIV,KAAK;gBAAC;aAAS,EAAE,cAAc;gBACnDC,MAAM;YACR;YAEA,MAAMU,UAAU,MAAMT,0BAAY,CAACxC,MAAM,CAACgD,WAAW,UAAU;gBAC7DP,UAAU;YACZ;YAEAjB,OAAOyB,QAAQ9B,OAAO,IAAI8B,QAAQ7B,IAAI,CAACa,WAAW,EAAER,IAAI,CAAC;YAEzD,0CAA0C;YACzCvB,oBAAS,CAACC,WAAW,CAAe2C,qBAAqB,CAAC;gBACzD3B,SAAS;gBACTC,MAAM;oBAAEC,SAAS;gBAAK;YACxB;YAECnB,oBAAS,CAACF,MAAM,CAAekB,iBAAiB,CAAC;gBAChDC,SAAS;gBACTC,MAAM;oBACJY,KAAK;oBACLC,aAAa;gBACf;YACF;YAEAC,aAAapC,MAAM,CAACgD,qBAAqB,CAAC;gBACxC1B,MAAM;oBACJe,IAAI;oBACJF,aAAa;gBACf;gBACAP,OAAO;YACT;YAEA,MAAMwB,YAAY,IAAIZ,KAAK;gBAAC;aAAS,EAAE,cAAc;gBACnDC,MAAM;YACR;YAEA,MAAMY,UAAU,MAAMX,0BAAY,CAACxC,MAAM,CAACkD,WAAW,UAAU;gBAC7DT,UAAU;YACZ;YAEAjB,OAAO2B,QAAQhC,OAAO,IAAIgC,QAAQ/B,IAAI,CAACa,WAAW,EAAER,IAAI,CAAC;QAC3D;IACF;IAEAX,SAAS,kBAAkB;QACzBG,GAAG,8CAA8C;YAC9Cf,oBAAS,CAACC,WAAW,CAAee,iBAAiB,CAAC;gBACrDC,SAAS;gBACTO,OAAO;oBAAEC,MAAM;oBAAuBC,SAAS;gBAAU;YAC3D;YAEAM,aAAanC,OAAO,CAACC,MAAM,CAACkB,iBAAiB,CAAC;gBAC5CE,MAAM;gBACNM,OAAO;oBAAEE,SAAS;gBAA+B;YACnD;YAEA,MAAMS,WAAW,IAAIC,KAAK;gBAAC;aAAQ,EAAE,aAAa;gBAChDC,MAAM;YACR;YAEA,MAAMhB,SAAS,MAAMiB,0BAAY,CAACxC,MAAM,CAACqC,UAAU,UAAU;gBAC3DI,UAAU;YACZ;YAEAjB,OAAOD,OAAOJ,OAAO,EAAEM,IAAI,CAAC;YAC5B,IAAI,CAACF,OAAOJ,OAAO,EAAE;gBACnBK,OAAOD,OAAOG,KAAK,CAACC,IAAI,EAAEF,IAAI,CAAC;YACjC;QACF;IACF;AACF"}