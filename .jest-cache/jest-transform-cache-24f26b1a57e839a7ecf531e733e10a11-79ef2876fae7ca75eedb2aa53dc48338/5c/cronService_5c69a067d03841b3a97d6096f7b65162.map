{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/cronService.ts"],"sourcesContent":["import type { Result } from '@/types';\nimport { ERROR_CODES } from '@/types';\nimport { supabase } from '@/lib/supabase';\n\n/**\n * Cron job status types.\n */\nexport type CronJobStatus = 'pending' | 'running' | 'completed' | 'failed';\n\n/**\n * Cron job types supported by the system.\n */\nexport type CronJobType =\n  | 'rsvp_deadline_reminders'\n  | 'scheduled_email_processing'\n  | 'webhook_retry'\n  | 'temp_file_cleanup'\n  | 'expired_session_cleanup';\n\n/**\n * Cron job execution log entry.\n */\nexport interface CronJobLog {\n  id: string;\n  job_type: CronJobType;\n  status: CronJobStatus;\n  started_at: string;\n  completed_at: string | null;\n  duration_ms: number | null;\n  items_processed: number;\n  items_failed: number;\n  error_message: string | null;\n  metadata: Record<string, unknown> | null;\n}\n\n/**\n * Cron job execution result.\n */\nexport interface CronJobResult {\n  jobType: CronJobType;\n  status: CronJobStatus;\n  itemsProcessed: number;\n  itemsFailed: number;\n  durationMs: number;\n  errors: string[];\n}\n\n/**\n * Creates a cron job log entry at the start of execution.\n * \n * @param jobType - Type of cron job being executed\n * @returns Result containing the log entry ID\n */\nasync function startJobLog(jobType: CronJobType): Promise<Result<string>> {\n  try {\n    const { data, error } = await supabase\n      .from('cron_job_logs')\n      .insert({\n        job_type: jobType,\n        status: 'running',\n        started_at: new Date().toISOString(),\n        items_processed: 0,\n        items_failed: 0,\n      })\n      .select('id')\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: 'Failed to create job log',\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: data.id };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Updates a cron job log entry at the end of execution.\n * \n * @param logId - Log entry ID\n * @param result - Job execution result\n * @returns Result indicating success or error\n */\nasync function completeJobLog(\n  logId: string,\n  result: Omit<CronJobResult, 'jobType'>\n): Promise<Result<void>> {\n  try {\n    const { error } = await supabase\n      .from('cron_job_logs')\n      .update({\n        status: result.status,\n        completed_at: new Date().toISOString(),\n        duration_ms: result.durationMs,\n        items_processed: result.itemsProcessed,\n        items_failed: result.itemsFailed,\n        error_message: result.errors.length > 0 ? result.errors.join('; ') : null,\n      })\n      .eq('id', logId);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: 'Failed to update job log',\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Executes a cron job with automatic logging and error handling.\n * \n * @param jobType - Type of cron job to execute\n * @param jobFunction - Function that performs the job\n * @returns Result containing job execution details\n * \n * @example\n * await executeCronJob('rsvp_deadline_reminders', async () => {\n *   // Job implementation\n *   return { itemsProcessed: 10, itemsFailed: 0 };\n * });\n */\nexport async function executeCronJob(\n  jobType: CronJobType,\n  jobFunction: () => Promise<{ itemsProcessed: number; itemsFailed: number }>\n): Promise<Result<CronJobResult>> {\n  const startTime = Date.now();\n  const errors: string[] = [];\n\n  // Start job log\n  const logResult = await startJobLog(jobType);\n  if (!logResult.success) {\n    return {\n      success: false,\n      error: logResult.error,\n    };\n  }\n\n  const logId = logResult.data;\n\n  try {\n    // Execute the job function\n    const { itemsProcessed, itemsFailed } = await jobFunction();\n\n    const durationMs = Date.now() - startTime;\n    const status: CronJobStatus = itemsFailed > 0 ? 'completed' : 'completed';\n\n    const result: CronJobResult = {\n      jobType,\n      status,\n      itemsProcessed,\n      itemsFailed,\n      durationMs,\n      errors,\n    };\n\n    // Update job log\n    await completeJobLog(logId, result);\n\n    return { success: true, data: result };\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n    errors.push(errorMessage);\n\n    const durationMs = Date.now() - startTime;\n\n    const result: CronJobResult = {\n      jobType,\n      status: 'failed',\n      itemsProcessed: 0,\n      itemsFailed: 0,\n      durationMs,\n      errors,\n    };\n\n    // Update job log with failure\n    await completeJobLog(logId, result);\n\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.CRON_JOB_ERROR,\n        message: `Cron job ${jobType} failed: ${errorMessage}`,\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Gets recent cron job execution logs.\n * \n * @param jobType - Optional filter by job type\n * @param limit - Maximum number of logs to return (default: 100)\n * @returns Result containing array of job logs\n */\nexport async function getJobLogs(\n  jobType?: CronJobType,\n  limit: number = 100\n): Promise<Result<CronJobLog[]>> {\n  try {\n    let query = supabase\n      .from('cron_job_logs')\n      .select('*')\n      .order('started_at', { ascending: false })\n      .limit(limit);\n\n    if (jobType) {\n      query = query.eq('job_type', jobType);\n    }\n\n    const { data, error } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: 'Failed to fetch job logs',\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: data || [] };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Gets cron job execution statistics.\n * \n * @param jobType - Optional filter by job type\n * @param since - Optional start date for statistics (ISO string)\n * @returns Result containing job statistics\n */\nexport async function getJobStats(\n  jobType?: CronJobType,\n  since?: string\n): Promise<\n  Result<{\n    totalExecutions: number;\n    successfulExecutions: number;\n    failedExecutions: number;\n    averageDurationMs: number;\n    totalItemsProcessed: number;\n    totalItemsFailed: number;\n  }>\n> {\n  try {\n    let query = supabase.from('cron_job_logs').select('*');\n\n    if (jobType) {\n      query = query.eq('job_type', jobType);\n    }\n\n    if (since) {\n      query = query.gte('started_at', since);\n    }\n\n    const { data: logs, error } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: 'Failed to fetch job statistics',\n          details: error,\n        },\n      };\n    }\n\n    const stats = {\n      totalExecutions: logs.length,\n      successfulExecutions: logs.filter((l) => l.status === 'completed').length,\n      failedExecutions: logs.filter((l) => l.status === 'failed').length,\n      averageDurationMs:\n        logs.length > 0\n          ? logs.reduce((sum, l) => sum + (l.duration_ms || 0), 0) / logs.length\n          : 0,\n      totalItemsProcessed: logs.reduce((sum, l) => sum + (l.items_processed || 0), 0),\n      totalItemsFailed: logs.reduce((sum, l) => sum + (l.items_failed || 0), 0),\n    };\n\n    return { success: true, data: stats };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Checks if a cron job is currently running.\n * \n * @param jobType - Type of cron job to check\n * @returns Result indicating if job is running\n */\nexport async function isJobRunning(jobType: CronJobType): Promise<Result<boolean>> {\n  try {\n    const { data, error } = await supabase\n      .from('cron_job_logs')\n      .select('id')\n      .eq('job_type', jobType)\n      .eq('status', 'running')\n      .limit(1);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: 'Failed to check job status',\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: (data || []).length > 0 };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n"],"names":["executeCronJob","getJobLogs","getJobStats","isJobRunning","startJobLog","jobType","data","error","supabase","from","insert","job_type","status","started_at","Date","toISOString","items_processed","items_failed","select","single","success","code","ERROR_CODES","DATABASE_ERROR","message","details","id","UNKNOWN_ERROR","Error","completeJobLog","logId","result","update","completed_at","duration_ms","durationMs","itemsProcessed","itemsFailed","error_message","errors","length","join","eq","undefined","jobFunction","startTime","now","logResult","errorMessage","push","CRON_JOB_ERROR","limit","query","order","ascending","since","gte","logs","stats","totalExecutions","successfulExecutions","filter","l","failedExecutions","averageDurationMs","reduce","sum","totalItemsProcessed","totalItemsFailed"],"mappings":"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"}