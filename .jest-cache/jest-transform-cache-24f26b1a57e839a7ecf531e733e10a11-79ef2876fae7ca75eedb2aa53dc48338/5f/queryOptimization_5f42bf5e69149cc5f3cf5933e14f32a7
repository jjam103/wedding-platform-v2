9dedf942ea30239e74d433a8efc3de65
/**
 * Query Optimization Utilities
 * 
 * This module provides utilities for optimizing database queries,
 * preventing N+1 query patterns, and implementing efficient data fetching.
 * 
 * Requirements: 19.1, 19.2, 18.6, 18.7
 */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get PAGINATION_DEFAULTS () {
        return PAGINATION_DEFAULTS;
    },
    get batchFetchByIds () {
        return batchFetchByIds;
    },
    get fetchActivitiesWithRSVPs () {
        return fetchActivitiesWithRSVPs;
    },
    get fetchAuditLogsWithUsers () {
        return fetchAuditLogsWithUsers;
    },
    get fetchContentPagesWithSections () {
        return fetchContentPagesWithSections;
    },
    get fetchEmailHistoryWithTemplates () {
        return fetchEmailHistoryWithTemplates;
    },
    get fetchEventsWithActivities () {
        return fetchEventsWithActivities;
    },
    get fetchGuestsWithRSVPs () {
        return fetchGuestsWithRSVPs;
    },
    get fetchPhotosWithUploaders () {
        return fetchPhotosWithUploaders;
    },
    get getPaginationRange () {
        return getPaginationRange;
    }
});
const PAGINATION_DEFAULTS = {
    GUESTS_PER_PAGE: 50,
    ACTIVITIES_PER_PAGE: 50,
    EVENTS_PER_PAGE: 50,
    PHOTOS_PER_PAGE: 50,
    EMAIL_HISTORY_PER_PAGE: 50,
    AUDIT_LOGS_PER_PAGE: 100
};
function getPaginationRange(page, pageSize) {
    const from = (page - 1) * pageSize;
    const to = from + pageSize - 1;
    return {
        from,
        to
    };
}
async function fetchGuestsWithRSVPs(supabase, options = {}) {
    const { groupId, page = 1, pageSize = PAGINATION_DEFAULTS.GUESTS_PER_PAGE } = options;
    const { from, to } = getPaginationRange(page, pageSize);
    let query = supabase.from('guests').select(`
      *,
      rsvps (
        id,
        activity_id,
        event_id,
        response_status,
        guest_count,
        dietary_restrictions
      )
    `, {
        count: 'exact'
    }).range(from, to).order('last_name', {
        ascending: true
    });
    if (groupId) {
        query = query.eq('group_id', groupId);
    }
    return query;
}
async function fetchEventsWithActivities(supabase, options = {}) {
    const { includeInactive = false, page = 1, pageSize = PAGINATION_DEFAULTS.EVENTS_PER_PAGE } = options;
    const { from, to } = getPaginationRange(page, pageSize);
    let query = supabase.from('events').select(`
      *,
      activities (
        id,
        title,
        activity_date,
        activity_time,
        activity_type,
        capacity,
        cost_per_person,
        location_id
      ),
      locations (
        id,
        name,
        type
      )
    `, {
        count: 'exact'
    }).range(from, to).order('event_date', {
        ascending: true
    });
    if (!includeInactive) {
        query = query.eq('is_active', true);
    }
    return query;
}
async function fetchActivitiesWithRSVPs(supabase, options = {}) {
    const { eventId, page = 1, pageSize = PAGINATION_DEFAULTS.ACTIVITIES_PER_PAGE } = options;
    const { from, to } = getPaginationRange(page, pageSize);
    let query = supabase.from('activities').select(`
      *,
      rsvps (
        id,
        guest_id,
        response_status,
        guest_count
      ),
      locations (
        id,
        name,
        type
      )
    `, {
        count: 'exact'
    }).range(from, to).order('activity_date', {
        ascending: true
    });
    if (eventId) {
        query = query.eq('event_id', eventId);
    }
    return query;
}
async function fetchContentPagesWithSections(supabase, options = {}) {
    const { status, page = 1, pageSize = 50 } = options;
    const { from, to } = getPaginationRange(page, pageSize);
    let query = supabase.from('content_pages').select(`
      *,
      sections (
        id,
        title,
        display_order,
        section_columns (
          id,
          column_number,
          content_type,
          content_data
        )
      )
    `, {
        count: 'exact'
    }).range(from, to).order('updated_at', {
        ascending: false
    });
    if (status) {
        query = query.eq('status', status);
    }
    return query;
}
async function fetchPhotosWithUploaders(supabase, options = {}) {
    const { moderationStatus, pageType, pageId, page = 1, pageSize = PAGINATION_DEFAULTS.PHOTOS_PER_PAGE } = options;
    const { from, to } = getPaginationRange(page, pageSize);
    let query = supabase.from('photos').select(`
      *,
      guests!uploader_id (
        id,
        first_name,
        last_name
      )
    `, {
        count: 'exact'
    }).range(from, to).order('created_at', {
        ascending: false
    });
    if (moderationStatus) {
        query = query.eq('moderation_status', moderationStatus);
    }
    if (pageType && pageId) {
        query = query.eq('page_type', pageType).eq('page_id', pageId);
    }
    return query;
}
async function batchFetchByIds(supabase, table, ids, selectFields = '*') {
    if (ids.length === 0) {
        return {
            data: [],
            error: null
        };
    }
    return supabase.from(table).select(selectFields).in('id', ids);
}
async function fetchAuditLogsWithUsers(supabase, options = {}) {
    const { userId, entityType, action, page = 1, pageSize = PAGINATION_DEFAULTS.AUDIT_LOGS_PER_PAGE } = options;
    const { from, to } = getPaginationRange(page, pageSize);
    let query = supabase.from('audit_logs').select(`
      *,
      users!user_id (
        id,
        email,
        role
      )
    `, {
        count: 'exact'
    }).range(from, to).order('timestamp', {
        ascending: false
    });
    if (userId) {
        query = query.eq('user_id', userId);
    }
    if (entityType) {
        query = query.eq('entity_type', entityType);
    }
    if (action) {
        query = query.eq('action', action);
    }
    return query;
}
async function fetchEmailHistoryWithTemplates(supabase, options = {}) {
    const { deliveryStatus, page = 1, pageSize = PAGINATION_DEFAULTS.EMAIL_HISTORY_PER_PAGE } = options;
    const { from, to } = getPaginationRange(page, pageSize);
    let query = supabase.from('email_history').select(`
      *,
      email_templates (
        id,
        name,
        category
      ),
      users!sent_by (
        id,
        email
      )
    `, {
        count: 'exact'
    }).range(from, to).order('sent_at', {
        ascending: false
    });
    if (deliveryStatus) {
        query = query.eq('delivery_status', deliveryStatus);
    }
    return query;
} /**
 * Query optimization best practices:
 * 
 * 1. Always use pagination for large result sets
 * 2. Use select with joins to fetch related data in one query
 * 3. Batch queries when fetching multiple entities by ID
 * 4. Use indexes on frequently queried columns
 * 5. Use composite indexes for multi-column filters
 * 6. Use partial indexes for frequently filtered subsets
 * 7. Avoid SELECT * when you only need specific fields
 * 8. Use .single() only when you expect exactly one result
 * 9. Use .maybeSingle() when you expect 0 or 1 results
 * 10. Use count: 'exact' only when you need the total count
 * 
 * Performance targets:
 * - Database queries: < 100ms (p95)
 * - API responses: < 500ms (p95)
 * - Page loads: < 2 seconds
 */ 

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9qYXJvbi9EZXNrdG9wL3dlZGRpbmctcGxhdGZvcm0tdjIvbGliL3F1ZXJ5T3B0aW1pemF0aW9uLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogUXVlcnkgT3B0aW1pemF0aW9uIFV0aWxpdGllc1xuICogXG4gKiBUaGlzIG1vZHVsZSBwcm92aWRlcyB1dGlsaXRpZXMgZm9yIG9wdGltaXppbmcgZGF0YWJhc2UgcXVlcmllcyxcbiAqIHByZXZlbnRpbmcgTisxIHF1ZXJ5IHBhdHRlcm5zLCBhbmQgaW1wbGVtZW50aW5nIGVmZmljaWVudCBkYXRhIGZldGNoaW5nLlxuICogXG4gKiBSZXF1aXJlbWVudHM6IDE5LjEsIDE5LjIsIDE4LjYsIDE4LjdcbiAqL1xuXG5pbXBvcnQgeyBjcmVhdGVDbGllbnQgfSBmcm9tICdAc3VwYWJhc2Uvc3VwYWJhc2UtanMnO1xuXG4vKipcbiAqIFBhZ2luYXRpb24gY29uZmlndXJhdGlvblxuICovXG5leHBvcnQgY29uc3QgUEFHSU5BVElPTl9ERUZBVUxUUyA9IHtcbiAgR1VFU1RTX1BFUl9QQUdFOiA1MCxcbiAgQUNUSVZJVElFU19QRVJfUEFHRTogNTAsXG4gIEVWRU5UU19QRVJfUEFHRTogNTAsXG4gIFBIT1RPU19QRVJfUEFHRTogNTAsXG4gIEVNQUlMX0hJU1RPUllfUEVSX1BBR0U6IDUwLFxuICBBVURJVF9MT0dTX1BFUl9QQUdFOiAxMDAsXG59IGFzIGNvbnN0O1xuXG4vKipcbiAqIENhbGN1bGF0ZSBwYWdpbmF0aW9uIHJhbmdlIGZvciBTdXBhYmFzZSBxdWVyaWVzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRQYWdpbmF0aW9uUmFuZ2UocGFnZTogbnVtYmVyLCBwYWdlU2l6ZTogbnVtYmVyKTogeyBmcm9tOiBudW1iZXI7IHRvOiBudW1iZXIgfSB7XG4gIGNvbnN0IGZyb20gPSAocGFnZSAtIDEpICogcGFnZVNpemU7XG4gIGNvbnN0IHRvID0gZnJvbSArIHBhZ2VTaXplIC0gMTtcbiAgcmV0dXJuIHsgZnJvbSwgdG8gfTtcbn1cblxuLyoqXG4gKiBGZXRjaCBndWVzdHMgd2l0aCB0aGVpciBSU1ZQcyBpbiBhIHNpbmdsZSBxdWVyeSAocHJldmVudHMgTisxKVxuICogXG4gKiBJbnN0ZWFkIG9mOlxuICogMS4gRmV0Y2ggYWxsIGd1ZXN0c1xuICogMi4gRm9yIGVhY2ggZ3Vlc3QsIGZldGNoIHRoZWlyIFJTVlBzIChOIHF1ZXJpZXMpXG4gKiBcbiAqIERvOlxuICogMS4gRmV0Y2ggZ3Vlc3RzIHdpdGggUlNWUHMgam9pbmVkICgxIHF1ZXJ5KVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZmV0Y2hHdWVzdHNXaXRoUlNWUHMoXG4gIHN1cGFiYXNlOiBSZXR1cm5UeXBlPHR5cGVvZiBjcmVhdGVDbGllbnQ+LFxuICBvcHRpb25zOiB7XG4gICAgZ3JvdXBJZD86IHN0cmluZztcbiAgICBwYWdlPzogbnVtYmVyO1xuICAgIHBhZ2VTaXplPzogbnVtYmVyO1xuICB9ID0ge31cbikge1xuICBjb25zdCB7IGdyb3VwSWQsIHBhZ2UgPSAxLCBwYWdlU2l6ZSA9IFBBR0lOQVRJT05fREVGQVVMVFMuR1VFU1RTX1BFUl9QQUdFIH0gPSBvcHRpb25zO1xuICBjb25zdCB7IGZyb20sIHRvIH0gPSBnZXRQYWdpbmF0aW9uUmFuZ2UocGFnZSwgcGFnZVNpemUpO1xuXG4gIGxldCBxdWVyeSA9IHN1cGFiYXNlXG4gICAgLmZyb20oJ2d1ZXN0cycpXG4gICAgLnNlbGVjdChgXG4gICAgICAqLFxuICAgICAgcnN2cHMgKFxuICAgICAgICBpZCxcbiAgICAgICAgYWN0aXZpdHlfaWQsXG4gICAgICAgIGV2ZW50X2lkLFxuICAgICAgICByZXNwb25zZV9zdGF0dXMsXG4gICAgICAgIGd1ZXN0X2NvdW50LFxuICAgICAgICBkaWV0YXJ5X3Jlc3RyaWN0aW9uc1xuICAgICAgKVxuICAgIGAsIHsgY291bnQ6ICdleGFjdCcgfSlcbiAgICAucmFuZ2UoZnJvbSwgdG8pXG4gICAgLm9yZGVyKCdsYXN0X25hbWUnLCB7IGFzY2VuZGluZzogdHJ1ZSB9KTtcblxuICBpZiAoZ3JvdXBJZCkge1xuICAgIHF1ZXJ5ID0gcXVlcnkuZXEoJ2dyb3VwX2lkJywgZ3JvdXBJZCk7XG4gIH1cblxuICByZXR1cm4gcXVlcnk7XG59XG5cbi8qKlxuICogRmV0Y2ggZXZlbnRzIHdpdGggdGhlaXIgYWN0aXZpdGllcyBpbiBhIHNpbmdsZSBxdWVyeSAocHJldmVudHMgTisxKVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZmV0Y2hFdmVudHNXaXRoQWN0aXZpdGllcyhcbiAgc3VwYWJhc2U6IFJldHVyblR5cGU8dHlwZW9mIGNyZWF0ZUNsaWVudD4sXG4gIG9wdGlvbnM6IHtcbiAgICBpbmNsdWRlSW5hY3RpdmU/OiBib29sZWFuO1xuICAgIHBhZ2U/OiBudW1iZXI7XG4gICAgcGFnZVNpemU/OiBudW1iZXI7XG4gIH0gPSB7fVxuKSB7XG4gIGNvbnN0IHsgaW5jbHVkZUluYWN0aXZlID0gZmFsc2UsIHBhZ2UgPSAxLCBwYWdlU2l6ZSA9IFBBR0lOQVRJT05fREVGQVVMVFMuRVZFTlRTX1BFUl9QQUdFIH0gPSBvcHRpb25zO1xuICBjb25zdCB7IGZyb20sIHRvIH0gPSBnZXRQYWdpbmF0aW9uUmFuZ2UocGFnZSwgcGFnZVNpemUpO1xuXG4gIGxldCBxdWVyeSA9IHN1cGFiYXNlXG4gICAgLmZyb20oJ2V2ZW50cycpXG4gICAgLnNlbGVjdChgXG4gICAgICAqLFxuICAgICAgYWN0aXZpdGllcyAoXG4gICAgICAgIGlkLFxuICAgICAgICB0aXRsZSxcbiAgICAgICAgYWN0aXZpdHlfZGF0ZSxcbiAgICAgICAgYWN0aXZpdHlfdGltZSxcbiAgICAgICAgYWN0aXZpdHlfdHlwZSxcbiAgICAgICAgY2FwYWNpdHksXG4gICAgICAgIGNvc3RfcGVyX3BlcnNvbixcbiAgICAgICAgbG9jYXRpb25faWRcbiAgICAgICksXG4gICAgICBsb2NhdGlvbnMgKFxuICAgICAgICBpZCxcbiAgICAgICAgbmFtZSxcbiAgICAgICAgdHlwZVxuICAgICAgKVxuICAgIGAsIHsgY291bnQ6ICdleGFjdCcgfSlcbiAgICAucmFuZ2UoZnJvbSwgdG8pXG4gICAgLm9yZGVyKCdldmVudF9kYXRlJywgeyBhc2NlbmRpbmc6IHRydWUgfSk7XG5cbiAgaWYgKCFpbmNsdWRlSW5hY3RpdmUpIHtcbiAgICBxdWVyeSA9IHF1ZXJ5LmVxKCdpc19hY3RpdmUnLCB0cnVlKTtcbiAgfVxuXG4gIHJldHVybiBxdWVyeTtcbn1cblxuLyoqXG4gKiBGZXRjaCBhY3Rpdml0aWVzIHdpdGggdGhlaXIgUlNWUHMgYW5kIGNhcGFjaXR5IGluZm8gaW4gYSBzaW5nbGUgcXVlcnkgKHByZXZlbnRzIE4rMSlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZldGNoQWN0aXZpdGllc1dpdGhSU1ZQcyhcbiAgc3VwYWJhc2U6IFJldHVyblR5cGU8dHlwZW9mIGNyZWF0ZUNsaWVudD4sXG4gIG9wdGlvbnM6IHtcbiAgICBldmVudElkPzogc3RyaW5nO1xuICAgIHBhZ2U/OiBudW1iZXI7XG4gICAgcGFnZVNpemU/OiBudW1iZXI7XG4gIH0gPSB7fVxuKSB7XG4gIGNvbnN0IHsgZXZlbnRJZCwgcGFnZSA9IDEsIHBhZ2VTaXplID0gUEFHSU5BVElPTl9ERUZBVUxUUy5BQ1RJVklUSUVTX1BFUl9QQUdFIH0gPSBvcHRpb25zO1xuICBjb25zdCB7IGZyb20sIHRvIH0gPSBnZXRQYWdpbmF0aW9uUmFuZ2UocGFnZSwgcGFnZVNpemUpO1xuXG4gIGxldCBxdWVyeSA9IHN1cGFiYXNlXG4gICAgLmZyb20oJ2FjdGl2aXRpZXMnKVxuICAgIC5zZWxlY3QoYFxuICAgICAgKixcbiAgICAgIHJzdnBzIChcbiAgICAgICAgaWQsXG4gICAgICAgIGd1ZXN0X2lkLFxuICAgICAgICByZXNwb25zZV9zdGF0dXMsXG4gICAgICAgIGd1ZXN0X2NvdW50XG4gICAgICApLFxuICAgICAgbG9jYXRpb25zIChcbiAgICAgICAgaWQsXG4gICAgICAgIG5hbWUsXG4gICAgICAgIHR5cGVcbiAgICAgIClcbiAgICBgLCB7IGNvdW50OiAnZXhhY3QnIH0pXG4gICAgLnJhbmdlKGZyb20sIHRvKVxuICAgIC5vcmRlcignYWN0aXZpdHlfZGF0ZScsIHsgYXNjZW5kaW5nOiB0cnVlIH0pO1xuXG4gIGlmIChldmVudElkKSB7XG4gICAgcXVlcnkgPSBxdWVyeS5lcSgnZXZlbnRfaWQnLCBldmVudElkKTtcbiAgfVxuXG4gIHJldHVybiBxdWVyeTtcbn1cblxuLyoqXG4gKiBGZXRjaCBjb250ZW50IHBhZ2VzIHdpdGggdGhlaXIgc2VjdGlvbnMgaW4gYSBzaW5nbGUgcXVlcnkgKHByZXZlbnRzIE4rMSlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZldGNoQ29udGVudFBhZ2VzV2l0aFNlY3Rpb25zKFxuICBzdXBhYmFzZTogUmV0dXJuVHlwZTx0eXBlb2YgY3JlYXRlQ2xpZW50PixcbiAgb3B0aW9uczoge1xuICAgIHN0YXR1cz86ICdkcmFmdCcgfCAncHVibGlzaGVkJztcbiAgICBwYWdlPzogbnVtYmVyO1xuICAgIHBhZ2VTaXplPzogbnVtYmVyO1xuICB9ID0ge31cbikge1xuICBjb25zdCB7IHN0YXR1cywgcGFnZSA9IDEsIHBhZ2VTaXplID0gNTAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHsgZnJvbSwgdG8gfSA9IGdldFBhZ2luYXRpb25SYW5nZShwYWdlLCBwYWdlU2l6ZSk7XG5cbiAgbGV0IHF1ZXJ5ID0gc3VwYWJhc2VcbiAgICAuZnJvbSgnY29udGVudF9wYWdlcycpXG4gICAgLnNlbGVjdChgXG4gICAgICAqLFxuICAgICAgc2VjdGlvbnMgKFxuICAgICAgICBpZCxcbiAgICAgICAgdGl0bGUsXG4gICAgICAgIGRpc3BsYXlfb3JkZXIsXG4gICAgICAgIHNlY3Rpb25fY29sdW1ucyAoXG4gICAgICAgICAgaWQsXG4gICAgICAgICAgY29sdW1uX251bWJlcixcbiAgICAgICAgICBjb250ZW50X3R5cGUsXG4gICAgICAgICAgY29udGVudF9kYXRhXG4gICAgICAgIClcbiAgICAgIClcbiAgICBgLCB7IGNvdW50OiAnZXhhY3QnIH0pXG4gICAgLnJhbmdlKGZyb20sIHRvKVxuICAgIC5vcmRlcigndXBkYXRlZF9hdCcsIHsgYXNjZW5kaW5nOiBmYWxzZSB9KTtcblxuICBpZiAoc3RhdHVzKSB7XG4gICAgcXVlcnkgPSBxdWVyeS5lcSgnc3RhdHVzJywgc3RhdHVzKTtcbiAgfVxuXG4gIHJldHVybiBxdWVyeTtcbn1cblxuLyoqXG4gKiBGZXRjaCBwaG90b3Mgd2l0aCB1cGxvYWRlciBpbmZvIGluIGEgc2luZ2xlIHF1ZXJ5IChwcmV2ZW50cyBOKzEpXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmZXRjaFBob3Rvc1dpdGhVcGxvYWRlcnMoXG4gIHN1cGFiYXNlOiBSZXR1cm5UeXBlPHR5cGVvZiBjcmVhdGVDbGllbnQ+LFxuICBvcHRpb25zOiB7XG4gICAgbW9kZXJhdGlvblN0YXR1cz86ICdwZW5kaW5nJyB8ICdhcHByb3ZlZCcgfCAncmVqZWN0ZWQnO1xuICAgIHBhZ2VUeXBlPzogc3RyaW5nO1xuICAgIHBhZ2VJZD86IHN0cmluZztcbiAgICBwYWdlPzogbnVtYmVyO1xuICAgIHBhZ2VTaXplPzogbnVtYmVyO1xuICB9ID0ge31cbikge1xuICBjb25zdCB7IG1vZGVyYXRpb25TdGF0dXMsIHBhZ2VUeXBlLCBwYWdlSWQsIHBhZ2UgPSAxLCBwYWdlU2l6ZSA9IFBBR0lOQVRJT05fREVGQVVMVFMuUEhPVE9TX1BFUl9QQUdFIH0gPSBvcHRpb25zO1xuICBjb25zdCB7IGZyb20sIHRvIH0gPSBnZXRQYWdpbmF0aW9uUmFuZ2UocGFnZSwgcGFnZVNpemUpO1xuXG4gIGxldCBxdWVyeSA9IHN1cGFiYXNlXG4gICAgLmZyb20oJ3Bob3RvcycpXG4gICAgLnNlbGVjdChgXG4gICAgICAqLFxuICAgICAgZ3Vlc3RzIXVwbG9hZGVyX2lkIChcbiAgICAgICAgaWQsXG4gICAgICAgIGZpcnN0X25hbWUsXG4gICAgICAgIGxhc3RfbmFtZVxuICAgICAgKVxuICAgIGAsIHsgY291bnQ6ICdleGFjdCcgfSlcbiAgICAucmFuZ2UoZnJvbSwgdG8pXG4gICAgLm9yZGVyKCdjcmVhdGVkX2F0JywgeyBhc2NlbmRpbmc6IGZhbHNlIH0pO1xuXG4gIGlmIChtb2RlcmF0aW9uU3RhdHVzKSB7XG4gICAgcXVlcnkgPSBxdWVyeS5lcSgnbW9kZXJhdGlvbl9zdGF0dXMnLCBtb2RlcmF0aW9uU3RhdHVzKTtcbiAgfVxuXG4gIGlmIChwYWdlVHlwZSAmJiBwYWdlSWQpIHtcbiAgICBxdWVyeSA9IHF1ZXJ5LmVxKCdwYWdlX3R5cGUnLCBwYWdlVHlwZSkuZXEoJ3BhZ2VfaWQnLCBwYWdlSWQpO1xuICB9XG5cbiAgcmV0dXJuIHF1ZXJ5O1xufVxuXG4vKipcbiAqIEJhdGNoIGZldGNoIGVudGl0aWVzIGJ5IElEcyAocHJldmVudHMgTisxKVxuICogXG4gKiBJbnN0ZWFkIG9mOlxuICogZm9yIChjb25zdCBpZCBvZiBpZHMpIHtcbiAqICAgYXdhaXQgc3VwYWJhc2UuZnJvbSgndGFibGUnKS5zZWxlY3QoJyonKS5lcSgnaWQnLCBpZCkuc2luZ2xlKCk7XG4gKiB9XG4gKiBcbiAqIERvOlxuICogYXdhaXQgYmF0Y2hGZXRjaEJ5SWRzKHN1cGFiYXNlLCAndGFibGUnLCBpZHMpO1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYmF0Y2hGZXRjaEJ5SWRzPFQgPSBhbnk+KFxuICBzdXBhYmFzZTogUmV0dXJuVHlwZTx0eXBlb2YgY3JlYXRlQ2xpZW50PixcbiAgdGFibGU6IHN0cmluZyxcbiAgaWRzOiBzdHJpbmdbXSxcbiAgc2VsZWN0RmllbGRzOiBzdHJpbmcgPSAnKidcbik6IFByb21pc2U8eyBkYXRhOiBUW10gfCBudWxsOyBlcnJvcjogYW55IH0+IHtcbiAgaWYgKGlkcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4geyBkYXRhOiBbXSwgZXJyb3I6IG51bGwgfTtcbiAgfVxuXG4gIHJldHVybiBzdXBhYmFzZVxuICAgIC5mcm9tKHRhYmxlKVxuICAgIC5zZWxlY3Qoc2VsZWN0RmllbGRzKVxuICAgIC5pbignaWQnLCBpZHMpO1xufVxuXG4vKipcbiAqIEZldGNoIGF1ZGl0IGxvZ3Mgd2l0aCB1c2VyIGluZm8gaW4gYSBzaW5nbGUgcXVlcnkgKHByZXZlbnRzIE4rMSlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZldGNoQXVkaXRMb2dzV2l0aFVzZXJzKFxuICBzdXBhYmFzZTogUmV0dXJuVHlwZTx0eXBlb2YgY3JlYXRlQ2xpZW50PixcbiAgb3B0aW9uczoge1xuICAgIHVzZXJJZD86IHN0cmluZztcbiAgICBlbnRpdHlUeXBlPzogc3RyaW5nO1xuICAgIGFjdGlvbj86IHN0cmluZztcbiAgICBwYWdlPzogbnVtYmVyO1xuICAgIHBhZ2VTaXplPzogbnVtYmVyO1xuICB9ID0ge31cbikge1xuICBjb25zdCB7IHVzZXJJZCwgZW50aXR5VHlwZSwgYWN0aW9uLCBwYWdlID0gMSwgcGFnZVNpemUgPSBQQUdJTkFUSU9OX0RFRkFVTFRTLkFVRElUX0xPR1NfUEVSX1BBR0UgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHsgZnJvbSwgdG8gfSA9IGdldFBhZ2luYXRpb25SYW5nZShwYWdlLCBwYWdlU2l6ZSk7XG5cbiAgbGV0IHF1ZXJ5ID0gc3VwYWJhc2VcbiAgICAuZnJvbSgnYXVkaXRfbG9ncycpXG4gICAgLnNlbGVjdChgXG4gICAgICAqLFxuICAgICAgdXNlcnMhdXNlcl9pZCAoXG4gICAgICAgIGlkLFxuICAgICAgICBlbWFpbCxcbiAgICAgICAgcm9sZVxuICAgICAgKVxuICAgIGAsIHsgY291bnQ6ICdleGFjdCcgfSlcbiAgICAucmFuZ2UoZnJvbSwgdG8pXG4gICAgLm9yZGVyKCd0aW1lc3RhbXAnLCB7IGFzY2VuZGluZzogZmFsc2UgfSk7XG5cbiAgaWYgKHVzZXJJZCkge1xuICAgIHF1ZXJ5ID0gcXVlcnkuZXEoJ3VzZXJfaWQnLCB1c2VySWQpO1xuICB9XG5cbiAgaWYgKGVudGl0eVR5cGUpIHtcbiAgICBxdWVyeSA9IHF1ZXJ5LmVxKCdlbnRpdHlfdHlwZScsIGVudGl0eVR5cGUpO1xuICB9XG5cbiAgaWYgKGFjdGlvbikge1xuICAgIHF1ZXJ5ID0gcXVlcnkuZXEoJ2FjdGlvbicsIGFjdGlvbik7XG4gIH1cblxuICByZXR1cm4gcXVlcnk7XG59XG5cbi8qKlxuICogRmV0Y2ggZW1haWwgaGlzdG9yeSB3aXRoIHRlbXBsYXRlIGluZm8gaW4gYSBzaW5nbGUgcXVlcnkgKHByZXZlbnRzIE4rMSlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZldGNoRW1haWxIaXN0b3J5V2l0aFRlbXBsYXRlcyhcbiAgc3VwYWJhc2U6IFJldHVyblR5cGU8dHlwZW9mIGNyZWF0ZUNsaWVudD4sXG4gIG9wdGlvbnM6IHtcbiAgICBkZWxpdmVyeVN0YXR1cz86IHN0cmluZztcbiAgICBwYWdlPzogbnVtYmVyO1xuICAgIHBhZ2VTaXplPzogbnVtYmVyO1xuICB9ID0ge31cbikge1xuICBjb25zdCB7IGRlbGl2ZXJ5U3RhdHVzLCBwYWdlID0gMSwgcGFnZVNpemUgPSBQQUdJTkFUSU9OX0RFRkFVTFRTLkVNQUlMX0hJU1RPUllfUEVSX1BBR0UgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHsgZnJvbSwgdG8gfSA9IGdldFBhZ2luYXRpb25SYW5nZShwYWdlLCBwYWdlU2l6ZSk7XG5cbiAgbGV0IHF1ZXJ5ID0gc3VwYWJhc2VcbiAgICAuZnJvbSgnZW1haWxfaGlzdG9yeScpXG4gICAgLnNlbGVjdChgXG4gICAgICAqLFxuICAgICAgZW1haWxfdGVtcGxhdGVzIChcbiAgICAgICAgaWQsXG4gICAgICAgIG5hbWUsXG4gICAgICAgIGNhdGVnb3J5XG4gICAgICApLFxuICAgICAgdXNlcnMhc2VudF9ieSAoXG4gICAgICAgIGlkLFxuICAgICAgICBlbWFpbFxuICAgICAgKVxuICAgIGAsIHsgY291bnQ6ICdleGFjdCcgfSlcbiAgICAucmFuZ2UoZnJvbSwgdG8pXG4gICAgLm9yZGVyKCdzZW50X2F0JywgeyBhc2NlbmRpbmc6IGZhbHNlIH0pO1xuXG4gIGlmIChkZWxpdmVyeVN0YXR1cykge1xuICAgIHF1ZXJ5ID0gcXVlcnkuZXEoJ2RlbGl2ZXJ5X3N0YXR1cycsIGRlbGl2ZXJ5U3RhdHVzKTtcbiAgfVxuXG4gIHJldHVybiBxdWVyeTtcbn1cblxuLyoqXG4gKiBRdWVyeSBvcHRpbWl6YXRpb24gYmVzdCBwcmFjdGljZXM6XG4gKiBcbiAqIDEuIEFsd2F5cyB1c2UgcGFnaW5hdGlvbiBmb3IgbGFyZ2UgcmVzdWx0IHNldHNcbiAqIDIuIFVzZSBzZWxlY3Qgd2l0aCBqb2lucyB0byBmZXRjaCByZWxhdGVkIGRhdGEgaW4gb25lIHF1ZXJ5XG4gKiAzLiBCYXRjaCBxdWVyaWVzIHdoZW4gZmV0Y2hpbmcgbXVsdGlwbGUgZW50aXRpZXMgYnkgSURcbiAqIDQuIFVzZSBpbmRleGVzIG9uIGZyZXF1ZW50bHkgcXVlcmllZCBjb2x1bW5zXG4gKiA1LiBVc2UgY29tcG9zaXRlIGluZGV4ZXMgZm9yIG11bHRpLWNvbHVtbiBmaWx0ZXJzXG4gKiA2LiBVc2UgcGFydGlhbCBpbmRleGVzIGZvciBmcmVxdWVudGx5IGZpbHRlcmVkIHN1YnNldHNcbiAqIDcuIEF2b2lkIFNFTEVDVCAqIHdoZW4geW91IG9ubHkgbmVlZCBzcGVjaWZpYyBmaWVsZHNcbiAqIDguIFVzZSAuc2luZ2xlKCkgb25seSB3aGVuIHlvdSBleHBlY3QgZXhhY3RseSBvbmUgcmVzdWx0XG4gKiA5LiBVc2UgLm1heWJlU2luZ2xlKCkgd2hlbiB5b3UgZXhwZWN0IDAgb3IgMSByZXN1bHRzXG4gKiAxMC4gVXNlIGNvdW50OiAnZXhhY3QnIG9ubHkgd2hlbiB5b3UgbmVlZCB0aGUgdG90YWwgY291bnRcbiAqIFxuICogUGVyZm9ybWFuY2UgdGFyZ2V0czpcbiAqIC0gRGF0YWJhc2UgcXVlcmllczogPCAxMDBtcyAocDk1KVxuICogLSBBUEkgcmVzcG9uc2VzOiA8IDUwMG1zIChwOTUpXG4gKiAtIFBhZ2UgbG9hZHM6IDwgMiBzZWNvbmRzXG4gKi9cbiJdLCJuYW1lcyI6WyJQQUdJTkFUSU9OX0RFRkFVTFRTIiwiYmF0Y2hGZXRjaEJ5SWRzIiwiZmV0Y2hBY3Rpdml0aWVzV2l0aFJTVlBzIiwiZmV0Y2hBdWRpdExvZ3NXaXRoVXNlcnMiLCJmZXRjaENvbnRlbnRQYWdlc1dpdGhTZWN0aW9ucyIsImZldGNoRW1haWxIaXN0b3J5V2l0aFRlbXBsYXRlcyIsImZldGNoRXZlbnRzV2l0aEFjdGl2aXRpZXMiLCJmZXRjaEd1ZXN0c1dpdGhSU1ZQcyIsImZldGNoUGhvdG9zV2l0aFVwbG9hZGVycyIsImdldFBhZ2luYXRpb25SYW5nZSIsIkdVRVNUU19QRVJfUEFHRSIsIkFDVElWSVRJRVNfUEVSX1BBR0UiLCJFVkVOVFNfUEVSX1BBR0UiLCJQSE9UT1NfUEVSX1BBR0UiLCJFTUFJTF9ISVNUT1JZX1BFUl9QQUdFIiwiQVVESVRfTE9HU19QRVJfUEFHRSIsInBhZ2UiLCJwYWdlU2l6ZSIsImZyb20iLCJ0byIsInN1cGFiYXNlIiwib3B0aW9ucyIsImdyb3VwSWQiLCJxdWVyeSIsInNlbGVjdCIsImNvdW50IiwicmFuZ2UiLCJvcmRlciIsImFzY2VuZGluZyIsImVxIiwiaW5jbHVkZUluYWN0aXZlIiwiZXZlbnRJZCIsInN0YXR1cyIsIm1vZGVyYXRpb25TdGF0dXMiLCJwYWdlVHlwZSIsInBhZ2VJZCIsInRhYmxlIiwiaWRzIiwic2VsZWN0RmllbGRzIiwibGVuZ3RoIiwiZGF0YSIsImVycm9yIiwiaW4iLCJ1c2VySWQiLCJlbnRpdHlUeXBlIiwiYWN0aW9uIiwiZGVsaXZlcnlTdGF0dXMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0NBT0M7Ozs7Ozs7Ozs7O1FBT1lBO2VBQUFBOztRQTZPU0M7ZUFBQUE7O1FBaElBQztlQUFBQTs7UUFtSkFDO2VBQUFBOztRQTNHQUM7ZUFBQUE7O1FBdUpBQztlQUFBQTs7UUEzT0FDO2VBQUFBOztRQXJDQUM7ZUFBQUE7O1FBaUtBQztlQUFBQTs7UUFqTE5DO2VBQUFBOzs7QUFaVCxNQUFNVCxzQkFBc0I7SUFDakNVLGlCQUFpQjtJQUNqQkMscUJBQXFCO0lBQ3JCQyxpQkFBaUI7SUFDakJDLGlCQUFpQjtJQUNqQkMsd0JBQXdCO0lBQ3hCQyxxQkFB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