{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/lib/queryOptimization.ts"],"sourcesContent":["/**\n * Query Optimization Utilities\n * \n * This module provides utilities for optimizing database queries,\n * preventing N+1 query patterns, and implementing efficient data fetching.\n * \n * Requirements: 19.1, 19.2, 18.6, 18.7\n */\n\nimport { createClient } from '@supabase/supabase-js';\n\n/**\n * Pagination configuration\n */\nexport const PAGINATION_DEFAULTS = {\n  GUESTS_PER_PAGE: 50,\n  ACTIVITIES_PER_PAGE: 50,\n  EVENTS_PER_PAGE: 50,\n  PHOTOS_PER_PAGE: 50,\n  EMAIL_HISTORY_PER_PAGE: 50,\n  AUDIT_LOGS_PER_PAGE: 100,\n} as const;\n\n/**\n * Calculate pagination range for Supabase queries\n */\nexport function getPaginationRange(page: number, pageSize: number): { from: number; to: number } {\n  const from = (page - 1) * pageSize;\n  const to = from + pageSize - 1;\n  return { from, to };\n}\n\n/**\n * Fetch guests with their RSVPs in a single query (prevents N+1)\n * \n * Instead of:\n * 1. Fetch all guests\n * 2. For each guest, fetch their RSVPs (N queries)\n * \n * Do:\n * 1. Fetch guests with RSVPs joined (1 query)\n */\nexport async function fetchGuestsWithRSVPs(\n  supabase: ReturnType<typeof createClient>,\n  options: {\n    groupId?: string;\n    page?: number;\n    pageSize?: number;\n  } = {}\n) {\n  const { groupId, page = 1, pageSize = PAGINATION_DEFAULTS.GUESTS_PER_PAGE } = options;\n  const { from, to } = getPaginationRange(page, pageSize);\n\n  let query = supabase\n    .from('guests')\n    .select(`\n      *,\n      rsvps (\n        id,\n        activity_id,\n        event_id,\n        response_status,\n        guest_count,\n        dietary_restrictions\n      )\n    `, { count: 'exact' })\n    .range(from, to)\n    .order('last_name', { ascending: true });\n\n  if (groupId) {\n    query = query.eq('group_id', groupId);\n  }\n\n  return query;\n}\n\n/**\n * Fetch events with their activities in a single query (prevents N+1)\n */\nexport async function fetchEventsWithActivities(\n  supabase: ReturnType<typeof createClient>,\n  options: {\n    includeInactive?: boolean;\n    page?: number;\n    pageSize?: number;\n  } = {}\n) {\n  const { includeInactive = false, page = 1, pageSize = PAGINATION_DEFAULTS.EVENTS_PER_PAGE } = options;\n  const { from, to } = getPaginationRange(page, pageSize);\n\n  let query = supabase\n    .from('events')\n    .select(`\n      *,\n      activities (\n        id,\n        title,\n        activity_date,\n        activity_time,\n        activity_type,\n        capacity,\n        cost_per_person,\n        location_id\n      ),\n      locations (\n        id,\n        name,\n        type\n      )\n    `, { count: 'exact' })\n    .range(from, to)\n    .order('event_date', { ascending: true });\n\n  if (!includeInactive) {\n    query = query.eq('is_active', true);\n  }\n\n  return query;\n}\n\n/**\n * Fetch activities with their RSVPs and capacity info in a single query (prevents N+1)\n */\nexport async function fetchActivitiesWithRSVPs(\n  supabase: ReturnType<typeof createClient>,\n  options: {\n    eventId?: string;\n    page?: number;\n    pageSize?: number;\n  } = {}\n) {\n  const { eventId, page = 1, pageSize = PAGINATION_DEFAULTS.ACTIVITIES_PER_PAGE } = options;\n  const { from, to } = getPaginationRange(page, pageSize);\n\n  let query = supabase\n    .from('activities')\n    .select(`\n      *,\n      rsvps (\n        id,\n        guest_id,\n        response_status,\n        guest_count\n      ),\n      locations (\n        id,\n        name,\n        type\n      )\n    `, { count: 'exact' })\n    .range(from, to)\n    .order('activity_date', { ascending: true });\n\n  if (eventId) {\n    query = query.eq('event_id', eventId);\n  }\n\n  return query;\n}\n\n/**\n * Fetch content pages with their sections in a single query (prevents N+1)\n */\nexport async function fetchContentPagesWithSections(\n  supabase: ReturnType<typeof createClient>,\n  options: {\n    status?: 'draft' | 'published';\n    page?: number;\n    pageSize?: number;\n  } = {}\n) {\n  const { status, page = 1, pageSize = 50 } = options;\n  const { from, to } = getPaginationRange(page, pageSize);\n\n  let query = supabase\n    .from('content_pages')\n    .select(`\n      *,\n      sections (\n        id,\n        title,\n        display_order,\n        section_columns (\n          id,\n          column_number,\n          content_type,\n          content_data\n        )\n      )\n    `, { count: 'exact' })\n    .range(from, to)\n    .order('updated_at', { ascending: false });\n\n  if (status) {\n    query = query.eq('status', status);\n  }\n\n  return query;\n}\n\n/**\n * Fetch photos with uploader info in a single query (prevents N+1)\n */\nexport async function fetchPhotosWithUploaders(\n  supabase: ReturnType<typeof createClient>,\n  options: {\n    moderationStatus?: 'pending' | 'approved' | 'rejected';\n    pageType?: string;\n    pageId?: string;\n    page?: number;\n    pageSize?: number;\n  } = {}\n) {\n  const { moderationStatus, pageType, pageId, page = 1, pageSize = PAGINATION_DEFAULTS.PHOTOS_PER_PAGE } = options;\n  const { from, to } = getPaginationRange(page, pageSize);\n\n  let query = supabase\n    .from('photos')\n    .select(`\n      *,\n      guests!uploader_id (\n        id,\n        first_name,\n        last_name\n      )\n    `, { count: 'exact' })\n    .range(from, to)\n    .order('created_at', { ascending: false });\n\n  if (moderationStatus) {\n    query = query.eq('moderation_status', moderationStatus);\n  }\n\n  if (pageType && pageId) {\n    query = query.eq('page_type', pageType).eq('page_id', pageId);\n  }\n\n  return query;\n}\n\n/**\n * Batch fetch entities by IDs (prevents N+1)\n * \n * Instead of:\n * for (const id of ids) {\n *   await supabase.from('table').select('*').eq('id', id).single();\n * }\n * \n * Do:\n * await batchFetchByIds(supabase, 'table', ids);\n */\nexport async function batchFetchByIds<T = any>(\n  supabase: ReturnType<typeof createClient>,\n  table: string,\n  ids: string[],\n  selectFields: string = '*'\n): Promise<{ data: T[] | null; error: any }> {\n  if (ids.length === 0) {\n    return { data: [], error: null };\n  }\n\n  return supabase\n    .from(table)\n    .select(selectFields)\n    .in('id', ids);\n}\n\n/**\n * Fetch audit logs with user info in a single query (prevents N+1)\n */\nexport async function fetchAuditLogsWithUsers(\n  supabase: ReturnType<typeof createClient>,\n  options: {\n    userId?: string;\n    entityType?: string;\n    action?: string;\n    page?: number;\n    pageSize?: number;\n  } = {}\n) {\n  const { userId, entityType, action, page = 1, pageSize = PAGINATION_DEFAULTS.AUDIT_LOGS_PER_PAGE } = options;\n  const { from, to } = getPaginationRange(page, pageSize);\n\n  let query = supabase\n    .from('audit_logs')\n    .select(`\n      *,\n      users!user_id (\n        id,\n        email,\n        role\n      )\n    `, { count: 'exact' })\n    .range(from, to)\n    .order('timestamp', { ascending: false });\n\n  if (userId) {\n    query = query.eq('user_id', userId);\n  }\n\n  if (entityType) {\n    query = query.eq('entity_type', entityType);\n  }\n\n  if (action) {\n    query = query.eq('action', action);\n  }\n\n  return query;\n}\n\n/**\n * Fetch email history with template info in a single query (prevents N+1)\n */\nexport async function fetchEmailHistoryWithTemplates(\n  supabase: ReturnType<typeof createClient>,\n  options: {\n    deliveryStatus?: string;\n    page?: number;\n    pageSize?: number;\n  } = {}\n) {\n  const { deliveryStatus, page = 1, pageSize = PAGINATION_DEFAULTS.EMAIL_HISTORY_PER_PAGE } = options;\n  const { from, to } = getPaginationRange(page, pageSize);\n\n  let query = supabase\n    .from('email_history')\n    .select(`\n      *,\n      email_templates (\n        id,\n        name,\n        category\n      ),\n      users!sent_by (\n        id,\n        email\n      )\n    `, { count: 'exact' })\n    .range(from, to)\n    .order('sent_at', { ascending: false });\n\n  if (deliveryStatus) {\n    query = query.eq('delivery_status', deliveryStatus);\n  }\n\n  return query;\n}\n\n/**\n * Query optimization best practices:\n * \n * 1. Always use pagination for large result sets\n * 2. Use select with joins to fetch related data in one query\n * 3. Batch queries when fetching multiple entities by ID\n * 4. Use indexes on frequently queried columns\n * 5. Use composite indexes for multi-column filters\n * 6. Use partial indexes for frequently filtered subsets\n * 7. Avoid SELECT * when you only need specific fields\n * 8. Use .single() only when you expect exactly one result\n * 9. Use .maybeSingle() when you expect 0 or 1 results\n * 10. Use count: 'exact' only when you need the total count\n * \n * Performance targets:\n * - Database queries: < 100ms (p95)\n * - API responses: < 500ms (p95)\n * - Page loads: < 2 seconds\n */\n"],"names":["PAGINATION_DEFAULTS","batchFetchByIds","fetchActivitiesWithRSVPs","fetchAuditLogsWithUsers","fetchContentPagesWithSections","fetchEmailHistoryWithTemplates","fetchEventsWithActivities","fetchGuestsWithRSVPs","fetchPhotosWithUploaders","getPaginationRange","GUESTS_PER_PAGE","ACTIVITIES_PER_PAGE","EVENTS_PER_PAGE","PHOTOS_PER_PAGE","EMAIL_HISTORY_PER_PAGE","AUDIT_LOGS_PER_PAGE","page","pageSize","from","to","supabase","options","groupId","query","select","count","range","order","ascending","eq","includeInactive","eventId","status","moderationStatus","pageType","pageId","table","ids","selectFields","length","data","error","in","userId","entityType","action","deliveryStatus"],"mappings":"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"}