{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/settingsService.ts"],"sourcesContent":["import {\n  systemSettingsSchema,\n  updateSystemSettingsSchema,\n  type SystemSettings,\n  type UpdateSystemSettingsDTO,\n} from '../schemas/settingsSchemas';\n\ntype Result<T> =\n  | { success: true; data: T }\n  | { success: false; error: { code: string; message: string; details?: any } };\n\n// Lazy load supabase to avoid initialization issues in tests\nlet _supabase: any = null;\nfunction getSupabase() {\n  if (!_supabase) {\n    const { supabase } = require('../lib/supabase');\n    _supabase = supabase;\n  }\n  return _supabase;\n}\n\n/**\n * Gets system settings\n * \n * @returns Result containing system settings or error details\n * \n * @example\n * const result = await settingsService.getSettings();\n * if (result.success) {\n *   console.log(result.data.wedding_date);\n * }\n */\nexport async function getSettings(): Promise<Result<SystemSettings>> {\n  try {\n    const supabase = getSupabase();\n    const { data, error } = await supabase\n      .from('system_settings')\n      .select('*')\n      .single();\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        // No settings found, return default settings\n        return {\n          success: true,\n          data: {\n            id: '',\n            wedding_date: null,\n            venue_name: null,\n            couple_name_1: null,\n            couple_name_2: null,\n            timezone: 'America/Costa_Rica',\n            send_rsvp_confirmations: true,\n            send_activity_reminders: true,\n            send_deadline_reminders: true,\n            reminder_days_before: 7,\n            require_photo_moderation: true,\n            max_photos_per_guest: 20,\n            allowed_photo_formats: ['jpg', 'jpeg', 'png', 'heic'],\n            home_page_title: null,\n            home_page_subtitle: null,\n            home_page_welcome_message: null,\n            home_page_hero_image_url: null,\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString(),\n          },\n        };\n      }\n\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Updates system settings\n * \n * @param data - Settings data to update\n * @returns Result containing the updated settings or error details\n * \n * @example\n * const result = await settingsService.updateSettings({\n *   wedding_date: '2024-06-15T00:00:00Z',\n *   venue_name: 'Dreams Las Mareas',\n *   couple_name_1: 'John',\n *   couple_name_2: 'Jane',\n * });\n */\nexport async function updateSettings(data: UpdateSystemSettingsDTO): Promise<Result<SystemSettings>> {\n  try {\n    // 1. Validate\n    const validation = updateSystemSettingsSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Check if settings exist\n    const supabase = getSupabase();\n    const { data: existing } = await supabase\n      .from('system_settings')\n      .select('id')\n      .single();\n\n    let result;\n    if (existing) {\n      // Update existing settings\n      const { data: updated, error } = await supabase\n        .from('system_settings')\n        .update(validation.data)\n        .eq('id', existing.id)\n        .select()\n        .single();\n\n      if (error) {\n        return {\n          success: false,\n          error: {\n            code: 'DATABASE_ERROR',\n            message: error.message,\n            details: error,\n          },\n        };\n      }\n\n      result = updated;\n    } else {\n      // Create new settings\n      const { data: created, error } = await supabase\n        .from('system_settings')\n        .insert(validation.data)\n        .select()\n        .single();\n\n      if (error) {\n        return {\n          success: false,\n          error: {\n            code: 'DATABASE_ERROR',\n            message: error.message,\n            details: error,\n          },\n        };\n      }\n\n      result = created;\n    }\n\n    return { success: true, data: result };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n"],"names":["getSettings","updateSettings","_supabase","getSupabase","supabase","require","data","error","from","select","single","code","success","id","wedding_date","venue_name","couple_name_1","couple_name_2","timezone","send_rsvp_confirmations","send_activity_reminders","send_deadline_reminders","reminder_days_before","require_photo_moderation","max_photos_per_guest","allowed_photo_formats","home_page_title","home_page_subtitle","home_page_welcome_message","home_page_hero_image_url","created_at","Date","toISOString","updated_at","message","details","Error","validation","updateSystemSettingsSchema","safeParse","issues","existing","result","updated","update","eq","created","insert"],"mappings":"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"}