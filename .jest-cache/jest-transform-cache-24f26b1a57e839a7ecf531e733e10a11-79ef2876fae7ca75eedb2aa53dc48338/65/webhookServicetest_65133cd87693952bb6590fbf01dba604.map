{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/webhookService.test.ts"],"sourcesContent":["// Mock crypto\njest.mock('crypto', () => ({\n  createHmac: jest.fn().mockReturnValue({\n    update: jest.fn().mockReturnThis(),\n    digest: jest.fn().mockReturnValue('mocked-signature'),\n  }),\n  timingSafeEqual: jest.fn().mockReturnValue(true),\n}));\n\n// Mock fetch globally\nglobal.fetch = jest.fn();\n\n// Import service AFTER mocking dependencies\nimport {\n  generateWebhookSignature,\n  verifyWebhookSignature,\n  calculateRetryDelay,\n  sendWebhookEvent,\n  retryFailedWebhooks,\n  validateWebhookConfig,\n  testWebhookConnectivity,\n} from './webhookService';\nimport { createMockSupabaseClient } from '../__tests__/helpers/mockSupabase';\n\n// Mock the supabase lib at the module level\nconst mockSupabase = createMockSupabaseClient();\njest.mock('../lib/supabase', () => ({\n  supabase: mockSupabase,\n}));\n\ndescribe('webhookService', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    \n    // Set up environment variables\n    process.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';\n    process.env.SUPABASE_SERVICE_ROLE_KEY = 'test-service-role-key';\n    \n    // Reset fetch mock\n    (global.fetch as jest.Mock).mockClear();\n  });\n\n  describe('generateWebhookSignature', () => {\n    it('should generate HMAC signature for webhook payload', () => {\n      const payload = '{\"event\":\"test\",\"data\":{}}';\n      const secret = 'test-secret-key';\n\n      const signature = generateWebhookSignature(payload, secret);\n\n      expect(signature).toBe('mocked-signature');\n      expect(require('crypto').createHmac).toHaveBeenCalledWith('sha256', secret);\n    });\n  });\n\n  describe('verifyWebhookSignature', () => {\n    it('should return true when signature is valid', () => {\n      const payload = '{\"event\":\"test\",\"data\":{}}';\n      const signature = 'valid-signature';\n      const secret = 'test-secret-key';\n\n      const isValid = verifyWebhookSignature(payload, signature, secret);\n\n      expect(isValid).toBe(true);\n      expect(require('crypto').timingSafeEqual).toHaveBeenCalled();\n    });\n\n    it('should return false when timingSafeEqual throws error', () => {\n      require('crypto').timingSafeEqual.mockImplementationOnce(() => {\n        throw new Error('Buffer length mismatch');\n      });\n\n      const payload = '{\"event\":\"test\",\"data\":{}}';\n      const signature = 'invalid-signature';\n      const secret = 'test-secret-key';\n\n      const isValid = verifyWebhookSignature(payload, signature, secret);\n\n      expect(isValid).toBe(false);\n    });\n  });\n\n  describe('calculateRetryDelay', () => {\n    it('should calculate exponential backoff delay', () => {\n      const baseDelay = 1000;\n\n      const delay0 = calculateRetryDelay(0, baseDelay);\n      const delay1 = calculateRetryDelay(1, baseDelay);\n      const delay2 = calculateRetryDelay(2, baseDelay);\n\n      // Exponential backoff: baseDelay * 2^attempt\n      // With jitter, so we check ranges\n      expect(delay0).toBeGreaterThanOrEqual(1000); // 1000 * 2^0 = 1000\n      expect(delay0).toBeLessThanOrEqual(1100); // With 10% jitter\n\n      expect(delay1).toBeGreaterThanOrEqual(2000); // 1000 * 2^1 = 2000\n      expect(delay1).toBeLessThanOrEqual(2200); // With 10% jitter\n\n      expect(delay2).toBeGreaterThanOrEqual(4000); // 1000 * 2^2 = 4000\n      expect(delay2).toBeLessThanOrEqual(4400); // With 10% jitter\n    });\n\n    it('should use default base delay when not provided', () => {\n      const delay = calculateRetryDelay(0);\n      expect(delay).toBeGreaterThanOrEqual(1000);\n      expect(delay).toBeLessThanOrEqual(1100);\n    });\n  });\n\n  describe('sendWebhookEvent', () => {\n    beforeEach(() => {\n      (global.fetch as jest.Mock).mockResolvedValue({\n        ok: true,\n        status: 200,\n        text: jest.fn().mockResolvedValue('OK'),\n      });\n    });\n\n    it('should return success when no webhooks configured for event', async () => {\n      mockSupabase.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            contains: jest.fn().mockResolvedValue({\n              data: [],\n              error: null,\n            }),\n          }),\n        }),\n      });\n\n      const result = await sendWebhookEvent('rsvp.submitted', {\n        guestId: 'guest-123',\n        status: 'attending',\n      });\n\n      expect(result.success).toBe(true);\n    });\n\n    it('should return success when webhooks delivered successfully', async () => {\n      const mockWebhooks = [\n        {\n          id: 'webhook-1',\n          url: 'https://example.com/webhook',\n          events: ['rsvp.submitted'],\n          secret: 'test-secret-key-12345678901234567890',\n          enabled: true,\n          retry_config: null,\n        },\n      ];\n\n      // Set up mock chain for webhook fetch, log insertion, and log update\n      mockSupabase.from\n        .mockReturnValueOnce({\n          select: jest.fn().mockReturnValue({\n            eq: jest.fn().mockReturnValue({\n              contains: jest.fn().mockResolvedValue({\n                data: mockWebhooks,\n                error: null,\n              }),\n            }),\n          }),\n        })\n        .mockReturnValueOnce({\n          insert: jest.fn().mockReturnValue({\n            select: jest.fn().mockReturnValue({\n              single: jest.fn().mockResolvedValue({\n                data: { id: 'log-123' },\n                error: null,\n              }),\n            }),\n          }),\n        })\n        .mockReturnValueOnce({\n          update: jest.fn().mockReturnValue({\n            eq: jest.fn().mockResolvedValue({ error: null }),\n          }),\n        });\n\n      const result = await sendWebhookEvent('rsvp.submitted', {\n        guestId: 'guest-123',\n        status: 'attending',\n      });\n\n      expect(result.success).toBe(true);\n      expect(global.fetch).toHaveBeenCalledWith(\n        'https://example.com/webhook',\n        expect.objectContaining({\n          method: 'POST',\n          headers: expect.objectContaining({\n            'Content-Type': 'application/json',\n            'X-Webhook-Signature': 'mocked-signature',\n            'X-Webhook-Event': 'rsvp.submitted',\n          }),\n        })\n      );\n    });\n\n    it('should return DATABASE_ERROR when fetching webhooks fails', async () => {\n      mockSupabase.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            contains: jest.fn().mockResolvedValue({\n              data: null,\n              error: { message: 'Database error' },\n            }),\n          }),\n        }),\n      });\n\n      const result = await sendWebhookEvent('rsvp.submitted', {\n        guestId: 'guest-123',\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n\n    it('should handle webhook delivery failures and schedule retries', async () => {\n      const mockWebhooks = [\n        {\n          id: 'webhook-1',\n          url: 'https://example.com/webhook',\n          events: ['rsvp.submitted'],\n          secret: 'test-secret-key-12345678901234567890',\n          enabled: true,\n          retry_config: { maxRetries: 3, baseDelay: 1000 },\n        },\n      ];\n\n      // Set up mock chain for webhook fetch, log insertion, and log update\n      mockSupabase.from\n        .mockReturnValueOnce({\n          select: jest.fn().mockReturnValue({\n            eq: jest.fn().mockReturnValue({\n              contains: jest.fn().mockResolvedValue({\n                data: mockWebhooks,\n                error: null,\n              }),\n            }),\n          }),\n        })\n        .mockReturnValueOnce({\n          insert: jest.fn().mockReturnValue({\n            select: jest.fn().mockReturnValue({\n              single: jest.fn().mockResolvedValue({\n                data: { id: 'log-123' },\n                error: null,\n              }),\n            }),\n          }),\n        })\n        .mockReturnValueOnce({\n          update: jest.fn().mockReturnValue({\n            eq: jest.fn().mockResolvedValue({ error: null }),\n          }),\n        });\n\n      (global.fetch as jest.Mock).mockResolvedValue({\n        ok: false,\n        status: 500,\n        text: jest.fn().mockResolvedValue('Internal Server Error'),\n      });\n\n      const result = await sendWebhookEvent('rsvp.submitted', {\n        guestId: 'guest-123',\n      });\n\n      expect(result.success).toBe(true);\n    });\n\n    it('should return WEBHOOK_ERROR when unexpected error occurs', async () => {\n      mockSupabase.from.mockImplementation(() => {\n        throw new Error('Unexpected error');\n      });\n\n      const result = await sendWebhookEvent('rsvp.submitted', {\n        guestId: 'guest-123',\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('WEBHOOK_ERROR');\n      }\n    });\n  });\n\n  describe('retryFailedWebhooks', () => {\n    it('should return success with retry count when failed webhooks retried', async () => {\n      const mockPendingDeliveries = [\n        {\n          id: 'log-1',\n          webhook_id: 'webhook-1',\n          event: 'rsvp.submitted',\n          payload: { event: 'rsvp.submitted', timestamp: '2024-01-01T10:00:00Z', data: {} },\n          url: 'https://example.com/webhook',\n          status: 'retrying',\n          attempts: 1,\n          next_retry_at: '2024-01-01T10:00:00Z',\n          webhooks: {\n            id: 'webhook-1',\n            url: 'https://example.com/webhook',\n            events: ['rsvp.submitted'],\n            secret: 'test-secret-key-12345678901234567890',\n            enabled: true,\n            retry_config: { maxRetries: 3, baseDelay: 1000 },\n          },\n        },\n      ];\n\n      mockSupabase.from\n        .mockReturnValueOnce({\n          select: jest.fn().mockReturnValue({\n            eq: jest.fn().mockReturnValue({\n              lte: jest.fn().mockReturnValue({\n                order: jest.fn().mockReturnValue({\n                  limit: jest.fn().mockResolvedValue({\n                    data: mockPendingDeliveries,\n                    error: null,\n                  }),\n                }),\n              }),\n            }),\n          }),\n        })\n        .mockReturnValue({\n          update: jest.fn().mockReturnValue({\n            eq: jest.fn().mockResolvedValue({ error: null }),\n          }),\n        });\n\n      (global.fetch as jest.Mock).mockResolvedValue({\n        ok: true,\n        status: 200,\n        text: jest.fn().mockResolvedValue('OK'),\n      });\n\n      const result = await retryFailedWebhooks();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.retriedCount).toBe(1);\n      }\n    });\n\n    it('should return success with zero count when no pending deliveries exist', async () => {\n      mockSupabase.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            lte: jest.fn().mockReturnValue({\n              order: jest.fn().mockReturnValue({\n                limit: jest.fn().mockResolvedValue({\n                  data: [],\n                  error: null,\n                }),\n              }),\n            }),\n          }),\n        }),\n      });\n\n      const result = await retryFailedWebhooks();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.retriedCount).toBe(0);\n      }\n    });\n\n    it('should mark deliveries as failed when max retries exceeded', async () => {\n      const mockPendingDeliveries = [\n        {\n          id: 'log-1',\n          webhook_id: 'webhook-1',\n          attempts: 5, // Exceeds max retries\n          webhooks: {\n            id: 'webhook-1',\n            enabled: true,\n            retry_config: { maxRetries: 3 },\n          },\n        },\n      ];\n\n      mockSupabase.from\n        .mockReturnValueOnce({\n          select: jest.fn().mockReturnValue({\n            eq: jest.fn().mockReturnValue({\n              lte: jest.fn().mockReturnValue({\n                order: jest.fn().mockReturnValue({\n                  limit: jest.fn().mockResolvedValue({\n                    data: mockPendingDeliveries,\n                    error: null,\n                  }),\n                }),\n              }),\n            }),\n          }),\n        })\n        .mockReturnValue({\n          update: jest.fn().mockReturnValue({\n            eq: jest.fn().mockResolvedValue({ error: null }),\n          }),\n        });\n\n      const result = await retryFailedWebhooks();\n\n      expect(result.success).toBe(true);\n    });\n\n    it('should return DATABASE_ERROR when fetching pending deliveries fails', async () => {\n      mockSupabase.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            lte: jest.fn().mockReturnValue({\n              order: jest.fn().mockReturnValue({\n                limit: jest.fn().mockResolvedValue({\n                  data: null,\n                  error: { message: 'Database error' },\n                }),\n              }),\n            }),\n          }),\n        }),\n      });\n\n      const result = await retryFailedWebhooks();\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n\n    it('should return WEBHOOK_RETRY_ERROR when unexpected error occurs', async () => {\n      mockSupabase.from.mockImplementation(() => {\n        throw new Error('Unexpected error');\n      });\n\n      const result = await retryFailedWebhooks();\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('WEBHOOK_RETRY_ERROR');\n      }\n    });\n  });\n\n  describe('validateWebhookConfig', () => {\n    it('should return success when valid webhook configuration provided', () => {\n      const validConfig = {\n        url: 'https://example.com/webhook',\n        events: ['rsvp.submitted', 'photo.uploaded'],\n        secret: 'test-secret-key-12345678901234567890',\n        enabled: true,\n        retryConfig: {\n          maxRetries: 5,\n          baseDelay: 2000,\n        },\n      };\n\n      const result = validateWebhookConfig(validConfig);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.url).toBe('https://example.com/webhook');\n        expect(result.data.events).toEqual(['rsvp.submitted', 'photo.uploaded']);\n        expect(result.data.secret).toBe('test-secret-key-12345678901234567890');\n        expect(result.data.enabled).toBe(true);\n      }\n    });\n\n    it('should return VALIDATION_ERROR when invalid URL provided', () => {\n      const invalidConfig = {\n        url: 'not-a-valid-url',\n        events: ['rsvp.submitted'],\n        secret: 'test-secret-key-12345678901234567890',\n      };\n\n      const result = validateWebhookConfig(invalidConfig);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n      }\n    });\n\n    it('should return VALIDATION_ERROR when secret is too short', () => {\n      const invalidConfig = {\n        url: 'https://example.com/webhook',\n        events: ['rsvp.submitted'],\n        secret: 'short', // Less than 32 characters\n      };\n\n      const result = validateWebhookConfig(invalidConfig);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n      }\n    });\n\n    it('should return success when events array is empty', () => {\n      const configWithEmptyEvents = {\n        url: 'https://example.com/webhook',\n        events: [], // Empty array is allowed by the schema\n        secret: 'test-secret-key-12345678901234567890',\n      };\n\n      const result = validateWebhookConfig(configWithEmptyEvents);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.events).toEqual([]);\n      }\n    });\n\n    it('should return success with default values when optional fields omitted', () => {\n      const minimalConfig = {\n        url: 'https://example.com/webhook',\n        events: ['rsvp.submitted'],\n        secret: 'test-secret-key-12345678901234567890',\n      };\n\n      const result = validateWebhookConfig(minimalConfig);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.enabled).toBe(true); // Default value\n        expect(result.data.retryConfig).toBeUndefined(); // Optional field not provided\n      }\n    });\n  });\n\n  describe('testWebhookConnectivity', () => {\n    it('should return success when webhook endpoint is reachable', async () => {\n      const config = {\n        url: 'https://example.com/webhook',\n        events: ['webhook.test'],\n        secret: 'test-secret-key-12345678901234567890',\n        enabled: true,\n      };\n\n      (global.fetch as jest.Mock).mockResolvedValue({\n        ok: true,\n        status: 200,\n        text: jest.fn().mockResolvedValue('OK'),\n      });\n\n      const result = await testWebhookConnectivity(config);\n\n      expect(result.success).toBe(true);\n      expect(global.fetch).toHaveBeenCalledWith(\n        'https://example.com/webhook',\n        expect.objectContaining({\n          method: 'POST',\n          headers: expect.objectContaining({\n            'Content-Type': 'application/json',\n            'X-Webhook-Event': 'webhook.test',\n          }),\n        })\n      );\n    });\n\n    it('should return WEBHOOK_DELIVERY_FAILED when endpoint returns error status', async () => {\n      const config = {\n        url: 'https://example.com/webhook',\n        events: ['webhook.test'],\n        secret: 'test-secret-key-12345678901234567890',\n        enabled: true,\n      };\n\n      (global.fetch as jest.Mock).mockResolvedValue({\n        ok: false,\n        status: 404,\n        text: jest.fn().mockResolvedValue('Not Found'),\n      });\n\n      const result = await testWebhookConnectivity(config);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('WEBHOOK_DELIVERY_FAILED');\n      }\n    });\n\n    it('should return WEBHOOK_TIMEOUT when request times out', async () => {\n      const config = {\n        url: 'https://example.com/webhook',\n        events: ['webhook.test'],\n        secret: 'test-secret-key-12345678901234567890',\n        enabled: true,\n      };\n\n      (global.fetch as jest.Mock).mockImplementation(() => {\n        return new Promise((_, reject) => {\n          setTimeout(() => {\n            const error = new Error('Request timed out');\n            error.name = 'AbortError';\n            reject(error);\n          }, 100);\n        });\n      });\n\n      const result = await testWebhookConnectivity(config);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('WEBHOOK_TIMEOUT');\n      }\n    });\n\n    it('should return WEBHOOK_DELIVERY_ERROR when network error occurs', async () => {\n      const config = {\n        url: 'https://example.com/webhook',\n        events: ['webhook.test'],\n        secret: 'test-secret-key-12345678901234567890',\n        enabled: true,\n      };\n\n      (global.fetch as jest.Mock).mockRejectedValue(new Error('Network error'));\n\n      const result = await testWebhookConnectivity(config);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('WEBHOOK_DELIVERY_ERROR');\n      }\n    });\n  });\n});"],"names":["jest","mock","createHmac","fn","mockReturnValue","update","mockReturnThis","digest","timingSafeEqual","supabase","mockSupabase","global","fetch","createMockSupabaseClient","describe","beforeEach","clearAllMocks","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","mockClear","it","payload","secret","signature","generateWebhookSignature","expect","toBe","require","toHaveBeenCalledWith","isValid","verifyWebhookSignature","toHaveBeenCalled","mockImplementationOnce","Error","baseDelay","delay0","calculateRetryDelay","delay1","delay2","toBeGreaterThanOrEqual","toBeLessThanOrEqual","delay","mockResolvedValue","ok","status","text","from","select","eq","contains","data","error","result","sendWebhookEvent","guestId","success","mockWebhooks","id","url","events","enabled","retry_config","mockReturnValueOnce","insert","single","objectContaining","method","headers","message","code","maxRetries","mockImplementation","mockPendingDeliveries","webhook_id","event","timestamp","attempts","next_retry_at","webhooks","lte","order","limit","retryFailedWebhooks","retriedCount","validConfig","retryConfig","validateWebhookConfig","toEqual","invalidConfig","configWithEmptyEvents","minimalConfig","toBeUndefined","config","testWebhookConnectivity","Promise","_","reject","setTimeout","name","mockRejectedValue"],"mappings":"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"}