{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/lib/supabaseServer.ts"],"sourcesContent":["/**\n * Supabase Server Client Utilities\n * \n * Helper functions for creating Supabase clients in Next.js 15+ API routes\n * with proper async cookies() handling.\n */\n\nimport { createServerClient } from '@supabase/ssr';\nimport { cookies } from 'next/headers';\n\n/**\n * Creates an authenticated Supabase client for API routes.\n * \n * This function properly handles the Next.js 15+ async cookies() API\n * and creates a Supabase client with cookie-based authentication.\n * \n * @returns Promise resolving to an authenticated Supabase client\n * \n * @example\n * ```typescript\n * export async function GET(request: Request) {\n *   const supabase = await createAuthenticatedClient();\n *   const { data: { session } } = await supabase.auth.getSession();\n *   // ... rest of route logic\n * }\n * ```\n */\nexport async function createAuthenticatedClient() {\n  const cookieStore = await cookies();\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll();\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options);\n            });\n          } catch (error) {\n            // Handle cookie setting errors (e.g., in middleware)\n            console.error('Error setting cookies:', error);\n          }\n        },\n      },\n    }\n  );\n}\n\n/**\n * Creates a Supabase client with service role privileges.\n * \n * IMPORTANT: This client bypasses Row Level Security (RLS) and should only be used\n * in server-side code after proper authentication and authorization checks.\n * \n * Use this for:\n * - Admin operations that need to bypass RLS\n * - Background jobs and cron tasks\n * - Operations where RLS policies would cause circular dependencies\n * \n * @returns Supabase client with service role privileges\n * \n * @example\n * ```typescript\n * export async function GET(request: Request) {\n *   // First verify user is authenticated and authorized\n *   const authClient = await createAuthenticatedClient();\n *   const { data: { session } } = await supabase.auth.getSession();\n *   if (!session) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n *   \n *   // Then use service role for operations that need to bypass RLS\n *   const serviceClient = createServiceRoleClient();\n *   const { data } = await serviceClient.from('guests').select('*');\n * }\n * ```\n */\nexport function createServiceRoleClient() {\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n  if (!supabaseUrl || !supabaseServiceKey) {\n    throw new Error(\n      'Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY'\n    );\n  }\n\n  return createServerClient(supabaseUrl, supabaseServiceKey, {\n    cookies: {\n      getAll() {\n        return [];\n      },\n      setAll() {\n        // Service role client doesn't need cookies\n      },\n    },\n  });\n}\n"],"names":["createAuthenticatedClient","createServiceRoleClient","cookieStore","cookies","createServerClient","process","env","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","getAll","setAll","cookiesToSet","forEach","name","value","options","set","error","console","supabaseUrl","supabaseServiceKey","SUPABASE_SERVICE_ROLE_KEY","Error"],"mappings":"AAAA;;;;;CAKC;;;;;;;;;;;QAsBqBA;eAAAA;;QAqDNC;eAAAA;;;qBAzEmB;yBACX;AAmBjB,eAAeD;IACpB,MAAME,cAAc,MAAMC,IAAAA,gBAAO;IAEjC,OAAOC,IAAAA,uBAAkB,EACvBC,QAAQC,GAAG,CAACC,wBAAwB,EACpCF,QAAQC,GAAG,CAACE,6BAA6B,EACzC;QACEL,SAAS;YACPM;gBACE,OAAOP,YAAYO,MAAM;YAC3B;YACAC,QAAOC,YAAY;gBACjB,IAAI;oBACFA,aAAaC,OAAO,CAAC,CAAC,EAAEC,IAAI,EAAEC,KAAK,EAAEC,OAAO,EAAE;wBAC5Cb,YAAYc,GAAG,CAACH,MAAMC,OAAOC;oBAC/B;gBACF,EAAE,OAAOE,OAAO;oBACd,qDAAqD;oBACrDC,QAAQD,KAAK,CAAC,0BAA0BA;gBAC1C;YACF;QACF;IACF;AAEJ;AA6BO,SAAShB;IACd,MAAMkB,cAAcd,QAAQC,GAAG,CAACC,wBAAwB;IACxD,MAAMa,qBAAqBf,QAAQC,GAAG,CAACe,yBAAyB;IAEhE,IAAI,CAACF,eAAe,CAACC,oBAAoB;QACvC,MAAM,IAAIE,MACR;IAEJ;IAEA,OAAOlB,IAAAA,uBAAkB,EAACe,aAAaC,oBAAoB;QACzDjB,SAAS;YACPM;gBACE,OAAO,EAAE;YACX;YACAC;YACE,2CAA2C;YAC7C;QACF;IACF;AACF"}