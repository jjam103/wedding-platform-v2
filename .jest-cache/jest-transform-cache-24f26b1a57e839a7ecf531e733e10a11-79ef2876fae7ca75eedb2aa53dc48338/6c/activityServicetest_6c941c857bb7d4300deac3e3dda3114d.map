{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/activityService.test.ts"],"sourcesContent":["/**\n * Test Suite: Activity Service\n * \n * Tests for activity management service including capacity management\n * and RSVP operations integration.\n * \n * Follows the 4-path testing pattern:\n * 1. Success path - Valid input returns success\n * 2. Validation error - Invalid input returns VALIDATION_ERROR\n * 3. Database error - DB failure returns DATABASE_ERROR\n * 4. Security - Malicious input is sanitized\n */\n\nimport * as activityService from './activityService';\nimport { createMockSupabaseClient, createMockBuilder } from '../__tests__/helpers/mockSupabase';\nimport type { MockSupabaseClient } from '../__tests__/helpers/mockSupabase';\n\n// Mock Supabase\njest.mock('@supabase/supabase-js', () => ({\n  createClient: jest.fn(),\n}));\n\ndescribe('activityService', () => {\n  let mockSupabase: MockSupabaseClient;\n  let mockBuilder: ReturnType<typeof createMockBuilder>;\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient();\n    mockBuilder = createMockBuilder(mockSupabase);\n    \n    // Mock createClient to return our mock\n    const { createClient } = require('@supabase/supabase-js');\n    createClient.mockReturnValue(mockSupabase);\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n  });\n\n  describe('create', () => {\n    const validActivityData = {\n      name: 'Beach Volleyball',\n      activityType: 'activity',\n      startTime: '2025-06-15T10:00:00Z',\n      capacity: 20,\n      costPerPerson: 50,\n      hostSubsidy: 10,\n    };\n\n    it('should return success with activity data when valid input provided', async () => {\n      const expectedActivity = {\n        id: 'activity-1',\n        name: 'Beach Volleyball',\n        activity_type: 'activity',\n        start_time: '2025-06-15T10:00:00Z',\n        capacity: 20,\n        cost_per_person: 50,\n        host_subsidy: 10,\n        created_at: '2024-01-01T00:00:00Z',\n        updated_at: '2024-01-01T00:00:00Z',\n      };\n\n      mockBuilder.mockInsert('activities', expectedActivity);\n\n      const result = await activityService.create(validActivityData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('activity-1');\n        expect(result.data.name).toBe('Beach Volleyball');\n        expect(result.data.activityType).toBe('activity');\n        expect(result.data.capacity).toBe(20);\n      }\n      expect(mockSupabase.from).toHaveBeenCalledWith('activities');\n      expect(mockSupabase.insert).toHaveBeenCalled();\n    });\n\n    it('should return VALIDATION_ERROR when required fields are missing', async () => {\n      const invalidData = {\n        name: '',\n        activityType: 'activity',\n        startTime: '2025-06-15T10:00:00Z',\n      };\n\n      const result = await activityService.create(invalidData as any);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n        expect(result.error.message).toBe('Validation failed');\n        expect(result.error.details).toBeDefined();\n      }\n    });\n\n    it('should return VALIDATION_ERROR when end time is before start time', async () => {\n      const invalidData = {\n        ...validActivityData,\n        startTime: '2025-06-15T10:00:00Z',\n        endTime: '2025-06-15T09:00:00Z', // Before start time\n      };\n\n      const result = await activityService.create(invalidData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n        expect(result.error.message).toBe('Validation failed');\n      }\n    });\n\n    it('should return DATABASE_ERROR when insert fails', async () => {\n      mockBuilder.mockDatabaseError('Connection failed');\n\n      const result = await activityService.create(validActivityData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n        expect(result.error.message).toBe('Connection failed');\n      }\n    });\n\n    it('should sanitize input to prevent XSS attacks', async () => {\n      const maliciousData = {\n        ...validActivityData,\n        name: '<script>alert(\"xss\")</script>Beach Volleyball',\n        description: '<img src=x onerror=alert(1)>Fun activity',\n      };\n\n      const sanitizedActivity = {\n        id: 'activity-1',\n        name: 'Beach Volleyball',\n        description: 'Fun activity',\n        activity_type: 'activity',\n        start_time: '2025-06-15T10:00:00Z',\n        capacity: 20,\n        created_at: '2024-01-01T00:00:00Z',\n        updated_at: '2024-01-01T00:00:00Z',\n      };\n\n      mockBuilder.mockInsert('activities', sanitizedActivity);\n\n      const result = await activityService.create(maliciousData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.name).not.toContain('<script>');\n        expect(result.data.name).not.toContain('alert');\n        expect(result.data.description).not.toContain('<img');\n        expect(result.data.description).not.toContain('onerror');\n      }\n    });\n  });\n\n  describe('get', () => {\n    it('should return success with activity data when activity exists', async () => {\n      const activityData = {\n        id: 'activity-1',\n        name: 'Beach Volleyball',\n        activity_type: 'activity',\n        start_time: '2025-06-15T10:00:00Z',\n        capacity: 20,\n        created_at: '2024-01-01T00:00:00Z',\n        updated_at: '2024-01-01T00:00:00Z',\n      };\n\n      mockBuilder.mockSelectSingle('activities', activityData);\n\n      const result = await activityService.get('activity-1');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('activity-1');\n        expect(result.data.name).toBe('Beach Volleyball');\n        expect(result.data.activityType).toBe('activity');\n      }\n      expect(mockSupabase.from).toHaveBeenCalledWith('activities');\n      expect(mockSupabase.eq).toHaveBeenCalledWith('id', 'activity-1');\n    });\n\n    it('should return NOT_FOUND when activity does not exist', async () => {\n      const error = { code: 'PGRST116', message: 'No rows found' };\n      mockBuilder.mockSelectSingle('activities', null, error);\n\n      const result = await activityService.get('nonexistent-id');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('NOT_FOUND');\n        expect(result.error.message).toBe('Activity not found');\n      }\n    });\n\n    it('should return DATABASE_ERROR when database query fails', async () => {\n      const error = { message: 'Connection timeout', code: 'DATABASE_ERROR' };\n      mockBuilder.mockSelectSingle('activities', null, error);\n\n      const result = await activityService.get('activity-1');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n        expect(result.error.message).toBe('Connection timeout');\n      }\n    });\n  });\n\n  describe('update', () => {\n    const updateData = {\n      name: 'Updated Beach Volleyball',\n      capacity: 25,\n    };\n\n    it('should return success with updated activity data when valid input provided', async () => {\n      const updatedActivity = {\n        id: 'activity-1',\n        name: 'Updated Beach Volleyball',\n        activity_type: 'activity',\n        start_time: '2025-06-15T10:00:00Z',\n        capacity: 25,\n        updated_at: '2024-01-01T01:00:00Z',\n      };\n\n      mockBuilder.mockUpdate('activities', updatedActivity);\n\n      const result = await activityService.update('activity-1', updateData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.name).toBe('Updated Beach Volleyball');\n        expect(result.data.capacity).toBe(25);\n      }\n      expect(mockSupabase.from).toHaveBeenCalledWith('activities');\n      expect(mockSupabase.update).toHaveBeenCalled();\n      expect(mockSupabase.eq).toHaveBeenCalledWith('id', 'activity-1');\n    });\n\n    it('should return NOT_FOUND when activity does not exist', async () => {\n      const error = { code: 'PGRST116', message: 'No rows found' };\n      mockBuilder.mockUpdate('activities', null, error);\n\n      const result = await activityService.update('nonexistent-id', updateData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('NOT_FOUND');\n        expect(result.error.message).toBe('Activity not found');\n      }\n    });\n\n    it('should return VALIDATION_ERROR when update data is invalid', async () => {\n      const invalidData = {\n        capacity: -5, // Negative capacity\n      };\n\n      const result = await activityService.update('activity-1', invalidData as any);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n        expect(result.error.message).toBe('Validation failed');\n      }\n    });\n\n    it('should sanitize input to prevent XSS attacks', async () => {\n      const maliciousData = {\n        name: '<script>alert(\"xss\")</script>Updated Activity',\n        description: 'javascript:alert(1)',\n      };\n\n      const sanitizedActivity = {\n        id: 'activity-1',\n        name: 'Updated Activity',\n        description: 'javascriptalert1',\n        activity_type: 'activity',\n        updated_at: '2024-01-01T01:00:00Z',\n      };\n\n      mockBuilder.mockUpdate('activities', sanitizedActivity);\n\n      const result = await activityService.update('activity-1', maliciousData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.name).not.toContain('<script>');\n        expect(result.data.name).not.toContain('alert');\n        expect(result.data.description).not.toContain('javascript:');\n      }\n    });\n  });\n\n  describe('deleteActivity', () => {\n    it('should return success when activity is deleted successfully', async () => {\n      mockBuilder.mockDelete('activities');\n\n      const result = await activityService.deleteActivity('activity-1');\n\n      expect(result.success).toBe(true);\n      expect(result.data).toBeUndefined();\n      expect(mockSupabase.from).toHaveBeenCalledWith('activities');\n      expect(mockSupabase.delete).toHaveBeenCalled();\n      expect(mockSupabase.eq).toHaveBeenCalledWith('id', 'activity-1');\n    });\n\n    it('should return DATABASE_ERROR when delete fails', async () => {\n      mockBuilder.mockDatabaseError('Foreign key constraint violation');\n\n      const result = await activityService.deleteActivity('activity-1');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n        expect(result.error.message).toBe('Foreign key constraint violation');\n      }\n    });\n  });\n\n  describe('list', () => {\n    const mockActivities = [\n      {\n        id: 'activity-1',\n        name: 'Beach Volleyball',\n        activity_type: 'activity',\n        start_time: '2025-06-15T10:00:00Z',\n        capacity: 20,\n      },\n      {\n        id: 'activity-2',\n        name: 'Sunset Dinner',\n        activity_type: 'meal',\n        start_time: '2025-06-15T18:00:00Z',\n        capacity: 50,\n      },\n    ];\n\n    it('should return success with paginated activities when no filters provided', async () => {\n      mockSupabase.from.mockReturnValue(mockSupabase);\n      mockSupabase.select.mockReturnValue(mockSupabase);\n      mockSupabase.order.mockReturnValue(mockSupabase);\n      mockSupabase.range.mockResolvedValue({\n        data: mockActivities,\n        error: null,\n        count: 2,\n      });\n\n      const result = await activityService.list();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.activities).toHaveLength(2);\n        expect(result.data.total).toBe(2);\n        expect(result.data.page).toBe(1);\n        expect(result.data.pageSize).toBe(50);\n        expect(result.data.totalPages).toBe(1);\n      }\n      expect(mockSupabase.from).toHaveBeenCalledWith('activities');\n      expect(mockSupabase.select).toHaveBeenCalledWith('*', { count: 'exact' });\n    });\n\n    it('should return success with filtered activities when filters provided', async () => {\n      const filters = {\n        eventId: '123e4567-e89b-12d3-a456-426614174000', // Valid UUID\n        activityType: 'activity',\n        status: 'published' as const,\n        page: 1,\n        pageSize: 10,\n      };\n\n      mockSupabase.from.mockReturnValue(mockSupabase);\n      mockSupabase.select.mockReturnValue(mockSupabase);\n      mockSupabase.eq.mockReturnValue(mockSupabase);\n      mockSupabase.order.mockReturnValue(mockSupabase);\n      mockSupabase.range.mockResolvedValue({\n        data: [mockActivities[0]],\n        error: null,\n        count: 1,\n      });\n\n      const result = await activityService.list(filters);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.activities).toHaveLength(1);\n        expect(result.data.page).toBe(1);\n        expect(result.data.pageSize).toBe(10);\n      }\n      expect(mockSupabase.eq).toHaveBeenCalledWith('event_id', '123e4567-e89b-12d3-a456-426614174000');\n      expect(mockSupabase.eq).toHaveBeenCalledWith('activity_type', 'activity');\n      expect(mockSupabase.eq).toHaveBeenCalledWith('status', 'published');\n    });\n\n    it('should return VALIDATION_ERROR when invalid filters provided', async () => {\n      const invalidFilters = {\n        page: -1, // Invalid page number\n        pageSize: 200, // Exceeds maximum\n      };\n\n      const result = await activityService.list(invalidFilters);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n        expect(result.error.message).toBe('Validation failed');\n      }\n    });\n\n    it('should return DATABASE_ERROR when query fails', async () => {\n      const error = { message: 'Query timeout', code: 'DATABASE_ERROR' };\n      \n      mockSupabase.from.mockReturnValue(mockSupabase);\n      mockSupabase.select.mockReturnValue(mockSupabase);\n      mockSupabase.order.mockReturnValue(mockSupabase);\n      mockSupabase.range.mockResolvedValue({\n        data: null,\n        error,\n        count: null,\n      });\n\n      const result = await activityService.list();\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n        expect(result.error.message).toBe('Query timeout');\n      }\n    });\n  });\n\n  describe('search', () => {\n    const mockSearchResults = [\n      {\n        id: 'activity-1',\n        name: 'Beach Volleyball',\n        description: 'Fun beach activity',\n        activity_type: 'activity',\n        start_time: '2025-06-15T10:00:00Z',\n      },\n    ];\n\n    it('should return success with search results when valid query provided', async () => {\n      const searchParams = {\n        query: 'beach',\n        page: 1,\n        pageSize: 20,\n      };\n\n      mockSupabase.from.mockReturnValue(mockSupabase);\n      mockSupabase.select.mockReturnValue(mockSupabase);\n      mockSupabase.or.mockReturnValue(mockSupabase);\n      mockSupabase.order.mockReturnValue(mockSupabase);\n      mockSupabase.range.mockResolvedValue({\n        data: mockSearchResults,\n        error: null,\n        count: 1,\n      });\n\n      const result = await activityService.search(searchParams);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.activities).toHaveLength(1);\n        expect(result.data.activities[0].name).toBe('Beach Volleyball');\n      }\n      expect(mockSupabase.or).toHaveBeenCalledWith('name.ilike.%beach%,description.ilike.%beach%');\n    });\n\n    it('should return VALIDATION_ERROR when query is empty', async () => {\n      const invalidParams = {\n        query: '',\n      };\n\n      const result = await activityService.search(invalidParams);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n        expect(result.error.message).toBe('Validation failed');\n      }\n    });\n\n    it('should sanitize search query to prevent injection attacks', async () => {\n      const maliciousParams = {\n        query: '<script>alert(\"xss\")</script>',\n      };\n\n      mockSupabase.from.mockReturnValue(mockSupabase);\n      mockSupabase.select.mockReturnValue(mockSupabase);\n      mockSupabase.or.mockReturnValue(mockSupabase);\n      mockSupabase.order.mockReturnValue(mockSupabase);\n      mockSupabase.range.mockResolvedValue({\n        data: [],\n        error: null,\n        count: 0,\n      });\n\n      const result = await activityService.search(maliciousParams);\n\n      expect(result.success).toBe(true);\n      // Verify the query was sanitized (no script tags in the database query)\n      expect(mockSupabase.or).toHaveBeenCalledWith(\n        expect.not.stringContaining('<script>')\n      );\n    });\n  });\n\n  describe('getCapacityInfo - Capacity Management', () => {\n    it('should return success with capacity information when activity exists', async () => {\n      const activityData = {\n        id: 'activity-1',\n        name: 'Beach Volleyball',\n        capacity: 20,\n      };\n\n      // Mock activity query\n      mockSupabase.from.mockReturnValueOnce(mockSupabase);\n      mockSupabase.select.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockReturnValueOnce(mockSupabase);\n      mockSupabase.single.mockResolvedValueOnce({\n        data: activityData,\n        error: null,\n      });\n\n      // Mock RSVP count query\n      mockSupabase.from.mockReturnValueOnce(mockSupabase);\n      mockSupabase.select.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockResolvedValueOnce({\n        count: 15,\n        error: null,\n      });\n\n      const result = await activityService.getCapacityInfo('activity-1');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.activityId).toBe('activity-1');\n        expect(result.data.activityName).toBe('Beach Volleyball');\n        expect(result.data.capacity).toBe(20);\n        expect(result.data.currentAttendees).toBe(15);\n        expect(result.data.availableSpots).toBe(5);\n        expect(result.data.utilizationPercentage).toBe(75);\n        expect(result.data.isNearCapacity).toBe(false);\n        expect(result.data.isAtCapacity).toBe(false);\n      }\n    });\n\n    it('should return capacity info with near capacity warning when utilization >= 90%', async () => {\n      const activityData = {\n        id: 'activity-1',\n        name: 'Beach Volleyball',\n        capacity: 20,\n      };\n\n      // Mock activity query\n      mockSupabase.from.mockReturnValueOnce(mockSupabase);\n      mockSupabase.select.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockReturnValueOnce(mockSupabase);\n      mockSupabase.single.mockResolvedValueOnce({\n        data: activityData,\n        error: null,\n      });\n\n      // Mock RSVP count query - 18 attendees (90% capacity)\n      mockSupabase.from.mockReturnValueOnce(mockSupabase);\n      mockSupabase.select.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockResolvedValueOnce({\n        count: 18,\n        error: null,\n      });\n\n      const result = await activityService.getCapacityInfo('activity-1');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.currentAttendees).toBe(18);\n        expect(result.data.availableSpots).toBe(2);\n        expect(result.data.utilizationPercentage).toBe(90);\n        expect(result.data.isNearCapacity).toBe(true);\n        expect(result.data.isAtCapacity).toBe(false);\n      }\n    });\n\n    it('should return capacity info with at capacity alert when utilization >= 100%', async () => {\n      const activityData = {\n        id: 'activity-1',\n        name: 'Beach Volleyball',\n        capacity: 20,\n      };\n\n      // Mock activity query\n      mockSupabase.from.mockReturnValueOnce(mockSupabase);\n      mockSupabase.select.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockReturnValueOnce(mockSupabase);\n      mockSupabase.single.mockResolvedValueOnce({\n        data: activityData,\n        error: null,\n      });\n\n      // Mock RSVP count query - 20 attendees (100% capacity)\n      mockSupabase.from.mockReturnValueOnce(mockSupabase);\n      mockSupabase.select.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockResolvedValueOnce({\n        count: 20,\n        error: null,\n      });\n\n      const result = await activityService.getCapacityInfo('activity-1');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.currentAttendees).toBe(20);\n        expect(result.data.availableSpots).toBe(0);\n        expect(result.data.utilizationPercentage).toBe(100);\n        expect(result.data.isNearCapacity).toBe(true);\n        expect(result.data.isAtCapacity).toBe(true);\n      }\n    });\n\n    it('should handle activities with no capacity limit', async () => {\n      const activityData = {\n        id: 'activity-1',\n        name: 'Beach Volleyball',\n        capacity: null, // No capacity limit\n      };\n\n      // Mock activity query\n      mockSupabase.from.mockReturnValueOnce(mockSupabase);\n      mockSupabase.select.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockReturnValueOnce(mockSupabase);\n      mockSupabase.single.mockResolvedValueOnce({\n        data: activityData,\n        error: null,\n      });\n\n      // Mock RSVP count query\n      mockSupabase.from.mockReturnValueOnce(mockSupabase);\n      mockSupabase.select.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockResolvedValueOnce({\n        count: 50,\n        error: null,\n      });\n\n      const result = await activityService.getCapacityInfo('activity-1');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.capacity).toBeNull();\n        expect(result.data.currentAttendees).toBe(50);\n        expect(result.data.availableSpots).toBeNull();\n        expect(result.data.utilizationPercentage).toBeNull();\n        expect(result.data.isNearCapacity).toBe(false);\n        expect(result.data.isAtCapacity).toBe(false);\n      }\n    });\n\n    it('should return NOT_FOUND when activity does not exist', async () => {\n      const error = { code: 'PGRST116', message: 'No rows found' };\n      \n      mockSupabase.from.mockReturnValueOnce(mockSupabase);\n      mockSupabase.select.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockReturnValueOnce(mockSupabase);\n      mockSupabase.single.mockResolvedValueOnce({\n        data: null,\n        error,\n      });\n\n      const result = await activityService.getCapacityInfo('nonexistent-id');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('NOT_FOUND');\n        expect(result.error.message).toBe('Activity not found');\n      }\n    });\n\n    it('should return DATABASE_ERROR when RSVP count query fails', async () => {\n      const activityData = {\n        id: 'activity-1',\n        name: 'Beach Volleyball',\n        capacity: 20,\n      };\n\n      // Mock successful activity query\n      mockSupabase.from.mockReturnValueOnce(mockSupabase);\n      mockSupabase.select.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockReturnValueOnce(mockSupabase);\n      mockSupabase.single.mockResolvedValueOnce({\n        data: activityData,\n        error: null,\n      });\n\n      // Mock failed RSVP count query\n      mockSupabase.from.mockReturnValueOnce(mockSupabase);\n      mockSupabase.select.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockReturnValueOnce(mockSupabase);\n      mockSupabase.eq.mockResolvedValueOnce({\n        count: null,\n        error: { message: 'Connection timeout' },\n      });\n\n      const result = await activityService.getCapacityInfo('activity-1');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n        expect(result.error.message).toBe('Connection timeout');\n      }\n    });\n  });\n\n  describe('calculateNetCost - Cost Management', () => {\n    it('should return success with net cost when activity exists', async () => {\n      const activityData = {\n        cost_per_person: 100,\n        host_subsidy: 25,\n      };\n\n      mockBuilder.mockSelectSingle('activities', activityData);\n\n      const result = await activityService.calculateNetCost('activity-1');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toBe(75); // 100 - 25 = 75\n      }\n      expect(mockSupabase.from).toHaveBeenCalledWith('activities');\n      expect(mockSupabase.select).toHaveBeenCalledWith('cost_per_person, host_subsidy');\n    });\n\n    it('should return zero when host subsidy exceeds cost per person', async () => {\n      const activityData = {\n        cost_per_person: 50,\n        host_subsidy: 75, // Exceeds cost\n      };\n\n      mockBuilder.mockSelectSingle('activities', activityData);\n\n      const result = await activityService.calculateNetCost('activity-1');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toBe(0); // Max(0, 50 - 75) = 0\n      }\n    });\n\n    it('should handle null values correctly', async () => {\n      const activityData = {\n        cost_per_person: null,\n        host_subsidy: null,\n      };\n\n      mockBuilder.mockSelectSingle('activities', activityData);\n\n      const result = await activityService.calculateNetCost('activity-1');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toBe(0); // 0 - 0 = 0\n      }\n    });\n\n    it('should return NOT_FOUND when activity does not exist', async () => {\n      const error = { code: 'PGRST116', message: 'No rows found' };\n      mockBuilder.mockSelectSingle('activities', null, error);\n\n      const result = await activityService.calculateNetCost('nonexistent-id');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('NOT_FOUND');\n        expect(result.error.message).toBe('Activity not found');\n      }\n    });\n\n    it('should return DATABASE_ERROR when query fails', async () => {\n      const error = { message: 'Connection failed', code: 'DATABASE_ERROR' };\n      mockBuilder.mockSelectSingle('activities', null, error);\n\n      const result = await activityService.calculateNetCost('activity-1');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n        expect(result.error.message).toBe('Connection failed');\n      }\n    });\n  });\n});"],"names":["jest","mock","createClient","fn","describe","mockSupabase","mockBuilder","beforeEach","createMockSupabaseClient","createMockBuilder","require","mockReturnValue","afterEach","clearAllMocks","validActivityData","name","activityType","startTime","capacity","costPerPerson","hostSubsidy","it","expectedActivity","id","activity_type","start_time","cost_per_person","host_subsidy","created_at","updated_at","mockInsert","result","activityService","create","expect","success","toBe","data","from","toHaveBeenCalledWith","insert","toHaveBeenCalled","invalidData","error","code","message","details","toBeDefined","endTime","mockDatabaseError","maliciousData","description","sanitizedActivity","not","toContain","activityData","mockSelectSingle","get","eq","updateData","updatedActivity","mockUpdate","update","mockDelete","deleteActivity","toBeUndefined","delete","mockActivities","select","order","range","mockResolvedValue","count","list","activities","toHaveLength","total","page","pageSize","totalPages","filters","eventId","status","invalidFilters","mockSearchResults","searchParams","query","or","search","invalidParams","maliciousParams","stringContaining","mockReturnValueOnce","single","mockResolvedValueOnce","getCapacityInfo","activityId","activityName","currentAttendees","availableSpots","utilizationPercentage","isNearCapacity","isAtCapacity","toBeNull","calculateNetCost"],"mappings":"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"}