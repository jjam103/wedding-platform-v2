{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/rsvps/export/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { z } from 'zod';\nimport { withAuth, errorResponse } from '@/lib/apiHelpers';\nimport { rateLimitMiddleware, RATE_LIMITS, getRateLimitHeaders } from '@/lib/rateLimit';\nimport * as rsvpManagementService from '@/services/rsvpManagementService';\n\n/**\n * GET /api/admin/rsvps/export\n * \n * Export RSVPs to CSV format with filtering support\n * \n * Query Parameters:\n * - eventId: string (UUID) - Filter by event\n * - activityId: string (UUID) - Filter by activity\n * - status: 'pending' | 'attending' | 'declined' | 'maybe' - Filter by status\n * - guestId: string (UUID) - Filter by guest\n * - searchQuery: string (max 100 chars) - Search guest name/email\n * \n * Returns:\n * - CSV file download with RSVP data\n * \n * Rate Limit: 1 request per minute per user\n * \n * **Validates: Requirements 6.4**\n */\n\n// Query parameter validation schema\nconst queryParamsSchema = z.object({\n  eventId: z.string().uuid().optional(),\n  activityId: z.string().uuid().optional(),\n  status: z.enum(['pending', 'attending', 'declined', 'maybe']).optional(),\n  guestId: z.string().uuid().optional(),\n  searchQuery: z.string().max(100).optional(),\n});\n\n/**\n * Map error codes to HTTP status codes\n */\nfunction getStatusCode(errorCode: string): number {\n  const statusMap: Record<string, number> = {\n    'VALIDATION_ERROR': 400,\n    'INVALID_INPUT': 400,\n    'UNAUTHORIZED': 401,\n    'AUTHENTICATION_REQUIRED': 401,\n    'FORBIDDEN': 403,\n    'NOT_FOUND': 404,\n    'DATABASE_ERROR': 500,\n    'INTERNAL_ERROR': 500,\n    'UNKNOWN_ERROR': 500,\n    'RATE_LIMIT_EXCEEDED': 429,\n  };\n  \n  return statusMap[errorCode] || 500;\n}\n\nexport async function GET(request: Request) {\n  return withAuth(async (userId) => {\n    try {\n      // 1. Rate limiting - 1 request per minute per user\n      const rateLimitResult = rateLimitMiddleware(\n        userId,\n        'api:rsvps:export',\n        { maxRequests: 1, windowMs: 60 * 1000 } // 1 request per minute\n      );\n\n      if (!rateLimitResult.success) {\n        const details = rateLimitResult.error.details as any;\n        const headers = getRateLimitHeaders({\n          allowed: false,\n          limit: details?.limit || 1,\n          remaining: details?.remaining || 0,\n          reset: details?.reset || Math.floor(Date.now() / 1000) + 60,\n          retryAfter: details?.retryAfter,\n        });\n\n        return NextResponse.json(\n          rateLimitResult,\n          { \n            status: 429,\n            headers,\n          }\n        );\n      }\n\n      // 2. Parse and validate query parameters\n      const { searchParams } = new URL(request.url);\n      \n      // Build query object, filtering out null values\n      const queryParams: Record<string, string> = {};\n      \n      const eventIdParam = searchParams.get('eventId');\n      const activityIdParam = searchParams.get('activityId');\n      const statusParam = searchParams.get('status');\n      const guestIdParam = searchParams.get('guestId');\n      const searchQueryParam = searchParams.get('searchQuery');\n      \n      if (eventIdParam !== null) queryParams.eventId = eventIdParam;\n      if (activityIdParam !== null) queryParams.activityId = activityIdParam;\n      if (statusParam !== null) queryParams.status = statusParam;\n      if (guestIdParam !== null) queryParams.guestId = guestIdParam;\n      if (searchQueryParam !== null) queryParams.searchQuery = searchQueryParam;\n      \n      const queryValidation = queryParamsSchema.safeParse(queryParams);\n\n      if (!queryValidation.success) {\n        return errorResponse(\n          'VALIDATION_ERROR',\n          'Invalid query parameters',\n          400,\n          { fields: queryValidation.error.issues }\n        );\n      }\n\n      const filters = queryValidation.data;\n\n      // 3. Call service layer to generate CSV\n      const result = await rsvpManagementService.exportRSVPsToCSV(filters);\n\n      // 4. Handle service errors\n      if (!result.success) {\n        return errorResponse(\n          result.error.code,\n          result.error.message,\n          getStatusCode(result.error.code),\n          result.error.details\n        );\n      }\n\n      // 5. Return CSV file as download\n      const csv = result.data;\n      const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD\n      const filename = `rsvps-export-${timestamp}.csv`;\n\n      // Add rate limit headers to successful response\n      const rateLimitHeaders = getRateLimitHeaders(rateLimitResult.data);\n\n      return new NextResponse(csv, {\n        status: 200,\n        headers: {\n          'Content-Type': 'text/csv; charset=utf-8',\n          'Content-Disposition': `attachment; filename=\"${filename}\"`,\n          'Cache-Control': 'no-cache, no-store, must-revalidate',\n          ...rateLimitHeaders,\n        },\n      });\n\n    } catch (error) {\n      console.error('GET /api/admin/rsvps/export error:', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n        stack: error instanceof Error ? error.stack : undefined,\n      });\n      \n      return errorResponse(\n        'INTERNAL_ERROR',\n        'Failed to export RSVPs',\n        500\n      );\n    }\n  });\n}\n"],"names":["GET","queryParamsSchema","z","object","eventId","string","uuid","optional","activityId","status","enum","guestId","searchQuery","max","getStatusCode","errorCode","statusMap","request","withAuth","userId","rateLimitResult","rateLimitMiddleware","maxRequests","windowMs","success","details","error","headers","getRateLimitHeaders","allowed","limit","remaining","reset","Math","floor","Date","now","retryAfter","NextResponse","json","searchParams","URL","url","queryParams","eventIdParam","get","activityIdParam","statusParam","guestIdParam","searchQueryParam","queryValidation","safeParse","errorResponse","fields","issues","filters","data","result","rsvpManagementService","exportRSVPsToCSV","code","message","csv","timestamp","toISOString","split","filename","rateLimitHeaders","console","Error","stack","undefined"],"mappings":"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"}