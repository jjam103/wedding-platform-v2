{"version":3,"names":["cov_z879ubex7","actualCoverage","s","POST","request","f","signature","headers","get","timestamp","webhookId","b","_server","NextResponse","json","success","error","code","message","status","body","text","webhookSecret","process","env","RESEND_WEBHOOK_SECRET","console","signedContent","isValid","_webhookService","verifyWebhookSignature","payload","JSON","parse","type","data","supabase","_supabasejs","createClient","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","emailId","email_id","deliveryStatus","errorMessage","reason","warn","updateData","delivery_status","delivered_at","Date","toISOString","error_message","updateError","from","update","eq","details","insert","webhook_id","event","url","attempts","last_attempt_at","response_status","Error"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/webhooks/resend/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport { verifyWebhookSignature } from '@/services/webhookService';\n\n/**\n * POST /api/webhooks/resend\n * \n * Handles webhook callbacks from Resend email service.\n * Updates email delivery status based on webhook events.\n * \n * Webhook events:\n * - email.sent: Email was accepted by the recipient's mail server\n * - email.delivered: Email was successfully delivered\n * - email.delivery_delayed: Email delivery was delayed\n * - email.bounced: Email bounced (hard or soft bounce)\n * - email.complained: Recipient marked email as spam\n * - email.opened: Recipient opened the email\n * - email.clicked: Recipient clicked a link in the email\n */\nexport async function POST(request: Request) {\n  try {\n    // 1. Verify webhook signature\n    const signature = request.headers.get('svix-signature');\n    const timestamp = request.headers.get('svix-timestamp');\n    const webhookId = request.headers.get('svix-id');\n\n    if (!signature || !timestamp || !webhookId) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'MISSING_HEADERS',\n            message: 'Missing required webhook headers',\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    const body = await request.text();\n    const webhookSecret = process.env.RESEND_WEBHOOK_SECRET;\n\n    if (!webhookSecret) {\n      console.error('RESEND_WEBHOOK_SECRET not configured');\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'CONFIGURATION_ERROR',\n            message: 'Webhook secret not configured',\n          },\n        },\n        { status: 500 }\n      );\n    }\n\n    // Verify signature\n    const signedContent = `${webhookId}.${timestamp}.${body}`;\n    const isValid = verifyWebhookSignature(signedContent, signature, webhookSecret);\n\n    if (!isValid) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'INVALID_SIGNATURE',\n            message: 'Webhook signature verification failed',\n          },\n        },\n        { status: 401 }\n      );\n    }\n\n    // 2. Parse webhook payload\n    const payload = JSON.parse(body);\n    const { type, data } = payload;\n\n    if (!type || !data) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'INVALID_PAYLOAD',\n            message: 'Invalid webhook payload',\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    // 3. Initialize Supabase client\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    );\n\n    // 4. Process webhook event\n    const emailId = data.email_id;\n    if (!emailId) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'MISSING_EMAIL_ID',\n            message: 'Email ID not found in webhook payload',\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    // Map Resend event types to our delivery status\n    let deliveryStatus: string;\n    let errorMessage: string | null = null;\n\n    switch (type) {\n      case 'email.sent':\n        deliveryStatus = 'sent';\n        break;\n      case 'email.delivered':\n        deliveryStatus = 'delivered';\n        break;\n      case 'email.delivery_delayed':\n        deliveryStatus = 'sent'; // Keep as sent, just delayed\n        errorMessage = data.reason || 'Delivery delayed';\n        break;\n      case 'email.bounced':\n        deliveryStatus = 'bounced';\n        errorMessage = data.reason || 'Email bounced';\n        break;\n      case 'email.complained':\n        deliveryStatus = 'failed';\n        errorMessage = 'Recipient marked as spam';\n        break;\n      case 'email.opened':\n      case 'email.clicked':\n        // These are engagement events, don't update delivery status\n        // Could be used for analytics in the future\n        return NextResponse.json({ success: true, message: 'Event recorded' });\n      default:\n        console.warn(`Unknown webhook event type: ${type}`);\n        return NextResponse.json({ success: true, message: 'Event ignored' });\n    }\n\n    // 5. Update email log in database\n    const updateData: any = {\n      delivery_status: deliveryStatus,\n    };\n\n    if (deliveryStatus === 'delivered') {\n      updateData.delivered_at = new Date().toISOString();\n    }\n\n    if (errorMessage) {\n      updateData.error_message = errorMessage;\n    }\n\n    const { error: updateError } = await supabase\n      .from('email_logs')\n      .update(updateData)\n      .eq('id', emailId);\n\n    if (updateError) {\n      console.error('Failed to update email log:', updateError);\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'DATABASE_ERROR',\n            message: 'Failed to update email delivery status',\n            details: updateError,\n          },\n        },\n        { status: 500 }\n      );\n    }\n\n    // 6. Log webhook event\n    await supabase.from('webhook_delivery_logs').insert({\n      webhook_id: null, // Resend webhook, not a user-configured webhook\n      event: type,\n      payload: payload,\n      url: request.url,\n      status: 'delivered',\n      attempts: 1,\n      last_attempt_at: new Date().toISOString(),\n      response_status: 200,\n    });\n\n    return NextResponse.json({\n      success: true,\n      message: 'Webhook processed successfully',\n    });\n  } catch (error) {\n    console.error('Webhook processing error:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'WEBHOOK_ERROR',\n          message: error instanceof Error ? error.message : 'Webhook processing failed',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}