{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/settingsService.authMethodInheritance.property.test.ts"],"sourcesContent":["/**\n * Property-based tests for auth method configuration\n * \n * **Feature: admin-ux-enhancements, Property 4: Default Auth Method Inheritance**\n * **Validates: Requirements 4.3**\n * \n * Property: For any newly created guest, the auth_method should automatically \n * inherit the system's default_auth_method setting\n * \n * **Feature: admin-ux-enhancements, Property 5: Bulk Auth Method Update**\n * **Validates: Requirements 4.4**\n * \n * Property: For any bulk update operation on guest auth methods, all selected \n * guests should have their auth_method updated to the specified value\n */\n\nimport * as fc from 'fast-check';\nimport * as settingsService from './settingsService';\n\n// Mock supabase\njest.mock('../lib/supabase', () => ({\n  supabase: {\n    from: jest.fn(),\n    auth: {\n      getSession: jest.fn(),\n    },\n  },\n}));\n\ndescribe('Auth Method Configuration - Property Tests', () => {\n  let mockSupabase: any;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    const { supabase } = require('../lib/supabase');\n    mockSupabase = supabase;\n  });\n\n  describe('Property 4: Default Auth Method Inheritance', () => {\n    /**\n     * Property: New guests should inherit the system's default_auth_method\n     * \n     * This test verifies that regardless of which auth method is set as default,\n     * the system correctly retrieves and returns that value.\n     */\n    it('should always return a valid auth method (email_matching or magic_link)', () => {\n      fc.assert(\n        fc.property(\n          fc.constantFrom('email_matching', 'magic_link'),\n          async (authMethod) => {\n            // Mock database to return the auth method\n            mockSupabase.from.mockReturnValue({\n              select: jest.fn().mockReturnValue({\n                eq: jest.fn().mockReturnValue({\n                  single: jest.fn().mockResolvedValue({\n                    data: { value: authMethod },\n                    error: null,\n                  }),\n                }),\n              }),\n            });\n\n            const result = await settingsService.getDefaultAuthMethod();\n\n            // Property: Result should always be successful\n            expect(result.success).toBe(true);\n\n            if (result.success) {\n              // Property: Returned value should match the stored value\n              expect(result.data).toBe(authMethod);\n              \n              // Property: Returned value should be one of the valid options\n              expect(['email_matching', 'magic_link']).toContain(result.data);\n            }\n          }\n        ),\n        { numRuns: 100 }\n      );\n    });\n\n    it('should return email_matching as default when setting does not exist', () => {\n      fc.assert(\n        fc.property(fc.constant(null), async () => {\n          // Mock database to return not found error\n          mockSupabase.from.mockReturnValue({\n            select: jest.fn().mockReturnValue({\n              eq: jest.fn().mockReturnValue({\n                single: jest.fn().mockResolvedValue({\n                  data: null,\n                  error: { code: 'PGRST116', message: 'Not found' },\n                }),\n              }),\n            }),\n          });\n\n          const result = await settingsService.getDefaultAuthMethod();\n\n          // Property: Should always succeed with default value\n          expect(result.success).toBe(true);\n\n          if (result.success) {\n            // Property: Default should always be email_matching\n            expect(result.data).toBe('email_matching');\n          }\n        }),\n        { numRuns: 50 }\n      );\n    });\n  });\n\n  describe('Property 5: Bulk Auth Method Update', () => {\n    /**\n     * Property: All selected guests should be updated atomically\n     * \n     * This test verifies that when bulk updating guests, the operation\n     * correctly updates the setting and reports the number of guests updated.\n     */\n    it('should update all guests when bulk update is requested', () => {\n      fc.assert(\n        fc.property(\n          fc.constantFrom('email_matching', 'magic_link'),\n          fc.integer({ min: 0, max: 100 }), // Number of guests to update\n          async (authMethod, guestCount) => {\n            const mockFrom = jest.fn();\n            mockSupabase.from = mockFrom;\n\n            // First call: upsert setting (success)\n            mockFrom.mockReturnValueOnce({\n              upsert: jest.fn().mockReturnValue({\n                select: jest.fn().mockReturnValue({\n                  single: jest.fn().mockResolvedValue({\n                    data: {\n                      key: 'default_auth_method',\n                      value: authMethod,\n                    },\n                    error: null,\n                  }),\n                }),\n              }),\n            });\n\n            // Second call: update guests\n            const mockGuestData = Array.from({ length: guestCount }, (_, i) => ({\n              id: `guest-${i}`,\n            }));\n\n            mockFrom.mockReturnValueOnce({\n              update: jest.fn().mockReturnValue({\n                neq: jest.fn().mockReturnValue({\n                  select: jest.fn().mockResolvedValue({\n                    data: mockGuestData,\n                    error: null,\n                  }),\n                }),\n              }),\n            });\n\n            const result = await settingsService.updateDefaultAuthMethod(authMethod, true);\n\n            // Property: Update should always succeed\n            expect(result.success).toBe(true);\n\n            if (result.success) {\n              // Property: Updated count should match the number of guests\n              expect(result.data.updatedGuestsCount).toBe(guestCount);\n              \n              // Property: Updated count should be non-negative\n              expect(result.data.updatedGuestsCount).toBeGreaterThanOrEqual(0);\n            }\n          }\n        ),\n        { numRuns: 100 }\n      );\n    });\n\n    it('should not update guests when bulk update is not requested', () => {\n      fc.assert(\n        fc.property(\n          fc.constantFrom('email_matching', 'magic_link'),\n          async (authMethod) => {\n            // Mock upsert for setting only\n            mockSupabase.from.mockReturnValue({\n              upsert: jest.fn().mockReturnValue({\n                select: jest.fn().mockReturnValue({\n                  single: jest.fn().mockResolvedValue({\n                    data: {\n                      key: 'default_auth_method',\n                      value: authMethod,\n                    },\n                    error: null,\n                  }),\n                }),\n              }),\n            });\n\n            const result = await settingsService.updateDefaultAuthMethod(authMethod, false);\n\n            // Property: Update should always succeed\n            expect(result.success).toBe(true);\n\n            if (result.success) {\n              // Property: No guests should be updated when bulk update is false\n              expect(result.data.updatedGuestsCount).toBe(0);\n            }\n          }\n        ),\n        { numRuns: 100 }\n      );\n    });\n\n    it('should maintain atomicity - either all guests updated or none', () => {\n      fc.assert(\n        fc.property(\n          fc.constantFrom('email_matching', 'magic_link'),\n          fc.boolean(), // Whether the guest update should fail\n          async (authMethod, shouldFail) => {\n            const mockFrom = jest.fn();\n            mockSupabase.from = mockFrom;\n\n            // First call: upsert setting (always succeeds)\n            mockFrom.mockReturnValueOnce({\n              upsert: jest.fn().mockReturnValue({\n                select: jest.fn().mockReturnValue({\n                  single: jest.fn().mockResolvedValue({\n                    data: {\n                      key: 'default_auth_method',\n                      value: authMethod,\n                    },\n                    error: null,\n                  }),\n                }),\n              }),\n            });\n\n            // Second call: update guests (may fail)\n            if (shouldFail) {\n              mockFrom.mockReturnValueOnce({\n                update: jest.fn().mockReturnValue({\n                  neq: jest.fn().mockReturnValue({\n                    select: jest.fn().mockResolvedValue({\n                      data: null,\n                      error: { message: 'Database error' },\n                    }),\n                  }),\n                }),\n              });\n            } else {\n              mockFrom.mockReturnValueOnce({\n                update: jest.fn().mockReturnValue({\n                  neq: jest.fn().mockReturnValue({\n                    select: jest.fn().mockResolvedValue({\n                      data: [{ id: '1' }, { id: '2' }],\n                      error: null,\n                    }),\n                  }),\n                }),\n              });\n            }\n\n            const result = await settingsService.updateDefaultAuthMethod(authMethod, true);\n\n            if (shouldFail) {\n              // Property: If guest update fails, entire operation should fail\n              expect(result.success).toBe(false);\n              if (!result.success) {\n                expect(result.error.code).toBe('DATABASE_ERROR');\n              }\n            } else {\n              // Property: If guest update succeeds, operation should succeed\n              expect(result.success).toBe(true);\n              if (result.success) {\n                expect(result.data.updatedGuestsCount).toBeGreaterThanOrEqual(0);\n              }\n            }\n          }\n        ),\n        { numRuns: 100 }\n      );\n    });\n  });\n\n  describe('Property: Auth Method Validation', () => {\n    /**\n     * Property: Invalid auth methods should always be rejected\n     * \n     * This test verifies that the system properly validates auth method values\n     * and rejects any invalid values.\n     */\n    it('should reject invalid auth method values', () => {\n      fc.assert(\n        fc.property(\n          fc.string().filter((s) => s !== 'email_matching' && s !== 'magic_link'),\n          async (invalidMethod) => {\n            const result = await settingsService.updateDefaultAuthMethod(\n              invalidMethod as any,\n              false\n            );\n\n            // Property: Invalid methods should always fail validation\n            expect(result.success).toBe(false);\n\n            if (!result.success) {\n              // Property: Error code should be VALIDATION_ERROR\n              expect(result.error.code).toBe('VALIDATION_ERROR');\n              \n              // Property: Error message should mention invalid auth method\n              expect(result.error.message.toLowerCase()).toContain('invalid');\n            }\n          }\n        ),\n        { numRuns: 100 }\n      );\n    });\n\n    it('should only accept email_matching or magic_link as valid values', () => {\n      fc.assert(\n        fc.property(\n          fc.constantFrom('email_matching', 'magic_link'),\n          async (validMethod) => {\n            // Mock successful upsert\n            mockSupabase.from.mockReturnValue({\n              upsert: jest.fn().mockReturnValue({\n                select: jest.fn().mockReturnValue({\n                  single: jest.fn().mockResolvedValue({\n                    data: {\n                      key: 'default_auth_method',\n                      value: validMethod,\n                    },\n                    error: null,\n                  }),\n                }),\n              }),\n            });\n\n            const result = await settingsService.updateDefaultAuthMethod(validMethod, false);\n\n            // Property: Valid methods should always succeed (assuming no DB errors)\n            expect(result.success).toBe(true);\n          }\n        ),\n        { numRuns: 100 }\n      );\n    });\n  });\n});\n"],"names":["jest","mock","supabase","from","fn","auth","getSession","describe","mockSupabase","beforeEach","clearAllMocks","require","it","fc","assert","property","constantFrom","authMethod","mockReturnValue","select","eq","single","mockResolvedValue","data","value","error","result","settingsService","getDefaultAuthMethod","expect","success","toBe","toContain","numRuns","constant","code","message","integer","min","max","guestCount","mockFrom","mockReturnValueOnce","upsert","key","mockGuestData","Array","length","_","i","id","update","neq","updateDefaultAuthMethod","updatedGuestsCount","toBeGreaterThanOrEqual","boolean","shouldFail","string","filter","s","invalidMethod","toLowerCase","validMethod"],"mappings":"AAAA;;;;;;;;;;;;;;CAcC;AAKD,gBAAgB;AAChBA,KAAKC,IAAI,CAAC,mBAAmB,IAAO,CAAA;QAClCC,UAAU;YACRC,MAAMH,KAAKI,EAAE;YACbC,MAAM;gBACJC,YAAYN,KAAKI,EAAE;YACrB;QACF;IACF,CAAA;;;;mEAXoB;yEACa;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAYjCG,SAAS,8CAA8C;IACrD,IAAIC;IAEJC,WAAW;QACTT,KAAKU,aAAa;QAClB,MAAM,EAAER,QAAQ,EAAE,GAAGS,QAAQ;QAC7BH,eAAeN;IACjB;IAEAK,SAAS,+CAA+C;QACtD;;;;;KAKC,GACDK,GAAG,2EAA2E;YAC5EC,WAAGC,MAAM,CACPD,WAAGE,QAAQ,CACTF,WAAGG,YAAY,CAAC,kBAAkB,eAClC,OAAOC;gBACL,0CAA0C;gBAC1CT,aAAaL,IAAI,CAACe,eAAe,CAAC;oBAChCC,QAAQnB,KAAKI,EAAE,GAAGc,eAAe,CAAC;wBAChCE,IAAIpB,KAAKI,EAAE,GAAGc,eAAe,CAAC;4BAC5BG,QAAQrB,KAAKI,EAAE,GAAGkB,iBAAiB,CAAC;gCAClCC,MAAM;oCAAEC,OAAOP;gCAAW;gCAC1BQ,OAAO;4BACT;wBACF;oBACF;gBACF;gBAEA,MAAMC,SAAS,MAAMC,iBAAgBC,oBAAoB;gBAEzD,+CAA+C;gBAC/CC,OAAOH,OAAOI,OAAO,EAAEC,IAAI,CAAC;gBAE5B,IAAIL,OAAOI,OAAO,EAAE;oBAClB,yDAAyD;oBACzDD,OAAOH,OAAOH,IAAI,EAAEQ,IAAI,CAACd;oBAEzB,8DAA8D;oBAC9DY,OAAO;wBAAC;wBAAkB;qBAAa,EAAEG,SAAS,CAACN,OAAOH,IAAI;gBAChE;YACF,IAEF;gBAAEU,SAAS;YAAI;QAEnB;QAEArB,GAAG,uEAAuE;YACxEC,WAAGC,MAAM,CACPD,WAAGE,QAAQ,CAACF,WAAGqB,QAAQ,CAAC,OAAO;gBAC7B,0CAA0C;gBAC1C1B,aAAaL,IAAI,CAACe,eAAe,CAAC;oBAChCC,QAAQnB,KAAKI,EAAE,GAAGc,eAAe,CAAC;wBAChCE,IAAIpB,KAAKI,EAAE,GAAGc,eAAe,CAAC;4BAC5BG,QAAQrB,KAAKI,EAAE,GAAGkB,iBAAiB,CAAC;gCAClCC,MAAM;gCACNE,OAAO;oCAAEU,MAAM;oCAAYC,SAAS;gCAAY;4BAClD;wBACF;oBACF;gBACF;gBAEA,MAAMV,SAAS,MAAMC,iBAAgBC,oBAAoB;gBAEzD,qDAAqD;gBACrDC,OAAOH,OAAOI,OAAO,EAAEC,IAAI,CAAC;gBAE5B,IAAIL,OAAOI,OAAO,EAAE;oBAClB,oDAAoD;oBACpDD,OAAOH,OAAOH,IAAI,EAAEQ,IAAI,CAAC;gBAC3B;YACF,IACA;gBAAEE,SAAS;YAAG;QAElB;IACF;IAEA1B,SAAS,uCAAuC;QAC9C;;;;;KAKC,GACDK,GAAG,0DAA0D;YAC3DC,WAAGC,MAAM,CACPD,WAAGE,QAAQ,CACTF,WAAGG,YAAY,CAAC,kBAAkB,eAClCH,WAAGwB,OAAO,CAAC;gBAAEC,KAAK;gBAAGC,KAAK;YAAI,IAC9B,OAAOtB,YAAYuB;gBACjB,MAAMC,WAAWzC,KAAKI,EAAE;gBACxBI,aAAaL,IAAI,GAAGsC;gBAEpB,uCAAuC;gBACvCA,SAASC,mBAAmB,CAAC;oBAC3BC,QAAQ3C,KAAKI,EAAE,GAAGc,eAAe,CAAC;wBAChCC,QAAQnB,KAAKI,EAAE,GAAGc,eAAe,CAAC;4BAChCG,QAAQrB,KAAKI,EAAE,GAAGkB,iBAAiB,CAAC;gCAClCC,MAAM;oCACJqB,KAAK;oCACLpB,OAAOP;gCACT;gCACAQ,OAAO;4BACT;wBACF;oBACF;gBACF;gBAEA,6BAA6B;gBAC7B,MAAMoB,gBAAgBC,MAAM3C,IAAI,CAAC;oBAAE4C,QAAQP;gBAAW,GAAG,CAACQ,GAAGC,IAAO,CAAA;wBAClEC,IAAI,CAAC,MAAM,EAAED,GAAG;oBAClB,CAAA;gBAEAR,SAASC,mBAAmB,CAAC;oBAC3BS,QAAQnD,KAAKI,EAAE,GAAGc,eAAe,CAAC;wBAChCkC,KAAKpD,KAAKI,EAAE,GAAGc,eAAe,CAAC;4BAC7BC,QAAQnB,KAAKI,EAAE,GAAGkB,iBAAiB,CAAC;gCAClCC,MAAMsB;gCACNpB,OAAO;4BACT;wBACF;oBACF;gBACF;gBAEA,MAAMC,SAAS,MAAMC,iBAAgB0B,uBAAuB,CAACpC,YAAY;gBAEzE,yCAAyC;gBACzCY,OAAOH,OAAOI,OAAO,EAAEC,IAAI,CAAC;gBAE5B,IAAIL,OAAOI,OAAO,EAAE;oBAClB,4DAA4D;oBAC5DD,OAAOH,OAAOH,IAAI,CAAC+B,kBAAkB,EAAEvB,IAAI,CAACS;oBAE5C,iDAAiD;oBACjDX,OAAOH,OAAOH,IAAI,CAAC+B,kBAAkB,EAAEC,sBAAsB,CAAC;gBAChE;YACF,IAEF;gBAAEtB,SAAS;YAAI;QAEnB;QAEArB,GAAG,8DAA8D;YAC/DC,WAAGC,MAAM,CACPD,WAAGE,QAAQ,CACTF,WAAGG,YAAY,CAAC,kBAAkB,eAClC,OAAOC;gBACL,+BAA+B;gBAC/BT,aAAaL,IAAI,CAACe,eAAe,CAAC;oBAChCyB,QAAQ3C,KAAKI,EAAE,GAAGc,eAAe,CAAC;wBAChCC,QAAQnB,KAAKI,EAAE,GAAGc,eAAe,CAAC;4BAChCG,QAAQrB,KAAKI,EAAE,GAAGkB,iBAAiB,CAAC;gCAClCC,MAAM;oCACJqB,KAAK;oCACLpB,OAAOP;gCACT;gCACAQ,OAAO;4BACT;wBACF;oBACF;gBACF;gBAEA,MAAMC,SAAS,MAAMC,iBAAgB0B,uBAAuB,CAACpC,YAAY;gBAEzE,yCAAyC;gBACzCY,OAAOH,OAAOI,OAAO,EAAEC,IAAI,CAAC;gBAE5B,IAAIL,OAAOI,OAAO,EAAE;oBAClB,kEAAkE;oBAClED,OAAOH,OAAOH,IAAI,CAAC+B,kBAAkB,EAAEvB,IAAI,CAAC;gBAC9C;YACF,IAEF;gBAAEE,SAAS;YAAI;QAEnB;QAEArB,GAAG,iEAAiE;YAClEC,WAAGC,MAAM,CACPD,WAAGE,QAAQ,CACTF,WAAGG,YAAY,CAAC,kBAAkB,eAClCH,WAAG2C,OAAO,IACV,OAAOvC,YAAYwC;gBACjB,MAAMhB,WAAWzC,KAAKI,EAAE;gBACxBI,aAAaL,IAAI,GAAGsC;gBAEpB,+CAA+C;gBAC/CA,SAASC,mBAAmB,CAAC;oBAC3BC,QAAQ3C,KAAKI,EAAE,GAAGc,eAAe,CAAC;wBAChCC,QAAQnB,KAAKI,EAAE,GAAGc,eAAe,CAAC;4BAChCG,QAAQrB,KAAKI,EAAE,GAAGkB,iBAAiB,CAAC;gCAClCC,MAAM;oCACJqB,KAAK;oCACLpB,OAAOP;gCACT;gCACAQ,OAAO;4BACT;wBACF;oBACF;gBACF;gBAEA,wCAAwC;gBACxC,IAAIgC,YAAY;oBACdhB,SAASC,mBAAmB,CAAC;wBAC3BS,QAAQnD,KAAKI,EAAE,GAAGc,eAAe,CAAC;4BAChCkC,KAAKpD,KAAKI,EAAE,GAAGc,eAAe,CAAC;gCAC7BC,QAAQnB,KAAKI,EAAE,GAAGkB,iBAAiB,CAAC;oCAClCC,MAAM;oCACNE,OAAO;wCAAEW,SAAS;oCAAiB;gCACrC;4BACF;wBACF;oBACF;gBACF,OAAO;oBACLK,SAASC,mBAAmB,CAAC;wBAC3BS,QAAQnD,KAAKI,EAAE,GAAGc,eAAe,CAAC;4BAChCkC,KAAKpD,KAAKI,EAAE,GAAGc,eAAe,CAAC;gCAC7BC,QAAQnB,KAAKI,EAAE,GAAGkB,iBAAiB,CAAC;oCAClCC,MAAM;wCAAC;4CAAE2B,IAAI;wCAAI;wCAAG;4CAAEA,IAAI;wCAAI;qCAAE;oCAChCzB,OAAO;gCACT;4BACF;wBACF;oBACF;gBACF;gBAEA,MAAMC,SAAS,MAAMC,iBAAgB0B,uBAAuB,CAACpC,YAAY;gBAEzE,IAAIwC,YAAY;oBACd,gEAAgE;oBAChE5B,OAAOH,OAAOI,OAAO,EAAEC,IAAI,CAAC;oBAC5B,IAAI,CAACL,OAAOI,OAAO,EAAE;wBACnBD,OAAOH,OAAOD,KAAK,CAACU,IAAI,EAAEJ,IAAI,CAAC;oBACjC;gBACF,OAAO;oBACL,+DAA+D;oBAC/DF,OAAOH,OAAOI,OAAO,EAAEC,IAAI,CAAC;oBAC5B,IAAIL,OAAOI,OAAO,EAAE;wBAClBD,OAAOH,OAAOH,IAAI,CAAC+B,kBAAkB,EAAEC,sBAAsB,CAAC;oBAChE;gBACF;YACF,IAEF;gBAAEtB,SAAS;YAAI;QAEnB;IACF;IAEA1B,SAAS,oCAAoC;QAC3C;;;;;KAKC,GACDK,GAAG,4CAA4C;YAC7CC,WAAGC,MAAM,CACPD,WAAGE,QAAQ,CACTF,WAAG6C,MAAM,GAAGC,MAAM,CAAC,CAACC,IAAMA,MAAM,oBAAoBA,MAAM,eAC1D,OAAOC;gBACL,MAAMnC,SAAS,MAAMC,iBAAgB0B,uBAAuB,CAC1DQ,eACA;gBAGF,0DAA0D;gBAC1DhC,OAAOH,OAAOI,OAAO,EAAEC,IAAI,CAAC;gBAE5B,IAAI,CAACL,OAAOI,OAAO,EAAE;oBACnB,kDAAkD;oBAClDD,OAAOH,OAAOD,KAAK,CAACU,IAAI,EAAEJ,IAAI,CAAC;oBAE/B,6DAA6D;oBAC7DF,OAAOH,OAAOD,KAAK,CAACW,OAAO,CAAC0B,WAAW,IAAI9B,SAAS,CAAC;gBACvD;YACF,IAEF;gBAAEC,SAAS;YAAI;QAEnB;QAEArB,GAAG,mEAAmE;YACpEC,WAAGC,MAAM,CACPD,WAAGE,QAAQ,CACTF,WAAGG,YAAY,CAAC,kBAAkB,eAClC,OAAO+C;gBACL,yBAAyB;gBACzBvD,aAAaL,IAAI,CAACe,eAAe,CAAC;oBAChCyB,QAAQ3C,KAAKI,EAAE,GAAGc,eAAe,CAAC;wBAChCC,QAAQnB,KAAKI,EAAE,GAAGc,eAAe,CAAC;4BAChCG,QAAQrB,KAAKI,EAAE,GAAGkB,iBAAiB,CAAC;gCAClCC,MAAM;oCACJqB,KAAK;oCACLpB,OAAOuC;gCACT;gCACAtC,OAAO;4BACT;wBACF;oBACF;gBACF;gBAEA,MAAMC,SAAS,MAAMC,iBAAgB0B,uBAAuB,CAACU,aAAa;gBAE1E,wEAAwE;gBACxElC,OAAOH,OAAOI,OAAO,EAAEC,IAAI,CAAC;YAC9B,IAEF;gBAAEE,SAAS;YAAI;QAEnB;IACF;AACF"}