{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/locationService.test.ts"],"sourcesContent":["import { describe, it, expect, jest, beforeEach } from '@jest/globals';\nimport type { CreateLocationDTO, UpdateLocationDTO, LocationFilterDTO, LocationSearchDTO } from '@/schemas/locationSchemas';\n\n// Set environment variables FIRST\nprocess.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';\nprocess.env.SUPABASE_SERVICE_ROLE_KEY = 'test-service-role-key';\n\n// Mock Supabase with shared client instance (Pattern A)\njest.mock('@supabase/supabase-js', () => {\n  const mockFrom = jest.fn();\n  const mockSupabaseClient = {\n    from: mockFrom,\n  };\n  \n  return {\n    createClient: jest.fn(() => mockSupabaseClient),\n    __mockFrom: mockFrom,\n  };\n});\n\n// Mock sanitization utilities\njest.mock('../utils/sanitization', () => ({\n  sanitizeInput: jest.fn((input: string) => input.trim()),\n  sanitizeRichText: jest.fn((input: string) => input.trim()),\n}));\n\n// Import service using require() AFTER mocking (Pattern A requirement)\nconst locationServiceModule = require('./locationService');\nconst { create, get, update, deleteLocation, list, search, getHierarchy, getWithChildren } = locationServiceModule;\n\n// Get the mocked from function\nconst { __mockFrom: mockFrom } = require('@supabase/supabase-js');\n\ndescribe('locationService', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    \n    // Set up environment variables\n    process.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';\n    process.env.SUPABASE_SERVICE_ROLE_KEY = 'test-service-role-key';\n  });\n\n  describe('create', () => {\n    const validData: CreateLocationDTO = {\n      name: 'Tamarindo Beach',\n      parentLocationId: '123e4567-e89b-12d3-a456-426614174000',\n      address: 'Tamarindo, Guanacaste, Costa Rica',\n      description: 'Beautiful beach location',\n    };\n\n    it('should return success with location data when valid input provided', async () => {\n      const mockLocation = {\n        id: 'location-1',\n        name: 'Tamarindo Beach',\n        parent_location_id: validData.parentLocationId,\n        address: validData.address,\n        description: validData.description,\n        coordinates: null,\n        created_at: '2024-01-01T00:00:00Z',\n      };\n\n      // Mock parent location exists check (first call)\n      // Service calls: supabase.from('locations').select('*').eq('id', parentId).single()\n      const mockSingle1 = jest.fn().mockResolvedValue({\n        data: { id: validData.parentLocationId },\n        error: null,\n      });\n      const mockEq1 = jest.fn().mockReturnValue({ single: mockSingle1 });\n      const mockSelect1 = jest.fn().mockReturnValue({ eq: mockEq1 });\n\n      // Mock location creation (second call)\n      // Service calls: supabase.from('locations').insert(data).select().single()\n      const mockSingle2 = jest.fn().mockResolvedValue({\n        data: mockLocation,\n        error: null,\n      });\n      const mockSelect2 = jest.fn().mockReturnValue({ single: mockSingle2 });\n      const mockInsert = jest.fn().mockReturnValue({ select: mockSelect2 });\n\n      let callCount = 0;\n      mockFrom.mockImplementation((table: string) => {\n        if (table === 'locations') {\n          callCount++;\n          if (callCount === 1) {\n            // First call - check parent exists\n            return { select: mockSelect1 };\n          } else {\n            // Second call - insert new location\n            return { insert: mockInsert };\n          }\n        }\n        return {};\n      });\n\n      const result = await create(validData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('location-1');\n        expect(result.data.name).toBe('Tamarindo Beach');\n        expect(result.data.parentLocationId).toBe(validData.parentLocationId);\n      }\n    });\n\n    it('should return VALIDATION_ERROR when name is missing', async () => {\n      const invalidData = { ...validData, name: '' };\n      const result = await create(invalidData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n      }\n    });\n\n    it('should return VALIDATION_ERROR when name is too long', async () => {\n      const invalidData = { ...validData, name: 'a'.repeat(201) };\n      const result = await create(invalidData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n      }\n    });\n\n    it('should return INVALID_PARENT when parent location does not exist', async () => {\n      // Mock parent location not found\n      const mockSingle = jest.fn().mockResolvedValue({\n        data: null,\n        error: { code: 'PGRST116' },\n      });\n      const mockEq = jest.fn().mockReturnValue({ single: mockSingle });\n      const mockSelect = jest.fn().mockReturnValue({ eq: mockEq });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await create(validData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('INVALID_PARENT');\n      }\n    });\n\n    it('should return DATABASE_ERROR when insert fails', async () => {\n      // Mock parent location exists\n      const mockSingle1 = jest.fn().mockResolvedValue({\n        data: { id: validData.parentLocationId },\n        error: null,\n      });\n      const mockEq1 = jest.fn().mockReturnValue({ single: mockSingle1 });\n      const mockSelect1 = jest.fn().mockReturnValue({ eq: mockEq1 });\n\n      // Mock database error on insert\n      const mockSingle2 = jest.fn().mockResolvedValue({\n        data: null,\n        error: { message: 'Connection failed' },\n      });\n      const mockSelect2 = jest.fn().mockReturnValue({ single: mockSingle2 });\n      const mockInsert = jest.fn().mockReturnValue({ select: mockSelect2 });\n\n      let callCount = 0;\n      mockFrom.mockImplementation((table: string) => {\n        if (table === 'locations') {\n          callCount++;\n          if (callCount === 1) {\n            return { select: mockSelect1 };\n          } else {\n            return { insert: mockInsert };\n          }\n        }\n        return {};\n      });\n\n      const result = await create(validData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n\n    it('should sanitize input to prevent XSS attacks', async () => {\n      const maliciousData = {\n        ...validData,\n        name: '<script>alert(\"xss\")</script>Tamarindo',\n        address: '<img src=x onerror=alert(1)>Address',\n        description: '<svg onload=alert(1)>Description',\n      };\n\n      // Mock parent location exists\n      const mockSingle1 = jest.fn().mockResolvedValue({\n        data: { id: validData.parentLocationId },\n        error: null,\n      });\n      const mockEq1 = jest.fn().mockReturnValue({ single: mockSingle1 });\n      const mockSelect1 = jest.fn().mockReturnValue({ eq: mockEq1 });\n\n      // Mock successful creation\n      const mockSingle2 = jest.fn().mockResolvedValue({\n        data: {\n          id: 'location-1',\n          name: 'Tamarindo',\n          address: 'Address',\n          description: 'Description',\n        },\n        error: null,\n      });\n      const mockSelect2 = jest.fn().mockReturnValue({ single: mockSingle2 });\n      const mockInsert = jest.fn().mockReturnValue({ select: mockSelect2 });\n\n      let callCount = 0;\n      mockFrom.mockImplementation((table: string) => {\n        if (table === 'locations') {\n          callCount++;\n          if (callCount === 1) {\n            return { select: mockSelect1 };\n          } else {\n            return { insert: mockInsert };\n          }\n        }\n        return {};\n      });\n\n      const result = await create(maliciousData);\n\n      expect(result.success).toBe(true);\n      // Verify sanitization was called\n      const { sanitizeInput, sanitizeRichText } = require('../utils/sanitization');\n      expect(sanitizeInput).toHaveBeenCalledWith(maliciousData.name);\n      expect(sanitizeInput).toHaveBeenCalledWith(maliciousData.address);\n      expect(sanitizeRichText).toHaveBeenCalledWith(maliciousData.description);\n    });\n  });\n\n  describe('get', () => {\n    it('should return success with location data when location exists', async () => {\n      const mockLocation = {\n        id: 'location-1',\n        name: 'Tamarindo Beach',\n        parent_location_id: null,\n        address: 'Tamarindo, Costa Rica',\n        coordinates: null,\n        description: null,\n        created_at: '2024-01-01T00:00:00Z',\n      };\n\n      const mockSingle = jest.fn().mockResolvedValue({\n        data: mockLocation,\n        error: null,\n      });\n      const mockEq = jest.fn().mockReturnValue({ single: mockSingle });\n      const mockSelect = jest.fn().mockReturnValue({ eq: mockEq });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await get('location-1');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('location-1');\n        expect(result.data.name).toBe('Tamarindo Beach');\n      }\n    });\n\n    it('should return NOT_FOUND when location does not exist', async () => {\n      const mockSingle = jest.fn().mockResolvedValue({\n        data: null,\n        error: { code: 'PGRST116' },\n      });\n      const mockEq = jest.fn().mockReturnValue({ single: mockSingle });\n      const mockSelect = jest.fn().mockReturnValue({ eq: mockEq });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await get('nonexistent-id');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('NOT_FOUND');\n      }\n    });\n\n    it('should return DATABASE_ERROR when database query fails', async () => {\n      const mockSingle = jest.fn().mockResolvedValue({\n        data: null,\n        error: { message: 'Connection failed' },\n      });\n      const mockEq = jest.fn().mockReturnValue({ single: mockSingle });\n      const mockSelect = jest.fn().mockReturnValue({ eq: mockEq });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await get('location-1');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n  });\n\n  describe('update', () => {\n    const updateData: UpdateLocationDTO = {\n      name: 'Updated Beach',\n      address: 'Updated Address',\n    };\n\n    it('should return success with updated location data when valid input provided', async () => {\n      const mockUpdatedLocation = {\n        id: 'location-1',\n        name: 'Updated Beach',\n        address: 'Updated Address',\n        parent_location_id: null,\n        coordinates: null,\n        description: null,\n        created_at: '2024-01-01T00:00:00Z',\n      };\n\n      const mockSingle = jest.fn().mockResolvedValue({\n        data: mockUpdatedLocation,\n        error: null,\n      });\n      const mockSelect = jest.fn().mockReturnValue({ single: mockSingle });\n      const mockEq = jest.fn().mockReturnValue({ select: mockSelect });\n      const mockUpdate = jest.fn().mockReturnValue({ eq: mockEq });\n      mockFrom.mockReturnValue({ update: mockUpdate });\n\n      const result = await update('location-1', updateData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.name).toBe('Updated Beach');\n        expect(result.data.address).toBe('Updated Address');\n      }\n    });\n\n    it('should return CIRCULAR_REFERENCE when trying to set self as parent', async () => {\n      const locationId = '123e4567-e89b-12d3-a456-426614174000';\n      const circularData = { parentLocationId: locationId };\n      \n      // Service checks if parentLocationId === id before any DB calls\n      const result = await update(locationId, circularData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        // Service returns CIRCULAR_REFERENCE for self-reference\n        expect(result.error.code).toBe('CIRCULAR_REFERENCE');\n        expect(result.error.message).toContain('cannot be its own parent');\n      }\n    });\n\n    it('should return INVALID_PARENT when parent location does not exist', async () => {\n      const invalidParentData = { parentLocationId: '123e4567-e89b-12d3-a456-426614174000' };\n\n      // Mock parent location not found (get() call)\n      const mockSingle = jest.fn().mockResolvedValue({\n        data: null,\n        error: { code: 'PGRST116' },\n      });\n      const mockEq = jest.fn().mockReturnValue({ single: mockSingle });\n      const mockSelect = jest.fn().mockReturnValue({ eq: mockEq });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await update('location-1', invalidParentData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('INVALID_PARENT');\n      }\n    });\n\n    it('should return NOT_FOUND when location to update does not exist', async () => {\n      const mockSingle = jest.fn().mockResolvedValue({\n        data: null,\n        error: { code: 'PGRST116' },\n      });\n      const mockSelect = jest.fn().mockReturnValue({ single: mockSingle });\n      const mockEq = jest.fn().mockReturnValue({ select: mockSelect });\n      const mockUpdate = jest.fn().mockReturnValue({ eq: mockEq });\n      mockFrom.mockReturnValue({ update: mockUpdate });\n\n      const result = await update('nonexistent-id', updateData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('NOT_FOUND');\n      }\n    });\n  });\n\n  describe('deleteLocation', () => {\n    it('should return success when location is deleted successfully', async () => {\n      const mockEq = jest.fn().mockResolvedValue({\n        error: null,\n      });\n      const mockDelete = jest.fn().mockReturnValue({ eq: mockEq });\n      mockFrom.mockReturnValue({ delete: mockDelete });\n\n      const result = await deleteLocation('location-1');\n\n      expect(result.success).toBe(true);\n    });\n\n    it('should return DATABASE_ERROR when delete fails', async () => {\n      const mockEq = jest.fn().mockResolvedValue({\n        error: { message: 'Foreign key constraint violation' },\n      });\n      const mockDelete = jest.fn().mockReturnValue({ eq: mockEq });\n      mockFrom.mockReturnValue({ delete: mockDelete });\n\n      const result = await deleteLocation('location-1');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n  });\n\n  describe('list', () => {\n    it('should return success with paginated locations when valid filters provided', async () => {\n      const mockLocations = [\n        {\n          id: 'location-1',\n          name: 'Beach A',\n          parent_location_id: null,\n          address: null,\n          coordinates: null,\n          description: null,\n          created_at: '2024-01-01T00:00:00Z',\n        },\n        {\n          id: 'location-2',\n          name: 'Beach B',\n          parent_location_id: null,\n          address: null,\n          coordinates: null,\n          description: null,\n          created_at: '2024-01-01T00:00:00Z',\n        },\n      ];\n\n      const mockRange = jest.fn().mockResolvedValue({\n        data: mockLocations,\n        error: null,\n        count: 2,\n      });\n      const mockOrder = jest.fn().mockReturnValue({ range: mockRange });\n      const mockSelect = jest.fn().mockReturnValue({ order: mockOrder });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const filters: LocationFilterDTO = { page: 1, pageSize: 10 };\n      const result = await list(filters);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.locations).toHaveLength(2);\n        expect(result.data.total).toBe(2);\n        expect(result.data.page).toBe(1);\n        expect(result.data.pageSize).toBe(10);\n      }\n    });\n\n    it('should filter by parent location ID when provided', async () => {\n      const filters: LocationFilterDTO = {\n        parentLocationId: '123e4567-e89b-12d3-a456-426614174000',\n        page: 1,\n        pageSize: 10,\n      };\n\n      const mockRange = jest.fn().mockResolvedValue({\n        data: [],\n        error: null,\n        count: 0,\n      });\n      const mockOrder = jest.fn().mockReturnValue({ range: mockRange });\n      const mockEq = jest.fn().mockReturnValue({ order: mockOrder });\n      const mockSelect = jest.fn().mockReturnValue({ eq: mockEq });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await list(filters);\n\n      // Just verify the result is successful - the mock was called correctly\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.locations).toEqual([]);\n        expect(result.data.total).toBe(0);\n      }\n    });\n\n    it('should filter for root locations when parentLocationId is null', async () => {\n      const filters: LocationFilterDTO = {\n        parentLocationId: null,\n        page: 1,\n        pageSize: 10,\n      };\n\n      const mockRange = jest.fn().mockResolvedValue({\n        data: [],\n        error: null,\n        count: 0,\n      });\n      const mockOrder = jest.fn().mockReturnValue({ range: mockRange });\n      const mockIs = jest.fn().mockReturnValue({ order: mockOrder });\n      const mockSelect = jest.fn().mockReturnValue({ is: mockIs });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await list(filters);\n\n      expect(mockIs).toHaveBeenCalledWith('parent_location_id', null);\n      expect(result.success).toBe(true);\n    });\n\n    it('should return DATABASE_ERROR when query fails', async () => {\n      const mockRange = jest.fn().mockResolvedValue({\n        data: null,\n        error: { message: 'Connection failed' },\n      });\n      const mockOrder = jest.fn().mockReturnValue({ range: mockRange });\n      const mockSelect = jest.fn().mockReturnValue({ order: mockOrder });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await list();\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n  });\n\n  describe('search', () => {\n    const searchParams: LocationSearchDTO = {\n      query: 'beach',\n      page: 1,\n      pageSize: 10,\n    };\n\n    it('should return success with search results when valid query provided', async () => {\n      const mockResults = [\n        {\n          id: 'location-1',\n          name: 'Tamarindo Beach',\n          parent_location_id: null,\n          address: 'Beach address',\n          coordinates: null,\n          description: 'Beach description',\n          created_at: '2024-01-01T00:00:00Z',\n        },\n      ];\n\n      const mockRange = jest.fn().mockResolvedValue({\n        data: mockResults,\n        error: null,\n        count: 1,\n      });\n      const mockOrder = jest.fn().mockReturnValue({ range: mockRange });\n      const mockOr = jest.fn().mockReturnValue({ order: mockOrder });\n      const mockSelect = jest.fn().mockReturnValue({ or: mockOr });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await search(searchParams);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.locations).toHaveLength(1);\n        expect(result.data.locations[0].name).toBe('Tamarindo Beach');\n      }\n    });\n\n    it('should sanitize search query to prevent injection attacks', async () => {\n      const maliciousSearch = {\n        query: '<script>alert(\"xss\")</script>beach',\n        page: 1,\n        pageSize: 10,\n      };\n\n      const mockRange = jest.fn().mockResolvedValue({\n        data: [],\n        error: null,\n        count: 0,\n      });\n      const mockOrder = jest.fn().mockReturnValue({ range: mockRange });\n      const mockOr = jest.fn().mockReturnValue({ order: mockOrder });\n      const mockSelect = jest.fn().mockReturnValue({ or: mockOr });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await search(maliciousSearch);\n\n      // Verify sanitization was called\n      const { sanitizeInput } = require('../utils/sanitization');\n      expect(sanitizeInput).toHaveBeenCalledWith(maliciousSearch.query);\n      expect(result.success).toBe(true);\n    });\n\n    it('should return VALIDATION_ERROR when query is empty', async () => {\n      const invalidSearch = { ...searchParams, query: '' };\n      const result = await search(invalidSearch);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n      }\n    });\n  });\n\n  describe('getHierarchy', () => {\n    it('should return success with hierarchical location tree', async () => {\n      const mockLocations = [\n        {\n          id: 'country-1',\n          name: 'Costa Rica',\n          parent_location_id: null,\n          address: null,\n          coordinates: null,\n          description: null,\n          created_at: '2024-01-01T00:00:00Z',\n        },\n        {\n          id: 'province-1',\n          name: 'Guanacaste',\n          parent_location_id: 'country-1',\n          address: null,\n          coordinates: null,\n          description: null,\n          created_at: '2024-01-01T00:00:00Z',\n        },\n        {\n          id: 'city-1',\n          name: 'Tamarindo',\n          parent_location_id: 'province-1',\n          address: null,\n          coordinates: null,\n          description: null,\n          created_at: '2024-01-01T00:00:00Z',\n        },\n      ];\n\n      const mockOrder = jest.fn().mockResolvedValue({\n        data: mockLocations,\n        error: null,\n      });\n      const mockSelect = jest.fn().mockReturnValue({ order: mockOrder });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await getHierarchy();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(1); // One root location\n        expect(result.data[0].name).toBe('Costa Rica');\n        expect(result.data[0].children).toHaveLength(1);\n        expect(result.data[0].children[0].name).toBe('Guanacaste');\n        expect(result.data[0].children[0].children).toHaveLength(1);\n        expect(result.data[0].children[0].children[0].name).toBe('Tamarindo');\n      }\n    });\n\n    it('should return DATABASE_ERROR when query fails', async () => {\n      const mockOrder = jest.fn().mockResolvedValue({\n        data: null,\n        error: { message: 'Connection failed' },\n      });\n      const mockSelect = jest.fn().mockReturnValue({ order: mockOrder });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await getHierarchy();\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n  });\n\n  describe('getWithChildren', () => {\n    it('should return success with location and its children', async () => {\n      const parentId = 'country-1';\n      \n      // Mock get parent location (first call)\n      const mockSingle = jest.fn().mockResolvedValue({\n        data: {\n          id: 'country-1',\n          name: 'Costa Rica',\n          parent_location_id: null,\n          address: null,\n          coordinates: null,\n          description: null,\n          created_at: '2024-01-01T00:00:00Z',\n        },\n        error: null,\n      });\n      const mockEq = jest.fn().mockReturnValue({ single: mockSingle });\n      const mockSelect1 = jest.fn().mockReturnValue({ eq: mockEq });\n\n      // Mock get all locations for hierarchy building (second call)\n      const mockOrder = jest.fn().mockResolvedValue({\n        data: [\n          {\n            id: 'country-1',\n            name: 'Costa Rica',\n            parent_location_id: null,\n            address: null,\n            coordinates: null,\n            description: null,\n            created_at: '2024-01-01T00:00:00Z',\n          },\n          {\n            id: 'province-1',\n            name: 'Guanacaste',\n            parent_location_id: 'country-1',\n            address: null,\n            coordinates: null,\n            description: null,\n            created_at: '2024-01-01T00:00:00Z',\n          },\n        ],\n        error: null,\n      });\n      const mockSelect2 = jest.fn().mockReturnValue({ order: mockOrder });\n\n      let callCount = 0;\n      mockFrom.mockImplementation((table: string) => {\n        if (table === 'locations') {\n          callCount++;\n          if (callCount === 1) {\n            return { select: mockSelect1 };\n          } else {\n            return { select: mockSelect2 };\n          }\n        }\n        return {};\n      });\n\n      const result = await getWithChildren(parentId);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.name).toBe('Costa Rica');\n        expect(result.data.children).toHaveLength(1);\n        expect(result.data.children[0].name).toBe('Guanacaste');\n      }\n    });\n\n    it('should return NOT_FOUND when parent location does not exist', async () => {\n      const mockSingle = jest.fn().mockResolvedValue({\n        data: null,\n        error: { code: 'PGRST116' },\n      });\n      const mockEq = jest.fn().mockReturnValue({ single: mockSingle });\n      const mockSelect = jest.fn().mockReturnValue({ eq: mockEq });\n      mockFrom.mockReturnValue({ select: mockSelect });\n\n      const result = await getWithChildren('nonexistent-id');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('NOT_FOUND');\n      }\n    });\n  });\n});\n"],"names":["process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","jest","mock","mockFrom","fn","mockSupabaseClient","from","createClient","__mockFrom","sanitizeInput","input","trim","sanitizeRichText","locationServiceModule","require","create","get","update","deleteLocation","list","search","getHierarchy","getWithChildren","describe","beforeEach","clearAllMocks","validData","name","parentLocationId","address","description","it","mockLocation","id","parent_location_id","coordinates","created_at","mockSingle1","mockResolvedValue","data","error","mockEq1","mockReturnValue","single","mockSelect1","eq","mockSingle2","mockSelect2","mockInsert","select","callCount","mockImplementation","table","insert","result","expect","success","toBe","invalidData","code","repeat","mockSingle","mockEq","mockSelect","message","maliciousData","toHaveBeenCalledWith","updateData","mockUpdatedLocation","mockUpdate","locationId","circularData","toContain","invalidParentData","mockDelete","delete","mockLocations","mockRange","count","mockOrder","range","order","filters","page","pageSize","locations","toHaveLength","total","toEqual","mockIs","is","searchParams","query","mockResults","mockOr","or","maliciousSearch","invalidSearch","children","parentId"],"mappings":"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"}