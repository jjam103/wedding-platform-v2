{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/lib/rateLimit.test.ts"],"sourcesContent":["import {\n  checkRateLimit,\n  rateLimitMiddleware,\n  getRateLimitHeaders,\n  checkEmailRateLimit,\n  checkBulkEmailRateLimit,\n  RATE_LIMITS,\n} from './rateLimit';\n\ndescribe('rateLimit', () => {\n  describe('checkRateLimit', () => {\n    it('should allow requests within limit', () => {\n      const identifier = 'test-user-1';\n      const action = 'test-action';\n      const config = { maxRequests: 5, windowMs: 60000 };\n\n      // First request should be allowed\n      const result1 = checkRateLimit(identifier, action, config);\n      expect(result1.allowed).toBe(true);\n      expect(result1.remaining).toBe(4);\n\n      // Second request should be allowed\n      const result2 = checkRateLimit(identifier, action, config);\n      expect(result2.allowed).toBe(true);\n      expect(result2.remaining).toBe(3);\n    });\n\n    it('should block requests exceeding limit', () => {\n      const identifier = 'test-user-2';\n      const action = 'test-action';\n      const config = { maxRequests: 3, windowMs: 60000 };\n\n      // Make 3 requests (at limit)\n      checkRateLimit(identifier, action, config);\n      checkRateLimit(identifier, action, config);\n      const result3 = checkRateLimit(identifier, action, config);\n      expect(result3.allowed).toBe(true);\n      expect(result3.remaining).toBe(0);\n\n      // 4th request should be blocked\n      const result4 = checkRateLimit(identifier, action, config);\n      expect(result4.allowed).toBe(false);\n      expect(result4.remaining).toBe(0);\n      expect(result4.retryAfter).toBeGreaterThan(0);\n    });\n\n    it('should track different identifiers separately', () => {\n      const action = 'test-action';\n      const config = { maxRequests: 2, windowMs: 60000 };\n\n      const result1 = checkRateLimit('user-a', action, config);\n      const result2 = checkRateLimit('user-b', action, config);\n\n      expect(result1.allowed).toBe(true);\n      expect(result1.remaining).toBe(1);\n      expect(result2.allowed).toBe(true);\n      expect(result2.remaining).toBe(1);\n    });\n\n    it('should track different actions separately', () => {\n      const identifier = 'test-user-3';\n      const config = { maxRequests: 2, windowMs: 60000 };\n\n      const result1 = checkRateLimit(identifier, 'action-a', config);\n      const result2 = checkRateLimit(identifier, 'action-b', config);\n\n      expect(result1.allowed).toBe(true);\n      expect(result1.remaining).toBe(1);\n      expect(result2.allowed).toBe(true);\n      expect(result2.remaining).toBe(1);\n    });\n\n    it('should include reset timestamp', () => {\n      const identifier = 'test-user-4';\n      const action = 'test-action';\n      const config = { maxRequests: 5, windowMs: 60000 };\n\n      const result = checkRateLimit(identifier, action, config);\n\n      expect(result.reset).toBeGreaterThan(Math.floor(Date.now() / 1000));\n      expect(result.reset).toBeLessThanOrEqual(Math.floor((Date.now() + config.windowMs) / 1000));\n    });\n  });\n\n  describe('rateLimitMiddleware', () => {\n    it('should return success when within limits', () => {\n      const identifier = 'test-user-5';\n      const action = 'test-action';\n      const config = { maxRequests: 5, windowMs: 60000 };\n\n      const result = rateLimitMiddleware(identifier, action, config);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.allowed).toBe(true);\n      }\n    });\n\n    it('should return error when exceeding limits', () => {\n      const identifier = 'test-user-6';\n      const action = 'test-action';\n      const config = { maxRequests: 2, windowMs: 60000 };\n\n      // Exhaust the limit\n      rateLimitMiddleware(identifier, action, config);\n      rateLimitMiddleware(identifier, action, config);\n\n      // This should fail\n      const result = rateLimitMiddleware(identifier, action, config);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('RATE_LIMIT_EXCEEDED');\n        expect(result.error.details).toHaveProperty('retryAfter');\n      }\n    });\n  });\n\n  describe('getRateLimitHeaders', () => {\n    it('should return standard rate limit headers', () => {\n      const result = {\n        allowed: true,\n        limit: 10,\n        remaining: 5,\n        reset: 1234567890,\n      };\n\n      const headers = getRateLimitHeaders(result);\n\n      expect(headers['X-RateLimit-Limit']).toBe('10');\n      expect(headers['X-RateLimit-Remaining']).toBe('5');\n      expect(headers['X-RateLimit-Reset']).toBe('1234567890');\n    });\n\n    it('should include Retry-After when provided', () => {\n      const result = {\n        allowed: false,\n        limit: 10,\n        remaining: 0,\n        reset: 1234567890,\n        retryAfter: 60,\n      };\n\n      const headers = getRateLimitHeaders(result);\n\n      expect(headers['Retry-After']).toBe('60');\n    });\n  });\n\n  describe('checkEmailRateLimit', () => {\n    it('should allow email within limits', () => {\n      const userId = 'user-email-1';\n      const recipientEmail = 'recipient1@example.com';\n\n      const result = checkEmailRateLimit(userId, recipientEmail);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.canSend).toBe(true);\n      }\n    });\n\n    it('should block email when user limit exceeded', () => {\n      const userId = 'user-email-2';\n      const recipientEmail = 'recipient2@example.com';\n\n      // Exhaust user limit (10 emails per hour)\n      for (let i = 0; i < 10; i++) {\n        checkEmailRateLimit(userId, `recipient${i}@example.com`);\n      }\n\n      const result = checkEmailRateLimit(userId, recipientEmail);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('EMAIL_RATE_LIMIT_EXCEEDED');\n      }\n    });\n\n    it('should block email when recipient limit exceeded', () => {\n      const recipientEmail = 'recipient3@example.com';\n\n      // Exhaust recipient limit (3 emails per hour)\n      for (let i = 0; i < 3; i++) {\n        checkEmailRateLimit(`user${i}@example.com`, recipientEmail);\n      }\n\n      const result = checkEmailRateLimit('another-user@example.com', recipientEmail);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('RECIPIENT_RATE_LIMIT_EXCEEDED');\n      }\n    });\n  });\n\n  describe('checkBulkEmailRateLimit', () => {\n    it('should allow bulk email within limits', () => {\n      const userId = 'user-bulk-1';\n      const recipientCount = 50;\n\n      const result = checkBulkEmailRateLimit(userId, recipientCount);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.canSend).toBe(true);\n      }\n    });\n\n    it('should block bulk email when limit exceeded', () => {\n      const userId = 'user-bulk-2';\n\n      // Exhaust bulk limit (100 per hour)\n      for (let i = 0; i < 100; i++) {\n        checkBulkEmailRateLimit(userId, 1);\n      }\n\n      const result = checkBulkEmailRateLimit(userId, 10);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('BULK_EMAIL_RATE_LIMIT_EXCEEDED');\n      }\n    });\n\n    it('should block bulk email when recipient count would exceed remaining limit', () => {\n      const userId = 'user-bulk-3';\n\n      // Use up 95 of 100 limit\n      for (let i = 0; i < 95; i++) {\n        checkBulkEmailRateLimit(userId, 1);\n      }\n\n      // Try to send to 10 recipients (would exceed limit)\n      const result = checkBulkEmailRateLimit(userId, 10);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('BULK_EMAIL_WOULD_EXCEED_LIMIT');\n        expect(result.error.details).toHaveProperty('remaining');\n      }\n    });\n  });\n\n  describe('RATE_LIMITS configuration', () => {\n    it('should have API rate limits defined', () => {\n      expect(RATE_LIMITS.api.strict).toBeDefined();\n      expect(RATE_LIMITS.api.moderate).toBeDefined();\n      expect(RATE_LIMITS.api.relaxed).toBeDefined();\n    });\n\n    it('should have email rate limits defined', () => {\n      expect(RATE_LIMITS.email.perUser).toBeDefined();\n      expect(RATE_LIMITS.email.perRecipient).toBeDefined();\n      expect(RATE_LIMITS.email.bulk).toBeDefined();\n    });\n\n    it('should have auth rate limits defined', () => {\n      expect(RATE_LIMITS.auth.login).toBeDefined();\n      expect(RATE_LIMITS.auth.passwordReset).toBeDefined();\n    });\n\n    it('should have upload rate limits defined', () => {\n      expect(RATE_LIMITS.upload.photos).toBeDefined();\n      expect(RATE_LIMITS.upload.documents).toBeDefined();\n    });\n  });\n});\n"],"names":["describe","it","identifier","action","config","maxRequests","windowMs","result1","checkRateLimit","expect","allowed","toBe","remaining","result2","result3","result4","retryAfter","toBeGreaterThan","result","reset","Math","floor","Date","now","toBeLessThanOrEqual","rateLimitMiddleware","success","data","error","code","details","toHaveProperty","limit","headers","getRateLimitHeaders","userId","recipientEmail","checkEmailRateLimit","canSend","i","recipientCount","checkBulkEmailRateLimit","RATE_LIMITS","api","strict","toBeDefined","moderate","relaxed","email","perUser","perRecipient","bulk","auth","login","passwordReset","upload","photos","documents"],"mappings":";;;;2BAOO;AAEPA,SAAS,aAAa;IACpBA,SAAS,kBAAkB;QACzBC,GAAG,sCAAsC;YACvC,MAAMC,aAAa;YACnB,MAAMC,SAAS;YACf,MAAMC,SAAS;gBAAEC,aAAa;gBAAGC,UAAU;YAAM;YAEjD,kCAAkC;YAClC,MAAMC,UAAUC,IAAAA,yBAAc,EAACN,YAAYC,QAAQC;YACnDK,OAAOF,QAAQG,OAAO,EAAEC,IAAI,CAAC;YAC7BF,OAAOF,QAAQK,SAAS,EAAED,IAAI,CAAC;YAE/B,mCAAmC;YACnC,MAAME,UAAUL,IAAAA,yBAAc,EAACN,YAAYC,QAAQC;YACnDK,OAAOI,QAAQH,OAAO,EAAEC,IAAI,CAAC;YAC7BF,OAAOI,QAAQD,SAAS,EAAED,IAAI,CAAC;QACjC;QAEAV,GAAG,yCAAyC;YAC1C,MAAMC,aAAa;YACnB,MAAMC,SAAS;YACf,MAAMC,SAAS;gBAAEC,aAAa;gBAAGC,UAAU;YAAM;YAEjD,6BAA6B;YAC7BE,IAAAA,yBAAc,EAACN,YAAYC,QAAQC;YACnCI,IAAAA,yBAAc,EAACN,YAAYC,QAAQC;YACnC,MAAMU,UAAUN,IAAAA,yBAAc,EAACN,YAAYC,QAAQC;YACnDK,OAAOK,QAAQJ,OAAO,EAAEC,IAAI,CAAC;YAC7BF,OAAOK,QAAQF,SAAS,EAAED,IAAI,CAAC;YAE/B,gCAAgC;YAChC,MAAMI,UAAUP,IAAAA,yBAAc,EAACN,YAAYC,QAAQC;YACnDK,OAAOM,QAAQL,OAAO,EAAEC,IAAI,CAAC;YAC7BF,OAAOM,QAAQH,SAAS,EAAED,IAAI,CAAC;YAC/BF,OAAOM,QAAQC,UAAU,EAAEC,eAAe,CAAC;QAC7C;QAEAhB,GAAG,iDAAiD;YAClD,MAAME,SAAS;YACf,MAAMC,SAAS;gBAAEC,aAAa;gBAAGC,UAAU;YAAM;YAEjD,MAAMC,UAAUC,IAAAA,yBAAc,EAAC,UAAUL,QAAQC;YACjD,MAAMS,UAAUL,IAAAA,yBAAc,EAAC,UAAUL,QAAQC;YAEjDK,OAAOF,QAAQG,OAAO,EAAEC,IAAI,CAAC;YAC7BF,OAAOF,QAAQK,SAAS,EAAED,IAAI,CAAC;YAC/BF,OAAOI,QAAQH,OAAO,EAAEC,IAAI,CAAC;YAC7BF,OAAOI,QAAQD,SAAS,EAAED,IAAI,CAAC;QACjC;QAEAV,GAAG,6CAA6C;YAC9C,MAAMC,aAAa;YACnB,MAAME,SAAS;gBAAEC,aAAa;gBAAGC,UAAU;YAAM;YAEjD,MAAMC,UAAUC,IAAAA,yBAAc,EAACN,YAAY,YAAYE;YACvD,MAAMS,UAAUL,IAAAA,yBAAc,EAACN,YAAY,YAAYE;YAEvDK,OAAOF,QAAQG,OAAO,EAAEC,IAAI,CAAC;YAC7BF,OAAOF,QAAQK,SAAS,EAAED,IAAI,CAAC;YAC/BF,OAAOI,QAAQH,OAAO,EAAEC,IAAI,CAAC;YAC7BF,OAAOI,QAAQD,SAAS,EAAED,IAAI,CAAC;QACjC;QAEAV,GAAG,kCAAkC;YACnC,MAAMC,aAAa;YACnB,MAAMC,SAAS;YACf,MAAMC,SAAS;gBAAEC,aAAa;gBAAGC,UAAU;YAAM;YAEjD,MAAMY,SAASV,IAAAA,yBAAc,EAACN,YAAYC,QAAQC;YAElDK,OAAOS,OAAOC,KAAK,EAAEF,eAAe,CAACG,KAAKC,KAAK,CAACC,KAAKC,GAAG,KAAK;YAC7Dd,OAAOS,OAAOC,KAAK,EAAEK,mBAAmB,CAACJ,KAAKC,KAAK,CAAC,AAACC,CAAAA,KAAKC,GAAG,KAAKnB,OAAOE,QAAQ,AAAD,IAAK;QACvF;IACF;IAEAN,SAAS,uBAAuB;QAC9BC,GAAG,4CAA4C;YAC7C,MAAMC,aAAa;YACnB,MAAMC,SAAS;YACf,MAAMC,SAAS;gBAAEC,aAAa;gBAAGC,UAAU;YAAM;YAEjD,MAAMY,SAASO,IAAAA,8BAAmB,EAACvB,YAAYC,QAAQC;YAEvDK,OAAOS,OAAOQ,OAAO,EAAEf,IAAI,CAAC;YAC5B,IAAIO,OAAOQ,OAAO,EAAE;gBAClBjB,OAAOS,OAAOS,IAAI,CAACjB,OAAO,EAAEC,IAAI,CAAC;YACnC;QACF;QAEAV,GAAG,6CAA6C;YAC9C,MAAMC,aAAa;YACnB,MAAMC,SAAS;YACf,MAAMC,SAAS;gBAAEC,aAAa;gBAAGC,UAAU;YAAM;YAEjD,oBAAoB;YACpBmB,IAAAA,8BAAmB,EAACvB,YAAYC,QAAQC;YACxCqB,IAAAA,8BAAmB,EAACvB,YAAYC,QAAQC;YAExC,mBAAmB;YACnB,MAAMc,SAASO,IAAAA,8BAAmB,EAACvB,YAAYC,QAAQC;YAEvDK,OAAOS,OAAOQ,OAAO,EAAEf,IAAI,CAAC;YAC5B,IAAI,CAACO,OAAOQ,OAAO,EAAE;gBACnBjB,OAAOS,OAAOU,KAAK,CAACC,IAAI,EAAElB,IAAI,CAAC;gBAC/BF,OAAOS,OAAOU,KAAK,CAACE,OAAO,EAAEC,cAAc,CAAC;YAC9C;QACF;IACF;IAEA/B,SAAS,uBAAuB;QAC9BC,GAAG,6CAA6C;YAC9C,MAAMiB,SAAS;gBACbR,SAAS;gBACTsB,OAAO;gBACPpB,WAAW;gBACXO,OAAO;YACT;YAEA,MAAMc,UAAUC,IAAAA,8BAAmB,EAAChB;YAEpCT,OAAOwB,OAAO,CAAC,oBAAoB,EAAEtB,IAAI,CAAC;YAC1CF,OAAOwB,OAAO,CAAC,wBAAwB,EAAEtB,IAAI,CAAC;YAC9CF,OAAOwB,OAAO,CAAC,oBAAoB,EAAEtB,IAAI,CAAC;QAC5C;QAEAV,GAAG,4CAA4C;YAC7C,MAAMiB,SAAS;gBACbR,SAAS;gBACTsB,OAAO;gBACPpB,WAAW;gBACXO,OAAO;gBACPH,YAAY;YACd;YAEA,MAAMiB,UAAUC,IAAAA,8BAAmB,EAAChB;YAEpCT,OAAOwB,OAAO,CAAC,cAAc,EAAEtB,IAAI,CAAC;QACtC;IACF;IAEAX,SAAS,uBAAuB;QAC9BC,GAAG,oCAAoC;YACrC,MAAMkC,SAAS;YACf,MAAMC,iBAAiB;YAEvB,MAAMlB,SAASmB,IAAAA,8BAAmB,EAACF,QAAQC;YAE3C3B,OAAOS,OAAOQ,OAAO,EAAEf,IAAI,CAAC;YAC5B,IAAIO,OAAOQ,OAAO,EAAE;gBAClBjB,OAAOS,OAAOS,IAAI,CAACW,OAAO,EAAE3B,IAAI,CAAC;YACnC;QACF;QAEAV,GAAG,+CAA+C;YAChD,MAAMkC,SAAS;YACf,MAAMC,iBAAiB;YAEvB,0CAA0C;YAC1C,IAAK,IAAIG,IAAI,GAAGA,IAAI,IAAIA,IAAK;gBAC3BF,IAAAA,8BAAmB,EAACF,QAAQ,CAAC,SAAS,EAAEI,EAAE,YAAY,CAAC;YACzD;YAEA,MAAMrB,SAASmB,IAAAA,8BAAmB,EAACF,QAAQC;YAE3C3B,OAAOS,OAAOQ,OAAO,EAAEf,IAAI,CAAC;YAC5B,IAAI,CAACO,OAAOQ,OAAO,EAAE;gBACnBjB,OAAOS,OAAOU,KAAK,CAACC,IAAI,EAAElB,IAAI,CAAC;YACjC;QACF;QAEAV,GAAG,oDAAoD;YACrD,MAAMmC,iBAAiB;YAEvB,8CAA8C;YAC9C,IAAK,IAAIG,IAAI,GAAGA,IAAI,GAAGA,IAAK;gBAC1BF,IAAAA,8BAAmB,EAAC,CAAC,IAAI,EAAEE,EAAE,YAAY,CAAC,EAAEH;YAC9C;YAEA,MAAMlB,SAASmB,IAAAA,8BAAmB,EAAC,4BAA4BD;YAE/D3B,OAAOS,OAAOQ,OAAO,EAAEf,IAAI,CAAC;YAC5B,IAAI,CAACO,OAAOQ,OAAO,EAAE;gBACnBjB,OAAOS,OAAOU,KAAK,CAACC,IAAI,EAAElB,IAAI,CAAC;YACjC;QACF;IACF;IAEAX,SAAS,2BAA2B;QAClCC,GAAG,yCAAyC;YAC1C,MAAMkC,SAAS;YACf,MAAMK,iBAAiB;YAEvB,MAAMtB,SAASuB,IAAAA,kCAAuB,EAACN,QAAQK;YAE/C/B,OAAOS,OAAOQ,OAAO,EAAEf,IAAI,CAAC;YAC5B,IAAIO,OAAOQ,OAAO,EAAE;gBAClBjB,OAAOS,OAAOS,IAAI,CAACW,OAAO,EAAE3B,IAAI,CAAC;YACnC;QACF;QAEAV,GAAG,+CAA+C;YAChD,MAAMkC,SAAS;YAEf,oCAAoC;YACpC,IAAK,IAAII,IAAI,GAAGA,IAAI,KAAKA,IAAK;gBAC5BE,IAAAA,kCAAuB,EAACN,QAAQ;YAClC;YAEA,MAAMjB,SAASuB,IAAAA,kCAAuB,EAACN,QAAQ;YAE/C1B,OAAOS,OAAOQ,OAAO,EAAEf,IAAI,CAAC;YAC5B,IAAI,CAACO,OAAOQ,OAAO,EAAE;gBACnBjB,OAAOS,OAAOU,KAAK,CAACC,IAAI,EAAElB,IAAI,CAAC;YACjC;QACF;QAEAV,GAAG,6EAA6E;YAC9E,MAAMkC,SAAS;YAEf,yBAAyB;YACzB,IAAK,IAAII,IAAI,GAAGA,IAAI,IAAIA,IAAK;gBAC3BE,IAAAA,kCAAuB,EAACN,QAAQ;YAClC;YAEA,oDAAoD;YACpD,MAAMjB,SAASuB,IAAAA,kCAAuB,EAACN,QAAQ;YAE/C1B,OAAOS,OAAOQ,OAAO,EAAEf,IAAI,CAAC;YAC5B,IAAI,CAACO,OAAOQ,OAAO,EAAE;gBACnBjB,OAAOS,OAAOU,KAAK,CAACC,IAAI,EAAElB,IAAI,CAAC;gBAC/BF,OAAOS,OAAOU,KAAK,CAACE,OAAO,EAAEC,cAAc,CAAC;YAC9C;QACF;IACF;IAEA/B,SAAS,6BAA6B;QACpCC,GAAG,uCAAuC;YACxCQ,OAAOiC,sBAAW,CAACC,GAAG,CAACC,MAAM,EAAEC,WAAW;YAC1CpC,OAAOiC,sBAAW,CAACC,GAAG,CAACG,QAAQ,EAAED,WAAW;YAC5CpC,OAAOiC,sBAAW,CAACC,GAAG,CAACI,OAAO,EAAEF,WAAW;QAC7C;QAEA5C,GAAG,yCAAyC;YAC1CQ,OAAOiC,sBAAW,CAACM,KAAK,CAACC,OAAO,EAAEJ,WAAW;YAC7CpC,OAAOiC,sBAAW,CAACM,KAAK,CAACE,YAAY,EAAEL,WAAW;YAClDpC,OAAOiC,sBAAW,CAACM,KAAK,CAACG,IAAI,EAAEN,WAAW;QAC5C;QAEA5C,GAAG,wCAAwC;YACzCQ,OAAOiC,sBAAW,CAACU,IAAI,CAACC,KAAK,EAAER,WAAW;YAC1CpC,OAAOiC,sBAAW,CAACU,IAAI,CAACE,aAAa,EAAET,WAAW;QACpD;QAEA5C,GAAG,0CAA0C;YAC3CQ,OAAOiC,sBAAW,CAACa,MAAM,CAACC,MAAM,EAAEX,WAAW;YAC7CpC,OAAOiC,sBAAW,CAACa,MAAM,CAACE,SAAS,EAAEZ,WAAW;QAClD;IACF;AACF"}