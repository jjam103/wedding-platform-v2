4febe377ee1d581c34314ca1e02b6610
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "POST", {
    enumerable: true,
    get: function() {
        return POST;
    }
});
const _ssr = require("@supabase/ssr");
const _headers = require("next/headers");
const _server = require("next/server");
const _supabasejs = require("@supabase/supabase-js");
async function POST(request, { params }) {
    // 1. Auth check
    const cookieStore = await (0, _headers.cookies)();
    const supabase = (0, _ssr.createServerClient)(process.env.NEXT_PUBLIC_SUPABASE_URL, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY, {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                cookiesToSet.forEach(({ name, value })=>{
                    cookieStore.set(name, value);
                });
            }
        }
    });
    const { data: { session }, error: authError } = await supabase.auth.getSession();
    if (authError || !session) {
        return _server.NextResponse.json({
            success: false,
            error: {
                code: 'UNAUTHORIZED',
                message: 'Authentication required'
            }
        }, {
            status: 401
        });
    }
    // 2. Parse request body
    const body = await request.json();
    const { parentLocationId } = body;
    if (!parentLocationId) {
        return _server.NextResponse.json({
            success: false,
            error: {
                code: 'VALIDATION_ERROR',
                message: 'parentLocationId is required'
            }
        }, {
            status: 400
        });
    }
    // 3. Check for circular reference
    const resolvedParams = await params;
    const wouldCreateCycle = await checkCircularReference(resolvedParams.id, parentLocationId);
    if (wouldCreateCycle) {
        return _server.NextResponse.json({
            success: false,
            error: {
                code: 'CIRCULAR_REFERENCE',
                message: 'This would create a circular reference in the location hierarchy'
            }
        }, {
            status: 409
        });
    }
    return _server.NextResponse.json({
        success: true,
        data: {
            valid: true
        }
    }, {
        status: 200
    });
}
/**
 * Checks if setting a parent would create a circular reference.
 */ async function checkCircularReference(locationId, newParentId) {
    // Prevent setting self as parent
    if (locationId === newParentId) {
        return true;
    }
    const supabase = (0, _supabasejs.createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);
    // Get all locations
    const { data, error } = await supabase.from('locations').select('id, parent_location_id');
    if (error || !data) {
        return false; // If we can't check, allow the operation
    }
    // Build parent map
    const parentMap = new Map();
    data.forEach((location)=>{
        parentMap.set(location.id, location.parent_location_id);
    });
    // Walk up the tree from newParentId to see if we encounter locationId
    let currentId = newParentId;
    const visited = new Set();
    while(currentId){
        if (currentId === locationId) {
            return true; // Circular reference detected
        }
        if (visited.has(currentId)) {
            return true; // Already visited, circular reference exists
        }
        visited.add(currentId);
        currentId = parentMap.get(currentId) || null;
    }
    return false; // No circular reference
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9qYXJvbi9EZXNrdG9wL3dlZGRpbmctcGxhdGZvcm0tdjIvYXBwL2FwaS9hZG1pbi9sb2NhdGlvbnMvW2lkXS92YWxpZGF0ZS1wYXJlbnQvcm91dGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlU2VydmVyQ2xpZW50IH0gZnJvbSAnQHN1cGFiYXNlL3Nzcic7XG5pbXBvcnQgeyBjb29raWVzIH0gZnJvbSAnbmV4dC9oZWFkZXJzJztcbmltcG9ydCB7IE5leHRSZXNwb25zZSB9IGZyb20gJ25leHQvc2VydmVyJztcbmltcG9ydCB7IGNyZWF0ZUNsaWVudCB9IGZyb20gJ0BzdXBhYmFzZS9zdXBhYmFzZS1qcyc7XG5cbi8qKlxuICogUE9TVCAvYXBpL2FkbWluL2xvY2F0aW9ucy86aWQvdmFsaWRhdGUtcGFyZW50IC0gQ2hlY2sgY2lyY3VsYXIgcmVmc1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gUE9TVChcbiAgcmVxdWVzdDogUmVxdWVzdCxcbiAgeyBwYXJhbXMgfTogeyBwYXJhbXM6IFByb21pc2U8eyBpZDogc3RyaW5nIH0+IH1cbikge1xuICAvLyAxLiBBdXRoIGNoZWNrXG4gIGNvbnN0IGNvb2tpZVN0b3JlID0gYXdhaXQgY29va2llcygpO1xuICAgIGNvbnN0IHN1cGFiYXNlID0gY3JlYXRlU2VydmVyQ2xpZW50KFxuICAgICAgcHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfU1VQQUJBU0VfVVJMISxcbiAgICAgIHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX1NVUEFCQVNFX0FOT05fS0VZISxcbiAgICAgIHtcbiAgICAgICAgY29va2llczoge1xuICAgICAgICAgIGdldEFsbCgpIHtcbiAgICAgICAgICAgIHJldHVybiBjb29raWVTdG9yZS5nZXRBbGwoKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNldEFsbChjb29raWVzVG9TZXQpIHtcbiAgICAgICAgICAgIGNvb2tpZXNUb1NldC5mb3JFYWNoKCh7IG5hbWUsIHZhbHVlIH0pID0+IHtcbiAgICAgICAgICAgICAgY29va2llU3RvcmUuc2V0KG5hbWUsIHZhbHVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcbiAgY29uc3Qge1xuICAgIGRhdGE6IHsgc2Vzc2lvbiB9LFxuICAgIGVycm9yOiBhdXRoRXJyb3IsXG4gIH0gPSBhd2FpdCBzdXBhYmFzZS5hdXRoLmdldFNlc3Npb24oKTtcblxuICBpZiAoYXV0aEVycm9yIHx8ICFzZXNzaW9uKSB7XG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHsgY29kZTogJ1VOQVVUSE9SSVpFRCcsIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcgfSxcbiAgICAgIH0sXG4gICAgICB7IHN0YXR1czogNDAxIH1cbiAgICApO1xuICB9XG5cbiAgLy8gMi4gUGFyc2UgcmVxdWVzdCBib2R5XG4gIGNvbnN0IGJvZHkgPSBhd2FpdCByZXF1ZXN0Lmpzb24oKTtcbiAgY29uc3QgeyBwYXJlbnRMb2NhdGlvbklkIH0gPSBib2R5O1xuXG4gIGlmICghcGFyZW50TG9jYXRpb25JZCkge1xuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiB7IGNvZGU6ICdWQUxJREFUSU9OX0VSUk9SJywgbWVzc2FnZTogJ3BhcmVudExvY2F0aW9uSWQgaXMgcmVxdWlyZWQnIH0sXG4gICAgICB9LFxuICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgKTtcbiAgfVxuXG4gIC8vIDMuIENoZWNrIGZvciBjaXJjdWxhciByZWZlcmVuY2VcbiAgY29uc3QgcmVzb2x2ZWRQYXJhbXMgPSBhd2FpdCBwYXJhbXM7XG5cbiAgY29uc3Qgd291bGRDcmVhdGVDeWNsZSA9IGF3YWl0IGNoZWNrQ2lyY3VsYXJSZWZlcmVuY2UocmVzb2x2ZWRQYXJhbXMuaWQsIHBhcmVudExvY2F0aW9uSWQpO1xuXG4gIGlmICh3b3VsZENyZWF0ZUN5Y2xlKSB7XG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICBjb2RlOiAnQ0lSQ1VMQVJfUkVGRVJFTkNFJyxcbiAgICAgICAgICBtZXNzYWdlOiAnVGhpcyB3b3VsZCBjcmVhdGUgYSBjaXJjdWxhciByZWZlcmVuY2UgaW4gdGhlIGxvY2F0aW9uIGhpZXJhcmNoeScsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgeyBzdGF0dXM6IDQwOSB9XG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICB7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YTogeyB2YWxpZDogdHJ1ZSB9LFxuICAgIH0sXG4gICAgeyBzdGF0dXM6IDIwMCB9XG4gICk7XG59XG5cbi8qKlxuICogQ2hlY2tzIGlmIHNldHRpbmcgYSBwYXJlbnQgd291bGQgY3JlYXRlIGEgY2lyY3VsYXIgcmVmZXJlbmNlLlxuICovXG5hc3luYyBmdW5jdGlvbiBjaGVja0NpcmN1bGFyUmVmZXJlbmNlKFxuICBsb2NhdGlvbklkOiBzdHJpbmcsXG4gIG5ld1BhcmVudElkOiBzdHJpbmdcbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAvLyBQcmV2ZW50IHNldHRpbmcgc2VsZiBhcyBwYXJlbnRcbiAgaWYgKGxvY2F0aW9uSWQgPT09IG5ld1BhcmVudElkKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBjb25zdCBzdXBhYmFzZSA9IGNyZWF0ZUNsaWVudChcbiAgICBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwhLFxuICAgIHByb2Nlc3MuZW52LlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVkhXG4gICk7XG5cbiAgLy8gR2V0IGFsbCBsb2NhdGlvbnNcbiAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAuZnJvbSgnbG9jYXRpb25zJylcbiAgICAuc2VsZWN0KCdpZCwgcGFyZW50X2xvY2F0aW9uX2lkJyk7XG5cbiAgaWYgKGVycm9yIHx8ICFkYXRhKSB7XG4gICAgcmV0dXJuIGZhbHNlOyAvLyBJZiB3ZSBjYW4ndCBjaGVjaywgYWxsb3cgdGhlIG9wZXJhdGlvblxuICB9XG5cbiAgLy8gQnVpbGQgcGFyZW50IG1hcFxuICBjb25zdCBwYXJlbnRNYXAgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nIHwgbnVsbD4oKTtcbiAgZGF0YS5mb3JFYWNoKChsb2NhdGlvbikgPT4ge1xuICAgIHBhcmVudE1hcC5zZXQobG9jYXRpb24uaWQsIGxvY2F0aW9uLnBhcmVudF9sb2NhdGlvbl9pZCk7XG4gIH0pO1xuXG4gIC8vIFdhbGsgdXAgdGhlIHRyZWUgZnJvbSBuZXdQYXJlbnRJZCB0byBzZWUgaWYgd2UgZW5jb3VudGVyIGxvY2F0aW9uSWRcbiAgbGV0IGN1cnJlbnRJZDogc3RyaW5nIHwgbnVsbCA9IG5ld1BhcmVudElkO1xuICBjb25zdCB2aXNpdGVkID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cbiAgd2hpbGUgKGN1cnJlbnRJZCkge1xuICAgIGlmIChjdXJyZW50SWQgPT09IGxvY2F0aW9uSWQpIHtcbiAgICAgIHJldHVybiB0cnVlOyAvLyBDaXJjdWxhciByZWZlcmVuY2UgZGV0ZWN0ZWRcbiAgICB9XG4gICAgaWYgKHZpc2l0ZWQuaGFzKGN1cnJlbnRJZCkpIHtcbiAgICAgIHJldHVybiB0cnVlOyAvLyBBbHJlYWR5IHZpc2l0ZWQsIGNpcmN1bGFyIHJlZmVyZW5jZSBleGlzdHNcbiAgICB9XG4gICAgdmlzaXRlZC5hZGQoY3VycmVudElkKTtcbiAgICBjdXJyZW50SWQgPSBwYXJlbnRNYXAuZ2V0KGN1cnJlbnRJZCkgfHwgbnVsbDtcbiAgfVxuXG4gIHJldHVybiBmYWxzZTsgLy8gTm8gY2lyY3VsYXIgcmVmZXJlbmNlXG59XG4iXSwibmFtZXMiOlsiUE9TVCIsInJlcXVlc3QiLCJwYXJhbXMiLCJjb29raWVTdG9yZSIsImNvb2tpZXMiLCJzdXBhYmFzZSIsImNyZWF0ZVNlcnZlckNsaWVudCIsInByb2Nlc3MiLCJlbnYiLCJORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwiLCJORVhUX1BVQkxJQ19TVVBBQkFTRV9BTk9OX0tFWSIsImdldEFsbCIsInNldEFsbCIsImNvb2tpZXNUb1NldCIsImZvckVhY2giLCJuYW1lIiwidmFsdWUiLCJzZXQiLCJkYXRhIiwic2Vzc2lvbiIsImVycm9yIiwiYXV0aEVycm9yIiwiYXV0aCIsImdldFNlc3Npb24iLCJOZXh0UmVzcG9uc2UiLCJqc29uIiwic3VjY2VzcyIsImNvZGUiLCJtZXNzYWdlIiwic3RhdHVzIiwiYm9keSIsInBhcmVudExvY2F0aW9uSWQiLCJyZXNvbHZlZFBhcmFtcyIsIndvdWxkQ3JlYXRlQ3ljbGUiLCJjaGVja0NpcmN1bGFyUmVmZXJlbmNlIiwiaWQiLCJ2YWxpZCIsImxvY2F0aW9uSWQiLCJuZXdQYXJlbnRJZCIsImNyZWF0ZUNsaWVudCIsIlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVkiLCJmcm9tIiwic2VsZWN0IiwicGFyZW50TWFwIiwiTWFwIiwibG9jYXRpb24iLCJwYXJlbnRfbG9jYXRpb25faWQiLCJjdXJyZW50SWQiLCJ2aXNpdGVkIiwiU2V0IiwiaGFzIiwiYWRkIiwiZ2V0Il0sIm1hcHBpbmdzIjoiOzs7OytCQVFzQkE7OztlQUFBQTs7O3FCQVJhO3lCQUNYO3dCQUNLOzRCQUNBO0FBS3RCLGVBQWVBLEtBQ3BCQyxPQUFnQixFQUNoQixFQUFFQyxNQUFNLEVBQXVDO0lBRS9DLGdCQUFnQjtJQUNoQixNQUFNQyxjQUFjLE1BQU1DLElBQUFBLGdCQUFPO0lBQy9CLE1BQU1DLFdBQVdDLElBQUFBLHVCQUFrQixFQUNqQ0MsUUFBUUMsR0FBRyxDQUFDQyx3QkFBd0IsRUFDcENGLFFBQVFDLEdBQUcsQ0FBQ0UsNkJB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