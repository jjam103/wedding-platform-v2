{"version":3,"names":["cov_8gdzj12uc","actualCoverage","s","POST","driverSheetsSchema","_zod","z","object","date","string","regex","type","enum","request","f","cookieStore","_headers","cookies","supabase","_ssr","createServerClient","process","env","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","getAll","setAll","cookiesToSet","forEach","name","value","set","data","session","error","authError","auth","getSession","b","_server","NextResponse","json","success","code","message","status","body","validation","safeParse","details","issues","dateField","timeField","guests","from","select","eq","not","order","shuttleGroups","Map","guest","shuttle","shuttle_assignment","has","get","push","html","generateDriverSheetsHTML","Error","title","entries","length","time","substring","first_name","last_name","flight_number","airport_code","phone"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/transportation/driver-sheets/route.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr';\nimport { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\nimport { z } from 'zod';\n\nconst driverSheetsSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/),\n  type: z.enum(['arrivals', 'departures']),\n});\n\n/**\n * POST /api/admin/transportation/driver-sheets\n * Generate driver sheets for a specific date\n */\nexport async function POST(request: Request) {\n  try {\n    // 1. Auth check\n    const cookieStore = await cookies();\n    const supabase = createServerClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n      {\n        cookies: {\n          getAll() {\n            return cookieStore.getAll();\n          },\n          setAll(cookiesToSet) {\n            cookiesToSet.forEach(({ name, value }) => {\n              cookieStore.set(name, value);\n            });\n          },\n        },\n      }\n    );\n    const {\n      data: { session },\n      error: authError,\n    } = await supabase.auth.getSession();\n\n    if (authError || !session) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: { code: 'UNAUTHORIZED', message: 'Authentication required' },\n        },\n        { status: 401 }\n      );\n    }\n\n    // 2. Parse and validate request body\n    const body = await request.json();\n    const validation = driverSheetsSchema.safeParse(body);\n\n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid request data',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    const { date, type } = validation.data;\n\n    // 3. Query guests\n    const dateField = type === 'arrivals' ? 'arrival_date' : 'departure_date';\n    const timeField = type === 'arrivals' ? 'arrival_time' : 'departure_time';\n\n    const { data: guests, error } = await supabase\n      .from('guests')\n      .select(`id, first_name, last_name, ${timeField}, airport_code, flight_number, phone, shuttle_assignment`)\n      .eq(dateField, date)\n      .not('airport_code', 'is', null)\n      .order(timeField);\n\n    if (error) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: { code: 'DATABASE_ERROR', message: error.message, details: error },\n        },\n        { status: 500 }\n      );\n    }\n\n    // 4. Group by shuttle assignment\n    const shuttleGroups = new Map<string, any[]>();\n    \n    guests?.forEach((guest: any) => {\n      const shuttle = guest.shuttle_assignment || 'Unassigned';\n      if (!shuttleGroups.has(shuttle)) {\n        shuttleGroups.set(shuttle, []);\n      }\n      shuttleGroups.get(shuttle)!.push(guest);\n    });\n\n    // 5. Generate HTML for driver sheets\n    const html = generateDriverSheetsHTML(shuttleGroups, date, type);\n\n    return NextResponse.json({\n      success: true,\n      data: { html },\n    });\n  } catch (error) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'UNKNOWN_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n\nfunction generateDriverSheetsHTML(\n  shuttleGroups: Map<string, any[]>,\n  date: string,\n  type: string\n): string {\n  const title = type === 'arrivals' ? 'Arrival' : 'Departure';\n  \n  let html = `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <title>Driver Sheets - ${title} - ${date}</title>\n      <style>\n        body { font-family: Arial, sans-serif; margin: 20px; }\n        h1 { text-align: center; }\n        .shuttle-group { page-break-after: always; margin-bottom: 40px; }\n        .shuttle-group:last-child { page-break-after: auto; }\n        table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n        th { background-color: #f2f2f2; }\n        .summary { margin-top: 20px; font-weight: bold; }\n        @media print {\n          .shuttle-group { page-break-after: always; }\n        }\n      </style>\n    </head>\n    <body>\n      <h1>${title} Driver Sheets - ${date}</h1>\n  `;\n\n  for (const [shuttle, guests] of shuttleGroups.entries()) {\n    html += `\n      <div class=\"shuttle-group\">\n        <h2>Shuttle: ${shuttle}</h2>\n        <p class=\"summary\">Total Guests: ${guests.length}</p>\n        <table>\n          <thead>\n            <tr>\n              <th>Guest Name</th>\n              <th>Flight</th>\n              <th>Time</th>\n              <th>Airport</th>\n              <th>Phone</th>\n            </tr>\n          </thead>\n          <tbody>\n    `;\n\n    guests.forEach((guest: any) => {\n      const timeField = type === 'arrivals' ? 'arrival_time' : 'departure_time';\n      const time = guest[timeField] ? guest[timeField].substring(0, 5) : '-';\n      \n      html += `\n        <tr>\n          <td>${guest.first_name} ${guest.last_name}</td>\n          <td>${guest.flight_number || '-'}</td>\n          <td>${time}</td>\n          <td>${guest.airport_code || '-'}</td>\n          <td>${guest.phone || '-'}</td>\n        </tr>\n      `;\n    });\n\n    html += `\n          </tbody>\n        </table>\n      </div>\n    `;\n  }\n\n  html += `\n    </body>\n    </html>\n  `;\n\n  return html;\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}