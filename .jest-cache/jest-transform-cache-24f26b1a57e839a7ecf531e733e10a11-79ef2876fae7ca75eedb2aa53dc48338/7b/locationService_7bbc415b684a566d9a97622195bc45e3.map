{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/locationService.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { sanitizeInput, sanitizeRichText } from \"../utils/sanitization\";\nimport {\n  createLocationSchema,\n  updateLocationSchema,\n  locationFilterSchema,\n  locationSearchSchema,\n  type CreateLocationDTO,\n  type UpdateLocationDTO,\n  type LocationFilterDTO,\n  type LocationSearchDTO,\n  type Location,\n  type PaginatedLocations,\n  type LocationWithChildren,\n} from '../schemas/locationSchemas';\n\n/**\n * Result type for consistent error handling.\n */\ntype Result<T> =\n  | { success: true; data: T }\n  | { success: false; error: { code: string; message: string; details?: any } };\n\n/**\n * Module-level Supabase client (Pattern A)\n */\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\n/**\n * Converts camelCase to snake_case for database columns.\n */\nfunction toSnakeCase(obj: any): any {\n  const snakeObj: any = {};\n  for (const key in obj) {\n    const snakeKey = key.replace(/[A-Z]/g, (letter) => `_${letter.toLowerCase()}`);\n    snakeObj[snakeKey] = obj[key];\n  }\n  return snakeObj;\n}\n\n/**\n * Converts snake_case to camelCase for TypeScript objects.\n */\nfunction toCamelCase(obj: any): any {\n  const camelObj: any = {};\n  for (const key in obj) {\n    const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());\n    camelObj[camelKey] = obj[key];\n  }\n  return camelObj;\n}\n\n/**\n * Creates a new location in the system.\n *\n * @param data - Location data including name, parent location, and address\n * @returns Result containing the created location or error details\n *\n * @example\n * const result = await locationService.create({\n *   name: 'Tamarindo Beach',\n *   parentLocationId: '123e4567-e89b-12d3-a456-426614174000',\n *   address: 'Tamarindo, Guanacaste, Costa Rica',\n * });\n */\nexport async function create(data: CreateLocationDTO): Promise<Result<Location>> {\n  try {\n    // 1. Validate\n    const validation = createLocationSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize user input\n    const sanitized = {\n      ...validation.data,\n      name: sanitizeInput(validation.data.name),\n      address: validation.data.address ? sanitizeInput(validation.data.address) : null,\n      description: validation.data.description ? sanitizeRichText(validation.data.description) : null,\n    };\n\n    // 3. Check for circular reference if parent is specified\n    if (sanitized.parentLocationId) {\n      const parentExists = await get(sanitized.parentLocationId);\n      if (!parentExists.success) {\n        return {\n          success: false,\n          error: {\n            code: 'INVALID_PARENT',\n            message: 'Parent location does not exist',\n          },\n        };\n      }\n    }\n\n    // 4. Database operation\n    const dbData = toSnakeCase(sanitized);\n    const { data: result, error } = await supabase\n      .from('locations')\n      .insert(dbData)\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: { code: 'DATABASE_ERROR', message: error.message, details: error },\n      };\n    }\n\n    return { success: true, data: toCamelCase(result) as Location };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Retrieves a single location by ID.\n *\n * @param id - Location UUID\n * @returns Result containing the location or error details\n */\nexport async function get(id: string): Promise<Result<Location>> {\n  try {\n    const { data, error } = await supabase\n      .from('locations')\n      .select('*')\n      .eq('id', id)\n      .single();\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        return {\n          success: false,\n          error: { code: 'NOT_FOUND', message: 'Location not found' },\n        };\n      }\n      return {\n        success: false,\n        error: { code: 'DATABASE_ERROR', message: error.message, details: error },\n      };\n    }\n\n    return { success: true, data: toCamelCase(data) as Location };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Updates an existing location.\n *\n * @param id - Location UUID\n * @param data - Partial location data to update\n * @returns Result containing the updated location or error details\n */\nexport async function update(id: string, data: UpdateLocationDTO): Promise<Result<Location>> {\n  try {\n    // 1. Validate\n    const validation = updateLocationSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize user input\n    const sanitized: any = { ...validation.data };\n    if (sanitized.name) {\n      sanitized.name = sanitizeInput(sanitized.name);\n    }\n    if (sanitized.address) {\n      sanitized.address = sanitizeInput(sanitized.address);\n    }\n    if (sanitized.description) {\n      sanitized.description = sanitizeRichText(sanitized.description);\n    }\n\n    // 3. Check for circular reference if parent is being updated\n    if (sanitized.parentLocationId) {\n      // Prevent setting self as parent\n      if (sanitized.parentLocationId === id) {\n        return {\n          success: false,\n          error: {\n            code: 'CIRCULAR_REFERENCE',\n            message: 'Location cannot be its own parent',\n          },\n        };\n      }\n\n      // Check if parent exists\n      const parentExists = await get(sanitized.parentLocationId);\n      if (!parentExists.success) {\n        return {\n          success: false,\n          error: {\n            code: 'INVALID_PARENT',\n            message: 'Parent location does not exist',\n          },\n        };\n      }\n\n      // Check for circular reference in hierarchy\n      const wouldCreateCycle = await checkCircularReference(id, sanitized.parentLocationId);\n      if (wouldCreateCycle) {\n        return {\n          success: false,\n          error: {\n            code: 'CIRCULAR_REFERENCE',\n            message: 'This would create a circular reference in the location hierarchy',\n          },\n        };\n      }\n    }\n\n    // 4. Database operation\n    const dbData = toSnakeCase(sanitized);\n    const { data: result, error } = await supabase\n      .from('locations')\n      .update(dbData)\n      .eq('id', id)\n      .select()\n      .single();\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        return {\n          success: false,\n          error: { code: 'NOT_FOUND', message: 'Location not found' },\n        };\n      }\n      return {\n        success: false,\n        error: { code: 'DATABASE_ERROR', message: error.message, details: error },\n      };\n    }\n\n    return { success: true, data: toCamelCase(result) as Location };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Deletes a location by ID.\n * Note: Child locations will have their parent_location_id set to NULL (not deleted).\n *\n * @param id - Location UUID\n * @returns Result indicating success or error details\n */\nexport async function deleteLocation(id: string): Promise<Result<void>> {\n  try {\n    const { error } = await supabase.from('locations').delete().eq('id', id);\n\n    if (error) {\n      return {\n        success: false,\n        error: { code: 'DATABASE_ERROR', message: error.message, details: error },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Lists locations with optional filtering and pagination.\n *\n * @param filters - Filter criteria and pagination options\n * @returns Result containing paginated locations or error details\n */\nexport async function list(filters: Partial<LocationFilterDTO> = { page: 1, pageSize: 50 }): Promise<Result<PaginatedLocations>> {\n  try {\n    // 1. Validate\n    const filtersWithDefaults = { page: 1, pageSize: 50, ...filters };\n    const validation = locationFilterSchema.safeParse(filtersWithDefaults);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    const { page = 1, pageSize = 50, ...filterParams } = validation.data;\n    const from = (page - 1) * pageSize;\n    const to = from + pageSize - 1;\n\n    // 2. Database operation\n    let query = supabase.from('locations').select('*', { count: 'exact' });\n\n    // Apply filters\n    if (filterParams.parentLocationId !== undefined) {\n      if (filterParams.parentLocationId === null) {\n        query = query.is('parent_location_id', null);\n      } else {\n        query = query.eq('parent_location_id', filterParams.parentLocationId);\n      }\n    }\n\n    // Apply pagination and ordering\n    query = query.order('name', { ascending: true }).range(from, to);\n\n    const { data, error, count } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: { code: 'DATABASE_ERROR', message: error.message, details: error },\n      };\n    }\n\n    const locations = data.map((location) => toCamelCase(location) as Location);\n    const total = count || 0;\n    const totalPages = Math.ceil(total / pageSize);\n\n    return {\n      success: true,\n      data: {\n        locations,\n        total,\n        page,\n        pageSize,\n        totalPages,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Searches locations by name, address, or description.\n *\n * @param searchParams - Search query and pagination options\n * @returns Result containing paginated search results or error details\n */\nexport async function search(searchParams: LocationSearchDTO): Promise<Result<PaginatedLocations>> {\n  try {\n    // 1. Validate\n    const validation = locationSearchSchema.safeParse(searchParams);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    const { query, page = 1, pageSize = 50 } = validation.data;\n    const from = (page - 1) * pageSize;\n    const to = from + pageSize - 1;\n\n    // 2. Sanitize search query\n    const sanitizedQuery = sanitizeInput(query);\n\n    // 3. Database operation\n    const { data, error, count } = await supabase\n      .from('locations')\n      .select('*', { count: 'exact' })\n      .or(`name.ilike.%${sanitizedQuery}%,address.ilike.%${sanitizedQuery}%,description.ilike.%${sanitizedQuery}%`)\n      .order('name', { ascending: true })\n      .range(from, to);\n\n    if (error) {\n      return {\n        success: false,\n        error: { code: 'DATABASE_ERROR', message: error.message, details: error },\n      };\n    }\n\n    const locations = data.map((location) => toCamelCase(location) as Location);\n    const total = count || 0;\n    const totalPages = Math.ceil(total / pageSize);\n\n    return {\n      success: true,\n      data: {\n        locations,\n        total,\n        page,\n        pageSize,\n        totalPages,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Gets the hierarchical tree of locations starting from root locations.\n *\n * @returns Result containing the location hierarchy or error details\n */\nexport async function getHierarchy(): Promise<Result<LocationWithChildren[]>> {\n  try {\n    // Get all locations\n    const { data, error } = await supabase\n      .from('locations')\n      .select('*')\n      .order('name', { ascending: true });\n\n    if (error) {\n      return {\n        success: false,\n        error: { code: 'DATABASE_ERROR', message: error.message, details: error },\n      };\n    }\n\n    const locations = data.map((location) => toCamelCase(location) as Location);\n\n    // Build hierarchy\n    const locationMap = new Map<string, LocationWithChildren>();\n    const rootLocations: LocationWithChildren[] = [];\n\n    // Initialize all locations with empty children arrays\n    locations.forEach((location) => {\n      locationMap.set(location.id, { ...location, children: [] });\n    });\n\n    // Build parent-child relationships\n    locations.forEach((location) => {\n      const locationWithChildren = locationMap.get(location.id)!;\n      if (location.parentLocationId) {\n        const parent = locationMap.get(location.parentLocationId);\n        if (parent) {\n          parent.children.push(locationWithChildren);\n        } else {\n          // Parent doesn't exist, treat as root\n          rootLocations.push(locationWithChildren);\n        }\n      } else {\n        rootLocations.push(locationWithChildren);\n      }\n    });\n\n    return { success: true, data: rootLocations };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Gets all child locations of a specific location (recursive).\n *\n * @param parentId - Parent location UUID\n * @returns Result containing the location with all descendants or error details\n */\nexport async function getWithChildren(parentId: string): Promise<Result<LocationWithChildren>> {\n  try {\n    // Get the parent location\n    const parentResult = await get(parentId);\n    if (!parentResult.success) {\n      return parentResult as Result<LocationWithChildren>;\n    }\n\n    // Get all locations to build the tree\n    const { data, error } = await supabase\n      .from('locations')\n      .select('*')\n      .order('name', { ascending: true });\n\n    if (error) {\n      return {\n        success: false,\n        error: { code: 'DATABASE_ERROR', message: error.message, details: error },\n      };\n    }\n\n    const locations = data.map((location) => toCamelCase(location) as Location);\n\n    // Build location map\n    const locationMap = new Map<string, LocationWithChildren>();\n    locations.forEach((location) => {\n      locationMap.set(location.id, { ...location, children: [] });\n    });\n\n    // Build parent-child relationships\n    locations.forEach((location) => {\n      if (location.parentLocationId) {\n        const parent = locationMap.get(location.parentLocationId);\n        const child = locationMap.get(location.id);\n        if (parent && child) {\n          parent.children.push(child);\n        }\n      }\n    });\n\n    const result = locationMap.get(parentId);\n    if (!result) {\n      return {\n        success: false,\n        error: { code: 'NOT_FOUND', message: 'Location not found' },\n      };\n    }\n\n    return { success: true, data: result };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Checks if setting a parent would create a circular reference.\n * Returns true if it would create a cycle, false otherwise.\n *\n * @param locationId - The location being updated\n * @param newParentId - The proposed new parent\n * @returns Promise<boolean> - True if circular reference would be created\n */\nasync function checkCircularReference(locationId: string, newParentId: string): Promise<boolean> {\n  // Get all locations\n  const { data, error } = await supabase.from('locations').select('id, parent_location_id');\n\n  if (error || !data) {\n    return false; // If we can't check, allow the operation\n  }\n\n  // Build parent map\n  const parentMap = new Map<string, string | null>();\n  data.forEach((location) => {\n    parentMap.set(location.id, location.parent_location_id);\n  });\n\n  // Walk up the tree from newParentId to see if we encounter locationId\n  let currentId: string | null = newParentId;\n  const visited = new Set<string>();\n\n  while (currentId) {\n    if (currentId === locationId) {\n      return true; // Circular reference detected\n    }\n    if (visited.has(currentId)) {\n      return true; // Already visited, circular reference exists\n    }\n    visited.add(currentId);\n    currentId = parentMap.get(currentId) || null;\n  }\n\n  return false; // No circular reference\n}\n"],"names":["create","deleteLocation","get","getHierarchy","getWithChildren","list","search","update","supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","toSnakeCase","obj","snakeObj","key","snakeKey","replace","letter","toLowerCase","toCamelCase","camelObj","camelKey","_","toUpperCase","data","validation","createLocationSchema","safeParse","success","error","code","message","details","issues","sanitized","name","sanitizeInput","address","description","sanitizeRichText","parentLocationId","parentExists","dbData","result","from","insert","select","single","Error","id","eq","updateLocationSchema","wouldCreateCycle","checkCircularReference","delete","undefined","filters","page","pageSize","filtersWithDefaults","locationFilterSchema","filterParams","to","query","count","is","order","ascending","range","locations","map","location","total","totalPages","Math","ceil","searchParams","locationSearchSchema","sanitizedQuery","or","locationMap","Map","rootLocations","forEach","set","children","locationWithChildren","parent","push","parentId","parentResult","child","locationId","newParentId","parentMap","parent_location_id","currentId","visited","Set","has","add"],"mappings":"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"}