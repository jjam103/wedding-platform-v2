{"version":3,"names":["PUT","request","params","cov_1xbte2rrm6","f","s","id","supabase","_authhelpersnextjs","createRouteHandlerClient","cookies","_headers","data","session","error","authError","auth","getSession","b","_server","NextResponse","json","success","code","_types","ERROR_CODES","UNAUTHORIZED","message","status","guest","guestError","from","select","eq","user","email","single","NOT_FOUND","existingRsvpResult","_rsvpService","get","guest_id","FORBIDDEN","body","validation","_rsvpSchemas","updateRSVPSchema","safeParse","VALIDATION_ERROR","details","issues","activity_id","newStatus","newGuestCount","guest_count","capacityCheck","enforceCapacityLimit","event_id","eventResult","_eventService","rsvpDeadline","deadline","Date","result","update","UNKNOWN_ERROR","Error"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/guest/rsvps/[id]/route.ts"],"sourcesContent":["import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\nimport * as rsvpService from '@/services/rsvpService';\nimport * as activityService from '@/services/activityService';\nimport * as eventService from '@/services/eventService';\nimport { updateRSVPSchema } from '@/schemas/rsvpSchemas';\nimport { ERROR_CODES } from '@/types';\n\n/**\n * PUT /api/guest/rsvps/[id]\n * \n * Updates an existing RSVP for the authenticated guest.\n * Validates capacity and deadlines before updating.\n * Sends update confirmation email on success.\n * \n * Requirements: 10.1, 10.2, 10.5, 10.6, 10.7, 10.9\n */\nexport async function PUT(\n  request: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // Await params for Next.js 15+\n    const { id } = await params;\n    \n    // 1. Auth check\n    const supabase = createRouteHandlerClient({ cookies });\n    const { data: { session }, error: authError } = await supabase.auth.getSession();\n    \n    if (authError || !session) {\n      return NextResponse.json(\n        { success: false, error: { code: ERROR_CODES.UNAUTHORIZED, message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n\n    // Get guest ID from session\n    const { data: guest, error: guestError } = await supabase\n      .from('guests')\n      .select('id')\n      .eq('email', session.user.email)\n      .single();\n\n    if (guestError || !guest) {\n      return NextResponse.json(\n        { success: false, error: { code: ERROR_CODES.NOT_FOUND, message: 'Guest not found' } },\n        { status: 404 }\n      );\n    }\n\n    // Get existing RSVP to verify ownership\n    const existingRsvpResult = await rsvpService.get(id);\n    if (!existingRsvpResult.success) {\n      return NextResponse.json(existingRsvpResult, { status: 404 });\n    }\n\n    // Verify RSVP belongs to authenticated guest\n    if (existingRsvpResult.data.guest_id !== guest.id) {\n      return NextResponse.json(\n        { success: false, error: { code: ERROR_CODES.FORBIDDEN, message: 'Cannot modify another guest\\'s RSVP' } },\n        { status: 403 }\n      );\n    }\n\n    // 2. Parse and validate request body\n    const body = await request.json();\n    const validation = updateRSVPSchema.safeParse(body);\n\n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: ERROR_CODES.VALIDATION_ERROR,\n            message: 'Invalid request',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    // 3. Check capacity if activity_id exists and changing to 'attending'\n    if (existingRsvpResult.data.activity_id) {\n      const newStatus = validation.data.status || existingRsvpResult.data.status;\n      const newGuestCount = validation.data.guest_count || existingRsvpResult.data.guest_count || 1;\n\n      if (newStatus === 'attending') {\n        const capacityCheck = await rsvpService.enforceCapacityLimit(\n          existingRsvpResult.data.activity_id,\n          newGuestCount,\n          id // Pass existing RSVP ID to exclude from count\n        );\n\n        if (!capacityCheck.success) {\n          return NextResponse.json(capacityCheck, { status: 400 });\n        }\n      }\n    }\n\n    // Check deadline for events\n    if (existingRsvpResult.data.event_id) {\n      const eventResult = await eventService.get(existingRsvpResult.data.event_id);\n      if (eventResult.success && eventResult.data.rsvpDeadline) {\n        const deadline = new Date(eventResult.data.rsvpDeadline);\n        if (deadline < new Date()) {\n          return NextResponse.json(\n            {\n              success: false,\n              error: {\n                code: ERROR_CODES.VALIDATION_ERROR,\n                message: 'RSVP deadline has passed',\n              },\n            },\n            { status: 400 }\n          );\n        }\n      }\n    }\n\n    // 4. Update RSVP via service\n    const result = await rsvpService.update(id, validation.data);\n\n    if (!result.success) {\n      return NextResponse.json(result, { status: 500 });\n    }\n\n    return NextResponse.json(result);\n  } catch (error) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: ERROR_CODES.UNKNOWN_ERROR,\n          message: error instanceof Error ? error.message : 'Unknown error',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}