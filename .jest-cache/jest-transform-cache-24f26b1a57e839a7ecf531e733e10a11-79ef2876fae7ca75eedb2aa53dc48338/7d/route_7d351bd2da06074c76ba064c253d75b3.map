{"version":3,"names":["cov_1f5xaxxhhe","actualCoverage","s","POST","request","f","auth","_apiAuth","getAuthenticatedUser","b","_server","NextResponse","json","success","error","code","message","status","user","supabase","data","currentGuest","currentGuestError","from","select","eq","email","single","formData","file","get","caption","altText","pageType","pageId","type","startsWith","size","timestamp","Date","now","randomString","Math","random","toString","substring","fileExt","name","split","pop","fileName","filePath","uploadData","uploadError","storage","upload","contentType","cacheControl","urlData","getPublicUrl","photo","photoError","insert","uploader_id","id","photo_url","publicUrl","storage_type","page_type","page_id","_sanitization","sanitizeInput","alt_text","moderation_status","created_at","toISOString","remove","Error"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/guest/photos/upload/route.ts"],"sourcesContent":["import { getAuthenticatedUser } from '@/lib/apiAuth';\nimport { NextResponse } from 'next/server';\nimport { sanitizeInput } from '@/utils/sanitization';\n\n/**\n * POST /api/guest/photos/upload\n * \n * Uploads a photo from a guest to the wedding gallery.\n * Photos are queued for moderation before appearing publicly.\n * \n * Requirements: 13.9, 11.1, 11.11\n */\nexport async function POST(request: Request) {\n  try {\n    const auth = await getAuthenticatedUser();\n    \n    if (!auth) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n\n    const { user, supabase } = auth;\n    \n    // Get current guest\n    const { data: currentGuest, error: currentGuestError } = await supabase\n      .from('guests')\n      .select('id')\n      .eq('email', user.email)\n      .single();\n    \n    if (currentGuestError || !currentGuest) {\n      return NextResponse.json(\n        { success: false, error: { code: 'GUEST_NOT_FOUND', message: 'Guest not found' } },\n        { status: 404 }\n      );\n    }\n    \n    // Parse form data\n    const formData = await request.formData();\n    const file = formData.get('file') as File;\n    const caption = formData.get('caption') as string;\n    const altText = formData.get('alt_text') as string;\n    const pageType = formData.get('page_type') as string || 'memory';\n    const pageId = formData.get('page_id') as string | null;\n    \n    if (!file) {\n      return NextResponse.json(\n        { success: false, error: { code: 'VALIDATION_ERROR', message: 'No file provided' } },\n        { status: 400 }\n      );\n    }\n    \n    // Validate file type\n    if (!file.type.startsWith('image/')) {\n      return NextResponse.json(\n        { success: false, error: { code: 'VALIDATION_ERROR', message: 'File must be an image' } },\n        { status: 400 }\n      );\n    }\n    \n    // Validate file size (10MB limit)\n    if (file.size > 10 * 1024 * 1024) {\n      return NextResponse.json(\n        { success: false, error: { code: 'VALIDATION_ERROR', message: 'File size must be less than 10MB' } },\n        { status: 400 }\n      );\n    }\n    \n    // Generate unique filename\n    const timestamp = Date.now();\n    const randomString = Math.random().toString(36).substring(7);\n    const fileExt = file.name.split('.').pop();\n    const fileName = `${timestamp}-${randomString}.${fileExt}`;\n    const filePath = `photos/${fileName}`;\n    \n    // Upload to Supabase Storage\n    const { data: uploadData, error: uploadError } = await supabase.storage\n      .from('wedding-photos')\n      .upload(filePath, file, {\n        contentType: file.type,\n        cacheControl: '3600',\n      });\n    \n    if (uploadError) {\n      return NextResponse.json(\n        { success: false, error: { code: 'STORAGE_ERROR', message: uploadError.message } },\n        { status: 500 }\n      );\n    }\n    \n    // Get public URL\n    const { data: urlData } = supabase.storage\n      .from('wedding-photos')\n      .getPublicUrl(filePath);\n    \n    // Create photo record in database\n    const { data: photo, error: photoError } = await supabase\n      .from('photos')\n      .insert({\n        uploader_id: user.id,\n        photo_url: urlData.publicUrl,\n        storage_type: 'supabase',\n        page_type: pageType,\n        page_id: pageId,\n        caption: caption ? sanitizeInput(caption) : null,\n        alt_text: altText ? sanitizeInput(altText) : null,\n        moderation_status: 'pending',\n        created_at: new Date().toISOString(),\n      })\n      .select()\n      .single();\n    \n    if (photoError) {\n      // Clean up uploaded file if database insert fails\n      await supabase.storage.from('wedding-photos').remove([filePath]);\n      \n      return NextResponse.json(\n        { success: false, error: { code: 'DATABASE_ERROR', message: photoError.message } },\n        { status: 500 }\n      );\n    }\n    \n    return NextResponse.json({ success: true, data: photo }, { status: 201 });\n  } catch (error) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'UNKNOWN_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}