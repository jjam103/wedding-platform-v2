{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/emailSMSFallback.test.ts"],"sourcesContent":["import type { SendEmailDTO } from '@/schemas/emailSchemas';\n\n/**\n * Unit Test for Email-to-SMS Fallback\n * \n * Tests that email failure triggers SMS fallback.\n * Validates: Requirements 13.10\n */\n\n// Mock the SMS service\njest.mock('./smsService', () => ({\n  sendSMSFallback: jest.fn(),\n}));\n\n// Mock Supabase\njest.mock('@supabase/supabase-js', () => ({\n  createClient: jest.fn(() => ({\n    from: jest.fn(() => ({\n      insert: jest.fn(() => ({\n        select: jest.fn(() => ({\n          single: jest.fn(() => Promise.resolve({ data: { id: 'log-123' }, error: null })),\n        })),\n      })),\n      select: jest.fn(() => ({\n        eq: jest.fn(() => ({\n          single: jest.fn(() => Promise.resolve({ data: null, error: null })),\n        })),\n      })),\n    })),\n  })),\n}));\n\n// Import after mocks are set up\nimport { sendEmailWithSMSFallback, setResendClient, resetResendClient } from './emailService';\nimport { sendSMSFallback } from './smsService';\n\nconst mockSendSMSFallback = sendSMSFallback as jest.MockedFunction<typeof sendSMSFallback>;\n\ndescribe('Email-to-SMS Fallback', () => {\n  const mockEmailData: SendEmailDTO = {\n    to: 'guest@example.com',\n    subject: 'RSVP Reminder',\n    html: '<p>Please RSVP by Friday</p>',\n    text: 'Please RSVP by Friday',\n  };\n\n  const mockPhone = '+15551234567';\n  let mockEmailsSend: jest.Mock;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    \n    // Create a mock Resend client\n    mockEmailsSend = jest.fn();\n    const mockResendClient = {\n      emails: {\n        send: mockEmailsSend,\n      },\n    } as any;\n    \n    // Inject the mock client\n    setResendClient(mockResendClient);\n  });\n\n  afterEach(() => {\n    resetResendClient();\n  });\n\n  it('should send email successfully without triggering SMS fallback', async () => {\n    // Mock successful email send - Resend returns { data, error } structure\n    mockEmailsSend.mockResolvedValue({\n      data: {\n        id: 'email-123',\n      },\n      error: null,\n    } as any);\n\n    const result = await sendEmailWithSMSFallback(mockEmailData, mockPhone);\n\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.data.method).toBe('email');\n      expect(result.data.id).toBe('email-123');\n    }\n\n    // SMS should not be called\n    expect(mockSendSMSFallback).not.toHaveBeenCalled();\n  });\n\n  it('should trigger SMS fallback when email fails', async () => {\n    // Mock failed email send - Resend returns error in the response\n    mockEmailsSend.mockResolvedValue({\n      data: null,\n      error: { message: 'Email service unavailable' },\n    } as any);\n\n    // Mock successful SMS send\n    mockSendSMSFallback.mockResolvedValue({\n      success: true,\n      data: { id: 'sms-456' },\n    } as any);\n\n    const result = await sendEmailWithSMSFallback(mockEmailData, mockPhone);\n\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.data.method).toBe('sms');\n      expect(result.data.id).toBe('sms-456');\n    }\n\n    // SMS should be called with correct parameters\n    expect(mockSendSMSFallback).toHaveBeenCalledWith(\n      mockPhone,\n      mockEmailData.subject,\n      mockEmailData.text\n    );\n  });\n\n  it('should strip HTML tags when falling back to SMS', async () => {\n    // Mock failed email send\n    mockEmailsSend.mockResolvedValue({\n      data: null,\n      error: { message: 'Email service unavailable' },\n    } as any);\n\n    // Mock successful SMS send\n    mockSendSMSFallback.mockResolvedValue({\n      success: true,\n      data: { id: 'sms-789' },\n    } as any);\n\n    const emailDataWithHTML: SendEmailDTO = {\n      to: 'guest@example.com',\n      subject: 'RSVP Reminder',\n      html: '<p>Please <strong>RSVP</strong> by <em>Friday</em></p>',\n    };\n\n    await sendEmailWithSMSFallback(emailDataWithHTML, mockPhone);\n\n    // SMS should be called with HTML stripped\n    expect(mockSendSMSFallback).toHaveBeenCalledWith(\n      mockPhone,\n      emailDataWithHTML.subject,\n      'Please RSVP by Friday'\n    );\n  });\n\n  it('should return error when email fails and no phone number provided', async () => {\n    // Mock failed email send\n    mockEmailsSend.mockResolvedValue({\n      data: null,\n      error: { message: 'Email service unavailable' },\n    } as any);\n\n    const result = await sendEmailWithSMSFallback(mockEmailData);\n\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error.code).toBe('EMAIL_SERVICE_ERROR');\n    }\n\n    // SMS should not be called\n    expect(mockSendSMSFallback).not.toHaveBeenCalled();\n  });\n\n  it('should return error when both email and SMS fail', async () => {\n    // Mock failed email send\n    mockEmailsSend.mockResolvedValue({\n      data: null,\n      error: { message: 'Email service unavailable' },\n    } as any);\n\n    // Mock failed SMS send\n    mockSendSMSFallback.mockResolvedValue({\n      success: false,\n      error: {\n        code: 'EXTERNAL_SERVICE_ERROR',\n        message: 'SMS service unavailable',\n      },\n    } as any);\n\n    const result = await sendEmailWithSMSFallback(mockEmailData, mockPhone);\n\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error.code).toBe('EXTERNAL_SERVICE_ERROR');\n      expect(result.error.message).toContain('Both email and SMS delivery failed');\n      expect(result.error.details).toBeDefined();\n    }\n  });\n\n  it('should use text body if provided, otherwise strip HTML', async () => {\n    // Mock failed email send\n    mockEmailsSend.mockResolvedValue({\n      data: null,\n      error: { message: 'Email service unavailable' },\n    } as any);\n\n    // Mock successful SMS send\n    mockSendSMSFallback.mockResolvedValue({\n      success: true,\n      data: { id: 'sms-999' },\n    } as any);\n\n    const emailDataWithText: SendEmailDTO = {\n      to: 'guest@example.com',\n      subject: 'Test',\n      html: '<p>HTML version</p>',\n      text: 'Text version',\n    };\n\n    await sendEmailWithSMSFallback(emailDataWithText, mockPhone);\n\n    // Should use text body, not HTML\n    expect(mockSendSMSFallback).toHaveBeenCalledWith(\n      mockPhone,\n      'Test',\n      'Text version'\n    );\n  });\n\n  it('should handle email with template variables', async () => {\n    // Mock failed email send\n    mockEmailsSend.mockResolvedValue({\n      data: null,\n      error: { message: 'Email service unavailable' },\n    } as any);\n\n    // Mock successful SMS send\n    mockSendSMSFallback.mockResolvedValue({\n      success: true,\n      data: { id: 'sms-111' },\n    } as any);\n\n    const emailDataWithTemplate: SendEmailDTO = {\n      to: 'guest@example.com',\n      subject: 'Hello {{guest_name}}',\n      html: '<p>Welcome {{guest_name}} to our wedding</p>',\n      template_id: 'template-123',\n      variables: { guest_name: 'John' },\n    };\n\n    await sendEmailWithSMSFallback(emailDataWithTemplate, mockPhone);\n\n    // SMS fallback should be triggered\n    expect(mockSendSMSFallback).toHaveBeenCalled();\n  });\n\n  it('should handle long email content by truncating for SMS', async () => {\n    // Mock failed email send\n    mockEmailsSend.mockResolvedValue({\n      data: null,\n      error: { message: 'Email service unavailable' },\n    } as any);\n\n    // Mock successful SMS send\n    mockSendSMSFallback.mockResolvedValue({\n      success: true,\n      data: { id: 'sms-222' },\n    } as any);\n\n    const longContent = 'A'.repeat(500);\n    const emailDataWithLongContent: SendEmailDTO = {\n      to: 'guest@example.com',\n      subject: 'Long Message',\n      html: `<p>${longContent}</p>`,\n    };\n\n    await sendEmailWithSMSFallback(emailDataWithLongContent, mockPhone);\n\n    // SMS should be called (truncation happens in smsService)\n    expect(mockSendSMSFallback).toHaveBeenCalledWith(\n      mockPhone,\n      'Long Message',\n      longContent\n    );\n  });\n});\n"],"names":["jest","mock","sendSMSFallback","fn","createClient","from","insert","select","single","Promise","resolve","data","id","error","eq","mockSendSMSFallback","describe","mockEmailData","to","subject","html","text","mockPhone","mockEmailsSend","beforeEach","clearAllMocks","mockResendClient","emails","send","setResendClient","afterEach","resetResendClient","it","mockResolvedValue","result","sendEmailWithSMSFallback","expect","success","toBe","method","not","toHaveBeenCalled","message","toHaveBeenCalledWith","emailDataWithHTML","code","toContain","details","toBeDefined","emailDataWithText","emailDataWithTemplate","template_id","variables","guest_name","longContent","repeat","emailDataWithLongContent"],"mappings":"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"}