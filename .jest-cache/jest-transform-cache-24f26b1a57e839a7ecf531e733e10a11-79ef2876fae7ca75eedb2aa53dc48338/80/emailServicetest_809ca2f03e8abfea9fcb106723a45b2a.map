{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/emailService.test.ts"],"sourcesContent":["/**\n * Email Service Tests\n * \n * Tests for email template operations, sending logic, and delivery tracking.\n * Requirements: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7, 12.9, 12.10\n */\n\nimport type { CreateEmailTemplateDTO, UpdateEmailTemplateDTO, SendEmailDTO, EmailTemplate } from '@/schemas/emailSchemas';\nimport { ERROR_CODES } from '@/types';\n\n// Set up environment variables BEFORE any imports\nprocess.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';\nprocess.env.SUPABASE_SERVICE_ROLE_KEY = 'test-service-role-key';\n\n// Mock Supabase - Pattern A\njest.mock('@supabase/supabase-js', () => {\n  const mockFrom = jest.fn();\n  const mockSupabaseClient = {\n    from: mockFrom,\n  };\n  \n  return {\n    createClient: jest.fn(() => mockSupabaseClient),\n    __mockFrom: mockFrom,\n  };\n});\n\n// Mock SMS service\njest.mock('./smsService', () => ({\n  sendSMSFallback: jest.fn(),\n}));\n\n// Import service using require() AFTER mocking\nconst emailService = require('./emailService');\nconst {\n  createTemplate,\n  getTemplate,\n  updateTemplate,\n  deleteTemplate,\n  listTemplates,\n  sendEmail,\n  sendBulkEmail,\n  scheduleEmail,\n  updateDeliveryStatus,\n  getEmailAnalytics,\n  getEmailLogs,\n  sendEmailWithSMSFallback,\n  setResendClient,\n  resetResendClient,\n} = emailService;\n\n// Get the mocked from function\nconst { __mockFrom: mockFrom } = require('@supabase/supabase-js');\n\n// Create a helper object that mimics the old mockSupabase interface\n// This allows existing tests to work without modification\nconst mockSupabase = {\n  from: mockFrom,\n  select: jest.fn(),\n  insert: jest.fn(),\n  update: jest.fn(),\n  delete: jest.fn(),\n  eq: jest.fn(),\n  order: jest.fn(),\n  limit: jest.fn(),\n  single: jest.fn(),\n};\n\n// Mock Resend client\nconst mockResend = {\n  emails: {\n    send: jest.fn(),\n  },\n};\n\ndescribe('emailService', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    \n    // Configure mockFrom to return mockSupabase helper for chaining\n    mockFrom.mockReturnValue(mockSupabase);\n    \n    // Reset mockSupabase methods to return themselves for chaining\n    mockSupabase.select.mockReturnValue(mockSupabase);\n    mockSupabase.insert.mockReturnValue(mockSupabase);\n    mockSupabase.update.mockReturnValue(mockSupabase);\n    mockSupabase.delete.mockReturnValue(mockSupabase);\n    mockSupabase.eq.mockReturnValue(mockSupabase);\n    mockSupabase.order.mockReturnValue(mockSupabase);\n    mockSupabase.limit.mockReturnValue(mockSupabase);\n    \n    setResendClient(mockResend as any);\n  });\n\n  afterEach(() => {\n    resetResendClient();\n  });\n\n  // ===== TEMPLATE OPERATIONS TESTS =====\n\n  describe('createTemplate', () => {\n    const validTemplateData: CreateEmailTemplateDTO = {\n      name: 'Welcome Email',\n      subject: 'Welcome {{guest_name}}!',\n      body_html: '<p>Hello {{guest_name}}, welcome to our wedding!</p>',\n      body_text: 'Hello {{guest_name}}, welcome to our wedding!',\n      variables: ['guest_name'],\n    };\n\n    it('should return success with template data when valid input provided', async () => {\n      const expectedTemplate: EmailTemplate = {\n        id: 'template-1',\n        ...validTemplateData,\n        created_at: '2024-01-01T00:00:00Z',\n        updated_at: '2024-01-01T00:00:00Z',\n      };\n\n      mockSupabase.single.mockResolvedValue({ data: expectedTemplate, error: null });\n\n      const result = await createTemplate(validTemplateData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('template-1');\n        expect(result.data.name).toBe('Welcome Email');\n        expect(result.data.variables).toEqual(['guest_name']);\n      }\n    });\n\n    it('should return VALIDATION_ERROR when name is empty', async () => {\n      const invalidData = { ...validTemplateData, name: '' };\n\n      const result = await createTemplate(invalidData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.VALIDATION_ERROR);\n        expect(result.error.message).toBe('Validation failed');\n      }\n    });\n\n    it('should return VALIDATION_ERROR when template contains undefined variables', async () => {\n      const invalidData = {\n        ...validTemplateData,\n        body_html: '<p>Hello {{undefined_var}}, welcome!</p>',\n        variables: ['guest_name'], // missing 'undefined_var'\n      };\n\n      const result = await createTemplate(invalidData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.VALIDATION_ERROR);\n        expect(result.error.message).toBe('Template contains undefined variables');\n        expect(result.error.details).toEqual({ undefinedVariables: ['undefined_var'] });\n      }\n    });\n\n    it('should return DATABASE_ERROR when insert fails', async () => {\n      mockSupabase.single.mockResolvedValue({ data: null, error: { message: 'Connection failed' } });\n\n      const result = await createTemplate(validTemplateData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.DATABASE_ERROR);\n        expect(result.error.message).toBe('Connection failed');\n      }\n    });\n\n    it('should sanitize HTML content to prevent XSS attacks', async () => {\n      const maliciousData = {\n        ...validTemplateData,\n        body_html: '<p>Hello {{guest_name}}</p><script>alert(\"xss\")</script>',\n      };\n\n      const expectedTemplate: EmailTemplate = {\n        id: 'template-1',\n        ...maliciousData,\n        body_html: '<p>Hello {{guest_name}}</p>', // script tag removed\n        created_at: '2024-01-01T00:00:00Z',\n        updated_at: '2024-01-01T00:00:00Z',\n      };\n\n      mockSupabase.single.mockResolvedValue({ data: expectedTemplate, error: null });\n\n      const result = await createTemplate(maliciousData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.body_html).not.toContain('<script>');\n        expect(result.data.body_html).not.toContain('alert');\n      }\n    });\n  });\n\n  describe('getTemplate', () => {\n    it('should return success with template data when template exists', async () => {\n      const template: EmailTemplate = {\n        id: 'template-1',\n        name: 'Welcome Email',\n        subject: 'Welcome!',\n        body_html: '<p>Hello!</p>',\n        body_text: 'Hello!',\n        variables: [],\n        created_at: '2024-01-01T00:00:00Z',\n        updated_at: '2024-01-01T00:00:00Z',\n      };\n\n      mockSupabase.single.mockResolvedValue({ data: template, error: null });\n\n      const result = await getTemplate('template-1');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('template-1');\n        expect(result.data.name).toBe('Welcome Email');\n      }\n    });\n\n    it('should return NOT_FOUND when template does not exist', async () => {\n      mockSupabase.single.mockResolvedValue({ data: null, error: { message: 'No rows returned' } });\n\n      const result = await getTemplate('nonexistent');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.NOT_FOUND);\n        expect(result.error.message).toBe('Template not found');\n      }\n    });\n  });\n\n  describe('updateTemplate', () => {\n    const updateData: UpdateEmailTemplateDTO = {\n      name: 'Updated Welcome Email',\n      subject: 'Welcome {{guest_name}}!',\n    };\n\n    it('should return success with updated template data when valid input provided', async () => {\n      const existingTemplate: EmailTemplate = {\n        id: 'template-1',\n        name: 'Welcome Email',\n        subject: 'Welcome!',\n        body_html: '<p>Hello!</p>',\n        body_text: 'Hello!',\n        variables: ['guest_name'],\n        created_at: '2024-01-01T00:00:00Z',\n        updated_at: '2024-01-01T00:00:00Z',\n      };\n\n      const updatedTemplate: EmailTemplate = {\n        ...existingTemplate,\n        ...updateData,\n        updated_at: '2024-01-01T01:00:00Z',\n      };\n\n      // Mock getTemplate call first, then update call\n      mockSupabase.single\n        .mockResolvedValueOnce({ data: existingTemplate, error: null })\n        .mockResolvedValueOnce({ data: updatedTemplate, error: null });\n\n      const result = await updateTemplate('template-1', updateData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.name).toBe('Updated Welcome Email');\n        expect(result.data.subject).toBe('Welcome {{guest_name}}!');\n      }\n    });\n\n    it('should return NOT_FOUND when template does not exist', async () => {\n      mockSupabase.single.mockResolvedValue({ data: null, error: { message: 'No rows returned' } });\n\n      const result = await updateTemplate('nonexistent', updateData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.NOT_FOUND);\n      }\n    });\n  });\n\n  describe('deleteTemplate', () => {\n    it('should return success when template is deleted', async () => {\n      mockSupabase.eq.mockResolvedValue({ data: null, error: null });\n\n      const result = await deleteTemplate('template-1');\n\n      expect(result.success).toBe(true);\n    });\n\n    it('should return DATABASE_ERROR when delete fails', async () => {\n      mockSupabase.eq.mockResolvedValue({ data: null, error: { message: 'Foreign key constraint' } });\n\n      const result = await deleteTemplate('template-1');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.DATABASE_ERROR);\n      }\n    });\n  });\n\n  describe('listTemplates', () => {\n    it('should return success with templates list', async () => {\n      const templates: EmailTemplate[] = [\n        {\n          id: 'template-1',\n          name: 'Welcome Email',\n          subject: 'Welcome!',\n          body_html: '<p>Hello!</p>',\n          body_text: 'Hello!',\n          variables: [],\n          created_at: '2024-01-01T00:00:00Z',\n          updated_at: '2024-01-01T00:00:00Z',\n        },\n        {\n          id: 'template-2',\n          name: 'RSVP Reminder',\n          subject: 'RSVP Reminder',\n          body_html: '<p>Please RSVP!</p>',\n          body_text: 'Please RSVP!',\n          variables: [],\n          created_at: '2024-01-01T00:00:00Z',\n          updated_at: '2024-01-01T00:00:00Z',\n        },\n      ];\n\n      mockSupabase.order.mockResolvedValue({ data: templates, error: null });\n\n      const result = await listTemplates();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(2);\n        expect(result.data[0].name).toBe('Welcome Email');\n        expect(result.data[1].name).toBe('RSVP Reminder');\n      }\n    });\n\n    it('should return empty array when no templates exist', async () => {\n      mockSupabase.order.mockResolvedValue({ data: [], error: null });\n\n      const result = await listTemplates();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(0);\n      }\n    });\n  });\n\n  // ===== SENDING LOGIC TESTS =====\n\n  describe('sendEmail', () => {\n    const validEmailData: SendEmailDTO = {\n      to: 'guest@example.com',\n      subject: 'Welcome!',\n      html: '<p>Hello!</p>',\n      text: 'Hello!',\n    };\n\n    beforeEach(() => {\n      // Mock successful email log insertion\n      mockSupabase.single.mockResolvedValue({ data: { id: 'log-1' }, error: null });\n    });\n\n    it('should return success with email ID when email is sent successfully', async () => {\n      mockResend.emails.send.mockResolvedValue({\n        data: { id: 'email-123' },\n        error: null,\n      });\n\n      const result = await sendEmail(validEmailData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('email-123');\n      }\n\n      expect(mockResend.emails.send).toHaveBeenCalledWith({\n        from: 'onboarding@resend.dev',\n        to: 'guest@example.com',\n        subject: 'Welcome!',\n        html: '<p>Hello!</p>',\n        text: 'Hello!',\n      });\n    });\n\n    it('should return VALIDATION_ERROR when email address is invalid', async () => {\n      const invalidData = { ...validEmailData, to: 'invalid-email' };\n\n      const result = await sendEmail(invalidData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.VALIDATION_ERROR);\n        expect(result.error.message).toBe('Validation failed');\n      }\n    });\n\n    it('should return EMAIL_SERVICE_ERROR when Resend fails', async () => {\n      mockResend.emails.send.mockResolvedValue({\n        data: null,\n        error: { message: 'API key invalid' },\n      });\n\n      const result = await sendEmail(validEmailData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.EMAIL_SERVICE_ERROR);\n        expect(result.error.message).toBe('API key invalid');\n      }\n    });\n\n    it('should substitute template variables when template_id provided', async () => {\n      const templateId = '123e4567-e89b-12d3-a456-426614174000'; // Valid UUID\n      const template: EmailTemplate = {\n        id: templateId,\n        name: 'Welcome Email',\n        subject: 'Welcome {{guest_name}}!',\n        body_html: '<p>Hello {{guest_name}}!</p>',\n        body_text: 'Hello {{guest_name}}!',\n        variables: ['guest_name'],\n        created_at: '2024-01-01T00:00:00Z',\n        updated_at: '2024-01-01T00:00:00Z',\n      };\n\n      // Setup complete mock chain for getTemplate call\n      // getTemplate does: supabase.from('email_templates').select('*').eq('id', id).single()\n      const mockSingleForTemplate = jest.fn().mockResolvedValue({ data: template, error: null });\n      const mockEqForTemplate = jest.fn().mockReturnValue({ single: mockSingleForTemplate });\n      const mockSelectForTemplate = jest.fn().mockReturnValue({ eq: mockEqForTemplate });\n      const mockFromForTemplate = jest.fn().mockReturnValue({ select: mockSelectForTemplate });\n      \n      // Setup mock chain for email log insertion\n      // sendEmail does: supabase.from('email_logs').insert({...}).select().single()\n      const mockSingleForLog = jest.fn().mockResolvedValue({ data: { id: 'log-1' }, error: null });\n      const mockSelectForLog = jest.fn().mockReturnValue({ single: mockSingleForLog });\n      const mockInsertForLog = jest.fn().mockReturnValue({ select: mockSelectForLog });\n      const mockFromForLog = jest.fn().mockReturnValue({ insert: mockInsertForLog });\n      \n      // Configure mockFrom to return the right chain based on table name\n      mockFrom.mockImplementation((table: string) => {\n        if (table === 'email_templates') {\n          return { select: mockSelectForTemplate };\n        } else if (table === 'email_logs') {\n          return { insert: mockInsertForLog };\n        }\n        return mockSupabase;\n      });\n\n      mockResend.emails.send.mockResolvedValue({\n        data: { id: 'email-123' },\n        error: null,\n      });\n\n      const emailWithTemplate: SendEmailDTO = {\n        to: 'guest@example.com',\n        subject: 'Welcome!', // Will be overridden by template\n        html: '<p>Hello!</p>', // Will be overridden by template\n        text: 'Hello!', // Add text field to pass validation\n        template_id: templateId,\n        variables: { guest_name: 'John Doe' },\n      };\n\n      const result = await sendEmail(emailWithTemplate);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('email-123');\n      }\n      expect(mockResend.emails.send).toHaveBeenCalledWith({\n        from: 'onboarding@resend.dev',\n        to: 'guest@example.com',\n        subject: 'Welcome John Doe!',\n        html: '<p>Hello John Doe!</p>',\n        text: 'Hello John Doe!',\n      });\n    });\n\n    it('should return NOT_FOUND when template_id does not exist', async () => {\n      // Setup complete mock chain for getTemplate call that returns null\n      const mockSingleForTemplate = jest.fn().mockResolvedValue({ data: null, error: { message: 'No rows returned' } });\n      const mockEqForTemplate = jest.fn().mockReturnValue({ single: mockSingleForTemplate });\n      const mockSelectForTemplate = jest.fn().mockReturnValue({ eq: mockEqForTemplate });\n      \n      // Configure mockFrom to return the template chain\n      mockFrom.mockImplementation((table: string) => {\n        if (table === 'email_templates') {\n          return { select: mockSelectForTemplate };\n        }\n        return mockSupabase;\n      });\n\n      const emailWithTemplate: SendEmailDTO = {\n        to: 'guest@example.com',\n        subject: 'Welcome!',\n        html: '<p>Hello!</p>',\n        text: 'Hello!', // Add text field to pass validation\n        template_id: '00000000-0000-0000-0000-000000000000', // Valid UUID format\n      };\n\n      const result = await sendEmail(emailWithTemplate);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.NOT_FOUND);\n        expect(result.error.message).toBe('Template not found');\n      }\n    });\n  });\n\n  describe('sendBulkEmail', () => {\n    it('should return success with sent/failed counts when bulk email is sent', async () => {\n      const bulkEmailData = {\n        recipients: ['guest1@example.com', 'guest2@example.com', 'guest3@example.com'],\n        subject: 'Bulk Email',\n        html: '<p>Hello everyone!</p>',\n        text: 'Hello everyone!',\n      };\n\n      // Mock successful sends for first two, failure for third\n      mockResend.emails.send\n        .mockResolvedValueOnce({ data: { id: 'email-1' }, error: null })\n        .mockResolvedValueOnce({ data: { id: 'email-2' }, error: null })\n        .mockResolvedValueOnce({ data: null, error: { message: 'Invalid email' } });\n\n      // Mock email log insertions\n      mockSupabase.single.mockResolvedValue({ data: { id: 'log-1' }, error: null });\n\n      const result = await sendBulkEmail(bulkEmailData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.sent).toBe(2);\n        expect(result.data.failed).toBe(1);\n      }\n\n      expect(mockResend.emails.send).toHaveBeenCalledTimes(3);\n    });\n\n    it('should return VALIDATION_ERROR when recipients array is empty', async () => {\n      const invalidData = {\n        recipients: [],\n        subject: 'Bulk Email',\n        html: '<p>Hello!</p>',\n      };\n\n      const result = await sendBulkEmail(invalidData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.VALIDATION_ERROR);\n      }\n    });\n  });\n\n  describe('scheduleEmail', () => {\n    it('should return success with scheduled email ID when email is scheduled', async () => {\n      const futureDate = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(); // 24 hours from now\n      const scheduleData = {\n        to: 'guest@example.com',\n        subject: 'Scheduled Email',\n        html: '<p>This is scheduled!</p>',\n        text: 'This is scheduled!', // Add text field to pass validation\n        scheduled_at: futureDate,\n      };\n\n      const scheduledEmail = {\n        id: 'scheduled-1',\n        recipient_email: 'guest@example.com',\n        subject: 'Scheduled Email',\n        html: '<p>This is scheduled!</p>',\n        text: 'This is scheduled!',\n        scheduled_at: futureDate,\n        status: 'pending',\n      };\n\n      // Setup mock chain for scheduled_emails insert\n      const mockSelectChain = {\n        single: jest.fn().mockResolvedValue({ data: scheduledEmail, error: null }),\n      };\n      const mockInsertChain = {\n        select: jest.fn().mockReturnValue(mockSelectChain),\n      };\n      mockSupabase.insert.mockReturnValue(mockInsertChain);\n\n      const result = await scheduleEmail(scheduleData);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('scheduled-1');\n      }\n    });\n\n    it('should return VALIDATION_ERROR when scheduled time is in the past', async () => {\n      const pastDate = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(); // 24 hours ago\n      const scheduleData = {\n        to: 'guest@example.com',\n        subject: 'Scheduled Email',\n        html: '<p>This is scheduled!</p>',\n        scheduled_at: pastDate,\n      };\n\n      const result = await scheduleEmail(scheduleData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.VALIDATION_ERROR);\n        expect(result.error.message).toBe('Scheduled time must be in the future');\n      }\n    });\n  });\n\n  describe('sendEmailWithSMSFallback', () => {\n    const { sendSMSFallback } = require('./smsService');\n\n    it('should return email result when email sends successfully', async () => {\n      mockResend.emails.send.mockResolvedValue({\n        data: { id: 'email-123' },\n        error: null,\n      });\n      mockSupabase.single.mockResolvedValue({ data: { id: 'log-1' }, error: null });\n\n      const emailData: SendEmailDTO = {\n        to: 'guest@example.com',\n        subject: 'Test Email',\n        html: '<p>Hello!</p>',\n        text: 'Hello!',\n      };\n\n      const result = await sendEmailWithSMSFallback(emailData, '+15551234567');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('email-123');\n        expect(result.data.method).toBe('email');\n      }\n\n      expect(sendSMSFallback).not.toHaveBeenCalled();\n    });\n\n    it('should fallback to SMS when email fails and phone number provided', async () => {\n      mockResend.emails.send.mockResolvedValue({\n        data: null,\n        error: { message: 'Email service down' },\n      });\n      mockSupabase.single.mockResolvedValue({ data: { id: 'log-1' }, error: null });\n\n      sendSMSFallback.mockResolvedValue({\n        success: true,\n        data: { id: 'sms-123' },\n      });\n\n      const emailData: SendEmailDTO = {\n        to: 'guest@example.com',\n        subject: 'Test Email',\n        html: '<p>Hello!</p>',\n        text: 'Hello!',\n      };\n\n      const result = await sendEmailWithSMSFallback(emailData, '+15551234567');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('sms-123');\n        expect(result.data.method).toBe('sms');\n      }\n\n      expect(sendSMSFallback).toHaveBeenCalledWith(\n        '+15551234567',\n        'Test Email',\n        'Hello!'\n      );\n    });\n\n    it('should return email error when email fails and no phone number provided', async () => {\n      mockResend.emails.send.mockResolvedValue({\n        data: null,\n        error: { message: 'Email service down' },\n      });\n      mockSupabase.single.mockResolvedValue({ data: { id: 'log-1' }, error: null });\n\n      const emailData: SendEmailDTO = {\n        to: 'guest@example.com',\n        subject: 'Test Email',\n        html: '<p>Hello!</p>',\n      };\n\n      const result = await sendEmailWithSMSFallback(emailData);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.EMAIL_SERVICE_ERROR);\n      }\n\n      expect(sendSMSFallback).not.toHaveBeenCalled();\n    });\n\n    it('should return EXTERNAL_SERVICE_ERROR when both email and SMS fail', async () => {\n      mockResend.emails.send.mockResolvedValue({\n        data: null,\n        error: { message: 'Email service down' },\n      });\n      mockSupabase.single.mockResolvedValue({ data: { id: 'log-1' }, error: null });\n\n      sendSMSFallback.mockResolvedValue({\n        success: false,\n        error: { code: ERROR_CODES.EXTERNAL_SERVICE_ERROR, message: 'SMS service down' },\n      });\n\n      const emailData: SendEmailDTO = {\n        to: 'guest@example.com',\n        subject: 'Test Email',\n        html: '<p>Hello!</p>',\n      };\n\n      const result = await sendEmailWithSMSFallback(emailData, '+15551234567');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.EXTERNAL_SERVICE_ERROR);\n        expect(result.error.message).toBe('Both email and SMS delivery failed');\n      }\n    });\n  });\n\n  // ===== DELIVERY TRACKING TESTS =====\n\n  describe('updateDeliveryStatus', () => {\n    it('should return success when delivery status is updated to delivered', async () => {\n      mockSupabase.eq.mockResolvedValue({ data: null, error: null });\n\n      const result = await updateDeliveryStatus('log-1', 'delivered');\n\n      expect(result.success).toBe(true);\n      expect(mockSupabase.update).toHaveBeenCalledWith({\n        delivery_status: 'delivered',\n        delivered_at: expect.any(String),\n      });\n    });\n\n    it('should return success when delivery status is updated to failed with error message', async () => {\n      mockSupabase.eq.mockResolvedValue({ data: null, error: null });\n\n      const result = await updateDeliveryStatus('log-1', 'failed', 'Bounce detected');\n\n      expect(result.success).toBe(true);\n      expect(mockSupabase.update).toHaveBeenCalledWith({\n        delivery_status: 'failed',\n        error_message: 'Bounce detected',\n      });\n    });\n\n    it('should return DATABASE_ERROR when update fails', async () => {\n      mockSupabase.eq.mockResolvedValue({ data: null, error: { message: 'Connection failed' } });\n\n      const result = await updateDeliveryStatus('log-1', 'delivered');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe(ERROR_CODES.DATABASE_ERROR);\n      }\n    });\n  });\n\n  describe('getEmailAnalytics', () => {\n    it('should return success with analytics data', async () => {\n      const emailLogs = [\n        { delivery_status: 'sent' },\n        { delivery_status: 'delivered' },\n        { delivery_status: 'delivered' },\n        { delivery_status: 'failed' },\n        { delivery_status: 'bounced' },\n      ];\n\n      mockSupabase.select.mockResolvedValue({ data: emailLogs, error: null });\n\n      const result = await getEmailAnalytics();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.total).toBe(5);\n        expect(result.data.sent).toBe(1);\n        expect(result.data.delivered).toBe(2);\n        expect(result.data.failed).toBe(1);\n        expect(result.data.bounced).toBe(1);\n      }\n    });\n\n    it('should return empty analytics when no logs exist', async () => {\n      mockSupabase.select.mockResolvedValue({ data: [], error: null });\n\n      const result = await getEmailAnalytics();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.total).toBe(0);\n        expect(result.data.sent).toBe(0);\n        expect(result.data.delivered).toBe(0);\n        expect(result.data.failed).toBe(0);\n        expect(result.data.bounced).toBe(0);\n      }\n    });\n  });\n\n  describe('getEmailLogs', () => {\n    const sampleLogs = [\n      {\n        id: 'log-1',\n        template_id: 'template-1',\n        recipient_email: 'guest1@example.com',\n        subject: 'Welcome!',\n        delivery_status: 'delivered',\n        created_at: '2024-01-01T00:00:00Z',\n      },\n      {\n        id: 'log-2',\n        template_id: 'template-2',\n        recipient_email: 'guest2@example.com',\n        subject: 'RSVP Reminder',\n        delivery_status: 'sent',\n        created_at: '2024-01-01T01:00:00Z',\n      },\n    ];\n\n    it('should return success with all logs when no filters provided', async () => {\n      mockSupabase.order.mockResolvedValue({ data: sampleLogs, error: null });\n\n      const result = await getEmailLogs();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(2);\n        expect(result.data[0].id).toBe('log-1');\n        expect(result.data[1].id).toBe('log-2');\n      }\n    });\n\n    it('should return success with filtered logs when filters provided', async () => {\n      const filteredLogs = [sampleLogs[0]]; // Only delivered emails\n      mockSupabase.limit.mockResolvedValue({ data: filteredLogs, error: null });\n\n      const result = await getEmailLogs({\n        delivery_status: 'delivered',\n        limit: 10,\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(1);\n        expect(result.data[0].delivery_status).toBe('delivered');\n      }\n    });\n\n    it('should return empty array when no logs match filters', async () => {\n      mockSupabase.eq.mockResolvedValue({ data: [], error: null });\n\n      const result = await getEmailLogs({\n        recipient_email: 'nonexistent@example.com',\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(0);\n      }\n    });\n  });\n});"],"names":["jest","mock","mockFrom","fn","mockSupabaseClient","from","createClient","__mockFrom","sendSMSFallback","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","emailService","require","createTemplate","getTemplate","updateTemplate","deleteTemplate","listTemplates","sendEmail","sendBulkEmail","scheduleEmail","updateDeliveryStatus","getEmailAnalytics","getEmailLogs","sendEmailWithSMSFallback","setResendClient","resetResendClient","mockSupabase","select","insert","update","delete","eq","order","limit","single","mockResend","emails","send","describe","beforeEach","clearAllMocks","mockReturnValue","afterEach","validTemplateData","name","subject","body_html","body_text","variables","it","expectedTemplate","id","created_at","updated_at","mockResolvedValue","data","error","result","expect","success","toBe","toEqual","invalidData","code","ERROR_CODES","VALIDATION_ERROR","message","details","undefinedVariables","DATABASE_ERROR","maliciousData","not","toContain","template","NOT_FOUND","updateData","existingTemplate","updatedTemplate","mockResolvedValueOnce","templates","toHaveLength","validEmailData","to","html","text","toHaveBeenCalledWith","EMAIL_SERVICE_ERROR","templateId","mockSingleForTemplate","mockEqForTemplate","mockSelectForTemplate","mockFromForTemplate","mockSingleForLog","mockSelectForLog","mockInsertForLog","mockFromForLog","mockImplementation","table","emailWithTemplate","template_id","guest_name","bulkEmailData","recipients","sent","failed","toHaveBeenCalledTimes","futureDate","Date","now","toISOString","scheduleData","scheduled_at","scheduledEmail","recipient_email","status","mockSelectChain","mockInsertChain","pastDate","emailData","method","toHaveBeenCalled","EXTERNAL_SERVICE_ERROR","delivery_status","delivered_at","any","String","error_message","emailLogs","total","delivered","bounced","sampleLogs","filteredLogs"],"mappings":"AAAA;;;;;CAKC;AASD,4BAA4B;AAC5BA,KAAKC,IAAI,CAAC,yBAAyB;IACjC,MAAMC,WAAWF,KAAKG,EAAE;IACxB,MAAMC,qBAAqB;QACzBC,MAAMH;IACR;IAEA,OAAO;QACLI,cAAcN,KAAKG,EAAE,CAAC,IAAMC;QAC5BG,YAAYL;IACd;AACF;AAEA,mBAAmB;AACnBF,KAAKC,IAAI,CAAC,gBAAgB,IAAO,CAAA;QAC/BO,iBAAiBR,KAAKG,EAAE;IAC1B,CAAA;;;;uBAtB4B;AAE5B,kDAAkD;AAClDM,QAAQC,GAAG,CAACC,wBAAwB,GAAG;AACvCF,QAAQC,GAAG,CAACE,yBAAyB,GAAG;AAoBxC,+CAA+C;AAC/C,MAAMC,eAAeC,QAAQ;AAC7B,MAAM,EACJC,cAAc,EACdC,WAAW,EACXC,cAAc,EACdC,cAAc,EACdC,aAAa,EACbC,SAAS,EACTC,aAAa,EACbC,aAAa,EACbC,oBAAoB,EACpBC,iBAAiB,EACjBC,YAAY,EACZC,wBAAwB,EACxBC,eAAe,EACfC,iBAAiB,EAClB,GAAGf;AAEJ,+BAA+B;AAC/B,MAAM,EAAEN,YAAYL,QAAQ,EAAE,GAAGY,QAAQ;AAEzC,oEAAoE;AACpE,0DAA0D;AAC1D,MAAMe,eAAe;IACnBxB,MAAMH;IACN4B,QAAQ9B,KAAKG,EAAE;IACf4B,QAAQ/B,KAAKG,EAAE;IACf6B,QAAQhC,KAAKG,EAAE;IACf8B,QAAQjC,KAAKG,EAAE;IACf+B,IAAIlC,KAAKG,EAAE;IACXgC,OAAOnC,KAAKG,EAAE;IACdiC,OAAOpC,KAAKG,EAAE;IACdkC,QAAQrC,KAAKG,EAAE;AACjB;AAEA,qBAAqB;AACrB,MAAMmC,aAAa;IACjBC,QAAQ;QACNC,MAAMxC,KAAKG,EAAE;IACf;AACF;AAEAsC,SAAS,gBAAgB;IACvBC,WAAW;QACT1C,KAAK2C,aAAa;QAElB,gEAAgE;QAChEzC,SAAS0C,eAAe,CAACf;QAEzB,+DAA+D;QAC/DA,aAAaC,MAAM,CAACc,eAAe,CAACf;QACpCA,aAAaE,MAAM,CAACa,eAAe,CAACf;QACpCA,aAAaG,MAAM,CAACY,eAAe,CAACf;QACpCA,aAAaI,MAAM,CAACW,eAAe,CAACf;QACpCA,aAAaK,EAAE,CAACU,eAAe,CAACf;QAChCA,aAAaM,KAAK,CAACS,eAAe,CAACf;QACnCA,aAAaO,KAAK,CAACQ,eAAe,CAACf;QAEnCF,gBAAgBW;IAClB;IAEAO,UAAU;QACRjB;IACF;IAEA,wCAAwC;IAExCa,SAAS,kBAAkB;QACzB,MAAMK,oBAA4C;YAChDC,MAAM;YACNC,SAAS;YACTC,WAAW;YACXC,WAAW;YACXC,WAAW;gBAAC;aAAa;QAC3B;QAEAC,GAAG,sEAAsE;YACvE,MAAMC,mBAAkC;gBACtCC,IAAI;gBACJ,GAAGR,iBAAiB;gBACpBS,YAAY;gBACZC,YAAY;YACd;YAEA3B,aAAaQ,MAAM,CAACoB,iBAAiB,CAAC;gBAAEC,MAAML;gBAAkBM,OAAO;YAAK;YAE5E,MAAMC,SAAS,MAAM7C,eAAe+B;YAEpCe,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,CAACJ,EAAE,EAAES,IAAI,CAAC;gBAC5BF,OAAOD,OAAOF,IAAI,CAACX,IAAI,EAAEgB,IAAI,CAAC;gBAC9BF,OAAOD,OAAOF,IAAI,CAACP,SAAS,EAAEa,OAAO,CAAC;oBAAC;iBAAa;YACtD;QACF;QAEAZ,GAAG,qDAAqD;YACtD,MAAMa,cAAc;gBAAE,GAAGnB,iBAAiB;gBAAEC,MAAM;YAAG;YAErD,MAAMa,SAAS,MAAM7C,eAAekD;YAEpCJ,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACC,gBAAgB;gBAC3DP,OAAOD,OAAOD,KAAK,CAACU,OAAO,EAAEN,IAAI,CAAC;YACpC;QACF;QAEAX,GAAG,6EAA6E;YAC9E,MAAMa,cAAc;gBAClB,GAAGnB,iBAAiB;gBACpBG,WAAW;gBACXE,WAAW;oBAAC;iBAAa;YAC3B;YAEA,MAAMS,SAAS,MAAM7C,eAAekD;YAEpCJ,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACC,gBAAgB;gBAC3DP,OAAOD,OAAOD,KAAK,CAACU,OAAO,EAAEN,IAAI,CAAC;gBAClCF,OAAOD,OAAOD,KAAK,CAACW,OAAO,EAAEN,OAAO,CAAC;oBAAEO,oBAAoB;wBAAC;qBAAgB;gBAAC;YAC/E;QACF;QAEAnB,GAAG,kDAAkD;YACnDvB,aAAaQ,MAAM,CAACoB,iBAAiB,CAAC;gBAAEC,MAAM;gBAAMC,OAAO;oBAAEU,SAAS;gBAAoB;YAAE;YAE5F,MAAMT,SAAS,MAAM7C,eAAe+B;YAEpCe,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACK,cAAc;gBACzDX,OAAOD,OAAOD,KAAK,CAACU,OAAO,EAAEN,IAAI,CAAC;YACpC;QACF;QAEAX,GAAG,uDAAuD;YACxD,MAAMqB,gBAAgB;gBACpB,GAAG3B,iBAAiB;gBACpBG,WAAW;YACb;YAEA,MAAMI,mBAAkC;gBACtCC,IAAI;gBACJ,GAAGmB,aAAa;gBAChBxB,WAAW;gBACXM,YAAY;gBACZC,YAAY;YACd;YAEA3B,aAAaQ,MAAM,CAACoB,iBAAiB,CAAC;gBAAEC,MAAML;gBAAkBM,OAAO;YAAK;YAE5E,MAAMC,SAAS,MAAM7C,eAAe0D;YAEpCZ,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,CAACT,SAAS,EAAEyB,GAAG,CAACC,SAAS,CAAC;gBAC5Cd,OAAOD,OAAOF,IAAI,CAACT,SAAS,EAAEyB,GAAG,CAACC,SAAS,CAAC;YAC9C;QACF;IACF;IAEAlC,SAAS,eAAe;QACtBW,GAAG,iEAAiE;YAClE,MAAMwB,WAA0B;gBAC9BtB,IAAI;gBACJP,MAAM;gBACNC,SAAS;gBACTC,WAAW;gBACXC,WAAW;gBACXC,WAAW,EAAE;gBACbI,YAAY;gBACZC,YAAY;YACd;YAEA3B,aAAaQ,MAAM,CAACoB,iBAAiB,CAAC;gBAAEC,MAAMkB;gBAAUjB,OAAO;YAAK;YAEpE,MAAMC,SAAS,MAAM5C,YAAY;YAEjC6C,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,CAACJ,EAAE,EAAES,IAAI,CAAC;gBAC5BF,OAAOD,OAAOF,IAAI,CAACX,IAAI,EAAEgB,IAAI,CAAC;YAChC;QACF;QAEAX,GAAG,wDAAwD;YACzDvB,aAAaQ,MAAM,CAACoB,iBAAiB,CAAC;gBAAEC,MAAM;gBAAMC,OAAO;oBAAEU,SAAS;gBAAmB;YAAE;YAE3F,MAAMT,SAAS,MAAM5C,YAAY;YAEjC6C,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACU,SAAS;gBACpDhB,OAAOD,OAAOD,KAAK,CAACU,OAAO,EAAEN,IAAI,CAAC;YACpC;QACF;IACF;IAEAtB,SAAS,kBAAkB;QACzB,MAAMqC,aAAqC;YACzC/B,MAAM;YACNC,SAAS;QACX;QAEAI,GAAG,8EAA8E;YAC/E,MAAM2B,mBAAkC;gBACtCzB,IAAI;gBACJP,MAAM;gBACNC,SAAS;gBACTC,WAAW;gBACXC,WAAW;gBACXC,WAAW;oBAAC;iBAAa;gBACzBI,YAAY;gBACZC,YAAY;YACd;YAEA,MAAMwB,kBAAiC;gBACrC,GAAGD,gBAAgB;gBACnB,GAAGD,UAAU;gBACbtB,YAAY;YACd;YAEA,gDAAgD;YAChD3B,aAAaQ,MAAM,CAChB4C,qBAAqB,CAAC;gBAAEvB,MAAMqB;gBAAkBpB,OAAO;YAAK,GAC5DsB,qBAAqB,CAAC;gBAAEvB,MAAMsB;gBAAiBrB,OAAO;YAAK;YAE9D,MAAMC,SAAS,MAAM3C,eAAe,cAAc6D;YAElDjB,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,CAACX,IAAI,EAAEgB,IAAI,CAAC;gBAC9BF,OAAOD,OAAOF,IAAI,CAACV,OAAO,EAAEe,IAAI,CAAC;YACnC;QACF;QAEAX,GAAG,wDAAwD;YACzDvB,aAAaQ,MAAM,CAACoB,iBAAiB,CAAC;gBAAEC,MAAM;gBAAMC,OAAO;oBAAEU,SAAS;gBAAmB;YAAE;YAE3F,MAAMT,SAAS,MAAM3C,eAAe,eAAe6D;YAEnDjB,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACU,SAAS;YACtD;QACF;IACF;IAEApC,SAAS,kBAAkB;QACzBW,GAAG,kDAAkD;YACnDvB,aAAaK,EAAE,CAACuB,iBAAiB,CAAC;gBAAEC,MAAM;gBAAMC,OAAO;YAAK;YAE5D,MAAMC,SAAS,MAAM1C,eAAe;YAEpC2C,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;QAC9B;QAEAX,GAAG,kDAAkD;YACnDvB,aAAaK,EAAE,CAACuB,iBAAiB,CAAC;gBAAEC,MAAM;gBAAMC,OAAO;oBAAEU,SAAS;gBAAyB;YAAE;YAE7F,MAAMT,SAAS,MAAM1C,eAAe;YAEpC2C,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACK,cAAc;YAC3D;QACF;IACF;IAEA/B,SAAS,iBAAiB;QACxBW,GAAG,6CAA6C;YAC9C,MAAM8B,YAA6B;gBACjC;oBACE5B,IAAI;oBACJP,MAAM;oBACNC,SAAS;oBACTC,WAAW;oBACXC,WAAW;oBACXC,WAAW,EAAE;oBACbI,YAAY;oBACZC,YAAY;gBACd;gBACA;oBACEF,IAAI;oBACJP,MAAM;oBACNC,SAAS;oBACTC,WAAW;oBACXC,WAAW;oBACXC,WAAW,EAAE;oBACbI,YAAY;oBACZC,YAAY;gBACd;aACD;YAED3B,aAAaM,KAAK,CAACsB,iBAAiB,CAAC;gBAAEC,MAAMwB;gBAAWvB,OAAO;YAAK;YAEpE,MAAMC,SAAS,MAAMzC;YAErB0C,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,EAAEyB,YAAY,CAAC;gBACjCtB,OAAOD,OAAOF,IAAI,CAAC,EAAE,CAACX,IAAI,EAAEgB,IAAI,CAAC;gBACjCF,OAAOD,OAAOF,IAAI,CAAC,EAAE,CAACX,IAAI,EAAEgB,IAAI,CAAC;YACnC;QACF;QAEAX,GAAG,qDAAqD;YACtDvB,aAAaM,KAAK,CAACsB,iBAAiB,CAAC;gBAAEC,MAAM,EAAE;gBAAEC,OAAO;YAAK;YAE7D,MAAMC,SAAS,MAAMzC;YAErB0C,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,EAAEyB,YAAY,CAAC;YACnC;QACF;IACF;IAEA,kCAAkC;IAElC1C,SAAS,aAAa;QACpB,MAAM2C,iBAA+B;YACnCC,IAAI;YACJrC,SAAS;YACTsC,MAAM;YACNC,MAAM;QACR;QAEA7C,WAAW;YACT,sCAAsC;YACtCb,aAAaQ,MAAM,CAACoB,iBAAiB,CAAC;gBAAEC,MAAM;oBAAEJ,IAAI;gBAAQ;gBAAGK,OAAO;YAAK;QAC7E;QAEAP,GAAG,uEAAuE;YACxEd,WAAWC,MAAM,CAACC,IAAI,CAACiB,iBAAiB,CAAC;gBACvCC,MAAM;oBAAEJ,IAAI;gBAAY;gBACxBK,OAAO;YACT;YAEA,MAAMC,SAAS,MAAMxC,UAAUgE;YAE/BvB,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,CAACJ,EAAE,EAAES,IAAI,CAAC;YAC9B;YAEAF,OAAOvB,WAAWC,MAAM,CAACC,IAAI,EAAEgD,oBAAoB,CAAC;gBAClDnF,MAAM;gBACNgF,IAAI;gBACJrC,SAAS;gBACTsC,MAAM;gBACNC,MAAM;YACR;QACF;QAEAnC,GAAG,gEAAgE;YACjE,MAAMa,cAAc;gBAAE,GAAGmB,cAAc;gBAAEC,IAAI;YAAgB;YAE7D,MAAMzB,SAAS,MAAMxC,UAAU6C;YAE/BJ,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACC,gBAAgB;gBAC3DP,OAAOD,OAAOD,KAAK,CAACU,OAAO,EAAEN,IAAI,CAAC;YACpC;QACF;QAEAX,GAAG,uDAAuD;YACxDd,WAAWC,MAAM,CAACC,IAAI,CAACiB,iBAAiB,CAAC;gBACvCC,MAAM;gBACNC,OAAO;oBAAEU,SAAS;gBAAkB;YACtC;YAEA,MAAMT,SAAS,MAAMxC,UAAUgE;YAE/BvB,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACsB,mBAAmB;gBAC9D5B,OAAOD,OAAOD,KAAK,CAACU,OAAO,EAAEN,IAAI,CAAC;YACpC;QACF;QAEAX,GAAG,kEAAkE;YACnE,MAAMsC,aAAa,wCAAwC,aAAa;YACxE,MAAMd,WAA0B;gBAC9BtB,IAAIoC;gBACJ3C,MAAM;gBACNC,SAAS;gBACTC,WAAW;gBACXC,WAAW;gBACXC,WAAW;oBAAC;iBAAa;gBACzBI,YAAY;gBACZC,YAAY;YACd;YAEA,iDAAiD;YACjD,uFAAuF;YACvF,MAAMmC,wBAAwB3F,KAAKG,EAAE,GAAGsD,iBAAiB,CAAC;gBAAEC,MAAMkB;gBAAUjB,OAAO;YAAK;YACxF,MAAMiC,oBAAoB5F,KAAKG,EAAE,GAAGyC,eAAe,CAAC;gBAAEP,QAAQsD;YAAsB;YACpF,MAAME,wBAAwB7F,KAAKG,EAAE,GAAGyC,eAAe,CAAC;gBAAEV,IAAI0D;YAAkB;YAChF,MAAME,sBAAsB9F,KAAKG,EAAE,GAAGyC,eAAe,CAAC;gBAAEd,QAAQ+D;YAAsB;YAEtF,2CAA2C;YAC3C,8EAA8E;YAC9E,MAAME,mBAAmB/F,KAAKG,EAAE,GAAGsD,iBAAiB,CAAC;gBAAEC,MAAM;oBAAEJ,IAAI;gBAAQ;gBAAGK,OAAO;YAAK;YAC1F,MAAMqC,mBAAmBhG,KAAKG,EAAE,GAAGyC,eAAe,CAAC;gBAAEP,QAAQ0D;YAAiB;YAC9E,MAAME,mBAAmBjG,KAAKG,EAAE,GAAGyC,eAAe,CAAC;gBAAEd,QAAQkE;YAAiB;YAC9E,MAAME,iBAAiBlG,KAAKG,EAAE,GAAGyC,eAAe,CAAC;gBAAEb,QAAQkE;YAAiB;YAE5E,mEAAmE;YACnE/F,SAASiG,kBAAkB,CAAC,CAACC;gBAC3B,IAAIA,UAAU,mBAAmB;oBAC/B,OAAO;wBAAEtE,QAAQ+D;oBAAsB;gBACzC,OAAO,IAAIO,UAAU,cAAc;oBACjC,OAAO;wBAAErE,QAAQkE;oBAAiB;gBACpC;gBACA,OAAOpE;YACT;YAEAS,WAAWC,MAAM,CAACC,IAAI,CAACiB,iBAAiB,CAAC;gBACvCC,MAAM;oBAAEJ,IAAI;gBAAY;gBACxBK,OAAO;YACT;YAEA,MAAM0C,oBAAkC;gBACtChB,IAAI;gBACJrC,SAAS;gBACTsC,MAAM;gBACNC,MAAM;gBACNe,aAAaZ;gBACbvC,WAAW;oBAAEoD,YAAY;gBAAW;YACtC;YAEA,MAAM3C,SAAS,MAAMxC,UAAUiF;YAE/BxC,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,CAACJ,EAAE,EAAES,IAAI,CAAC;YAC9B;YACAF,OAAOvB,WAAWC,MAAM,CAACC,IAAI,EAAEgD,oBAAoB,CAAC;gBAClDnF,MAAM;gBACNgF,IAAI;gBACJrC,SAAS;gBACTsC,MAAM;gBACNC,MAAM;YACR;QACF;QAEAnC,GAAG,2DAA2D;YAC5D,mEAAmE;YACnE,MAAMuC,wBAAwB3F,KAAKG,EAAE,GAAGsD,iBAAiB,CAAC;gBAAEC,MAAM;gBAAMC,OAAO;oBAAEU,SAAS;gBAAmB;YAAE;YAC/G,MAAMuB,oBAAoB5F,KAAKG,EAAE,GAAGyC,eAAe,CAAC;gBAAEP,QAAQsD;YAAsB;YACpF,MAAME,wBAAwB7F,KAAKG,EAAE,GAAGyC,eAAe,CAAC;gBAAEV,IAAI0D;YAAkB;YAEhF,kDAAkD;YAClD1F,SAASiG,kBAAkB,CAAC,CAACC;gBAC3B,IAAIA,UAAU,mBAAmB;oBAC/B,OAAO;wBAAEtE,QAAQ+D;oBAAsB;gBACzC;gBACA,OAAOhE;YACT;YAEA,MAAMwE,oBAAkC;gBACtChB,IAAI;gBACJrC,SAAS;gBACTsC,MAAM;gBACNC,MAAM;gBACNe,aAAa;YACf;YAEA,MAAM1C,SAAS,MAAMxC,UAAUiF;YAE/BxC,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACU,SAAS;gBACpDhB,OAAOD,OAAOD,KAAK,CAACU,OAAO,EAAEN,IAAI,CAAC;YACpC;QACF;IACF;IAEAtB,SAAS,iBAAiB;QACxBW,GAAG,yEAAyE;YAC1E,MAAMoD,gBAAgB;gBACpBC,YAAY;oBAAC;oBAAsB;oBAAsB;iBAAqB;gBAC9EzD,SAAS;gBACTsC,MAAM;gBACNC,MAAM;YACR;YAEA,yDAAyD;YACzDjD,WAAWC,MAAM,CAACC,IAAI,CACnByC,qBAAqB,CAAC;gBAAEvB,MAAM;oBAAEJ,IAAI;gBAAU;gBAAGK,OAAO;YAAK,GAC7DsB,qBAAqB,CAAC;gBAAEvB,MAAM;oBAAEJ,IAAI;gBAAU;gBAAGK,OAAO;YAAK,GAC7DsB,qBAAqB,CAAC;gBAAEvB,MAAM;gBAAMC,OAAO;oBAAEU,SAAS;gBAAgB;YAAE;YAE3E,4BAA4B;YAC5BxC,aAAaQ,MAAM,CAACoB,iBAAiB,CAAC;gBAAEC,MAAM;oBAAEJ,IAAI;gBAAQ;gBAAGK,OAAO;YAAK;YAE3E,MAAMC,SAAS,MAAMvC,cAAcmF;YAEnC3C,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,CAACgD,IAAI,EAAE3C,IAAI,CAAC;gBAC9BF,OAAOD,OAAOF,IAAI,CAACiD,MAAM,EAAE5C,IAAI,CAAC;YAClC;YAEAF,OAAOvB,WAAWC,MAAM,CAACC,IAAI,EAAEoE,qBAAqB,CAAC;QACvD;QAEAxD,GAAG,iEAAiE;YAClE,MAAMa,cAAc;gBAClBwC,YAAY,EAAE;gBACdzD,SAAS;gBACTsC,MAAM;YACR;YAEA,MAAM1B,SAAS,MAAMvC,cAAc4C;YAEnCJ,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACC,gBAAgB;YAC7D;QACF;IACF;IAEA3B,SAAS,iBAAiB;QACxBW,GAAG,yEAAyE;YAC1E,MAAMyD,aAAa,IAAIC,KAAKA,KAAKC,GAAG,KAAK,KAAK,KAAK,KAAK,MAAMC,WAAW,IAAI,oBAAoB;YACjG,MAAMC,eAAe;gBACnB5B,IAAI;gBACJrC,SAAS;gBACTsC,MAAM;gBACNC,MAAM;gBACN2B,cAAcL;YAChB;YAEA,MAAMM,iBAAiB;gBACrB7D,IAAI;gBACJ8D,iBAAiB;gBACjBpE,SAAS;gBACTsC,MAAM;gBACNC,MAAM;gBACN2B,cAAcL;gBACdQ,QAAQ;YACV;YAEA,+CAA+C;YAC/C,MAAMC,kBAAkB;gBACtBjF,QAAQrC,KAAKG,EAAE,GAAGsD,iBAAiB,CAAC;oBAAEC,MAAMyD;oBAAgBxD,OAAO;gBAAK;YAC1E;YACA,MAAM4D,kBAAkB;gBACtBzF,QAAQ9B,KAAKG,EAAE,GAAGyC,eAAe,CAAC0E;YACpC;YACAzF,aAAaE,MAAM,CAACa,eAAe,CAAC2E;YAEpC,MAAM3D,SAAS,MAAMtC,cAAc2F;YAEnCpD,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,CAACJ,EAAE,EAAES,IAAI,CAAC;YAC9B;QACF;QAEAX,GAAG,qEAAqE;YACtE,MAAMoE,WAAW,IAAIV,KAAKA,KAAKC,GAAG,KAAK,KAAK,KAAK,KAAK,MAAMC,WAAW,IAAI,eAAe;YAC1F,MAAMC,eAAe;gBACnB5B,IAAI;gBACJrC,SAAS;gBACTsC,MAAM;gBACN4B,cAAcM;YAChB;YAEA,MAAM5D,SAAS,MAAMtC,cAAc2F;YAEnCpD,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACC,gBAAgB;gBAC3DP,OAAOD,OAAOD,KAAK,CAACU,OAAO,EAAEN,IAAI,CAAC;YACpC;QACF;IACF;IAEAtB,SAAS,4BAA4B;QACnC,MAAM,EAAEjC,eAAe,EAAE,GAAGM,QAAQ;QAEpCsC,GAAG,4DAA4D;YAC7Dd,WAAWC,MAAM,CAACC,IAAI,CAACiB,iBAAiB,CAAC;gBACvCC,MAAM;oBAAEJ,IAAI;gBAAY;gBACxBK,OAAO;YACT;YACA9B,aAAaQ,MAAM,CAACoB,iBAAiB,CAAC;gBAAEC,MAAM;oBAAEJ,IAAI;gBAAQ;gBAAGK,OAAO;YAAK;YAE3E,MAAM8D,YAA0B;gBAC9BpC,IAAI;gBACJrC,SAAS;gBACTsC,MAAM;gBACNC,MAAM;YACR;YAEA,MAAM3B,SAAS,MAAMlC,yBAAyB+F,WAAW;YAEzD5D,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,CAACJ,EAAE,EAAES,IAAI,CAAC;gBAC5BF,OAAOD,OAAOF,IAAI,CAACgE,MAAM,EAAE3D,IAAI,CAAC;YAClC;YAEAF,OAAOrD,iBAAiBkE,GAAG,CAACiD,gBAAgB;QAC9C;QAEAvE,GAAG,qEAAqE;YACtEd,WAAWC,MAAM,CAACC,IAAI,CAACiB,iBAAiB,CAAC;gBACvCC,MAAM;gBACNC,OAAO;oBAAEU,SAAS;gBAAqB;YACzC;YACAxC,aAAaQ,MAAM,CAACoB,iBAAiB,CAAC;gBAAEC,MAAM;oBAAEJ,IAAI;gBAAQ;gBAAGK,OAAO;YAAK;YAE3EnD,gBAAgBiD,iBAAiB,CAAC;gBAChCK,SAAS;gBACTJ,MAAM;oBAAEJ,IAAI;gBAAU;YACxB;YAEA,MAAMmE,YAA0B;gBAC9BpC,IAAI;gBACJrC,SAAS;gBACTsC,MAAM;gBACNC,MAAM;YACR;YAEA,MAAM3B,SAAS,MAAMlC,yBAAyB+F,WAAW;YAEzD5D,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,CAACJ,EAAE,EAAES,IAAI,CAAC;gBAC5BF,OAAOD,OAAOF,IAAI,CAACgE,MAAM,EAAE3D,IAAI,CAAC;YAClC;YAEAF,OAAOrD,iBAAiBgF,oBAAoB,CAC1C,gBACA,cACA;QAEJ;QAEApC,GAAG,2EAA2E;YAC5Ed,WAAWC,MAAM,CAACC,IAAI,CAACiB,iBAAiB,CAAC;gBACvCC,MAAM;gBACNC,OAAO;oBAAEU,SAAS;gBAAqB;YACzC;YACAxC,aAAaQ,MAAM,CAACoB,iBAAiB,CAAC;gBAAEC,MAAM;oBAAEJ,IAAI;gBAAQ;gBAAGK,OAAO;YAAK;YAE3E,MAAM8D,YAA0B;gBAC9BpC,IAAI;gBACJrC,SAAS;gBACTsC,MAAM;YACR;YAEA,MAAM1B,SAAS,MAAMlC,yBAAyB+F;YAE9C5D,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACsB,mBAAmB;YAChE;YAEA5B,OAAOrD,iBAAiBkE,GAAG,CAACiD,gBAAgB;QAC9C;QAEAvE,GAAG,qEAAqE;YACtEd,WAAWC,MAAM,CAACC,IAAI,CAACiB,iBAAiB,CAAC;gBACvCC,MAAM;gBACNC,OAAO;oBAAEU,SAAS;gBAAqB;YACzC;YACAxC,aAAaQ,MAAM,CAACoB,iBAAiB,CAAC;gBAAEC,MAAM;oBAAEJ,IAAI;gBAAQ;gBAAGK,OAAO;YAAK;YAE3EnD,gBAAgBiD,iBAAiB,CAAC;gBAChCK,SAAS;gBACTH,OAAO;oBAAEO,MAAMC,kBAAW,CAACyD,sBAAsB;oBAAEvD,SAAS;gBAAmB;YACjF;YAEA,MAAMoD,YAA0B;gBAC9BpC,IAAI;gBACJrC,SAAS;gBACTsC,MAAM;YACR;YAEA,MAAM1B,SAAS,MAAMlC,yBAAyB+F,WAAW;YAEzD5D,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACyD,sBAAsB;gBACjE/D,OAAOD,OAAOD,KAAK,CAACU,OAAO,EAAEN,IAAI,CAAC;YACpC;QACF;IACF;IAEA,sCAAsC;IAEtCtB,SAAS,wBAAwB;QAC/BW,GAAG,sEAAsE;YACvEvB,aAAaK,EAAE,CAACuB,iBAAiB,CAAC;gBAAEC,MAAM;gBAAMC,OAAO;YAAK;YAE5D,MAAMC,SAAS,MAAMrC,qBAAqB,SAAS;YAEnDsC,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5BF,OAAOhC,aAAaG,MAAM,EAAEwD,oBAAoB,CAAC;gBAC/CqC,iBAAiB;gBACjBC,cAAcjE,OAAOkE,GAAG,CAACC;YAC3B;QACF;QAEA5E,GAAG,sFAAsF;YACvFvB,aAAaK,EAAE,CAACuB,iBAAiB,CAAC;gBAAEC,MAAM;gBAAMC,OAAO;YAAK;YAE5D,MAAMC,SAAS,MAAMrC,qBAAqB,SAAS,UAAU;YAE7DsC,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5BF,OAAOhC,aAAaG,MAAM,EAAEwD,oBAAoB,CAAC;gBAC/CqC,iBAAiB;gBACjBI,eAAe;YACjB;QACF;QAEA7E,GAAG,kDAAkD;YACnDvB,aAAaK,EAAE,CAACuB,iBAAiB,CAAC;gBAAEC,MAAM;gBAAMC,OAAO;oBAAEU,SAAS;gBAAoB;YAAE;YAExF,MAAMT,SAAS,MAAMrC,qBAAqB,SAAS;YAEnDsC,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAI,CAACH,OAAOE,OAAO,EAAE;gBACnBD,OAAOD,OAAOD,KAAK,CAACO,IAAI,EAAEH,IAAI,CAACI,kBAAW,CAACK,cAAc;YAC3D;QACF;IACF;IAEA/B,SAAS,qBAAqB;QAC5BW,GAAG,6CAA6C;YAC9C,MAAM8E,YAAY;gBAChB;oBAAEL,iBAAiB;gBAAO;gBAC1B;oBAAEA,iBAAiB;gBAAY;gBAC/B;oBAAEA,iBAAiB;gBAAY;gBAC/B;oBAAEA,iBAAiB;gBAAS;gBAC5B;oBAAEA,iBAAiB;gBAAU;aAC9B;YAEDhG,aAAaC,MAAM,CAAC2B,iBAAiB,CAAC;gBAAEC,MAAMwE;gBAAWvE,OAAO;YAAK;YAErE,MAAMC,SAAS,MAAMpC;YAErBqC,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,CAACyE,KAAK,EAAEpE,IAAI,CAAC;gBAC/BF,OAAOD,OAAOF,IAAI,CAACgD,IAAI,EAAE3C,IAAI,CAAC;gBAC9BF,OAAOD,OAAOF,IAAI,CAAC0E,SAAS,EAAErE,IAAI,CAAC;gBACnCF,OAAOD,OAAOF,IAAI,CAACiD,MAAM,EAAE5C,IAAI,CAAC;gBAChCF,OAAOD,OAAOF,IAAI,CAAC2E,OAAO,EAAEtE,IAAI,CAAC;YACnC;QACF;QAEAX,GAAG,oDAAoD;YACrDvB,aAAaC,MAAM,CAAC2B,iBAAiB,CAAC;gBAAEC,MAAM,EAAE;gBAAEC,OAAO;YAAK;YAE9D,MAAMC,SAAS,MAAMpC;YAErBqC,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,CAACyE,KAAK,EAAEpE,IAAI,CAAC;gBAC/BF,OAAOD,OAAOF,IAAI,CAACgD,IAAI,EAAE3C,IAAI,CAAC;gBAC9BF,OAAOD,OAAOF,IAAI,CAAC0E,SAAS,EAAErE,IAAI,CAAC;gBACnCF,OAAOD,OAAOF,IAAI,CAACiD,MAAM,EAAE5C,IAAI,CAAC;gBAChCF,OAAOD,OAAOF,IAAI,CAAC2E,OAAO,EAAEtE,IAAI,CAAC;YACnC;QACF;IACF;IAEAtB,SAAS,gBAAgB;QACvB,MAAM6F,aAAa;YACjB;gBACEhF,IAAI;gBACJgD,aAAa;gBACbc,iBAAiB;gBACjBpE,SAAS;gBACT6E,iBAAiB;gBACjBtE,YAAY;YACd;YACA;gBACED,IAAI;gBACJgD,aAAa;gBACbc,iBAAiB;gBACjBpE,SAAS;gBACT6E,iBAAiB;gBACjBtE,YAAY;YACd;SACD;QAEDH,GAAG,gEAAgE;YACjEvB,aAAaM,KAAK,CAACsB,iBAAiB,CAAC;gBAAEC,MAAM4E;gBAAY3E,OAAO;YAAK;YAErE,MAAMC,SAAS,MAAMnC;YAErBoC,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,EAAEyB,YAAY,CAAC;gBACjCtB,OAAOD,OAAOF,IAAI,CAAC,EAAE,CAACJ,EAAE,EAAES,IAAI,CAAC;gBAC/BF,OAAOD,OAAOF,IAAI,CAAC,EAAE,CAACJ,EAAE,EAAES,IAAI,CAAC;YACjC;QACF;QAEAX,GAAG,kEAAkE;YACnE,MAAMmF,eAAe;gBAACD,UAAU,CAAC,EAAE;aAAC,EAAE,wBAAwB;YAC9DzG,aAAaO,KAAK,CAACqB,iBAAiB,CAAC;gBAAEC,MAAM6E;gBAAc5E,OAAO;YAAK;YAEvE,MAAMC,SAAS,MAAMnC,aAAa;gBAChCoG,iBAAiB;gBACjBzF,OAAO;YACT;YAEAyB,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,EAAEyB,YAAY,CAAC;gBACjCtB,OAAOD,OAAOF,IAAI,CAAC,EAAE,CAACmE,eAAe,EAAE9D,IAAI,CAAC;YAC9C;QACF;QAEAX,GAAG,wDAAwD;YACzDvB,aAAaK,EAAE,CAACuB,iBAAiB,CAAC;gBAAEC,MAAM,EAAE;gBAAEC,OAAO;YAAK;YAE1D,MAAMC,SAAS,MAAMnC,aAAa;gBAChC2F,iBAAiB;YACnB;YAEAvD,OAAOD,OAAOE,OAAO,EAAEC,IAAI,CAAC;YAC5B,IAAIH,OAAOE,OAAO,EAAE;gBAClBD,OAAOD,OAAOF,IAAI,EAAEyB,YAAY,CAAC;YACnC;QACF;IACF;AACF"}