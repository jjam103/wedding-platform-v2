{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/guest/profile/route.ts"],"sourcesContent":["import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\nimport { z } from 'zod';\nimport { sanitizeInput } from '@/utils/sanitization';\nimport { sendEmail } from '@/services/emailService';\n\n/**\n * Guest Profile API Routes\n * \n * GET: Get guest profile with group membership\n * PUT: Update guest profile\n * \n * Requirements: 6.2, 6.4, 6.5, 6.6, 6.7, 6.8, 6.12\n */\n\nconst updateProfileSchema = z.object({\n  first_name: z.string().min(1).max(50).optional(),\n  last_name: z.string().min(1).max(50).optional(),\n  email: z.string().email().optional(),\n  phone: z.string().max(20).optional(),\n  dietary_restrictions: z.string().max(500).optional(),\n});\n\n/**\n * GET /api/guest/profile\n * Get guest profile with group membership\n */\nexport async function GET(request: Request) {\n  try {\n    const supabase = createRouteHandlerClient({ cookies });\n    \n    // Check authentication\n    const { data: { session }, error: authError } = await supabase.auth.getSession();\n    \n    if (authError || !session) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n    \n    // Get guest profile\n    const { data: guest, error: guestError } = await supabase\n      .from('guests')\n      .select(`\n        *,\n        groups:group_id (\n          id,\n          name,\n          group_type\n        )\n      `)\n      .eq('email', session.user.email)\n      .single();\n    \n    if (guestError || !guest) {\n      return NextResponse.json(\n        { success: false, error: { code: 'NOT_FOUND', message: 'Guest profile not found' } },\n        { status: 404 }\n      );\n    }\n    \n    return NextResponse.json({\n      success: true,\n      data: guest\n    });\n  } catch (error) {\n    console.error('Error fetching guest profile:', error);\n    return NextResponse.json(\n      { success: false, error: { code: 'INTERNAL_ERROR', message: 'Failed to fetch profile' } },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * PUT /api/guest/profile\n * Update guest profile\n */\nexport async function PUT(request: Request) {\n  try {\n    const supabase = createRouteHandlerClient({ cookies });\n    \n    // Check authentication\n    const { data: { session }, error: authError } = await supabase.auth.getSession();\n    \n    if (authError || !session) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n    \n    // Get current guest\n    const { data: guest, error: guestError } = await supabase\n      .from('guests')\n      .select('*')\n      .eq('email', session.user.email)\n      .single();\n    \n    if (guestError || !guest) {\n      return NextResponse.json(\n        { success: false, error: { code: 'NOT_FOUND', message: 'Guest profile not found' } },\n        { status: 404 }\n      );\n    }\n    \n    // Parse and validate request body\n    const body = await request.json();\n    const validation = updateProfileSchema.safeParse(body);\n    \n    if (!validation.success) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: { \n            code: 'VALIDATION_ERROR', \n            message: 'Invalid request data', \n            details: validation.error.issues \n          } \n        },\n        { status: 400 }\n      );\n    }\n    \n    // Sanitize inputs\n    const sanitized: Record<string, any> = {};\n    if (validation.data.first_name) {\n      sanitized.first_name = sanitizeInput(validation.data.first_name);\n    }\n    if (validation.data.last_name) {\n      sanitized.last_name = sanitizeInput(validation.data.last_name);\n    }\n    if (validation.data.email) {\n      sanitized.email = sanitizeInput(validation.data.email);\n    }\n    if (validation.data.phone) {\n      sanitized.phone = sanitizeInput(validation.data.phone);\n    }\n    if (validation.data.dietary_restrictions !== undefined) {\n      sanitized.dietary_restrictions = validation.data.dietary_restrictions \n        ? sanitizeInput(validation.data.dietary_restrictions)\n        : null;\n    }\n    \n    // Update profile\n    const { data: updatedGuest, error: updateError } = await supabase\n      .from('guests')\n      .update(sanitized)\n      .eq('id', guest.id)\n      .select()\n      .single();\n    \n    if (updateError) {\n      return NextResponse.json(\n        { success: false, error: { code: 'DATABASE_ERROR', message: updateError.message } },\n        { status: 500 }\n      );\n    }\n    \n    // Send admin notification for critical updates\n    const criticalFields = ['email', 'dietary_restrictions'];\n    const hasCriticalUpdate = Object.keys(sanitized).some(key => criticalFields.includes(key));\n    \n    if (hasCriticalUpdate) {\n      try {\n        await sendEmail({\n          to: process.env.ADMIN_EMAIL || 'admin@example.com',\n          subject: 'Guest Profile Update',\n          html: `\n            <h2>Guest Profile Updated</h2>\n            <p><strong>Guest:</strong> ${updatedGuest.first_name} ${updatedGuest.last_name}</p>\n            <p><strong>Updated Fields:</strong></p>\n            <ul>\n              ${Object.keys(sanitized).map(key => `<li>${key}: ${sanitized[key]}</li>`).join('')}\n            </ul>\n          `\n        });\n      } catch (emailError) {\n        console.error('Failed to send admin notification:', emailError);\n        // Don't fail the request if email fails\n      }\n    }\n    \n    return NextResponse.json({\n      success: true,\n      data: updatedGuest\n    });\n  } catch (error) {\n    console.error('Error updating guest profile:', error);\n    return NextResponse.json(\n      { success: false, error: { code: 'INTERNAL_ERROR', message: 'Failed to update profile' } },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["GET","PUT","updateProfileSchema","z","object","first_name","string","min","max","optional","last_name","email","phone","dietary_restrictions","request","supabase","createRouteHandlerClient","cookies","data","session","error","authError","auth","getSession","NextResponse","json","success","code","message","status","guest","guestError","from","select","eq","user","single","console","body","validation","safeParse","details","issues","sanitized","sanitizeInput","undefined","updatedGuest","updateError","update","id","criticalFields","hasCriticalUpdate","Object","keys","some","key","includes","sendEmail","to","process","env","ADMIN_EMAIL","subject","html","map","join","emailError"],"mappings":"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"}