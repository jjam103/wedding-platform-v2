{"version":3,"names":["POST","validateRequestSchema","cov_2drhp3mr5j","s","_zod","z","object","pageId","string","uuid","optional","pageType","references","array","type","enum","id","name","description","metadata","record","any","request","f","supabase","_authhelpersnextjs","createRouteHandlerClient","cookies","_headers","data","session","error","authError","auth","getSession","b","_server","NextResponse","json","success","code","message","status","body","validation","safeParse","details","issues","hasCircularReference","circularResult","_sectionsService","detectCircularReferences","validationResult","validateReferences","valid","brokenReferences","circularReferences","console","Error"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/references/validate/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { cookies } from 'next/headers';\nimport { z } from 'zod';\nimport * as sectionsService from '@/services/sectionsService';\n\n/**\n * Reference Validation API Route\n * \n * POST /api/admin/references/validate\n * \n * Validates references for:\n * - Existence in database (broken reference detection)\n * - Circular reference detection\n * \n * Requirements: 21.8, 21.9\n */\n\nconst validateRequestSchema = z.object({\n  pageId: z.string().uuid().optional(),\n  pageType: z.string().optional(),\n  references: z.array(\n    z.object({\n      type: z.enum(['event', 'activity', 'content_page', 'accommodation']),\n      id: z.string().uuid(),\n      name: z.string(),\n      description: z.string().optional(),\n      metadata: z.record(z.any()).optional(),\n    })\n  ),\n});\n\nexport async function POST(request: Request) {\n  try {\n    // 1. Auth check\n    const supabase = createRouteHandlerClient({ cookies });\n    const {\n      data: { session },\n      error: authError,\n    } = await supabase.auth.getSession();\n\n    if (authError || !session) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'UNAUTHORIZED',\n            message: 'Authentication required',\n          },\n        },\n        { status: 401 }\n      );\n    }\n\n    // 2. Parse and validate request\n    const body = await request.json();\n    const validation = validateRequestSchema.safeParse(body);\n\n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid request',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    const { pageId, pageType, references } = validation.data;\n\n    // 3. Check for circular references if pageId and pageType provided\n    let hasCircularReference = false;\n    if (pageId && pageType) {\n      const circularResult = await sectionsService.detectCircularReferences(\n        pageId,\n        references\n      );\n\n      if (!circularResult.success) {\n        return NextResponse.json(\n          {\n            success: false,\n            error: {\n              code: 'VALIDATION_ERROR',\n              message: circularResult.error.message,\n              details: circularResult.error.details,\n            },\n          },\n          { status: 500 }\n        );\n      }\n\n      hasCircularReference = circularResult.data;\n    }\n\n    // 4. Validate reference existence (broken reference detection)\n    const validationResult = await sectionsService.validateReferences(references);\n\n    if (!validationResult.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: validationResult.error.message,\n            details: validationResult.error.details,\n          },\n        },\n        { status: 500 }\n      );\n    }\n\n    // 5. Return validation result\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          valid: validationResult.data.valid && !hasCircularReference,\n          hasCircularReference,\n          brokenReferences: validationResult.data.brokenReferences,\n          circularReferences: validationResult.data.circularReferences,\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('Reference validation error:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'INTERNAL_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}