{"version":3,"names":["POST","magicLinkRequestSchema","cov_1ca5yryfnl","s","_zod","z","object","email","string","request","f","body","json","validation","safeParse","success","b","_server","NextResponse","error","code","message","details","issues","status","_sanitization","sanitizeInput","data","toLowerCase","supabase","_supabase","createSupabaseClient","guest","guestError","from","select","eq","single","tokenBytes","crypto","getRandomValues","Uint8Array","token","Array","map","toString","padStart","join","expiresAt","Date","now","tokenError","insert","guest_id","id","expires_at","toISOString","ip_address","headers","get","user_agent","console","baseUrl","process","env","NEXT_PUBLIC_URL","magicLinkUrl","log","action","entity_type","entity_id","Error"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/auth/guest/magic-link/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createSupabaseClient } from '@/lib/supabase';\nimport { z } from 'zod';\nimport { sanitizeInput } from '@/utils/sanitization';\n\n/**\n * Magic Link Request API Route\n * \n * Generates a secure one-time token and sends it via email to the guest.\n * The token is valid for 15 minutes and can only be used once.\n * \n * Requirements: 5.3, 5.9\n * Task: 6.1\n */\n\nconst magicLinkRequestSchema = z.object({\n  email: z.string().email('Invalid email format'),\n});\n\n/**\n * POST /api/auth/guest/magic-link\n * \n * Request a magic link for passwordless authentication.\n * \n * @param request - Request containing email in body\n * @returns Success response with message, or error response\n */\nexport async function POST(request: Request) {\n  try {\n    // 1. Parse and validate request body\n    const body = await request.json();\n    const validation = magicLinkRequestSchema.safeParse(body);\n    \n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid email format',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n    \n    // 2. Sanitize email input\n    const email = sanitizeInput(validation.data.email.toLowerCase());\n    \n    // 3. Create Supabase client\n    const supabase = createSupabaseClient();\n    \n    // 4. Find guest by email with magic_link auth method\n    const { data: guest, error: guestError } = await supabase\n      .from('guests')\n      .select('id, email, first_name, last_name, auth_method')\n      .eq('email', email)\n      .eq('auth_method', 'magic_link')\n      .single();\n    \n    if (guestError || !guest) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'NOT_FOUND',\n            message: 'Email not found or not configured for magic link authentication',\n          },\n        },\n        { status: 404 }\n      );\n    }\n    \n    // 5. Generate secure token (32 bytes = 64 hex characters)\n    const tokenBytes = crypto.getRandomValues(new Uint8Array(32));\n    const token = Array.from(tokenBytes)\n      .map(b => b.toString(16).padStart(2, '0'))\n      .join('');\n    \n    // 6. Calculate expiration (15 minutes from now)\n    const expiresAt = new Date(Date.now() + 15 * 60 * 1000);\n    \n    // 7. Store token in database\n    const { error: tokenError } = await supabase\n      .from('magic_link_tokens')\n      .insert({\n        guest_id: guest.id,\n        token,\n        expires_at: expiresAt.toISOString(),\n        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || 'unknown',\n        user_agent: request.headers.get('user-agent') || 'unknown',\n      });\n    \n    if (tokenError) {\n      console.error('Failed to store magic link token:', tokenError);\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'TOKEN_ERROR',\n            message: 'Failed to generate magic link',\n          },\n        },\n        { status: 500 }\n      );\n    }\n    \n    // 8. Generate magic link URL\n    const baseUrl = process.env.NEXT_PUBLIC_URL || 'http://localhost:3000';\n    const magicLinkUrl = `${baseUrl}/auth/guest-login/verify?token=${token}`;\n    \n    // 9. Send email with magic link\n    // Note: Email sending will be implemented when emailService is integrated\n    // For now, we'll log the link (in production, this would send an actual email)\n    console.log(`Magic link for ${email}: ${magicLinkUrl}`);\n    \n    // TODO: Implement email sending\n    // await emailService.send({\n    //   to: email,\n    //   subject: 'Your Wedding Portal Login Link',\n    //   html: `\n    //     <p>Hi ${guest.first_name},</p>\n    //     <p>Click the link below to log in to the wedding portal:</p>\n    //     <p><a href=\"${magicLinkUrl}\">Log In</a></p>\n    //     <p>This link will expire in 15 minutes and can only be used once.</p>\n    //     <p>If you didn't request this link, you can safely ignore this email.</p>\n    //   `,\n    // });\n    \n    // 10. Log magic link request in audit log\n    await supabase.from('audit_logs').insert({\n      action: 'magic_link_requested',\n      entity_type: 'guest',\n      entity_id: guest.id,\n      details: {\n        email: guest.email,\n        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || 'unknown',\n      },\n    });\n    \n    // 11. Return success response (don't reveal if email exists for security)\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          message: 'If your email is registered, you will receive a login link shortly.',\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('Magic link request error:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'UNKNOWN_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error occurred',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}