{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/regression/sectionsRls.regression.test.ts"],"sourcesContent":["/**\n * Sections RLS Regression Test\n * \n * This test prevents regression of the \"permission denied for table users\" bug\n * that occurred when creating sections with real authentication.\n * \n * Bug Description:\n * - Service methods were using service role client that bypassed RLS\n * - When called from API routes with real auth, RLS policies were enforced\n * - Sections table had RLS policies that referenced users table\n * - Real auth didn't have permission to query users table\n * - Result: \"permission denied for table users\" error\n * \n * This test validates:\n * - Sections can be created with real authentication (not service role)\n * - RLS policies work correctly with authenticated users\n * - No \"permission denied\" errors occur\n * \n * Validates: Requirements 5.4\n */\n\nimport { withTestDatabase, createAndSignInTestUser } from '../helpers/testDb';\nimport { createTestEvent, createTestSection } from '../helpers/factories';\nimport { cleanupTestSections, cleanupTestEvents } from '../helpers/cleanup';\nimport * as sectionsService from '@/services/sectionsService';\n\ndescribe('Sections RLS Regression Tests', () => {\n  afterEach(async () => {\n    // Clean up test data\n    await cleanupTestSections();\n    await cleanupTestEvents();\n  });\n  \n  it('should create section with real auth without permission denied error', async () => {\n    await withTestDatabase(async (db) => {\n      // Create authenticated user (not service role!)\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create a test event first\n      const event = createTestEvent();\n      const { data: createdEvent, error: eventError } = await client\n        .from('events')\n        .insert(event)\n        .select()\n        .single();\n      \n      expect(eventError).toBeNull();\n      expect(createdEvent).toBeDefined();\n      \n      // Create section with real authentication\n      const sectionData = {\n        entityType: 'event' as const,\n        entityId: createdEvent.id,\n        position: 0,\n      };\n      \n      const result = await sectionsService.create(sectionData);\n      \n      // THIS IS THE KEY TEST - Would have caught the RLS bug!\n      // The bug caused: \"permission denied for table users\"\n      expect(result.success).toBe(true);\n      \n      if (result.success) {\n        expect(result.data).toBeDefined();\n        expect(result.data.entityType).toBe('event');\n        expect(result.data.entityId).toBe(createdEvent.id);\n      } else {\n        // If this fails, check the error message\n        console.error('Section creation failed:', result.error);\n        expect(result.error.message).not.toContain('permission denied');\n        expect(result.error.message).not.toContain('users');\n      }\n    });\n  });\n  \n  it('should update section with real auth without RLS errors', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create event and section\n      const event = createTestEvent();\n      const { data: createdEvent } = await client\n        .from('events')\n        .insert(event)\n        .select()\n        .single();\n      \n      const section = createTestSection({ entityId: createdEvent.id });\n      const { data: createdSection } = await client\n        .from('sections')\n        .insert(section)\n        .select()\n        .single();\n      \n      // Update section with real auth\n      const result = await sectionsService.update(createdSection.id, {\n        position: 1,\n      });\n      \n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.position).toBe(1);\n      }\n    });\n  });\n  \n  it('should delete section with real auth without RLS errors', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create event and section\n      const event = createTestEvent();\n      const { data: createdEvent } = await client\n        .from('events')\n        .insert(event)\n        .select()\n        .single();\n      \n      const section = createTestSection({ entityId: createdEvent.id });\n      const { data: createdSection } = await client\n        .from('sections')\n        .insert(section)\n        .select()\n        .single();\n      \n      // Delete section with real auth\n      const result = await sectionsService.deleteSection(createdSection.id);\n      \n      expect(result.success).toBe(true);\n    });\n  });\n  \n  it('should list sections with real auth without RLS errors', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create event and sections\n      const event = createTestEvent();\n      const { data: createdEvent } = await client\n        .from('events')\n        .insert(event)\n        .select()\n        .single();\n      \n      const sections = [\n        createTestSection({ entityId: createdEvent.id, position: 0 }),\n        createTestSection({ entityId: createdEvent.id, position: 1 }),\n      ];\n      \n      await client.from('sections').insert(sections);\n      \n      // List sections with real auth\n      const result = await sectionsService.list({\n        entityType: 'event',\n        entityId: createdEvent.id,\n      });\n      \n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.length).toBeGreaterThanOrEqual(2);\n      }\n    });\n  });\n  \n  it('should handle RLS policies correctly for different entity types', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Test with different entity types\n      const entityTypes = ['event', 'activity', 'accommodation', 'room_type', 'content_page'] as const;\n      \n      for (const entityType of entityTypes) {\n        const sectionData = {\n          entityType,\n          entityId: `test-${entityType}-id`,\n          position: 0,\n        };\n        \n        const result = await sectionsService.create(sectionData);\n        \n        // Should not fail with RLS errors\n        if (!result.success) {\n          expect(result.error.message).not.toContain('permission denied');\n          expect(result.error.message).not.toContain('users');\n        }\n      }\n    });\n  });\n});\n\n/**\n * Why This Test Would Have Caught the Bug:\n * \n * The sections RLS bug occurred because:\n * 1. Service methods used service role client (bypassed RLS)\n * 2. API routes used real auth (enforced RLS)\n * 3. RLS policies referenced users table\n * 4. Real auth didn't have permission to query users table\n * \n * This test explicitly:\n * - Uses real authentication (not service role)\n * - Calls service methods that interact with sections table\n * - Validates no \"permission denied\" errors occur\n * - Tests all CRUD operations with RLS enforcement\n * \n * If the RLS policies are misconfigured, this test will fail with the exact\n * error message that users would see, making it easy to diagnose and fix.\n */\n"],"names":["describe","afterEach","cleanupTestSections","cleanupTestEvents","it","withTestDatabase","db","client","user","createAuthenticatedClient","event","createTestEvent","data","createdEvent","error","eventError","from","insert","select","single","expect","toBeNull","toBeDefined","sectionData","entityType","entityId","id","position","result","sectionsService","create","success","toBe","console","message","not","toContain","section","createTestSection","createdSection","update","deleteSection","sections","list","length","toBeGreaterThanOrEqual","entityTypes"],"mappings":"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"}