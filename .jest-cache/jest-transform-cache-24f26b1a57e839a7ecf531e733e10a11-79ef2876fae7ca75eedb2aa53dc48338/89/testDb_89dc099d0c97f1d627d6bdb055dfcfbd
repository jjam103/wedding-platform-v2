9cf3f9fef74621efcde0b630fdeb0f0e
/**
 * Test Database Configuration
 * 
 * Provides Supabase client instances configured for testing.
 * Supports both authenticated (RLS-enforced) and service role (RLS-bypassed) clients.
 */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get TestDatabase () {
        return TestDatabase;
    },
    get createAndSignInTestUser () {
        return createAndSignInTestUser;
    },
    get createServiceClient () {
        return createServiceClient;
    },
    get createTestClient () {
        return createTestClient;
    },
    get createTestDatabase () {
        return createTestDatabase;
    },
    get createTestUser () {
        return createTestUser;
    },
    get deleteTestUser () {
        return deleteTestUser;
    },
    get retryDbOperation () {
        return retryDbOperation;
    },
    get signInTestUser () {
        return signInTestUser;
    },
    get waitForDb () {
        return waitForDb;
    },
    get withTestDatabase () {
        return withTestDatabase;
    }
});
const _supabasejs = require("@supabase/supabase-js");
/**
 * Get Supabase URL from environment
 */ function getSupabaseUrl() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    if (!url) {
        throw new Error('NEXT_PUBLIC_SUPABASE_URL is not set');
    }
    return url;
}
/**
 * Get Supabase anon key from environment
 */ function getSupabaseAnonKey() {
    const key = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
    if (!key) {
        throw new Error('NEXT_PUBLIC_SUPABASE_ANON_KEY is not set');
    }
    return key;
}
/**
 * Get Supabase service role key from environment
 */ function getSupabaseServiceKey() {
    const key = process.env.SUPABASE_SERVICE_ROLE_KEY;
    if (!key) {
        throw new Error('SUPABASE_SERVICE_ROLE_KEY is not set');
    }
    return key;
}
function createTestClient(accessToken) {
    const client = (0, _supabasejs.createClient)(getSupabaseUrl(), getSupabaseAnonKey(), {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    });
    // If access token provided, set it for authenticated requests
    if (accessToken) {
        client.auth.setSession({
            access_token: accessToken,
            refresh_token: ''
        });
    }
    return client;
}
function createServiceClient() {
    return (0, _supabasejs.createClient)(getSupabaseUrl(), getSupabaseServiceKey(), {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    });
}
async function createTestUser(email = `test.${Date.now()}@example.com`, password = 'test123456') {
    const serviceClient = createServiceClient();
    // Create user with admin API
    const { data, error } = await serviceClient.auth.admin.createUser({
        email,
        password,
        email_confirm: true
    });
    if (error) {
        throw new Error(`Failed to create test user: ${error.message}`);
    }
    if (!data.user) {
        throw new Error('User creation succeeded but no user returned');
    }
    return {
        email,
        password,
        id: data.user.id
    };
}
async function signInTestUser(email, password) {
    const client = createTestClient();
    const { data, error } = await client.auth.signInWithPassword({
        email,
        password
    });
    if (error) {
        throw new Error(`Failed to sign in test user: ${error.message}`);
    }
    if (!data.session) {
        throw new Error('Sign in succeeded but no session returned');
    }
    return {
        email,
        password,
        id: data.user.id,
        accessToken: data.session.access_token
    };
}
async function deleteTestUser(userId) {
    const serviceClient = createServiceClient();
    const { error } = await serviceClient.auth.admin.deleteUser(userId);
    if (error) {
        console.error(`Failed to delete test user ${userId}:`, error);
    }
}
async function createAndSignInTestUser() {
    const email = `test.${Date.now()}@example.com`;
    const password = 'test123456';
    await createTestUser(email, password);
    return signInTestUser(email, password);
}
class TestDatabase {
    constructor(){
        this.createdUsers = [];
        this.serviceClient = createServiceClient();
        this.testClient = createTestClient();
    }
    /**
   * Get service client (bypasses RLS)
   */ getServiceClient() {
        return this.serviceClient;
    }
    /**
   * Get test client (respects RLS)
   */ getTestClient() {
        return this.testClient;
    }
    /**
   * Create an authenticated test client
   */ async createAuthenticatedClient() {
        const user = await createAndSignInTestUser();
        this.createdUsers.push(user.id);
        const client = createTestClient(user.accessToken);
        return {
            client,
            user
        };
    }
    /**
   * Clean up all test data and users
   */ async cleanup() {
        // Delete created users
        for (const userId of this.createdUsers){
            await deleteTestUser(userId);
        }
        this.createdUsers = [];
    }
}
function createTestDatabase() {
    return new TestDatabase();
}
async function withTestDatabase(fn) {
    const db = createTestDatabase();
    try {
        return await fn(db);
    } finally{
        await db.cleanup();
    }
}
async function waitForDb(ms = 100) {
    return new Promise((resolve)=>setTimeout(resolve, ms));
}
async function retryDbOperation(operation, maxRetries = 3, baseDelay = 100) {
    let lastError = null;
    for(let i = 0; i < maxRetries; i++){
        try {
            return await operation();
        } catch (error) {
            lastError = error instanceof Error ? error : new Error(String(error));
            if (i < maxRetries - 1) {
                const delay = baseDelay * Math.pow(2, i);
                await waitForDb(delay);
            }
        }
    }
    throw lastError || new Error('Operation failed after retries');
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9qYXJvbi9EZXNrdG9wL3dlZGRpbmctcGxhdGZvcm0tdjIvX190ZXN0c19fL2hlbHBlcnMvdGVzdERiLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVGVzdCBEYXRhYmFzZSBDb25maWd1cmF0aW9uXG4gKiBcbiAqIFByb3ZpZGVzIFN1cGFiYXNlIGNsaWVudCBpbnN0YW5jZXMgY29uZmlndXJlZCBmb3IgdGVzdGluZy5cbiAqIFN1cHBvcnRzIGJvdGggYXV0aGVudGljYXRlZCAoUkxTLWVuZm9yY2VkKSBhbmQgc2VydmljZSByb2xlIChSTFMtYnlwYXNzZWQpIGNsaWVudHMuXG4gKi9cblxuaW1wb3J0IHsgY3JlYXRlQ2xpZW50LCBTdXBhYmFzZUNsaWVudCB9IGZyb20gJ0BzdXBhYmFzZS9zdXBhYmFzZS1qcyc7XG5cbi8qKlxuICogR2V0IFN1cGFiYXNlIFVSTCBmcm9tIGVudmlyb25tZW50XG4gKi9cbmZ1bmN0aW9uIGdldFN1cGFiYXNlVXJsKCk6IHN0cmluZyB7XG4gIGNvbnN0IHVybCA9IHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTDtcbiAgaWYgKCF1cmwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05FWFRfUFVCTElDX1NVUEFCQVNFX1VSTCBpcyBub3Qgc2V0Jyk7XG4gIH1cbiAgcmV0dXJuIHVybDtcbn1cblxuLyoqXG4gKiBHZXQgU3VwYWJhc2UgYW5vbiBrZXkgZnJvbSBlbnZpcm9ubWVudFxuICovXG5mdW5jdGlvbiBnZXRTdXBhYmFzZUFub25LZXkoKTogc3RyaW5nIHtcbiAgY29uc3Qga2V5ID0gcHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfU1VQQUJBU0VfQU5PTl9LRVk7XG4gIGlmICgha2V5KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdORVhUX1BVQkxJQ19TVVBBQkFTRV9BTk9OX0tFWSBpcyBub3Qgc2V0Jyk7XG4gIH1cbiAgcmV0dXJuIGtleTtcbn1cblxuLyoqXG4gKiBHZXQgU3VwYWJhc2Ugc2VydmljZSByb2xlIGtleSBmcm9tIGVudmlyb25tZW50XG4gKi9cbmZ1bmN0aW9uIGdldFN1cGFiYXNlU2VydmljZUtleSgpOiBzdHJpbmcge1xuICBjb25zdCBrZXkgPSBwcm9jZXNzLmVudi5TVVBBQkFTRV9TRVJWSUNFX1JPTEVfS0VZO1xuICBpZiAoIWtleSkge1xuICAgIHRocm93IG5ldyBFcnJvcignU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWSBpcyBub3Qgc2V0Jyk7XG4gIH1cbiAgcmV0dXJuIGtleTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgYW4gYXV0aGVudGljYXRlZCBTdXBhYmFzZSBjbGllbnQgZm9yIHRlc3RpbmdcbiAqIFRoaXMgY2xpZW50IHJlc3BlY3RzIFJMUyBwb2xpY2llcyBhbmQgc2hvdWxkIGJlIHVzZWQgZm9yIG1vc3QgdGVzdHNcbiAqIFxuICogQHBhcmFtIGFjY2Vzc1Rva2VuIC0gT3B0aW9uYWwgYWNjZXNzIHRva2VuIGZvciBhdXRoZW50aWNhdGVkIHJlcXVlc3RzXG4gKiBAcmV0dXJucyBTdXBhYmFzZSBjbGllbnQgd2l0aCBSTFMgZW5mb3JjZW1lbnRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVRlc3RDbGllbnQoYWNjZXNzVG9rZW4/OiBzdHJpbmcpOiBTdXBhYmFzZUNsaWVudCB7XG4gIGNvbnN0IGNsaWVudCA9IGNyZWF0ZUNsaWVudChnZXRTdXBhYmFzZVVybCgpLCBnZXRTdXBhYmFzZUFub25LZXkoKSwge1xuICAgIGF1dGg6IHtcbiAgICAgIGF1dG9SZWZyZXNoVG9rZW46IGZhbHNlLFxuICAgICAgcGVyc2lzdFNlc3Npb246IGZhbHNlLFxuICAgIH0sXG4gIH0pO1xuICBcbiAgLy8gSWYgYWNjZXNzIHRva2VuIHByb3ZpZGVkLCBzZXQgaXQgZm9yIGF1dGhlbnRpY2F0ZWQgcmVxdWVzdHNcbiAgaWYgKGFjY2Vzc1Rva2VuKSB7XG4gICAgY2xpZW50LmF1dGguc2V0U2Vzc2lvbih7XG4gICAgICBhY2Nlc3NfdG9rZW46IGFjY2Vzc1Rva2VuLFxuICAgICAgcmVmcmVzaF90b2tlbjogJycsXG4gICAgfSk7XG4gIH1cbiAgXG4gIHJldHVybiBjbGllbnQ7XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgc2VydmljZSByb2xlIFN1cGFiYXNlIGNsaWVudCBmb3IgdGVzdGluZ1xuICogVGhpcyBjbGllbnQgYnlwYXNzZXMgUkxTIHBvbGljaWVzIGFuZCBzaG91bGQgT05MWSBiZSB1c2VkIGZvcjpcbiAqIC0gVGVzdCBzZXR1cCAoY3JlYXRpbmcgdGVzdCBkYXRhKVxuICogLSBUZXN0IGNsZWFudXAgKGRlbGV0aW5nIHRlc3QgZGF0YSlcbiAqIC0gVGVzdGluZyBzZXJ2aWNlLWxldmVsIGxvZ2ljIHRoYXQgZG9lc24ndCBpbnZvbHZlIFJMU1xuICogXG4gKiBXQVJOSU5HOiBOZXZlciB1c2UgdGhpcyBmb3IgdGVzdGluZyBSTFMgcG9saWNpZXMhXG4gKiBcbiAqIEByZXR1cm5zIFN1cGFiYXNlIGNsaWVudCB3aXRoIFJMUyBieXBhc3NcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVNlcnZpY2VDbGllbnQoKTogU3VwYWJhc2VDbGllbnQge1xuICByZXR1cm4gY3JlYXRlQ2xpZW50KGdldFN1cGFiYXNlVXJsKCksIGdldFN1cGFiYXNlU2VydmljZUtleSgpLCB7XG4gICAgYXV0aDoge1xuICAgICAgYXV0b1JlZnJlc2hUb2tlbjogZmFsc2UsXG4gICAgICBwZXJzaXN0U2Vzc2lvbjogZmFsc2UsXG4gICAgfSxcbiAgfSk7XG59XG5cbi8qKlxuICogVGVzdCB1c2VyIGNyZWRlbnRpYWxzIGZvciBhdXRoZW50aWNhdGlvbiB0ZXN0c1xuICovXG5leHBvcnQgaW50ZXJmYWNlIFRlc3RVc2VyIHtcbiAgZW1haWw6IHN0cmluZztcbiAgcGFzc3dvcmQ6IHN0cmluZztcbiAgaWQ/OiBzdHJpbmc7XG4gIGFjY2Vzc1Rva2VuPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhIHRlc3QgdXNlciBpbiB0aGUgZGF0YWJhc2VcbiAqIFVzZXMgc2VydmljZSByb2xlIHRvIGJ5cGFzcyBSTFMgZm9yIHVzZXIgY3JlYXRpb25cbiAqIFxuICogQHBhcmFtIGVtYWlsIC0gVXNlciBlbWFpbFxuICogQHBhcmFtIHBhc3N3b3JkIC0gVXNlciBwYXNzd29yZFxuICogQHJldHVybnMgVGVzdCB1c2VyIHdpdGggY3JlZGVudGlhbHNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRlc3RVc2VyKFxuICBlbWFpbDogc3RyaW5nID0gYHRlc3QuJHtEYXRlLm5vdygpfUBleGFtcGxlLmNvbWAsXG4gIHBhc3N3b3JkOiBzdHJpbmcgPSAndGVzdDEyMzQ1Nidcbik6IFByb21pc2U8VGVzdFVzZXI+IHtcbiAgY29uc3Qgc2VydmljZUNsaWVudCA9IGNyZWF0ZVNlcnZpY2VDbGllbnQoKTtcbiAgXG4gIC8vIENyZWF0ZSB1c2VyIHdpdGggYWRtaW4gQVBJXG4gIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHNlcnZpY2VDbGllbnQuYXV0aC5hZG1pbi5jcmVhdGVVc2VyKHtcbiAgICBlbWFpbCxcbiAgICBwYXNzd29yZCxcbiAgICBlbWFpbF9jb25maXJtOiB0cnVlLCAvLyBBdXRvLWNvbmZpcm0gZW1haWwgZm9yIHRlc3RpbmdcbiAgfSk7XG4gIFxuICBpZiAoZXJyb3IpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBjcmVhdGUgdGVzdCB1c2VyOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gIH1cbiAgXG4gIGlmICghZGF0YS51c2VyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIGNyZWF0aW9uIHN1Y2NlZWRlZCBidXQgbm8gdXNlciByZXR1cm5lZCcpO1xuICB9XG4gIFxuICByZXR1cm4ge1xuICAgIGVtYWlsLFxuICAgIHBhc3N3b3JkLFxuICAgIGlkOiBkYXRhLnVzZXIuaWQsXG4gIH07XG59XG5cbi8qKlxuICogU2lnbiBpbiBhIHRlc3QgdXNlciBhbmQgZ2V0IGFjY2VzcyB0b2tlblxuICogXG4gKiBAcGFyYW0gZW1haWwgLSBVc2VyIGVtYWlsXG4gKiBAcGFyYW0gcGFzc3dvcmQgLSBVc2VyIHBhc3N3b3JkXG4gKiBAcmV0dXJucyBUZXN0IHVzZXIgd2l0aCBhY2Nlc3MgdG9rZW5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNpZ25JblRlc3RVc2VyKFxuICBlbWFpbDogc3RyaW5nLFxuICBwYXNzd29yZDogc3RyaW5nXG4pOiBQcm9taXNlPFRlc3RVc2VyPiB7XG4gIGNvbnN0IGNsaWVudCA9IGNyZWF0ZVRlc3RDbGllbnQoKTtcbiAgXG4gIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IGNsaWVudC5hdXRoLnNpZ25JbldpdGhQYXNzd29yZCh7XG4gICAgZW1haWwsXG4gICAgcGFzc3dvcmQsXG4gIH0pO1xuICBcbiAgaWYgKGVycm9yKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gc2lnbiBpbiB0ZXN0IHVzZXI6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgfVxuICBcbiAgaWYgKCFkYXRhLnNlc3Npb24pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1NpZ24gaW4gc3VjY2VlZGVkIGJ1dCBubyBzZXNzaW9uIHJldHVybmVkJyk7XG4gIH1cbiAgXG4gIHJldHVybiB7XG4gICAgZW1haWwsXG4gICAgcGFzc3dvcmQsXG4gICAgaWQ6IGRhdGEudXNlci5pZCxcbiAgICBhY2Nlc3NUb2tlbjogZGF0YS5zZXNzaW9uLmFjY2Vzc190b2tlbixcbiAgfTtcbn1cblxuLyoqXG4gKiBEZWxldGUgYSB0ZXN0IHVzZXIgZnJvbSB0aGUgZGF0YWJhc2VcbiAqIFVzZXMgc2VydmljZSByb2xlIHRvIGJ5cGFzcyBSTFMgZm9yIHVzZXIgZGVsZXRpb25cbiAqIFxuICogQHBhcmFtIHVzZXJJZCAtIFVzZXIgSUQgdG8gZGVsZXRlXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVUZXN0VXNlcih1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCBzZXJ2aWNlQ2xpZW50ID0gY3JlYXRlU2VydmljZUNsaWVudCgpO1xuICBcbiAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc2VydmljZUNsaWVudC5hdXRoLmFkbWluLmRlbGV0ZVVzZXIodXNlcklkKTtcbiAgXG4gIGlmIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBkZWxldGUgdGVzdCB1c2VyICR7dXNlcklkfTpgLCBlcnJvcik7XG4gIH1cbn1cblxuLyoqXG4gKiBDcmVhdGUgYW5kIHNpZ24gaW4gYSB0ZXN0IHVzZXIgaW4gb25lIHN0ZXBcbiAqIFVzZWZ1bCBmb3IgdGVzdHMgdGhhdCBuZWVkIGFuIGF1dGhlbnRpY2F0ZWQgdXNlclxuICogXG4gKiBAcmV0dXJucyBUZXN0IHVzZXIgd2l0aCBhY2Nlc3MgdG9rZW5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUFuZFNpZ25JblRlc3RVc2VyKCk6IFByb21pc2U8VGVzdFVzZXI+IHtcbiAgY29uc3QgZW1haWwgPSBgdGVzdC4ke0RhdGUubm93KCl9QGV4YW1wbGUuY29tYDtcbiAgY29uc3QgcGFzc3dvcmQgPSAndGVzdDEyMzQ1Nic7XG4gIFxuICBhd2FpdCBjcmVhdGVUZXN0VXNlcihlbWFpbCwgcGFzc3dvcmQpO1xuICByZXR1cm4gc2lnbkluVGVzdFVzZXIoZW1haWwsIHBhc3N3b3JkKTtcbn1cblxuLyoqXG4gKiBUZXN0IGRhdGFiYXNlIGhlbHBlciBjbGFzcyBmb3IgbWFuYWdpbmcgdGVzdCBkYXRhIGxpZmVjeWNsZVxuICovXG5leHBvcnQgY2xhc3MgVGVzdERhdGFiYXNlIHtcbiAgcHJpdmF0ZSBzZXJ2aWNlQ2xpZW50OiBTdXBhYmFzZUNsaWVudDtcbiAgcHJpdmF0ZSB0ZXN0Q2xpZW50OiBTdXBhYmFzZUNsaWVudDtcbiAgcHJpdmF0ZSBjcmVhdGVkVXNlcnM6IHN0cmluZ1tdID0gW107XG4gIFxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLnNlcnZpY2VDbGllbnQgPSBjcmVhdGVTZXJ2aWNlQ2xpZW50KCk7XG4gICAgdGhpcy50ZXN0Q2xpZW50ID0gY3JlYXRlVGVzdENsaWVudCgpO1xuICB9XG4gIFxuICAvKipcbiAgICogR2V0IHNlcnZpY2UgY2xpZW50IChieXBhc3NlcyBSTFMpXG4gICAqL1xuICBnZXRTZXJ2aWNlQ2xpZW50KCk6IFN1cGFiYXNlQ2xpZW50IHtcbiAgICByZXR1cm4gdGhpcy5zZXJ2aWNlQ2xpZW50O1xuICB9XG4gIFxuICAvKipcbiAgICogR2V0IHRlc3QgY2xpZW50IChyZXNwZWN0cyBSTFMpXG4gICAqL1xuICBnZXRUZXN0Q2xpZW50KCk6IFN1cGFiYXNlQ2xpZW50IHtcbiAgICByZXR1cm4gdGhpcy50ZXN0Q2xpZW50O1xuICB9XG4gIFxuICAvKipcbiAgICogQ3JlYXRlIGFuIGF1dGhlbnRpY2F0ZWQgdGVzdCBjbGllbnRcbiAgICovXG4gIGFzeW5jIGNyZWF0ZUF1dGhlbnRpY2F0ZWRDbGllbnQoKTogUHJvbWlzZTx7IGNsaWVudDogU3VwYWJhc2VDbGllbnQ7IHVzZXI6IFRlc3RVc2VyIH0+IHtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgY3JlYXRlQW5kU2lnbkluVGVzdFVzZXIoKTtcbiAgICB0aGlzLmNyZWF0ZWRVc2Vycy5wdXNoKHVzZXIuaWQhKTtcbiAgICBcbiAgICBjb25zdCBjbGllbnQgPSBjcmVhdGVUZXN0Q2xpZW50KHVzZXIuYWNjZXNzVG9rZW4pO1xuICAgIFxuICAgIHJldHVybiB7IGNsaWVudCwgdXNlciB9O1xuICB9XG4gIFxuICAvKipcbiAgICogQ2xlYW4gdXAgYWxsIHRlc3QgZGF0YSBhbmQgdXNlcnNcbiAgICovXG4gIGFzeW5jIGNsZWFudXAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gRGVsZXRlIGNyZWF0ZWQgdXNlcnNcbiAgICBmb3IgKGNvbnN0IHVzZXJJZCBvZiB0aGlzLmNyZWF0ZWRVc2Vycykge1xuICAgICAgYXdhaXQgZGVsZXRlVGVzdFVzZXIodXNlcklkKTtcbiAgICB9XG4gICAgXG4gICAgdGhpcy5jcmVhdGVkVXNlcnMgPSBbXTtcbiAgfVxufVxuXG4vKipcbiAqIENyZWF0ZSBhIHRlc3QgZGF0YWJhc2UgaW5zdGFuY2VcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVRlc3REYXRhYmFzZSgpOiBUZXN0RGF0YWJhc2Uge1xuICByZXR1cm4gbmV3IFRlc3REYXRhYmFzZSgpO1xufVxuXG4vKipcbiAqIEhlbHBlciB0byBydW4gYSB0ZXN0IHdpdGggYXV0b21hdGljIGRhdGFiYXNlIGNsZWFudXBcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdpdGhUZXN0RGF0YWJhc2U8VD4oXG4gIGZuOiAoZGI6IFRlc3REYXRhYmFzZSkgPT4gUHJvbWlzZTxUPlxuKTogUHJvbWlzZTxUPiB7XG4gIGNvbnN0IGRiID0gY3JlYXRlVGVzdERhdGFiYXNlKCk7XG4gIFxuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBmbihkYik7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZGIuY2xlYW51cCgpO1xuICB9XG59XG5cbi8qKlxuICogV2FpdCBmb3IgZGF0YWJhc2Ugb3BlcmF0aW9uIHRvIGNvbXBsZXRlXG4gKiBVc2VmdWwgZm9yIHRlc3RzIHRoYXQgbmVlZCB0byB3YWl0IGZvciBhc3luYyBvcGVyYXRpb25zXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3YWl0Rm9yRGIobXM6IG51bWJlciA9IDEwMCk6IFByb21pc2U8dm9pZD4ge1xuICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7XG59XG5cbi8qKlxuICogUmV0cnkgYSBkYXRhYmFzZSBvcGVyYXRpb24gd2l0aCBleHBvbmVudGlhbCBiYWNrb2ZmXG4gKiBVc2VmdWwgZm9yIGhhbmRsaW5nIHRyYW5zaWVudCBkYXRhYmFzZSBlcnJvcnNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJldHJ5RGJPcGVyYXRpb248VD4oXG4gIG9wZXJhdGlvbjogKCkgPT4gUHJvbWlzZTxUPixcbiAgbWF4UmV0cmllczogbnVtYmVyID0gMyxcbiAgYmFzZURlbGF5OiBudW1iZXIgPSAxMDBcbik6IFByb21pc2U8VD4ge1xuICBsZXQgbGFzdEVycm9yOiBFcnJvciB8IG51bGwgPSBudWxsO1xuICBcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXhSZXRyaWVzOyBpKyspIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IG9wZXJhdGlvbigpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsYXN0RXJyb3IgPSBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiBuZXcgRXJyb3IoU3RyaW5nKGVycm9yKSk7XG4gICAgICBcbiAgICAgIGlmIChpIDwgbWF4UmV0cmllcyAtIDEpIHtcbiAgICAgICAgY29uc3QgZGVsYXkgPSBiYXNlRGVsYXkgKiBNYXRoLnBvdygyLCBpKTtcbiAgICAgICAgYXdhaXQgd2FpdEZvckRiKGRlbGF5KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgXG4gIHRocm93IGxhc3RFcnJvciB8fCBuZXcgRXJyb3IoJ09wZXJhdGlvbiBmYWlsZWQgYWZ0ZXIgcmV0cmllcycpO1xufVxuIl0sIm5hbWVzIjpbIlRlc3REYXRhYmFzZSIsImNyZWF0ZUFuZFNpZ25JblRlc3RVc2VyIiwiY3JlYXRlU2VydmljZUNsaWVudCIsImNyZWF0ZVRlc3RDbGllbnQiLCJjcmVhdGVUZXN0RGF0YWJhc2UiLCJjcmVhdGVUZXN0VXNlciIsImRlbGV0ZVRlc3RVc2VyIiwicmV0cnlEYk9wZXJhdGlvbiIsInNpZ25JblRlc3RVc2VyIiwid2FpdEZvckRiIiwid2l0aFRlc3REYXRhYmFzZSIsImdldFN1cGFiYXNlVXJsIiwidXJsIiwicHJvY2VzcyIsImVudiIsIk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTCIsIkVycm9yIiwiZ2V0U3VwYWJhc2VBbm9uS2V5Iiwia2V5IiwiTkVYVF9QVUJMSUNfU1VQQUJBU0VfQU5PTl9LRVkiLCJnZXRTdXBhYmFzZVNlcnZpY2VLZXkiLCJTVVBBQkFTRV9TRVJWSUNFX1JPTEVfS0VZIiwiYWNjZXNzVG9rZW4iLCJjbGllbnQiLCJjcmVhdGVDbGllbnQiLCJhdXRoIiwiYXV0b1JlZnJlc2hUb2tlbiIsInBlcnNpc3RTZXNzaW9uIiwic2V0U2Vzc2lvbiIsImFjY2Vzc190b2tlbiIsInJlZnJlc2hfdG9rZW4iLCJlbWFpbCIsIkRhdGUiLCJub3ciLCJwYXNzd29yZCIsInNlcnZpY2VDbGllbnQiLCJkYXRhIiwiZXJyb3IiLCJhZG1pbiIsImNyZWF0ZVVzZXIiLCJlbWFpbF9jb25maXJtIiwibWVzc2FnZSIsInVzZXIiLCJpZCIsInNpZ25JbldpdGhQYXNzd29yZCIsInNlc3Npb24iLCJ1c2VySWQiLCJkZWxldGVVc2VyIiwiY29uc29sZSIsImNyZWF0ZWRVc2VycyIsInRlc3RDbGllbnQiLCJnZXRTZXJ2aWNlQ2xpZW50IiwiZ2V0VGVzdENsaWVudCIsImNyZWF0ZUF1dGhlbnRpY2F0ZWRDbGllbnQiLCJwdXNoIiwiY2xlYW51cCIsImZuIiwiZGIiLCJtcyIsIlByb21pc2UiLCJyZXNvbHZlIiwic2V0VGltZW91dCIsIm9wZXJhdGlvbiIsIm1heFJldHJpZXMiLCJiYXNlRGVsYXkiLCJsYXN0RXJyb3IiLCJpIiwiU3RyaW5nIiwiZGVsYXkiLCJNYXRoIiwicG93Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Q0FLQzs7Ozs7Ozs7Ozs7UUFvTVlBO2VBQUFBOztRQVhTQztlQUFBQTs7UUEvR05DO2VBQUFBOztRQTlCQUM7ZUFBQUE7O1FBNE1BQztlQUFBQTs7UUFuSk1DO2VBQUFBOztRQW9FQUM7ZUFBQUE7O1FBOEdBQztlQUFBQTs7UUEvSUFDO2VBQUFBOztRQXVJQUM7ZUFBQUE7O1FBaEJBQztlQUFBQTs7OzRCQTdQdUI7QUFFN0M7O0NBRUMsR0FDRCxTQUFTQztJQUNQLE1BQU1DLE1BQU1DLFFBQVFDLEdBQUcsQ0FBQ0Msd0JBQXdCO0lBQ2hELElBQUksQ0FBQ0gsS0FBSztRQUNSLE1BQU0sSUFBSUksTUFBTTtJQUNsQjtJQUNBLE9BQU9KO0FBQ1Q7QUFFQTs7Q0FFQyxHQUNELFNBQVNL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