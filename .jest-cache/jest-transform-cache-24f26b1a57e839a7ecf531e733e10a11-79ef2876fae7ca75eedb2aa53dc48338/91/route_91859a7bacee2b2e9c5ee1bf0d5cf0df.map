{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/settings/auth-method/route.ts"],"sourcesContent":["import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\nimport { z } from 'zod';\nimport * as settingsService from '@/services/settingsService';\n\n// Request validation schema\nconst updateAuthMethodSchema = z.object({\n  defaultAuthMethod: z.enum(['email_matching', 'magic_link']),\n  updateExistingGuests: z.boolean().optional().default(false),\n});\n\n/**\n * GET /api/admin/settings/auth-method\n * \n * Get the current default authentication method\n */\nexport async function GET(request: Request) {\n  try {\n    // 1. Auth check\n    const supabase = createRouteHandlerClient({ cookies });\n    const {\n      data: { session },\n      error: authError,\n    } = await supabase.auth.getSession();\n\n    if (authError || !session) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: { code: 'UNAUTHORIZED', message: 'Authentication required' },\n        },\n        { status: 401 }\n      );\n    }\n\n    // 2. Get default auth method\n    const result = await settingsService.getDefaultAuthMethod();\n\n    if (!result.success) {\n      const statusCode = result.error.code === 'NOT_FOUND' ? 404 : 500;\n      return NextResponse.json(result, { status: statusCode });\n    }\n\n    // 3. Return response\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          defaultAuthMethod: result.data,\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('Get auth method error:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'INTERNAL_ERROR',\n          message: 'Failed to get authentication method',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * PUT /api/admin/settings/auth-method\n * \n * Update the default authentication method\n * Optionally update all existing guests\n */\nexport async function PUT(request: Request) {\n  try {\n    // 1. Auth check\n    const supabase = createRouteHandlerClient({ cookies });\n    const {\n      data: { session },\n      error: authError,\n    } = await supabase.auth.getSession();\n\n    if (authError || !session) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: { code: 'UNAUTHORIZED', message: 'Authentication required' },\n        },\n        { status: 401 }\n      );\n    }\n\n    // 2. Parse and validate request body\n    const body = await request.json();\n    const validation = updateAuthMethodSchema.safeParse(body);\n\n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid request data',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    const { defaultAuthMethod, updateExistingGuests } = validation.data;\n\n    // 3. Update auth method\n    const result = await settingsService.updateDefaultAuthMethod(\n      defaultAuthMethod,\n      updateExistingGuests\n    );\n\n    if (!result.success) {\n      const statusCode =\n        result.error.code === 'VALIDATION_ERROR'\n          ? 400\n          : result.error.code === 'DATABASE_ERROR'\n          ? 500\n          : 500;\n      return NextResponse.json(result, { status: statusCode });\n    }\n\n    // 4. Return response\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          defaultAuthMethod,\n          updatedGuestsCount: result.data.updatedGuestsCount,\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('Update auth method error:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'INTERNAL_ERROR',\n          message: 'Failed to update authentication method',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["GET","PUT","updateAuthMethodSchema","z","object","defaultAuthMethod","enum","updateExistingGuests","boolean","optional","default","request","supabase","createRouteHandlerClient","cookies","data","session","error","authError","auth","getSession","NextResponse","json","success","code","message","status","result","settingsService","getDefaultAuthMethod","statusCode","console","body","validation","safeParse","details","issues","updateDefaultAuthMethod","updatedGuestsCount"],"mappings":";;;;;;;;;;;QAiBsBA;eAAAA;;QA0DAC;eAAAA;;;mCA3EmB;yBACjB;wBACK;qBACX;yEACe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEjC,4BAA4B;AAC5B,MAAMC,yBAAyBC,MAAC,CAACC,MAAM,CAAC;IACtCC,mBAAmBF,MAAC,CAACG,IAAI,CAAC;QAAC;QAAkB;KAAa;IAC1DC,sBAAsBJ,MAAC,CAACK,OAAO,GAAGC,QAAQ,GAAGC,OAAO,CAAC;AACvD;AAOO,eAAeV,IAAIW,OAAgB;IACxC,IAAI;QACF,gBAAgB;QAChB,MAAMC,WAAWC,IAAAA,2CAAwB,EAAC;YAAEC,SAAAA,gBAAO;QAAC;QACpD,MAAM,EACJC,MAAM,EAAEC,OAAO,EAAE,EACjBC,OAAOC,SAAS,EACjB,GAAG,MAAMN,SAASO,IAAI,CAACC,UAAU;QAElC,IAAIF,aAAa,CAACF,SAAS;YACzB,OAAOK,oBAAY,CAACC,IAAI,CACtB;gBACEC,SAAS;gBACTN,OAAO;oBAAEO,MAAM;oBAAgBC,SAAS;gBAA0B;YACpE,GACA;gBAAEC,QAAQ;YAAI;QAElB;QAEA,6BAA6B;QAC7B,MAAMC,SAAS,MAAMC,iBAAgBC,oBAAoB;QAEzD,IAAI,CAACF,OAAOJ,OAAO,EAAE;YACnB,MAAMO,aAAaH,OAAOV,KAAK,CAACO,IAAI,KAAK,cAAc,MAAM;YAC7D,OAAOH,oBAAY,CAACC,IAAI,CAACK,QAAQ;gBAAED,QAAQI;YAAW;QACxD;QAEA,qBAAqB;QACrB,OAAOT,oBAAY,CAACC,IAAI,CACtB;YACEC,SAAS;YACTR,MAAM;gBACJV,mBAAmBsB,OAAOZ,IAAI;YAChC;QACF,GACA;YAAEW,QAAQ;QAAI;IAElB,EAAE,OAAOT,OAAO;QACdc,QAAQd,KAAK,CAAC,0BAA0BA;QACxC,OAAOI,oBAAY,CAACC,IAAI,CACtB;YACEC,SAAS;YACTN,OAAO;gBACLO,MAAM;gBACNC,SAAS;YACX;QACF,GACA;YAAEC,QAAQ;QAAI;IAElB;AACF;AAQO,eAAezB,IAAIU,OAAgB;IACxC,IAAI;QACF,gBAAgB;QAChB,MAAMC,WAAWC,IAAAA,2CAAwB,EAAC;YAAEC,SAAAA,gBAAO;QAAC;QACpD,MAAM,EACJC,MAAM,EAAEC,OAAO,EAAE,EACjBC,OAAOC,SAAS,EACjB,GAAG,MAAMN,SAASO,IAAI,CAACC,UAAU;QAElC,IAAIF,aAAa,CAACF,SAAS;YACzB,OAAOK,oBAAY,CAACC,IAAI,CACtB;gBACEC,SAAS;gBACTN,OAAO;oBAAEO,MAAM;oBAAgBC,SAAS;gBAA0B;YACpE,GACA;gBAAEC,QAAQ;YAAI;QAElB;QAEA,qCAAqC;QACrC,MAAMM,OAAO,MAAMrB,QAAQW,IAAI;QAC/B,MAAMW,aAAa/B,uBAAuBgC,SAAS,CAACF;QAEpD,IAAI,CAACC,WAAWV,OAAO,EAAE;YACvB,OAAOF,oBAAY,CAACC,IAAI,CACtB;gBACEC,SAAS;gBACTN,OAAO;oBACLO,MAAM;oBACNC,SAAS;oBACTU,SAASF,WAAWhB,KAAK,CAACmB,MAAM;gBAClC;YACF,GACA;gBAAEV,QAAQ;YAAI;QAElB;QAEA,MAAM,EAAErB,iBAAiB,EAAEE,oBAAoB,EAAE,GAAG0B,WAAWlB,IAAI;QAEnE,wBAAwB;QACxB,MAAMY,SAAS,MAAMC,iBAAgBS,uBAAuB,CAC1DhC,mBACAE;QAGF,IAAI,CAACoB,OAAOJ,OAAO,EAAE;YACnB,MAAMO,aACJH,OAAOV,KAAK,CAACO,IAAI,KAAK,qBAClB,MACAG,OAAOV,KAAK,CAACO,IAAI,KAAK,mBACtB,MACA;YACN,OAAOH,oBAAY,CAACC,IAAI,CAACK,QAAQ;gBAAED,QAAQI;YAAW;QACxD;QAEA,qBAAqB;QACrB,OAAOT,oBAAY,CAACC,IAAI,CACtB;YACEC,SAAS;YACTR,MAAM;gBACJV;gBACAiC,oBAAoBX,OAAOZ,IAAI,CAACuB,kBAAkB;YACpD;QACF,GACA;YAAEZ,QAAQ;QAAI;IAElB,EAAE,OAAOT,OAAO;QACdc,QAAQd,KAAK,CAAC,6BAA6BA;QAC3C,OAAOI,oBAAY,CAACC,IAAI,CACtB;YACEC,SAAS;YACTN,OAAO;gBACLO,MAAM;gBACNC,SAAS;YACX;QACF,GACA;YAAEC,QAAQ;QAAI;IAElB;AACF"}