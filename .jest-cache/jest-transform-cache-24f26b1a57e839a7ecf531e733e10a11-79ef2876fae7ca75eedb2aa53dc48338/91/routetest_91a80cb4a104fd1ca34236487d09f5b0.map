{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/guests/bulk-auth-method/route.test.ts"],"sourcesContent":["/**\n * Unit Tests: POST /api/admin/guests/bulk-auth-method\n * \n * Tests the API route for bulk updating guest auth methods\n * \n * Requirements: 22.7\n */\n\nimport { POST } from './route';\nimport { createAuthenticatedClient } from '@/lib/supabaseServer';\n\n// Mock Supabase\njest.mock('@/lib/supabaseServer');\n\ndescribe('POST /api/admin/guests/bulk-auth-method', () => {\n  const mockSupabase = {\n    auth: {\n      getSession: jest.fn(),\n    },\n    from: jest.fn(),\n  };\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (createAuthenticatedClient as jest.Mock).mockResolvedValue(mockSupabase);\n  });\n\n  it('should update multiple guests successfully', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: { user: { id: 'admin-123' } } },\n      error: null,\n    });\n\n    const mockUpdate = jest.fn().mockReturnValue({\n      in: jest.fn().mockReturnValue({\n        select: jest.fn().mockResolvedValue({\n          data: [\n            { id: 'guest-1', auth_method: 'magic_link', email: 'test1@example.com', first_name: 'Test', last_name: 'User1' },\n            { id: 'guest-2', auth_method: 'magic_link', email: 'test2@example.com', first_name: 'Test', last_name: 'User2' },\n          ],\n          error: null,\n        }),\n      }),\n    });\n\n    mockSupabase.from.mockReturnValue({\n      update: mockUpdate,\n    });\n\n    const request = new Request('http://localhost:3000/api/admin/guests/bulk-auth-method', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        guest_ids: ['guest-1', 'guest-2'],\n        auth_method: 'magic_link',\n      }),\n    });\n\n    const response = await POST(request);\n    const result = await response.json();\n\n    expect(response.status).toBe(200);\n    expect(result.success).toBe(true);\n    expect(result.data.updated_count).toBe(2);\n    expect(result.data.guests).toHaveLength(2);\n  });\n\n  it('should return 400 for empty guest_ids array', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: { user: { id: 'admin-123' } } },\n      error: null,\n    });\n\n    const request = new Request('http://localhost:3000/api/admin/guests/bulk-auth-method', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        guest_ids: [],\n        auth_method: 'magic_link',\n      }),\n    });\n\n    const response = await POST(request);\n    const result = await response.json();\n\n    expect(response.status).toBe(400);\n    expect(result.success).toBe(false);\n    expect(result.error.code).toBe('VALIDATION_ERROR');\n  });\n\n  it('should return 400 for too many guest IDs', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: { user: { id: 'admin-123' } } },\n      error: null,\n    });\n\n    const tooManyIds = Array.from({ length: 101 }, () => '00000000-0000-0000-0000-000000000000');\n\n    const request = new Request('http://localhost:3000/api/admin/guests/bulk-auth-method', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        guest_ids: tooManyIds,\n        auth_method: 'magic_link',\n      }),\n    });\n\n    const response = await POST(request);\n    const result = await response.json();\n\n    expect(response.status).toBe(400);\n    expect(result.success).toBe(false);\n    expect(result.error.code).toBe('VALIDATION_ERROR');\n  });\n\n  it('should return 400 for invalid guest ID format', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: { user: { id: 'admin-123' } } },\n      error: null,\n    });\n\n    const request = new Request('http://localhost:3000/api/admin/guests/bulk-auth-method', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        guest_ids: ['invalid-id', 'another-invalid'],\n        auth_method: 'magic_link',\n      }),\n    });\n\n    const response = await POST(request);\n    const result = await response.json();\n\n    expect(response.status).toBe(400);\n    expect(result.success).toBe(false);\n    expect(result.error.code).toBe('VALIDATION_ERROR');\n  });\n\n  it('should return 400 for invalid auth method', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: { user: { id: 'admin-123' } } },\n      error: null,\n    });\n\n    const request = new Request('http://localhost:3000/api/admin/guests/bulk-auth-method', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        guest_ids: ['00000000-0000-0000-0000-000000000000'],\n        auth_method: 'invalid_method',\n      }),\n    });\n\n    const response = await POST(request);\n    const result = await response.json();\n\n    expect(response.status).toBe(400);\n    expect(result.success).toBe(false);\n    expect(result.error.code).toBe('VALIDATION_ERROR');\n  });\n\n  it('should return 401 when not authenticated', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: null },\n      error: null,\n    });\n\n    const request = new Request('http://localhost:3000/api/admin/guests/bulk-auth-method', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        guest_ids: ['guest-1'],\n        auth_method: 'magic_link',\n      }),\n    });\n\n    const response = await POST(request);\n    const result = await response.json();\n\n    expect(response.status).toBe(401);\n    expect(result.success).toBe(false);\n    expect(result.error.code).toBe('UNAUTHORIZED');\n  });\n\n  it('should return 500 for database errors', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: { user: { id: 'admin-123' } } },\n      error: null,\n    });\n\n    const mockUpdate = jest.fn().mockReturnValue({\n      in: jest.fn().mockReturnValue({\n        select: jest.fn().mockResolvedValue({\n          data: null,\n          error: { code: 'DATABASE_ERROR', message: 'Database connection failed' },\n        }),\n      }),\n    });\n\n    mockSupabase.from.mockReturnValue({\n      update: mockUpdate,\n    });\n\n    const request = new Request('http://localhost:3000/api/admin/guests/bulk-auth-method', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        guest_ids: ['guest-1', 'guest-2'],\n        auth_method: 'magic_link',\n      }),\n    });\n\n    const response = await POST(request);\n    const result = await response.json();\n\n    expect(response.status).toBe(500);\n    expect(result.success).toBe(false);\n    expect(result.error.code).toBe('DATABASE_ERROR');\n  });\n\n  it('should handle send_notification flag', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: { user: { id: 'admin-123' } } },\n      error: null,\n    });\n\n    const mockUpdate = jest.fn().mockReturnValue({\n      in: jest.fn().mockReturnValue({\n        select: jest.fn().mockResolvedValue({\n          data: [\n            { id: 'guest-1', auth_method: 'magic_link', email: 'test1@example.com', first_name: 'Test', last_name: 'User1' },\n          ],\n          error: null,\n        }),\n      }),\n    });\n\n    mockSupabase.from.mockReturnValue({\n      update: mockUpdate,\n    });\n\n    const consoleSpy = jest.spyOn(console, 'log').mockImplementation();\n\n    const request = new Request('http://localhost:3000/api/admin/guests/bulk-auth-method', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        guest_ids: ['guest-1'],\n        auth_method: 'magic_link',\n        send_notification: true,\n      }),\n    });\n\n    const response = await POST(request);\n    const result = await response.json();\n\n    expect(response.status).toBe(200);\n    expect(result.success).toBe(true);\n    expect(consoleSpy).toHaveBeenCalledWith(\n      expect.stringContaining('Would send notifications to 1 guests')\n    );\n\n    consoleSpy.mockRestore();\n  });\n});\n"],"names":["jest","mock","describe","mockSupabase","auth","getSession","fn","from","beforeEach","clearAllMocks","createAuthenticatedClient","mockResolvedValue","it","data","session","user","id","error","mockUpdate","mockReturnValue","in","select","auth_method","email","first_name","last_name","update","request","Request","method","headers","body","JSON","stringify","guest_ids","response","POST","result","json","expect","status","toBe","success","updated_count","guests","toHaveLength","code","tooManyIds","Array","length","message","consoleSpy","spyOn","console","mockImplementation","send_notification","toHaveBeenCalledWith","stringContaining","mockRestore"],"mappings":"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"}