{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/rsvpAnalyticsService.test.ts"],"sourcesContent":["// Mock Supabase before importing the service\njest.mock('@supabase/supabase-js', () => {\n  const mockSupabase = {\n    from: jest.fn().mockReturnThis(),\n    select: jest.fn().mockReturnThis(),\n    eq: jest.fn().mockReturnThis(),\n    order: jest.fn().mockReturnThis(),\n    single: jest.fn(),\n    not: jest.fn().mockReturnThis(),\n    in: jest.fn().mockReturnThis(),\n  };\n  \n  return {\n    createClient: jest.fn(() => mockSupabase),\n  };\n});\n\nimport {\n  calculateResponseRate,\n  projectAttendance,\n  summarizeDietaryRestrictions,\n  getEventAnalytics,\n  getActivityAnalytics,\n} from './rsvpAnalyticsService';\n\ndescribe('rsvpAnalyticsService', () => {\n  let mockSupabase: any;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    \n    // Get the mock instance\n    const { createClient } = require('@supabase/supabase-js');\n    mockSupabase = createClient();\n  });\n\n  describe('calculateResponseRate', () => {\n    it('should return success with response rate statistics when RSVPs exist', async () => {\n      const mockRSVPs = [\n        { id: '1', guest_id: 'guest-1', status: 'attending' },\n        { id: '2', guest_id: 'guest-2', status: 'attending' },\n        { id: '3', guest_id: 'guest-3', status: 'declined' },\n        { id: '4', guest_id: 'guest-4', status: 'pending' },\n      ];\n\n      mockSupabase.eq.mockResolvedValue({\n        data: mockRSVPs,\n        error: null,\n      });\n\n      const result = await calculateResponseRate('event-1', 'event');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.total_invited).toBe(4);\n        expect(result.data.total_responded).toBe(3); // attending + declined\n        expect(result.data.total_pending).toBe(1);\n        expect(result.data.response_rate).toBe(75); // 3/4 * 100\n        expect(result.data.by_status.attending).toBe(2);\n        expect(result.data.by_status.declined).toBe(1);\n        expect(result.data.by_status.pending).toBe(1);\n      }\n    });\n\n    it('should return DATABASE_ERROR when query fails', async () => {\n      mockSupabase.eq.mockResolvedValue({\n        data: null,\n        error: { message: 'Connection failed' },\n      });\n\n      const result = await calculateResponseRate('event-1', 'event');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n  });\n\n  describe('projectAttendance', () => {\n    it('should return success with attendance projection when RSVPs exist', async () => {\n      const mockRSVPs = [\n        { status: 'attending', guest_count: 2 },\n        { status: 'attending', guest_count: 1 },\n        { status: 'maybe', guest_count: 2 },\n        { status: 'declined', guest_count: 1 },\n        { status: 'pending', guest_count: 1 },\n      ];\n\n      mockSupabase.eq.mockResolvedValue({\n        data: mockRSVPs,\n        error: null,\n      });\n\n      const result = await projectAttendance('activity-1', 'activity');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.confirmed_attending).toBe(3); // 2 + 1\n        expect(result.data.maybe_attending).toBe(2);\n        expect(result.data.projected_total).toBe(4); // 3 + (2 * 0.5)\n        expect(result.data.declined_count).toBe(1);\n        expect(result.data.pending_count).toBe(1);\n      }\n    });\n  });\n\n  describe('getEventAnalytics', () => {\n    it('should return success with comprehensive analytics when event exists', async () => {\n      // Mock data for the different queries that will be made\n      const mockRSVPs = [\n        { id: '1', guest_id: 'guest-1', status: 'attending', guest_count: 2 },\n        { id: '2', guest_id: 'guest-2', status: 'attending', guest_count: 1 },\n        { id: '3', guest_id: 'guest-3', status: 'declined', guest_count: 1 },\n        { id: '4', guest_id: 'guest-4', status: 'pending', guest_count: 1 },\n      ];\n\n      const mockGuests = [\n        { id: 'guest-1', guest_type: 'wedding_guest' },\n        { id: 'guest-2', guest_type: 'wedding_guest' },\n        { id: 'guest-3', guest_type: 'wedding_guest' },\n        { id: 'guest-4', guest_type: 'wedding_guest' },\n      ];\n\n      const mockDietaryRSVPs = [\n        { guest_id: 'guest-1', dietary_notes: 'Vegetarian' },\n      ];\n\n      const mockDietaryGuests = [\n        { id: 'guest-1', first_name: 'John', last_name: 'Doe', dietary_restrictions: 'vegetarian' },\n      ];\n\n      // Reset the mock before setting up new behavior\n      jest.clearAllMocks();\n\n      // Create a more sophisticated mock that can handle the complex query chains\n      let callIndex = 0;\n      \n      // Mock the from() method to track which table is being queried\n      mockSupabase.from.mockImplementation((table: string) => {\n        callIndex++;\n        \n        if (table === 'rsvps') {\n          // For RSVP queries, we need to handle different query patterns\n          const mockRsvpQuery = {\n            select: jest.fn().mockReturnThis(),\n            eq: jest.fn().mockReturnThis(),\n            not: jest.fn().mockReturnThis(),\n          };\n          \n          // Set up the select method\n          mockRsvpQuery.select.mockImplementation((fields: string) => {\n            if (fields === 'id, guest_id, status') {\n              // This is for calculateResponseRate - return simple query that resolves immediately\n              return {\n                eq: jest.fn().mockResolvedValue({ data: mockRSVPs, error: null })\n              };\n            } else if (fields === 'status, guest_count') {\n              // This is for projectAttendance - return simple query that resolves immediately\n              return {\n                eq: jest.fn().mockResolvedValue({ data: mockRSVPs, error: null })\n              };\n            } else if (fields === 'guest_id, dietary_notes') {\n              // This is for summarizeDietaryRestrictions - return chained query\n              return {\n                eq: jest.fn().mockImplementation((field: string, value: any) => {\n                  if (field === 'event_id') {\n                    return {\n                      eq: jest.fn().mockImplementation((field2: string, value2: any) => {\n                        if (field2 === 'status' && value2 === 'attending') {\n                          return {\n                            not: jest.fn().mockResolvedValue({ data: mockDietaryRSVPs, error: null })\n                          };\n                        }\n                        return mockRsvpQuery;\n                      })\n                    };\n                  }\n                  return mockRsvpQuery;\n                })\n              };\n            }\n            return mockRsvpQuery;\n          });\n          \n          return mockRsvpQuery;\n        } else if (table === 'guests') {\n          // For guest queries\n          const mockGuestQuery = {\n            select: jest.fn().mockReturnThis(),\n            in: jest.fn().mockReturnThis(),\n          };\n          \n          mockGuestQuery.select.mockImplementation((fields: string) => {\n            if (fields === 'id, guest_type') {\n              // This is for guest type breakdown in calculateResponseRate\n              return {\n                in: jest.fn().mockResolvedValue({ data: mockGuests, error: null })\n              };\n            } else if (fields === 'id, first_name, last_name, dietary_restrictions') {\n              // This is for dietary restrictions in summarizeDietaryRestrictions\n              return {\n                in: jest.fn().mockResolvedValue({ data: mockDietaryGuests, error: null })\n              };\n            }\n            return mockGuestQuery;\n          });\n          \n          return mockGuestQuery;\n        }\n        \n        return mockSupabase;\n      });\n\n      const result = await getEventAnalytics('event-1');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.response_rates).toBeDefined();\n        expect(result.data.attendance_projection).toBeDefined();\n        expect(result.data.dietary_summary).toBeDefined();\n        // Verify the structure of the returned data\n        expect(result.data.response_rates.total_invited).toBe(4);\n        expect(result.data.attendance_projection.confirmed_attending).toBe(3);\n        expect(result.data.dietary_summary.total_with_restrictions).toBe(1);\n        expect(result.data.dietary_summary.notes).toHaveLength(1);\n        expect(result.data.dietary_summary.notes[0].guest_name).toBe('John Doe');\n        expect(result.data.dietary_summary.restrictions.vegetarian).toBe(1);\n      }\n    });\n  });\n});"],"names":["jest","mock","mockSupabase","from","fn","mockReturnThis","select","eq","order","single","not","in","createClient","describe","beforeEach","clearAllMocks","require","it","mockRSVPs","id","guest_id","status","mockResolvedValue","data","error","result","calculateResponseRate","expect","success","toBe","total_invited","total_responded","total_pending","response_rate","by_status","attending","declined","pending","message","code","guest_count","projectAttendance","confirmed_attending","maybe_attending","projected_total","declined_count","pending_count","mockGuests","guest_type","mockDietaryRSVPs","dietary_notes","mockDietaryGuests","first_name","last_name","dietary_restrictions","callIndex","mockImplementation","table","mockRsvpQuery","fields","field","value","field2","value2","mockGuestQuery","getEventAnalytics","response_rates","toBeDefined","attendance_projection","dietary_summary","total_with_restrictions","notes","toHaveLength","guest_name","restrictions","vegetarian"],"mappings":"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"}