{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/lib/rateLimit.ts"],"sourcesContent":["/**\n * Rate limiting utilities for API endpoints and email sending\n */\n\n/**\n * Result type for consistent error handling\n */\ntype Result<T> =\n  | { success: true; data: T }\n  | { success: false; error: { code: string; message: string; details?: unknown } };\n\n/**\n * Rate limit check result\n */\nexport interface RateLimitResult {\n  allowed: boolean;\n  limit: number;\n  remaining: number;\n  reset: number; // Unix timestamp when the limit resets\n  retryAfter?: number; // Seconds until retry is allowed\n}\n\n/**\n * Rate limit configuration\n */\nexport interface RateLimitConfig {\n  maxRequests: number;\n  windowMs: number; // Time window in milliseconds\n}\n\n/**\n * In-memory store for rate limiting\n * In production, this should be replaced with Redis or similar\n */\nclass RateLimitStore {\n  private store: Map<string, { count: number; resetAt: number }> = new Map();\n\n  /**\n   * Gets the current count and reset time for an identifier\n   */\n  get(key: string): { count: number; resetAt: number } | null {\n    const entry = this.store.get(key);\n    if (!entry) return null;\n\n    // Check if the window has expired\n    if (Date.now() > entry.resetAt) {\n      this.store.delete(key);\n      return null;\n    }\n\n    return entry;\n  }\n\n  /**\n   * Increments the count for an identifier\n   */\n  increment(key: string, windowMs: number): { count: number; resetAt: number } {\n    const existing = this.get(key);\n\n    if (existing) {\n      existing.count++;\n      this.store.set(key, existing);\n      return existing;\n    }\n\n    const resetAt = Date.now() + windowMs;\n    const entry = { count: 1, resetAt };\n    this.store.set(key, entry);\n    return entry;\n  }\n\n  /**\n   * Clears expired entries (cleanup)\n   */\n  cleanup(): void {\n    const now = Date.now();\n    for (const [key, entry] of this.store.entries()) {\n      if (now > entry.resetAt) {\n        this.store.delete(key);\n      }\n    }\n  }\n}\n\n// Global store instance\nconst store = new RateLimitStore();\n\n// Run cleanup every 5 minutes\nif (typeof setInterval !== 'undefined') {\n  setInterval(() => store.cleanup(), 5 * 60 * 1000);\n}\n\n/**\n * Checks if a request is within rate limits.\n * \n * @param identifier - Unique identifier (user ID, IP address, etc.)\n * @param action - Action being rate limited (e.g., 'api:guests:create')\n * @param config - Rate limit configuration\n * @returns Rate limit check result\n * \n * @example\n * const result = await checkRateLimit('user-123', 'api:guests:create', {\n *   maxRequests: 10,\n *   windowMs: 60000, // 1 minute\n * });\n * \n * if (!result.allowed) {\n *   return Response with 429 status\n * }\n */\nexport function checkRateLimit(\n  identifier: string,\n  action: string,\n  config: RateLimitConfig\n): RateLimitResult {\n  const key = `${identifier}:${action}`;\n  const entry = store.increment(key, config.windowMs);\n\n  const allowed = entry.count <= config.maxRequests;\n  const remaining = Math.max(0, config.maxRequests - entry.count);\n  const reset = Math.floor(entry.resetAt / 1000); // Convert to seconds\n  const retryAfter = allowed ? undefined : Math.ceil((entry.resetAt - Date.now()) / 1000);\n\n  return {\n    allowed,\n    limit: config.maxRequests,\n    remaining,\n    reset,\n    retryAfter,\n  };\n}\n\n/**\n * Predefined rate limit configurations for common use cases\n */\nexport const RATE_LIMITS = {\n  // API endpoints\n  api: {\n    strict: { maxRequests: 10, windowMs: 60 * 1000 }, // 10 requests per minute\n    moderate: { maxRequests: 30, windowMs: 60 * 1000 }, // 30 requests per minute\n    relaxed: { maxRequests: 100, windowMs: 60 * 1000 }, // 100 requests per minute\n  },\n  // Email sending\n  email: {\n    perUser: { maxRequests: 10, windowMs: 60 * 60 * 1000 }, // 10 emails per hour per user\n    perRecipient: { maxRequests: 3, windowMs: 60 * 60 * 1000 }, // 3 emails per hour per recipient\n    bulk: { maxRequests: 100, windowMs: 60 * 60 * 1000 }, // 100 bulk emails per hour\n  },\n  // Authentication\n  auth: {\n    login: { maxRequests: 5, windowMs: 15 * 60 * 1000 }, // 5 login attempts per 15 minutes\n    passwordReset: { maxRequests: 3, windowMs: 60 * 60 * 1000 }, // 3 password resets per hour\n  },\n  // File uploads\n  upload: {\n    photos: { maxRequests: 20, windowMs: 60 * 60 * 1000 }, // 20 photo uploads per hour\n    documents: { maxRequests: 10, windowMs: 60 * 60 * 1000 }, // 10 document uploads per hour\n  },\n} as const;\n\n/**\n * Middleware helper for rate limiting API routes.\n * \n * @param identifier - Unique identifier (user ID, IP address, etc.)\n * @param action - Action being rate limited\n * @param config - Rate limit configuration\n * @returns Result indicating if request is allowed\n * \n * @example\n * const rateLimitResult = await rateLimitMiddleware(\n *   session.user.id,\n *   'api:guests:create',\n *   RATE_LIMITS.api.moderate\n * );\n * \n * if (!rateLimitResult.success) {\n *   return NextResponse.json(rateLimitResult, { status: 429 });\n * }\n */\nexport function rateLimitMiddleware(\n  identifier: string,\n  action: string,\n  config: RateLimitConfig\n): Result<RateLimitResult> {\n  try {\n    const result = checkRateLimit(identifier, action, config);\n\n    if (!result.allowed) {\n      return {\n        success: false,\n        error: {\n          code: 'RATE_LIMIT_EXCEEDED',\n          message: 'Too many requests. Please try again later.',\n          details: {\n            limit: result.limit,\n            remaining: result.remaining,\n            reset: result.reset,\n            retryAfter: result.retryAfter,\n          },\n        },\n      };\n    }\n\n    return {\n      success: true,\n      data: result,\n    };\n  } catch (error) {\n    // If rate limiting fails, allow the request (fail open)\n    return {\n      success: true,\n      data: {\n        allowed: true,\n        limit: config.maxRequests,\n        remaining: config.maxRequests,\n        reset: Math.floor((Date.now() + config.windowMs) / 1000),\n      },\n    };\n  }\n}\n\n/**\n * Gets rate limit headers for HTTP responses.\n * \n * @param result - Rate limit check result\n * @returns Headers object\n */\nexport function getRateLimitHeaders(result: RateLimitResult): Record<string, string> {\n  const headers: Record<string, string> = {\n    'X-RateLimit-Limit': String(result.limit),\n    'X-RateLimit-Remaining': String(result.remaining),\n    'X-RateLimit-Reset': String(result.reset),\n  };\n\n  if (result.retryAfter !== undefined) {\n    headers['Retry-After'] = String(result.retryAfter);\n  }\n\n  return headers;\n}\n\n/**\n * Email-specific rate limiting helper.\n * \n * @param userId - User ID sending the email\n * @param recipientEmail - Recipient email address\n * @returns Result indicating if email can be sent\n */\nexport function checkEmailRateLimit(\n  userId: string,\n  recipientEmail: string\n): Result<{ canSend: boolean; reason?: string }> {\n  // Check per-user limit\n  const userLimit = checkRateLimit(userId, 'email:send', RATE_LIMITS.email.perUser);\n  if (!userLimit.allowed) {\n    return {\n      success: false,\n      error: {\n        code: 'EMAIL_RATE_LIMIT_EXCEEDED',\n        message: 'You have sent too many emails. Please try again later.',\n        details: {\n          limit: userLimit.limit,\n          retryAfter: userLimit.retryAfter,\n        },\n      },\n    };\n  }\n\n  // Check per-recipient limit\n  const recipientLimit = checkRateLimit(\n    recipientEmail,\n    'email:receive',\n    RATE_LIMITS.email.perRecipient\n  );\n  if (!recipientLimit.allowed) {\n    return {\n      success: false,\n      error: {\n        code: 'RECIPIENT_RATE_LIMIT_EXCEEDED',\n        message: 'This recipient has received too many emails. Please try again later.',\n        details: {\n          limit: recipientLimit.limit,\n          retryAfter: recipientLimit.retryAfter,\n        },\n      },\n    };\n  }\n\n  return {\n    success: true,\n    data: {\n      canSend: true,\n    },\n  };\n}\n\n/**\n * Bulk email rate limiting helper.\n * \n * @param userId - User ID sending bulk emails\n * @param recipientCount - Number of recipients\n * @returns Result indicating if bulk email can be sent\n */\nexport function checkBulkEmailRateLimit(\n  userId: string,\n  recipientCount: number\n): Result<{ canSend: boolean; reason?: string }> {\n  const bulkLimit = checkRateLimit(userId, 'email:bulk', RATE_LIMITS.email.bulk);\n\n  if (!bulkLimit.allowed) {\n    return {\n      success: false,\n      error: {\n        code: 'BULK_EMAIL_RATE_LIMIT_EXCEEDED',\n        message: 'You have sent too many bulk emails. Please try again later.',\n        details: {\n          limit: bulkLimit.limit,\n          retryAfter: bulkLimit.retryAfter,\n        },\n      },\n    };\n  }\n\n  // Check if this bulk send would exceed the limit\n  if (bulkLimit.remaining < recipientCount) {\n    return {\n      success: false,\n      error: {\n        code: 'BULK_EMAIL_WOULD_EXCEED_LIMIT',\n        message: `Sending to ${recipientCount} recipients would exceed your rate limit. You can send to ${bulkLimit.remaining} more recipients.`,\n        details: {\n          limit: bulkLimit.limit,\n          remaining: bulkLimit.remaining,\n          requested: recipientCount,\n        },\n      },\n    };\n  }\n\n  return {\n    success: true,\n    data: {\n      canSend: true,\n    },\n  };\n}\n\nexport const rateLimitService = {\n  check: checkRateLimit,\n  middleware: rateLimitMiddleware,\n  getHeaders: getRateLimitHeaders,\n  checkEmail: checkEmailRateLimit,\n  checkBulkEmail: checkBulkEmailRateLimit,\n};\n"],"names":["RATE_LIMITS","checkBulkEmailRateLimit","checkEmailRateLimit","checkRateLimit","getRateLimitHeaders","rateLimitMiddleware","rateLimitService","RateLimitStore","get","key","entry","store","Date","now","resetAt","delete","increment","windowMs","existing","count","set","cleanup","entries","Map","setInterval","identifier","action","config","allowed","maxRequests","remaining","Math","max","reset","floor","retryAfter","undefined","ceil","limit","api","strict","moderate","relaxed","email","perUser","perRecipient","bulk","auth","login","passwordReset","upload","photos","documents","result","success","error","code","message","details","data","headers","String","userId","recipientEmail","userLimit","recipientLimit","canSend","recipientCount","bulkLimit","requested","check","middleware","getHeaders","checkEmail","checkBulkEmail"],"mappings":"AAAA;;CAEC,GAED;;CAEC;;;;;;;;;;;QAiIYA;eAAAA;;QAwKGC;eAAAA;;QAvDAC;eAAAA;;QA1IAC;eAAAA;;QAqHAC;eAAAA;;QAhDAC;eAAAA;;QAwKHC;eAAAA;;;AA7Tb;;;CAGC,GACD,MAAMC;IAGJ;;GAEC,GACDC,IAAIC,GAAW,EAA6C;QAC1D,MAAMC,QAAQ,IAAI,CAACC,KAAK,CAACH,GAAG,CAACC;QAC7B,IAAI,CAACC,OAAO,OAAO;QAEnB,kCAAkC;QAClC,IAAIE,KAAKC,GAAG,KAAKH,MAAMI,OAAO,EAAE;YAC9B,IAAI,CAACH,KAAK,CAACI,MAAM,CAACN;YAClB,OAAO;QACT;QAEA,OAAOC;IACT;IAEA;;GAEC,GACDM,UAAUP,GAAW,EAAEQ,QAAgB,EAAsC;QAC3E,MAAMC,WAAW,IAAI,CAACV,GAAG,CAACC;QAE1B,IAAIS,UAAU;YACZA,SAASC,KAAK;YACd,IAAI,CAACR,KAAK,CAACS,GAAG,CAACX,KAAKS;YACpB,OAAOA;QACT;QAEA,MAAMJ,UAAUF,KAAKC,GAAG,KAAKI;QAC7B,MAAMP,QAAQ;YAAES,OAAO;YAAGL;QAAQ;QAClC,IAAI,CAACH,KAAK,CAACS,GAAG,CAACX,KAAKC;QACpB,OAAOA;IACT;IAEA;;GAEC,GACDW,UAAgB;QACd,MAAMR,MAAMD,KAAKC,GAAG;QACpB,KAAK,MAAM,CAACJ,KAAKC,MAAM,IAAI,IAAI,CAACC,KAAK,CAACW,OAAO,GAAI;YAC/C,IAAIT,MAAMH,MAAMI,OAAO,EAAE;gBACvB,IAAI,CAACH,KAAK,CAACI,MAAM,CAACN;YACpB;QACF;IACF;;aA9CQE,QAAyD,IAAIY;;AA+CvE;AAEA,wBAAwB;AACxB,MAAMZ,QAAQ,IAAIJ;AAElB,8BAA8B;AAC9B,IAAI,OAAOiB,gBAAgB,aAAa;IACtCA,YAAY,IAAMb,MAAMU,OAAO,IAAI,IAAI,KAAK;AAC9C;AAoBO,SAASlB,eACdsB,UAAkB,EAClBC,MAAc,EACdC,MAAuB;IAEvB,MAAMlB,MAAM,GAAGgB,WAAW,CAAC,EAAEC,QAAQ;IACrC,MAAMhB,QAAQC,MAAMK,SAAS,CAACP,KAAKkB,OAAOV,QAAQ;IAElD,MAAMW,UAAUlB,MAAMS,KAAK,IAAIQ,OAAOE,WAAW;IACjD,MAAMC,YAAYC,KAAKC,GAAG,CAAC,GAAGL,OAAOE,WAAW,GAAGnB,MAAMS,KAAK;IAC9D,MAAMc,QAAQF,KAAKG,KAAK,CAACxB,MAAMI,OAAO,GAAG,OAAO,qBAAqB;IACrE,MAAMqB,aAAaP,UAAUQ,YAAYL,KAAKM,IAAI,CAAC,AAAC3B,CAAAA,MAAMI,OAAO,GAAGF,KAAKC,GAAG,EAAC,IAAK;IAElF,OAAO;QACLe;QACAU,OAAOX,OAAOE,WAAW;QACzBC;QACAG;QACAE;IACF;AACF;AAKO,MAAMnC,cAAc;IACzB,gBAAgB;IAChBuC,KAAK;QACHC,QAAQ;YAAEX,aAAa;YAAIZ,UAAU,KAAK;QAAK;QAC/CwB,UAAU;YAAEZ,aAAa;YAAIZ,UAAU,KAAK;QAAK;QACjDyB,SAAS;YAAEb,aAAa;YAAKZ,UAAU,KAAK;QAAK;IACnD;IACA,gBAAgB;IAChB0B,OAAO;QACLC,SAAS;YAAEf,aAAa;YAAIZ,UAAU,KAAK,KAAK;QAAK;QACrD4B,cAAc;YAAEhB,aAAa;YAAGZ,UAAU,KAAK,KAAK;QAAK;QACzD6B,MAAM;YAAEjB,aAAa;YAAKZ,UAAU,KAAK,KAAK;QAAK;IACrD;IACA,iBAAiB;IACjB8B,MAAM;QACJC,OAAO;YAAEnB,aAAa;YAAGZ,UAAU,KAAK,KAAK;QAAK;QAClDgC,eAAe;YAAEpB,aAAa;YAAGZ,UAAU,KAAK,KAAK;QAAK;IAC5D;IACA,eAAe;IACfiC,QAAQ;QACNC,QAAQ;YAAEtB,aAAa;YAAIZ,UAAU,KAAK,KAAK;QAAK;QACpDmC,WAAW;YAAEvB,aAAa;YAAIZ,UAAU,KAAK,KAAK;QAAK;IACzD;AACF;AAqBO,SAASZ,oBACdoB,UAAkB,EAClBC,MAAc,EACdC,MAAuB;IAEvB,IAAI;QACF,MAAM0B,SAASlD,eAAesB,YAAYC,QAAQC;QAElD,IAAI,CAAC0B,OAAOzB,OAAO,EAAE;YACnB,OAAO;gBACL0B,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;oBACTC,SAAS;wBACPpB,OAAOe,OAAOf,KAAK;wBACnBR,WAAWuB,OAAOvB,SAAS;wBAC3BG,OAAOoB,OAAOpB,KAAK;wBACnBE,YAAYkB,OAAOlB,UAAU;oBAC/B;gBACF;YACF;QACF;QAEA,OAAO;YACLmB,SAAS;YACTK,MAAMN;QACR;IACF,EAAE,OAAOE,OAAO;QACd,wDAAwD;QACxD,OAAO;YACLD,SAAS;YACTK,MAAM;gBACJ/B,SAAS;gBACTU,OAAOX,OAAOE,WAAW;gBACzBC,WAAWH,OAAOE,WAAW;gBAC7BI,OAAOF,KAAKG,KAAK,CAAC,AAACtB,CAAAA,KAAKC,GAAG,KAAKc,OAAOV,QAAQ,AAAD,IAAK;YACrD;QACF;IACF;AACF;AAQO,SAASb,oBAAoBiD,MAAuB;IACzD,MAAMO,UAAkC;QACtC,qBAAqBC,OAAOR,OAAOf,KAAK;QACxC,yBAAyBuB,OAAOR,OAAOvB,SAAS;QAChD,qBAAqB+B,OAAOR,OAAOpB,KAAK;IAC1C;IAEA,IAAIoB,OAAOlB,UAAU,KAAKC,WAAW;QACnCwB,OAAO,CAAC,cAAc,GAAGC,OAAOR,OAAOlB,UAAU;IACnD;IAEA,OAAOyB;AACT;AASO,SAAS1D,oBACd4D,MAAc,EACdC,cAAsB;IAEtB,uBAAuB;IACvB,MAAMC,YAAY7D,eAAe2D,QAAQ,cAAc9D,YAAY2C,KAAK,CAACC,OAAO;IAChF,IAAI,CAACoB,UAAUpC,OAAO,EAAE;QACtB,OAAO;YACL0B,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAAS;gBACTC,SAAS;oBACPpB,OAAO0B,UAAU1B,KAAK;oBACtBH,YAAY6B,UAAU7B,UAAU;gBAClC;YACF;QACF;IACF;IAEA,4BAA4B;IAC5B,MAAM8B,iBAAiB9D,eACrB4D,gBACA,iBACA/D,YAAY2C,KAAK,CAACE,YAAY;IAEhC,IAAI,CAACoB,eAAerC,OAAO,EAAE;QAC3B,OAAO;YACL0B,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAAS;gBACTC,SAAS;oBACPpB,OAAO2B,eAAe3B,KAAK;oBAC3BH,YAAY8B,eAAe9B,UAAU;gBACvC;YACF;QACF;IACF;IAEA,OAAO;QACLmB,SAAS;QACTK,MAAM;YACJO,SAAS;QACX;IACF;AACF;AASO,SAASjE,wBACd6D,MAAc,EACdK,cAAsB;IAEtB,MAAMC,YAAYjE,eAAe2D,QAAQ,cAAc9D,YAAY2C,KAAK,CAACG,IAAI;IAE7E,IAAI,CAACsB,UAAUxC,OAAO,EAAE;QACtB,OAAO;YACL0B,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAAS;gBACTC,SAAS;oBACPpB,OAAO8B,UAAU9B,KAAK;oBACtBH,YAAYiC,UAAUjC,UAAU;gBAClC;YACF;QACF;IACF;IAEA,iDAAiD;IACjD,IAAIiC,UAAUtC,SAAS,GAAGqC,gBAAgB;QACxC,OAAO;YACLb,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAAS,CAAC,WAAW,EAAEU,eAAe,0DAA0D,EAAEC,UAAUtC,SAAS,CAAC,iBAAiB,CAAC;gBACxI4B,SAAS;oBACPpB,OAAO8B,UAAU9B,KAAK;oBACtBR,WAAWsC,UAAUtC,SAAS;oBAC9BuC,WAAWF;gBACb;YACF;QACF;IACF;IAEA,OAAO;QACLb,SAAS;QACTK,MAAM;YACJO,SAAS;QACX;IACF;AACF;AAEO,MAAM5D,mBAAmB;IAC9BgE,OAAOnE;IACPoE,YAAYlE;IACZmE,YAAYpE;IACZqE,YAAYvE;IACZwE,gBAAgBzE;AAClB"}