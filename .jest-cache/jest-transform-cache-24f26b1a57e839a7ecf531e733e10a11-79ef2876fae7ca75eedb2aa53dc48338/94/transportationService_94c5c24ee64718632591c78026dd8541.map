{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/transportationService.ts"],"sourcesContent":["import { sanitizeInput, sanitizeRichText } from \"../utils/sanitization\";\nimport type { Result } from '@/types';\nimport { ERROR_CODES } from '@/types';\nimport {\n  flightInfoSchema,\n  createTransportationManifestSchema,\n  updateTransportationManifestSchema,\n  type FlightInfoDTO,\n  type CreateTransportationManifestDTO,\n  type UpdateTransportationManifestDTO,\n  type VehicleRequirementDTO,\n  type DriverSheetDTO,\n} from '@/schemas/transportationSchemas';\n\n// Supabase client - can be overridden for testing\nlet _supabase: any = null;\n\n/**\n * Gets the Supabase client instance.\n * Lazy loads the client to avoid initialization issues in tests.\n */\nfunction getSupabase() {\n  if (!_supabase) {\n    const { supabase } = require('@/lib/supabase');\n    _supabase = supabase;\n  }\n  return _supabase;\n}\n\n/**\n * Sets the Supabase client instance (for testing).\n * @internal\n */\nexport function _setSupabaseForTesting(client: any) {\n  _supabase = client;\n}\n\n/**\n * Resets the Supabase client instance (for testing).\n * @internal\n */\nexport function _resetSupabaseForTesting() {\n  _supabase = null;\n}\n\n/**\n * Transportation manifest entity\n */\nexport interface TransportationManifest {\n  id: string;\n  manifest_type: 'arrival' | 'departure';\n  date: string;\n  time_window_start: string;\n  time_window_end: string;\n  vehicle_type?: string;\n  driver_name?: string;\n  driver_phone?: string;\n  guest_ids: string[];\n  notes?: string;\n  created_at: string;\n  updated_at: string;\n}\n\n/**\n * Flight information entity\n */\nexport interface FlightInfo {\n  guest_id: string;\n  airport_code: 'SJO' | 'LIR' | 'Other';\n  flight_number?: string;\n  airline?: string;\n  arrival_time?: string;\n  departure_time?: string;\n}\n\n/**\n * Vehicle requirement entity\n */\nexport interface VehicleRequirement {\n  vehicle_type: string;\n  capacity: number;\n  quantity_needed: number;\n  estimated_cost: number;\n}\n\n/**\n * Driver sheet entity\n */\nexport interface DriverSheet {\n  manifest_id: string;\n  date: string;\n  time_window: string;\n  vehicle_type?: string;\n  driver_name?: string;\n  driver_phone?: string;\n  guests: Array<{\n    name: string;\n    flight_number?: string;\n    phone?: string;\n    special_requests?: string;\n  }>;\n  total_guests: number;\n  pickup_location: string;\n  dropoff_locations: string[];\n}\n\n/**\n * Updates flight information for a guest.\n * \n * @param guestId - The guest's ID\n * @param flightInfo - Flight information to update\n * @returns Result containing void or error details\n * \n * @example\n * const result = await transportationService.updateFlightInfo('guest-123', {\n *   guest_id: 'guest-123',\n *   airport_code: 'SJO',\n *   flight_number: 'AA123',\n *   arrival_time: '2025-06-01T14:30:00Z',\n * });\n */\nexport async function updateFlightInfo(\n  guestId: string,\n  flightInfo: FlightInfoDTO\n): Promise<Result<void>> {\n  try {\n    // 1. Validate\n    const validation = flightInfoSchema.safeParse(flightInfo);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Invalid flight information',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize\n    const sanitized = {\n      ...validation.data,\n      flight_number: validation.data.flight_number\n        ? sanitizeInput(validation.data.flight_number)\n        : undefined,\n      airline: validation.data.airline\n        ? sanitizeInput(validation.data.airline)\n        : undefined,\n    };\n\n    // 3. Update guest record\n    const supabase = getSupabase();\n    \n    // Extract date and time components from datetime strings\n    const arrivalDate = sanitized.arrival_time\n      ? new Date(sanitized.arrival_time).toISOString().split('T')[0]\n      : undefined;\n    const arrivalTime = sanitized.arrival_time\n      ? new Date(sanitized.arrival_time).toISOString().split('T')[1].substring(0, 8)\n      : undefined;\n    const departureDate = sanitized.departure_time\n      ? new Date(sanitized.departure_time).toISOString().split('T')[0]\n      : undefined;\n    const departureTime = sanitized.departure_time\n      ? new Date(sanitized.departure_time).toISOString().split('T')[1].substring(0, 8)\n      : undefined;\n    \n    const { error } = await supabase\n      .from('guests')\n      .update({\n        airport_code: sanitized.airport_code,\n        flight_number: sanitized.flight_number,\n        arrival_date: arrivalDate,\n        arrival_time: arrivalTime,\n        departure_date: departureDate,\n        departure_time: departureTime,\n        updated_at: new Date().toISOString(),\n      })\n      .eq('id', guestId);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Gets flights by airport code.\n * \n * @param airportCode - Airport code to filter by\n * @returns Result containing flight information array or error details\n */\nexport async function getFlightsByAirport(\n  airportCode: 'SJO' | 'LIR' | 'Other'\n): Promise<Result<FlightInfo[]>> {\n  try {\n    const supabase = getSupabase();\n    const { data, error } = await supabase\n      .from('guests')\n      .select('id, airport_code, flight_number, arrival_date, departure_date')\n      .eq('airport_code', airportCode)\n      .not('flight_number', 'is', null);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    const flights: FlightInfo[] = data.map((guest: any) => ({\n      guest_id: guest.id,\n      airport_code: guest.airport_code as 'SJO' | 'LIR' | 'Other',\n      flight_number: guest.flight_number || undefined,\n      arrival_time: guest.arrival_date || undefined,\n      departure_time: guest.departure_date || undefined,\n    }));\n\n    return { success: true, data: flights };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Generates arrival manifests for a specific date, grouping guests by time windows.\n * \n * @param date - Date to generate manifests for\n * @param timeWindowHours - Hours for time window grouping (default: 2)\n * @returns Result containing transportation manifests or error details\n */\nexport async function generateArrivalManifest(\n  date: Date,\n  timeWindowHours: number = 2\n): Promise<Result<TransportationManifest[]>> {\n  try {\n    const dateStr = date.toISOString().split('T')[0];\n\n    // Get all guests arriving on this date\n    const supabase = getSupabase();\n    const { data: guests, error } = await supabase\n      .from('guests')\n      .select('id, first_name, last_name, arrival_date, arrival_time, airport_code, flight_number')\n      .eq('arrival_date', dateStr)\n      .not('airport_code', 'is', null);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    if (!guests || guests.length === 0) {\n      return { success: true, data: [] };\n    }\n\n    // Group guests by time windows based on their arrival times\n    const timeWindows = new Map<string, string[]>();\n    \n    guests.forEach((guest: { id: string; arrival_time?: string }) => {\n      // Parse arrival time or default to noon if not specified\n      let hour = 12; // Default to noon\n      if (guest.arrival_time) {\n        const timeParts = guest.arrival_time.split(':');\n        hour = parseInt(timeParts[0], 10);\n      }\n      \n      // Calculate which time window this guest belongs to\n      const windowStart = Math.floor(hour / timeWindowHours) * timeWindowHours;\n      const windowEnd = windowStart + timeWindowHours;\n      \n      const windowKey = `${String(windowStart).padStart(2, '0')}:00:00-${String(windowEnd).padStart(2, '0')}:00:00`;\n      \n      if (!timeWindows.has(windowKey)) {\n        timeWindows.set(windowKey, []);\n      }\n      timeWindows.get(windowKey)!.push(guest.id);\n    });\n\n    // Create manifests for each time window\n    const manifests: TransportationManifest[] = [];\n    \n    for (const [windowKey, guestIds] of timeWindows.entries()) {\n      const [startTime, endTime] = windowKey.split('-');\n      \n      const manifestData: CreateTransportationManifestDTO = {\n        manifest_type: 'arrival',\n        date: dateStr,\n        time_window_start: startTime,\n        time_window_end: endTime,\n        guest_ids: guestIds,\n      };\n\n      const createResult = await createManifest(manifestData);\n      if (createResult.success) {\n        manifests.push(createResult.data);\n      }\n    }\n\n    return { success: true, data: manifests };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Generates departure manifests for a specific date, grouping guests by time windows.\n * \n * @param date - Date to generate manifests for\n * @param timeWindowHours - Hours for time window grouping (default: 2)\n * @returns Result containing transportation manifests or error details\n */\nexport async function generateDepartureManifest(\n  date: Date,\n  timeWindowHours: number = 2\n): Promise<Result<TransportationManifest[]>> {\n  try {\n    const dateStr = date.toISOString().split('T')[0];\n\n    // Get all guests departing on this date\n    const supabase = getSupabase();\n    const { data: guests, error } = await supabase\n      .from('guests')\n      .select('id, first_name, last_name, departure_date, departure_time, airport_code, flight_number')\n      .eq('departure_date', dateStr)\n      .not('airport_code', 'is', null);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    if (!guests || guests.length === 0) {\n      return { success: true, data: [] };\n    }\n\n    // Group guests by time windows based on their departure times\n    const timeWindows = new Map<string, string[]>();\n    \n    guests.forEach((guest: { id: string; departure_time?: string }) => {\n      // Parse departure time or default to 2 PM if not specified\n      let hour = 14; // Default to 2 PM\n      if (guest.departure_time) {\n        const timeParts = guest.departure_time.split(':');\n        hour = parseInt(timeParts[0], 10);\n      }\n      \n      // Calculate which time window this guest belongs to\n      const windowStart = Math.floor(hour / timeWindowHours) * timeWindowHours;\n      const windowEnd = windowStart + timeWindowHours;\n      \n      const windowKey = `${String(windowStart).padStart(2, '0')}:00:00-${String(windowEnd).padStart(2, '0')}:00:00`;\n      \n      if (!timeWindows.has(windowKey)) {\n        timeWindows.set(windowKey, []);\n      }\n      timeWindows.get(windowKey)!.push(guest.id);\n    });\n\n    // Create manifests for each time window\n    const manifests: TransportationManifest[] = [];\n    \n    for (const [windowKey, guestIds] of timeWindows.entries()) {\n      const [startTime, endTime] = windowKey.split('-');\n      \n      const manifestData: CreateTransportationManifestDTO = {\n        manifest_type: 'departure',\n        date: dateStr,\n        time_window_start: startTime,\n        time_window_end: endTime,\n        guest_ids: guestIds,\n      };\n\n      const createResult = await createManifest(manifestData);\n      if (createResult.success) {\n        manifests.push(createResult.data);\n      }\n    }\n\n    return { success: true, data: manifests };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Creates a transportation manifest.\n * \n * @param data - Manifest data\n * @returns Result containing created manifest or error details\n */\nexport async function createManifest(\n  data: CreateTransportationManifestDTO\n): Promise<Result<TransportationManifest>> {\n  try {\n    // 1. Validate\n    const validation = createTransportationManifestSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Invalid manifest data',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize\n    const sanitized = {\n      ...validation.data,\n      vehicle_type: validation.data.vehicle_type\n        ? sanitizeInput(validation.data.vehicle_type)\n        : undefined,\n      driver_name: validation.data.driver_name\n        ? sanitizeInput(validation.data.driver_name)\n        : undefined,\n      driver_phone: validation.data.driver_phone\n        ? sanitizeInput(validation.data.driver_phone)\n        : undefined,\n      notes: validation.data.notes\n        ? sanitizeInput(validation.data.notes)\n        : undefined,\n    };\n\n    // 3. Insert into database\n    const supabase = getSupabase();\n    const { data: manifest, error } = await supabase\n      .from('transportation_manifests')\n      .insert(sanitized)\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: manifest };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Assigns guests to a shuttle manifest.\n * \n * @param manifestId - Manifest ID\n * @param guestIds - Array of guest IDs to assign\n * @returns Result containing void or error details\n */\nexport async function assignGuestsToShuttle(\n  manifestId: string,\n  guestIds: string[]\n): Promise<Result<void>> {\n  try {\n    // Get current manifest\n    const supabase = getSupabase();\n    const { data: manifest, error: fetchError } = await supabase\n      .from('transportation_manifests')\n      .select('guest_ids')\n      .eq('id', manifestId)\n      .single();\n\n    if (fetchError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: fetchError.message,\n          details: fetchError,\n        },\n      };\n    }\n\n    // Merge guest IDs (avoid duplicates)\n    const currentGuestIds = manifest.guest_ids || [];\n    const updatedGuestIds = Array.from(new Set([...currentGuestIds, ...guestIds]));\n\n    // Update manifest\n    const { error: updateError } = await supabase\n      .from('transportation_manifests')\n      .update({\n        guest_ids: updatedGuestIds,\n        updated_at: new Date().toISOString(),\n      })\n      .eq('id', manifestId);\n\n    if (updateError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: updateError.message,\n          details: updateError,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Calculates vehicle requirements based on guest count.\n * \n * @param guestCount - Total number of guests\n * @returns Result containing vehicle requirements or error details\n */\nexport async function calculateVehicleRequirements(\n  guestCount: number\n): Promise<Result<VehicleRequirement[]>> {\n  try {\n    if (guestCount < 0) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Guest count must be non-negative',\n        },\n      };\n    }\n\n    // Vehicle capacity definitions\n    const vehicles = [\n      { type: 'sedan', capacity: 4, cost: 50 },\n      { type: 'van', capacity: 8, cost: 80 },\n      { type: 'minibus', capacity: 15, cost: 120 },\n      { type: 'bus', capacity: 50, cost: 300 },\n    ];\n\n    // Calculate optimal vehicle mix (greedy algorithm - largest first)\n    const requirements: VehicleRequirement[] = [];\n    let remainingGuests = guestCount;\n\n    for (let i = vehicles.length - 1; i >= 0; i--) {\n      const vehicle = vehicles[i];\n      if (remainingGuests >= vehicle.capacity) {\n        const quantity = Math.floor(remainingGuests / vehicle.capacity);\n        requirements.push({\n          vehicle_type: vehicle.type,\n          capacity: vehicle.capacity,\n          quantity_needed: quantity,\n          estimated_cost: quantity * vehicle.cost,\n        });\n        remainingGuests -= quantity * vehicle.capacity;\n      }\n    }\n\n    // Handle remaining guests with smallest vehicle\n    if (remainingGuests > 0) {\n      const smallestVehicle = vehicles[0];\n      requirements.push({\n        vehicle_type: smallestVehicle.type,\n        capacity: smallestVehicle.capacity,\n        quantity_needed: 1,\n        estimated_cost: smallestVehicle.cost,\n      });\n    }\n\n    return { success: true, data: requirements };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Generates a driver sheet for a manifest.\n * \n * @param manifestId - Manifest ID\n * @returns Result containing driver sheet or error details\n */\nexport async function generateDriverSheet(\n  manifestId: string\n): Promise<Result<DriverSheet>> {\n  try {\n    // Get manifest\n    const supabase = getSupabase();\n    const { data: manifest, error: manifestError } = await supabase\n      .from('transportation_manifests')\n      .select('*')\n      .eq('id', manifestId)\n      .single();\n\n    if (manifestError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: manifestError.message,\n          details: manifestError,\n        },\n      };\n    }\n\n    // Get guest details\n    const { data: guests, error: guestsError } = await supabase\n      .from('guests')\n      .select('id, first_name, last_name, flight_number, phone, notes')\n      .in('id', manifest.guest_ids);\n\n    if (guestsError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: guestsError.message,\n          details: guestsError,\n        },\n      };\n    }\n\n    // Build driver sheet\n    const driverSheet: DriverSheet = {\n      manifest_id: manifest.id,\n      date: manifest.date,\n      time_window: `${manifest.time_window_start} - ${manifest.time_window_end}`,\n      vehicle_type: manifest.vehicle_type,\n      driver_name: manifest.driver_name,\n      driver_phone: manifest.driver_phone,\n      guests: guests.map((guest: any) => ({\n        name: `${guest.first_name} ${guest.last_name}`,\n        flight_number: guest.flight_number || undefined,\n        phone: guest.phone || undefined,\n        special_requests: guest.notes || undefined,\n      })),\n      total_guests: guests.length,\n      pickup_location: manifest.manifest_type === 'arrival' ? 'Airport' : 'Hotel',\n      dropoff_locations: manifest.manifest_type === 'arrival' ? ['Hotel'] : ['Airport'],\n    };\n\n    return { success: true, data: driverSheet };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Calculates total shuttle costs for manifests.\n * \n * @param manifests - Array of transportation manifests\n * @returns Result containing total cost or error details\n */\nexport async function calculateShuttleCosts(\n  manifests: TransportationManifest[]\n): Promise<Result<number>> {\n  try {\n    let totalCost = 0;\n\n    for (const manifest of manifests) {\n      const guestCount = manifest.guest_ids.length;\n      const vehicleResult = await calculateVehicleRequirements(guestCount);\n      \n      if (vehicleResult.success) {\n        const manifestCost = vehicleResult.data.reduce(\n          (sum, req) => sum + req.estimated_cost,\n          0\n        );\n        totalCost += manifestCost;\n      }\n    }\n\n    return { success: true, data: totalCost };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n"],"names":["_resetSupabaseForTesting","_setSupabaseForTesting","assignGuestsToShuttle","calculateShuttleCosts","calculateVehicleRequirements","createManifest","generateArrivalManifest","generateDepartureManifest","generateDriverSheet","getFlightsByAirport","updateFlightInfo","_supabase","getSupabase","supabase","require","client","guestId","flightInfo","validation","flightInfoSchema","safeParse","success","error","code","ERROR_CODES","VALIDATION_ERROR","message","details","issues","sanitized","data","flight_number","sanitizeInput","undefined","airline","arrivalDate","arrival_time","Date","toISOString","split","arrivalTime","substring","departureDate","departure_time","departureTime","from","update","airport_code","arrival_date","departure_date","updated_at","eq","DATABASE_ERROR","UNKNOWN_ERROR","Error","airportCode","select","not","flights","map","guest","guest_id","id","date","timeWindowHours","dateStr","guests","length","timeWindows","Map","forEach","hour","timeParts","parseInt","windowStart","Math","floor","windowEnd","windowKey","String","padStart","has","set","get","push","manifests","guestIds","entries","startTime","endTime","manifestData","manifest_type","time_window_start","time_window_end","guest_ids","createResult","createTransportationManifestSchema","vehicle_type","driver_name","driver_phone","notes","manifest","insert","single","manifestId","fetchError","currentGuestIds","updatedGuestIds","Array","Set","updateError","guestCount","vehicles","type","capacity","cost","requirements","remainingGuests","i","vehicle","quantity","quantity_needed","estimated_cost","smallestVehicle","manifestError","guestsError","in","driverSheet","manifest_id","time_window","name","first_name","last_name","phone","special_requests","total_guests","pickup_location","dropoff_locations","totalCost","vehicleResult","manifestCost","reduce","sum","req"],"mappings":"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"}