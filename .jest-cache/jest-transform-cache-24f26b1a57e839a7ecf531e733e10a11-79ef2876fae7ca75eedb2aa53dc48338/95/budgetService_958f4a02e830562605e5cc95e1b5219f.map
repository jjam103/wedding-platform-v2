{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/budgetService.ts"],"sourcesContent":["/**\n * Budget Service\n * \n * Handles budget calculations, subsidy tracking, payment status updates,\n * and budget report generation for the wedding.\n * \n * Requirements: 7.2, 7.4, 7.5, 7.7, 7.8\n */\n\nimport { createClient } from '@supabase/supabase-js';\nimport {\n  budgetCalculationSchema,\n  type BudgetCalculationDTO,\n  type BudgetBreakdown,\n  type BudgetSummary,\n  type PaymentStatusReport,\n  type SubsidyTracking,\n} from '../schemas/budgetSchemas';\n\n// Result type for consistent error handling\ntype Result<T> =\n  | { success: true; data: T }\n  | { success: false; error: { code: string; message: string; details?: unknown } };\n\n// Initialize Supabase client - Pattern A (testable)\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\n/**\n * Calculates total wedding budget including vendors, activities, and accommodations.\n * \n * @param options - Options to include/exclude different budget categories\n * @returns Result containing budget breakdown or error details\n * \n * @example\n * const result = await budgetService.calculateTotal({\n *   includeVendors: true,\n *   includeActivities: true,\n *   includeAccommodations: true,\n * });\n */\nexport async function calculateTotal(options: BudgetCalculationDTO = {}): Promise<Result<BudgetBreakdown>> {\n  try {\n    // Validate options\n    const validation = budgetCalculationSchema.safeParse(options);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid calculation options',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    const {\n      includeVendors = true,\n      includeActivities = true,\n      includeAccommodations = true,\n      vendorCategories,\n    } = validation.data;\n\n    // Initialize breakdown structure\n    const breakdown: BudgetBreakdown = {\n      vendors: [],\n      activities: {\n        totalCost: 0,\n        totalSubsidy: 0,\n        netCost: 0,\n        activities: [],\n      },\n      accommodations: {\n        totalCost: 0,\n        totalSubsidy: 0,\n        netCost: 0,\n        accommodations: [],\n      },\n      totals: {\n        grossTotal: 0,\n        totalSubsidies: 0,\n        totalPaid: 0,\n        netTotal: 0,\n        balanceDue: 0,\n      },\n    };\n\n    // Calculate vendor costs\n    if (includeVendors) {\n      let vendorQuery = supabase.from('vendors').select('*');\n      \n      if (vendorCategories && vendorCategories.length > 0) {\n        vendorQuery = vendorQuery.in('category', vendorCategories);\n      }\n\n      const { data: vendors, error: vendorError } = await vendorQuery;\n\n      if (vendorError) {\n        return {\n          success: false,\n          error: {\n            code: 'DATABASE_ERROR',\n            message: vendorError.message,\n            details: vendorError,\n          },\n        };\n      }\n\n      // Group vendors by category\n      const vendorsByCategory: Record<string, any[]> = {};\n      vendors.forEach((vendor) => {\n        if (!vendorsByCategory[vendor.category]) {\n          vendorsByCategory[vendor.category] = [];\n        }\n        vendorsByCategory[vendor.category].push(vendor);\n      });\n\n      // Calculate totals per category\n      breakdown.vendors = Object.entries(vendorsByCategory).map(([category, categoryVendors]) => {\n        const categoryTotal = categoryVendors.reduce((sum, v) => sum + parseFloat(v.base_cost), 0);\n        const categoryPaid = categoryVendors.reduce((sum, v) => sum + parseFloat(v.amount_paid), 0);\n        const categoryBalance = categoryTotal - categoryPaid;\n\n        return {\n          category,\n          totalCost: categoryTotal,\n          amountPaid: categoryPaid,\n          balanceDue: categoryBalance,\n          vendors: categoryVendors.map((v) => ({\n            id: v.id,\n            name: v.name,\n            cost: parseFloat(v.base_cost),\n            paid: parseFloat(v.amount_paid),\n            balance: parseFloat(v.base_cost) - parseFloat(v.amount_paid),\n            paymentStatus: v.payment_status,\n          })),\n        };\n      });\n\n      // Update totals\n      breakdown.totals.grossTotal += breakdown.vendors.reduce((sum, cat) => sum + cat.totalCost, 0);\n      breakdown.totals.totalPaid += breakdown.vendors.reduce((sum, cat) => sum + cat.amountPaid, 0);\n    }\n\n    // Calculate activity costs\n    if (includeActivities) {\n      const { data: activities, error: activityError } = await supabase\n        .from('activities')\n        .select('id, name, cost_per_person, host_subsidy')\n        .not('cost_per_person', 'is', null);\n\n      if (activityError) {\n        return {\n          success: false,\n          error: {\n            code: 'DATABASE_ERROR',\n            message: activityError.message,\n            details: activityError,\n          },\n        };\n      }\n\n      // Get RSVP counts for each activity\n      for (const activity of activities) {\n        const { count: attendeeCount, error: rsvpError } = await supabase\n          .from('rsvps')\n          .select('*', { count: 'exact', head: true })\n          .eq('activity_id', activity.id)\n          .eq('status', 'attending');\n\n        if (rsvpError) {\n          return {\n            success: false,\n            error: {\n              code: 'DATABASE_ERROR',\n              message: rsvpError.message,\n              details: rsvpError,\n            },\n          };\n        }\n\n        const estimatedAttendees = attendeeCount || 0;\n        const costPerPerson = parseFloat(activity.cost_per_person);\n        const hostSubsidy = activity.host_subsidy ? parseFloat(activity.host_subsidy) : 0;\n        const totalCost = costPerPerson * estimatedAttendees;\n        const totalSubsidy = hostSubsidy * estimatedAttendees;\n        const netCost = totalCost - totalSubsidy;\n\n        breakdown.activities.activities.push({\n          id: activity.id,\n          name: activity.name,\n          costPerPerson,\n          hostSubsidy,\n          estimatedAttendees,\n          totalCost,\n          netCost,\n        });\n\n        breakdown.activities.totalCost += totalCost;\n        breakdown.activities.totalSubsidy += totalSubsidy;\n        breakdown.activities.netCost += netCost;\n      }\n\n      breakdown.totals.grossTotal += breakdown.activities.totalCost;\n      breakdown.totals.totalSubsidies += breakdown.activities.totalSubsidy;\n    }\n\n    // Calculate accommodation costs\n    if (includeAccommodations) {\n      // Note: This is a simplified calculation. In a real implementation,\n      // you would need to query room_types and room_assignments tables\n      // For now, we'll leave this as a placeholder\n      breakdown.accommodations = {\n        totalCost: 0,\n        totalSubsidy: 0,\n        netCost: 0,\n        accommodations: [],\n      };\n    }\n\n    // Calculate final totals\n    breakdown.totals.netTotal = breakdown.totals.grossTotal - breakdown.totals.totalSubsidies;\n    breakdown.totals.balanceDue = breakdown.totals.netTotal - breakdown.totals.totalPaid;\n\n    return {\n      success: true,\n      data: breakdown,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Gets a summary of the wedding budget for dashboard display.\n * \n * @returns Result containing budget summary or error details\n */\nexport async function getSummary(): Promise<Result<BudgetSummary>> {\n  try {\n    const breakdownResult = await calculateTotal();\n    if (!breakdownResult.success) {\n      return breakdownResult as Result<BudgetSummary>;\n    }\n\n    const breakdown = breakdownResult.data;\n\n    // Count vendors\n    const { count: totalVendors, error: countError } = await supabase\n      .from('vendors')\n      .select('*', { count: 'exact', head: true });\n\n    if (countError) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: countError.message,\n          details: countError,\n        },\n      };\n    }\n\n    const { count: unpaidVendors, error: unpaidError } = await supabase\n      .from('vendors')\n      .select('*', { count: 'exact', head: true })\n      .eq('payment_status', 'unpaid');\n\n    if (unpaidError) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: unpaidError.message,\n          details: unpaidError,\n        },\n      };\n    }\n\n    const paymentProgress = breakdown.totals.netTotal > 0\n      ? (breakdown.totals.totalPaid / breakdown.totals.netTotal) * 100\n      : 0;\n\n    return {\n      success: true,\n      data: {\n        totalBudget: breakdown.totals.netTotal,\n        totalPaid: breakdown.totals.totalPaid,\n        totalSubsidies: breakdown.totals.totalSubsidies,\n        balanceDue: breakdown.totals.balanceDue,\n        vendorCount: totalVendors || 0,\n        unpaidVendorCount: unpaidVendors || 0,\n        paymentProgress: Math.round(paymentProgress * 100) / 100,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Generates a payment status report showing unpaid, partially paid, and paid vendors.\n * \n * @returns Result containing payment status report or error details\n */\nexport async function getPaymentStatusReport(): Promise<Result<PaymentStatusReport>> {\n  try {\n    const { data: vendors, error } = await supabase\n      .from('vendors')\n      .select('*')\n      .order('payment_status', { ascending: true })\n      .order('name', { ascending: true });\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    const report: PaymentStatusReport = {\n      unpaidVendors: [],\n      partiallyPaidVendors: [],\n      paidVendors: [],\n      totalUnpaid: 0,\n      totalPartial: 0,\n      totalPaid: 0,\n    };\n\n    vendors.forEach((vendor) => {\n      const baseCost = parseFloat(vendor.base_cost);\n      const amountPaid = parseFloat(vendor.amount_paid);\n      const balanceDue = baseCost - amountPaid;\n\n      if (vendor.payment_status === 'unpaid') {\n        report.unpaidVendors.push({\n          id: vendor.id,\n          name: vendor.name,\n          category: vendor.category,\n          baseCost,\n        });\n        report.totalUnpaid += baseCost;\n      } else if (vendor.payment_status === 'partial') {\n        report.partiallyPaidVendors.push({\n          id: vendor.id,\n          name: vendor.name,\n          category: vendor.category,\n          baseCost,\n          amountPaid,\n          balanceDue,\n        });\n        report.totalPartial += balanceDue;\n      } else if (vendor.payment_status === 'paid') {\n        report.paidVendors.push({\n          id: vendor.id,\n          name: vendor.name,\n          category: vendor.category,\n          amountPaid,\n        });\n        report.totalPaid += amountPaid;\n      }\n    });\n\n    return {\n      success: true,\n      data: report,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Tracks all subsidies across activities and accommodations.\n * \n * @returns Result containing subsidy tracking information or error details\n */\nexport async function trackSubsidies(): Promise<Result<SubsidyTracking>> {\n  try {\n    const tracking: SubsidyTracking = {\n      activitySubsidies: [],\n      accommodationSubsidies: [],\n      totalActivitySubsidies: 0,\n      totalAccommodationSubsidies: 0,\n      grandTotalSubsidies: 0,\n    };\n\n    // Get activity subsidies\n    const { data: activities, error: activityError } = await supabase\n      .from('activities')\n      .select('id, name, host_subsidy')\n      .not('host_subsidy', 'is', null);\n\n    if (activityError) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: activityError.message,\n          details: activityError,\n        },\n      };\n    }\n\n    // Calculate activity subsidies\n    for (const activity of activities) {\n      const { count: attendeeCount, error: rsvpError } = await supabase\n        .from('rsvps')\n        .select('*', { count: 'exact', head: true })\n        .eq('activity_id', activity.id)\n        .eq('status', 'attending');\n\n      if (rsvpError) {\n        return {\n          success: false,\n          error: {\n            code: 'DATABASE_ERROR',\n            message: rsvpError.message,\n            details: rsvpError,\n          },\n        };\n      }\n\n      const estimatedAttendees = attendeeCount || 0;\n      const subsidyPerPerson = parseFloat(activity.host_subsidy);\n      const totalSubsidy = subsidyPerPerson * estimatedAttendees;\n\n      tracking.activitySubsidies.push({\n        activityId: activity.id,\n        activityName: activity.name,\n        subsidyPerPerson,\n        estimatedAttendees,\n        totalSubsidy,\n      });\n\n      tracking.totalActivitySubsidies += totalSubsidy;\n    }\n\n    // Note: Accommodation subsidies would be calculated here\n    // This requires room_types and room_assignments tables\n    tracking.accommodationSubsidies = [];\n    tracking.totalAccommodationSubsidies = 0;\n\n    tracking.grandTotalSubsidies = tracking.totalActivitySubsidies + tracking.totalAccommodationSubsidies;\n\n    return {\n      success: true,\n      data: tracking,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Generates a comprehensive budget report with all details.\n * \n * @returns Result containing complete budget breakdown or error details\n */\nexport async function generateReport(): Promise<Result<BudgetBreakdown>> {\n  // This is essentially the same as calculateTotal with all options enabled\n  return calculateTotal({\n    includeVendors: true,\n    includeActivities: true,\n    includeAccommodations: true,\n  });\n}\n"],"names":["calculateTotal","generateReport","getPaymentStatusReport","getSummary","trackSubsidies","supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","options","validation","budgetCalculationSchema","safeParse","success","error","code","message","details","issues","includeVendors","includeActivities","includeAccommodations","vendorCategories","data","breakdown","vendors","activities","totalCost","totalSubsidy","netCost","accommodations","totals","grossTotal","totalSubsidies","totalPaid","netTotal","balanceDue","vendorQuery","from","select","length","in","vendorError","vendorsByCategory","forEach","vendor","category","push","Object","entries","map","categoryVendors","categoryTotal","reduce","sum","v","parseFloat","base_cost","categoryPaid","amount_paid","categoryBalance","amountPaid","id","name","cost","paid","balance","paymentStatus","payment_status","cat","activityError","not","activity","count","attendeeCount","rsvpError","head","eq","estimatedAttendees","costPerPerson","cost_per_person","hostSubsidy","host_subsidy","Error","breakdownResult","totalVendors","countError","unpaidVendors","unpaidError","paymentProgress","totalBudget","vendorCount","unpaidVendorCount","Math","round","order","ascending","report","partiallyPaidVendors","paidVendors","totalUnpaid","totalPartial","baseCost","tracking","activitySubsidies","accommodationSubsidies","totalActivitySubsidies","totalAccommodationSubsidies","grandTotalSubsidies","subsidyPerPerson","activityId","activityName"],"mappings":"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"}