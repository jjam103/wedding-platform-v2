{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/utils/fileValidation.test.ts"],"sourcesContent":["import {\n  validateFile,\n  validateFiles,\n  sanitizeFilename,\n  generateUniqueFilename,\n  ALLOWED_FILE_TYPES,\n  MAX_FILE_SIZES,\n} from './fileValidation';\n\n// Mock File constructor for testing\nclass MockFile implements File {\n  name: string;\n  type: string;\n  size: number;\n  lastModified: number;\n  webkitRelativePath: string = '';\n\n  constructor(content: BlobPart[], name: string, options?: FilePropertyBag) {\n    this.name = name;\n    this.type = options?.type || '';\n    this.size = this.calculateSize(content);\n    this.lastModified = options?.lastModified || Date.now();\n  }\n\n  private calculateSize(content: BlobPart[]): number {\n    return content.reduce((total, part) => {\n      if (typeof part === 'string') return total + part.length;\n      if (part instanceof ArrayBuffer) return total + part.byteLength;\n      if (ArrayBuffer.isView(part)) return total + part.byteLength;\n      return total;\n    }, 0);\n  }\n\n  slice(start?: number, end?: number, contentType?: string): Blob {\n    return new Blob([], { type: contentType });\n  }\n\n  async arrayBuffer(): Promise<ArrayBuffer> {\n    return new ArrayBuffer(0);\n  }\n\n  async text(): Promise<string> {\n    return '';\n  }\n\n  async bytes(): Promise<Uint8Array<ArrayBuffer>> {\n    const buffer = await this.arrayBuffer();\n    return new Uint8Array(buffer);\n  }\n\n  stream(): ReadableStream<Uint8Array<ArrayBuffer>> {\n    return new ReadableStream();\n  }\n}\n\ndescribe('fileValidation', () => {\n  describe('validateFile', () => {\n    it('should validate a valid image file', async () => {\n      const file = new MockFile(['test content'], 'test.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result = await validateFile(file, {\n        allowedTypes: ALLOWED_FILE_TYPES.images,\n        maxSize: MAX_FILE_SIZES.image,\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.name).toBe('test.jpg');\n        expect(result.data.type).toBe('image/jpeg');\n        expect(result.data.extension).toBe('jpg');\n      }\n    });\n\n    it('should reject file with invalid type', async () => {\n      const file = new MockFile(['test content'], 'test.exe', {\n        type: 'application/x-msdownload',\n      });\n\n      const result = await validateFile(file, {\n        allowedTypes: ALLOWED_FILE_TYPES.images,\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('INVALID_FILE_TYPE');\n      }\n    });\n\n    it('should reject file that is too large', async () => {\n      const largeContent = 'x'.repeat(11 * 1024 * 1024); // 11 MB\n      const file = new MockFile([largeContent], 'large.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result = await validateFile(file, {\n        allowedTypes: ALLOWED_FILE_TYPES.images,\n        maxSize: MAX_FILE_SIZES.image, // 10 MB\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('FILE_TOO_LARGE');\n      }\n    });\n\n    it('should reject empty file', async () => {\n      const file = new MockFile([], 'empty.jpg', {\n        type: 'image/jpeg',\n      });\n\n      const result = await validateFile(file);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('EMPTY_FILE');\n      }\n    });\n\n    it('should reject file without extension', async () => {\n      const file = new MockFile(['content'], 'noextension', {\n        type: 'image/jpeg',\n      });\n\n      const result = await validateFile(file);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('MISSING_FILE_EXTENSION');\n      }\n    });\n\n    it('should reject file with mismatched extension', async () => {\n      const file = new MockFile(['content'], 'test.png', {\n        type: 'image/jpeg',\n      });\n\n      const result = await validateFile(file, {\n        allowedTypes: ALLOWED_FILE_TYPES.images,\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('EXTENSION_MISMATCH');\n      }\n    });\n\n    it('should validate PDF document', async () => {\n      const file = new MockFile(['PDF content'], 'document.pdf', {\n        type: 'application/pdf',\n      });\n\n      const result = await validateFile(file, {\n        allowedTypes: ALLOWED_FILE_TYPES.documents,\n        maxSize: MAX_FILE_SIZES.document,\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.extension).toBe('pdf');\n      }\n    });\n  });\n\n  describe('validateFiles', () => {\n    it('should validate multiple valid files', async () => {\n      const files = [\n        new MockFile(['content1'], 'file1.jpg', { type: 'image/jpeg' }),\n        new MockFile(['content2'], 'file2.png', { type: 'image/png' }),\n      ];\n\n      const result = await validateFiles(files, {\n        allowedTypes: ALLOWED_FILE_TYPES.images,\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data).toHaveLength(2);\n      }\n    });\n\n    it('should return errors for invalid files', async () => {\n      const files = [\n        new MockFile(['content1'], 'file1.jpg', { type: 'image/jpeg' }),\n        new MockFile(['content2'], 'file2.exe', { type: 'application/x-msdownload' }),\n      ];\n\n      const result = await validateFiles(files, {\n        allowedTypes: ALLOWED_FILE_TYPES.images,\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERRORS');\n        expect(result.error.details).toBeDefined();\n      }\n    });\n\n    it('should reject empty file array', async () => {\n      const result = await validateFiles([]);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('NO_FILES');\n      }\n    });\n  });\n\n  describe('sanitizeFilename', () => {\n    it('should remove path separators', () => {\n      expect(sanitizeFilename('../../../etc/passwd')).toBe('_.._.._etc_passwd');\n    });\n\n    it('should remove null bytes', () => {\n      expect(sanitizeFilename('file\\0name.jpg')).toBe('file_name.jpg');\n    });\n\n    it('should remove leading dots', () => {\n      expect(sanitizeFilename('...hidden.txt')).toBe('hidden.txt');\n    });\n\n    it('should limit filename length', () => {\n      const longName = 'a'.repeat(300) + '.jpg';\n      const sanitized = sanitizeFilename(longName);\n      expect(sanitized.length).toBeLessThanOrEqual(255);\n      expect(sanitized.endsWith('.jpg')).toBe(true);\n    });\n\n    it('should handle empty filename', () => {\n      expect(sanitizeFilename('')).toBe('file');\n      expect(sanitizeFilename('   ')).toBe('file');\n    });\n\n    it('should preserve valid filenames', () => {\n      expect(sanitizeFilename('valid-file_name.jpg')).toBe('valid-file_name.jpg');\n    });\n  });\n\n  describe('generateUniqueFilename', () => {\n    it('should generate unique filename with timestamp', () => {\n      const original = 'test.jpg';\n      const unique = generateUniqueFilename(original);\n\n      expect(unique).toContain('test_');\n      expect(unique).toMatch(/test_\\d+_[a-z0-9]+\\.jpg/);\n    });\n\n    it('should sanitize filename before generating unique name', () => {\n      const original = '../../../test.jpg';\n      const unique = generateUniqueFilename(original);\n\n      expect(unique).not.toContain('../');\n      expect(unique).toMatch(/_\\d+_[a-z0-9]+\\.jpg$/);\n    });\n\n    it('should preserve file extension', () => {\n      const original = 'document.pdf';\n      const unique = generateUniqueFilename(original);\n\n      expect(unique).toMatch(/\\.pdf$/);\n    });\n\n    it('should generate different names for same input', () => {\n      const original = 'test.jpg';\n      const unique1 = generateUniqueFilename(original);\n      const unique2 = generateUniqueFilename(original);\n\n      expect(unique1).not.toBe(unique2);\n    });\n  });\n});\n"],"names":["MockFile","content","name","options","webkitRelativePath","type","size","calculateSize","lastModified","Date","now","reduce","total","part","length","ArrayBuffer","byteLength","isView","slice","start","end","contentType","Blob","arrayBuffer","text","bytes","buffer","Uint8Array","stream","ReadableStream","describe","it","file","result","validateFile","allowedTypes","ALLOWED_FILE_TYPES","images","maxSize","MAX_FILE_SIZES","image","expect","success","toBe","data","extension","error","code","largeContent","repeat","documents","document","files","validateFiles","toHaveLength","details","toBeDefined","sanitizeFilename","longName","sanitized","toBeLessThanOrEqual","endsWith","original","unique","generateUniqueFilename","toContain","toMatch","not","unique1","unique2"],"mappings":"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"}