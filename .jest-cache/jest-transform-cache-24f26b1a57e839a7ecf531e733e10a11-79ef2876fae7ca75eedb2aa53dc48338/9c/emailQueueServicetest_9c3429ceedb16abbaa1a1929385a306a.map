{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/emailQueueService.test.ts"],"sourcesContent":["// Mock emailService\njest.mock('./emailService', () => ({\n  sendEmail: jest.fn(),\n}));\n\n// Mock cronService\njest.mock('./cronService', () => ({\n  executeCronJob: jest.fn().mockImplementation(async (jobType, fn) => {\n    try {\n      const result = await fn();\n      return {\n        success: true,\n        data: {\n          jobType,\n          status: 'completed',\n          itemsProcessed: result.itemsProcessed,\n          itemsFailed: result.itemsFailed,\n          durationMs: 100,\n          errors: [],\n        },\n      };\n    } catch (error) {\n      return {\n        success: false,\n        error: {\n          code: 'UNKNOWN_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        },\n      };\n    }\n  }),\n}));\n\n// Mock Supabase client creation - service creates its own client\njest.mock('@supabase/supabase-js', () => {\n  const mockFrom = jest.fn();\n  const mockSupabaseClient = {\n    from: mockFrom,\n  };\n  \n  return {\n    createClient: jest.fn(() => mockSupabaseClient),\n    // Export mockFrom so we can access it in tests\n    __mockFrom: mockFrom,\n  };\n});\n\n// Import service AFTER mocking dependencies\nimport {\n  processScheduledEmails,\n  getScheduledEmailStats,\n  retryFailedScheduledEmails,\n  cancelScheduledEmail,\n} from './emailQueueService';\n\n// Get the mocked from function\nconst { __mockFrom: mockFrom } = require('@supabase/supabase-js');\n\ndescribe('emailQueueService', () => {\n  const mockSendEmail = require('./emailService').sendEmail;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    \n    // Set up environment variables for the service\n    process.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';\n    process.env.SUPABASE_SERVICE_ROLE_KEY = 'test-service-role-key';\n    \n    // Reset Supabase mocks to default successful state\n    // Default setup for most common query patterns\n    mockFrom.mockReturnValue({\n      select: jest.fn().mockResolvedValue({ data: [], error: null }),\n      update: jest.fn().mockReturnValue({\n        eq: jest.fn().mockReturnValue({\n          eq: jest.fn().mockResolvedValue({ error: null }),\n        }),\n      }),\n    });\n  });\n\n  describe('processScheduledEmails', () => {\n    it('should return success with zero processed when no scheduled emails exist', async () => {\n      // Set up the complete mock chain for this specific test\n      mockFrom.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            lte: jest.fn().mockReturnValue({\n              order: jest.fn().mockReturnValue({\n                limit: jest.fn().mockResolvedValue({ data: [], error: null }),\n              }),\n            }),\n          }),\n        }),\n      });\n\n      const result = await processScheduledEmails();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.itemsProcessed).toBe(0);\n        expect(result.data.itemsFailed).toBe(0);\n      }\n    });\n\n    it('should return success with processed count when emails sent successfully', async () => {\n      const mockScheduledEmails = [\n        {\n          id: 'email-1',\n          recipient_email: 'guest1@example.com',\n          subject: 'RSVP Reminder',\n          html: '<p>Please RSVP</p>',\n          text: 'Please RSVP',\n          template_id: 'template-1',\n          status: 'pending',\n          scheduled_at: new Date(Date.now() - 60000).toISOString(), // 1 minute ago\n        },\n        {\n          id: 'email-2',\n          recipient_email: 'guest2@example.com',\n          subject: 'Event Update',\n          html: '<p>Event updated</p>',\n          text: 'Event updated',\n          template_id: 'template-2',\n          status: 'pending',\n          scheduled_at: new Date(Date.now() - 60000).toISOString(), // 1 minute ago\n        },\n      ];\n\n      // Handle multiple calls to supabase.from() - first call gets emails, subsequent calls update status\n      let callCount = 0;\n      mockFrom.mockImplementation((table: string) => {\n        if (table === 'scheduled_emails') {\n          callCount++;\n          if (callCount === 1) {\n            // First call - select emails\n            return {\n              select: jest.fn().mockReturnValue({\n                eq: jest.fn().mockReturnValue({\n                  lte: jest.fn().mockReturnValue({\n                    order: jest.fn().mockReturnValue({\n                      limit: jest.fn().mockResolvedValue({ data: mockScheduledEmails, error: null }),\n                    }),\n                  }),\n                }),\n              }),\n            };\n          } else {\n            // Subsequent calls - updates\n            return {\n              update: jest.fn().mockReturnValue({\n                eq: jest.fn().mockResolvedValue({ error: null }),\n              }),\n            };\n          }\n        }\n        return {};\n      });\n\n      mockSendEmail.mockResolvedValue({\n        success: true,\n        data: { id: 'sent-email-id' },\n      });\n\n      const result = await processScheduledEmails();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.itemsProcessed).toBe(2);\n        expect(result.data.itemsFailed).toBe(0);\n      }\n      expect(mockSendEmail).toHaveBeenCalledTimes(2);\n    });\n\n    it('should handle email sending failures and mark emails as failed', async () => {\n      const mockScheduledEmails = [\n        {\n          id: 'email-1',\n          recipient_email: 'guest1@example.com',\n          subject: 'RSVP Reminder',\n          html: '<p>Please RSVP</p>',\n          text: 'Please RSVP',\n          template_id: 'template-1',\n        },\n      ];\n\n      // Handle multiple calls to supabase.from()\n      let callCount = 0;\n      mockFrom.mockImplementation((table: string) => {\n        if (table === 'scheduled_emails') {\n          callCount++;\n          if (callCount === 1) {\n            // First call - select emails\n            return {\n              select: jest.fn().mockReturnValue({\n                eq: jest.fn().mockReturnValue({\n                  lte: jest.fn().mockReturnValue({\n                    order: jest.fn().mockReturnValue({\n                      limit: jest.fn().mockResolvedValue({ data: mockScheduledEmails, error: null }),\n                    }),\n                  }),\n                }),\n              }),\n            };\n          } else {\n            // Subsequent calls - updates\n            return {\n              update: jest.fn().mockReturnValue({\n                eq: jest.fn().mockResolvedValue({ error: null }),\n              }),\n            };\n          }\n        }\n        return {};\n      });\n\n      mockSendEmail.mockResolvedValue({\n        success: false,\n        error: { message: 'Email service error' },\n      });\n\n      const result = await processScheduledEmails();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.itemsProcessed).toBe(0);\n        expect(result.data.itemsFailed).toBe(1);\n      }\n    });\n\n    it('should handle exceptions during email processing', async () => {\n      const mockScheduledEmails = [\n        {\n          id: 'email-1',\n          recipient_email: 'guest1@example.com',\n          subject: 'RSVP Reminder',\n          html: '<p>Please RSVP</p>',\n          text: 'Please RSVP',\n          template_id: 'template-1',\n        },\n      ];\n\n      // Handle multiple calls to supabase.from()\n      let callCount = 0;\n      mockFrom.mockImplementation((table: string) => {\n        if (table === 'scheduled_emails') {\n          callCount++;\n          if (callCount === 1) {\n            // First call - select emails\n            return {\n              select: jest.fn().mockReturnValue({\n                eq: jest.fn().mockReturnValue({\n                  lte: jest.fn().mockReturnValue({\n                    order: jest.fn().mockReturnValue({\n                      limit: jest.fn().mockResolvedValue({ data: mockScheduledEmails, error: null }),\n                    }),\n                  }),\n                }),\n              }),\n            };\n          } else {\n            // Subsequent calls - updates\n            return {\n              update: jest.fn().mockReturnValue({\n                eq: jest.fn().mockResolvedValue({ error: null }),\n              }),\n            };\n          }\n        }\n        return {};\n      });\n\n      mockSendEmail.mockRejectedValue(new Error('Unexpected error'));\n\n      const result = await processScheduledEmails();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.itemsProcessed).toBe(0);\n        expect(result.data.itemsFailed).toBe(1);\n      }\n    });\n\n    it('should throw error when fetching scheduled emails fails', async () => {\n      // Set up the mock chain to return an error\n      mockFrom.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            lte: jest.fn().mockReturnValue({\n              order: jest.fn().mockReturnValue({\n                limit: jest.fn().mockResolvedValue({ data: null, error: { message: 'Database error' } }),\n              }),\n            }),\n          }),\n        }),\n      });\n\n      const result = await processScheduledEmails();\n\n      // The executeCronJob mock should catch the error and return a failed result\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('UNKNOWN_ERROR');\n      }\n    });\n  });\n\n  describe('getScheduledEmailStats', () => {\n    it('should return success with email statistics when emails exist', async () => {\n      const mockEmails = [\n        { status: 'pending' },\n        { status: 'pending' },\n        { status: 'processing' },\n        { status: 'sent' },\n        { status: 'sent' },\n        { status: 'sent' },\n        { status: 'failed' },\n      ];\n\n      // Set up the complete mock chain for this specific test\n      mockFrom.mockReturnValue({\n        select: jest.fn().mockResolvedValue({\n          data: mockEmails,\n          error: null,\n        }),\n      });\n\n      const result = await getScheduledEmailStats();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.pending).toBe(2);\n        expect(result.data.processing).toBe(1);\n        expect(result.data.sent).toBe(3);\n        expect(result.data.failed).toBe(1);\n        expect(result.data.total).toBe(7);\n      }\n    });\n\n    it('should return success with zero stats when no emails exist', async () => {\n      // Set up the complete mock chain for this specific test\n      const mockSelect = jest.fn().mockResolvedValue({\n        data: [],\n        error: null,\n      });\n      \n      mockFrom.mockReturnValue({\n        select: mockSelect,\n      });\n\n      const result = await getScheduledEmailStats();\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.pending).toBe(0);\n        expect(result.data.processing).toBe(0);\n        expect(result.data.sent).toBe(0);\n        expect(result.data.failed).toBe(0);\n        expect(result.data.total).toBe(0);\n      }\n    });\n\n    it('should return DATABASE_ERROR when query fails', async () => {\n      // Set up the complete mock chain for this specific test\n      mockFrom.mockReturnValue({\n        select: jest.fn().mockResolvedValue({\n          data: null,\n          error: { message: 'Query failed' },\n        }),\n      });\n\n      const result = await getScheduledEmailStats();\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n\n    it('should return UNKNOWN_ERROR when unexpected error occurs', async () => {\n      // Set up the mock to throw an error\n      mockFrom.mockImplementation(() => {\n        throw new Error('Unexpected error');\n      });\n\n      const result = await getScheduledEmailStats();\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('UNKNOWN_ERROR');\n      }\n    });\n  });\n\n  describe('retryFailedScheduledEmails', () => {\n    it('should return success with retry count when failed emails retried', async () => {\n      const mockFailedEmails = [\n        {\n          id: 'email-1',\n          retry_count: 1,\n        },\n        {\n          id: 'email-2',\n          retry_count: null,\n        },\n      ];\n\n      // Handle multiple calls to supabase.from() - first call gets emails, subsequent calls update\n      let callCount = 0;\n      mockFrom.mockImplementation((table: string) => {\n        if (table === 'scheduled_emails') {\n          callCount++;\n          if (callCount === 1) {\n            // First call - select failed emails\n            return {\n              select: jest.fn().mockReturnValue({\n                eq: jest.fn().mockReturnValue({\n                  or: jest.fn().mockReturnValue({\n                    limit: jest.fn().mockResolvedValue({ data: mockFailedEmails, error: null }),\n                  }),\n                }),\n              }),\n            };\n          } else {\n            // Subsequent calls - updates\n            return {\n              update: jest.fn().mockReturnValue({\n                eq: jest.fn().mockResolvedValue({ error: null }),\n              }),\n            };\n          }\n        }\n        return {};\n      });\n\n      const result = await retryFailedScheduledEmails(3);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.retried).toBe(2);\n        expect(result.data.failed).toBe(0);\n      }\n    });\n\n    it('should return success with zero count when no failed emails exist', async () => {\n      // Set up the complete mock chain for this specific test\n      mockFrom.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            or: jest.fn().mockReturnValue({\n              limit: jest.fn().mockResolvedValue({ data: [], error: null }),\n            }),\n          }),\n        }),\n      });\n\n      const result = await retryFailedScheduledEmails(3);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.retried).toBe(0);\n        expect(result.data.failed).toBe(0);\n      }\n    });\n\n    it('should return DATABASE_ERROR when fetching failed emails fails', async () => {\n      // Set up the mock chain to return an error\n      mockFrom.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            or: jest.fn().mockReturnValue({\n              limit: jest.fn().mockResolvedValue({ data: null, error: { message: 'Query failed' } }),\n            }),\n          }),\n        }),\n      });\n\n      const result = await retryFailedScheduledEmails(3);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n\n    it('should return success with zero count when no data returned', async () => {\n      // Set up the mock chain to return null data but no error\n      mockFrom.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            or: jest.fn().mockReturnValue({\n              limit: jest.fn().mockResolvedValue({ data: null, error: null }),\n            }),\n          }),\n        }),\n      });\n\n      const result = await retryFailedScheduledEmails(3);\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.retried).toBe(0);\n        expect(result.data.failed).toBe(0);\n      }\n    });\n\n    it('should return UNKNOWN_ERROR when unexpected error occurs', async () => {\n      // Set up the mock to throw an error\n      mockFrom.mockImplementation(() => {\n        throw new Error('Unexpected error');\n      });\n\n      const result = await retryFailedScheduledEmails(3);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('UNKNOWN_ERROR');\n      }\n    });\n  });\n\n  describe('cancelScheduledEmail', () => {\n    it('should return success when email cancelled successfully', async () => {\n      // Set up the complete mock chain for this specific test\n      mockFrom.mockReturnValue({\n        update: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            eq: jest.fn().mockResolvedValue({ error: null }),\n          }),\n        }),\n      });\n\n      const result = await cancelScheduledEmail('email-123');\n\n      expect(result.success).toBe(true);\n    });\n\n    it('should return DATABASE_ERROR when update fails', async () => {\n      // Set up the mock chain to return an error\n      mockFrom.mockReturnValue({\n        update: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            eq: jest.fn().mockResolvedValue({ error: { message: 'Update failed' } }),\n          }),\n        }),\n      });\n\n      const result = await cancelScheduledEmail('email-123');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n\n    it('should return UNKNOWN_ERROR when unexpected error occurs', async () => {\n      // Set up the mock to throw an error\n      mockFrom.mockImplementation(() => {\n        throw new Error('Unexpected error');\n      });\n\n      const result = await cancelScheduledEmail('email-123');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('UNKNOWN_ERROR');\n      }\n    });\n  });\n});"],"names":["jest","mock","sendEmail","fn","executeCronJob","mockImplementation","jobType","result","success","data","status","itemsProcessed","itemsFailed","durationMs","errors","error","code","message","Error","mockFrom","mockSupabaseClient","from","createClient","__mockFrom","require","describe","mockSendEmail","beforeEach","clearAllMocks","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","mockReturnValue","select","mockResolvedValue","update","eq","it","lte","order","limit","processScheduledEmails","expect","toBe","mockScheduledEmails","id","recipient_email","subject","html","text","template_id","scheduled_at","Date","now","toISOString","callCount","table","toHaveBeenCalledTimes","mockRejectedValue","mockEmails","getScheduledEmailStats","pending","processing","sent","failed","total","mockSelect","mockFailedEmails","retry_count","or","retryFailedScheduledEmails","retried","cancelScheduledEmail"],"mappings":"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"}