{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/guestEngagementService.ts"],"sourcesContent":["/**\n * Guest Engagement Service\n * \n * Tracks guest engagement metrics including portal logins, photo uploads,\n * and email interactions.\n * \n * Requirements: 15.4, 12.4\n */\n\nimport { createClient } from '@supabase/supabase-js';\nimport type { Result } from '@/types';\nimport { ERROR_CODES } from '@/types';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\nconst supabase = createClient(supabaseUrl, supabaseKey);\n\n/**\n * Portal login statistics.\n */\nexport interface PortalLoginStats {\n  totalGuests: number;\n  guestsWithLogins: number;\n  loginRate: number; // Percentage (0-100)\n  totalLogins: number;\n  averageLoginsPerGuest: number;\n  recentLogins: Array<{\n    guestId: string;\n    guestName: string;\n    lastLogin: string;\n    loginCount: number;\n  }>;\n}\n\n/**\n * Photo upload statistics.\n */\nexport interface PhotoUploadStats {\n  totalPhotos: number;\n  photosByStatus: {\n    pending: number;\n    approved: number;\n    rejected: number;\n  };\n  guestsWhoUploaded: number;\n  uploadRate: number; // Percentage of guests who uploaded (0-100)\n  topContributors: Array<{\n    guestId: string;\n    guestName: string;\n    photoCount: number;\n  }>;\n  uploadsByDate: Array<{\n    date: string;\n    count: number;\n  }>;\n}\n\n/**\n * Email engagement statistics.\n */\nexport interface EmailEngagementStats {\n  totalEmailsSent: number;\n  emailsDelivered: number;\n  emailsFailed: number;\n  deliveryRate: number; // Percentage (0-100)\n  emailsByStatus: {\n    queued: number;\n    sent: number;\n    delivered: number;\n    failed: number;\n    bounced: number;\n  };\n  recentEmails: Array<{\n    recipientEmail: string;\n    subject: string;\n    deliveryStatus: string;\n    sentAt: string;\n  }>;\n}\n\n/**\n * Comprehensive guest engagement report.\n */\nexport interface GuestEngagementReport {\n  portalLogins: PortalLoginStats;\n  photoUploads: PhotoUploadStats;\n  emailEngagement: EmailEngagementStats;\n  summary: {\n    overallEngagementRate: number; // Percentage (0-100)\n    activeGuests: number; // Guests with any engagement activity\n    inactiveGuests: number; // Guests with no engagement\n  };\n}\n\n/**\n * Tracks portal login frequency for guests.\n * \n * @param daysBack - Number of days to look back for login data (default: 30)\n * @returns Result containing portal login statistics or error details\n * \n * Requirements: 15.4\n */\nexport async function trackPortalLogins(daysBack: number = 30): Promise<Result<PortalLoginStats>> {\n  try {\n    // Get total guest count\n    const { count: totalGuests, error: guestCountError } = await supabase\n      .from('guests')\n      .select('*', { count: 'exact', head: true });\n\n    if (guestCountError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: guestCountError.message,\n          details: guestCountError,\n        },\n      };\n    }\n\n    // Get users (guests with accounts) and their login data\n    const cutoffDate = new Date();\n    cutoffDate.setDate(cutoffDate.getDate() - daysBack);\n\n    const { data: users, error: userError } = await supabase\n      .from('users')\n      .select('id, email, last_login')\n      .eq('role', 'guest')\n      .gte('last_login', cutoffDate.toISOString());\n\n    if (userError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: userError.message,\n          details: userError,\n        },\n      };\n    }\n\n    const guestsWithLogins = users.length;\n    const loginRate = totalGuests && totalGuests > 0 ? (guestsWithLogins / totalGuests) * 100 : 0;\n\n    // For a more accurate login count, we would need an audit log or login history table\n    // For now, we'll use the count of users with recent logins as a proxy\n    const totalLogins = guestsWithLogins; // Simplified - would be sum of all login events\n    const averageLoginsPerGuest = guestsWithLogins > 0 ? totalLogins / guestsWithLogins : 0;\n\n    // Get guest details for recent logins\n    const recentLogins = [];\n    for (const user of users.slice(0, 10)) { // Top 10 most recent\n      const { data: guest, error: guestError } = await supabase\n        .from('guests')\n        .select('id, first_name, last_name')\n        .eq('email', user.email)\n        .single();\n\n      if (!guestError && guest) {\n        recentLogins.push({\n          guestId: guest.id,\n          guestName: `${guest.first_name} ${guest.last_name}`,\n          lastLogin: user.last_login || '',\n          loginCount: 1, // Simplified - would come from audit log\n        });\n      }\n    }\n\n    return {\n      success: true,\n      data: {\n        totalGuests: totalGuests || 0,\n        guestsWithLogins,\n        loginRate: Math.round(loginRate * 100) / 100,\n        totalLogins,\n        averageLoginsPerGuest: Math.round(averageLoginsPerGuest * 100) / 100,\n        recentLogins,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Tracks photo upload statistics.\n * \n * @param daysBack - Number of days to look back for photo data (default: 30)\n * @returns Result containing photo upload statistics or error details\n * \n * Requirements: 15.4\n */\nexport async function trackPhotoUploads(daysBack: number = 30): Promise<Result<PhotoUploadStats>> {\n  try {\n    const cutoffDate = new Date();\n    cutoffDate.setDate(cutoffDate.getDate() - daysBack);\n\n    // Get all photos within the time period\n    const { data: photos, error: photoError } = await supabase\n      .from('photos')\n      .select('id, uploader_id, moderation_status, created_at')\n      .gte('created_at', cutoffDate.toISOString());\n\n    if (photoError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: photoError.message,\n          details: photoError,\n        },\n      };\n    }\n\n    const totalPhotos = photos.length;\n\n    // Count by status\n    const photosByStatus = {\n      pending: photos.filter(p => p.moderation_status === 'pending').length,\n      approved: photos.filter(p => p.moderation_status === 'approved').length,\n      rejected: photos.filter(p => p.moderation_status === 'rejected').length,\n    };\n\n    // Get unique uploaders\n    const uniqueUploaders = new Set(photos.map(p => p.uploader_id));\n    const guestsWhoUploaded = uniqueUploaders.size;\n\n    // Get total guest count for upload rate\n    const { count: totalGuests, error: guestCountError } = await supabase\n      .from('guests')\n      .select('*', { count: 'exact', head: true });\n\n    if (guestCountError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: guestCountError.message,\n          details: guestCountError,\n        },\n      };\n    }\n\n    const uploadRate = totalGuests && totalGuests > 0 ? (guestsWhoUploaded / totalGuests) * 100 : 0;\n\n    // Calculate top contributors\n    const uploaderCounts = new Map<string, number>();\n    photos.forEach(photo => {\n      uploaderCounts.set(photo.uploader_id, (uploaderCounts.get(photo.uploader_id) || 0) + 1);\n    });\n\n    const topContributorIds = Array.from(uploaderCounts.entries())\n      .sort((a, b) => b[1] - a[1])\n      .slice(0, 10)\n      .map(([id]) => id);\n\n    // Get user details for top contributors\n    const topContributors = [];\n    for (const uploaderId of topContributorIds) {\n      const { data: user, error: userError } = await supabase\n        .from('users')\n        .select('email')\n        .eq('id', uploaderId)\n        .single();\n\n      if (!userError && user) {\n        const { data: guest, error: guestError } = await supabase\n          .from('guests')\n          .select('id, first_name, last_name')\n          .eq('email', user.email)\n          .single();\n\n        if (!guestError && guest) {\n          topContributors.push({\n            guestId: guest.id,\n            guestName: `${guest.first_name} ${guest.last_name}`,\n            photoCount: uploaderCounts.get(uploaderId) || 0,\n          });\n        }\n      }\n    }\n\n    // Group uploads by date\n    const uploadsByDate = new Map<string, number>();\n    photos.forEach(photo => {\n      const date = photo.created_at.split('T')[0]; // Get date part only\n      uploadsByDate.set(date, (uploadsByDate.get(date) || 0) + 1);\n    });\n\n    const uploadsByDateArray = Array.from(uploadsByDate.entries())\n      .map(([date, count]) => ({ date, count }))\n      .sort((a, b) => a.date.localeCompare(b.date));\n\n    return {\n      success: true,\n      data: {\n        totalPhotos,\n        photosByStatus,\n        guestsWhoUploaded,\n        uploadRate: Math.round(uploadRate * 100) / 100,\n        topContributors,\n        uploadsByDate: uploadsByDateArray,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Tracks email open rates and engagement.\n * \n * @param daysBack - Number of days to look back for email data (default: 30)\n * @returns Result containing email engagement statistics or error details\n * \n * Requirements: 15.4, 12.4\n */\nexport async function trackEmailEngagement(daysBack: number = 30): Promise<Result<EmailEngagementStats>> {\n  try {\n    const cutoffDate = new Date();\n    cutoffDate.setDate(cutoffDate.getDate() - daysBack);\n\n    // Get all emails within the time period\n    const { data: emails, error: emailError } = await supabase\n      .from('email_logs')\n      .select('id, recipient_email, subject, delivery_status, sent_at')\n      .gte('created_at', cutoffDate.toISOString());\n\n    if (emailError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: emailError.message,\n          details: emailError,\n        },\n      };\n    }\n\n    const totalEmailsSent = emails.length;\n\n    // Count by status\n    const emailsByStatus = {\n      queued: emails.filter(e => e.delivery_status === 'queued').length,\n      sent: emails.filter(e => e.delivery_status === 'sent').length,\n      delivered: emails.filter(e => e.delivery_status === 'delivered').length,\n      failed: emails.filter(e => e.delivery_status === 'failed').length,\n      bounced: emails.filter(e => e.delivery_status === 'bounced').length,\n    };\n\n    const emailsDelivered = emailsByStatus.delivered;\n    const emailsFailed = emailsByStatus.failed + emailsByStatus.bounced;\n    const deliveryRate = totalEmailsSent > 0 ? (emailsDelivered / totalEmailsSent) * 100 : 0;\n\n    // Get recent emails\n    const recentEmails = emails\n      .filter(e => e.sent_at)\n      .sort((a, b) => new Date(b.sent_at!).getTime() - new Date(a.sent_at!).getTime())\n      .slice(0, 10)\n      .map(e => ({\n        recipientEmail: e.recipient_email,\n        subject: e.subject,\n        deliveryStatus: e.delivery_status,\n        sentAt: e.sent_at || '',\n      }));\n\n    return {\n      success: true,\n      data: {\n        totalEmailsSent,\n        emailsDelivered,\n        emailsFailed,\n        deliveryRate: Math.round(deliveryRate * 100) / 100,\n        emailsByStatus,\n        recentEmails,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Generates comprehensive guest engagement report.\n * \n * @param daysBack - Number of days to look back for engagement data (default: 30)\n * @returns Result containing complete engagement report or error details\n * \n * Requirements: 15.4, 12.4\n */\nexport async function getGuestEngagementReport(daysBack: number = 30): Promise<Result<GuestEngagementReport>> {\n  try {\n    // Get all engagement metrics\n    const [loginResult, photoResult, emailResult] = await Promise.all([\n      trackPortalLogins(daysBack),\n      trackPhotoUploads(daysBack),\n      trackEmailEngagement(daysBack),\n    ]);\n\n    if (!loginResult.success) {\n      return loginResult as Result<GuestEngagementReport>;\n    }\n    if (!photoResult.success) {\n      return photoResult as Result<GuestEngagementReport>;\n    }\n    if (!emailResult.success) {\n      return emailResult as Result<GuestEngagementReport>;\n    }\n\n    const portalLogins = loginResult.data;\n    const photoUploads = photoResult.data;\n    const emailEngagement = emailResult.data;\n\n    // Calculate overall engagement\n    const totalGuests = portalLogins.totalGuests;\n    const guestsWithLogins = portalLogins.guestsWithLogins;\n    const guestsWhoUploaded = photoUploads.guestsWhoUploaded;\n\n    // Count unique active guests (logged in OR uploaded photos)\n    const activeGuestsSet = new Set<string>();\n    \n    // Add guests who logged in\n    portalLogins.recentLogins.forEach(login => activeGuestsSet.add(login.guestId));\n    \n    // Add guests who uploaded photos\n    photoUploads.topContributors.forEach(contributor => activeGuestsSet.add(contributor.guestId));\n\n    const activeGuests = activeGuestsSet.size;\n    const inactiveGuests = totalGuests - activeGuests;\n\n    // Calculate overall engagement rate\n    const overallEngagementRate = totalGuests > 0 ? (activeGuests / totalGuests) * 100 : 0;\n\n    return {\n      success: true,\n      data: {\n        portalLogins,\n        photoUploads,\n        emailEngagement,\n        summary: {\n          overallEngagementRate: Math.round(overallEngagementRate * 100) / 100,\n          activeGuests,\n          inactiveGuests,\n        },\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n"],"names":["getGuestEngagementReport","trackEmailEngagement","trackPhotoUploads","trackPortalLogins","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","supabaseKey","NEXT_PUBLIC_SUPABASE_ANON_KEY","supabase","createClient","daysBack","count","totalGuests","error","guestCountError","from","select","head","success","code","ERROR_CODES","DATABASE_ERROR","message","details","cutoffDate","Date","setDate","getDate","data","users","userError","eq","gte","toISOString","guestsWithLogins","length","loginRate","totalLogins","averageLoginsPerGuest","recentLogins","user","slice","guest","guestError","email","single","push","guestId","id","guestName","first_name","last_name","lastLogin","last_login","loginCount","Math","round","UNKNOWN_ERROR","Error","photos","photoError","totalPhotos","photosByStatus","pending","filter","p","moderation_status","approved","rejected","uniqueUploaders","Set","map","uploader_id","guestsWhoUploaded","size","uploadRate","uploaderCounts","Map","forEach","photo","set","get","topContributorIds","Array","entries","sort","a","b","topContributors","uploaderId","photoCount","uploadsByDate","date","created_at","split","uploadsByDateArray","localeCompare","emails","emailError","totalEmailsSent","emailsByStatus","queued","e","delivery_status","sent","delivered","failed","bounced","emailsDelivered","emailsFailed","deliveryRate","recentEmails","sent_at","getTime","recipientEmail","recipient_email","subject","deliveryStatus","sentAt","loginResult","photoResult","emailResult","Promise","all","portalLogins","photoUploads","emailEngagement","activeGuestsSet","login","add","contributor","activeGuests","inactiveGuests","overallEngagementRate","summary"],"mappings":"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"}