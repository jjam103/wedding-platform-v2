{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/guestService.property.test.ts"],"sourcesContent":["import { describe, it, expect, jest, beforeEach } from '@jest/globals';\nimport * as fc from 'fast-check';\nimport type { CreateGuestDTO } from '@/schemas/guestSchemas';\n\n// Mock Supabase before importing guestService\nconst mockFrom = jest.fn();\njest.mock('@/lib/supabase', () => ({\n  supabase: {\n    from: mockFrom,\n  },\n}));\n\n// Import after mocking\nimport * as guestService from './guestService';\n\n/**\n * Feature: destination-wedding-platform, Property 5: Guest Input Validation\n * \n * For any guest data where first name, last name, or group ID is missing,\n * or where email is syntactically invalid, the system should reject the\n * creation/update and return a validation error.\n * \n * Validates: Requirements 4.16\n */\ndescribe('Feature: destination-wedding-platform, Property 5: Guest Input Validation', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n  });\n\n  // Generator for valid guest data with unique identifiers\n  const validGuestArbitrary = fc.record({\n    firstName: fc.string({ minLength: 1, maxLength: 50 })\n      .filter(s => s.trim().length > 0)\n      .map(s => `${s} ${Date.now()} ${Math.random().toString(36).substr(2, 5)}`), // Add unique suffix\n    lastName: fc.string({ minLength: 1, maxLength: 50 })\n      .filter(s => s.trim().length > 0)\n      .map(s => `${s} ${Date.now()} ${Math.random().toString(36).substr(2, 5)}`), // Add unique suffix\n    email: fc.option(fc.emailAddress().map(email => {\n      const [local, domain] = email.split('@');\n      return `${local}-${Date.now()}-${Math.random().toString(36).substr(2, 5)}@${domain}`;\n    }), { nil: null }),\n    groupId: fc.uuid(),\n    ageType: fc.constantFrom('adult', 'child', 'senior') as fc.Arbitrary<'adult' | 'child' | 'senior'>,\n    guestType: fc.string({ minLength: 1, maxLength: 50 })\n      .filter(s => s.trim().length > 0)\n      .map(s => `${s}-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`), // Add unique suffix\n  });\n\n  it('should reject guest creation when firstName is missing or empty', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        validGuestArbitrary,\n        async (validGuest) => {\n          // Test with empty string\n          const invalidGuest1 = { ...validGuest, firstName: '' };\n          const result1 = await guestService.create(invalidGuest1);\n          expect(result1.success).toBe(false);\n          if (!result1.success) {\n            expect(result1.error.code).toBe('VALIDATION_ERROR');\n          }\n\n          // Test with whitespace only\n          const invalidGuest2 = { ...validGuest, firstName: '   ' };\n          const result2 = await guestService.create(invalidGuest2);\n          expect(result2.success).toBe(false);\n          if (!result2.success) {\n            expect(result2.error.code).toBe('VALIDATION_ERROR');\n          }\n\n          // Test with missing field\n          const { firstName, ...invalidGuest3 } = validGuest;\n          const result3 = await guestService.create(invalidGuest3 as CreateGuestDTO);\n          expect(result3.success).toBe(false);\n          if (!result3.success) {\n            expect(result3.error.code).toBe('VALIDATION_ERROR');\n          }\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should reject guest creation when lastName is missing or empty', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        validGuestArbitrary,\n        async (validGuest) => {\n          // Test with empty string\n          const invalidGuest1 = { ...validGuest, lastName: '' };\n          const result1 = await guestService.create(invalidGuest1);\n          expect(result1.success).toBe(false);\n          if (!result1.success) {\n            expect(result1.error.code).toBe('VALIDATION_ERROR');\n          }\n\n          // Test with whitespace only\n          const invalidGuest2 = { ...validGuest, lastName: '   ' };\n          const result2 = await guestService.create(invalidGuest2);\n          expect(result2.success).toBe(false);\n          if (!result2.success) {\n            expect(result2.error.code).toBe('VALIDATION_ERROR');\n          }\n\n          // Test with missing field\n          const { lastName, ...invalidGuest3 } = validGuest;\n          const result3 = await guestService.create(invalidGuest3 as CreateGuestDTO);\n          expect(result3.success).toBe(false);\n          if (!result3.success) {\n            expect(result3.error.code).toBe('VALIDATION_ERROR');\n          }\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should reject guest creation when groupId is missing or invalid', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        validGuestArbitrary,\n        fc.string().filter(s => !isValidUUID(s)), // Generate invalid UUIDs\n        async (validGuest, invalidUUID) => {\n          // Test with invalid UUID\n          const invalidGuest1 = { ...validGuest, groupId: invalidUUID };\n          const result1 = await guestService.create(invalidGuest1);\n          expect(result1.success).toBe(false);\n          if (!result1.success) {\n            expect(result1.error.code).toBe('VALIDATION_ERROR');\n          }\n\n          // Test with missing field\n          const { groupId, ...invalidGuest2 } = validGuest;\n          const result2 = await guestService.create(invalidGuest2 as CreateGuestDTO);\n          expect(result2.success).toBe(false);\n          if (!result2.success) {\n            expect(result2.error.code).toBe('VALIDATION_ERROR');\n          }\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should reject guest creation when email is syntactically invalid', async () => {\n    // Generator for invalid email formats\n    const invalidEmailArbitrary = fc.oneof(\n      fc.constant('not-an-email'),\n      fc.constant('missing@domain'),\n      fc.constant('@nodomain.com'),\n      fc.constant('no-at-sign.com'),\n      fc.constant('spaces in@email.com'),\n      fc.constant('double@@email.com'),\n      fc.string().filter(s => !isValidEmail(s) && s.length > 0)\n    );\n\n    await fc.assert(\n      fc.asyncProperty(\n        validGuestArbitrary,\n        invalidEmailArbitrary,\n        async (validGuest, invalidEmail) => {\n          const invalidGuest = { ...validGuest, email: invalidEmail };\n          const result = await guestService.create(invalidGuest);\n          \n          expect(result.success).toBe(false);\n          if (!result.success) {\n            expect(result.error.code).toBe('VALIDATION_ERROR');\n            expect(result.error.message).toContain('Validation failed');\n          }\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  // Note: Positive test case (valid data should succeed) is covered in unit tests\n  // Property-based tests focus on validation failures across many random inputs\n\n  it('should reject guest update when validation fails', async () => {\n    const validId = '123e4567-e89b-12d3-a456-426614174000';\n\n    await fc.assert(\n      fc.asyncProperty(\n        fc.oneof(\n          fc.record({ firstName: fc.constant('') }), // Empty firstName\n          fc.record({ firstName: fc.constant('   ') }), // Whitespace firstName\n          fc.record({ lastName: fc.constant('') }), // Empty lastName\n          fc.record({ lastName: fc.constant('   ') }), // Whitespace lastName\n          fc.record({ email: fc.constant('invalid-email') }), // Invalid email\n          fc.record({ groupId: fc.constant('not-a-uuid') }) // Invalid UUID\n        ),\n        async (invalidUpdate) => {\n          const result = await guestService.update(validId, invalidUpdate);\n          \n          expect(result.success).toBe(false);\n          if (!result.success) {\n            expect(result.error.code).toBe('VALIDATION_ERROR');\n          }\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n});\n\n/**\n * Helper function to validate UUID format.\n */\nfunction isValidUUID(uuid: string): boolean {\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n  return uuidRegex.test(uuid);\n}\n\n/**\n * Helper function to validate email format.\n */\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$/;\n  return emailRegex.test(email);\n}\n"],"names":["mockFrom","jest","fn","mock","supabase","from","describe","beforeEach","clearAllMocks","validGuestArbitrary","fc","record","firstName","string","minLength","maxLength","filter","s","trim","length","map","Date","now","Math","random","toString","substr","lastName","email","option","emailAddress","local","domain","split","nil","groupId","uuid","ageType","constantFrom","guestType","it","assert","asyncProperty","validGuest","invalidGuest1","result1","guestService","create","expect","success","toBe","error","code","invalidGuest2","result2","invalidGuest3","result3","numRuns","isValidUUID","invalidUUID","invalidEmailArbitrary","oneof","constant","isValidEmail","invalidEmail","invalidGuest","result","message","toContain","validId","invalidUpdate","update","uuidRegex","test","emailRegex"],"mappings":"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"}