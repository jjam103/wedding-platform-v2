{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/utils/referenceChecking.ts"],"sourcesContent":["/**\n * Reference Checking Utilities\n * \n * Provides functions to check for references before deletion and\n * identify dependent records that would be affected by cascade deletion.\n */\n\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nexport interface DependentRecord {\n  type: 'section' | 'column' | 'activity' | 'rsvp' | 'reference';\n  id: string;\n  name?: string;\n  count?: number;\n}\n\nexport interface ReferenceCheckResult {\n  hasReferences: boolean;\n  dependentRecords: DependentRecord[];\n  totalCount: number;\n}\n\n/**\n * Checks for references to a content page before deletion\n * \n * @param pageId - Content page ID\n * @returns Reference check result with list of dependent records\n */\nexport async function checkContentPageReferences(pageId: string): Promise<ReferenceCheckResult> {\n  const dependentRecords: DependentRecord[] = [];\n\n  // Check for sections\n  const { data: sections } = await supabase\n    .from('sections')\n    .select('id, title')\n    .eq('page_type', 'custom')\n    .eq('page_id', pageId)\n    .is('deleted_at', null);\n\n  if (sections && sections.length > 0) {\n    dependentRecords.push({\n      type: 'section',\n      id: 'sections',\n      name: 'Sections',\n      count: sections.length,\n    });\n\n    // Check for columns in those sections\n    const sectionIds = sections.map((s) => s.id);\n    const { data: columns } = await supabase\n      .from('columns')\n      .select('id')\n      .in('section_id', sectionIds)\n      .is('deleted_at', null);\n\n    if (columns && columns.length > 0) {\n      dependentRecords.push({\n        type: 'column',\n        id: 'columns',\n        name: 'Columns',\n        count: columns.length,\n      });\n    }\n  }\n\n  // Check for references in other sections\n  const { data: referencingSections } = await supabase\n    .from('sections')\n    .select('id, title, page_type, page_id')\n    .contains('content', { references: [{ type: 'content_page', id: pageId }] })\n    .is('deleted_at', null);\n\n  if (referencingSections && referencingSections.length > 0) {\n    dependentRecords.push({\n      type: 'reference',\n      id: 'references',\n      name: 'References in other pages',\n      count: referencingSections.length,\n    });\n  }\n\n  const totalCount = dependentRecords.reduce((sum, record) => sum + (record.count || 0), 0);\n\n  return {\n    hasReferences: dependentRecords.length > 0,\n    dependentRecords,\n    totalCount,\n  };\n}\n\n/**\n * Checks for references to an event before deletion\n * \n * @param eventId - Event ID\n * @returns Reference check result with list of dependent records\n */\nexport async function checkEventReferences(eventId: string): Promise<ReferenceCheckResult> {\n  const dependentRecords: DependentRecord[] = [];\n\n  // Check for activities\n  const { data: activities } = await supabase\n    .from('activities')\n    .select('id, name')\n    .eq('event_id', eventId)\n    .is('deleted_at', null);\n\n  if (activities && activities.length > 0) {\n    dependentRecords.push({\n      type: 'activity',\n      id: 'activities',\n      name: 'Activities',\n      count: activities.length,\n    });\n\n    // Check for RSVPs in those activities\n    const activityIds = activities.map((a) => a.id);\n    const { data: rsvps } = await supabase\n      .from('rsvps')\n      .select('id')\n      .in('activity_id', activityIds)\n      .is('deleted_at', null);\n\n    if (rsvps && rsvps.length > 0) {\n      dependentRecords.push({\n        type: 'rsvp',\n        id: 'rsvps',\n        name: 'RSVPs',\n        count: rsvps.length,\n      });\n    }\n  }\n\n  // Check for references in sections\n  const { data: referencingSections } = await supabase\n    .from('sections')\n    .select('id, title, page_type, page_id')\n    .contains('content', { references: [{ type: 'event', id: eventId }] })\n    .is('deleted_at', null);\n\n  if (referencingSections && referencingSections.length > 0) {\n    dependentRecords.push({\n      type: 'reference',\n      id: 'references',\n      name: 'References in pages',\n      count: referencingSections.length,\n    });\n  }\n\n  const totalCount = dependentRecords.reduce((sum, record) => sum + (record.count || 0), 0);\n\n  return {\n    hasReferences: dependentRecords.length > 0,\n    dependentRecords,\n    totalCount,\n  };\n}\n\n/**\n * Checks for references to an activity before deletion\n * \n * @param activityId - Activity ID\n * @returns Reference check result with list of dependent records\n */\nexport async function checkActivityReferences(activityId: string): Promise<ReferenceCheckResult> {\n  const dependentRecords: DependentRecord[] = [];\n\n  // Check for RSVPs\n  const { data: rsvps } = await supabase\n    .from('rsvps')\n    .select('id')\n    .eq('activity_id', activityId)\n    .is('deleted_at', null);\n\n  if (rsvps && rsvps.length > 0) {\n    dependentRecords.push({\n      type: 'rsvp',\n      id: 'rsvps',\n      name: 'RSVPs',\n      count: rsvps.length,\n    });\n  }\n\n  // Check for references in sections\n  const { data: referencingSections } = await supabase\n    .from('sections')\n    .select('id, title, page_type, page_id')\n    .contains('content', { references: [{ type: 'activity', id: activityId }] })\n    .is('deleted_at', null);\n\n  if (referencingSections && referencingSections.length > 0) {\n    dependentRecords.push({\n      type: 'reference',\n      id: 'references',\n      name: 'References in pages',\n      count: referencingSections.length,\n    });\n  }\n\n  const totalCount = dependentRecords.reduce((sum, record) => sum + (record.count || 0), 0);\n\n  return {\n    hasReferences: dependentRecords.length > 0,\n    dependentRecords,\n    totalCount,\n  };\n}\n"],"names":["checkActivityReferences","checkContentPageReferences","checkEventReferences","supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","pageId","dependentRecords","data","sections","from","select","eq","is","length","push","type","id","name","count","sectionIds","map","s","columns","in","referencingSections","contains","references","totalCount","reduce","sum","record","hasReferences","eventId","activities","activityIds","a","rsvps","activityId"],"mappings":"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"}