{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/references/search/route.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr';\nimport { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\n\ninterface SearchResult {\n  id: string;\n  name: string;\n  type: string;\n  slug?: string;\n  status?: string;\n  preview?: string;\n}\n\n/**\n * Search across multiple entity types for reference linking\n * \n * @param request - Request with query params: q (query), type (comma-separated entity types)\n * @returns Search results ordered by relevance\n */\nexport async function GET(request: Request): Promise<NextResponse> {\n  try {\n    // 1. Authenticate\n    const cookieStore = await cookies();\n    const supabase = createServerClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n      {\n        cookies: {\n          getAll() {\n            return cookieStore.getAll();\n          },\n          setAll(cookiesToSet) {\n            cookiesToSet.forEach(({ name, value }) => {\n              cookieStore.set(name, value);\n            });\n          },\n        },\n      }\n    );\n    const {\n      data: { session },\n      error: authError,\n    } = await supabase.auth.getSession();\n\n    if (authError || !session) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: { code: 'UNAUTHORIZED', message: 'Authentication required' },\n        },\n        { status: 401 }\n      );\n    }\n\n    // 2. Parse query parameters\n    const { searchParams } = new URL(request.url);\n    const query = searchParams.get('q') || '';\n    const typeParam = searchParams.get('type') || '';\n\n    if (!query.trim()) {\n      return NextResponse.json({\n        success: true,\n        data: { results: [], total: 0 },\n      });\n    }\n\n    const entityTypes = typeParam.split(',').filter(Boolean);\n    if (entityTypes.length === 0) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'At least one entity type is required',\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    // 3. Search across entity types\n    const results: SearchResult[] = [];\n    const searchPattern = `%${query.toLowerCase()}%`;\n\n    // Search events\n    if (entityTypes.includes('event')) {\n      const { data: events } = await supabase\n        .from('events')\n        .select('id, name, slug, is_active, start_time')\n        .or(`name.ilike.${searchPattern},slug.ilike.${searchPattern}`)\n        .limit(20);\n\n      if (events) {\n        results.push(\n          ...events.map((event) => ({\n            id: event.id,\n            name: event.name,\n            type: 'event',\n            slug: event.slug,\n            status: event.is_active ? 'active' : 'inactive',\n            preview: event.start_time\n              ? `${new Date(event.start_time).toLocaleDateString()} • ${\n                  event.is_active ? 'Active' : 'Inactive'\n                }`\n              : event.is_active\n              ? 'Active'\n              : 'Inactive',\n          }))\n        );\n      }\n    }\n\n    // Search activities\n    if (entityTypes.includes('activity')) {\n      const { data: activities } = await supabase\n        .from('activities')\n        .select('id, name, slug, capacity, start_time')\n        .or(`name.ilike.${searchPattern},slug.ilike.${searchPattern}`)\n        .limit(20);\n\n      if (activities) {\n        // Get RSVP counts for capacity display\n        const activityIds = activities.map((a) => a.id);\n        const { data: rsvpCounts } = await supabase\n          .from('rsvps')\n          .select('activity_id')\n          .in('activity_id', activityIds)\n          .eq('status', 'attending');\n\n        const rsvpCountMap = new Map<string, number>();\n        rsvpCounts?.forEach((rsvp) => {\n          rsvpCountMap.set(rsvp.activity_id, (rsvpCountMap.get(rsvp.activity_id) || 0) + 1);\n        });\n\n        results.push(\n          ...activities.map((activity) => {\n            const attendees = rsvpCountMap.get(activity.id) || 0;\n            const capacityText = activity.capacity\n              ? `${attendees}/${activity.capacity} capacity`\n              : `${attendees} attendees`;\n\n            return {\n              id: activity.id,\n              name: activity.name,\n              type: 'activity',\n              slug: activity.slug,\n              preview: activity.start_time\n                ? `${new Date(activity.start_time).toLocaleDateString()} • ${capacityText}`\n                : capacityText,\n            };\n          })\n        );\n      }\n    }\n\n    // Search accommodations\n    if (entityTypes.includes('accommodation')) {\n      const { data: accommodations } = await supabase\n        .from('accommodations')\n        .select('id, name, slug, check_in_date, check_out_date')\n        .or(`name.ilike.${searchPattern},slug.ilike.${searchPattern}`)\n        .limit(20);\n\n      if (accommodations) {\n        results.push(\n          ...accommodations.map((accommodation) => ({\n            id: accommodation.id,\n            name: accommodation.name,\n            type: 'accommodation',\n            slug: accommodation.slug,\n            preview:\n              accommodation.check_in_date && accommodation.check_out_date\n                ? `${new Date(accommodation.check_in_date).toLocaleDateString()} - ${new Date(\n                    accommodation.check_out_date\n                  ).toLocaleDateString()}`\n                : undefined,\n          }))\n        );\n      }\n    }\n\n    // Search room types\n    if (entityTypes.includes('room_type')) {\n      const { data: roomTypes } = await supabase\n        .from('room_types')\n        .select('id, name, accommodation_id, capacity, price_per_night, accommodations(name)')\n        .or(`name.ilike.${searchPattern}`)\n        .limit(20);\n\n      if (roomTypes) {\n        results.push(\n          ...roomTypes.map((roomType) => ({\n            id: roomType.id,\n            name: roomType.name,\n            type: 'room_type',\n            preview: `${(roomType.accommodations as any)?.name || 'Unknown'} • Capacity: ${\n              roomType.capacity\n            } • $${roomType.price_per_night}/night`,\n          }))\n        );\n      }\n    }\n\n    // Search content pages\n    if (entityTypes.includes('content_page')) {\n      const { data: pages } = await supabase\n        .from('content_pages')\n        .select('id, title, slug, status')\n        .or(`title.ilike.${searchPattern},slug.ilike.${searchPattern}`)\n        .limit(20);\n\n      if (pages) {\n        results.push(\n          ...pages.map((page) => ({\n            id: page.id,\n            name: page.title,\n            type: 'content_page',\n            slug: page.slug,\n            status: page.status,\n            preview: `${page.status === 'published' ? 'Published' : 'Draft'} • /${page.slug}`,\n          }))\n        );\n      }\n    }\n\n    // 4. Sort results by relevance (exact matches first, then partial)\n    // Add index to each result for stable sorting\n    const indexedResults = results.map((result, index) => ({ result, index }));\n    \n    indexedResults.sort((a, b) => {\n      const aExact = a.result.name.toLowerCase() === query.toLowerCase();\n      const bExact = b.result.name.toLowerCase() === query.toLowerCase();\n\n      if (aExact && !bExact) return -1;\n      if (!aExact && bExact) return 1;\n\n      // Then sort alphabetically with normalization for consistent ordering\n      // Trim whitespace for comparison\n      const aName = a.result.name.trim().toLowerCase();\n      const bName = b.result.name.trim().toLowerCase();\n      \n      // Handle empty strings after trimming - sort them to the end\n      if (aName === '' && bName !== '') return 1;\n      if (aName !== '' && bName === '') return -1;\n      \n      // Use simple string comparison for deterministic ordering\n      // This is more predictable than localeCompare for special characters\n      if (aName < bName) return -1;\n      if (aName > bName) return 1;\n      \n      // If names are equal after normalization, maintain original order (stable sort)\n      return a.index - b.index;\n    });\n    \n    const sortedResults = indexedResults.map(({ result }) => result);\n\n    // 5. Return results\n    return NextResponse.json({\n      success: true,\n      data: {\n        results: sortedResults,\n        total: sortedResults.length,\n      },\n    });\n  } catch (error) {\n    console.error('Reference search error:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'INTERNAL_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["GET","request","cookieStore","cookies","supabase","createServerClient","process","env","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","getAll","setAll","cookiesToSet","forEach","name","value","set","data","session","error","authError","auth","getSession","NextResponse","json","success","code","message","status","searchParams","URL","url","query","get","typeParam","trim","results","total","entityTypes","split","filter","Boolean","length","searchPattern","toLowerCase","includes","events","from","select","or","limit","push","map","event","id","type","slug","is_active","preview","start_time","Date","toLocaleDateString","activities","activityIds","a","rsvpCounts","in","eq","rsvpCountMap","Map","rsvp","activity_id","activity","attendees","capacityText","capacity","accommodations","accommodation","check_in_date","check_out_date","undefined","roomTypes","roomType","price_per_night","pages","page","title","indexedResults","result","index","sort","b","aExact","bExact","aName","bName","sortedResults","console","Error"],"mappings":"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"}