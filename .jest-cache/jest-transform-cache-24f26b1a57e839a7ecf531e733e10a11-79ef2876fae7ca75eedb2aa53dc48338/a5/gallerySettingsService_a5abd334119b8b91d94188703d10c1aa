78b5208641c924ebb126e73936a68f6b
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get configureGallery () {
        return configureGallery;
    },
    get deleteSettings () {
        return deleteSettings;
    },
    get getSettings () {
        return getSettings;
    },
    get updateDisplayMode () {
        return updateDisplayMode;
    },
    get updatePhotoOrder () {
        return updatePhotoOrder;
    },
    get upsertSettings () {
        return upsertSettings;
    }
});
const _cmsSchemas = require("../schemas/cmsSchemas");
// Lazy load supabase to avoid initialization issues in tests
let _supabase = null;
function getSupabase() {
    if (!_supabase) {
        const { supabase } = require('../lib/supabase');
        _supabase = supabase;
    }
    return _supabase;
}
async function getSettings(pageType, pageId) {
    try {
        const supabase = getSupabase();
        const { data, error } = await supabase.from('gallery_settings').select('*').eq('page_type', pageType).eq('page_id', pageId).single();
        if (error) {
            if (error.code === 'PGRST116') {
                // No settings found, return default settings
                return {
                    success: true,
                    data: {
                        id: '',
                        page_type: pageType,
                        page_id: pageId,
                        display_mode: 'gallery',
                        show_captions: true,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }
                };
            }
            return {
                success: false,
                error: {
                    code: 'DATABASE_ERROR',
                    message: error.message,
                    details: error
                }
            };
        }
        return {
            success: true,
            data
        };
    } catch (error) {
        return {
            success: false,
            error: {
                code: 'UNKNOWN_ERROR',
                message: error instanceof Error ? error.message : 'Unknown error'
            }
        };
    }
}
async function upsertSettings(data) {
    try {
        // 1. Validate
        const validation = _cmsSchemas.createGallerySettingsSchema.safeParse(data);
        if (!validation.success) {
            return {
                success: false,
                error: {
                    code: 'VALIDATION_ERROR',
                    message: 'Validation failed',
                    details: validation.error.issues
                }
            };
        }
        // 2. Upsert settings
        const supabase = getSupabase();
        const { data: settings, error } = await supabase.from('gallery_settings').upsert({
            page_type: validation.data.page_type,
            page_id: validation.data.page_id,
            display_mode: validation.data.display_mode,
            photos_per_row: validation.data.photos_per_row,
            show_captions: validation.data.show_captions,
            autoplay_interval: validation.data.autoplay_interval,
            transition_effect: validation.data.transition_effect
        }, {
            onConflict: 'page_type,page_id'
        }).select().single();
        if (error) {
            return {
                success: false,
                error: {
                    code: 'DATABASE_ERROR',
                    message: error.message,
                    details: error
                }
            };
        }
        return {
            success: true,
            data: settings
        };
    } catch (error) {
        return {
            success: false,
            error: {
                code: 'UNKNOWN_ERROR',
                message: error instanceof Error ? error.message : 'Unknown error'
            }
        };
    }
}
async function updateDisplayMode(pageId, mode) {
    try {
        const supabase = getSupabase();
        const { error } = await supabase.from('gallery_settings').update({
            display_mode: mode
        }).eq('page_id', pageId);
        if (error) {
            return {
                success: false,
                error: {
                    code: 'DATABASE_ERROR',
                    message: error.message,
                    details: error
                }
            };
        }
        return {
            success: true,
            data: undefined
        };
    } catch (error) {
        return {
            success: false,
            error: {
                code: 'UNKNOWN_ERROR',
                message: error instanceof Error ? error.message : 'Unknown error'
            }
        };
    }
}
async function updatePhotoOrder(pageId, photoIds) {
    try {
        const supabase = getSupabase();
        // Update display_order for each photo
        const updates = photoIds.map((photoId, index)=>supabase.from('photos').update({
                display_order: index
            }).eq('id', photoId).eq('page_id', pageId));
        const results = await Promise.all(updates);
        const errors = results.filter((r)=>r.error);
        if (errors.length > 0) {
            return {
                success: false,
                error: {
                    code: 'DATABASE_ERROR',
                    message: 'Failed to update photo order',
                    details: errors
                }
            };
        }
        return {
            success: true,
            data: undefined
        };
    } catch (error) {
        return {
            success: false,
            error: {
                code: 'UNKNOWN_ERROR',
                message: error instanceof Error ? error.message : 'Unknown error'
            }
        };
    }
}
async function configureGallery(pageId, options) {
    try {
        // Validate options
        const validation = _cmsSchemas.updateGallerySettingsSchema.safeParse(options);
        if (!validation.success) {
            return {
                success: false,
                error: {
                    code: 'VALIDATION_ERROR',
                    message: 'Validation failed',
                    details: validation.error.issues
                }
            };
        }
        const supabase = getSupabase();
        const { error } = await supabase.from('gallery_settings').update(validation.data).eq('page_id', pageId);
        if (error) {
            return {
                success: false,
                error: {
                    code: 'DATABASE_ERROR',
                    message: error.message,
                    details: error
                }
            };
        }
        return {
            success: true,
            data: undefined
        };
    } catch (error) {
        return {
            success: false,
            error: {
                code: 'UNKNOWN_ERROR',
                message: error instanceof Error ? error.message : 'Unknown error'
            }
        };
    }
}
async function deleteSettings(pageId) {
    try {
        const supabase = getSupabase();
        const { error } = await supabase.from('gallery_settings').delete().eq('page_id', pageId);
        if (error) {
            return {
                success: false,
                error: {
                    code: 'DATABASE_ERROR',
                    message: error.message,
                    details: error
                }
            };
        }
        return {
            success: true,
            data: undefined
        };
    } catch (error) {
        return {
            success: false,
            error: {
                code: 'UNKNOWN_ERROR',
                message: error instanceof Error ? error.message : 'Unknown error'
            }
        };
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9qYXJvbi9EZXNrdG9wL3dlZGRpbmctcGxhdGZvcm0tdjIvc2VydmljZXMvZ2FsbGVyeVNldHRpbmdzU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBjcmVhdGVHYWxsZXJ5U2V0dGluZ3NTY2hlbWEsXG4gIHVwZGF0ZUdhbGxlcnlTZXR0aW5nc1NjaGVtYSxcbiAgdHlwZSBDcmVhdGVHYWxsZXJ5U2V0dGluZ3NEVE8sXG4gIHR5cGUgVXBkYXRlR2FsbGVyeVNldHRpbmdzRFRPLFxuICB0eXBlIEdhbGxlcnlTZXR0aW5ncyxcbn0gZnJvbSAnLi4vc2NoZW1hcy9jbXNTY2hlbWFzJztcblxudHlwZSBSZXN1bHQ8VD4gPVxuICB8IHsgc3VjY2VzczogdHJ1ZTsgZGF0YTogVCB9XG4gIHwgeyBzdWNjZXNzOiBmYWxzZTsgZXJyb3I6IHsgY29kZTogc3RyaW5nOyBtZXNzYWdlOiBzdHJpbmc7IGRldGFpbHM/OiBhbnkgfSB9O1xuXG4vLyBMYXp5IGxvYWQgc3VwYWJhc2UgdG8gYXZvaWQgaW5pdGlhbGl6YXRpb24gaXNzdWVzIGluIHRlc3RzXG5sZXQgX3N1cGFiYXNlOiBhbnkgPSBudWxsO1xuZnVuY3Rpb24gZ2V0U3VwYWJhc2UoKSB7XG4gIGlmICghX3N1cGFiYXNlKSB7XG4gICAgY29uc3QgeyBzdXBhYmFzZSB9ID0gcmVxdWlyZSgnLi4vbGliL3N1cGFiYXNlJyk7XG4gICAgX3N1cGFiYXNlID0gc3VwYWJhc2U7XG4gIH1cbiAgcmV0dXJuIF9zdXBhYmFzZTtcbn1cblxuLyoqXG4gKiBHZXRzIGdhbGxlcnkgc2V0dGluZ3MgZm9yIGEgcGFnZVxuICogXG4gKiBAcGFyYW0gcGFnZVR5cGUgLSBUeXBlIG9mIHBhZ2UgKGFjdGl2aXR5LCBldmVudCwgYWNjb21tb2RhdGlvbiwgcm9vbV90eXBlLCBjdXN0b20sIG1lbW9yeSlcbiAqIEBwYXJhbSBwYWdlSWQgLSBQYWdlIElEXG4gKiBAcmV0dXJucyBSZXN1bHQgY29udGFpbmluZyBnYWxsZXJ5IHNldHRpbmdzIG9yIGVycm9yIGRldGFpbHNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNldHRpbmdzKHBhZ2VUeXBlOiBzdHJpbmcsIHBhZ2VJZDogc3RyaW5nKTogUHJvbWlzZTxSZXN1bHQ8R2FsbGVyeVNldHRpbmdzPj4ge1xuICB0cnkge1xuICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKTtcbiAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oJ2dhbGxlcnlfc2V0dGluZ3MnKVxuICAgICAgLnNlbGVjdCgnKicpXG4gICAgICAuZXEoJ3BhZ2VfdHlwZScsIHBhZ2VUeXBlKVxuICAgICAgLmVxKCdwYWdlX2lkJywgcGFnZUlkKVxuICAgICAgLnNpbmdsZSgpO1xuXG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBpZiAoZXJyb3IuY29kZSA9PT0gJ1BHUlNUMTE2Jykge1xuICAgICAgICAvLyBObyBzZXR0aW5ncyBmb3VuZCwgcmV0dXJuIGRlZmF1bHQgc2V0dGluZ3NcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGlkOiAnJyxcbiAgICAgICAgICAgIHBhZ2VfdHlwZTogcGFnZVR5cGUgYXMgYW55LFxuICAgICAgICAgICAgcGFnZV9pZDogcGFnZUlkLFxuICAgICAgICAgICAgZGlzcGxheV9tb2RlOiAnZ2FsbGVyeScsXG4gICAgICAgICAgICBzaG93X2NhcHRpb25zOiB0cnVlLFxuICAgICAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6ICdEQVRBQkFTRV9FUlJPUicsXG4gICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICBkZXRhaWxzOiBlcnJvcixcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgZGF0YSB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiB7XG4gICAgICAgIGNvZGU6ICdVTktOT1dOX0VSUk9SJyxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgICB9LFxuICAgIH07XG4gIH1cbn1cblxuLyoqXG4gKiBDcmVhdGVzIG9yIHVwZGF0ZXMgZ2FsbGVyeSBzZXR0aW5ncyBmb3IgYSBwYWdlXG4gKiBcbiAqIEBwYXJhbSBkYXRhIC0gR2FsbGVyeSBzZXR0aW5ncyBkYXRhXG4gKiBAcmV0dXJucyBSZXN1bHQgY29udGFpbmluZyB0aGUgY3JlYXRlZC91cGRhdGVkIHNldHRpbmdzIG9yIGVycm9yIGRldGFpbHNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwc2VydFNldHRpbmdzKGRhdGE6IENyZWF0ZUdhbGxlcnlTZXR0aW5nc0RUTyk6IFByb21pc2U8UmVzdWx0PEdhbGxlcnlTZXR0aW5ncz4+IHtcbiAgdHJ5IHtcbiAgICAvLyAxLiBWYWxpZGF0ZVxuICAgIGNvbnN0IHZhbGlkYXRpb24gPSBjcmVhdGVHYWxsZXJ5U2V0dGluZ3NTY2hlbWEuc2FmZVBhcnNlKGRhdGEpO1xuICAgIGlmICghdmFsaWRhdGlvbi5zdWNjZXNzKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICBjb2RlOiAnVkFMSURBVElPTl9FUlJPUicsXG4gICAgICAgICAgbWVzc2FnZTogJ1ZhbGlkYXRpb24gZmFpbGVkJyxcbiAgICAgICAgICBkZXRhaWxzOiB2YWxpZGF0aW9uLmVycm9yLmlzc3VlcyxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gMi4gVXBzZXJ0IHNldHRpbmdzXG4gICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZSgpO1xuICAgIGNvbnN0IHsgZGF0YTogc2V0dGluZ3MsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oJ2dhbGxlcnlfc2V0dGluZ3MnKVxuICAgICAgLnVwc2VydChcbiAgICAgICAge1xuICAgICAgICAgIHBhZ2VfdHlwZTogdmFsaWRhdGlvbi5kYXRhLnBhZ2VfdHlwZSxcbiAgICAgICAgICBwYWdlX2lkOiB2YWxpZGF0aW9uLmRhdGEucGFnZV9pZCxcbiAgICAgICAgICBkaXNwbGF5X21vZGU6IHZhbGlkYXRpb24uZGF0YS5kaXNwbGF5X21vZGUsXG4gICAgICAgICAgcGhvdG9zX3Blcl9yb3c6IHZhbGlkYXRpb24uZGF0YS5waG90b3NfcGVyX3JvdyxcbiAgICAgICAgICBzaG93X2NhcHRpb25zOiB2YWxpZGF0aW9uLmRhdGEuc2hvd19jYXB0aW9ucyxcbiAgICAgICAgICBhdXRvcGxheV9pbnRlcnZhbDogdmFsaWRhdGlvbi5kYXRhLmF1dG9wbGF5X2ludGVydmFsLFxuICAgICAgICAgIHRyYW5zaXRpb25fZWZmZWN0OiB2YWxpZGF0aW9uLmRhdGEudHJhbnNpdGlvbl9lZmZlY3QsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBvbkNvbmZsaWN0OiAncGFnZV90eXBlLHBhZ2VfaWQnLFxuICAgICAgICB9XG4gICAgICApXG4gICAgICAuc2VsZWN0KClcbiAgICAgIC5zaW5nbGUoKTtcblxuICAgIGlmIChlcnJvcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgY29kZTogJ0RBVEFCQVNFX0VSUk9SJyxcbiAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgIGRldGFpbHM6IGVycm9yLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBkYXRhOiBzZXR0aW5ncyB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiB7XG4gICAgICAgIGNvZGU6ICdVTktOT1dOX0VSUk9SJyxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgICB9LFxuICAgIH07XG4gIH1cbn1cblxuLyoqXG4gKiBVcGRhdGVzIGRpc3BsYXkgbW9kZSBmb3IgYSBnYWxsZXJ5XG4gKiBcbiAqIEBwYXJhbSBwYWdlSWQgLSBQYWdlIElEXG4gKiBAcGFyYW0gbW9kZSAtIERpc3BsYXkgbW9kZSAoZ2FsbGVyeSwgY2Fyb3VzZWwsIGxvb3ApXG4gKiBAcmV0dXJucyBSZXN1bHQgaW5kaWNhdGluZyBzdWNjZXNzIG9yIGVycm9yIGRldGFpbHNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZURpc3BsYXlNb2RlKFxuICBwYWdlSWQ6IHN0cmluZyxcbiAgbW9kZTogJ2dhbGxlcnknIHwgJ2Nhcm91c2VsJyB8ICdsb29wJ1xuKTogUHJvbWlzZTxSZXN1bHQ8dm9pZD4+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCk7XG4gICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgIC5mcm9tKCdnYWxsZXJ5X3NldHRpbmdzJylcbiAgICAgIC51cGRhdGUoeyBkaXNwbGF5X21vZGU6IG1vZGUgfSlcbiAgICAgIC5lcSgncGFnZV9pZCcsIHBhZ2VJZCk7XG5cbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6ICdEQVRBQkFTRV9FUlJPUicsXG4gICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICBkZXRhaWxzOiBlcnJvcixcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgZGF0YTogdW5kZWZpbmVkIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6IHtcbiAgICAgICAgY29kZTogJ1VOS05PV05fRVJST1InLFxuICAgICAgICBtZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxufVxuXG4vKipcbiAqIFVwZGF0ZXMgcGhvdG8gb3JkZXJpbmcgZm9yIGEgZ2FsbGVyeVxuICogXG4gKiBAcGFyYW0gcGFnZUlkIC0gUGFnZSBJRFxuICogQHBhcmFtIHBob3RvSWRzIC0gQXJyYXkgb2YgcGhvdG8gSURzIGluIGRlc2lyZWQgb3JkZXJcbiAqIEByZXR1cm5zIFJlc3VsdCBpbmRpY2F0aW5nIHN1Y2Nlc3Mgb3IgZXJyb3IgZGV0YWlsc1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlUGhvdG9PcmRlcihwYWdlSWQ6IHN0cmluZywgcGhvdG9JZHM6IHN0cmluZ1tdKTogUHJvbWlzZTxSZXN1bHQ8dm9pZD4+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCk7XG4gICAgLy8gVXBkYXRlIGRpc3BsYXlfb3JkZXIgZm9yIGVhY2ggcGhvdG9cbiAgICBjb25zdCB1cGRhdGVzID0gcGhvdG9JZHMubWFwKChwaG90b0lkLCBpbmRleCkgPT5cbiAgICAgIHN1cGFiYXNlXG4gICAgICAgIC5mcm9tKCdwaG90b3MnKVxuICAgICAgICAudXBkYXRlKHsgZGlzcGxheV9vcmRlcjogaW5kZXggfSlcbiAgICAgICAgLmVxKCdpZCcsIHBob3RvSWQpXG4gICAgICAgIC5lcSgncGFnZV9pZCcsIHBhZ2VJZClcbiAgICApO1xuXG4gICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsKHVwZGF0ZXMpO1xuICAgIGNvbnN0IGVycm9ycyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5lcnJvcik7XG5cbiAgICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6ICdEQVRBQkFTRV9FUlJPUicsXG4gICAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byB1cGRhdGUgcGhvdG8gb3JkZXInLFxuICAgICAgICAgIGRldGFpbHM6IGVycm9ycyxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgZGF0YTogdW5kZWZpbmVkIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6IHtcbiAgICAgICAgY29kZTogJ1VOS05PV05fRVJST1InLFxuICAgICAgICBtZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxufVxuXG4vKipcbiAqIENvbmZpZ3VyZXMgZ2FsbGVyeSBvcHRpb25zXG4gKiBcbiAqIEBwYXJhbSBwYWdlSWQgLSBQYWdlIElEXG4gKiBAcGFyYW0gb3B0aW9ucyAtIEdhbGxlcnkgY29uZmlndXJhdGlvbiBvcHRpb25zXG4gKiBAcmV0dXJucyBSZXN1bHQgaW5kaWNhdGluZyBzdWNjZXNzIG9yIGVycm9yIGRldGFpbHNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvbmZpZ3VyZUdhbGxlcnkoXG4gIHBhZ2VJZDogc3RyaW5nLFxuICBvcHRpb25zOiB7XG4gICAgcGhvdG9zX3Blcl9yb3c/OiBudW1iZXI7XG4gICAgc2hvd19jYXB0aW9ucz86IGJvb2xlYW47XG4gICAgYXV0b3BsYXlfaW50ZXJ2YWw/OiBudW1iZXI7XG4gICAgdHJhbnNpdGlvbl9lZmZlY3Q/OiBzdHJpbmc7XG4gIH1cbik6IFByb21pc2U8UmVzdWx0PHZvaWQ+PiB7XG4gIHRyeSB7XG4gICAgLy8gVmFsaWRhdGUgb3B0aW9uc1xuICAgIGNvbnN0IHZhbGlkYXRpb24gPSB1cGRhdGVHYWxsZXJ5U2V0dGluZ3NTY2hlbWEuc2FmZVBhcnNlKG9wdGlvbnMpO1xuICAgIGlmICghdmFsaWRhdGlvbi5zdWNjZXNzKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICBjb2RlOiAnVkFMSURBVElPTl9FUlJPUicsXG4gICAgICAgICAgbWVzc2FnZTogJ1ZhbGlkYXRpb24gZmFpbGVkJyxcbiAgICAgICAgICBkZXRhaWxzOiB2YWxpZGF0aW9uLmVycm9yLmlzc3VlcyxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZSgpO1xuICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAuZnJvbSgnZ2FsbGVyeV9zZXR0aW5ncycpXG4gICAgICAudXBkYXRlKHZhbGlkYXRpb24uZGF0YSlcbiAgICAgIC5lcSgncGFnZV9pZCcsIHBhZ2VJZCk7XG5cbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6ICdEQVRBQkFTRV9FUlJPUicsXG4gICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICBkZXRhaWxzOiBlcnJvcixcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgZGF0YTogdW5kZWZpbmVkIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6IHtcbiAgICAgICAgY29kZTogJ1VOS05PV05fRVJST1InLFxuICAgICAgICBtZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxufVxuXG4vKipcbiAqIERlbGV0ZXMgZ2FsbGVyeSBzZXR0aW5ncyBmb3IgYSBwYWdlXG4gKiBcbiAqIEBwYXJhbSBwYWdlSWQgLSBQYWdlIElEXG4gKiBAcmV0dXJucyBSZXN1bHQgaW5kaWNhdGluZyBzdWNjZXNzIG9yIGVycm9yIGRldGFpbHNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZVNldHRpbmdzKHBhZ2VJZDogc3RyaW5nKTogUHJvbWlzZTxSZXN1bHQ8dm9pZD4+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCk7XG4gICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgIC5mcm9tKCdnYWxsZXJ5X3NldHRpbmdzJylcbiAgICAgIC5kZWxldGUoKVxuICAgICAgLmVxKCdwYWdlX2lkJywgcGFnZUlkKTtcblxuICAgIGlmIChlcnJvcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgY29kZTogJ0RBVEFCQVNFX0VSUk9SJyxcbiAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgIGRldGFpbHM6IGVycm9yLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBkYXRhOiB1bmRlZmluZWQgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjoge1xuICAgICAgICBjb2RlOiAnVU5LTk9XTl9FUlJPUicsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG59XG4iXSwibmFtZXMiOlsiY29uZmlndXJlR2FsbGVyeSIsImRlbGV0ZVNldHRpbmdzIiwiZ2V0U2V0dGluZ3MiLCJ1cGRhdGVEaXNwbGF5TW9kZSIsInVwZGF0ZVBob3RvT3JkZXIiLCJ1cHNlcnRTZXR0aW5ncyIsIl9zdXBhYmFzZSIsImdldFN1cGFiYXNlIiwic3VwYWJhc2UiLCJyZXF1aXJlIiwicGFnZVR5cGUiLCJwYWdlSWQiLCJkYXRhIiwiZXJyb3IiLCJmcm9tIiwic2VsZWN0IiwiZXEiLCJzaW5nbGUiLCJjb2RlIiwic3VjY2VzcyIsImlkIiwicGFnZV90eXBlIiwicGFnZV9pZCIsImRpc3BsYXlfbW9kZSIsInNob3dfY2FwdGlvbnMiLCJjcmVhdGVkX2F0IiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwidXBkYXRlZF9hdCIsIm1lc3NhZ2UiLCJkZXRhaWxzIiwiRXJyb3IiLCJ2YWxpZGF0aW9uIiwiY3JlYXRlR2FsbGVyeVNldHRpbmdzU2NoZW1hIiwic2FmZVBhcnNlIiwiaXNzdWVzIiwic2V0dGluZ3MiLCJ1cHNlcnQiLCJwaG90b3NfcGVyX3JvdyIsImF1dG9wbGF5X2ludGVydmFsIiwidHJhbnNpdGlvbl9lZmZlY3QiLCJvbkNvbmZsaWN0IiwibW9kZSIsInVwZGF0ZSIsInVuZGVmaW5lZCIsInBob3RvSWRzIiwidXBkYXRlcyIsIm1hcCIsInBob3RvSWQiLCJpbmRleCIsImRpc3BsYXlfb3JkZXIiLCJyZXN1bHRzIiwiUHJvbWlzZSIsImFsbCIsImVycm9ycyIsImZpbHRlciIsInIiLCJsZW5ndGgiLCJvcHRpb25zIiwidXBkYXRlR2FsbGVyeVNldHRpbmdzU2NoZW1hIiwiZGVsZXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztRQTRPc0JBO2VBQUFBOztRQTBEQUM7ZUFBQUE7O1FBelFBQztlQUFBQTs7UUF5SEFDO2VBQUFBOztRQXlDQUM7ZUFBQUE7O1FBM0dBQztlQUFBQTs7OzRCQTlFZjtBQU1QLDZEQUE2RDtBQUM3RCxJQUFJQyxZQUFpQjtBQUNyQixTQUFTQztJQUNQLElBQUksQ0FBQ0QsV0FBVztRQUNkLE1BQU0sRUFBRUUsUUFBUSxFQUFFLEdBQUdDLFFBQVE7UUFDN0JILFlBQVlFO0lBQ2Q7SUFDQSxPQUFPRjtBQUNUO0FBU08sZUFBZUosWUFBWVEsUUFBZ0IsRUFBRUMsTUFBYztJQUNoRSxJQUFJO1FBQ0YsTUFBTUgsV0FBV0Q7UUFDakIsTUFBTSxFQUFFSyxJQUFJLEVBQUVDLEtBQUssRUFBRSxHQUFHLE1BQU1MLFNBQzNCTSxJQUFJLENBQUMsb0JBQ0xDLE1BQU0sQ0FBQyxLQUNQQyxFQUFFLENBQUMsYUFBYU4sVUFDaEJNLEVBQUUsQ0FBQyxXQUFXTCxRQUNkTSxNQUFNO1FBRVQsSUFBSUosT0FBTztZQUNULElBQUlBLE1BQU1LLElBQUksS0FBSyxZQUFZO2dCQUM3Qiw2Q0FBNkM7Z0JBQzdDLE9BQU87b0JBQ0xDLFNBQVM7b0JBQ1RQLE1BQU07d0JBQ0pRLElBQUk7d0JBQ0pDLFdBQVdYO3dCQUNYWSxTQUFTWDt3QkFDVFksY0FBYzt3QkFDZEMsZUFBZTt3QkFDZkMsWUFBWSxJQUFJQyxPQUFPQyxXQUFXO3dCQUNsQ0MsWUFBWSxJQUFJRixPQUFPQyxXQUFXO29CQUNwQztnQkFDRjtZQUNGO1lBRUEsT0FBTztnQkFDTFIsU0FBUztnQkFDVE4sT0FBTztvQkFDTEssTUFBTTtvQkFDTlcsU0FBU2hCLE1BQU1nQixPQUFPO29CQUN0QkMsU0FB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