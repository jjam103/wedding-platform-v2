{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/softDeleteRestoration.property.test.ts"],"sourcesContent":["/**\n * Property-Based Test: Soft Delete Restoration\n * Feature: guest-portal-and-admin-enhancements\n * Property 33: Soft Delete Restoration\n * \n * Validates: Requirements 29.9\n * \n * Property: Restored records must have deleted_at set to NULL and must be\n * accessible in guest-facing queries again.\n */\n\nimport * as fc from 'fast-check';\nimport { createContentPage, deleteContentPage, restoreContentPage } from './contentPagesService';\nimport { create as createEvent, deleteEvent, restoreEvent } from './eventService';\nimport { create as createActivity, deleteActivity, restoreActivity } from './activityService';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ndescribe('Feature: guest-portal-and-admin-enhancements, Property 33: Soft Delete Restoration', () => {\n  beforeEach(async () => {\n    // Clean up test data\n    await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  afterAll(async () => {\n    // Final cleanup\n    await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  it('should restore content page with deleted_at set to NULL', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.string({ minLength: 1, maxLength: 100 }),\n        async (pageTitle) => {\n          // Create content page\n          const createResult = await createContentPage({\n            title: pageTitle,\n            status: 'published',\n          });\n\n          if (!createResult.success) {\n            throw new Error('Failed to create content page');\n          }\n\n          const pageId = createResult.data.id;\n\n          // Soft delete\n          await deleteContentPage(pageId, { permanent: false });\n\n          // Verify deleted\n          const { data: deletedPage } = await supabase\n            .from('content_pages')\n            .select('deleted_at')\n            .eq('id', pageId)\n            .single();\n\n          expect(deletedPage?.deleted_at).not.toBeNull();\n\n          // Restore\n          const restoreResult = await restoreContentPage(pageId);\n          expect(restoreResult.success).toBe(true);\n\n          // Verify restored\n          const { data: restoredPage } = await supabase\n            .from('content_pages')\n            .select('deleted_at')\n            .eq('id', pageId)\n            .single();\n\n          expect(restoredPage?.deleted_at).toBeNull();\n\n          // Verify accessible in guest query\n          const { data: guestPages } = await supabase\n            .from('content_pages')\n            .select('id')\n            .eq('status', 'published')\n            .is('deleted_at', null);\n\n          const guestPageIds = guestPages?.map((p) => p.id) || [];\n          expect(guestPageIds).toContain(pageId);\n\n          // Cleanup\n          await deleteContentPage(pageId, { permanent: true });\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should restore event with deleted_at set to NULL', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.string({ minLength: 1, maxLength: 100 }),\n        async (eventName) => {\n          // Create event\n          const createResult = await createEvent({\n            name: eventName,\n            date: new Date().toISOString().split('T')[0],\n          });\n\n          if (!createResult.success) {\n            throw new Error('Failed to create event');\n          }\n\n          const eventId = createResult.data.id;\n\n          // Soft delete\n          await deleteEvent(eventId, { permanent: false });\n\n          // Verify deleted\n          const { data: deletedEvent } = await supabase\n            .from('events')\n            .select('deleted_at')\n            .eq('id', eventId)\n            .single();\n\n          expect(deletedEvent?.deleted_at).not.toBeNull();\n\n          // Restore\n          const restoreResult = await restoreEvent(eventId);\n          expect(restoreResult.success).toBe(true);\n\n          // Verify restored\n          const { data: restoredEvent } = await supabase\n            .from('events')\n            .select('deleted_at')\n            .eq('id', eventId)\n            .single();\n\n          expect(restoredEvent?.deleted_at).toBeNull();\n\n          // Verify accessible in guest query\n          const { data: guestEvents } = await supabase\n            .from('events')\n            .select('id')\n            .is('deleted_at', null);\n\n          const guestEventIds = guestEvents?.map((e) => e.id) || [];\n          expect(guestEventIds).toContain(eventId);\n\n          // Cleanup\n          await deleteEvent(eventId, { permanent: true });\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should restore activity with deleted_at set to NULL', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.string({ minLength: 1, maxLength: 100 }),\n        async (activityName) => {\n          // Create activity\n          const createResult = await createActivity({\n            name: activityName,\n            date: new Date().toISOString().split('T')[0],\n            activity_type: 'activity',\n          });\n\n          if (!createResult.success) {\n            throw new Error('Failed to create activity');\n          }\n\n          const activityId = createResult.data.id;\n\n          // Soft delete\n          await deleteActivity(activityId, { permanent: false });\n\n          // Verify deleted\n          const { data: deletedActivity } = await supabase\n            .from('activities')\n            .select('deleted_at')\n            .eq('id', activityId)\n            .single();\n\n          expect(deletedActivity?.deleted_at).not.toBeNull();\n\n          // Restore\n          const restoreResult = await restoreActivity(activityId);\n          expect(restoreResult.success).toBe(true);\n\n          // Verify restored\n          const { data: restoredActivity } = await supabase\n            .from('activities')\n            .select('deleted_at')\n            .eq('id', activityId)\n            .single();\n\n          expect(restoredActivity?.deleted_at).toBeNull();\n\n          // Verify accessible in guest query\n          const { data: guestActivities } = await supabase\n            .from('activities')\n            .select('id')\n            .is('deleted_at', null);\n\n          const guestActivityIds = guestActivities?.map((a) => a.id) || [];\n          expect(guestActivityIds).toContain(activityId);\n\n          // Cleanup\n          await deleteActivity(activityId, { permanent: true });\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n});\n"],"names":["supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","describe","beforeEach","from","delete","neq","afterAll","it","fc","assert","asyncProperty","string","minLength","maxLength","pageTitle","createResult","createContentPage","title","status","success","Error","pageId","data","id","deleteContentPage","permanent","deletedPage","select","eq","single","expect","deleted_at","not","toBeNull","restoreResult","restoreContentPage","toBe","restoredPage","guestPages","is","guestPageIds","map","p","toContain","numRuns","eventName","createEvent","name","date","Date","toISOString","split","eventId","deleteEvent","deletedEvent","restoreEvent","restoredEvent","guestEvents","guestEventIds","e","activityName","createActivity","activity_type","activityId","deleteActivity","deletedActivity","restoreActivity","restoredActivity","guestActivities","guestActivityIds","a"],"mappings":"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"}