{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/photoStorageURLConsistency.property.test.ts"],"sourcesContent":["/**\n * Property-based test for photo storage URL consistency.\n * Feature: destination-wedding-platform, Property 16: Photo Storage URL Consistency\n * Validates: Requirements 12.7\n * \n * For any photo upload, the photo_url saved in the database should use the domain\n * corresponding to the active storage method (Cloudflare CDN domain for B2 storage,\n * Supabase domain for Supabase storage).\n */\n\nimport * as fc from 'fast-check';\n\ndescribe('Feature: destination-wedding-platform, Property 16: Photo Storage URL Consistency', () => {\n  // Arbitraries for generating test data\n  const storageTypeArbitrary = fc.constantFrom('b2', 'supabase');\n  \n  const b2CDNDomainArbitrary = fc.constantFrom(\n    'cdn.example.com',\n    'f000.backblazeb2.com',\n    'cdn.mysite.com'\n  );\n  \n  const supabaseDomainArbitrary = fc.constantFrom(\n    'supabase.co',\n    'supabase.example.com',\n    'storage.supabase.co'\n  );\n  \n  const photoKeyArbitrary = fc.string({ minLength: 10, maxLength: 100 }).map(\n    s => `photos/${Date.now()}-${s.replace(/[^a-zA-Z0-9._-]/g, '_')}.jpg`\n  );\n\n  it('should use Cloudflare CDN domain for B2 storage', () => {\n    fc.assert(\n      fc.property(\n        b2CDNDomainArbitrary,\n        photoKeyArbitrary,\n        (cdnDomain, photoKey) => {\n          // Arrange\n          const storageType = 'b2';\n          \n          // Act - Generate URL based on storage type\n          const photoUrl = `https://${cdnDomain}/${photoKey}`;\n          \n          // Assert - URL should contain the CDN domain\n          expect(photoUrl).toContain(cdnDomain);\n          expect(photoUrl).toContain('https://');\n          expect(photoUrl).toContain(photoKey);\n          \n          // Verify it's not a Supabase URL\n          expect(photoUrl).not.toContain('supabase');\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should use Supabase domain for Supabase storage', () => {\n    fc.assert(\n      fc.property(\n        supabaseDomainArbitrary,\n        photoKeyArbitrary,\n        (supabaseDomain, photoKey) => {\n          // Arrange\n          const storageType = 'supabase';\n          \n          // Act - Generate URL based on storage type\n          const photoUrl = `https://${supabaseDomain}/storage/v1/object/public/photos/${photoKey}`;\n          \n          // Assert - URL should contain the Supabase domain\n          expect(photoUrl).toContain(supabaseDomain);\n          expect(photoUrl).toContain('https://');\n          expect(photoUrl).toContain('storage/v1/object/public');\n          expect(photoUrl).toContain(photoKey);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should maintain URL consistency with storage type', () => {\n    fc.assert(\n      fc.property(\n        storageTypeArbitrary,\n        b2CDNDomainArbitrary,\n        supabaseDomainArbitrary,\n        photoKeyArbitrary,\n        (storageType, b2Domain, supabaseDomain, photoKey) => {\n          // Act - Generate URL based on storage type\n          let photoUrl: string;\n          if (storageType === 'b2') {\n            photoUrl = `https://${b2Domain}/${photoKey}`;\n          } else {\n            photoUrl = `https://${supabaseDomain}/storage/v1/object/public/photos/${photoKey}`;\n          }\n          \n          // Assert - URL domain should match storage type\n          if (storageType === 'b2') {\n            expect(photoUrl).toContain(b2Domain);\n            expect(photoUrl).not.toContain('storage/v1/object/public');\n          } else {\n            expect(photoUrl).toContain(supabaseDomain);\n            expect(photoUrl).toContain('storage/v1/object/public');\n          }\n          \n          // All URLs should be HTTPS\n          expect(photoUrl).toMatch(/^https:\\/\\//);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should generate valid URLs for all storage types', () => {\n    fc.assert(\n      fc.property(\n        storageTypeArbitrary,\n        photoKeyArbitrary,\n        (storageType, photoKey) => {\n          // Arrange\n          const b2Domain = 'cdn.example.com';\n          const supabaseDomain = 'supabase.example.com';\n          \n          // Act\n          let photoUrl: string;\n          if (storageType === 'b2') {\n            photoUrl = `https://${b2Domain}/${photoKey}`;\n          } else {\n            photoUrl = `https://${supabaseDomain}/storage/v1/object/public/photos/${photoKey}`;\n          }\n          \n          // Assert - URL should be valid\n          expect(() => new URL(photoUrl)).not.toThrow();\n          \n          const url = new URL(photoUrl);\n          expect(url.protocol).toBe('https:');\n          expect(url.hostname).toBeTruthy();\n          expect(url.pathname).toContain(photoKey);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should preserve photo key in URL regardless of storage type', () => {\n    fc.assert(\n      fc.property(\n        storageTypeArbitrary,\n        photoKeyArbitrary,\n        (storageType, photoKey) => {\n          // Arrange\n          const b2Domain = 'cdn.example.com';\n          const supabaseDomain = 'supabase.example.com';\n          \n          // Act\n          let photoUrl: string;\n          if (storageType === 'b2') {\n            photoUrl = `https://${b2Domain}/${photoKey}`;\n          } else {\n            photoUrl = `https://${supabaseDomain}/storage/v1/object/public/photos/${photoKey}`;\n          }\n          \n          // Assert - Photo key should be present in URL\n          expect(photoUrl).toContain(photoKey);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should not mix B2 and Supabase URL patterns', () => {\n    fc.assert(\n      fc.property(\n        storageTypeArbitrary,\n        b2CDNDomainArbitrary,\n        supabaseDomainArbitrary,\n        photoKeyArbitrary,\n        (storageType, b2Domain, supabaseDomain, photoKey) => {\n          // Act\n          let photoUrl: string;\n          if (storageType === 'b2') {\n            photoUrl = `https://${b2Domain}/${photoKey}`;\n          } else {\n            photoUrl = `https://${supabaseDomain}/storage/v1/object/public/photos/${photoKey}`;\n          }\n          \n          // Assert - B2 URLs should not have Supabase patterns and vice versa\n          const hasB2Pattern = photoUrl.includes(b2Domain) && !photoUrl.includes('storage/v1/object/public');\n          const hasSupabasePattern = photoUrl.includes('storage/v1/object/public');\n          \n          // Exactly one pattern should match\n          expect(hasB2Pattern !== hasSupabasePattern).toBe(true);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should generate consistent URLs for the same storage type and key', () => {\n    fc.assert(\n      fc.property(\n        storageTypeArbitrary,\n        photoKeyArbitrary,\n        (storageType, photoKey) => {\n          // Arrange\n          const b2Domain = 'cdn.example.com';\n          const supabaseDomain = 'supabase.example.com';\n          \n          // Act - Generate URL twice with same inputs\n          const generateUrl = (type: string, key: string) => {\n            if (type === 'b2') {\n              return `https://${b2Domain}/${key}`;\n            } else {\n              return `https://${supabaseDomain}/storage/v1/object/public/photos/${key}`;\n            }\n          };\n          \n          const url1 = generateUrl(storageType, photoKey);\n          const url2 = generateUrl(storageType, photoKey);\n          \n          // Assert - URLs should be identical\n          expect(url1).toBe(url2);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should use HTTPS protocol for all storage URLs', () => {\n    fc.assert(\n      fc.property(\n        storageTypeArbitrary,\n        photoKeyArbitrary,\n        (storageType, photoKey) => {\n          // Arrange\n          const b2Domain = 'cdn.example.com';\n          const supabaseDomain = 'supabase.example.com';\n          \n          // Act\n          let photoUrl: string;\n          if (storageType === 'b2') {\n            photoUrl = `https://${b2Domain}/${photoKey}`;\n          } else {\n            photoUrl = `https://${supabaseDomain}/storage/v1/object/public/photos/${photoKey}`;\n          }\n          \n          // Assert - All URLs must use HTTPS\n          expect(photoUrl).toMatch(/^https:\\/\\//);\n          expect(photoUrl).not.toMatch(/^http:\\/\\//);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n});\n"],"names":["describe","storageTypeArbitrary","fc","constantFrom","b2CDNDomainArbitrary","supabaseDomainArbitrary","photoKeyArbitrary","string","minLength","maxLength","map","s","Date","now","replace","it","assert","property","cdnDomain","photoKey","storageType","photoUrl","expect","toContain","not","numRuns","supabaseDomain","b2Domain","toMatch","URL","toThrow","url","protocol","toBe","hostname","toBeTruthy","pathname","hasB2Pattern","includes","hasSupabasePattern","generateUrl","type","key","url1","url2"],"mappings":"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"}