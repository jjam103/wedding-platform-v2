{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/regression/guestGroupsRls.regression.test.ts"],"sourcesContent":["/**\n * Guest Groups RLS Regression Test\n * \n * This test prevents regression of RLS issues with guest groups CRUD operations.\n * \n * Bug Description:\n * - Guest groups table had RLS policies enabled\n * - Service methods used service role client that bypassed RLS\n * - When called from API routes with real auth, RLS policies were enforced\n * - RLS policies might not allow authenticated users to manage guest groups\n * - Result: Permission denied or RLS violation errors\n * \n * This test validates:\n * - Guest groups can be created with real authentication\n * - RLS policies allow authenticated users to manage their guest groups\n * - All CRUD operations work correctly with RLS enforcement\n * \n * Validates: Requirements 5.1\n */\n\nimport { withTestDatabase } from '../helpers/testDb';\nimport { createTestGuestGroup } from '../helpers/factories';\nimport { cleanupTestGuestGroups } from '../helpers/cleanup';\n\ndescribe('Guest Groups RLS Regression Tests', () => {\n  afterEach(async () => {\n    // Clean up test data\n    await cleanupTestGuestGroups();\n  });\n  \n  it('should create guest group with real auth without RLS errors', async () => {\n    await withTestDatabase(async (db) => {\n      // Create authenticated user (not service role!)\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create guest group with real authentication\n      const groupData = createTestGuestGroup();\n      \n      const { data, error } = await client\n        .from('guest_groups')\n        .insert(groupData)\n        .select()\n        .single();\n      \n      // THIS IS THE KEY TEST - Would have caught RLS bugs!\n      expect(error).toBeNull();\n      expect(data).toBeDefined();\n      \n      if (data) {\n        expect(data.name).toBe(groupData.name);\n        expect(data.description).toBe(groupData.description);\n      }\n    });\n  });\n  \n  it('should read guest groups with real auth without RLS errors', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create guest group\n      const groupData = createTestGuestGroup();\n      const { data: createdGroup } = await client\n        .from('guest_groups')\n        .insert(groupData)\n        .select()\n        .single();\n      \n      // Read guest groups with real auth\n      const { data, error } = await client\n        .from('guest_groups')\n        .select('*')\n        .eq('id', createdGroup.id)\n        .single();\n      \n      expect(error).toBeNull();\n      expect(data).toBeDefined();\n      expect(data?.id).toBe(createdGroup.id);\n    });\n  });\n  \n  it('should update guest group with real auth without RLS errors', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create guest group\n      const groupData = createTestGuestGroup();\n      const { data: createdGroup } = await client\n        .from('guest_groups')\n        .insert(groupData)\n        .select()\n        .single();\n      \n      // Update guest group with real auth\n      const { data, error } = await client\n        .from('guest_groups')\n        .update({ name: 'Updated Name', description: 'Updated description' })\n        .eq('id', createdGroup.id)\n        .select()\n        .single();\n      \n      expect(error).toBeNull();\n      expect(data).toBeDefined();\n      expect(data?.name).toBe('Updated Name');\n      expect(data?.description).toBe('Updated description');\n    });\n  });\n  \n  it('should delete guest group with real auth without RLS errors', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create guest group\n      const groupData = createTestGuestGroup();\n      const { data: createdGroup } = await client\n        .from('guest_groups')\n        .insert(groupData)\n        .select()\n        .single();\n      \n      // Delete guest group with real auth\n      const { error } = await client\n        .from('guest_groups')\n        .delete()\n        .eq('id', createdGroup.id);\n      \n      expect(error).toBeNull();\n      \n      // Verify deletion\n      const { data: deletedGroup } = await client\n        .from('guest_groups')\n        .select('*')\n        .eq('id', createdGroup.id)\n        .single();\n      \n      expect(deletedGroup).toBeNull();\n    });\n  });\n  \n  it('should list all guest groups with real auth without RLS errors', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create multiple guest groups\n      const groups = [\n        createTestGuestGroup({ name: 'Group 1' }),\n        createTestGuestGroup({ name: 'Group 2' }),\n        createTestGuestGroup({ name: 'Group 3' }),\n      ];\n      \n      await client.from('guest_groups').insert(groups);\n      \n      // List all guest groups with real auth\n      const { data, error } = await client\n        .from('guest_groups')\n        .select('*')\n        .order('created_at', { ascending: false });\n      \n      expect(error).toBeNull();\n      expect(data).toBeDefined();\n      expect(data!.length).toBeGreaterThanOrEqual(3);\n    });\n  });\n  \n  it('should handle concurrent guest group operations with real auth', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create multiple groups concurrently\n      const groupPromises = Array.from({ length: 5 }, (_, i) => \n        client\n          .from('guest_groups')\n          .insert(createTestGuestGroup({ name: `Concurrent Group ${i}` }))\n          .select()\n          .single()\n      );\n      \n      const results = await Promise.all(groupPromises);\n      \n      // All operations should succeed\n      results.forEach(({ data, error }) => {\n        expect(error).toBeNull();\n        expect(data).toBeDefined();\n      });\n    });\n  });\n  \n  it('should enforce RLS for unauthorized access', async () => {\n    await withTestDatabase(async (db) => {\n      // Create two different users\n      const { client: client1, user: user1 } = await db.createAuthenticatedClient();\n      const { client: client2, user: user2 } = await db.createAuthenticatedClient();\n      \n      // User 1 creates a guest group\n      const groupData = createTestGuestGroup();\n      const { data: createdGroup } = await client1\n        .from('guest_groups')\n        .insert(groupData)\n        .select()\n        .single();\n      \n      // User 2 should be able to see the group (guest groups are shared)\n      // This tests that RLS policies are correctly configured\n      const { data, error } = await client2\n        .from('guest_groups')\n        .select('*')\n        .eq('id', createdGroup.id)\n        .single();\n      \n      // Depending on RLS policy, this might succeed or fail\n      // Document the expected behavior based on your RLS policies\n      if (error) {\n        // If RLS restricts access, error should be permission-related\n        expect(error.message).toContain('permission');\n      } else {\n        // If RLS allows shared access, data should be returned\n        expect(data).toBeDefined();\n      }\n    });\n  });\n});\n\n/**\n * Why This Test Would Have Caught the Bug:\n * \n * The guest groups RLS bug occurred because:\n * 1. Guest groups table had RLS policies enabled\n * 2. Service methods used service role client (bypassed RLS)\n * 3. API routes used real auth (enforced RLS)\n * 4. RLS policies might not allow authenticated users to manage groups\n * \n * This test explicitly:\n * - Uses real authentication (not service role)\n * - Tests all CRUD operations on guest_groups table\n * - Validates no RLS errors occur\n * - Tests concurrent operations to catch race conditions\n * - Tests multi-user scenarios to validate RLS policies\n * \n * If RLS policies are misconfigured, this test will fail with clear error\n * messages indicating permission issues, making it easy to diagnose and fix.\n */\n"],"names":["describe","afterEach","cleanupTestGuestGroups","it","withTestDatabase","db","client","user","createAuthenticatedClient","groupData","createTestGuestGroup","data","error","from","insert","select","single","expect","toBeNull","toBeDefined","name","toBe","description","createdGroup","eq","id","update","delete","deletedGroup","groups","order","ascending","length","toBeGreaterThanOrEqual","groupPromises","Array","_","i","results","Promise","all","forEach","client1","user1","client2","user2","message","toContain"],"mappings":"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"}