{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/eventService.slugUniqueness.property.test.ts"],"sourcesContent":["/**\n * Property-Based Tests for Event Service Slug Uniqueness\n * \n * **Property 24: Slug Uniqueness**\n * **Validates: Requirements 24.3, 24.4, 24.5**\n * \n * Tests that slugs are unique across all events and conflicts are resolved with numeric suffixes.\n */\n\nimport * as fc from 'fast-check';\nimport { create, deleteEvent } from './eventService';\n\ndescribe('Feature: guest-portal-and-admin-enhancements, Property 24: Slug Uniqueness', () => {\n  // Clean up test events after each test\n  const createdEventIds: string[] = [];\n\n  afterEach(async () => {\n    // Clean up all created events\n    for (const id of createdEventIds) {\n      await deleteEvent(id);\n    }\n    createdEventIds.length = 0;\n  });\n\n  /**\n   * Property: Creating multiple events with the same name generates unique slugs\n   * \n   * When multiple events have the same name, the system should append numeric\n   * suffixes (-2, -3, etc.) to ensure uniqueness.\n   */\n  it('should generate unique slugs for events with duplicate names', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.string({ minLength: 3, maxLength: 30 }).filter(s => /[a-zA-Z0-9]/.test(s)),\n        fc.integer({ min: 2, max: 5 }),\n        fc.date(),\n        async (baseName, count, startDate) => {\n          const slugs = new Set<string>();\n\n          // Create multiple events with the same name\n          for (let i = 0; i < count; i++) {\n            const result = await create({\n              name: baseName,\n              eventType: 'ceremony',\n              startDate: new Date(startDate.getTime() + i * 3600000).toISOString(), // Offset by hours\n            });\n\n            if (!result.success) {\n              // If creation failed, skip this iteration\n              continue;\n            }\n\n            createdEventIds.push(result.data.id);\n            const slug = result.data.slug;\n\n            // Each slug must be unique\n            expect(slugs.has(slug)).toBe(false);\n            slugs.add(slug);\n\n            // First event should have base slug, subsequent should have -2, -3, etc.\n            if (i === 0) {\n              expect(slug).not.toMatch(/-\\d+$/);\n            } else {\n              expect(slug).toMatch(/-\\d+$/);\n            }\n          }\n\n          // Verify we got the expected number of unique slugs\n          expect(slugs.size).toBe(count);\n\n          return true;\n        }\n      ),\n      { numRuns: 20 }\n    );\n  });\n\n  /**\n   * Property: Slug uniqueness is maintained across different event types\n   */\n  it('should ensure slug uniqueness across all event types', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.string({ minLength: 3, maxLength: 30 }).filter(s => /[a-zA-Z0-9]/.test(s)),\n        fc.date(),\n        async (name, startDate) => {\n          const eventTypes = ['ceremony', 'reception', 'meal', 'transport', 'activity'] as const;\n          const slugs = new Set<string>();\n\n          // Create events with same name but different types\n          for (const eventType of eventTypes) {\n            const result = await create({\n              name,\n              eventType,\n              startDate: startDate.toISOString(),\n            });\n\n            if (!result.success) {\n              continue;\n            }\n\n            createdEventIds.push(result.data.id);\n            const slug = result.data.slug;\n\n            // Each slug must be unique even across different event types\n            expect(slugs.has(slug)).toBe(false);\n            slugs.add(slug);\n          }\n\n          return true;\n        }\n      ),\n      { numRuns: 15 }\n    );\n  });\n\n  /**\n   * Property: Numeric suffix increments correctly for multiple duplicates\n   */\n  it('should increment numeric suffixes correctly for multiple duplicates', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.string({ minLength: 3, maxLength: 20 }).filter(s => /[a-zA-Z0-9]/.test(s)),\n        fc.date(),\n        async (name, startDate) => {\n          const events: Array<{ id: string; slug: string }> = [];\n\n          // Create 5 events with the same name\n          for (let i = 0; i < 5; i++) {\n            const result = await create({\n              name,\n              eventType: 'ceremony',\n              startDate: new Date(startDate.getTime() + i * 3600000).toISOString(),\n            });\n\n            if (!result.success) {\n              continue;\n            }\n\n            createdEventIds.push(result.data.id);\n            events.push({ id: result.data.id, slug: result.data.slug });\n          }\n\n          if (events.length < 2) {\n            return true; // Skip if we couldn't create enough events\n          }\n\n          // Verify slug pattern\n          const baseSlug = events[0].slug;\n          expect(baseSlug).not.toMatch(/-\\d+$/);\n\n          for (let i = 1; i < events.length; i++) {\n            const expectedSuffix = i + 1;\n            expect(events[i].slug).toBe(`${baseSlug}-${expectedSuffix}`);\n          }\n\n          return true;\n        }\n      ),\n      { numRuns: 10 }\n    );\n  });\n\n  /**\n   * Property: Slug uniqueness handles edge cases with similar names\n   */\n  it('should maintain uniqueness for names that differ only in special characters', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.string({ minLength: 3, maxLength: 20 }).filter(s => /[a-zA-Z0-9]/.test(s)),\n        fc.constantFrom('!', '@', '#', '-', '_', ' '),\n        fc.date(),\n        async (baseName, separator, startDate) => {\n          const names = [\n            baseName,\n            `${baseName}${separator}${baseName}`,\n            `${baseName}${separator}${separator}${baseName}`,\n          ];\n\n          const slugs = new Set<string>();\n\n          for (const name of names) {\n            const result = await create({\n              name,\n              eventType: 'reception',\n              startDate: startDate.toISOString(),\n            });\n\n            if (!result.success) {\n              continue;\n            }\n\n            createdEventIds.push(result.data.id);\n            const slug = result.data.slug;\n\n            // Each slug must be unique\n            expect(slugs.has(slug)).toBe(false);\n            slugs.add(slug);\n          }\n\n          return true;\n        }\n      ),\n      { numRuns: 15 }\n    );\n  });\n});\n"],"names":["describe","createdEventIds","afterEach","id","deleteEvent","length","it","fc","assert","asyncProperty","string","minLength","maxLength","filter","s","test","integer","min","max","date","baseName","count","startDate","slugs","Set","i","result","create","name","eventType","Date","getTime","toISOString","success","push","data","slug","expect","has","toBe","add","not","toMatch","size","numRuns","eventTypes","events","baseSlug","expectedSuffix","constantFrom","separator","names"],"mappings":"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"}