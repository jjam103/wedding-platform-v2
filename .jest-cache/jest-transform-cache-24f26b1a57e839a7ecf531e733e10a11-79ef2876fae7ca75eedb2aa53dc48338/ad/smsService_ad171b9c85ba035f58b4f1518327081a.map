{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/smsService.ts"],"sourcesContent":["import twilio from 'twilio';\nimport { createClient } from '@supabase/supabase-js';\nimport type { Result } from '@/types';\nimport { ERROR_CODES } from '@/types';\n\n// Lazy initialize Twilio client to avoid errors when env vars are missing\nlet twilioClient: ReturnType<typeof twilio> | null = null;\n\nfunction getTwilioClient() {\n  if (!twilioClient) {\n    const accountSid = process.env.TWILIO_ACCOUNT_SID;\n    const authToken = process.env.TWILIO_AUTH_TOKEN;\n    \n    // Return null if credentials are not configured (e.g., in test environment)\n    if (!accountSid || !authToken || accountSid === 'test' || authToken === 'test') {\n      return null;\n    }\n    \n    twilioClient = twilio(accountSid, authToken);\n  }\n  return twilioClient;\n}\n\n// Initialize Supabase client for logging\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\n/**\n * SMS log entity for tracking SMS delivery.\n * Requirements: 12.10\n */\nexport interface SMSLog {\n  id: string;\n  recipient_phone: string;\n  message: string;\n  delivery_status: 'queued' | 'sent' | 'delivered' | 'failed';\n  sent_at?: string;\n  delivered_at?: string;\n  error_message?: string;\n  created_at: string;\n}\n\n/**\n * Sends an SMS message using Twilio.\n * Requirements: 12.9, 12.10\n * \n * @param to - Recipient phone number in E.164 format (e.g., +15551234567)\n * @param message - SMS message content (max 160 characters for single SMS)\n * @returns Result containing the SMS ID or error details\n */\nexport async function sendSMS(\n  to: string,\n  message: string\n): Promise<Result<{ id: string }>> {\n  try {\n    // Check if Twilio is configured\n    const client = getTwilioClient();\n    if (!client) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.EXTERNAL_SERVICE_ERROR,\n          message: 'SMS service not configured',\n        },\n      };\n    }\n\n    // 1. Validate phone number format (basic check)\n    if (!to.startsWith('+')) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Phone number must be in E.164 format (e.g., +15551234567)',\n        },\n      };\n    }\n\n    // 2. Validate message length\n    if (message.length === 0) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Message cannot be empty',\n        },\n      };\n    }\n\n    // Truncate message if too long (SMS limit is 160 chars for single message)\n    const truncatedMessage = message.length > 160 \n      ? message.substring(0, 157) + '...' \n      : message;\n\n    // 3. Send SMS via Twilio\n    const twilioMessage = await client.messages.create({\n      body: truncatedMessage,\n      from: process.env.TWILIO_PHONE_NUMBER,\n      to,\n    });\n\n    // 4. Log successful SMS\n    await supabase.from('sms_logs').insert({\n      recipient_phone: to,\n      message: truncatedMessage,\n      delivery_status: 'sent',\n      sent_at: new Date().toISOString(),\n    });\n\n    return { success: true, data: { id: twilioMessage.sid } };\n  } catch (error: any) {\n    // Log failed SMS\n    await supabase.from('sms_logs').insert({\n      recipient_phone: to,\n      message,\n      delivery_status: 'failed',\n      error_message: error.message,\n    });\n\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.EXTERNAL_SERVICE_ERROR,\n        message: error.message || 'Failed to send SMS',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Sends an SMS with email fallback logic.\n * This is called when email delivery fails.\n * Requirements: 12.9, 12.10\n * \n * @param phone - Recipient phone number\n * @param subject - Email subject (used to create SMS message)\n * @param body - Email body (truncated for SMS)\n * @returns Result containing the SMS ID or error details\n */\nexport async function sendSMSFallback(\n  phone: string,\n  subject: string,\n  body: string\n): Promise<Result<{ id: string }>> {\n  try {\n    // Create a concise SMS message from email content\n    // Format: \"[Subject] Body (truncated)\"\n    const smsMessage = `[${subject}] ${body}`;\n    \n    return await sendSMS(phone, smsMessage);\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Updates SMS delivery status from Twilio webhook.\n * Requirements: 12.10\n * \n * @param smsId - Twilio message SID\n * @param status - Delivery status from Twilio\n * @param errorMessage - Optional error message\n */\nexport async function updateSMSDeliveryStatus(\n  smsId: string,\n  status: 'delivered' | 'failed',\n  errorMessage?: string\n): Promise<Result<void>> {\n  try {\n    const updateData: any = {\n      delivery_status: status,\n    };\n\n    if (status === 'delivered') {\n      updateData.delivered_at = new Date().toISOString();\n    }\n\n    if (errorMessage) {\n      updateData.error_message = errorMessage;\n    }\n\n    const { error } = await supabase\n      .from('sms_logs')\n      .update(updateData)\n      .eq('id', smsId);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Gets SMS delivery analytics.\n * Requirements: 12.10\n */\nexport async function getSMSAnalytics(): Promise<\n  Result<{\n    total: number;\n    sent: number;\n    delivered: number;\n    failed: number;\n  }>\n> {\n  try {\n    const { data: logs, error } = await supabase\n      .from('sms_logs')\n      .select('delivery_status');\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    const analytics = {\n      total: logs.length,\n      sent: logs.filter((l) => l.delivery_status === 'sent').length,\n      delivered: logs.filter((l) => l.delivery_status === 'delivered').length,\n      failed: logs.filter((l) => l.delivery_status === 'failed').length,\n    };\n\n    return { success: true, data: analytics };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Gets SMS logs with optional filtering.\n * Requirements: 12.10\n */\nexport async function getSMSLogs(filters?: {\n  recipient_phone?: string;\n  delivery_status?: string;\n  limit?: number;\n}): Promise<Result<SMSLog[]>> {\n  try {\n    let query = supabase\n      .from('sms_logs')\n      .select('*')\n      .order('created_at', { ascending: false });\n\n    if (filters?.recipient_phone) {\n      query = query.eq('recipient_phone', filters.recipient_phone);\n    }\n\n    if (filters?.delivery_status) {\n      query = query.eq('delivery_status', filters.delivery_status);\n    }\n\n    if (filters?.limit) {\n      query = query.limit(filters.limit);\n    }\n\n    const { data: logs, error } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: logs || [] };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n"],"names":["getSMSAnalytics","getSMSLogs","sendSMS","sendSMSFallback","updateSMSDeliveryStatus","twilioClient","getTwilioClient","accountSid","process","env","TWILIO_ACCOUNT_SID","authToken","TWILIO_AUTH_TOKEN","twilio","supabase","createClient","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","to","message","client","success","error","code","ERROR_CODES","EXTERNAL_SERVICE_ERROR","startsWith","VALIDATION_ERROR","length","truncatedMessage","substring","twilioMessage","messages","create","body","from","TWILIO_PHONE_NUMBER","insert","recipient_phone","delivery_status","sent_at","Date","toISOString","data","id","sid","error_message","details","phone","subject","smsMessage","UNKNOWN_ERROR","Error","smsId","status","errorMessage","updateData","delivered_at","update","eq","DATABASE_ERROR","undefined","logs","select","analytics","total","sent","filter","l","delivered","failed","filters","query","order","ascending","limit"],"mappings":";;;;;;;;;;;QA8NsBA;eAAAA;;QA+CAC;eAAAA;;QAzNAC;eAAAA;;QA0FAC;eAAAA;;QA8BAC;eAAAA;;;+DA5KH;4BACU;uBAED;;;;;;AAE5B,0EAA0E;AAC1E,IAAIC,eAAiD;AAErD,SAASC;IACP,IAAI,CAACD,cAAc;QACjB,MAAME,aAAaC,QAAQC,GAAG,CAACC,kBAAkB;QACjD,MAAMC,YAAYH,QAAQC,GAAG,CAACG,iBAAiB;QAE/C,4EAA4E;QAC5E,IAAI,CAACL,cAAc,CAACI,aAAaJ,eAAe,UAAUI,cAAc,QAAQ;YAC9E,OAAO;QACT;QAEAN,eAAeQ,IAAAA,eAAM,EAACN,YAAYI;IACpC;IACA,OAAON;AACT;AAEA,yCAAyC;AACzC,MAAMS,WAAWC,IAAAA,wBAAY,EAC3BP,QAAQC,GAAG,CAACO,wBAAwB,EACpCR,QAAQC,GAAG,CAACQ,yBAAyB;AA0BhC,eAAef,QACpBgB,EAAU,EACVC,OAAe;IAEf,IAAI;QACF,gCAAgC;QAChC,MAAMC,SAASd;QACf,IAAI,CAACc,QAAQ;YACX,OAAO;gBACLC,SAAS;gBACTC,OAAO;oBACLC,MAAMC,kBAAW,CAACC,sBAAsB;oBACxCN,SAAS;gBACX;YACF;QACF;QAEA,gDAAgD;QAChD,IAAI,CAACD,GAAGQ,UAAU,CAAC,MAAM;YACvB,OAAO;gBACLL,SAAS;gBACTC,OAAO;oBACLC,MAAMC,kBAAW,CAACG,gBAAgB;oBAClCR,SAAS;gBACX;YACF;QACF;QAEA,6BAA6B;QAC7B,IAAIA,QAAQS,MAAM,KAAK,GAAG;YACxB,OAAO;gBACLP,SAAS;gBACTC,OAAO;oBACLC,MAAMC,kBAAW,CAACG,gBAAgB;oBAClCR,SAAS;gBACX;YACF;QACF;QAEA,2EAA2E;QAC3E,MAAMU,mBAAmBV,QAAQS,MAAM,GAAG,MACtCT,QAAQW,SAAS,CAAC,GAAG,OAAO,QAC5BX;QAEJ,yBAAyB;QACzB,MAAMY,gBAAgB,MAAMX,OAAOY,QAAQ,CAACC,MAAM,CAAC;YACjDC,MAAML;YACNM,MAAM3B,QAAQC,GAAG,CAAC2B,mBAAmB;YACrClB;QACF;QAEA,wBAAwB;QACxB,MAAMJ,SAASqB,IAAI,CAAC,YAAYE,MAAM,CAAC;YACrCC,iBAAiBpB;YACjBC,SAASU;YACTU,iBAAiB;YACjBC,SAAS,IAAIC,OAAOC,WAAW;QACjC;QAEA,OAAO;YAAErB,SAAS;YAAMsB,MAAM;gBAAEC,IAAIb,cAAcc,GAAG;YAAC;QAAE;IAC1D,EAAE,OAAOvB,OAAY;QACnB,iBAAiB;QACjB,MAAMR,SAASqB,IAAI,CAAC,YAAYE,MAAM,CAAC;YACrCC,iBAAiBpB;YACjBC;YACAoB,iBAAiB;YACjBO,eAAexB,MAAMH,OAAO;QAC9B;QAEA,OAAO;YACLE,SAAS;YACTC,OAAO;gBACLC,MAAMC,kBAAW,CAACC,sBAAsB;gBACxCN,SAASG,MAAMH,OAAO,IAAI;gBAC1B4B,SAASzB;YACX;QACF;IACF;AACF;AAYO,eAAenB,gBACpB6C,KAAa,EACbC,OAAe,EACff,IAAY;IAEZ,IAAI;QACF,kDAAkD;QAClD,uCAAuC;QACvC,MAAMgB,aAAa,CAAC,CAAC,EAAED,QAAQ,EAAE,EAAEf,MAAM;QAEzC,OAAO,MAAMhC,QAAQ8C,OAAOE;IAC9B,EAAE,OAAO5B,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAMC,kBAAW,CAAC2B,aAAa;gBAC/BhC,SAASG,iBAAiB8B,QAAQ9B,MAAMH,OAAO,GAAG;YACpD;QACF;IACF;AACF;AAUO,eAAef,wBACpBiD,KAAa,EACbC,MAA8B,EAC9BC,YAAqB;IAErB,IAAI;QACF,MAAMC,aAAkB;YACtBjB,iBAAiBe;QACnB;QAEA,IAAIA,WAAW,aAAa;YAC1BE,WAAWC,YAAY,GAAG,IAAIhB,OAAOC,WAAW;QAClD;QAEA,IAAIa,cAAc;YAChBC,WAAWV,aAAa,GAAGS;QAC7B;QAEA,MAAM,EAAEjC,KAAK,EAAE,GAAG,MAAMR,SACrBqB,IAAI,CAAC,YACLuB,MAAM,CAACF,YACPG,EAAE,CAAC,MAAMN;QAEZ,IAAI/B,OAAO;YACT,OAAO;gBACLD,SAAS;gBACTC,OAAO;oBACLC,MAAMC,kBAAW,CAACoC,cAAc;oBAChCzC,SAASG,MAAMH,OAAO;oBACtB4B,SAASzB;gBACX;YACF;QACF;QAEA,OAAO;YAAED,SAAS;YAAMsB,MAAMkB;QAAU;IAC1C,EAAE,OAAOvC,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAMC,kBAAW,CAAC2B,aAAa;gBAC/BhC,SAASG,iBAAiB8B,QAAQ9B,MAAMH,OAAO,GAAG;YACpD;QACF;IACF;AACF;AAMO,eAAenB;IAQpB,IAAI;QACF,MAAM,EAAE2C,MAAMmB,IAAI,EAAExC,KAAK,EAAE,GAAG,MAAMR,SACjCqB,IAAI,CAAC,YACL4B,MAAM,CAAC;QAEV,IAAIzC,OAAO;YACT,OAAO;gBACLD,SAAS;gBACTC,OAAO;oBACLC,MAAMC,kBAAW,CAACoC,cAAc;oBAChCzC,SAASG,MAAMH,OAAO;oBACtB4B,SAASzB;gBACX;YACF;QACF;QAEA,MAAM0C,YAAY;YAChBC,OAAOH,KAAKlC,MAAM;YAClBsC,MAAMJ,KAAKK,MAAM,CAAC,CAACC,IAAMA,EAAE7B,eAAe,KAAK,QAAQX,MAAM;YAC7DyC,WAAWP,KAAKK,MAAM,CAAC,CAACC,IAAMA,EAAE7B,eAAe,KAAK,aAAaX,MAAM;YACvE0C,QAAQR,KAAKK,MAAM,CAAC,CAACC,IAAMA,EAAE7B,eAAe,KAAK,UAAUX,MAAM;QACnE;QAEA,OAAO;YAAEP,SAAS;YAAMsB,MAAMqB;QAAU;IAC1C,EAAE,OAAO1C,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAMC,kBAAW,CAAC2B,aAAa;gBAC/BhC,SAASG,iBAAiB8B,QAAQ9B,MAAMH,OAAO,GAAG;YACpD;QACF;IACF;AACF;AAMO,eAAelB,WAAWsE,OAIhC;IACC,IAAI;QACF,IAAIC,QAAQ1D,SACTqB,IAAI,CAAC,YACL4B,MAAM,CAAC,KACPU,KAAK,CAAC,cAAc;YAAEC,WAAW;QAAM;QAE1C,IAAIH,SAASjC,iBAAiB;YAC5BkC,QAAQA,MAAMb,EAAE,CAAC,mBAAmBY,QAAQjC,eAAe;QAC7D;QAEA,IAAIiC,SAAShC,iBAAiB;YAC5BiC,QAAQA,MAAMb,EAAE,CAAC,mBAAmBY,QAAQhC,eAAe;QAC7D;QAEA,IAAIgC,SAASI,OAAO;YAClBH,QAAQA,MAAMG,KAAK,CAACJ,QAAQI,KAAK;QACnC;QAEA,MAAM,EAAEhC,MAAMmB,IAAI,EAAExC,KAAK,EAAE,GAAG,MAAMkD;QAEpC,IAAIlD,OAAO;YACT,OAAO;gBACLD,SAAS;gBACTC,OAAO;oBACLC,MAAMC,kBAAW,CAACoC,cAAc;oBAChCzC,SAASG,MAAMH,OAAO;oBACtB4B,SAASzB;gBACX;YACF;QACF;QAEA,OAAO;YAAED,SAAS;YAAMsB,MAAMmB,QAAQ,EAAE;QAAC;IAC3C,EAAE,OAAOxC,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAMC,kBAAW,CAAC2B,aAAa;gBAC/BhC,SAASG,iBAAiB8B,QAAQ9B,MAAMH,OAAO,GAAG;YACpD;QACF;IACF;AACF"}