{"version":3,"names":["POST","bulkUpdateAuthMethodSchema","cov_1vyka5abym","s","_zod","z","object","guest_ids","array","string","uuid","min","max","auth_method","enum","send_notification","boolean","optional","default","getStatusCode","errorCode","f","statusMap","b","request","supabase","_supabaseServer","createAuthenticatedClient","data","session","error","authError","auth","getSession","_server","NextResponse","json","success","code","message","status","body","validation","safeParse","details","issues","updatedGuests","updateError","from","update","in","select","length","console","log","updated_count","guests","path","url","method"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/guests/bulk-auth-method/route.ts"],"sourcesContent":["import { createAuthenticatedClient } from '@/lib/supabaseServer';\nimport { NextResponse } from 'next/server';\nimport { z } from 'zod';\n\n/**\n * POST /api/admin/guests/bulk-auth-method\n * \n * Updates authentication method for multiple guests\n * \n * Requirements: 22.7\n */\n\nconst bulkUpdateAuthMethodSchema = z.object({\n  guest_ids: z.array(z.string().uuid()).min(1).max(100),\n  auth_method: z.enum(['email_matching', 'magic_link']),\n  send_notification: z.boolean().optional().default(false),\n});\n\nfunction getStatusCode(errorCode: string): number {\n  const statusMap: Record<string, number> = {\n    'VALIDATION_ERROR': 400,\n    'UNAUTHORIZED': 401,\n    'FORBIDDEN': 403,\n    'DATABASE_ERROR': 500,\n    'INTERNAL_ERROR': 500,\n  };\n  return statusMap[errorCode] || 500;\n}\n\nexport async function POST(request: Request) {\n  try {\n    // 1. AUTHENTICATION\n    const supabase = await createAuthenticatedClient();\n    const {\n      data: { session },\n      error: authError,\n    } = await supabase.auth.getSession();\n\n    if (authError || !session) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n\n    // 2. VALIDATION\n    const body = await request.json();\n    const validation = bulkUpdateAuthMethodSchema.safeParse(body);\n\n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid request data',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    const { guest_ids, auth_method, send_notification } = validation.data;\n\n    // 3. SERVICE CALL\n    // Update all guests in a single query\n    const { data: updatedGuests, error: updateError } = await supabase\n      .from('guests')\n      .update({ auth_method })\n      .in('id', guest_ids)\n      .select('id, email, first_name, last_name, auth_method');\n\n    if (updateError) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: { code: 'DATABASE_ERROR', message: 'Failed to update guests', details: updateError },\n        },\n        { status: 500 }\n      );\n    }\n\n    // TODO: Send notification emails if requested (Task 8.3)\n    // This will be implemented when email system is enhanced\n    if (send_notification && updatedGuests && updatedGuests.length > 0) {\n      // Future: Send email notifications to guests about auth method change\n      console.log(`Would send notifications to ${updatedGuests.length} guests about auth method change`);\n    }\n\n    // 4. RESPONSE\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          updated_count: updatedGuests?.length || 0,\n          guests: updatedGuests || [],\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('API Error:', { path: request.url, method: request.method, error });\n    return NextResponse.json(\n      { success: false, error: { code: 'INTERNAL_ERROR', message: 'An unexpected error occurred' } },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}