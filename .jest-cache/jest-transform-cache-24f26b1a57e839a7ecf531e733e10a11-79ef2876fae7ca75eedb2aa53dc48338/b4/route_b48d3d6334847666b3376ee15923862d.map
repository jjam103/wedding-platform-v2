{"version":3,"names":["cov_md5rqgut5","actualCoverage","s","GET","request","f","cookieStore","_headers","cookies","supabase","_ssr","createServerClient","process","env","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","getAll","setAll","cookiesToSet","forEach","name","value","set","data","session","error","authError","auth","getSession","b","_server","NextResponse","json","success","code","message","status","currentStatus","_b2Service","getB2HealthStatus","now","Date","fiveMinutesAgo","getTime","healthStatus","lastChecked","checkResult","checkB2Health","details","healthy","toISOString","console","Error"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/storage/health/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createServerClient } from '@supabase/ssr';\nimport { cookies } from 'next/headers';\nimport { checkB2Health, getB2HealthStatus } from '@/services/b2Service';\n\n/**\n * GET /api/admin/storage/health\n * \n * Returns the health status of B2 storage.\n * Performs a new health check if the last check was more than 5 minutes ago.\n * \n * @returns Health status with last check time and any error details\n */\nexport async function GET(request: Request) {\n  try {\n    // 1. Auth check\n    const cookieStore = await cookies();\n    const supabase = createServerClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n      {\n        cookies: {\n          getAll() {\n            return cookieStore.getAll();\n          },\n          setAll(cookiesToSet) {\n            cookiesToSet.forEach(({ name, value }) => {\n              cookieStore.set(name, value);\n            });\n          },\n        },\n      }\n    );\n    \n    const {\n      data: { session },\n      error: authError,\n    } = await supabase.auth.getSession();\n    \n    if (authError || !session) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n\n    // 2. Get current health status\n    const currentStatus = getB2HealthStatus();\n    const now = new Date();\n    const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);\n\n    // 3. Perform new check if last check was more than 5 minutes ago\n    let healthStatus = currentStatus;\n    if (currentStatus.lastChecked < fiveMinutesAgo) {\n      const checkResult = await checkB2Health();\n      if (checkResult.success) {\n        healthStatus = checkResult.data;\n      } else {\n        return NextResponse.json(\n          {\n            success: false,\n            error: {\n              code: 'HEALTH_CHECK_FAILED',\n              message: 'Failed to perform health check',\n              details: checkResult.error,\n            },\n          },\n          { status: 500 }\n        );\n      }\n    }\n\n    // 4. Return health status\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          healthy: healthStatus.healthy,\n          lastChecked: healthStatus.lastChecked.toISOString(),\n          error: healthStatus.error,\n          status: healthStatus.healthy ? 'healthy' : 'unhealthy',\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('Storage health check error:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'INTERNAL_ERROR',\n          message: error instanceof Error ? error.message : 'Internal server error',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}