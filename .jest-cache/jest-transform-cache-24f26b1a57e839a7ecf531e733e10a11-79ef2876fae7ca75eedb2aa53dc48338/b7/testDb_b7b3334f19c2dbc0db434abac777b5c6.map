{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/helpers/testDb.ts"],"sourcesContent":["/**\n * Test Database Configuration\n * \n * Provides Supabase client instances configured for testing.\n * Supports both authenticated (RLS-enforced) and service role (RLS-bypassed) clients.\n */\n\nimport { createClient, SupabaseClient } from '@supabase/supabase-js';\n\n/**\n * Get Supabase URL from environment\n */\nfunction getSupabaseUrl(): string {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  if (!url) {\n    throw new Error('NEXT_PUBLIC_SUPABASE_URL is not set');\n  }\n  return url;\n}\n\n/**\n * Get Supabase anon key from environment\n */\nfunction getSupabaseAnonKey(): string {\n  const key = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n  if (!key) {\n    throw new Error('NEXT_PUBLIC_SUPABASE_ANON_KEY is not set');\n  }\n  return key;\n}\n\n/**\n * Get Supabase service role key from environment\n */\nfunction getSupabaseServiceKey(): string {\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!key) {\n    throw new Error('SUPABASE_SERVICE_ROLE_KEY is not set');\n  }\n  return key;\n}\n\n/**\n * Create an authenticated Supabase client for testing\n * This client respects RLS policies and should be used for most tests\n * \n * @param accessToken - Optional access token for authenticated requests\n * @returns Supabase client with RLS enforcement\n */\nexport function createTestClient(accessToken?: string): SupabaseClient {\n  const client = createClient(getSupabaseUrl(), getSupabaseAnonKey(), {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  });\n  \n  // If access token provided, set it for authenticated requests\n  if (accessToken) {\n    client.auth.setSession({\n      access_token: accessToken,\n      refresh_token: '',\n    });\n  }\n  \n  return client;\n}\n\n/**\n * Create a service role Supabase client for testing\n * This client bypasses RLS policies and should ONLY be used for:\n * - Test setup (creating test data)\n * - Test cleanup (deleting test data)\n * - Testing service-level logic that doesn't involve RLS\n * \n * WARNING: Never use this for testing RLS policies!\n * \n * @returns Supabase client with RLS bypass\n */\nexport function createServiceClient(): SupabaseClient {\n  return createClient(getSupabaseUrl(), getSupabaseServiceKey(), {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  });\n}\n\n/**\n * Test user credentials for authentication tests\n */\nexport interface TestUser {\n  email: string;\n  password: string;\n  id?: string;\n  accessToken?: string;\n  role?: 'super_admin' | 'host' | 'guest';\n}\n\n/**\n * Create a test user in the database\n * Uses service role to bypass RLS for user creation\n * \n * @param email - User email\n * @param password - User password\n * @param role - User role (super_admin, host, or guest)\n * @returns Test user with credentials\n */\nexport async function createTestUser(\n  email: string = `test.${Date.now()}@example.com`,\n  password: string = 'test123456',\n  role: 'super_admin' | 'host' | 'guest' = 'guest'\n): Promise<TestUser> {\n  const serviceClient = createServiceClient();\n  \n  // Create user with admin API\n  const { data, error } = await serviceClient.auth.admin.createUser({\n    email,\n    password,\n    email_confirm: true, // Auto-confirm email for testing\n  });\n  \n  if (error) {\n    throw new Error(`Failed to create test user: ${error.message}`);\n  }\n  \n  if (!data.user) {\n    throw new Error('User creation succeeded but no user returned');\n  }\n  \n  // Insert user record with role in users table\n  const { error: userError } = await serviceClient\n    .from('users')\n    .insert({\n      id: data.user.id,\n      email,\n      role,\n    });\n  \n  if (userError) {\n    // Clean up auth user if users table insert fails\n    await serviceClient.auth.admin.deleteUser(data.user.id);\n    throw new Error(`Failed to create user record: ${userError.message}`);\n  }\n  \n  return {\n    email,\n    password,\n    id: data.user.id,\n    role,\n  };\n}\n\n/**\n * Sign in a test user and get access token\n * \n * @param email - User email\n * @param password - User password\n * @returns Test user with access token\n */\nexport async function signInTestUser(\n  email: string,\n  password: string\n): Promise<TestUser> {\n  const client = createTestClient();\n  \n  const { data, error } = await client.auth.signInWithPassword({\n    email,\n    password,\n  });\n  \n  if (error) {\n    throw new Error(`Failed to sign in test user: ${error.message}`);\n  }\n  \n  if (!data.session) {\n    throw new Error('Sign in succeeded but no session returned');\n  }\n  \n  // Get user role from users table\n  const serviceClient = createServiceClient();\n  const { data: userData } = await serviceClient\n    .from('users')\n    .select('role')\n    .eq('id', data.user.id)\n    .single();\n  \n  return {\n    email,\n    password,\n    id: data.user.id,\n    accessToken: data.session.access_token,\n    role: userData?.role || 'guest',\n  };\n}\n\n/**\n * Delete a test user from the database\n * Uses service role to bypass RLS for user deletion\n * \n * @param userId - User ID to delete\n */\nexport async function deleteTestUser(userId: string): Promise<void> {\n  const serviceClient = createServiceClient();\n  \n  const { error } = await serviceClient.auth.admin.deleteUser(userId);\n  \n  if (error) {\n    console.error(`Failed to delete test user ${userId}:`, error);\n  }\n}\n\n/**\n * Create and sign in a test user in one step\n * Useful for tests that need an authenticated user\n * \n * @param options - Optional user configuration\n * @returns Test user with access token\n */\nexport async function createAndSignInTestUser(options?: {\n  email?: string;\n  password?: string;\n  role?: 'super_admin' | 'host' | 'guest';\n}): Promise<TestUser> {\n  const email = options?.email || `test.${Date.now()}@example.com`;\n  const password = options?.password || 'test123456';\n  const role = options?.role || 'guest';\n  \n  await createTestUser(email, password, role);\n  return signInTestUser(email, password);\n}\n\n/**\n * Test database helper class for managing test data lifecycle\n */\nexport class TestDatabase {\n  private serviceClient: SupabaseClient;\n  private testClient: SupabaseClient;\n  private createdUsers: string[] = [];\n  \n  constructor() {\n    this.serviceClient = createServiceClient();\n    this.testClient = createTestClient();\n  }\n  \n  /**\n   * Get service client (bypasses RLS)\n   */\n  getServiceClient(): SupabaseClient {\n    return this.serviceClient;\n  }\n  \n  /**\n   * Get test client (respects RLS)\n   */\n  getTestClient(): SupabaseClient {\n    return this.testClient;\n  }\n  \n  /**\n   * Create an authenticated test client\n   */\n  async createAuthenticatedClient(): Promise<{ client: SupabaseClient; user: TestUser }> {\n    const user = await createAndSignInTestUser();\n    this.createdUsers.push(user.id!);\n    \n    const client = createTestClient(user.accessToken);\n    \n    return { client, user };\n  }\n  \n  /**\n   * Clean up all test data and users\n   */\n  async cleanup(): Promise<void> {\n    // Delete created users\n    for (const userId of this.createdUsers) {\n      await deleteTestUser(userId);\n    }\n    \n    this.createdUsers = [];\n  }\n}\n\n/**\n * Create a test database instance\n */\nexport function createTestDatabase(): TestDatabase {\n  return new TestDatabase();\n}\n\n/**\n * Helper to run a test with automatic database cleanup\n */\nexport async function withTestDatabase<T>(\n  fn: (db: TestDatabase) => Promise<T>\n): Promise<T> {\n  const db = createTestDatabase();\n  \n  try {\n    return await fn(db);\n  } finally {\n    await db.cleanup();\n  }\n}\n\n/**\n * Wait for database operation to complete\n * Useful for tests that need to wait for async operations\n */\nexport async function waitForDb(ms: number = 100): Promise<void> {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Retry a database operation with exponential backoff\n * Useful for handling transient database errors\n */\nexport async function retryDbOperation<T>(\n  operation: () => Promise<T>,\n  maxRetries: number = 3,\n  baseDelay: number = 100\n): Promise<T> {\n  let lastError: Error | null = null;\n  \n  for (let i = 0; i < maxRetries; i++) {\n    try {\n      return await operation();\n    } catch (error) {\n      lastError = error instanceof Error ? error : new Error(String(error));\n      \n      if (i < maxRetries - 1) {\n        const delay = baseDelay * Math.pow(2, i);\n        await waitForDb(delay);\n      }\n    }\n  }\n  \n  throw lastError || new Error('Operation failed after retries');\n}\n\n\n/**\n * Test database helper object with convenience methods\n */\nexport const testDb = {\n  /**\n   * Create a guest in the test database\n   */\n  async createGuest(data: {\n    email: string;\n    auth_method: 'email_matching' | 'magic_link';\n    first_name: string;\n    last_name: string;\n    group_id?: string;\n  }) {\n    const serviceClient = createServiceClient();\n    \n    // Create group if not provided\n    let groupId = data.group_id;\n    if (!groupId) {\n      const { data: group, error: groupError } = await serviceClient\n        .from('groups')\n        .insert({ name: `Test Group ${Date.now()}` })\n        .select()\n        .single();\n      \n      if (groupError) throw new Error(`Failed to create group: ${groupError.message}`);\n      groupId = group.id;\n    }\n    \n    const { data: guest, error } = await serviceClient\n      .from('guests')\n      .insert({\n        email: data.email,\n        auth_method: data.auth_method,\n        first_name: data.first_name,\n        last_name: data.last_name,\n        group_id: groupId,\n        age_type: 'adult',\n        guest_type: 'wedding_guest',\n      })\n      .select()\n      .single();\n    \n    if (error) throw new Error(`Failed to create guest: ${error.message}`);\n    return guest;\n  },\n\n  /**\n   * Get guest sessions for a specific guest\n   */\n  async getGuestSessions(guestId: string) {\n    const serviceClient = createServiceClient();\n    \n    const { data, error } = await serviceClient\n      .from('guest_sessions')\n      .select('*')\n      .eq('guest_id', guestId)\n      .order('created_at', { ascending: false });\n    \n    if (error) throw new Error(`Failed to get guest sessions: ${error.message}`);\n    return data || [];\n  },\n\n  /**\n   * Get all guest sessions\n   */\n  async getAllGuestSessions() {\n    const serviceClient = createServiceClient();\n    \n    const { data, error } = await serviceClient\n      .from('guest_sessions')\n      .select('*');\n    \n    if (error) throw new Error(`Failed to get all guest sessions: ${error.message}`);\n    return data || [];\n  },\n\n  /**\n   * Get audit logs matching criteria\n   */\n  async getAuditLogs(criteria: {\n    action?: string;\n    entity_type?: string;\n    entity_id?: string;\n  }) {\n    const serviceClient = createServiceClient();\n    \n    let query = serviceClient.from('audit_logs').select('*');\n    \n    if (criteria.action) {\n      query = query.eq('action', criteria.action);\n    }\n    if (criteria.entity_type) {\n      query = query.eq('entity_type', criteria.entity_type);\n    }\n    if (criteria.entity_id) {\n      query = query.eq('entity_id', criteria.entity_id);\n    }\n    \n    const { data, error } = await query.order('created_at', { ascending: false });\n    \n    if (error) throw new Error(`Failed to get audit logs: ${error.message}`);\n    return data || [];\n  },\n\n  /**\n   * Get all guests\n   */\n  async getAllGuests() {\n    const serviceClient = createServiceClient();\n    \n    const { data, error } = await serviceClient\n      .from('guests')\n      .select('*');\n    \n    if (error) throw new Error(`Failed to get all guests: ${error.message}`);\n    return data || [];\n  },\n\n  /**\n   * Create a magic link token in the test database\n   */\n  async createMagicLinkToken(data: {\n    guest_id: string;\n    expires_at: string;\n    used?: boolean;\n    used_at?: string;\n  }) {\n    const serviceClient = createServiceClient();\n    \n    // Generate secure token (32 bytes = 64 hex characters)\n    const tokenBytes = crypto.getRandomValues(new Uint8Array(32));\n    const token = Array.from(tokenBytes)\n      .map(b => b.toString(16).padStart(2, '0'))\n      .join('');\n    \n    const { data: tokenRecord, error } = await serviceClient\n      .from('magic_link_tokens')\n      .insert({\n        guest_id: data.guest_id,\n        token,\n        expires_at: data.expires_at,\n        used: data.used || false,\n        used_at: data.used_at || null,\n        ip_address: 'test-ip',\n        user_agent: 'test-agent',\n      })\n      .select()\n      .single();\n    \n    if (error) throw new Error(`Failed to create magic link token: ${error.message}`);\n    return tokenRecord;\n  },\n\n  /**\n   * Get magic link tokens for a specific guest\n   */\n  async getMagicLinkTokens(guestId: string) {\n    const serviceClient = createServiceClient();\n    \n    const { data, error } = await serviceClient\n      .from('magic_link_tokens')\n      .select('*')\n      .eq('guest_id', guestId)\n      .order('created_at', { ascending: false });\n    \n    if (error) throw new Error(`Failed to get magic link tokens: ${error.message}`);\n    return data || [];\n  },\n\n  /**\n   * Get a specific magic link token by ID\n   */\n  async getMagicLinkToken(tokenId: string) {\n    const serviceClient = createServiceClient();\n    \n    const { data, error } = await serviceClient\n      .from('magic_link_tokens')\n      .select('*')\n      .eq('id', tokenId)\n      .single();\n    \n    if (error) throw new Error(`Failed to get magic link token: ${error.message}`);\n    return data;\n  },\n\n  /**\n   * Delete a guest and all related data\n   */\n  async deleteGuest(guestId: string) {\n    const serviceClient = createServiceClient();\n    \n    // Delete related data first\n    await serviceClient.from('guest_sessions').delete().eq('guest_id', guestId);\n    await serviceClient.from('magic_link_tokens').delete().eq('guest_id', guestId);\n    \n    // Delete guest\n    const { error } = await serviceClient\n      .from('guests')\n      .delete()\n      .eq('id', guestId);\n    \n    if (error) throw new Error(`Failed to delete guest: ${error.message}`);\n  },\n};\n"],"names":["TestDatabase","createAndSignInTestUser","createServiceClient","createTestClient","createTestDatabase","createTestUser","deleteTestUser","retryDbOperation","signInTestUser","testDb","waitForDb","withTestDatabase","getSupabaseUrl","url","process","env","NEXT_PUBLIC_SUPABASE_URL","Error","getSupabaseAnonKey","key","NEXT_PUBLIC_SUPABASE_ANON_KEY","getSupabaseServiceKey","SUPABASE_SERVICE_ROLE_KEY","accessToken","client","createClient","auth","autoRefreshToken","persistSession","setSession","access_token","refresh_token","email","Date","now","password","role","serviceClient","data","error","admin","createUser","email_confirm","message","user","userError","from","insert","id","deleteUser","signInWithPassword","session","userData","select","eq","single","userId","console","options","createdUsers","testClient","getServiceClient","getTestClient","createAuthenticatedClient","push","cleanup","fn","db","ms","Promise","resolve","setTimeout","operation","maxRetries","baseDelay","lastError","i","String","delay","Math","pow","createGuest","groupId","group_id","group","groupError","name","guest","auth_method","first_name","last_name","age_type","guest_type","getGuestSessions","guestId","order","ascending","getAllGuestSessions","getAuditLogs","criteria","query","action","entity_type","entity_id","getAllGuests","createMagicLinkToken","tokenBytes","crypto","getRandomValues","Uint8Array","token","Array","map","b","toString","padStart","join","tokenRecord","guest_id","expires_at","used","used_at","ip_address","user_agent","getMagicLinkTokens","getMagicLinkToken","tokenId","deleteGuest","delete"],"mappings":"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"}