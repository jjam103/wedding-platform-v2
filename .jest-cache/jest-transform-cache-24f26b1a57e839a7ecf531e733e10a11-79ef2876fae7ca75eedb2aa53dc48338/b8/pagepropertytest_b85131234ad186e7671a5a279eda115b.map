{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/admin/settings/page.property.test.tsx"],"sourcesContent":["/**\n * Property Tests for Settings Page\n * \n * Feature: admin-ui-modernization, Property 38: Settings validation and persistence\n * Validates: Requirements 20.5\n */\n\nimport { render, screen, fireEvent, waitFor, cleanup } from '@testing-library/react';\nimport '@testing-library/jest-dom';\nimport * as fc from 'fast-check';\nimport SettingsForm from '@/components/admin/SettingsForm';\nimport type { SystemSettings } from '@/schemas/settingsSchemas';\n\n// Mock Next.js router\njest.mock('next/navigation', () => ({\n  useRouter: () => ({\n    push: jest.fn(),\n    replace: jest.fn(),\n    prefetch: jest.fn(),\n    refresh: jest.fn(),\n  }),\n}));\n\n// Mock fetch\nglobal.fetch = jest.fn();\n\n// Arbitraries for property-based testing\nconst validDateArbitrary = fc.date({ min: new Date('2024-01-01'), max: new Date('2030-12-31') });\n\nconst validSettingsArbitrary = fc.record({\n  wedding_date: fc.option(validDateArbitrary, { nil: null }),\n  venue_name: fc.option(fc.string({ minLength: 1, maxLength: 200 }), { nil: null }),\n  couple_name_1: fc.option(fc.string({ minLength: 1, maxLength: 100 }), { nil: null }),\n  couple_name_2: fc.option(fc.string({ minLength: 1, maxLength: 100 }), { nil: null }),\n  timezone: fc.constantFrom(\n    'America/Costa_Rica',\n    'America/New_York',\n    'America/Chicago',\n    'America/Denver',\n    'America/Los_Angeles',\n    'Europe/London',\n    'Europe/Paris',\n    'Asia/Tokyo'\n  ),\n  send_rsvp_confirmations: fc.boolean(),\n  send_activity_reminders: fc.boolean(),\n  send_deadline_reminders: fc.boolean(),\n  reminder_days_before: fc.integer({ min: 1, max: 30 }),\n  require_photo_moderation: fc.boolean(),\n  max_photos_per_guest: fc.integer({ min: 1, max: 100 }),\n  // Add missing home page fields to match SystemSettings type\n  home_page_title: fc.option(fc.string({ minLength: 1, maxLength: 200 }), { nil: null }),\n  home_page_subtitle: fc.option(fc.string({ maxLength: 500 }), { nil: null }),\n  home_page_welcome_message: fc.option(fc.string(), { nil: null }),\n  home_page_hero_image_url: fc.option(fc.webUrl(), { nil: null }),\n});\n\n// Helper function to create complete SystemSettings object with unique data\nfunction createSystemSettings(partial: any): SystemSettings {\n  const uniqueId = `test-id-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;\n  return {\n    id: uniqueId,\n    wedding_date: partial.wedding_date?.toISOString() || null,\n    venue_name: partial.venue_name || null,\n    couple_name_1: partial.couple_name_1 || null,\n    couple_name_2: partial.couple_name_2 || null,\n    timezone: partial.timezone,\n    send_rsvp_confirmations: partial.send_rsvp_confirmations,\n    send_activity_reminders: partial.send_activity_reminders,\n    send_deadline_reminders: partial.send_deadline_reminders,\n    reminder_days_before: partial.reminder_days_before,\n    require_photo_moderation: partial.require_photo_moderation,\n    max_photos_per_guest: partial.max_photos_per_guest,\n    allowed_photo_formats: ['jpg', 'jpeg', 'png', 'heic'],\n    home_page_title: partial.home_page_title || null,\n    home_page_subtitle: partial.home_page_subtitle || null,\n    home_page_welcome_message: partial.home_page_welcome_message || null,\n    home_page_hero_image_url: partial.home_page_hero_image_url || null,\n    created_at: new Date().toISOString(),\n    updated_at: new Date().toISOString(),\n  };\n}\n\n\ndescribe('Feature: admin-ui-modernization, Property 38: Settings validation and persistence', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    // Clear any existing DOM\n    document.body.innerHTML = '';\n  });\n\n  afterEach(() => {\n    cleanup();\n    jest.clearAllMocks();\n  });\n\n  it('should persist valid settings and display success toast', async () => {\n    await fc.assert(\n      fc.asyncProperty(validSettingsArbitrary, async (settings) => {\n        // Clear DOM and mocks for each property test run\n        cleanup();\n        jest.clearAllMocks();\n        \n        // Mock successful API response\n        (global.fetch as jest.Mock).mockResolvedValueOnce({\n          ok: true,\n          json: async () => ({\n            success: true,\n            data: createSystemSettings(settings),\n          }),\n        });\n\n        // Create complete SystemSettings object\n        const initialSettings = createSystemSettings(settings);\n\n        const { container } = render(<SettingsForm initialSettings={initialSettings} />);\n\n        // Submit the form using container to avoid multiple element issues\n        const submitButton = container.querySelector('button[type=\"submit\"]') as HTMLButtonElement;\n        expect(submitButton).toBeTruthy();\n        fireEvent.click(submitButton);\n\n        // Wait for the API call and success toast with reduced timeout\n        await waitFor(\n          () => {\n            expect(global.fetch).toHaveBeenCalledWith(\n              '/api/admin/settings',\n              expect.objectContaining({\n                method: 'PUT',\n                headers: { 'Content-Type': 'application/json' },\n              })\n            );\n          },\n          { timeout: 1000 }\n        );\n\n        // Verify success toast is displayed\n        await waitFor(\n          () => {\n            const successMessage = container.querySelector('[class*=\"bg-jungle-50\"]');\n            expect(successMessage).toBeTruthy();\n            expect(successMessage?.textContent).toMatch(/settings saved successfully/i);\n          },\n          { timeout: 1000 }\n        );\n      }),\n      { numRuns: 10 } // Further reduced for better performance and reliability\n    );\n  }, 15000); // Increased test timeout\n\n  it('should display error toast when settings validation fails', async () => {\n    // Clear DOM and mocks\n    cleanup();\n    jest.clearAllMocks();\n    \n    // Mock validation error response\n    (global.fetch as jest.Mock).mockResolvedValueOnce({\n      ok: false,\n      status: 400,\n      json: async () => ({\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Validation failed',\n          details: [{ path: ['reminder_days_before'], message: 'Must be between 1 and 30' }],\n        },\n      }),\n    });\n\n    const initialSettings = createSystemSettings({\n      wedding_date: null,\n      venue_name: null,\n      couple_name_1: null,\n      couple_name_2: null,\n      timezone: 'America/Costa_Rica',\n      send_rsvp_confirmations: true,\n      send_activity_reminders: true,\n      send_deadline_reminders: true,\n      reminder_days_before: 7,\n      require_photo_moderation: true,\n      max_photos_per_guest: 20,\n      home_page_title: null,\n      home_page_subtitle: null,\n      home_page_welcome_message: null,\n      home_page_hero_image_url: null,\n    });\n\n    const { container } = render(<SettingsForm initialSettings={initialSettings} />);\n\n    // Submit the form using container\n    const submitButton = container.querySelector('button[type=\"submit\"]') as HTMLButtonElement;\n    expect(submitButton).toBeTruthy();\n    fireEvent.click(submitButton);\n\n    // Wait for error toast with reduced timeout\n    await waitFor(\n      () => {\n        const errorMessage = container.querySelector('[class*=\"bg-volcano-50\"]');\n        expect(errorMessage).toBeTruthy();\n        expect(errorMessage?.textContent).toMatch(/failed to save settings|validation failed/i);\n      },\n      { timeout: 1000 }\n    );\n  });\n\n  it('should disable submit button and show loading state during submission', async () => {\n    await fc.assert(\n      fc.asyncProperty(validSettingsArbitrary, async (settings) => {\n        // Clear DOM and mocks for each property test run\n        cleanup();\n        jest.clearAllMocks();\n        \n        // Mock delayed API response\n        (global.fetch as jest.Mock).mockImplementationOnce(\n          () =>\n            new Promise((resolve) =>\n              setTimeout(\n                () =>\n                  resolve({\n                    ok: true,\n                    json: async () => ({\n                      success: true,\n                      data: createSystemSettings(settings),\n                    }),\n                  }),\n                50 // Reduced delay\n              )\n            )\n        );\n\n        const initialSettings = createSystemSettings(settings);\n\n        const { container } = render(<SettingsForm initialSettings={initialSettings} />);\n\n        // Submit the form using container\n        const submitButton = container.querySelector('button[type=\"submit\"]') as HTMLButtonElement;\n        expect(submitButton).toBeTruthy();\n        fireEvent.click(submitButton);\n\n        // Check that button is disabled and shows loading state\n        await waitFor(() => {\n          const loadingButton = container.querySelector('button[type=\"submit\"]') as HTMLButtonElement;\n          expect(loadingButton).toBeDisabled();\n          expect(loadingButton.textContent).toMatch(/saving/i);\n        }, { timeout: 500 });\n      }),\n      { numRuns: 5 } // Further reduced for better performance\n    );\n  }, 10000); // Increased test timeout\n});\n"],"names":["jest","mock","useRouter","push","fn","replace","prefetch","refresh","global","fetch","validDateArbitrary","fc","date","min","Date","max","validSettingsArbitrary","record","wedding_date","option","nil","venue_name","string","minLength","maxLength","couple_name_1","couple_name_2","timezone","constantFrom","send_rsvp_confirmations","boolean","send_activity_reminders","send_deadline_reminders","reminder_days_before","integer","require_photo_moderation","max_photos_per_guest","home_page_title","home_page_subtitle","home_page_welcome_message","home_page_hero_image_url","webUrl","createSystemSettings","partial","uniqueId","now","Math","random","toString","substr","id","toISOString","allowed_photo_formats","created_at","updated_at","describe","beforeEach","clearAllMocks","document","body","innerHTML","afterEach","cleanup","it","assert","asyncProperty","settings","mockResolvedValueOnce","ok","json","success","data","initialSettings","container","render","SettingsForm","submitButton","querySelector","expect","toBeTruthy","fireEvent","click","waitFor","toHaveBeenCalledWith","objectContaining","method","headers","timeout","successMessage","textContent","toMatch","numRuns","status","error","code","message","details","path","errorMessage","mockImplementationOnce","Promise","resolve","setTimeout","loadingButton","toBeDisabled"],"mappings":"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"}