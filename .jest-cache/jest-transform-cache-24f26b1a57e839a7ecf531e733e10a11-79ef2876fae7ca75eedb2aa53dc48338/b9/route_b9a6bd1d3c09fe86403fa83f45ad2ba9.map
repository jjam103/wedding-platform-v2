{"version":3,"names":["cov_2mvyeuvml9","actualCoverage","s","GET","request","f","auth","_apiAuth","getAuthenticatedUser","b","_server","NextResponse","json","success","error","code","message","status","user","supabase","data","guest","guestError","from","select","eq","email","single","events","eventsError","or","guest_type","gte","Date","toISOString","order","ascending","activities","activitiesError","rsvps","rsvpsError","id","rsvpMap","Map","forEach","rsvp","event_id","set","activity_id","combinedEvents","map","event","name","type","date","start_date","time","location","location_id","rsvpStatus","get","activity","start_time","sort","a","getTime","Error"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/guest/events/route.ts"],"sourcesContent":["import { getAuthenticatedUser } from '@/lib/apiAuth';\nimport { NextResponse } from 'next/server';\n\n/**\n * GET /api/guest/events\n * \n * Retrieves upcoming events and activities for the authenticated guest.\n * Returns combined list of events and activities with RSVP status.\n * \n * Requirements: 13.1, 13.5\n */\nexport async function GET(request: Request) {\n  try {\n    const auth = await getAuthenticatedUser();\n    \n    if (!auth) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n\n    const { user, supabase } = auth;\n    \n    // Get guest information\n    const { data: guest, error: guestError } = await supabase\n      .from('guests')\n      .select('id, guest_type')\n      .eq('email', user.email)\n      .single();\n    \n    if (guestError || !guest) {\n      return NextResponse.json(\n        { success: false, error: { code: 'GUEST_NOT_FOUND', message: 'Guest not found' } },\n        { status: 404 }\n      );\n    }\n    \n    // Fetch published events visible to this guest type\n    const { data: events, error: eventsError } = await supabase\n      .from('events')\n      .select('id, name, event_type, start_date, end_date, location_id, rsvp_required')\n      .eq('status', 'published')\n      .or(`visibility.cs.{${guest.guest_type}},visibility.eq.{}`)\n      .gte('start_date', new Date().toISOString())\n      .order('start_date', { ascending: true });\n    \n    if (eventsError) {\n      return NextResponse.json(\n        { success: false, error: { code: 'DATABASE_ERROR', message: eventsError.message } },\n        { status: 500 }\n      );\n    }\n    \n    // Fetch published activities visible to this guest type\n    const { data: activities, error: activitiesError } = await supabase\n      .from('activities')\n      .select('id, name, activity_type, start_time, end_time, location_id, event_id')\n      .eq('status', 'published')\n      .or(`visibility.cs.{${guest.guest_type}},visibility.eq.{}`)\n      .gte('start_time', new Date().toISOString())\n      .order('start_time', { ascending: true });\n    \n    if (activitiesError) {\n      return NextResponse.json(\n        { success: false, error: { code: 'DATABASE_ERROR', message: activitiesError.message } },\n        { status: 500 }\n      );\n    }\n    \n    // Fetch RSVPs for this guest\n    const { data: rsvps, error: rsvpsError } = await supabase\n      .from('rsvps')\n      .select('event_id, activity_id, status')\n      .eq('guest_id', guest.id);\n    \n    if (rsvpsError) {\n      return NextResponse.json(\n        { success: false, error: { code: 'DATABASE_ERROR', message: rsvpsError.message } },\n        { status: 500 }\n      );\n    }\n    \n    // Create RSVP lookup map\n    const rsvpMap = new Map<string, string>();\n    rsvps?.forEach(rsvp => {\n      if (rsvp.event_id) {\n        rsvpMap.set(`event-${rsvp.event_id}`, rsvp.status);\n      }\n      if (rsvp.activity_id) {\n        rsvpMap.set(`activity-${rsvp.activity_id}`, rsvp.status);\n      }\n    });\n    \n    // Combine and format events and activities\n    const combinedEvents = [\n      ...(events || []).map(event => ({\n        id: event.id,\n        name: event.name,\n        type: 'event' as const,\n        date: event.start_date,\n        time: event.start_date,\n        location: event.location_id,\n        rsvpStatus: rsvpMap.get(`event-${event.id}`) || 'pending',\n      })),\n      ...(activities || []).map(activity => ({\n        id: activity.id,\n        name: activity.name,\n        type: 'activity' as const,\n        date: activity.start_time,\n        time: activity.start_time,\n        location: activity.location_id,\n        rsvpStatus: rsvpMap.get(`activity-${activity.id}`) || 'pending',\n      })),\n    ].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());\n    \n    return NextResponse.json({ success: true, data: combinedEvents });\n  } catch (error) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'UNKNOWN_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}