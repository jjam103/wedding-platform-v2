{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/references/validate/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { cookies } from 'next/headers';\nimport { z } from 'zod';\nimport * as sectionsService from '@/services/sectionsService';\n\n/**\n * Reference Validation API Route\n * \n * POST /api/admin/references/validate\n * \n * Validates references for:\n * - Existence in database (broken reference detection)\n * - Circular reference detection\n * \n * Requirements: 21.8, 21.9\n */\n\nconst validateRequestSchema = z.object({\n  pageId: z.string().uuid().optional(),\n  pageType: z.string().optional(),\n  references: z.array(\n    z.object({\n      type: z.enum(['event', 'activity', 'content_page', 'accommodation']),\n      id: z.string().uuid(),\n      name: z.string(),\n      description: z.string().optional(),\n      metadata: z.record(z.any()).optional(),\n    })\n  ),\n});\n\nexport async function POST(request: Request) {\n  try {\n    // 1. Auth check\n    const supabase = createRouteHandlerClient({ cookies });\n    const {\n      data: { session },\n      error: authError,\n    } = await supabase.auth.getSession();\n\n    if (authError || !session) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'UNAUTHORIZED',\n            message: 'Authentication required',\n          },\n        },\n        { status: 401 }\n      );\n    }\n\n    // 2. Parse and validate request\n    const body = await request.json();\n    const validation = validateRequestSchema.safeParse(body);\n\n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid request',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n\n    const { pageId, pageType, references } = validation.data;\n\n    // 3. Check for circular references if pageId and pageType provided\n    let hasCircularReference = false;\n    if (pageId && pageType) {\n      const circularResult = await sectionsService.detectCircularReferences(\n        pageId,\n        references\n      );\n\n      if (!circularResult.success) {\n        return NextResponse.json(\n          {\n            success: false,\n            error: {\n              code: 'VALIDATION_ERROR',\n              message: circularResult.error.message,\n              details: circularResult.error.details,\n            },\n          },\n          { status: 500 }\n        );\n      }\n\n      hasCircularReference = circularResult.data;\n    }\n\n    // 4. Validate reference existence (broken reference detection)\n    const validationResult = await sectionsService.validateReferences(references);\n\n    if (!validationResult.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: validationResult.error.message,\n            details: validationResult.error.details,\n          },\n        },\n        { status: 500 }\n      );\n    }\n\n    // 5. Return validation result\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          valid: validationResult.data.valid && !hasCircularReference,\n          hasCircularReference,\n          brokenReferences: validationResult.data.brokenReferences,\n          circularReferences: validationResult.data.circularReferences,\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('Reference validation error:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'INTERNAL_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["POST","validateRequestSchema","z","object","pageId","string","uuid","optional","pageType","references","array","type","enum","id","name","description","metadata","record","any","request","supabase","createRouteHandlerClient","cookies","data","session","error","authError","auth","getSession","NextResponse","json","success","code","message","status","body","validation","safeParse","details","issues","hasCircularReference","circularResult","sectionsService","detectCircularReferences","validationResult","validateReferences","valid","brokenReferences","circularReferences","console","Error"],"mappings":"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"}