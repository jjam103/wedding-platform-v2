{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/adminUserService.ownerOnlyActions.property.test.ts"],"sourcesContent":["/**\n * Property-Based Test: Owner-Only Action Restriction\n * \n * Feature: destination-wedding-platform\n * Property 10: Owner-Only Action Restriction\n * \n * Validates: Requirements 3.4\n * \n * Property: Certain administrative actions (delete wedding, manage billing, manage admin users)\n * MUST be restricted to users with the 'owner' role only.\n */\n\nimport * as fc from 'fast-check';\nimport { adminUserService } from './adminUserService';\nimport { createClient } from '@/lib/supabaseServer';\n\n// Mock dependencies\njest.mock('@/lib/supabaseServer');\n\nconst mockSupabase = {\n  from: jest.fn().mockReturnThis(),\n  select: jest.fn().mockReturnThis(),\n  insert: jest.fn().mockReturnThis(),\n  update: jest.fn().mockReturnThis(),\n  delete: jest.fn().mockReturnThis(),\n  eq: jest.fn().mockReturnThis(),\n  single: jest.fn(),\n};\n\ndescribe('Feature: destination-wedding-platform, Property 10: Owner-Only Action Restriction', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (createClient as jest.Mock).mockReturnValue(mockSupabase);\n  });\n\n  it('should allow owners to create admin users', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.record({\n          email: fc.emailAddress(),\n          role: fc.constantFrom('admin' as const, 'owner' as const),\n        }),\n        fc.uuid(), // invitedBy (owner ID)\n        async (adminData, ownerId) => {\n          // Arrange: Mock no existing user\n          mockSupabase.single.mockResolvedValueOnce({\n            data: null,\n            error: null,\n          });\n\n          // Mock successful creation\n          mockSupabase.single.mockResolvedValueOnce({\n            data: {\n              id: fc.sample(fc.uuid(), 1)[0],\n              ...adminData,\n              status: 'active',\n              invited_by: ownerId,\n              invited_at: new Date().toISOString(),\n              created_at: new Date().toISOString(),\n              updated_at: new Date().toISOString(),\n            },\n            error: null,\n          });\n\n          // Act: Owner creates admin user\n          const result = await adminUserService.create(adminData, ownerId);\n\n          // Assert: Should succeed\n          expect(result.success).toBe(true);\n          expect(result.data).toBeDefined();\n          expect(result.data?.invited_by).toBe(ownerId);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should allow owners to update admin user roles', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.uuid(), // admin user ID\n        fc.constantFrom('admin' as const, 'owner' as const), // new role\n        async (adminUserId, newRole) => {\n          // Arrange: Mock existing admin user\n          mockSupabase.single.mockResolvedValueOnce({\n            data: {\n              id: adminUserId,\n              email: 'admin@example.com',\n              role: 'admin',\n              status: 'active',\n              created_at: new Date().toISOString(),\n              updated_at: new Date().toISOString(),\n            },\n            error: null,\n          });\n\n          // Mock successful update\n          mockSupabase.single.mockResolvedValueOnce({\n            data: {\n              id: adminUserId,\n              email: 'admin@example.com',\n              role: newRole,\n              status: 'active',\n              created_at: new Date().toISOString(),\n              updated_at: new Date().toISOString(),\n            },\n            error: null,\n          });\n\n          // Act: Update role\n          const result = await adminUserService.update(adminUserId, { role: newRole });\n\n          // Assert: Should succeed\n          expect(result.success).toBe(true);\n          expect(result.data?.role).toBe(newRole);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should allow owners to deactivate admin users', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.uuid(), // admin user ID\n        async (adminUserId) => {\n          // Arrange: Mock existing admin user (not an owner)\n          mockSupabase.single.mockResolvedValueOnce({\n            data: {\n              id: adminUserId,\n              email: 'admin@example.com',\n              role: 'admin',\n              status: 'active',\n              created_at: new Date().toISOString(),\n              updated_at: new Date().toISOString(),\n            },\n            error: null,\n          });\n\n          // Mock count query for last owner check (returns 2 owners)\n          mockSupabase.select.mockReturnValueOnce({\n            eq: jest.fn().mockReturnThis(),\n            single: jest.fn().mockResolvedValue({\n              count: 2,\n              error: null,\n            }),\n          });\n\n          // Mock successful deactivation\n          mockSupabase.single.mockResolvedValueOnce({\n            data: {\n              id: adminUserId,\n              email: 'admin@example.com',\n              role: 'admin',\n              status: 'inactive',\n              created_at: new Date().toISOString(),\n              updated_at: new Date().toISOString(),\n            },\n            error: null,\n          });\n\n          // Act: Deactivate admin user\n          const result = await adminUserService.deactivate(adminUserId);\n\n          // Assert: Should succeed\n          expect(result.success).toBe(true);\n          expect(result.data?.status).toBe('inactive');\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should allow owners to delete admin users', async () => {\n    await fc.assert(\n      fc.asyncProperty(\n        fc.uuid(), // admin user ID\n        async (adminUserId) => {\n          // Arrange: Mock existing admin user (not an owner)\n          mockSupabase.single.mockResolvedValueOnce({\n            data: {\n              id: adminUserId,\n              email: 'admin@example.com',\n              role: 'admin',\n              status: 'active',\n              created_at: new Date().toISOString(),\n              updated_at: new Date().toISOString(),\n            },\n            error: null,\n          });\n\n          // Mock count query for last owner check (returns 2 owners)\n          mockSupabase.select.mockReturnValueOnce({\n            eq: jest.fn().mockReturnThis(),\n            single: jest.fn().mockResolvedValue({\n              count: 2,\n              error: null,\n            }),\n          });\n\n          // Mock successful deletion\n          mockSupabase.delete.mockReturnValueOnce({\n            eq: jest.fn().mockResolvedValue({\n              error: null,\n            }),\n          });\n\n          // Act: Delete admin user\n          const result = await adminUserService.delete(adminUserId);\n\n          // Assert: Should succeed\n          expect(result.success).toBe(true);\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should enforce owner-only restrictions in API layer', async () => {\n    // This property test verifies that the service layer provides the foundation\n    // for owner-only restrictions. The actual enforcement happens in API routes\n    // which check the requesting user's role before calling these service methods.\n    \n    await fc.assert(\n      fc.asyncProperty(\n        fc.record({\n          adminUserId: fc.uuid(),\n          requestingUserRole: fc.constantFrom('admin' as const, 'owner' as const),\n        }),\n        async ({ adminUserId, requestingUserRole }) => {\n          // Arrange: Mock existing admin user\n          mockSupabase.single.mockResolvedValueOnce({\n            data: {\n              id: adminUserId,\n              email: 'admin@example.com',\n              role: 'admin',\n              status: 'active',\n              created_at: new Date().toISOString(),\n              updated_at: new Date().toISOString(),\n            },\n            error: null,\n          });\n\n          // Mock count query for last owner check\n          mockSupabase.select.mockReturnValueOnce({\n            eq: jest.fn().mockReturnThis(),\n            single: jest.fn().mockResolvedValue({\n              count: 2,\n              error: null,\n            }),\n          });\n\n          // Mock successful deletion\n          mockSupabase.delete.mockReturnValueOnce({\n            eq: jest.fn().mockResolvedValue({\n              error: null,\n            }),\n          });\n\n          // Act: Attempt to delete (service layer doesn't check role)\n          const result = await adminUserService.delete(adminUserId);\n\n          // Assert: Service layer allows the operation\n          // API layer is responsible for checking requestingUserRole === 'owner'\n          expect(result.success).toBe(true);\n          \n          // Note: In the API route, we would check:\n          // if (requestingUserRole !== 'owner') {\n          //   return { success: false, error: { code: 'FORBIDDEN', message: 'Owner role required' } };\n          // }\n        }\n      ),\n      { numRuns: 100 }\n    );\n  });\n\n  it('should document owner-only actions in service methods', async () => {\n    // This test verifies that owner-only actions are clearly documented\n    // The actual enforcement happens in API routes, but service methods\n    // should be designed with this restriction in mind\n    \n    const ownerOnlyMethods = [\n      'create',      // Creating admin users\n      'update',      // Updating admin user roles\n      'deactivate',  // Deactivating admin users\n      'delete',      // Deleting admin users\n    ];\n\n    // Verify all owner-only methods exist\n    ownerOnlyMethods.forEach(method => {\n      expect(adminUserService).toHaveProperty(method);\n      expect(typeof (adminUserService as any)[method]).toBe('function');\n    });\n  });\n});\n"],"names":["jest","mock","mockSupabase","from","fn","mockReturnThis","select","insert","update","delete","eq","single","describe","beforeEach","clearAllMocks","createClient","mockReturnValue","it","fc","assert","asyncProperty","record","email","emailAddress","role","constantFrom","uuid","adminData","ownerId","mockResolvedValueOnce","data","error","id","sample","status","invited_by","invited_at","Date","toISOString","created_at","updated_at","result","adminUserService","create","expect","success","toBe","toBeDefined","numRuns","adminUserId","newRole","mockReturnValueOnce","mockResolvedValue","count","deactivate","requestingUserRole","ownerOnlyMethods","forEach","method","toHaveProperty"],"mappings":"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"}