{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/utils/circuitBreaker.ts"],"sourcesContent":["import type { Result } from '@/types';\n\n/**\n * Circuit breaker states.\n */\nexport type CircuitState = 'closed' | 'open' | 'half-open';\n\n/**\n * Circuit breaker configuration.\n */\nexport interface CircuitBreakerConfig {\n  failureThreshold: number; // Number of failures before opening circuit\n  successThreshold: number; // Number of successes in half-open before closing\n  timeout: number; // Time in ms before attempting to close circuit\n  resetTimeout?: number; // Time in ms to reset failure count\n}\n\n/**\n * Circuit breaker statistics.\n */\nexport interface CircuitBreakerStats {\n  state: CircuitState;\n  failures: number;\n  successes: number;\n  lastFailureTime: number | null;\n  lastSuccessTime: number | null;\n  nextAttemptTime: number | null;\n}\n\n/**\n * Circuit breaker implementation for protecting external service calls.\n * \n * States:\n * - Closed: Normal operation, requests pass through\n * - Open: Too many failures, requests fail fast\n * - Half-Open: Testing if service recovered, limited requests pass through\n * \n * @example\n * const breaker = new CircuitBreaker({\n *   failureThreshold: 5,\n *   successThreshold: 2,\n *   timeout: 60000,\n * });\n * \n * const result = await breaker.execute(async () => {\n *   return await externalService.call();\n * });\n */\nexport class CircuitBreaker {\n  private state: CircuitState = 'closed';\n  private failures: number = 0;\n  private successes: number = 0;\n  private lastFailureTime: number | null = null;\n  private lastSuccessTime: number | null = null;\n  private nextAttemptTime: number | null = null;\n  private config: CircuitBreakerConfig;\n\n  constructor(config: CircuitBreakerConfig) {\n    this.config = config;\n  }\n\n  /**\n   * Gets current circuit breaker statistics.\n   */\n  public getStats(): CircuitBreakerStats {\n    return {\n      state: this.state,\n      failures: this.failures,\n      successes: this.successes,\n      lastFailureTime: this.lastFailureTime,\n      lastSuccessTime: this.lastSuccessTime,\n      nextAttemptTime: this.nextAttemptTime,\n    };\n  }\n\n  /**\n   * Resets the circuit breaker to closed state.\n   */\n  public reset(): void {\n    this.state = 'closed';\n    this.failures = 0;\n    this.successes = 0;\n    this.lastFailureTime = null;\n    this.lastSuccessTime = null;\n    this.nextAttemptTime = null;\n  }\n\n  /**\n   * Executes a function with circuit breaker protection.\n   * \n   * @param fn - Async function to execute\n   * @returns Result from the function or circuit breaker error\n   */\n  public async execute<T>(fn: () => Promise<Result<T>>): Promise<Result<T>> {\n    // Check if circuit is open\n    if (this.state === 'open') {\n      const now = Date.now();\n      \n      // Check if timeout has elapsed\n      if (this.nextAttemptTime && now < this.nextAttemptTime) {\n        return {\n          success: false,\n          error: {\n            code: 'CIRCUIT_OPEN',\n            message: 'Circuit breaker is open, request blocked',\n            details: {\n              nextAttemptTime: this.nextAttemptTime,\n              waitTime: this.nextAttemptTime - now,\n            },\n          },\n        };\n      }\n      \n      // Timeout elapsed, transition to half-open\n      this.state = 'half-open';\n      this.successes = 0;\n    }\n\n    try {\n      // Execute the function\n      const result = await fn();\n\n      if (result.success) {\n        this.onSuccess();\n      } else {\n        this.onFailure();\n      }\n\n      return result;\n    } catch (error) {\n      this.onFailure();\n      \n      return {\n        success: false,\n        error: {\n          code: 'EXECUTION_ERROR',\n          message: error instanceof Error ? error.message : 'Execution failed',\n          details: error,\n        },\n      };\n    }\n  }\n\n  /**\n   * Handles successful execution.\n   */\n  private onSuccess(): void {\n    this.lastSuccessTime = Date.now();\n    this.failures = 0;\n\n    if (this.state === 'half-open') {\n      this.successes++;\n      \n      // If enough successes in half-open, close the circuit\n      if (this.successes >= this.config.successThreshold) {\n        this.state = 'closed';\n        this.successes = 0;\n        this.nextAttemptTime = null;\n      }\n    }\n  }\n\n  /**\n   * Handles failed execution.\n   */\n  private onFailure(): void {\n    this.lastFailureTime = Date.now();\n    this.failures++;\n\n    if (this.state === 'half-open') {\n      // Any failure in half-open reopens the circuit\n      this.state = 'open';\n      this.successes = 0;\n      this.nextAttemptTime = Date.now() + this.config.timeout;\n    } else if (this.state === 'closed') {\n      // Check if failure threshold reached\n      if (this.failures >= this.config.failureThreshold) {\n        this.state = 'open';\n        this.nextAttemptTime = Date.now() + this.config.timeout;\n      }\n    }\n  }\n}\n\n/**\n * Global circuit breakers for external services.\n */\nconst circuitBreakers = new Map<string, CircuitBreaker>();\n\n/**\n * Gets or creates a circuit breaker for a service.\n * \n * @param serviceName - Name of the external service\n * @param config - Circuit breaker configuration\n * @returns Circuit breaker instance\n */\nexport function getCircuitBreaker(\n  serviceName: string,\n  config?: Partial<CircuitBreakerConfig>\n): CircuitBreaker {\n  if (!circuitBreakers.has(serviceName)) {\n    const defaultConfig: CircuitBreakerConfig = {\n      failureThreshold: 5,\n      successThreshold: 2,\n      timeout: 60000, // 1 minute\n      resetTimeout: 300000, // 5 minutes\n    };\n\n    circuitBreakers.set(\n      serviceName,\n      new CircuitBreaker({ ...defaultConfig, ...config })\n    );\n  }\n\n  return circuitBreakers.get(serviceName)!;\n}\n\n/**\n * Resets all circuit breakers.\n * Useful for testing or manual recovery.\n */\nexport function resetAllCircuitBreakers(): void {\n  circuitBreakers.forEach((breaker) => breaker.reset());\n}\n\n/**\n * Gets statistics for all circuit breakers.\n */\nexport function getAllCircuitBreakerStats(): Record<string, CircuitBreakerStats> {\n  const stats: Record<string, CircuitBreakerStats> = {};\n  \n  circuitBreakers.forEach((breaker, serviceName) => {\n    stats[serviceName] = breaker.getStats();\n  });\n  \n  return stats;\n}\n"],"names":["CircuitBreaker","getAllCircuitBreakerStats","getCircuitBreaker","resetAllCircuitBreakers","config","state","failures","successes","lastFailureTime","lastSuccessTime","nextAttemptTime","getStats","reset","execute","fn","now","Date","success","error","code","message","details","waitTime","result","onSuccess","onFailure","Error","successThreshold","timeout","failureThreshold","circuitBreakers","Map","serviceName","has","defaultConfig","resetTimeout","set","get","forEach","breaker","stats"],"mappings":"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"}