{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/photoService.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { sanitizeInput, sanitizeRichText } from \"../utils/sanitization\";\nimport {\n  createPhotoSchema,\n  updatePhotoSchema,\n  moderatePhotoSchema,\n  batchUploadSchema,\n  photoFilterSchema,\n  type CreatePhotoDTO,\n  type UpdatePhotoDTO,\n  type ModeratePhotoDTO,\n  type BatchUploadDTO,\n  type PhotoFilterDTO,\n} from '../schemas/photoSchemas';\nimport { uploadToB2, isB2Healthy } from './b2Service';\n\ntype Result<T> = \n  | { success: true; data: T } \n  | { success: false; error: { code: string; message: string; details?: any } };\n\n// Initialize Supabase client - Pattern A (testable)\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ninterface Photo {\n  id: string;\n  uploader_id: string;\n  photo_url: string;\n  storage_type: 'b2' | 'supabase';\n  page_type: 'event' | 'activity' | 'accommodation' | 'memory';\n  page_id?: string;\n  caption?: string;\n  alt_text?: string;\n  moderation_status: 'pending' | 'approved' | 'rejected';\n  moderation_reason?: string;\n  display_order?: number;\n  created_at: string;\n  moderated_at?: string;\n  updated_at: string;\n}\n\n/**\n * Uploads a photo with automatic storage selection and failover.\n * Tries B2 first, falls back to Supabase Storage if B2 is unavailable.\n * \n * @param file - File buffer to upload\n * @param fileName - Original filename\n * @param contentType - MIME type\n * @param metadata - Photo metadata (uploader, page info, caption, etc.)\n * @returns Result containing the created photo record\n * \n * @example\n * const result = await uploadPhoto(\n *   fileBuffer,\n *   'wedding-photo.jpg',\n *   'image/jpeg',\n *   {\n *     uploader_id: 'user-123',\n *     page_type: 'memory',\n *     caption: 'Beautiful sunset ceremony'\n *   }\n * );\n */\nexport async function uploadPhoto(\n  file: Buffer,\n  fileName: string,\n  contentType: string,\n  metadata: Omit<CreatePhotoDTO, 'photo_url' | 'storage_type'>\n): Promise<Result<Photo>> {\n  try {\n    // 1. Validate metadata\n    const metadataValidation = createPhotoSchema.omit({ photo_url: true, storage_type: true }).safeParse(metadata);\n    if (!metadataValidation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid photo metadata',\n          details: metadataValidation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize text fields\n    const sanitizedMetadata = {\n      ...metadataValidation.data,\n      caption: metadataValidation.data.caption\n        ? sanitizeInput(metadataValidation.data.caption)\n        : undefined,\n      alt_text: metadataValidation.data.alt_text\n        ? sanitizeInput(metadataValidation.data.alt_text)\n        : undefined,\n    };\n\n    // 3. Check B2 health and attempt upload\n    const b2HealthResult = await isB2Healthy();\n    let photoUrl: string;\n    let storageType: 'b2' | 'supabase';\n\n    if (b2HealthResult.success && b2HealthResult.data) {\n      // Try B2 upload\n      const b2Result = await uploadToB2(file, fileName, contentType);\n      if (b2Result.success) {\n        photoUrl = b2Result.data.url;\n        storageType = 'b2';\n      } else {\n        // B2 failed, fallback to Supabase\n        const supabaseResult = await uploadToSupabaseStorage(file, fileName, contentType);\n        if (!supabaseResult.success) {\n          return supabaseResult;\n        }\n        photoUrl = supabaseResult.data.url;\n        storageType = 'supabase';\n      }\n    } else {\n      // B2 unhealthy, use Supabase directly\n      const supabaseResult = await uploadToSupabaseStorage(file, fileName, contentType);\n      if (!supabaseResult.success) {\n        return supabaseResult;\n      }\n      photoUrl = supabaseResult.data.url;\n      storageType = 'supabase';\n    }\n\n    // 4. Create photo record in database\n    const photoData: CreatePhotoDTO = {\n      ...sanitizedMetadata,\n      photo_url: photoUrl,\n      storage_type: storageType,\n    };\n\n    const { data, error } = await supabase\n      .from('photos')\n      .insert(photoData)\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error during photo upload',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Uploads a file to Supabase Storage as fallback.\n * \n * @param file - File buffer\n * @param fileName - Original filename\n * @param contentType - MIME type\n * @returns Result containing the storage URL\n */\nasync function uploadToSupabaseStorage(\n  file: Buffer,\n  fileName: string,\n  contentType: string\n): Promise<Result<{ url: string; key: string }>> {\n  try {\n    // Sanitize filename\n    const sanitizedFileName = sanitizeInput(fileName).replace(/[^a-zA-Z0-9._-]/g, '_');\n\n    const timestamp = Date.now();\n    const key = `photos/${timestamp}-${sanitizedFileName}`;\n\n    const { data, error } = await supabase.storage\n      .from('photos')\n      .upload(key, file, {\n        contentType,\n        cacheControl: '31536000', // 1 year\n      });\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'STORAGE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    // Get public URL\n    const { data: urlData } = supabase.storage\n      .from('photos')\n      .getPublicUrl(data.path);\n\n    return {\n      success: true,\n      data: {\n        url: urlData.publicUrl,\n        key: data.path,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'STORAGE_ERROR',\n        message: error instanceof Error ? error.message : 'Failed to upload to Supabase Storage',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Uploads multiple photos in batch.\n * \n * @param uploads - Array of photo uploads with file data and metadata\n * @returns Result containing array of created photo records\n */\nexport async function batchUploadPhotos(\n  uploads: Array<{\n    file: Buffer;\n    fileName: string;\n    contentType: string;\n    metadata: Omit<CreatePhotoDTO, 'photo_url' | 'storage_type'>;\n  }>\n): Promise<Result<Photo[]>> {\n  try {\n    if (uploads.length === 0) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'No photos provided for batch upload',\n        },\n      };\n    }\n\n    if (uploads.length > 50) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Batch upload limited to 50 photos at a time',\n        },\n      };\n    }\n\n    const results: Photo[] = [];\n    const errors: any[] = [];\n\n    for (const upload of uploads) {\n      const result = await uploadPhoto(\n        upload.file,\n        upload.fileName,\n        upload.contentType,\n        upload.metadata\n      );\n\n      if (result.success) {\n        results.push(result.data);\n      } else {\n        errors.push({\n          fileName: upload.fileName,\n          error: result.error,\n        });\n      }\n    }\n\n    if (errors.length > 0) {\n      return {\n        success: false,\n        error: {\n          code: 'BATCH_UPLOAD_PARTIAL_FAILURE',\n          message: `${errors.length} of ${uploads.length} photos failed to upload`,\n          details: { successful: results.length, failed: errors.length, errors },\n        },\n      };\n    }\n\n    return { success: true, data: results };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error during batch upload',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Gets a photo by ID.\n * \n * @param id - Photo ID\n * @returns Result containing the photo record\n */\nexport async function getPhoto(id: string): Promise<Result<Photo>> {\n  try {\n    const { data, error } = await supabase\n      .from('photos')\n      .select('*')\n      .eq('id', id)\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: error.code === 'PGRST116' ? 'NOT_FOUND' : 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Lists photos with filtering and pagination.\n * \n * @param filters - Filter criteria (page type, moderation status, etc.)\n * @returns Result containing array of photos and total count\n */\nexport async function listPhotos(\n  filters: PhotoFilterDTO\n): Promise<Result<{ photos: Photo[]; total: number }>> {\n  try {\n    // Validate filters\n    const validation = photoFilterSchema.safeParse(filters);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid filter parameters',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    const { page_type, page_id, moderation_status, uploader_id, limit, offset } = validation.data;\n\n    let query = supabase.from('photos').select('*', { count: 'exact' });\n\n    if (page_type) {\n      query = query.eq('page_type', page_type);\n    }\n    if (page_id) {\n      query = query.eq('page_id', page_id);\n    }\n    if (moderation_status) {\n      query = query.eq('moderation_status', moderation_status);\n    }\n    if (uploader_id) {\n      query = query.eq('uploader_id', uploader_id);\n    }\n\n    query = query\n      .order('created_at', { ascending: false })\n      .range(offset, offset + limit - 1);\n\n    const { data, error, count } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return {\n      success: true,\n      data: {\n        photos: data || [],\n        total: count || 0,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Moderates a photo (approve or reject).\n * \n * @param id - Photo ID\n * @param moderation - Moderation decision and optional reason\n * @returns Result containing the updated photo\n */\nexport async function moderatePhoto(\n  id: string,\n  moderation: ModeratePhotoDTO\n): Promise<Result<Photo>> {\n  try {\n    // Validate moderation data\n    const validation = moderatePhotoSchema.safeParse(moderation);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid moderation data',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // Sanitize moderation reason\n    const sanitizedReason = validation.data.moderation_reason\n      ? sanitizeInput(validation.data.moderation_reason)\n      : undefined;\n\n    const { data, error } = await supabase\n      .from('photos')\n      .update({\n        moderation_status: validation.data.moderation_status,\n        moderation_reason: sanitizedReason,\n        moderated_at: new Date().toISOString(),\n      })\n      .eq('id', id)\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: error.code === 'PGRST116' ? 'NOT_FOUND' : 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Updates photo metadata (caption, alt text, display order).\n * \n * @param id - Photo ID\n * @param updates - Fields to update\n * @returns Result containing the updated photo\n */\nexport async function updatePhoto(\n  id: string,\n  updates: UpdatePhotoDTO\n): Promise<Result<Photo>> {\n  try {\n    // Validate updates\n    const validation = updatePhotoSchema.safeParse(updates);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid update data',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // Sanitize text fields\n    const sanitizedUpdates = {\n      ...validation.data,\n      caption: validation.data.caption\n        ? sanitizeInput(validation.data.caption)\n        : undefined,\n      alt_text: validation.data.alt_text\n        ? sanitizeInput(validation.data.alt_text)\n        : undefined,\n    };\n\n    const { data, error } = await supabase\n      .from('photos')\n      .update(sanitizedUpdates)\n      .eq('id', id)\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: error.code === 'PGRST116' ? 'NOT_FOUND' : 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Deletes a photo.\n * \n * @param id - Photo ID\n * @returns Result indicating success or failure\n */\nexport async function deletePhoto(id: string): Promise<Result<void>> {\n  try {\n    const { error } = await supabase\n      .from('photos')\n      .delete()\n      .eq('id', id);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Gets photos pending moderation.\n * \n * @param limit - Maximum number of photos to return\n * @returns Result containing array of pending photos\n */\nexport async function getPendingPhotos(limit: number = 50): Promise<Result<Photo[]>> {\n  return listPhotos({\n    moderation_status: 'pending',\n    limit,\n    offset: 0,\n  }).then(result => {\n    if (result.success) {\n      return { success: true, data: result.data.photos };\n    }\n    return result;\n  });\n}\n"],"names":["batchUploadPhotos","deletePhoto","getPendingPhotos","getPhoto","listPhotos","moderatePhoto","updatePhoto","uploadPhoto","supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","file","fileName","contentType","metadata","metadataValidation","createPhotoSchema","omit","photo_url","storage_type","safeParse","success","error","code","message","details","issues","sanitizedMetadata","data","caption","sanitizeInput","undefined","alt_text","b2HealthResult","isB2Healthy","photoUrl","storageType","b2Result","uploadToB2","url","supabaseResult","uploadToSupabaseStorage","photoData","from","insert","select","single","Error","sanitizedFileName","replace","timestamp","Date","now","key","storage","upload","cacheControl","urlData","getPublicUrl","path","publicUrl","uploads","length","results","errors","result","push","successful","failed","id","eq","filters","validation","photoFilterSchema","page_type","page_id","moderation_status","uploader_id","limit","offset","query","count","order","ascending","range","photos","total","moderation","moderatePhotoSchema","sanitizedReason","moderation_reason","update","moderated_at","toISOString","updates","updatePhotoSchema","sanitizedUpdates","delete","then"],"mappings":";;;;;;;;;;;QAuOsBA;eAAAA;;QAsUAC;eAAAA;;QAqCAC;eAAAA;;QA3RAC;eAAAA;;QAsCAC;eAAAA;;QA6EAC;eAAAA;;QAiEAC;eAAAA;;QA1aAC;eAAAA;;;4BAjEO;8BACmB;8BAYzC;2BACiC;AAMxC,oDAAoD;AACpD,MAAMC,WAAWC,IAAAA,wBAAY,EAC3BC,QAAQC,GAAG,CAACC,wBAAwB,EACpCF,QAAQC,GAAG,CAACE,yBAAyB;AA0ChC,eAAeN,YACpBO,IAAY,EACZC,QAAgB,EAChBC,WAAmB,EACnBC,QAA4D;IAE5D,IAAI;QACF,uBAAuB;QACvB,MAAMC,qBAAqBC,+BAAiB,CAACC,IAAI,CAAC;YAAEC,WAAW;YAAMC,cAAc;QAAK,GAAGC,SAAS,CAACN;QACrG,IAAI,CAACC,mBAAmBM,OAAO,EAAE;YAC/B,OAAO;gBACLA,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;oBACTC,SAASV,mBAAmBO,KAAK,CAACI,MAAM;gBAC1C;YACF;QACF;QAEA,0BAA0B;QAC1B,MAAMC,oBAAoB;YACxB,GAAGZ,mBAAmBa,IAAI;YAC1BC,SAASd,mBAAmBa,IAAI,CAACC,OAAO,GACpCC,IAAAA,2BAAa,EAACf,mBAAmBa,IAAI,CAACC,OAAO,IAC7CE;YACJC,UAAUjB,mBAAmBa,IAAI,CAACI,QAAQ,GACtCF,IAAAA,2BAAa,EAACf,mBAAmBa,IAAI,CAACI,QAAQ,IAC9CD;QACN;QAEA,wCAAwC;QACxC,MAAME,iBAAiB,MAAMC,IAAAA,sBAAW;QACxC,IAAIC;QACJ,IAAIC;QAEJ,IAAIH,eAAeZ,OAAO,IAAIY,eAAeL,IAAI,EAAE;YACjD,gBAAgB;YAChB,MAAMS,WAAW,MAAMC,IAAAA,qBAAU,EAAC3B,MAAMC,UAAUC;YAClD,IAAIwB,SAAShB,OAAO,EAAE;gBACpBc,WAAWE,SAAST,IAAI,CAACW,GAAG;gBAC5BH,cAAc;YAChB,OAAO;gBACL,kCAAkC;gBAClC,MAAMI,iBAAiB,MAAMC,wBAAwB9B,MAAMC,UAAUC;gBACrE,IAAI,CAAC2B,eAAenB,OAAO,EAAE;oBAC3B,OAAOmB;gBACT;gBACAL,WAAWK,eAAeZ,IAAI,CAACW,GAAG;gBAClCH,cAAc;YAChB;QACF,OAAO;YACL,sCAAsC;YACtC,MAAMI,iBAAiB,MAAMC,wBAAwB9B,MAAMC,UAAUC;YACrE,IAAI,CAAC2B,eAAenB,OAAO,EAAE;gBAC3B,OAAOmB;YACT;YACAL,WAAWK,eAAeZ,IAAI,CAACW,GAAG;YAClCH,cAAc;QAChB;QAEA,qCAAqC;QACrC,MAAMM,YAA4B;YAChC,GAAGf,iBAAiB;YACpBT,WAAWiB;YACXhB,cAAciB;QAChB;QAEA,MAAM,EAAER,IAAI,EAAEN,KAAK,EAAE,GAAG,MAAMjB,SAC3BsC,IAAI,CAAC,UACLC,MAAM,CAACF,WACPG,MAAM,GACNC,MAAM;QAET,IAAIxB,OAAO;YACT,OAAO;gBACLD,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAASF,MAAME,OAAO;oBACtBC,SAASH;gBACX;YACF;QACF;QAEA,OAAO;YAAED,SAAS;YAAMO;QAAK;IAC/B,EAAE,OAAON,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAASF,iBAAiByB,QAAQzB,MAAME,OAAO,GAAG;gBAClDC,SAASH;YACX;QACF;IACF;AACF;AAEA;;;;;;;CAOC,GACD,eAAemB,wBACb9B,IAAY,EACZC,QAAgB,EAChBC,WAAmB;IAEnB,IAAI;QACF,oBAAoB;QACpB,MAAMmC,oBAAoBlB,IAAAA,2BAAa,EAAClB,UAAUqC,OAAO,CAAC,oBAAoB;QAE9E,MAAMC,YAAYC,KAAKC,GAAG;QAC1B,MAAMC,MAAM,CAAC,OAAO,EAAEH,UAAU,CAAC,EAAEF,mBAAmB;QAEtD,MAAM,EAAEpB,IAAI,EAAEN,KAAK,EAAE,GAAG,MAAMjB,SAASiD,OAAO,CAC3CX,IAAI,CAAC,UACLY,MAAM,CAACF,KAAK1C,MAAM;YACjBE;YACA2C,cAAc;QAChB;QAEF,IAAIlC,OAAO;YACT,OAAO;gBACLD,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAASF,MAAME,OAAO;oBACtBC,SAASH;gBACX;YACF;QACF;QAEA,iBAAiB;QACjB,MAAM,EAAEM,MAAM6B,OAAO,EAAE,GAAGpD,SAASiD,OAAO,CACvCX,IAAI,CAAC,UACLe,YAAY,CAAC9B,KAAK+B,IAAI;QAEzB,OAAO;YACLtC,SAAS;YACTO,MAAM;gBACJW,KAAKkB,QAAQG,SAAS;gBACtBP,KAAKzB,KAAK+B,IAAI;YAChB;QACF;IACF,EAAE,OAAOrC,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAASF,iBAAiByB,QAAQzB,MAAME,OAAO,GAAG;gBAClDC,SAASH;YACX;QACF;IACF;AACF;AAQO,eAAezB,kBACpBgE,OAKE;IAEF,IAAI;QACF,IAAIA,QAAQC,MAAM,KAAK,GAAG;YACxB,OAAO;gBACLzC,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;gBACX;YACF;QACF;QAEA,IAAIqC,QAAQC,MAAM,GAAG,IAAI;YACvB,OAAO;gBACLzC,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;gBACX;YACF;QACF;QAEA,MAAMuC,UAAmB,EAAE;QAC3B,MAAMC,SAAgB,EAAE;QAExB,KAAK,MAAMT,UAAUM,QAAS;YAC5B,MAAMI,SAAS,MAAM7D,YACnBmD,OAAO5C,IAAI,EACX4C,OAAO3C,QAAQ,EACf2C,OAAO1C,WAAW,EAClB0C,OAAOzC,QAAQ;YAGjB,IAAImD,OAAO5C,OAAO,EAAE;gBAClB0C,QAAQG,IAAI,CAACD,OAAOrC,IAAI;YAC1B,OAAO;gBACLoC,OAAOE,IAAI,CAAC;oBACVtD,UAAU2C,OAAO3C,QAAQ;oBACzBU,OAAO2C,OAAO3C,KAAK;gBACrB;YACF;QACF;QAEA,IAAI0C,OAAOF,MAAM,GAAG,GAAG;YACrB,OAAO;gBACLzC,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS,GAAGwC,OAAOF,MAAM,CAAC,IAAI,EAAED,QAAQC,MAAM,CAAC,wBAAwB,CAAC;oBACxErC,SAAS;wBAAE0C,YAAYJ,QAAQD,MAAM;wBAAEM,QAAQJ,OAAOF,MAAM;wBAAEE;oBAAO;gBACvE;YACF;QACF;QAEA,OAAO;YAAE3C,SAAS;YAAMO,MAAMmC;QAAQ;IACxC,EAAE,OAAOzC,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAASF,iBAAiByB,QAAQzB,MAAME,OAAO,GAAG;gBAClDC,SAASH;YACX;QACF;IACF;AACF;AAQO,eAAetB,SAASqE,EAAU;IACvC,IAAI;QACF,MAAM,EAAEzC,IAAI,EAAEN,KAAK,EAAE,GAAG,MAAMjB,SAC3BsC,IAAI,CAAC,UACLE,MAAM,CAAC,KACPyB,EAAE,CAAC,MAAMD,IACTvB,MAAM;QAET,IAAIxB,OAAO;YACT,OAAO;gBACLD,SAAS;gBACTC,OAAO;oBACLC,MAAMD,MAAMC,IAAI,KAAK,aAAa,cAAc;oBAChDC,SAASF,MAAME,OAAO;oBACtBC,SAASH;gBACX;YACF;QACF;QAEA,OAAO;YAAED,SAAS;YAAMO;QAAK;IAC/B,EAAE,OAAON,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAASF,iBAAiByB,QAAQzB,MAAME,OAAO,GAAG;gBAClDC,SAASH;YACX;QACF;IACF;AACF;AAQO,eAAerB,WACpBsE,OAAuB;IAEvB,IAAI;QACF,mBAAmB;QACnB,MAAMC,aAAaC,+BAAiB,CAACrD,SAAS,CAACmD;QAC/C,IAAI,CAACC,WAAWnD,OAAO,EAAE;YACvB,OAAO;gBACLA,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;oBACTC,SAAS+C,WAAWlD,KAAK,CAACI,MAAM;gBAClC;YACF;QACF;QAEA,MAAM,EAAEgD,SAAS,EAAEC,OAAO,EAAEC,iBAAiB,EAAEC,WAAW,EAAEC,KAAK,EAAEC,MAAM,EAAE,GAAGP,WAAW5C,IAAI;QAE7F,IAAIoD,QAAQ3E,SAASsC,IAAI,CAAC,UAAUE,MAAM,CAAC,KAAK;YAAEoC,OAAO;QAAQ;QAEjE,IAAIP,WAAW;YACbM,QAAQA,MAAMV,EAAE,CAAC,aAAaI;QAChC;QACA,IAAIC,SAAS;YACXK,QAAQA,MAAMV,EAAE,CAAC,WAAWK;QAC9B;QACA,IAAIC,mBAAmB;YACrBI,QAAQA,MAAMV,EAAE,CAAC,qBAAqBM;QACxC;QACA,IAAIC,aAAa;YACfG,QAAQA,MAAMV,EAAE,CAAC,eAAeO;QAClC;QAEAG,QAAQA,MACLE,KAAK,CAAC,cAAc;YAAEC,WAAW;QAAM,GACvCC,KAAK,CAACL,QAAQA,SAASD,QAAQ;QAElC,MAAM,EAAElD,IAAI,EAAEN,KAAK,EAAE2D,KAAK,EAAE,GAAG,MAAMD;QAErC,IAAI1D,OAAO;YACT,OAAO;gBACLD,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAASF,MAAME,OAAO;oBACtBC,SAASH;gBACX;YACF;QACF;QAEA,OAAO;YACLD,SAAS;YACTO,MAAM;gBACJyD,QAAQzD,QAAQ,EAAE;gBAClB0D,OAAOL,SAAS;YAClB;QACF;IACF,EAAE,OAAO3D,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAASF,iBAAiByB,QAAQzB,MAAME,OAAO,GAAG;gBAClDC,SAASH;YACX;QACF;IACF;AACF;AASO,eAAepB,cACpBmE,EAAU,EACVkB,UAA4B;IAE5B,IAAI;QACF,2BAA2B;QAC3B,MAAMf,aAAagB,iCAAmB,CAACpE,SAAS,CAACmE;QACjD,IAAI,CAACf,WAAWnD,OAAO,EAAE;YACvB,OAAO;gBACLA,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;oBACTC,SAAS+C,WAAWlD,KAAK,CAACI,MAAM;gBAClC;YACF;QACF;QAEA,6BAA6B;QAC7B,MAAM+D,kBAAkBjB,WAAW5C,IAAI,CAAC8D,iBAAiB,GACrD5D,IAAAA,2BAAa,EAAC0C,WAAW5C,IAAI,CAAC8D,iBAAiB,IAC/C3D;QAEJ,MAAM,EAAEH,IAAI,EAAEN,KAAK,EAAE,GAAG,MAAMjB,SAC3BsC,IAAI,CAAC,UACLgD,MAAM,CAAC;YACNf,mBAAmBJ,WAAW5C,IAAI,CAACgD,iBAAiB;YACpDc,mBAAmBD;YACnBG,cAAc,IAAIzC,OAAO0C,WAAW;QACtC,GACCvB,EAAE,CAAC,MAAMD,IACTxB,MAAM,GACNC,MAAM;QAET,IAAIxB,OAAO;YACT,OAAO;gBACLD,SAAS;gBACTC,OAAO;oBACLC,MAAMD,MAAMC,IAAI,KAAK,aAAa,cAAc;oBAChDC,SAASF,MAAME,OAAO;oBACtBC,SAASH;gBACX;YACF;QACF;QAEA,OAAO;YAAED,SAAS;YAAMO;QAAK;IAC/B,EAAE,OAAON,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAASF,iBAAiByB,QAAQzB,MAAME,OAAO,GAAG;gBAClDC,SAASH;YACX;QACF;IACF;AACF;AASO,eAAenB,YACpBkE,EAAU,EACVyB,OAAuB;IAEvB,IAAI;QACF,mBAAmB;QACnB,MAAMtB,aAAauB,+BAAiB,CAAC3E,SAAS,CAAC0E;QAC/C,IAAI,CAACtB,WAAWnD,OAAO,EAAE;YACvB,OAAO;gBACLA,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;oBACTC,SAAS+C,WAAWlD,KAAK,CAACI,MAAM;gBAClC;YACF;QACF;QAEA,uBAAuB;QACvB,MAAMsE,mBAAmB;YACvB,GAAGxB,WAAW5C,IAAI;YAClBC,SAAS2C,WAAW5C,IAAI,CAACC,OAAO,GAC5BC,IAAAA,2BAAa,EAAC0C,WAAW5C,IAAI,CAACC,OAAO,IACrCE;YACJC,UAAUwC,WAAW5C,IAAI,CAACI,QAAQ,GAC9BF,IAAAA,2BAAa,EAAC0C,WAAW5C,IAAI,CAACI,QAAQ,IACtCD;QACN;QAEA,MAAM,EAAEH,IAAI,EAAEN,KAAK,EAAE,GAAG,MAAMjB,SAC3BsC,IAAI,CAAC,UACLgD,MAAM,CAACK,kBACP1B,EAAE,CAAC,MAAMD,IACTxB,MAAM,GACNC,MAAM;QAET,IAAIxB,OAAO;YACT,OAAO;gBACLD,SAAS;gBACTC,OAAO;oBACLC,MAAMD,MAAMC,IAAI,KAAK,aAAa,cAAc;oBAChDC,SAASF,MAAME,OAAO;oBACtBC,SAASH;gBACX;YACF;QACF;QAEA,OAAO;YAAED,SAAS;YAAMO;QAAK;IAC/B,EAAE,OAAON,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAASF,iBAAiByB,QAAQzB,MAAME,OAAO,GAAG;gBAClDC,SAASH;YACX;QACF;IACF;AACF;AAQO,eAAexB,YAAYuE,EAAU;IAC1C,IAAI;QACF,MAAM,EAAE/C,KAAK,EAAE,GAAG,MAAMjB,SACrBsC,IAAI,CAAC,UACLsD,MAAM,GACN3B,EAAE,CAAC,MAAMD;QAEZ,IAAI/C,OAAO;YACT,OAAO;gBACLD,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAASF,MAAME,OAAO;oBACtBC,SAASH;gBACX;YACF;QACF;QAEA,OAAO;YAAED,SAAS;YAAMO,MAAMG;QAAU;IAC1C,EAAE,OAAOT,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAASF,iBAAiByB,QAAQzB,MAAME,OAAO,GAAG;gBAClDC,SAASH;YACX;QACF;IACF;AACF;AAQO,eAAevB,iBAAiB+E,QAAgB,EAAE;IACvD,OAAO7E,WAAW;QAChB2E,mBAAmB;QACnBE;QACAC,QAAQ;IACV,GAAGmB,IAAI,CAACjC,CAAAA;QACN,IAAIA,OAAO5C,OAAO,EAAE;YAClB,OAAO;gBAAEA,SAAS;gBAAMO,MAAMqC,OAAOrC,IAAI,CAACyD,MAAM;YAAC;QACnD;QACA,OAAOpB;IACT;AACF"}