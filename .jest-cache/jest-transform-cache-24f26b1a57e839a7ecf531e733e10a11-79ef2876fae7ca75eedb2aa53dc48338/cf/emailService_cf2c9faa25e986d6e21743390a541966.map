{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/emailService.ts"],"sourcesContent":["import { Resend } from 'resend';\nimport { createClient } from '@supabase/supabase-js';\nimport { sanitizeInput, sanitizeRichText } from \"../utils/sanitization\";\nimport type { Result } from '@/types';\nimport { ERROR_CODES } from '@/types';\nimport {\n  createEmailTemplateSchema,\n  updateEmailTemplateSchema,\n  sendEmailSchema,\n  sendBulkEmailSchema,\n  scheduleEmailSchema,\n  type CreateEmailTemplateDTO,\n  type UpdateEmailTemplateDTO,\n  type SendEmailDTO,\n  type SendBulkEmailDTO,\n  type ScheduleEmailDTO,\n  type EmailTemplate,\n  type EmailLog,\n} from '@/schemas/emailSchemas';\nimport { sendSMSFallback } from './smsService';\n\n// Factory function to get Resend client (allows for dependency injection in tests)\nlet resendClientInstance: Resend | null = null;\n\nexport function getResendClient(): Resend {\n  if (!resendClientInstance) {\n    resendClientInstance = new Resend(process.env.RESEND_API_KEY);\n  }\n  return resendClientInstance;\n}\n\n// Allow tests to inject a mock client\nexport function setResendClient(client: Resend): void {\n  resendClientInstance = client;\n}\n\n// Reset to default client (for test cleanup)\nexport function resetResendClient(): void {\n  resendClientInstance = null;\n}\n\n// Initialize Supabase client for database operations\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\n/**\n * Sanitizes HTML content for email templates.\n * Allows safe HTML tags for email formatting.\n */\nfunction sanitizeEmailHTML(html: string): string {\n  return sanitizeRichText(html);\n}\n\n/**\n * Validates that all variables in the template are defined.\n * Requirements: 13.8\n */\nfunction validateTemplateVariables(\n  template: string,\n  allowedVariables: string[]\n): Result<void> {\n  // Match variable patterns like {{variable_name}}\n  // Variable names must be alphanumeric with underscores\n  const variablePattern = /\\{\\{([a-zA-Z_][a-zA-Z0-9_]*)\\}\\}/g;\n  const matches = template.matchAll(variablePattern);\n  const undefinedVars: string[] = [];\n\n  for (const match of matches) {\n    const varName = match[1];\n    if (!allowedVariables.includes(varName)) {\n      undefinedVars.push(varName);\n    }\n  }\n\n  if (undefinedVars.length > 0) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.VALIDATION_ERROR,\n        message: 'Template contains undefined variables',\n        details: { undefinedVariables: undefinedVars },\n      },\n    };\n  }\n\n  return { success: true, data: undefined };\n}\n\n/**\n * Substitutes variables in a template string.\n * Requirements: 12.2\n */\nfunction substituteVariables(\n  template: string,\n  variables: Record<string, string>\n): string {\n  let result = template;\n  for (const [key, value] of Object.entries(variables)) {\n    const pattern = new RegExp(`\\\\{\\\\{${key}\\\\}\\\\}`, 'g');\n    result = result.replace(pattern, value);\n  }\n  return result;\n}\n\n/**\n * Creates a new email template.\n * Requirements: 12.1, 12.2\n */\nexport async function createTemplate(\n  data: CreateEmailTemplateDTO\n): Promise<Result<EmailTemplate>> {\n  try {\n    // 1. Validate\n    const validation = createEmailTemplateSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize HTML content\n    const sanitized = {\n      ...validation.data,\n      body_html: sanitizeEmailHTML(validation.data.body_html),\n    };\n\n    // 3. Validate template variables\n    const htmlValidation = validateTemplateVariables(\n      sanitized.body_html,\n      sanitized.variables\n    );\n    if (!htmlValidation.success) {\n      return htmlValidation as Result<EmailTemplate>;\n    }\n\n    const textValidation = validateTemplateVariables(\n      sanitized.body_text,\n      sanitized.variables\n    );\n    if (!textValidation.success) {\n      return textValidation as Result<EmailTemplate>;\n    }\n\n    // 4. Insert into database\n    const { data: template, error } = await supabase\n      .from('email_templates')\n      .insert(sanitized)\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: template };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Gets an email template by ID.\n */\nexport async function getTemplate(id: string): Promise<Result<EmailTemplate>> {\n  try {\n    const { data: template, error } = await supabase\n      .from('email_templates')\n      .select('*')\n      .eq('id', id)\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.NOT_FOUND,\n          message: 'Template not found',\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: template };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Updates an email template.\n */\nexport async function updateTemplate(\n  id: string,\n  data: UpdateEmailTemplateDTO\n): Promise<Result<EmailTemplate>> {\n  try {\n    // 1. Validate\n    const validation = updateEmailTemplateSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize HTML if provided\n    const sanitized = {\n      ...validation.data,\n      ...(validation.data.body_html && {\n        body_html: sanitizeEmailHTML(validation.data.body_html),\n      }),\n    };\n\n    // 3. Get existing template to check variables\n    const existingResult = await getTemplate(id);\n    if (!existingResult.success) {\n      return existingResult;\n    }\n\n    const variables = sanitized.variables || existingResult.data.variables;\n\n    // 4. Validate template variables if HTML or text is being updated\n    if (sanitized.body_html) {\n      const htmlValidation = validateTemplateVariables(\n        sanitized.body_html,\n        variables\n      );\n      if (!htmlValidation.success) {\n        return htmlValidation as Result<EmailTemplate>;\n      }\n    }\n\n    if (sanitized.body_text) {\n      const textValidation = validateTemplateVariables(\n        sanitized.body_text,\n        variables\n      );\n      if (!textValidation.success) {\n        return textValidation as Result<EmailTemplate>;\n      }\n    }\n\n    // 5. Update in database\n    const { data: template, error } = await supabase\n      .from('email_templates')\n      .update(sanitized)\n      .eq('id', id)\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: template };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Deletes an email template.\n */\nexport async function deleteTemplate(id: string): Promise<Result<void>> {\n  try {\n    const { error } = await supabase\n      .from('email_templates')\n      .delete()\n      .eq('id', id);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Lists all email templates.\n */\nexport async function listTemplates(): Promise<Result<EmailTemplate[]>> {\n  try {\n    const { data: templates, error } = await supabase\n      .from('email_templates')\n      .select('*')\n      .order('created_at', { ascending: false });\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: templates || [] };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Sends a single email using Resend.\n * Requirements: 12.3, 12.4\n */\nexport async function sendEmail(data: SendEmailDTO): Promise<Result<{ id: string }>> {\n  try {\n    // 1. Validate\n    const validation = sendEmailSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    let html = validation.data.html;\n    let text = validation.data.text;\n    let subject = validation.data.subject;\n\n    // 2. If template_id provided, load template and substitute variables\n    if (validation.data.template_id) {\n      const templateResult = await getTemplate(validation.data.template_id);\n      if (!templateResult.success) {\n        return {\n          success: false,\n          error: {\n            code: ERROR_CODES.NOT_FOUND,\n            message: 'Template not found',\n          },\n        };\n      }\n\n      const template = templateResult.data;\n      const variables = validation.data.variables || {};\n\n      html = substituteVariables(template.body_html, variables);\n      text = substituteVariables(template.body_text, variables);\n      subject = substituteVariables(template.subject, variables);\n    }\n\n    // 3. Send email via Resend\n    const resend = getResendClient();\n    const { data: emailData, error: resendError } = await resend.emails.send({\n      from: process.env.RESEND_FROM_EMAIL || 'onboarding@resend.dev',\n      to: validation.data.to,\n      subject,\n      html,\n      text,\n    });\n\n    if (resendError) {\n      // Log failed email\n      await supabase.from('email_logs').insert({\n        template_id: validation.data.template_id,\n        recipient_email: validation.data.to,\n        subject,\n        delivery_status: 'failed',\n        error_message: resendError.message,\n      });\n\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.EMAIL_SERVICE_ERROR,\n          message: resendError.message,\n          details: resendError,\n        },\n      };\n    }\n\n    // 4. Log successful email\n    await supabase.from('email_logs').insert({\n      template_id: validation.data.template_id,\n      recipient_email: validation.data.to,\n      subject,\n      delivery_status: 'sent',\n      sent_at: new Date().toISOString(),\n    });\n\n    return { success: true, data: { id: emailData!.id } };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Sends bulk emails to multiple recipients.\n * Requirements: 12.3\n */\nexport async function sendBulkEmail(\n  data: SendBulkEmailDTO\n): Promise<Result<{ sent: number; failed: number }>> {\n  try {\n    // 1. Validate\n    const validation = sendBulkEmailSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    let html = validation.data.html;\n    let text = validation.data.text;\n    let subject = validation.data.subject;\n\n    // 2. If template_id provided, load template\n    if (validation.data.template_id) {\n      const templateResult = await getTemplate(validation.data.template_id);\n      if (!templateResult.success) {\n        return {\n          success: false,\n          error: {\n            code: ERROR_CODES.NOT_FOUND,\n            message: 'Template not found',\n          },\n        };\n      }\n\n      const template = templateResult.data;\n      const variables = validation.data.variables || {};\n\n      html = substituteVariables(template.body_html, variables);\n      text = substituteVariables(template.body_text, variables);\n      subject = substituteVariables(template.subject, variables);\n    }\n\n    // 3. Send emails to all recipients\n    let sent = 0;\n    let failed = 0;\n\n    for (const recipient of validation.data.recipients) {\n      const result = await sendEmail({\n        to: recipient,\n        subject,\n        html,\n        text,\n        template_id: validation.data.template_id,\n      });\n\n      if (result.success) {\n        sent++;\n      } else {\n        failed++;\n      }\n    }\n\n    return { success: true, data: { sent, failed } };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Schedules an email for future delivery.\n * Requirements: 12.5\n */\nexport async function scheduleEmail(\n  data: ScheduleEmailDTO\n): Promise<Result<{ id: string }>> {\n  try {\n    // 1. Validate\n    const validation = scheduleEmailSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Check that scheduled time is in the future\n    const scheduledDate = new Date(validation.data.scheduled_at);\n    if (scheduledDate <= new Date()) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Scheduled time must be in the future',\n        },\n      };\n    }\n\n    // 3. Store scheduled email in database\n    const { data: scheduledEmail, error } = await supabase\n      .from('scheduled_emails')\n      .insert({\n        recipient_email: validation.data.to,\n        subject: validation.data.subject,\n        html: validation.data.html,\n        text: validation.data.text,\n        template_id: validation.data.template_id,\n        scheduled_at: validation.data.scheduled_at,\n        status: 'pending',\n      })\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: { id: scheduledEmail.id } };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Updates email delivery status from webhook.\n * Requirements: 12.7\n */\nexport async function updateDeliveryStatus(\n  emailId: string,\n  status: 'delivered' | 'bounced' | 'failed',\n  errorMessage?: string\n): Promise<Result<void>> {\n  try {\n    const updateData: any = {\n      delivery_status: status,\n    };\n\n    if (status === 'delivered') {\n      updateData.delivered_at = new Date().toISOString();\n    }\n\n    if (errorMessage) {\n      updateData.error_message = errorMessage;\n    }\n\n    const { error } = await supabase\n      .from('email_logs')\n      .update(updateData)\n      .eq('id', emailId);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Gets email delivery analytics.\n * Requirements: 12.4\n */\nexport async function getEmailAnalytics(): Promise<\n  Result<{\n    total: number;\n    sent: number;\n    delivered: number;\n    failed: number;\n    bounced: number;\n  }>\n> {\n  try {\n    const { data: logs, error } = await supabase\n      .from('email_logs')\n      .select('delivery_status');\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    const analytics = {\n      total: logs.length,\n      sent: logs.filter((l) => l.delivery_status === 'sent').length,\n      delivered: logs.filter((l) => l.delivery_status === 'delivered').length,\n      failed: logs.filter((l) => l.delivery_status === 'failed').length,\n      bounced: logs.filter((l) => l.delivery_status === 'bounced').length,\n    };\n\n    return { success: true, data: analytics };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Gets email logs with optional filtering.\n * Requirements: 12.6\n */\nexport async function getEmailLogs(filters?: {\n  template_id?: string;\n  recipient_email?: string;\n  delivery_status?: string;\n  limit?: number;\n}): Promise<Result<EmailLog[]>> {\n  try {\n    let query = supabase\n      .from('email_logs')\n      .select('*')\n      .order('created_at', { ascending: false });\n\n    if (filters?.template_id) {\n      query = query.eq('template_id', filters.template_id);\n    }\n\n    if (filters?.recipient_email) {\n      query = query.eq('recipient_email', filters.recipient_email);\n    }\n\n    if (filters?.delivery_status) {\n      query = query.eq('delivery_status', filters.delivery_status);\n    }\n\n    if (filters?.limit) {\n      query = query.limit(filters.limit);\n    }\n\n    const { data: logs, error } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: logs || [] };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Sends an email with automatic SMS fallback on failure.\n * Requirements: 12.9, 12.10\n * \n * @param data - Email data including recipient email\n * @param fallbackPhone - Optional phone number for SMS fallback\n * @returns Result containing the delivery method and ID\n */\nexport async function sendEmailWithSMSFallback(\n  data: SendEmailDTO,\n  fallbackPhone?: string\n): Promise<Result<{ id: string; method: 'email' | 'sms' }>> {\n  try {\n    // 1. Attempt to send email\n    const emailResult = await sendEmail(data);\n\n    if (emailResult.success) {\n      return {\n        success: true,\n        data: {\n          id: emailResult.data.id,\n          method: 'email',\n        },\n      };\n    }\n\n    // 2. If email fails and phone number provided, try SMS fallback\n    if (fallbackPhone) {\n      // Strip HTML tags from email body for SMS\n      const textBody = data.text || data.html.replace(/<[^>]*>/g, '');\n      \n      const smsResult = await sendSMSFallback(\n        fallbackPhone,\n        data.subject,\n        textBody\n      );\n\n      if (smsResult.success) {\n        return {\n          success: true,\n          data: {\n            id: smsResult.data.id,\n            method: 'sms',\n          },\n        };\n      }\n\n      // Both email and SMS failed\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.EXTERNAL_SERVICE_ERROR,\n          message: 'Both email and SMS delivery failed',\n          details: {\n            emailError: emailResult.error,\n            smsError: smsResult.error,\n          },\n        },\n      };\n    }\n\n    // Email failed and no phone number for fallback\n    return emailResult;\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n"],"names":["createTemplate","deleteTemplate","getEmailAnalytics","getEmailLogs","getResendClient","getTemplate","listTemplates","resetResendClient","scheduleEmail","sendBulkEmail","sendEmail","sendEmailWithSMSFallback","setResendClient","updateDeliveryStatus","updateTemplate","resendClientInstance","Resend","process","env","RESEND_API_KEY","client","supabase","createClient","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","sanitizeEmailHTML","html","sanitizeRichText","validateTemplateVariables","template","allowedVariables","variablePattern","matches","matchAll","undefinedVars","match","varName","includes","push","length","success","error","code","ERROR_CODES","VALIDATION_ERROR","message","details","undefinedVariables","data","undefined","substituteVariables","variables","result","key","value","Object","entries","pattern","RegExp","replace","validation","createEmailTemplateSchema","safeParse","issues","sanitized","body_html","htmlValidation","textValidation","body_text","from","insert","select","single","DATABASE_ERROR","UNKNOWN_ERROR","Error","id","eq","NOT_FOUND","updateEmailTemplateSchema","existingResult","update","delete","templates","order","ascending","sendEmailSchema","text","subject","template_id","templateResult","resend","emailData","resendError","emails","send","RESEND_FROM_EMAIL","to","recipient_email","delivery_status","error_message","EMAIL_SERVICE_ERROR","sent_at","Date","toISOString","sendBulkEmailSchema","sent","failed","recipient","recipients","scheduleEmailSchema","scheduledDate","scheduled_at","scheduledEmail","status","emailId","errorMessage","updateData","delivered_at","logs","analytics","total","filter","l","delivered","bounced","filters","query","limit","fallbackPhone","emailResult","method","textBody","smsResult","sendSMSFallback","EXTERNAL_SERVICE_ERROR","emailError","smsError"],"mappings":"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"}