{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/lib/queryOptimization.test.ts"],"sourcesContent":["/**\n * Query Optimization Utilities Tests\n * \n * Tests for database query optimization functions\n */\n\nimport {\n  getPaginationRange,\n  PAGINATION_DEFAULTS,\n  fetchGuestsWithRSVPs,\n  fetchEventsWithActivities,\n  fetchActivitiesWithRSVPs,\n  batchFetchByIds,\n} from './queryOptimization';\n\ndescribe('Query Optimization Utilities', () => {\n  describe('getPaginationRange', () => {\n    it('should calculate correct range for first page', () => {\n      const result = getPaginationRange(1, 50);\n      expect(result).toEqual({ from: 0, to: 49 });\n    });\n\n    it('should calculate correct range for second page', () => {\n      const result = getPaginationRange(2, 50);\n      expect(result).toEqual({ from: 50, to: 99 });\n    });\n\n    it('should calculate correct range for custom page size', () => {\n      const result = getPaginationRange(3, 25);\n      expect(result).toEqual({ from: 50, to: 74 });\n    });\n\n    it('should handle page 1 with different page sizes', () => {\n      expect(getPaginationRange(1, 10)).toEqual({ from: 0, to: 9 });\n      expect(getPaginationRange(1, 100)).toEqual({ from: 0, to: 99 });\n    });\n  });\n\n  describe('PAGINATION_DEFAULTS', () => {\n    it('should have correct default values', () => {\n      expect(PAGINATION_DEFAULTS.GUESTS_PER_PAGE).toBe(50);\n      expect(PAGINATION_DEFAULTS.ACTIVITIES_PER_PAGE).toBe(50);\n      expect(PAGINATION_DEFAULTS.EVENTS_PER_PAGE).toBe(50);\n      expect(PAGINATION_DEFAULTS.PHOTOS_PER_PAGE).toBe(50);\n      expect(PAGINATION_DEFAULTS.EMAIL_HISTORY_PER_PAGE).toBe(50);\n      expect(PAGINATION_DEFAULTS.AUDIT_LOGS_PER_PAGE).toBe(100);\n    });\n  });\n\n  describe('fetchGuestsWithRSVPs', () => {\n    it('should build query with default pagination', () => {\n      const mockSupabase = createMockSupabaseClient();\n      \n      fetchGuestsWithRSVPs(mockSupabase as any);\n      \n      expect(mockSupabase.from).toHaveBeenCalledWith('guests');\n      expect(mockSupabase.select).toHaveBeenCalledWith(\n        expect.stringContaining('rsvps'),\n        { count: 'exact' }\n      );\n      expect(mockSupabase.range).toHaveBeenCalledWith(0, 49);\n      expect(mockSupabase.order).toHaveBeenCalledWith('last_name', { ascending: true });\n    });\n\n    it('should filter by group ID when provided', () => {\n      const mockSupabase = createMockSupabaseClient();\n      \n      fetchGuestsWithRSVPs(mockSupabase as any, { groupId: 'group-123' });\n      \n      expect(mockSupabase.eq).toHaveBeenCalledWith('group_id', 'group-123');\n    });\n\n    it('should use custom pagination', () => {\n      const mockSupabase = createMockSupabaseClient();\n      \n      fetchGuestsWithRSVPs(mockSupabase as any, { page: 2, pageSize: 25 });\n      \n      expect(mockSupabase.range).toHaveBeenCalledWith(25, 49);\n    });\n  });\n\n  describe('fetchEventsWithActivities', () => {\n    it('should build query with default pagination', () => {\n      const mockSupabase = createMockSupabaseClient();\n      \n      fetchEventsWithActivities(mockSupabase as any);\n      \n      expect(mockSupabase.from).toHaveBeenCalledWith('events');\n      expect(mockSupabase.select).toHaveBeenCalledWith(\n        expect.stringContaining('activities'),\n        { count: 'exact' }\n      );\n      expect(mockSupabase.range).toHaveBeenCalledWith(0, 49);\n      expect(mockSupabase.order).toHaveBeenCalledWith('event_date', { ascending: true });\n    });\n\n    it('should filter active events by default', () => {\n      const mockSupabase = createMockSupabaseClient();\n      \n      fetchEventsWithActivities(mockSupabase as any);\n      \n      expect(mockSupabase.eq).toHaveBeenCalledWith('is_active', true);\n    });\n\n    it('should include inactive events when requested', () => {\n      const mockSupabase = createMockSupabaseClient();\n      \n      fetchEventsWithActivities(mockSupabase as any, { includeInactive: true });\n      \n      expect(mockSupabase.eq).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('fetchActivitiesWithRSVPs', () => {\n    it('should build query with default pagination', () => {\n      const mockSupabase = createMockSupabaseClient();\n      \n      fetchActivitiesWithRSVPs(mockSupabase as any);\n      \n      expect(mockSupabase.from).toHaveBeenCalledWith('activities');\n      expect(mockSupabase.select).toHaveBeenCalledWith(\n        expect.stringContaining('rsvps'),\n        { count: 'exact' }\n      );\n      expect(mockSupabase.range).toHaveBeenCalledWith(0, 49);\n      expect(mockSupabase.order).toHaveBeenCalledWith('activity_date', { ascending: true });\n    });\n\n    it('should filter by event ID when provided', () => {\n      const mockSupabase = createMockSupabaseClient();\n      \n      fetchActivitiesWithRSVPs(mockSupabase as any, { eventId: 'event-123' });\n      \n      expect(mockSupabase.eq).toHaveBeenCalledWith('event_id', 'event-123');\n    });\n  });\n\n  describe('batchFetchByIds', () => {\n    it('should return empty array for empty IDs', async () => {\n      const mockSupabase = createMockSupabaseClient();\n      \n      const result = await batchFetchByIds(mockSupabase as any, 'guests', []);\n      \n      expect(result).toEqual({ data: [], error: null });\n      expect(mockSupabase.from).not.toHaveBeenCalled();\n    });\n\n    it('should fetch multiple entities by IDs', async () => {\n      const mockSupabase = createMockSupabaseClient();\n      const ids = ['id-1', 'id-2', 'id-3'];\n      \n      await batchFetchByIds(mockSupabase as any, 'guests', ids);\n      \n      expect(mockSupabase.from).toHaveBeenCalledWith('guests');\n      expect(mockSupabase.select).toHaveBeenCalledWith('*');\n      expect(mockSupabase.in).toHaveBeenCalledWith('id', ids);\n    });\n\n    it('should use custom select fields', async () => {\n      const mockSupabase = createMockSupabaseClient();\n      const ids = ['id-1', 'id-2'];\n      \n      await batchFetchByIds(mockSupabase as any, 'guests', ids, 'id, first_name, last_name');\n      \n      expect(mockSupabase.select).toHaveBeenCalledWith('id, first_name, last_name');\n    });\n  });\n});\n\n// Mock Supabase client for testing\nfunction createMockSupabaseClient() {\n  const mockChain = {\n    from: jest.fn().mockReturnThis(),\n    select: jest.fn().mockReturnThis(),\n    eq: jest.fn().mockReturnThis(),\n    in: jest.fn().mockReturnThis(),\n    range: jest.fn().mockReturnThis(),\n    order: jest.fn().mockReturnThis(),\n    single: jest.fn().mockResolvedValue({ data: null, error: null }),\n    maybeSingle: jest.fn().mockResolvedValue({ data: null, error: null }),\n  };\n\n  return mockChain;\n}\n"],"names":["describe","it","result","getPaginationRange","expect","toEqual","from","to","PAGINATION_DEFAULTS","GUESTS_PER_PAGE","toBe","ACTIVITIES_PER_PAGE","EVENTS_PER_PAGE","PHOTOS_PER_PAGE","EMAIL_HISTORY_PER_PAGE","AUDIT_LOGS_PER_PAGE","mockSupabase","createMockSupabaseClient","fetchGuestsWithRSVPs","toHaveBeenCalledWith","select","stringContaining","count","range","order","ascending","groupId","eq","page","pageSize","fetchEventsWithActivities","includeInactive","not","toHaveBeenCalled","fetchActivitiesWithRSVPs","eventId","batchFetchByIds","data","error","ids","in","mockChain","jest","fn","mockReturnThis","single","mockResolvedValue","maybeSingle"],"mappings":"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"}