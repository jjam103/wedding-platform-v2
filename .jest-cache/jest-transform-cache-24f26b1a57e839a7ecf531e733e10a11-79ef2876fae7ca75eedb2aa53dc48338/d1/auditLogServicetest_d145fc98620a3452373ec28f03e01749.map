{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/auditLogService.test.ts"],"sourcesContent":["import { auditLogService } from './auditLogService';\nimport type { SupabaseClient } from '@supabase/supabase-js';\n\n// Mock Supabase client\nfunction createMockSupabaseClient() {\n  const mockSelect = jest.fn().mockReturnThis();\n  const mockInsert = jest.fn().mockReturnThis();\n  const mockEq = jest.fn().mockReturnThis();\n  const mockGte = jest.fn().mockReturnThis();\n  const mockLte = jest.fn().mockReturnThis();\n  const mockOrder = jest.fn().mockReturnThis();\n  const mockRange = jest.fn().mockReturnThis();\n  const mockSingle = jest.fn();\n  const mockFrom = jest.fn().mockReturnValue({\n    select: mockSelect,\n    insert: mockInsert,\n    eq: mockEq,\n    gte: mockGte,\n    lte: mockLte,\n    order: mockOrder,\n    range: mockRange,\n    single: mockSingle,\n  });\n\n  return {\n    from: mockFrom,\n    _mocks: {\n      from: mockFrom,\n      select: mockSelect,\n      insert: mockInsert,\n      eq: mockEq,\n      gte: mockGte,\n      lte: mockLte,\n      order: mockOrder,\n      range: mockRange,\n      single: mockSingle,\n    },\n  } as unknown as SupabaseClient & { _mocks: any };\n}\n\ndescribe('auditLogService', () => {\n  describe('create', () => {\n    it('should create audit log with valid data', async () => {\n      const mockSupabase = createMockSupabaseClient();\n      const mockAuditLog = {\n        id: 'log-123',\n        user_id: 'user-456',\n        user_email: 'admin@example.com',\n        entity_type: 'guest',\n        entity_id: 'guest-789',\n        operation_type: 'create',\n        old_data: null,\n        new_data: { first_name: 'John', last_name: 'Doe' },\n        ip_address: '192.168.1.1',\n        user_agent: 'Mozilla/5.0',\n        created_at: new Date().toISOString(),\n      };\n\n      mockSupabase._mocks.single.mockResolvedValue({\n        data: mockAuditLog,\n        error: null,\n      } as any);\n\n      const result = await auditLogService.create(mockSupabase, {\n        user_id: 'user-456',\n        user_email: 'admin@example.com',\n        entity_type: 'guest',\n        entity_id: 'guest-789',\n        operation_type: 'create',\n        new_data: { first_name: 'John', last_name: 'Doe' },\n        ip_address: '192.168.1.1',\n        user_agent: 'Mozilla/5.0',\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('log-123');\n        expect(result.data.entity_type).toBe('guest');\n        expect(result.data.operation_type).toBe('create');\n      }\n    });\n\n    it('should return VALIDATION_ERROR when required fields are missing', async () => {\n      const mockSupabase = createMockSupabaseClient();\n\n      const result = await auditLogService.create(mockSupabase, {\n        entity_type: '',\n        entity_id: 'guest-789',\n        operation_type: 'create',\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n        expect(result.error.message).toContain('required fields');\n      }\n    });\n\n    it('should return VALIDATION_ERROR for invalid operation_type', async () => {\n      const mockSupabase = createMockSupabaseClient();\n\n      const result = await auditLogService.create(mockSupabase, {\n        entity_type: 'guest',\n        entity_id: 'guest-789',\n        operation_type: 'invalid' as any,\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('VALIDATION_ERROR');\n        expect(result.error.message).toContain('Invalid operation_type');\n      }\n    });\n\n    it('should return DATABASE_ERROR when insert fails', async () => {\n      const mockSupabase = createMockSupabaseClient();\n\n      mockSupabase._mocks.single.mockResolvedValue({\n        data: null,\n        error: { message: 'Database connection failed' },\n      } as any);\n\n      const result = await auditLogService.create(mockSupabase, {\n        entity_type: 'guest',\n        entity_id: 'guest-789',\n        operation_type: 'create',\n      });\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n  });\n\n  describe('list', () => {\n    it('should retrieve paginated audit logs', async () => {\n      const mockSupabase = createMockSupabaseClient();\n      const mockLogs = [\n        {\n          id: 'log-1',\n          entity_type: 'guest',\n          operation_type: 'create',\n          created_at: new Date().toISOString(),\n        },\n        {\n          id: 'log-2',\n          entity_type: 'event',\n          operation_type: 'update',\n          created_at: new Date().toISOString(),\n        },\n      ];\n\n      // Mock the chain to return data and count\n      mockSupabase._mocks.range.mockResolvedValue({\n        data: mockLogs,\n        error: null,\n        count: 2,\n      } as any);\n\n      const result = await auditLogService.list(mockSupabase, {\n        page: 1,\n        page_size: 50,\n      });\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.logs).toHaveLength(2);\n        expect(result.data.total).toBe(2);\n        expect(result.data.page).toBe(1);\n        expect(result.data.page_size).toBe(50);\n      }\n    });\n\n    it('should apply filters correctly', async () => {\n      const mockSupabase = createMockSupabaseClient();\n\n      mockSupabase._mocks.range.mockResolvedValue({\n        data: [],\n        error: null,\n        count: 0,\n      } as any);\n\n      await auditLogService.list(mockSupabase, {\n        entity_type: 'guest',\n        operation_type: 'update',\n        user_id: 'user-123',\n      });\n\n      expect(mockSupabase._mocks.eq).toHaveBeenCalledWith('entity_type', 'guest');\n      expect(mockSupabase._mocks.eq).toHaveBeenCalledWith('operation_type', 'update');\n      expect(mockSupabase._mocks.eq).toHaveBeenCalledWith('user_id', 'user-123');\n    });\n\n    it('should return DATABASE_ERROR when query fails', async () => {\n      const mockSupabase = createMockSupabaseClient();\n\n      mockSupabase._mocks.range.mockResolvedValue({\n        data: null,\n        error: { message: 'Query failed' },\n        count: null,\n      } as any);\n\n      const result = await auditLogService.list(mockSupabase);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('DATABASE_ERROR');\n      }\n    });\n  });\n\n  describe('get', () => {\n    it('should retrieve single audit log by ID', async () => {\n      const mockSupabase = createMockSupabaseClient();\n      const mockLog = {\n        id: 'log-123',\n        entity_type: 'guest',\n        operation_type: 'update',\n        created_at: new Date().toISOString(),\n      };\n\n      mockSupabase._mocks.single.mockResolvedValue({\n        data: mockLog,\n        error: null,\n      } as any);\n\n      const result = await auditLogService.get(mockSupabase, 'log-123');\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe('log-123');\n      }\n    });\n\n    it('should return NOT_FOUND when audit log does not exist', async () => {\n      const mockSupabase = createMockSupabaseClient();\n\n      mockSupabase._mocks.single.mockResolvedValue({\n        data: null,\n        error: { code: 'PGRST116', message: 'Not found' },\n      } as any);\n\n      const result = await auditLogService.get(mockSupabase, 'nonexistent');\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error.code).toBe('NOT_FOUND');\n      }\n    });\n  });\n\n  describe('helper functions', () => {\n    it('logCreate should create audit log for create operation', async () => {\n      const mockSupabase = createMockSupabaseClient();\n\n      mockSupabase._mocks.single.mockResolvedValue({\n        data: {\n          id: 'log-123',\n          operation_type: 'create',\n          entity_type: 'guest',\n          entity_id: 'guest-456',\n        },\n        error: null,\n      } as any);\n\n      const result = await auditLogService.logCreate(\n        mockSupabase,\n        'guest',\n        'guest-456',\n        { first_name: 'John' },\n        'user-123',\n        'user@example.com'\n      );\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.operation_type).toBe('create');\n      }\n    });\n\n    it('logUpdate should create audit log for update operation', async () => {\n      const mockSupabase = createMockSupabaseClient();\n\n      mockSupabase._mocks.single.mockResolvedValue({\n        data: {\n          id: 'log-123',\n          operation_type: 'update',\n          entity_type: 'guest',\n          entity_id: 'guest-456',\n        },\n        error: null,\n      } as any);\n\n      const result = await auditLogService.logUpdate(\n        mockSupabase,\n        'guest',\n        'guest-456',\n        { first_name: 'John' },\n        { first_name: 'Jane' },\n        'user-123',\n        'user@example.com'\n      );\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.operation_type).toBe('update');\n      }\n    });\n\n    it('logDelete should create audit log for delete operation', async () => {\n      const mockSupabase = createMockSupabaseClient();\n\n      mockSupabase._mocks.single.mockResolvedValue({\n        data: {\n          id: 'log-123',\n          operation_type: 'delete',\n          entity_type: 'guest',\n          entity_id: 'guest-456',\n        },\n        error: null,\n      } as any);\n\n      const result = await auditLogService.logDelete(\n        mockSupabase,\n        'guest',\n        'guest-456',\n        { first_name: 'John' },\n        'user-123',\n        'user@example.com'\n      );\n\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.operation_type).toBe('delete');\n      }\n    });\n  });\n});\n"],"names":["createMockSupabaseClient","mockSelect","jest","fn","mockReturnThis","mockInsert","mockEq","mockGte","mockLte","mockOrder","mockRange","mockSingle","mockFrom","mockReturnValue","select","insert","eq","gte","lte","order","range","single","from","_mocks","describe","it","mockSupabase","mockAuditLog","id","user_id","user_email","entity_type","entity_id","operation_type","old_data","new_data","first_name","last_name","ip_address","user_agent","created_at","Date","toISOString","mockResolvedValue","data","error","result","auditLogService","create","expect","success","toBe","code","message","toContain","mockLogs","count","list","page","page_size","logs","toHaveLength","total","toHaveBeenCalledWith","mockLog","get","logCreate","logUpdate","logDelete"],"mappings":"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"}