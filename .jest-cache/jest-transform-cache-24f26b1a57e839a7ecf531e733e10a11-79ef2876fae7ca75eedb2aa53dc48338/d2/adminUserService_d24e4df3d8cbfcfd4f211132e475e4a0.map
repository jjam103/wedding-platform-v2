{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/adminUserService.ts"],"sourcesContent":["/**\n * Admin User Service\n * \n * Handles admin user management including creation, updates, deactivation, and deletion.\n * Enforces owner-only permissions and last owner protection.\n * \n * Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9, 3.10\n */\n\nimport { createServiceRoleClient } from '@/lib/supabaseServer';\nimport { sanitizeInput } from '@/utils/sanitization';\nimport { z } from 'zod';\nimport type { Result } from '@/types';\nimport * as emailService from './emailService';\n\n// Types\nexport interface AdminUser {\n  id: string;\n  email: string;\n  role: 'admin' | 'owner';\n  status: 'active' | 'inactive';\n  invitedBy?: string;\n  invitedAt: string;\n  lastLoginAt?: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\n// Validation schemas\nconst createAdminUserSchema = z.object({\n  email: z.string().email(),\n  role: z.enum(['admin', 'owner']),\n});\n\nconst updateAdminUserSchema = z.object({\n  email: z.string().email().optional(),\n  role: z.enum(['admin', 'owner']).optional(),\n  status: z.enum(['active', 'inactive']).optional(),\n});\n\nexport type CreateAdminUserDTO = z.infer<typeof createAdminUserSchema>;\nexport type UpdateAdminUserDTO = z.infer<typeof updateAdminUserSchema>;\n\n/**\n * Create a new admin user\n * \n * @param data - Admin user data\n * @param invitedBy - ID of the user creating this admin\n * @returns Result containing the created admin user or error\n */\nexport async function create(\n  data: CreateAdminUserDTO,\n  invitedBy: string\n): Promise<Result<AdminUser>> {\n  try {\n    // 1. Validate\n    const validation = createAdminUserSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid admin user data',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize\n    const sanitized = {\n      ...validation.data,\n      email: sanitizeInput(validation.data.email.toLowerCase()),\n    };\n\n    // 3. Check if email already exists\n    const supabase = createServiceRoleClient();\n    const { data: existing } = await supabase\n      .from('admin_users')\n      .select('id')\n      .eq('email', sanitized.email)\n      .single();\n\n    if (existing) {\n      return {\n        success: false,\n        error: {\n          code: 'CONFLICT',\n          message: 'Admin user with this email already exists',\n        },\n      };\n    }\n\n    // 4. Create admin user\n    const { data: adminUser, error } = await supabase\n      .from('admin_users')\n      .insert({\n        email: sanitized.email,\n        role: sanitized.role,\n        invited_by: invitedBy,\n      })\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    // 5. Send invitation email\n    const inviteResult = await sendInvitationEmail(adminUser.email, adminUser.role);\n    if (!inviteResult.success) {\n      // Log error but don't fail the creation\n      console.error('Failed to send invitation email:', inviteResult.error);\n    }\n\n    return { success: true, data: adminUser };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Get all admin users\n * \n * @returns Result containing list of admin users or error\n */\nexport async function list(): Promise<Result<AdminUser[]>> {\n  try {\n    const supabase = createServiceRoleClient();\n    const { data, error } = await supabase\n      .from('admin_users')\n      .select('*')\n      .order('created_at', { ascending: false });\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: data || [] };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Get admin user by ID\n * \n * @param id - Admin user ID\n * @returns Result containing admin user or error\n */\nexport async function get(id: string): Promise<Result<AdminUser>> {\n  try {\n    const supabase = createServiceRoleClient();\n    const { data, error } = await supabase\n      .from('admin_users')\n      .select('*')\n      .eq('id', id)\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: error.code === 'PGRST116' ? 'NOT_FOUND' : 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Update admin user\n * \n * @param id - Admin user ID\n * @param data - Update data\n * @returns Result containing updated admin user or error\n */\nexport async function update(\n  id: string,\n  data: UpdateAdminUserDTO\n): Promise<Result<AdminUser>> {\n  try {\n    // 1. Validate\n    const validation = updateAdminUserSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid update data',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize\n    const sanitized: any = {};\n    if (validation.data.email) {\n      sanitized.email = sanitizeInput(validation.data.email.toLowerCase());\n    }\n    if (validation.data.role) {\n      sanitized.role = validation.data.role;\n    }\n    if (validation.data.status) {\n      sanitized.status = validation.data.status;\n    }\n\n    // 3. Check if trying to deactivate last owner\n    if (sanitized.status === 'inactive') {\n      const isLastOwnerResult = await isLastOwner(id);\n      if (!isLastOwnerResult.success) {\n        return isLastOwnerResult as Result<AdminUser>;\n      }\n      if (isLastOwnerResult.data) {\n        return {\n          success: false,\n          error: {\n            code: 'FORBIDDEN',\n            message: 'Cannot deactivate the last owner account',\n          },\n        };\n      }\n    }\n\n    // 4. Update admin user\n    const supabase = createServiceRoleClient();\n    const { data: adminUser, error } = await supabase\n      .from('admin_users')\n      .update(sanitized)\n      .eq('id', id)\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: error.code === 'PGRST116' ? 'NOT_FOUND' : 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: adminUser };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Deactivate admin user\n * \n * @param id - Admin user ID\n * @returns Result containing deactivated admin user or error\n */\nexport async function deactivate(id: string): Promise<Result<AdminUser>> {\n  return update(id, { status: 'inactive' });\n}\n\n/**\n * Delete admin user\n * \n * @param id - Admin user ID\n * @returns Result indicating success or error\n */\nexport async function deleteUser(id: string): Promise<Result<void>> {\n  try {\n    // 1. Check if last owner\n    const isLastOwnerResult = await isLastOwner(id);\n    if (!isLastOwnerResult.success) {\n      return isLastOwnerResult as Result<void>;\n    }\n    if (isLastOwnerResult.data) {\n      return {\n        success: false,\n        error: {\n          code: 'FORBIDDEN',\n          message: 'Cannot delete the last owner account',\n        },\n      };\n    }\n\n    // 2. Delete admin user\n    const supabase = createServiceRoleClient();\n    const { error } = await supabase\n      .from('admin_users')\n      .delete()\n      .eq('id', id);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: error.code === 'PGRST116' ? 'NOT_FOUND' : 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Resend invitation email\n * \n * @param id - Admin user ID\n * @returns Result indicating success or error\n */\nexport async function resendInvitation(id: string): Promise<Result<void>> {\n  try {\n    // 1. Get admin user\n    const result = await get(id);\n    if (!result.success) {\n      return result as Result<void>;\n    }\n\n    // 2. Send invitation email\n    const inviteResult = await sendInvitationEmail(result.data.email, result.data.role);\n    if (!inviteResult.success) {\n      return inviteResult as Result<void>;\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Update last login timestamp\n * \n * @param id - Admin user ID\n * @returns Result indicating success or error\n */\nexport async function updateLastLogin(id: string): Promise<Result<void>> {\n  try {\n    const supabase = createServiceRoleClient();\n    const { error } = await supabase\n      .from('admin_users')\n      .update({ last_login_at: new Date().toISOString() })\n      .eq('id', id);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Check if user is the last active owner\n * \n * @param id - Admin user ID\n * @returns Result containing boolean indicating if last owner\n */\nasync function isLastOwner(id: string): Promise<Result<boolean>> {\n  try {\n    const supabase = createServiceRoleClient();\n    \n    // Get the user\n    const { data: user, error: userError } = await supabase\n      .from('admin_users')\n      .select('role, status')\n      .eq('id', id)\n      .single();\n\n    if (userError) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: userError.message,\n          details: userError,\n        },\n      };\n    }\n\n    // If not an owner, not the last owner\n    if (user.role !== 'owner') {\n      return { success: true, data: false };\n    }\n\n    // Count active owners\n    const { count, error: countError } = await supabase\n      .from('admin_users')\n      .select('*', { count: 'exact', head: true })\n      .eq('role', 'owner')\n      .eq('status', 'active');\n\n    if (countError) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: countError.message,\n          details: countError,\n        },\n      };\n    }\n\n    // If only 1 active owner, this is the last one\n    return { success: true, data: (count || 0) <= 1 };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Send invitation email to new admin user\n * \n * @param email - Admin user email\n * @param role - Admin user role\n * @returns Result indicating success or error\n */\nasync function sendInvitationEmail(\n  email: string,\n  role: 'admin' | 'owner'\n): Promise<Result<void>> {\n  try {\n    const setupLink = `${process.env.NEXT_PUBLIC_URL}/auth/admin/setup`;\n    \n    const result = await emailService.sendEmail({\n      to: email,\n      subject: 'You\\'ve been invited to manage the wedding',\n      html: `\n        <p>Hi,</p>\n        <p>You've been invited to help manage the wedding website.</p>\n        <p><strong>Your role:</strong> ${role === 'owner' ? 'Owner' : 'Admin'}</p>\n        <p>Click here to set up your account: <a href=\"${setupLink}\">${setupLink}</a></p>\n        <p>This invitation expires in 7 days.</p>\n      `,\n    });\n\n    if (!result.success) {\n      return {\n        success: false,\n        error: {\n          code: 'EMAIL_SERVICE_ERROR',\n          message: 'Failed to send invitation email',\n          details: result.error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\nexport const adminUserService = {\n  create,\n  list,\n  get,\n  update,\n  deactivate,\n  delete: deleteUser,\n  resendInvitation,\n  updateLastLogin,\n};\n"],"names":["adminUserService","create","deactivate","deleteUser","get","list","resendInvitation","update","updateLastLogin","createAdminUserSchema","z","object","email","string","role","enum","updateAdminUserSchema","optional","status","data","invitedBy","validation","safeParse","success","error","code","message","details","issues","sanitized","sanitizeInput","toLowerCase","supabase","createServiceRoleClient","existing","from","select","eq","single","adminUser","insert","invited_by","inviteResult","sendInvitationEmail","console","Error","order","ascending","id","isLastOwnerResult","isLastOwner","delete","undefined","result","last_login_at","Date","toISOString","user","userError","count","countError","head","setupLink","process","env","NEXT_PUBLIC_URL","emailService","sendEmail","to","subject","html"],"mappings":"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"}