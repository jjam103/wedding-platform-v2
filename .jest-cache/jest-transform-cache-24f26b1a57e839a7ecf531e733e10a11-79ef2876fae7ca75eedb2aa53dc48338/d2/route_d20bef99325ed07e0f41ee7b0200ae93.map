{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/auth/guest/email-match/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { cookies } from 'next/headers';\nimport { createSupabaseClient } from '@/lib/supabase';\nimport { z } from 'zod';\nimport { sanitizeInput } from '@/utils/sanitization';\n\n/**\n * Email Matching Authentication API Route\n * \n * Authenticates guests by matching their login email to their guest record email.\n * Creates a guest session on successful match and sets an HTTP-only session cookie.\n * \n * Requirements: 5.2, 22.4\n * Task: 5.1\n */\n\nconst emailMatchSchema = z.object({\n  email: z.string().email('Invalid email format'),\n});\n\n/**\n * POST /api/auth/guest/email-match\n * \n * Authenticates a guest using email matching.\n * \n * @param request - Request containing email in body\n * @returns Success response with guest ID and group ID, or error response\n */\nexport async function POST(request: Request) {\n  try {\n    // 1. Parse and validate request body\n    const body = await request.json();\n    const validation = emailMatchSchema.safeParse(body);\n    \n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid email format',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n    \n    // 2. Sanitize email input\n    const email = sanitizeInput(validation.data.email.toLowerCase());\n    \n    // 3. Create Supabase client\n    const supabase = createSupabaseClient();\n    \n    // 4. Find guest by email with email_matching auth method\n    const { data: guest, error: guestError } = await supabase\n      .from('guests')\n      .select('id, email, group_id, first_name, last_name, auth_method')\n      .eq('email', email)\n      .eq('auth_method', 'email_matching')\n      .single();\n    \n    if (guestError || !guest) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'NOT_FOUND',\n            message: 'Email not found or not configured for email matching authentication',\n          },\n        },\n        { status: 404 }\n      );\n    }\n    \n    // 5. Generate session token (32 bytes)\n    const sessionToken = Array.from(crypto.getRandomValues(new Uint8Array(32)))\n      .map(b => b.toString(16).padStart(2, '0'))\n      .join('');\n    \n    // 6. Create session record in database\n    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours\n    \n    const { data: session, error: sessionError } = await supabase\n      .from('guest_sessions')\n      .insert({\n        guest_id: guest.id,\n        token: sessionToken,\n        expires_at: expiresAt.toISOString(),\n        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || 'unknown',\n        user_agent: request.headers.get('user-agent') || 'unknown',\n      })\n      .select()\n      .single();\n    \n    if (sessionError || !session) {\n      console.error('Failed to create guest session:', sessionError);\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'SESSION_ERROR',\n            message: 'Failed to create session',\n          },\n        },\n        { status: 500 }\n      );\n    }\n    \n    // 7. Set HTTP-only session cookie\n    const cookieStore = await cookies();\n    cookieStore.set('guest_session', sessionToken, {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === 'production',\n      sameSite: 'lax',\n      maxAge: 60 * 60 * 24, // 24 hours\n      path: '/',\n    });\n    \n    // 8. Log authentication event\n    await supabase.from('audit_logs').insert({\n      action: 'guest_login',\n      entity_type: 'guest',\n      entity_id: guest.id,\n      details: {\n        auth_method: 'email_matching',\n        email: guest.email,\n        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || 'unknown',\n      },\n    });\n    \n    // 9. Return success response\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          guestId: guest.id,\n          groupId: guest.group_id,\n          firstName: guest.first_name,\n          lastName: guest.last_name,\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('Email matching authentication error:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'UNKNOWN_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error occurred',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["POST","emailMatchSchema","z","object","email","string","request","body","json","validation","safeParse","success","NextResponse","error","code","message","details","issues","status","sanitizeInput","data","toLowerCase","supabase","createSupabaseClient","guest","guestError","from","select","eq","single","sessionToken","Array","crypto","getRandomValues","Uint8Array","map","b","toString","padStart","join","expiresAt","Date","now","session","sessionError","insert","guest_id","id","token","expires_at","toISOString","ip_address","headers","get","user_agent","console","cookieStore","cookies","set","httpOnly","secure","process","env","NODE_ENV","sameSite","maxAge","path","action","entity_type","entity_id","auth_method","guestId","groupId","group_id","firstName","first_name","lastName","last_name","Error"],"mappings":";;;;+BA4BsBA;;;eAAAA;;;wBA5BO;yBACL;0BACa;qBACnB;8BACY;AAE9B;;;;;;;;CAQC,GAED,MAAMC,mBAAmBC,MAAC,CAACC,MAAM,CAAC;IAChCC,OAAOF,MAAC,CAACG,MAAM,GAAGD,KAAK,CAAC;AAC1B;AAUO,eAAeJ,KAAKM,OAAgB;IACzC,IAAI;QACF,qCAAqC;QACrC,MAAMC,OAAO,MAAMD,QAAQE,IAAI;QAC/B,MAAMC,aAAaR,iBAAiBS,SAAS,CAACH;QAE9C,IAAI,CAACE,WAAWE,OAAO,EAAE;YACvB,OAAOC,oBAAY,CAACJ,IAAI,CACtB;gBACEG,SAAS;gBACTE,OAAO;oBACLC,MAAM;oBACNC,SAAS;oBACTC,SAASP,WAAWI,KAAK,CAACI,MAAM;gBAClC;YACF,GACA;gBAAEC,QAAQ;YAAI;QAElB;QAEA,0BAA0B;QAC1B,MAAMd,QAAQe,IAAAA,2BAAa,EAACV,WAAWW,IAAI,CAAChB,KAAK,CAACiB,WAAW;QAE7D,4BAA4B;QAC5B,MAAMC,WAAWC,IAAAA,8BAAoB;QAErC,yDAAyD;QACzD,MAAM,EAAEH,MAAMI,KAAK,EAAEX,OAAOY,UAAU,EAAE,GAAG,MAAMH,SAC9CI,IAAI,CAAC,UACLC,MAAM,CAAC,2DACPC,EAAE,CAAC,SAASxB,OACZwB,EAAE,CAAC,eAAe,kBAClBC,MAAM;QAET,IAAIJ,cAAc,CAACD,OAAO;YACxB,OAAOZ,oBAAY,CAACJ,IAAI,CACtB;gBACEG,SAAS;gBACTE,OAAO;oBACLC,MAAM;oBACNC,SAAS;gBACX;YACF,GACA;gBAAEG,QAAQ;YAAI;QAElB;QAEA,uCAAuC;QACvC,MAAMY,eAAeC,MAAML,IAAI,CAACM,OAAOC,eAAe,CAAC,IAAIC,WAAW,MACnEC,GAAG,CAACC,CAAAA,IAAKA,EAAEC,QAAQ,CAAC,IAAIC,QAAQ,CAAC,GAAG,MACpCC,IAAI,CAAC;QAER,uCAAuC;QACvC,MAAMC,YAAY,IAAIC,KAAKA,KAAKC,GAAG,KAAK,KAAK,KAAK,KAAK,OAAO,WAAW;QAEzE,MAAM,EAAEtB,MAAMuB,OAAO,EAAE9B,OAAO+B,YAAY,EAAE,GAAG,MAAMtB,SAClDI,IAAI,CAAC,kBACLmB,MAAM,CAAC;YACNC,UAAUtB,MAAMuB,EAAE;YAClBC,OAAOlB;YACPmB,YAAYT,UAAUU,WAAW;YACjCC,YAAY7C,QAAQ8C,OAAO,CAACC,GAAG,CAAC,sBAAsB/C,QAAQ8C,OAAO,CAACC,GAAG,CAAC,gBAAgB;YAC1FC,YAAYhD,QAAQ8C,OAAO,CAACC,GAAG,CAAC,iBAAiB;QACnD,GACC1B,MAAM,GACNE,MAAM;QAET,IAAIe,gBAAgB,CAACD,SAAS;YAC5BY,QAAQ1C,KAAK,CAAC,mCAAmC+B;YACjD,OAAOhC,oBAAY,CAACJ,IAAI,CACtB;gBACEG,SAAS;gBACTE,OAAO;oBACLC,MAAM;oBACNC,SAAS;gBACX;YACF,GACA;gBAAEG,QAAQ;YAAI;QAElB;QAEA,kCAAkC;QAClC,MAAMsC,cAAc,MAAMC,IAAAA,gBAAO;QACjCD,YAAYE,GAAG,CAAC,iBAAiB5B,cAAc;YAC7C6B,UAAU;YACVC,QAAQC,QAAQC,GAAG,CAACC,QAAQ,KAAK;YACjCC,UAAU;YACVC,QAAQ,KAAK,KAAK;YAClBC,MAAM;QACR;QAEA,8BAA8B;QAC9B,MAAM5C,SAASI,IAAI,CAAC,cAAcmB,MAAM,CAAC;YACvCsB,QAAQ;YACRC,aAAa;YACbC,WAAW7C,MAAMuB,EAAE;YACnB/B,SAAS;gBACPsD,aAAa;gBACblE,OAAOoB,MAAMpB,KAAK;gBAClB+C,YAAY7C,QAAQ8C,OAAO,CAACC,GAAG,CAAC,sBAAsB/C,QAAQ8C,OAAO,CAACC,GAAG,CAAC,gBAAgB;YAC5F;QACF;QAEA,6BAA6B;QAC7B,OAAOzC,oBAAY,CAACJ,IAAI,CACtB;YACEG,SAAS;YACTS,MAAM;gBACJmD,SAAS/C,MAAMuB,EAAE;gBACjByB,SAAShD,MAAMiD,QAAQ;gBACvBC,WAAWlD,MAAMmD,UAAU;gBAC3BC,UAAUpD,MAAMqD,SAAS;YAC3B;QACF,GACA;YAAE3D,QAAQ;QAAI;IAElB,EAAE,OAAOL,OAAO;QACd0C,QAAQ1C,KAAK,CAAC,wCAAwCA;QACtD,OAAOD,oBAAY,CAACJ,IAAI,CACtB;YACEG,SAAS;YACTE,OAAO;gBACLC,MAAM;gBACNC,SAASF,iBAAiBiE,QAAQjE,MAAME,OAAO,GAAG;YACpD;QACF,GACA;YAAEG,QAAQ;QAAI;IAElB;AACF"}