{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/regression/contentPagesRls.regression.test.ts"],"sourcesContent":["/**\n * Content Pages RLS Regression Test\n * \n * This test prevents regression of the \"violates row-level security policy\" bug\n * that occurred when creating content pages with real authentication.\n * \n * Bug Description:\n * - Content pages table had RLS policies enabled\n * - Service methods used service role client that bypassed RLS\n * - When called from API routes with real auth, RLS policies were enforced\n * - RLS policies were misconfigured or missing for authenticated users\n * - Result: \"new row violates row-level security policy\" error\n * \n * This test validates:\n * - Content pages can be created with real authentication\n * - RLS policies allow authenticated users to manage content pages\n * - No RLS violation errors occur\n * \n * Validates: Requirements 5.5\n */\n\nimport { withTestDatabase } from '../helpers/testDb';\nimport { createTestContentPage } from '../helpers/factories';\nimport { cleanupTestContentPages } from '../helpers/cleanup';\nimport * as contentPagesService from '@/services/contentPagesService';\n\ndescribe('Content Pages RLS Regression Tests', () => {\n  afterEach(async () => {\n    // Clean up test data\n    await cleanupTestContentPages();\n  });\n  \n  it('should create content page with real auth without RLS violation', async () => {\n    await withTestDatabase(async (db) => {\n      // Create authenticated user (not service role!)\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create content page with real authentication\n      const pageData = {\n        title: `Test Page ${Date.now()}`,\n        slug: `test-page-${Date.now()}`,\n        type: 'custom' as const,\n        published: false,\n      };\n      \n      const result = await contentPagesService.create(pageData);\n      \n      // THIS IS THE KEY TEST - Would have caught the RLS bug!\n      // The bug caused: \"new row violates row-level security policy\"\n      expect(result.success).toBe(true);\n      \n      if (result.success) {\n        expect(result.data).toBeDefined();\n        expect(result.data.title).toBe(pageData.title);\n        expect(result.data.slug).toBe(pageData.slug);\n        expect(result.data.type).toBe(pageData.type);\n      } else {\n        // If this fails, check the error message\n        console.error('Content page creation failed:', result.error);\n        expect(result.error.message).not.toContain('row-level security');\n        expect(result.error.message).not.toContain('policy');\n      }\n    });\n  });\n  \n  it('should update content page with real auth without RLS errors', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create content page\n      const page = createTestContentPage();\n      const { data: createdPage } = await client\n        .from('content_pages')\n        .insert(page)\n        .select()\n        .single();\n      \n      // Update content page with real auth\n      const result = await contentPagesService.update(createdPage.id, {\n        title: 'Updated Title',\n        published: true,\n      });\n      \n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.title).toBe('Updated Title');\n        expect(result.data.published).toBe(true);\n      }\n    });\n  });\n  \n  it('should delete content page with real auth without RLS errors', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create content page\n      const page = createTestContentPage();\n      const { data: createdPage } = await client\n        .from('content_pages')\n        .insert(page)\n        .select()\n        .single();\n      \n      // Delete content page with real auth\n      const result = await contentPagesService.deleteContentPage(createdPage.id);\n      \n      expect(result.success).toBe(true);\n    });\n  });\n  \n  it('should list content pages with real auth without RLS errors', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create multiple content pages\n      const pages = [\n        createTestContentPage({ title: 'Page 1', slug: `page-1-${Date.now()}` }),\n        createTestContentPage({ title: 'Page 2', slug: `page-2-${Date.now()}` }),\n      ];\n      \n      await client.from('content_pages').insert(pages);\n      \n      // List content pages with real auth\n      const result = await contentPagesService.list();\n      \n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.length).toBeGreaterThanOrEqual(2);\n      }\n    });\n  });\n  \n  it('should get content page by slug with real auth without RLS errors', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create content page\n      const page = createTestContentPage();\n      const { data: createdPage } = await client\n        .from('content_pages')\n        .insert(page)\n        .select()\n        .single();\n      \n      // Get content page by slug with real auth\n      const result = await contentPagesService.getBySlug(createdPage.slug);\n      \n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.id).toBe(createdPage.id);\n        expect(result.data.slug).toBe(createdPage.slug);\n      }\n    });\n  });\n  \n  it('should handle RLS policies correctly for different page types', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Test with different page types\n      const pageTypes = ['custom', 'home', 'our_story', 'accommodation', 'transportation'] as const;\n      \n      for (const type of pageTypes) {\n        const pageData = {\n          title: `Test ${type} Page`,\n          slug: `test-${type}-page-${Date.now()}`,\n          type,\n          published: false,\n        };\n        \n        const result = await contentPagesService.create(pageData);\n        \n        // Should not fail with RLS errors\n        if (!result.success) {\n          expect(result.error.message).not.toContain('row-level security');\n          expect(result.error.message).not.toContain('policy');\n        }\n      }\n    });\n  });\n  \n  it('should allow publishing and unpublishing with real auth', async () => {\n    await withTestDatabase(async (db) => {\n      const { client, user } = await db.createAuthenticatedClient();\n      \n      // Create unpublished page\n      const page = createTestContentPage({ published: false });\n      const { data: createdPage } = await client\n        .from('content_pages')\n        .insert(page)\n        .select()\n        .single();\n      \n      // Publish page\n      const publishResult = await contentPagesService.update(createdPage.id, {\n        published: true,\n      });\n      \n      expect(publishResult.success).toBe(true);\n      if (publishResult.success) {\n        expect(publishResult.data.published).toBe(true);\n      }\n      \n      // Unpublish page\n      const unpublishResult = await contentPagesService.update(createdPage.id, {\n        published: false,\n      });\n      \n      expect(unpublishResult.success).toBe(true);\n      if (unpublishResult.success) {\n        expect(unpublishResult.data.published).toBe(false);\n      }\n    });\n  });\n});\n\n/**\n * Why This Test Would Have Caught the Bug:\n * \n * The content pages RLS bug occurred because:\n * 1. Content pages table had RLS policies enabled\n * 2. Service methods used service role client (bypassed RLS)\n * 3. API routes used real auth (enforced RLS)\n * 4. RLS policies were misconfigured for authenticated users\n * \n * This test explicitly:\n * - Uses real authentication (not service role)\n * - Calls service methods that interact with content_pages table\n * - Validates no RLS violation errors occur\n * - Tests all CRUD operations with RLS enforcement\n * - Tests different page types to ensure policies work for all cases\n * \n * If the RLS policies are misconfigured, this test will fail with the exact\n * error message that users would see, making it easy to diagnose and fix.\n */\n"],"names":["describe","afterEach","cleanupTestContentPages","it","withTestDatabase","db","client","user","createAuthenticatedClient","pageData","title","Date","now","slug","type","published","result","contentPagesService","create","expect","success","toBe","data","toBeDefined","console","error","message","not","toContain","page","createTestContentPage","createdPage","from","insert","select","single","update","id","deleteContentPage","pages","list","length","toBeGreaterThanOrEqual","getBySlug","pageTypes","publishResult","unpublishResult"],"mappings":"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"}