{"version":3,"names":["POST","previewSchema","cov_4bl2uyqhs","s","_zod","z","object","template_id","string","uuid","optional","subject","html","variables","record","request","f","supabase","_authhelpersnextjs","createRouteHandlerClient","cookies","_headers","data","session","error","authError","auth","getSession","b","_server","NextResponse","json","success","code","message","status","body","validation","safeParse","details","issues","templateResult","_emailService","getTemplate","body_html","previewSubject","previewHtml","Object","entries","forEach","key","value","pattern","RegExp","replace"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/emails/preview/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { cookies } from 'next/headers';\nimport * as emailService from '@/services/emailService';\nimport { z } from 'zod';\n\nconst previewSchema = z.object({\n  template_id: z.string().uuid().optional(),\n  subject: z.string().optional(),\n  html: z.string().optional(),\n  variables: z.record(z.string(), z.string()).optional(),\n});\n\n/**\n * POST /api/admin/emails/preview\n * Previews an email with variable substitution\n * Requirements: 4.4\n */\nexport async function POST(request: Request) {\n  try {\n    // 1. Auth check\n    const supabase = createRouteHandlerClient({ cookies });\n    const { data: { session }, error: authError } = await supabase.auth.getSession();\n    \n    if (authError || !session) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n\n    // 2. Parse and validate\n    const body = await request.json();\n    const validation = previewSchema.safeParse(body);\n    \n    if (!validation.success) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: { \n            code: 'VALIDATION_ERROR', \n            message: 'Invalid request', \n            details: validation.error.issues \n          } \n        },\n        { status: 400 }\n      );\n    }\n\n    let subject = validation.data.subject || '';\n    let html = validation.data.html || '';\n    const variables = validation.data.variables || {};\n\n    // 3. If template_id provided, load template\n    if (validation.data.template_id) {\n      const templateResult = await emailService.getTemplate(validation.data.template_id);\n      \n      if (!templateResult.success) {\n        return NextResponse.json(\n          { success: false, error: { code: 'NOT_FOUND', message: 'Template not found' } },\n          { status: 404 }\n        );\n      }\n\n      subject = templateResult.data.subject;\n      html = templateResult.data.body_html;\n    }\n\n    // 4. Substitute variables\n    let previewSubject = subject;\n    let previewHtml = html;\n\n    Object.entries(variables).forEach(([key, value]) => {\n      const pattern = new RegExp(`\\\\{\\\\{${key}\\\\}\\\\}`, 'g');\n      previewSubject = previewSubject.replace(pattern, value);\n      previewHtml = previewHtml.replace(pattern, value);\n    });\n\n    // 5. Return preview\n    return NextResponse.json({\n      success: true,\n      data: {\n        subject: previewSubject,\n        html: previewHtml,\n      },\n    }, { status: 200 });\n  } catch (error) {\n    return NextResponse.json(\n      { success: false, error: { code: 'INTERNAL_ERROR', message: 'Internal server error' } },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}