{"version":3,"names":["cov_1cuqhbizep","actualCoverage","s","PATCH","updateFamilyMemberSchema","_zod","z","object","first_name","string","min","max","optional","last_name","email","nullable","phone","dietary_restrictions","request","params","f","auth","_apiAuth","getAuthenticatedUser","b","_server","NextResponse","json","success","error","code","message","status","user","supabase","id","data","currentGuest","currentGuestError","from","select","eq","single","targetMember","targetError","isAdult","age_type","isSameGroup","group_id","isSelf","body","validation","safeParse","details","issues","sanitized","undefined","_sanitization","sanitizeInput","updated","updateError","update","updated_at","Date","toISOString","Error"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/guest/family/[id]/route.ts"],"sourcesContent":["import { getAuthenticatedUser } from '@/lib/apiAuth';\nimport { NextResponse } from 'next/server';\nimport { z } from 'zod';\nimport { sanitizeInput } from '@/utils/sanitization';\n\nconst updateFamilyMemberSchema = z.object({\n  first_name: z.string().min(1).max(50).optional(),\n  last_name: z.string().min(1).max(50).optional(),\n  email: z.string().email().nullable().optional(),\n  phone: z.string().max(20).nullable().optional(),\n  dietary_restrictions: z.string().max(500).nullable().optional(),\n});\n\n/**\n * PATCH /api/guest/family/[id]\n * \n * Updates family member information with access control:\n * - Adults can update all family members in their group\n * - Children can only update their own information\n * \n * Requirements: 13.2, 13.3, 13.4\n */\nexport async function PATCH(\n  request: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const auth = await getAuthenticatedUser();\n    \n    if (!auth) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n\n    const { user, supabase } = auth;\n\n    // 2. Await params\n    const { id } = await params;\n    \n    // Get current guest information\n    const { data: currentGuest, error: currentGuestError } = await supabase\n      .from('guests')\n      .select('id, group_id, age_type')\n      .eq('email', user.email)\n      .single();\n    \n    if (currentGuestError || !currentGuest) {\n      return NextResponse.json(\n        { success: false, error: { code: 'GUEST_NOT_FOUND', message: 'Current guest not found' } },\n        { status: 404 }\n      );\n    }\n    \n    // Get target family member\n    const { data: targetMember, error: targetError } = await supabase\n      .from('guests')\n      .select('id, group_id')\n      .eq('id', id)\n      .single();\n    \n    if (targetError || !targetMember) {\n      return NextResponse.json(\n        { success: false, error: { code: 'GUEST_NOT_FOUND', message: 'Family member not found' } },\n        { status: 404 }\n      );\n    }\n    \n    // Check access control\n    const isAdult = currentGuest.age_type === 'adult';\n    const isSameGroup = currentGuest.group_id === targetMember.group_id;\n    const isSelf = currentGuest.id === id;\n    \n    // Adults can edit all family members in their group, children can only edit themselves\n    if (!isSameGroup || (!isAdult && !isSelf)) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'FORBIDDEN',\n            message: 'You do not have permission to edit this family member',\n          },\n        },\n        { status: 403 }\n      );\n    }\n    \n    // Parse and validate request body\n    const body = await request.json();\n    const validation = updateFamilyMemberSchema.safeParse(body);\n    \n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid request data',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n    \n    // Sanitize input\n    const sanitized: any = {};\n    if (validation.data.first_name !== undefined) {\n      sanitized.first_name = sanitizeInput(validation.data.first_name);\n    }\n    if (validation.data.last_name !== undefined) {\n      sanitized.last_name = sanitizeInput(validation.data.last_name);\n    }\n    if (validation.data.email !== undefined) {\n      sanitized.email = validation.data.email ? sanitizeInput(validation.data.email) : null;\n    }\n    if (validation.data.phone !== undefined) {\n      sanitized.phone = validation.data.phone ? sanitizeInput(validation.data.phone) : null;\n    }\n    if (validation.data.dietary_restrictions !== undefined) {\n      sanitized.dietary_restrictions = validation.data.dietary_restrictions\n        ? sanitizeInput(validation.data.dietary_restrictions)\n        : null;\n    }\n    \n    // Update family member\n    const { data: updated, error: updateError } = await supabase\n      .from('guests')\n      .update({\n        ...sanitized,\n        updated_at: new Date().toISOString(),\n      })\n      .eq('id', id)\n      .select()\n      .single();\n    \n    if (updateError) {\n      return NextResponse.json(\n        { success: false, error: { code: 'DATABASE_ERROR', message: updateError.message } },\n        { status: 500 }\n      );\n    }\n    \n    return NextResponse.json({ success: true, data: updated });\n  } catch (error) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'UNKNOWN_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}