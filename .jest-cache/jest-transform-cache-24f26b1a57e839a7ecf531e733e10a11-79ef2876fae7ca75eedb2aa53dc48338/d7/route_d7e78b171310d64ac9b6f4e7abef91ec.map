{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/guest/family/[id]/route.ts"],"sourcesContent":["import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\nimport { z } from 'zod';\nimport { sanitizeInput } from '@/utils/sanitization';\nimport { sendEmail } from '@/services/emailService';\n\n/**\n * Family Member Update API Route\n * \n * PUT: Update family member (group owner only)\n * \n * Requirements: 6.4, 6.5, 6.6, 6.7, 6.8, 6.12\n */\n\nconst updateFamilyMemberSchema = z.object({\n  first_name: z.string().min(1).max(50).optional(),\n  last_name: z.string().min(1).max(50).optional(),\n  email: z.string().email().optional(),\n  phone: z.string().max(20).optional(),\n  dietary_restrictions: z.string().max(500).optional(),\n});\n\n/**\n * PUT /api/guest/family/[id]\n * Update family member (group owner only)\n */\nexport async function PUT(\n  request: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const supabase = createRouteHandlerClient({ cookies });\n    \n    // Await params (Next.js 15+)\n    const { id } = await params;\n    \n    // Check authentication\n    const { data: { session }, error: authError } = await supabase.auth.getSession();\n    \n    if (authError || !session) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n    \n    // Get current guest\n    const { data: currentGuest, error: guestError } = await supabase\n      .from('guests')\n      .select('id, group_id, age_type')\n      .eq('email', session.user.email)\n      .single();\n    \n    if (guestError || !currentGuest) {\n      return NextResponse.json(\n        { success: false, error: { code: 'NOT_FOUND', message: 'Guest profile not found' } },\n        { status: 404 }\n      );\n    }\n    \n    // Get target family member\n    const { data: targetMember, error: targetError } = await supabase\n      .from('guests')\n      .select('*')\n      .eq('id', id)\n      .single();\n    \n    if (targetError || !targetMember) {\n      return NextResponse.json(\n        { success: false, error: { code: 'NOT_FOUND', message: 'Family member not found' } },\n        { status: 404 }\n      );\n    }\n    \n    // Check permissions: adults can edit all family members, children can only edit themselves\n    const canEdit = currentGuest.age_type === 'adult' \n      ? targetMember.group_id === currentGuest.group_id\n      : targetMember.id === currentGuest.id;\n    \n    if (!canEdit) {\n      return NextResponse.json(\n        { success: false, error: { code: 'FORBIDDEN', message: 'You do not have permission to edit this family member' } },\n        { status: 403 }\n      );\n    }\n    \n    // Parse and validate request body\n    const body = await request.json();\n    const validation = updateFamilyMemberSchema.safeParse(body);\n    \n    if (!validation.success) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: { \n            code: 'VALIDATION_ERROR', \n            message: 'Invalid request data', \n            details: validation.error.issues \n          } \n        },\n        { status: 400 }\n      );\n    }\n    \n    // Sanitize inputs\n    const sanitized: Record<string, any> = {};\n    if (validation.data.first_name) {\n      sanitized.first_name = sanitizeInput(validation.data.first_name);\n    }\n    if (validation.data.last_name) {\n      sanitized.last_name = sanitizeInput(validation.data.last_name);\n    }\n    if (validation.data.email) {\n      sanitized.email = sanitizeInput(validation.data.email);\n    }\n    if (validation.data.phone) {\n      sanitized.phone = sanitizeInput(validation.data.phone);\n    }\n    if (validation.data.dietary_restrictions !== undefined) {\n      sanitized.dietary_restrictions = validation.data.dietary_restrictions \n        ? sanitizeInput(validation.data.dietary_restrictions)\n        : null;\n    }\n    \n    // Update family member\n    const { data: updatedMember, error: updateError } = await supabase\n      .from('guests')\n      .update(sanitized)\n      .eq('id', id)\n      .select()\n      .single();\n    \n    if (updateError) {\n      return NextResponse.json(\n        { success: false, error: { code: 'DATABASE_ERROR', message: updateError.message } },\n        { status: 500 }\n      );\n    }\n    \n    // Send admin notification for critical updates\n    const criticalFields = ['email', 'dietary_restrictions'];\n    const hasCriticalUpdate = Object.keys(sanitized).some(key => criticalFields.includes(key));\n    \n    if (hasCriticalUpdate) {\n      try {\n        await sendEmail({\n          to: process.env.ADMIN_EMAIL || 'admin@example.com',\n          subject: 'Family Member Profile Update',\n          html: `\n            <h2>Family Member Profile Updated</h2>\n            <p><strong>Updated by:</strong> ${currentGuest.id === targetMember.id ? 'Self' : 'Group Owner'}</p>\n            <p><strong>Guest:</strong> ${updatedMember.first_name} ${updatedMember.last_name}</p>\n            <p><strong>Updated Fields:</strong></p>\n            <ul>\n              ${Object.keys(sanitized).map(key => `<li>${key}: ${sanitized[key]}</li>`).join('')}\n            </ul>\n          `\n        });\n      } catch (emailError) {\n        console.error('Failed to send admin notification:', emailError);\n        // Don't fail the request if email fails\n      }\n    }\n    \n    return NextResponse.json({\n      success: true,\n      data: updatedMember\n    });\n  } catch (error) {\n    console.error('Error updating family member:', error);\n    return NextResponse.json(\n      { success: false, error: { code: 'INTERNAL_ERROR', message: 'Failed to update family member' } },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * PATCH /api/guest/family/[id]\n * Alias for PUT to support partial updates\n */\nexport async function PATCH(\n  request: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  return PUT(request, { params });\n}\n"],"names":["PATCH","PUT","updateFamilyMemberSchema","z","object","first_name","string","min","max","optional","last_name","email","phone","dietary_restrictions","request","params","supabase","createRouteHandlerClient","cookies","id","data","session","error","authError","auth","getSession","NextResponse","json","success","code","message","status","currentGuest","guestError","from","select","eq","user","single","targetMember","targetError","canEdit","age_type","group_id","body","validation","safeParse","details","issues","sanitized","sanitizeInput","undefined","updatedMember","updateError","update","criticalFields","hasCriticalUpdate","Object","keys","some","key","includes","sendEmail","to","process","env","ADMIN_EMAIL","subject","html","map","join","emailError","console"],"mappings":"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"}