{"version":3,"names":["cov_20bozq0zfj","actualCoverage","s","POST","request","params","f","cookieStore","_headers","cookies","supabase","_ssr","createServerClient","process","env","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","getAll","setAll","cookiesToSet","forEach","name","value","set","data","session","error","authError","auth","getSession","b","_server","NextResponse","json","success","code","message","status","body","parentLocationId","resolvedParams","wouldCreateCycle","checkCircularReference","id","valid","locationId","newParentId","_supabasejs","createClient","SUPABASE_SERVICE_ROLE_KEY","from","select","parentMap","Map","location","parent_location_id","currentId","visited","Set","has","add","get"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/locations/[id]/validate-parent/route.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr';\nimport { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\n/**\n * POST /api/admin/locations/:id/validate-parent - Check circular refs\n */\nexport async function POST(\n  request: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  // 1. Auth check\n  const cookieStore = await cookies();\n    const supabase = createServerClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n      {\n        cookies: {\n          getAll() {\n            return cookieStore.getAll();\n          },\n          setAll(cookiesToSet) {\n            cookiesToSet.forEach(({ name, value }) => {\n              cookieStore.set(name, value);\n            });\n          },\n        },\n      }\n    );\n  const {\n    data: { session },\n    error: authError,\n  } = await supabase.auth.getSession();\n\n  if (authError || !session) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: { code: 'UNAUTHORIZED', message: 'Authentication required' },\n      },\n      { status: 401 }\n    );\n  }\n\n  // 2. Parse request body\n  const body = await request.json();\n  const { parentLocationId } = body;\n\n  if (!parentLocationId) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: { code: 'VALIDATION_ERROR', message: 'parentLocationId is required' },\n      },\n      { status: 400 }\n    );\n  }\n\n  // 3. Check for circular reference\n  const resolvedParams = await params;\n\n  const wouldCreateCycle = await checkCircularReference(resolvedParams.id, parentLocationId);\n\n  if (wouldCreateCycle) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'CIRCULAR_REFERENCE',\n          message: 'This would create a circular reference in the location hierarchy',\n        },\n      },\n      { status: 409 }\n    );\n  }\n\n  return NextResponse.json(\n    {\n      success: true,\n      data: { valid: true },\n    },\n    { status: 200 }\n  );\n}\n\n/**\n * Checks if setting a parent would create a circular reference.\n */\nasync function checkCircularReference(\n  locationId: string,\n  newParentId: string\n): Promise<boolean> {\n  // Prevent setting self as parent\n  if (locationId === newParentId) {\n    return true;\n  }\n\n  const supabase = createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\n  );\n\n  // Get all locations\n  const { data, error } = await supabase\n    .from('locations')\n    .select('id, parent_location_id');\n\n  if (error || !data) {\n    return false; // If we can't check, allow the operation\n  }\n\n  // Build parent map\n  const parentMap = new Map<string, string | null>();\n  data.forEach((location) => {\n    parentMap.set(location.id, location.parent_location_id);\n  });\n\n  // Walk up the tree from newParentId to see if we encounter locationId\n  let currentId: string | null = newParentId;\n  const visited = new Set<string>();\n\n  while (currentId) {\n    if (currentId === locationId) {\n      return true; // Circular reference detected\n    }\n    if (visited.has(currentId)) {\n      return true; // Already visited, circular reference exists\n    }\n    visited.add(currentId);\n    currentId = parentMap.get(currentId) || null;\n  }\n\n  return false; // No circular reference\n}\n"],"mappings":"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","ignoreList":[]}