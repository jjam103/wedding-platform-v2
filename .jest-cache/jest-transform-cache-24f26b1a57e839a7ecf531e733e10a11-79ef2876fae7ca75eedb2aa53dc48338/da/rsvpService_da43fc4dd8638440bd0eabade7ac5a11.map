{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/rsvpService.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { sanitizeInput } from '@/utils/sanitization';\nimport { \n  createRSVPSchema, \n  updateRSVPSchema, \n  listRSVPsSchema,\n  type CreateRSVPDTO,\n  type UpdateRSVPDTO,\n  type ListRSVPsDTO,\n} from '@/schemas/rsvpSchemas';\nimport type { Result, RSVP } from '@/types';\nimport { ERROR_CODES } from '@/types';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\nconst supabase = createClient(supabaseUrl, supabaseKey);\n\n/**\n * Creates a new RSVP for a guest to an event or activity.\n * \n * @param data - RSVP data including guest_id and either event_id or activity_id\n * @returns Result containing the created RSVP or error details\n * \n * Requirements: 6.1, 6.2, 6.3, 6.4\n * \n * @example\n * const result = await rsvpService.create({\n *   guest_id: '123e4567-e89b-12d3-a456-426614174000',\n *   event_id: '123e4567-e89b-12d3-a456-426614174001',\n *   status: 'attending',\n *   guest_count: 2,\n * });\n */\nexport async function create(data: CreateRSVPDTO): Promise<Result<RSVP>> {\n  try {\n    // 1. Validate\n    const validation = createRSVPSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize user input\n    const sanitized = {\n      ...validation.data,\n      dietary_notes: validation.data.dietary_notes \n        ? sanitizeInput(validation.data.dietary_notes) \n        : undefined,\n      special_requirements: validation.data.special_requirements \n        ? sanitizeInput(validation.data.special_requirements) \n        : undefined,\n      notes: validation.data.notes \n        ? sanitizeInput(validation.data.notes) \n        : undefined,\n    };\n\n    // Set responded_at if status is not pending\n    const rsvpData = {\n      ...sanitized,\n      responded_at: sanitized.status !== 'pending' ? new Date().toISOString() : undefined,\n    };\n\n    // 3. Database operation\n    const { data: result, error } = await supabase\n      .from('rsvps')\n      .insert(rsvpData)\n      .select()\n      .single();\n\n    if (error) {\n      // Check for unique constraint violation\n      if (error.code === '23505') {\n        return {\n          success: false,\n          error: {\n            code: ERROR_CODES.DUPLICATE_ENTRY,\n            message: 'RSVP already exists for this guest and event/activity',\n            details: error,\n          },\n        };\n      }\n\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: result };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Retrieves a single RSVP by ID.\n * \n * @param id - RSVP ID\n * @returns Result containing the RSVP or error details\n */\nexport async function get(id: string): Promise<Result<RSVP>> {\n  try {\n    const { data, error } = await supabase\n      .from('rsvps')\n      .select('*')\n      .eq('id', id)\n      .single();\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        return {\n          success: false,\n          error: {\n            code: ERROR_CODES.NOT_FOUND,\n            message: 'RSVP not found',\n            details: error,\n          },\n        };\n      }\n\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Updates an existing RSVP.\n * \n * @param id - RSVP ID\n * @param data - Updated RSVP data\n * @returns Result containing the updated RSVP or error details\n * \n * Requirements: 6.3, 6.4\n */\nexport async function update(id: string, data: UpdateRSVPDTO): Promise<Result<RSVP>> {\n  try {\n    // 1. Validate\n    const validation = updateRSVPSchema.safeParse(data);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Validation failed',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize user input\n    const sanitized = {\n      ...validation.data,\n      dietary_notes: validation.data.dietary_notes \n        ? sanitizeInput(validation.data.dietary_notes) \n        : undefined,\n      special_requirements: validation.data.special_requirements \n        ? sanitizeInput(validation.data.special_requirements) \n        : undefined,\n      notes: validation.data.notes \n        ? sanitizeInput(validation.data.notes) \n        : undefined,\n    };\n\n    // Set responded_at if status is being changed from pending\n    const updateData: any = { ...sanitized };\n    if (sanitized.status && sanitized.status !== 'pending') {\n      updateData.responded_at = new Date().toISOString();\n    }\n\n    // 3. Database operation\n    const { data: result, error } = await supabase\n      .from('rsvps')\n      .update(updateData)\n      .eq('id', id)\n      .select()\n      .single();\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        return {\n          success: false,\n          error: {\n            code: ERROR_CODES.NOT_FOUND,\n            message: 'RSVP not found',\n            details: error,\n          },\n        };\n      }\n\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: result };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Deletes an RSVP by ID.\n * \n * @param id - RSVP ID\n * @returns Result indicating success or error details\n */\nexport async function deleteRSVP(id: string): Promise<Result<void>> {\n  try {\n    const { error } = await supabase\n      .from('rsvps')\n      .delete()\n      .eq('id', id);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Lists RSVPs with optional filtering and pagination.\n * \n * @param filters - Filter criteria including guest_id, event_id, activity_id, status\n * @returns Result containing array of RSVPs or error details\n * \n * Requirements: 6.1, 6.2\n */\nexport async function list(filters: Partial<ListRSVPsDTO> = { page: 1, page_size: 50 }): Promise<Result<{ rsvps: RSVP[]; total: number }>> {\n  try {\n    // Validate filters\n    const filtersWithDefaults = { page: 1, page_size: 50, ...filters };\n    const validation = listRSVPsSchema.safeParse(filtersWithDefaults);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Invalid filter parameters',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    const { guest_id, event_id, activity_id, status, page, page_size } = validation.data;\n\n    // Build query\n    let query = supabase.from('rsvps').select('*', { count: 'exact' });\n\n    if (guest_id) {\n      query = query.eq('guest_id', guest_id);\n    }\n    if (event_id) {\n      query = query.eq('event_id', event_id);\n    }\n    if (activity_id) {\n      query = query.eq('activity_id', activity_id);\n    }\n    if (status) {\n      query = query.eq('status', status);\n    }\n\n    // Apply pagination\n    const from = (page - 1) * page_size;\n    const to = from + page_size - 1;\n    query = query.range(from, to);\n\n    // Order by created_at descending\n    query = query.order('created_at', { ascending: false });\n\n    const { data, error, count } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return {\n      success: true,\n      data: {\n        rsvps: data || [],\n        total: count || 0,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Gets all RSVPs for a specific guest.\n * \n * @param guestId - Guest ID\n * @returns Result containing array of RSVPs or error details\n */\nexport async function getByGuest(guestId: string): Promise<Result<RSVP[]>> {\n  const result = await list({ guest_id: guestId, page: 1, page_size: 100 });\n  \n  if (!result.success) {\n    return result;\n  }\n\n  return {\n    success: true,\n    data: result.data.rsvps,\n  };\n}\n\n/**\n * Gets all RSVPs for a specific event.\n * \n * @param eventId - Event ID\n * @returns Result containing array of RSVPs or error details\n */\nexport async function getByEvent(eventId: string): Promise<Result<RSVP[]>> {\n  const result = await list({ event_id: eventId, page: 1, page_size: 1000 });\n  \n  if (!result.success) {\n    return result;\n  }\n\n  return {\n    success: true,\n    data: result.data.rsvps,\n  };\n}\n\n/**\n * Gets all RSVPs for a specific activity.\n * \n * @param activityId - Activity ID\n * @returns Result containing array of RSVPs or error details\n */\nexport async function getByActivity(activityId: string): Promise<Result<RSVP[]>> {\n  const result = await list({ activity_id: activityId, page: 1, page_size: 1000 });\n  \n  if (!result.success) {\n    return result;\n  }\n\n  return {\n    success: true,\n    data: result.data.rsvps,\n  };\n}\n\n/**\n * Capacity alert information for an activity.\n * Requirements: 6.5, 6.7\n */\nexport interface CapacityAlert {\n  activity_id: string;\n  activity_name: string;\n  capacity: number;\n  attending_count: number;\n  utilization_percentage: number;\n  alert_level: 'warning' | 'critical' | 'full';\n  message: string;\n}\n\n/**\n * Calculates the current capacity utilization for an activity.\n * \n * @param activityId - Activity ID\n * @returns Result containing capacity information or error details\n * \n * Requirements: 6.5\n */\nexport async function calculateActivityCapacity(\n  activityId: string\n): Promise<Result<{ capacity: number | null; attending_count: number; available: number | null }>> {\n  try {\n    // Get activity capacity\n    const { data: activity, error: activityError } = await supabase\n      .from('activities')\n      .select('capacity, name')\n      .eq('id', activityId)\n      .single();\n\n    if (activityError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: activityError.message,\n          details: activityError,\n        },\n      };\n    }\n\n    // Count attending RSVPs\n    const { data: rsvps, error: rsvpError } = await supabase\n      .from('rsvps')\n      .select('guest_count')\n      .eq('activity_id', activityId)\n      .eq('status', 'attending');\n\n    if (rsvpError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: rsvpError.message,\n          details: rsvpError,\n        },\n      };\n    }\n\n    // Calculate total attending count\n    const attending_count = rsvps.reduce((sum, rsvp) => sum + (rsvp.guest_count || 1), 0);\n\n    // Calculate available capacity\n    const available = activity.capacity !== null ? activity.capacity - attending_count : null;\n\n    return {\n      success: true,\n      data: {\n        capacity: activity.capacity,\n        attending_count,\n        available,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Generates capacity alerts for activities that are approaching or at capacity.\n * \n * @param threshold - Percentage threshold for warning (default: 0.9 for 90%)\n * @returns Result containing array of capacity alerts or error details\n * \n * Requirements: 6.5, 6.7\n */\nexport async function generateCapacityAlerts(\n  threshold: number = 0.9\n): Promise<Result<CapacityAlert[]>> {\n  try {\n    // Get all activities with capacity limits\n    const { data: activities, error: activitiesError } = await supabase\n      .from('activities')\n      .select('id, name, capacity')\n      .not('capacity', 'is', null)\n      .eq('status', 'published');\n\n    if (activitiesError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: activitiesError.message,\n          details: activitiesError,\n        },\n      };\n    }\n\n    const alerts: CapacityAlert[] = [];\n\n    // Check capacity for each activity\n    for (const activity of activities) {\n      const capacityResult = await calculateActivityCapacity(activity.id);\n\n      if (!capacityResult.success) {\n        continue; // Skip activities with errors\n      }\n\n      const { capacity, attending_count } = capacityResult.data;\n\n      if (capacity === null) {\n        continue; // Skip activities without capacity limits\n      }\n\n      const utilization = attending_count / capacity;\n\n      // Generate alert if threshold is met or exceeded\n      if (utilization >= threshold) {\n        let alert_level: 'warning' | 'critical' | 'full';\n        let message: string;\n\n        if (attending_count >= capacity) {\n          alert_level = 'full';\n          message = `Activity \"${activity.name}\" is at full capacity (${attending_count}/${capacity})`;\n        } else if (utilization >= 0.95) {\n          alert_level = 'critical';\n          message = `Activity \"${activity.name}\" is critically full (${attending_count}/${capacity}, ${Math.round(utilization * 100)}%)`;\n        } else {\n          alert_level = 'warning';\n          message = `Activity \"${activity.name}\" is approaching capacity (${attending_count}/${capacity}, ${Math.round(utilization * 100)}%)`;\n        }\n\n        alerts.push({\n          activity_id: activity.id,\n          activity_name: activity.name,\n          capacity,\n          attending_count,\n          utilization_percentage: Math.round(utilization * 100),\n          alert_level,\n          message,\n        });\n      }\n    }\n\n    return {\n      success: true,\n      data: alerts,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Checks if an activity has available capacity for additional guests.\n * \n * @param activityId - Activity ID\n * @param additionalGuests - Number of additional guests (default: 1)\n * @returns Result indicating if capacity is available or error details\n * \n * Requirements: 6.7\n */\nexport async function checkCapacityAvailable(\n  activityId: string,\n  additionalGuests: number = 1\n): Promise<Result<{ available: boolean; message: string }>> {\n  try {\n    const capacityResult = await calculateActivityCapacity(activityId);\n\n    if (!capacityResult.success) {\n      return capacityResult;\n    }\n\n    const { capacity, attending_count, available } = capacityResult.data;\n\n    // If no capacity limit, always available\n    if (capacity === null) {\n      return {\n        success: true,\n        data: {\n          available: true,\n          message: 'No capacity limit set for this activity',\n        },\n      };\n    }\n\n    // Check if additional guests would exceed capacity\n    if (available !== null && available >= additionalGuests) {\n      return {\n        success: true,\n        data: {\n          available: true,\n          message: `Capacity available: ${available} spots remaining`,\n        },\n      };\n    }\n\n    return {\n      success: true,\n      data: {\n        available: false,\n        message: `Capacity exceeded: ${attending_count}/${capacity} attending, cannot add ${additionalGuests} more guest(s)`,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Enforces capacity limits when creating or updating an RSVP.\n * Returns an error if the RSVP would exceed activity capacity.\n * \n * @param activityId - Activity ID\n * @param guestCount - Number of guests for the RSVP\n * @param existingRsvpId - ID of existing RSVP if updating (to exclude from count)\n * @returns Result indicating if capacity check passed or error details\n * \n * Requirements: 6.7\n */\nexport async function enforceCapacityLimit(\n  activityId: string,\n  guestCount: number,\n  existingRsvpId?: string\n): Promise<Result<void>> {\n  try {\n    const capacityResult = await calculateActivityCapacity(activityId);\n\n    if (!capacityResult.success) {\n      return capacityResult;\n    }\n\n    const { capacity, attending_count } = capacityResult.data;\n\n    // If no capacity limit, allow\n    if (capacity === null) {\n      return { success: true, data: undefined };\n    }\n\n    // If updating existing RSVP, get current guest count to subtract\n    let currentGuestCount = 0;\n    if (existingRsvpId) {\n      const { data: existingRsvp, error } = await supabase\n        .from('rsvps')\n        .select('guest_count, status')\n        .eq('id', existingRsvpId)\n        .single();\n\n      if (!error && existingRsvp && existingRsvp.status === 'attending') {\n        currentGuestCount = existingRsvp.guest_count || 1;\n      }\n    }\n\n    // Calculate new total\n    const newTotal = attending_count - currentGuestCount + guestCount;\n\n    if (newTotal > capacity) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.CAPACITY_EXCEEDED,\n          message: `Activity capacity exceeded: ${newTotal}/${capacity}`,\n          details: {\n            capacity,\n            current_attending: attending_count,\n            requested_guests: guestCount,\n            available: capacity - attending_count + currentGuestCount,\n          },\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n"],"names":["calculateActivityCapacity","checkCapacityAvailable","create","deleteRSVP","enforceCapacityLimit","generateCapacityAlerts","get","getByActivity","getByEvent","getByGuest","list","update","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","supabaseKey","NEXT_PUBLIC_SUPABASE_ANON_KEY","supabase","createClient","data","validation","createRSVPSchema","safeParse","success","error","code","ERROR_CODES","VALIDATION_ERROR","message","details","issues","sanitized","dietary_notes","sanitizeInput","undefined","special_requirements","notes","rsvpData","responded_at","status","Date","toISOString","result","from","insert","select","single","DUPLICATE_ENTRY","DATABASE_ERROR","UNKNOWN_ERROR","Error","id","eq","NOT_FOUND","updateRSVPSchema","updateData","delete","filters","page","page_size","filtersWithDefaults","listRSVPsSchema","guest_id","event_id","activity_id","query","count","to","range","order","ascending","rsvps","total","guestId","eventId","activityId","activity","activityError","rsvpError","attending_count","reduce","sum","rsvp","guest_count","available","capacity","threshold","activities","activitiesError","not","alerts","capacityResult","utilization","alert_level","name","Math","round","push","activity_name","utilization_percentage","additionalGuests","guestCount","existingRsvpId","currentGuestCount","existingRsvp","newTotal","CAPACITY_EXCEEDED","current_attending","requested_guests"],"mappings":"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"}