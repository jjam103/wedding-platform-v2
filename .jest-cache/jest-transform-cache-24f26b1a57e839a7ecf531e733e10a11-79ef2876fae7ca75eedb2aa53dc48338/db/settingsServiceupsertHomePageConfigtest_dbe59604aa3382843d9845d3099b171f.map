{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/settingsService.upsertHomePageConfig.test.ts"],"sourcesContent":["import { upsertSetting, upsertHomePageConfig } from './settingsService';\nimport type { HomePageConfig } from '../schemas/settingsSchemas';\n\n// Mock the supabase module\njest.mock('../lib/supabase', () => ({\n  supabase: {\n    from: jest.fn(),\n  },\n}));\n\ndescribe('settingsService.upsertSetting', () => {\n  let mockSupabase: any;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    const { supabase } = require('../lib/supabase');\n    mockSupabase = supabase;\n  });\n\n  it('should successfully upsert a setting', async () => {\n    const mockSetting = {\n      id: 'setting-1',\n      key: 'test_key',\n      value: 'test_value',\n      description: 'Test setting',\n      category: 'general',\n      is_public: false,\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n    };\n\n    mockSupabase.from.mockReturnValue({\n      upsert: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: mockSetting,\n            error: null,\n          }),\n        }),\n      }),\n    });\n\n    const result = await upsertSetting('test_key', 'test_value', 'Test setting', 'general', false);\n\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.data.key).toBe('test_key');\n      expect(result.data.value).toBe('test_value');\n    }\n    expect(mockSupabase.from).toHaveBeenCalledWith('system_settings');\n  });\n\n  it('should return DATABASE_ERROR when upsert fails', async () => {\n    mockSupabase.from.mockReturnValue({\n      upsert: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: null,\n            error: { message: 'Database connection failed', code: 'CONNECTION_ERROR' },\n          }),\n        }),\n      }),\n    });\n\n    const result = await upsertSetting('test_key', 'test_value');\n\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error.code).toBe('DATABASE_ERROR');\n      expect(result.error.message).toBe('Database connection failed');\n    }\n  });\n\n  it('should handle unexpected errors', async () => {\n    mockSupabase.from.mockImplementation(() => {\n      throw new Error('Unexpected error');\n    });\n\n    const result = await upsertSetting('test_key', 'test_value');\n\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error.code).toBe('UNKNOWN_ERROR');\n      expect(result.error.message).toBe('Unexpected error');\n    }\n  });\n});\n\ndescribe('settingsService.upsertHomePageConfig', () => {\n  let mockSupabase: any;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    const { supabase } = require('../lib/supabase');\n    mockSupabase = supabase;\n  });\n\n  it('should successfully upsert home page configuration', async () => {\n    const config: HomePageConfig = {\n      title: 'Welcome to Our Wedding',\n      subtitle: 'Join us in Costa Rica',\n      welcomeMessage: '<p>We are excited to celebrate with you!</p>',\n      heroImageUrl: 'https://example.com/hero.jpg',\n    };\n\n    const mockSetting = {\n      id: 'setting-1',\n      key: 'home_page_title',\n      value: config.title,\n      description: 'Home page title',\n      category: 'home_page',\n      is_public: true,\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n    };\n\n    mockSupabase.from.mockReturnValue({\n      upsert: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: mockSetting,\n            error: null,\n          }),\n        }),\n      }),\n    });\n\n    const result = await upsertHomePageConfig(config);\n\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.data.title).toBe(config.title);\n      expect(result.data.subtitle).toBe(config.subtitle);\n      expect(result.data.welcomeMessage).toBe(config.welcomeMessage);\n      expect(result.data.heroImageUrl).toBe(config.heroImageUrl);\n    }\n    // Should call upsert 4 times (once for each setting)\n    expect(mockSupabase.from).toHaveBeenCalledTimes(4);\n  });\n\n  it('should successfully upsert partial home page configuration', async () => {\n    const config: HomePageConfig = {\n      title: 'New Title',\n    };\n\n    const mockSetting = {\n      id: 'setting-1',\n      key: 'home_page_title',\n      value: config.title,\n      description: 'Home page title',\n      category: 'home_page',\n      is_public: true,\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n    };\n\n    mockSupabase.from.mockReturnValue({\n      upsert: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: mockSetting,\n            error: null,\n          }),\n        }),\n      }),\n    });\n\n    const result = await upsertHomePageConfig(config);\n\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.data.title).toBe(config.title);\n    }\n    // Should only call upsert once (only title provided)\n    expect(mockSupabase.from).toHaveBeenCalledTimes(1);\n  });\n\n  it('should return VALIDATION_ERROR for invalid configuration', async () => {\n    const invalidConfig = {\n      title: '', // Empty string should fail min(1) validation\n      heroImageUrl: 'not-a-valid-url', // Invalid URL\n    } as HomePageConfig;\n\n    const result = await upsertHomePageConfig(invalidConfig);\n\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error.code).toBe('VALIDATION_ERROR');\n      expect(result.error.message).toBe('Invalid home page configuration');\n      expect(result.error.details).toBeDefined();\n    }\n  });\n\n  it('should return DATABASE_ERROR when one setting fails to upsert', async () => {\n    const config: HomePageConfig = {\n      title: 'Welcome',\n      subtitle: 'Join us',\n    };\n\n    let callCount = 0;\n    mockSupabase.from.mockReturnValue({\n      upsert: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockImplementation(() => {\n            callCount++;\n            if (callCount === 1) {\n              // First call succeeds\n              return Promise.resolve({\n                data: {\n                  id: 'setting-1',\n                  key: 'home_page_title',\n                  value: config.title,\n                  description: 'Home page title',\n                  category: 'home_page',\n                  is_public: true,\n                  created_at: new Date().toISOString(),\n                  updated_at: new Date().toISOString(),\n                },\n                error: null,\n              });\n            } else {\n              // Second call fails\n              return Promise.resolve({\n                data: null,\n                error: { message: 'Database error', code: 'DB_ERROR' },\n              });\n            }\n          }),\n        }),\n      }),\n    });\n\n    const result = await upsertHomePageConfig(config);\n\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error.code).toBe('DATABASE_ERROR');\n      expect(result.error.message).toBe('Failed to update some home page settings');\n    }\n  });\n\n  it('should handle null values correctly', async () => {\n    const config: HomePageConfig = {\n      title: null,\n      subtitle: null,\n      welcomeMessage: null,\n      heroImageUrl: null,\n    };\n\n    const mockSetting = {\n      id: 'setting-1',\n      key: 'home_page_title',\n      value: null,\n      description: 'Home page title',\n      category: 'home_page',\n      is_public: true,\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n    };\n\n    mockSupabase.from.mockReturnValue({\n      upsert: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: mockSetting,\n            error: null,\n          }),\n        }),\n      }),\n    });\n\n    const result = await upsertHomePageConfig(config);\n\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.data.title).toBeNull();\n      expect(result.data.subtitle).toBeNull();\n      expect(result.data.welcomeMessage).toBeNull();\n      expect(result.data.heroImageUrl).toBeNull();\n    }\n  });\n\n  it('should handle unexpected errors', async () => {\n    const config: HomePageConfig = {\n      title: 'Test',\n    };\n\n    mockSupabase.from.mockReturnValue({\n      upsert: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockImplementation(() => {\n            throw new Error('Unexpected database error');\n          }),\n        }),\n      }),\n    });\n\n    const result = await upsertHomePageConfig(config);\n\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error.code).toBe('DATABASE_ERROR');\n      expect(result.error.message).toBe('Failed to update some home page settings');\n    }\n  });\n});\n"],"names":["jest","mock","supabase","from","fn","describe","mockSupabase","beforeEach","clearAllMocks","require","it","mockSetting","id","key","value","description","category","is_public","created_at","Date","toISOString","updated_at","mockReturnValue","upsert","select","single","mockResolvedValue","data","error","result","upsertSetting","expect","success","toBe","toHaveBeenCalledWith","message","code","mockImplementation","Error","config","title","subtitle","welcomeMessage","heroImageUrl","upsertHomePageConfig","toHaveBeenCalledTimes","invalidConfig","details","toBeDefined","callCount","Promise","resolve","toBeNull"],"mappings":"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"}