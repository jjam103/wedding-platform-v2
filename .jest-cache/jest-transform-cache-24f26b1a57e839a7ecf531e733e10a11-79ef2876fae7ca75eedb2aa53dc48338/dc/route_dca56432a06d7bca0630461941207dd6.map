{"version":3,"names":["GET","verifyTokenSchema","cov_1myrl6j5gg","s","_zod","z","object","token","string","min","max","request","f","searchParams","URL","url","get","validation","safeParse","success","b","_server","NextResponse","json","error","code","message","details","issues","status","supabase","_supabase","createSupabaseClient","data","tokenRecord","tokenError","from","select","eq","single","used","now","Date","expiresAt","expires_at","updateError","update","used_at","toISOString","id","console","sessionToken","Array","crypto","getRandomValues","Uint8Array","map","toString","padStart","join","sessionExpiresAt","session","sessionError","insert","guest_id","ip_address","headers","user_agent","cookieStore","_headers","cookies","set","httpOnly","secure","process","env","NODE_ENV","sameSite","maxAge","path","action","entity_type","entity_id","auth_method","email","guests","guest","guestId","groupId","group_id","firstName","first_name","lastName","last_name","Error"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/auth/guest/magic-link/verify/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { cookies } from 'next/headers';\nimport { createSupabaseClient } from '@/lib/supabase';\nimport { z } from 'zod';\n\n/**\n * Magic Link Verification API Route\n * \n * Verifies a magic link token, marks it as used, creates a guest session,\n * and sets an HTTP-only session cookie.\n * \n * Requirements: 5.3, 5.9\n * Task: 6.2\n */\n\nconst verifyTokenSchema = z.object({\n  token: z.string().min(64).max(64), // 32 bytes = 64 hex characters\n});\n\n/**\n * GET /api/auth/guest/magic-link/verify?token=...\n * \n * Verifies a magic link token and creates a guest session.\n * \n * @param request - Request containing token in query params\n * @returns Success response with guest data, or error response\n */\nexport async function GET(request: Request) {\n  try {\n    // 1. Parse and validate query parameters\n    const { searchParams } = new URL(request.url);\n    const token = searchParams.get('token');\n    \n    const validation = verifyTokenSchema.safeParse({ token });\n    \n    if (!validation.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid token format',\n            details: validation.error.issues,\n          },\n        },\n        { status: 400 }\n      );\n    }\n    \n    // 2. Create Supabase client\n    const supabase = createSupabaseClient();\n    \n    // 3. Find token in database\n    const { data: tokenRecord, error: tokenError } = await supabase\n      .from('magic_link_tokens')\n      .select('id, guest_id, token, expires_at, used, guests(id, email, first_name, last_name, group_id)')\n      .eq('token', validation.data.token)\n      .single();\n    \n    if (tokenError || !tokenRecord) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'NOT_FOUND',\n            message: 'Invalid or expired magic link',\n          },\n        },\n        { status: 404 }\n      );\n    }\n    \n    // 4. Check if token has already been used\n    if (tokenRecord.used) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'TOKEN_USED',\n            message: 'This magic link has already been used',\n          },\n        },\n        { status: 409 }\n      );\n    }\n    \n    // 5. Check if token has expired\n    const now = new Date();\n    const expiresAt = new Date(tokenRecord.expires_at);\n    \n    if (now > expiresAt) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'TOKEN_EXPIRED',\n            message: 'This magic link has expired',\n          },\n        },\n        { status: 410 }\n      );\n    }\n    \n    // 6. Mark token as used\n    const { error: updateError } = await supabase\n      .from('magic_link_tokens')\n      .update({ \n        used: true,\n        used_at: now.toISOString(),\n      })\n      .eq('id', tokenRecord.id);\n    \n    if (updateError) {\n      console.error('Failed to mark token as used:', updateError);\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'TOKEN_ERROR',\n            message: 'Failed to verify magic link',\n          },\n        },\n        { status: 500 }\n      );\n    }\n    \n    // 7. Generate session token (32 bytes)\n    const sessionToken = Array.from(crypto.getRandomValues(new Uint8Array(32)))\n      .map(b => b.toString(16).padStart(2, '0'))\n      .join('');\n    \n    // 8. Create session record in database\n    const sessionExpiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours\n    \n    const { data: session, error: sessionError } = await supabase\n      .from('guest_sessions')\n      .insert({\n        guest_id: tokenRecord.guest_id,\n        token: sessionToken,\n        expires_at: sessionExpiresAt.toISOString(),\n        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || 'unknown',\n        user_agent: request.headers.get('user-agent') || 'unknown',\n      })\n      .select()\n      .single();\n    \n    if (sessionError || !session) {\n      console.error('Failed to create guest session:', sessionError);\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            code: 'SESSION_ERROR',\n            message: 'Failed to create session',\n          },\n        },\n        { status: 500 }\n      );\n    }\n    \n    // 9. Set HTTP-only session cookie\n    const cookieStore = await cookies();\n    cookieStore.set('guest_session', sessionToken, {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === 'production',\n      sameSite: 'lax',\n      maxAge: 60 * 60 * 24, // 24 hours\n      path: '/',\n    });\n    \n    // 10. Log authentication event\n    await supabase.from('audit_logs').insert({\n      action: 'guest_login',\n      entity_type: 'guest',\n      entity_id: tokenRecord.guest_id,\n      details: {\n        auth_method: 'magic_link',\n        email: (tokenRecord.guests as any).email,\n        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || 'unknown',\n      },\n    });\n    \n    // 11. Return success response\n    const guest = tokenRecord.guests as any;\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          guestId: guest.id,\n          groupId: guest.group_id,\n          firstName: guest.first_name,\n          lastName: guest.last_name,\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('Magic link verification error:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: {\n          code: 'UNKNOWN_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error occurred',\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}