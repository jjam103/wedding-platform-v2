{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/admin/activities/page.guestView.test.tsx"],"sourcesContent":["/**\n * Guest View Navigation Tests for Activities\n * \n * Tests the \"View as Guest\" functionality for activities.\n * Requirements: 32.3\n */\n\nimport { render, screen, fireEvent, waitFor } from '@testing-library/react';\nimport ActivitiesPage from './page';\nimport { useToast } from '@/components/ui/ToastContext';\nimport { useRouter } from 'next/navigation';\n\n// Mock dependencies\njest.mock('@/components/ui/ToastContext');\njest.mock('next/navigation', () => ({\n  useRouter: jest.fn(),\n  useSearchParams: () => ({\n    get: jest.fn(),\n    getAll: jest.fn(),\n    has: jest.fn(),\n    keys: jest.fn(),\n    values: jest.fn(),\n    entries: jest.fn(),\n    forEach: jest.fn(),\n    toString: jest.fn(),\n  }),\n  usePathname: () => '/admin/activities',\n}));\n\n// Mock fetch\nglobal.fetch = jest.fn();\n\n// Mock window.location\ndelete (window as any).location;\nwindow.location = { href: '' } as any;\n\nconst mockUseToast = useToast as jest.MockedFunction<typeof useToast>;\nconst mockUseRouter = useRouter as jest.MockedFunction<typeof useRouter>;\n\ndescribe('ActivitiesPage - Guest View Navigation', () => {\n  const mockAddToast = jest.fn();\n  const mockPush = jest.fn();\n\n  const mockActivities = [\n    {\n      id: 'activity-1',\n      name: 'Beach Day',\n      activityType: 'activity',\n      startTime: '2025-06-16T10:00:00Z',\n      endTime: '2025-06-16T16:00:00Z',\n      status: 'published',\n      capacity: 50,\n      currentRsvps: 45,\n      utilizationPercentage: 90,\n      eventId: 'event-1',\n      locationId: 'loc-1',\n      description: 'Beach activities',\n      costPerPerson: 50,\n      hostSubsidy: 10,\n      adultsOnly: false,\n      plusOneAllowed: true,\n    },\n    {\n      id: 'activity-2',\n      name: 'Zip Line Adventure',\n      activityType: 'activity',\n      startTime: '2025-06-17T09:00:00Z',\n      endTime: '2025-06-17T12:00:00Z',\n      status: 'published',\n      capacity: 20,\n      currentRsvps: 20,\n      utilizationPercentage: 100,\n      eventId: null,\n      locationId: 'loc-2',\n      description: 'Zip line tour',\n      costPerPerson: 75,\n      hostSubsidy: 0,\n      adultsOnly: true,\n      plusOneAllowed: false,\n    },\n  ];\n\n  const mockEvents = [\n    { id: 'event-1', name: 'Main Event' },\n  ];\n\n  const mockLocations = [\n    { id: 'loc-1', name: 'Beach' },\n    { id: 'loc-2', name: 'Adventure Park' },\n  ];\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    \n    mockUseToast.mockReturnValue({\n      addToast: mockAddToast,\n      toasts: [],\n      removeToast: jest.fn(),\n    });\n\n    mockUseRouter.mockReturnValue({\n      push: mockPush,\n      replace: jest.fn(),\n      refresh: jest.fn(),\n      back: jest.fn(),\n      forward: jest.fn(),\n      prefetch: jest.fn(),\n    } as any);\n\n    // Mock fetch responses\n    (global.fetch as jest.Mock).mockImplementation((url: string) => {\n      if (url.includes('/api/admin/activities') && !url.includes('/capacity')) {\n        return Promise.resolve({\n          ok: true,\n          json: () => Promise.resolve({\n            success: true,\n            data: { activities: mockActivities },\n          }),\n        });\n      }\n      if (url.includes('/capacity')) {\n        const activityId = url.split('/')[4];\n        const activity = mockActivities.find(a => a.id === activityId);\n        return Promise.resolve({\n          ok: true,\n          json: () => Promise.resolve({\n            success: true,\n            data: {\n              currentAttendees: activity?.currentRsvps || 0,\n              utilizationPercentage: activity?.utilizationPercentage || 0,\n            },\n          }),\n        });\n      }\n      if (url.includes('/api/admin/events')) {\n        return Promise.resolve({\n          ok: true,\n          json: () => Promise.resolve({\n            success: true,\n            data: { events: mockEvents },\n          }),\n        });\n      }\n      if (url.includes('/api/admin/locations')) {\n        return Promise.resolve({\n          ok: true,\n          json: () => Promise.resolve({\n            success: true,\n            data: mockLocations,\n          }),\n        });\n      }\n      return Promise.reject(new Error('Unknown URL'));\n    });\n  });\n\n  describe('View Button', () => {\n    it('should render View button for each activity', async () => {\n      render(<ActivitiesPage />);\n\n      await waitFor(() => {\n        // Check that activities are loaded\n        expect(screen.getAllByText('Beach Day').length).toBeGreaterThan(0);\n        expect(screen.getAllByText('Zip Line Adventure').length).toBeGreaterThan(0);\n      });\n\n      // Check that View buttons exist (may be more than 2 due to responsive design)\n      const viewButtons = screen.getAllByRole('button', { name: /^view$/i });\n      expect(viewButtons.length).toBeGreaterThan(0);\n    });\n\n    it('should navigate to guest-facing activity page when View button is clicked', async () => {\n      render(<ActivitiesPage />);\n\n      await waitFor(() => {\n        expect(screen.getAllByText('Beach Day').length).toBeGreaterThan(0);\n      });\n\n      const viewButtons = screen.getAllByRole('button', { name: /^view$/i });\n      fireEvent.click(viewButtons[0]);\n\n      expect(window.location.href).toBe('/guest/activities/activity-1');\n    });\n\n    it('should generate correct URL for each activity ID', async () => {\n      render(<ActivitiesPage />);\n\n      await waitFor(() => {\n        expect(screen.getAllByText('Beach Day').length).toBeGreaterThan(0);\n      });\n\n      // Test first activity\n      const viewButtons = screen.getAllByRole('button', { name: /^view$/i });\n      fireEvent.click(viewButtons[0]);\n      expect(window.location.href).toBe('/guest/activities/activity-1');\n\n      // Reset location\n      window.location.href = '';\n\n      // Test that we can navigate to a different activity\n      // (exact index depends on button layout, so just verify we can click another button)\n      if (viewButtons.length > 1) {\n        fireEvent.click(viewButtons[viewButtons.length > 2 ? 2 : 1]);\n        expect(window.location.href).toContain('/guest/activities/');\n      }\n    });\n\n    it('should not propagate click event to row', async () => {\n      render(<ActivitiesPage />);\n\n      await waitFor(() => {\n        expect(screen.getAllByText('Beach Day').length).toBeGreaterThan(0);\n      });\n\n      const viewButtons = screen.getAllByRole('button', { name: /^view$/i });\n      const clickEvent = new MouseEvent('click', { bubbles: true });\n      const stopPropagationSpy = jest.spyOn(clickEvent, 'stopPropagation');\n      \n      viewButtons[0].dispatchEvent(clickEvent);\n\n      expect(stopPropagationSpy).toHaveBeenCalled();\n    });\n  });\n\n  describe('Link Generation', () => {\n    it('should generate URL with /guest/activities/ prefix', async () => {\n      render(<ActivitiesPage />);\n\n      await waitFor(() => {\n        expect(screen.getAllByText('Beach Day').length).toBeGreaterThan(0);\n      });\n\n      const viewButtons = screen.getAllByRole('button', { name: /^view$/i });\n      fireEvent.click(viewButtons[0]);\n\n      expect(window.location.href).toMatch(/^\\/guest\\/activities\\//);\n    });\n\n    it('should use activity ID in URL', async () => {\n      render(<ActivitiesPage />);\n\n      await waitFor(() => {\n        expect(screen.getAllByText('Beach Day').length).toBeGreaterThan(0);\n      });\n\n      const viewButtons = screen.getAllByRole('button', { name: /^view$/i });\n      fireEvent.click(viewButtons[0]);\n\n      expect(window.location.href).toContain('activity-1');\n    });\n  });\n});\n"],"names":["jest","mock","useRouter","fn","useSearchParams","get","getAll","has","keys","values","entries","forEach","toString","usePathname","global","fetch","window","location","href","mockUseToast","useToast","mockUseRouter","describe","mockAddToast","mockPush","mockActivities","id","name","activityType","startTime","endTime","status","capacity","currentRsvps","utilizationPercentage","eventId","locationId","description","costPerPerson","hostSubsidy","adultsOnly","plusOneAllowed","mockEvents","mockLocations","beforeEach","clearAllMocks","mockReturnValue","addToast","toasts","removeToast","push","replace","refresh","back","forward","prefetch","mockImplementation","url","includes","Promise","resolve","ok","json","success","data","activities","activityId","split","activity","find","a","currentAttendees","events","reject","Error","it","render","ActivitiesPage","waitFor","expect","screen","getAllByText","length","toBeGreaterThan","viewButtons","getAllByRole","fireEvent","click","toBe","toContain","clickEvent","MouseEvent","bubbles","stopPropagationSpy","spyOn","dispatchEvent","toHaveBeenCalled","toMatch"],"mappings":"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"}