{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/helpers/testIsolation.ts"],"sourcesContent":["/**\n * Test Isolation Utilities\n * \n * Ensures tests can run in parallel without interfering with each other.\n * Provides unique identifiers and cleanup mechanisms for test data.\n */\n\nimport { randomBytes } from 'crypto';\n\n/**\n * Generate a unique test identifier for parallel test isolation.\n * Each test worker gets unique IDs to prevent data collisions.\n * \n * @param prefix - Optional prefix for the identifier\n * @returns Unique identifier string\n * \n * @example\n * const testId = generateTestId('guest');\n * // Returns: 'guest-abc123-worker1'\n */\nexport function generateTestId(prefix: string = 'test'): string {\n  const workerId = process.env.JEST_WORKER_ID || '0';\n  const randomId = randomBytes(4).toString('hex');\n  const timestamp = Date.now().toString(36);\n  \n  return `${prefix}-${randomId}-${timestamp}-w${workerId}`;\n}\n\n/**\n * Generate a unique email for test users.\n * Ensures each test worker has unique email addresses.\n * \n * @param prefix - Optional prefix for the email\n * @returns Unique email address\n * \n * @example\n * const email = generateTestEmail('admin');\n * // Returns: 'admin-abc123-worker1@test.example.com'\n */\nexport function generateTestEmail(prefix: string = 'test'): string {\n  const testId = generateTestId(prefix);\n  return `${testId}@test.example.com`;\n}\n\n/**\n * Generate a unique slug for test content.\n * Ensures each test worker has unique slugs.\n * \n * @param prefix - Optional prefix for the slug\n * @returns Unique slug string\n * \n * @example\n * const slug = generateTestSlug('page');\n * // Returns: 'page-abc123-worker1'\n */\nexport function generateTestSlug(prefix: string = 'test'): string {\n  return generateTestId(prefix);\n}\n\n/**\n * Create a test-scoped cleanup tracker.\n * Tracks resources created during a test for cleanup.\n * \n * @returns Cleanup tracker object\n * \n * @example\n * const cleanup = createCleanupTracker();\n * cleanup.track('guest', guestId);\n * await cleanup.cleanupAll(supabase);\n */\nexport function createCleanupTracker() {\n  const resources: Map<string, Set<string>> = new Map();\n  \n  return {\n    /**\n     * Track a resource for cleanup\n     */\n    track(table: string, id: string): void {\n      if (!resources.has(table)) {\n        resources.set(table, new Set());\n      }\n      resources.get(table)!.add(id);\n    },\n    \n    /**\n     * Get all tracked resources for a table\n     */\n    getTracked(table: string): string[] {\n      return Array.from(resources.get(table) || []);\n    },\n    \n    /**\n     * Clean up all tracked resources\n     */\n    async cleanupAll(supabase: any): Promise<void> {\n      const errors: Error[] = [];\n      \n      for (const [table, ids] of resources.entries()) {\n        try {\n          if (ids.size > 0) {\n            const { error } = await supabase\n              .from(table)\n              .delete()\n              .in('id', Array.from(ids));\n            \n            if (error) {\n              errors.push(new Error(`Failed to cleanup ${table}: ${error.message}`));\n            }\n          }\n        } catch (err) {\n          errors.push(err instanceof Error ? err : new Error(String(err)));\n        }\n      }\n      \n      if (errors.length > 0) {\n        console.warn('Cleanup errors:', errors);\n      }\n      \n      resources.clear();\n    },\n    \n    /**\n     * Clear tracking without cleanup (for when resources are already deleted)\n     */\n    clear(): void {\n      resources.clear();\n    }\n  };\n}\n\n/**\n * Create a test-scoped namespace for data isolation.\n * Useful for tests that need to create multiple related entities.\n * \n * @returns Namespace object with unique identifiers\n * \n * @example\n * const ns = createTestNamespace('guest-flow');\n * const group = await createGroup({ name: ns.name('Family Group') });\n * const guest = await createGuest({ email: ns.email('john') });\n */\nexport function createTestNamespace(prefix: string = 'test') {\n  const baseId = generateTestId(prefix);\n  \n  return {\n    id: baseId,\n    \n    /**\n     * Generate a namespaced name\n     */\n    name(suffix: string): string {\n      return `${baseId}-${suffix}`;\n    },\n    \n    /**\n     * Generate a namespaced email\n     */\n    email(suffix: string): string {\n      return `${baseId}-${suffix}@test.example.com`;\n    },\n    \n    /**\n     * Generate a namespaced slug\n     */\n    slug(suffix: string): string {\n      return `${baseId}-${suffix}`;\n    },\n    \n    /**\n     * Generate a namespaced ID\n     */\n    subId(suffix: string): string {\n      return `${baseId}-${suffix}`;\n    }\n  };\n}\n\n/**\n * Wait for a condition with timeout.\n * Useful for waiting for async operations in tests.\n * \n * @param condition - Function that returns true when condition is met\n * @param timeout - Maximum time to wait in milliseconds\n * @param interval - Check interval in milliseconds\n * @returns Promise that resolves when condition is met or rejects on timeout\n * \n * @example\n * await waitFor(() => data.length > 0, 5000);\n */\nexport async function waitFor(\n  condition: () => boolean | Promise<boolean>,\n  timeout: number = 5000,\n  interval: number = 100\n): Promise<void> {\n  const startTime = Date.now();\n  \n  while (Date.now() - startTime < timeout) {\n    const result = await Promise.resolve(condition());\n    if (result) {\n      return;\n    }\n    await new Promise(resolve => setTimeout(resolve, interval));\n  }\n  \n  throw new Error(`Timeout waiting for condition after ${timeout}ms`);\n}\n\n/**\n * Retry a function with exponential backoff.\n * Useful for flaky operations like external API calls.\n * \n * @param fn - Function to retry\n * @param maxRetries - Maximum number of retries\n * @param baseDelay - Base delay in milliseconds\n * @returns Result of the function\n * \n * @example\n * const result = await retry(() => fetchData(), 3, 100);\n */\nexport async function retry<T>(\n  fn: () => Promise<T>,\n  maxRetries: number = 3,\n  baseDelay: number = 100\n): Promise<T> {\n  let lastError: Error | undefined;\n  \n  for (let attempt = 0; attempt <= maxRetries; attempt++) {\n    try {\n      return await fn();\n    } catch (err) {\n      lastError = err instanceof Error ? err : new Error(String(err));\n      \n      if (attempt < maxRetries) {\n        const delay = baseDelay * Math.pow(2, attempt);\n        await new Promise(resolve => setTimeout(resolve, delay));\n      }\n    }\n  }\n  \n  throw lastError || new Error('Retry failed');\n}\n\n/**\n * Get the current Jest worker ID.\n * Useful for debugging parallel test issues.\n * \n * @returns Worker ID string\n */\nexport function getWorkerId(): string {\n  return process.env.JEST_WORKER_ID || '0';\n}\n\n/**\n * Check if running in CI environment.\n * \n * @returns True if running in CI\n */\nexport function isCI(): boolean {\n  return process.env.CI === 'true';\n}\n\n/**\n * Get test execution mode.\n * \n * @returns 'parallel' or 'serial'\n */\nexport function getTestMode(): 'parallel' | 'serial' {\n  return process.env.JEST_WORKER_ID ? 'parallel' : 'serial';\n}\n"],"names":["createCleanupTracker","createTestNamespace","generateTestEmail","generateTestId","generateTestSlug","getTestMode","getWorkerId","isCI","retry","waitFor","prefix","workerId","process","env","JEST_WORKER_ID","randomId","randomBytes","toString","timestamp","Date","now","testId","resources","Map","track","table","id","has","set","Set","get","add","getTracked","Array","from","cleanupAll","supabase","errors","ids","entries","size","error","delete","in","push","Error","message","err","String","length","console","warn","clear","baseId","name","suffix","email","slug","subId","condition","timeout","interval","startTime","result","Promise","resolve","setTimeout","fn","maxRetries","baseDelay","lastError","attempt","delay","Math","pow","CI"],"mappings":"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"}