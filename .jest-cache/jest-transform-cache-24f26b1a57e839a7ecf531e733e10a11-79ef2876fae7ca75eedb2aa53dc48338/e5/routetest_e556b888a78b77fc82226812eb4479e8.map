{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/admin/guests/[id]/auth-method/route.test.ts"],"sourcesContent":["/**\n * Unit Tests: PUT /api/admin/guests/[id]/auth-method\n * \n * Tests the API route for updating a single guest's auth method\n * \n * Requirements: 22.3\n */\n\nimport { PUT } from './route';\nimport { createAuthenticatedClient } from '@/lib/supabaseServer';\n\n// Mock Supabase\njest.mock('@/lib/supabaseServer');\n\ndescribe('PUT /api/admin/guests/[id]/auth-method', () => {\n  const mockSupabase = {\n    auth: {\n      getSession: jest.fn(),\n    },\n    from: jest.fn(),\n  };\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (createAuthenticatedClient as jest.Mock).mockResolvedValue(mockSupabase);\n  });\n\n  it('should update guest auth method successfully', async () => {\n    // Mock authenticated session\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: { user: { id: 'admin-123' } } },\n      error: null,\n    });\n\n    // Mock successful update\n    const mockUpdate = jest.fn().mockReturnValue({\n      eq: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: {\n              id: 'guest-123',\n              auth_method: 'magic_link',\n              email: 'test@example.com',\n              first_name: 'Test',\n              last_name: 'User',\n            },\n            error: null,\n          }),\n        }),\n      }),\n    });\n\n    mockSupabase.from.mockReturnValue({\n      update: mockUpdate,\n    });\n\n    const request = new Request('http://localhost:3000/api/admin/guests/guest-123/auth-method', {\n      method: 'PUT',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ auth_method: 'magic_link' }),\n    });\n\n    const response = await PUT(request, { params: { id: 'guest-123' } });\n    const result = await response.json();\n\n    expect(response.status).toBe(200);\n    expect(result.success).toBe(true);\n    expect(result.data.auth_method).toBe('magic_link');\n  });\n\n  it('should return 400 for invalid guest ID format', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: { user: { id: 'admin-123' } } },\n      error: null,\n    });\n\n    const request = new Request('http://localhost:3000/api/admin/guests/invalid-id/auth-method', {\n      method: 'PUT',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ auth_method: 'magic_link' }),\n    });\n\n    const response = await PUT(request, { params: { id: 'invalid-id' } });\n    const result = await response.json();\n\n    expect(response.status).toBe(400);\n    expect(result.success).toBe(false);\n    expect(result.error.code).toBe('VALIDATION_ERROR');\n  });\n\n  it('should return 400 for invalid auth method', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: { user: { id: 'admin-123' } } },\n      error: null,\n    });\n\n    const request = new Request('http://localhost:3000/api/admin/guests/00000000-0000-0000-0000-000000000000/auth-method', {\n      method: 'PUT',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ auth_method: 'invalid_method' }),\n    });\n\n    const response = await PUT(request, { params: { id: '00000000-0000-0000-0000-000000000000' } });\n    const result = await response.json();\n\n    expect(response.status).toBe(400);\n    expect(result.success).toBe(false);\n    expect(result.error.code).toBe('VALIDATION_ERROR');\n  });\n\n  it('should return 404 for non-existent guest', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: { user: { id: 'admin-123' } } },\n      error: null,\n    });\n\n    const mockUpdate = jest.fn().mockReturnValue({\n      eq: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: null,\n            error: { code: 'PGRST116', message: 'Not found' },\n          }),\n        }),\n      }),\n    });\n\n    mockSupabase.from.mockReturnValue({\n      update: mockUpdate,\n    });\n\n    const request = new Request('http://localhost:3000/api/admin/guests/00000000-0000-0000-0000-000000000000/auth-method', {\n      method: 'PUT',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ auth_method: 'magic_link' }),\n    });\n\n    const response = await PUT(request, { params: { id: '00000000-0000-0000-0000-000000000000' } });\n    const result = await response.json();\n\n    expect(response.status).toBe(404);\n    expect(result.success).toBe(false);\n    expect(result.error.code).toBe('GUEST_NOT_FOUND');\n  });\n\n  it('should return 401 when not authenticated', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: null },\n      error: null,\n    });\n\n    const request = new Request('http://localhost:3000/api/admin/guests/guest-123/auth-method', {\n      method: 'PUT',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ auth_method: 'magic_link' }),\n    });\n\n    const response = await PUT(request, { params: { id: 'guest-123' } });\n    const result = await response.json();\n\n    expect(response.status).toBe(401);\n    expect(result.success).toBe(false);\n    expect(result.error.code).toBe('UNAUTHORIZED');\n  });\n\n  it('should return 500 for database errors', async () => {\n    mockSupabase.auth.getSession.mockResolvedValue({\n      data: { session: { user: { id: 'admin-123' } } },\n      error: null,\n    });\n\n    const mockUpdate = jest.fn().mockReturnValue({\n      eq: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: null,\n            error: { code: 'DATABASE_ERROR', message: 'Database connection failed' },\n          }),\n        }),\n      }),\n    });\n\n    mockSupabase.from.mockReturnValue({\n      update: mockUpdate,\n    });\n\n    const request = new Request('http://localhost:3000/api/admin/guests/guest-123/auth-method', {\n      method: 'PUT',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ auth_method: 'magic_link' }),\n    });\n\n    const response = await PUT(request, { params: { id: 'guest-123' } });\n    const result = await response.json();\n\n    expect(response.status).toBe(500);\n    expect(result.success).toBe(false);\n    expect(result.error.code).toBe('DATABASE_ERROR');\n  });\n});\n"],"names":["jest","mock","describe","mockSupabase","auth","getSession","fn","from","beforeEach","clearAllMocks","createAuthenticatedClient","mockResolvedValue","it","data","session","user","id","error","mockUpdate","mockReturnValue","eq","select","single","auth_method","email","first_name","last_name","update","request","Request","method","headers","body","JSON","stringify","response","PUT","params","result","json","expect","status","toBe","success","code","message"],"mappings":"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"}