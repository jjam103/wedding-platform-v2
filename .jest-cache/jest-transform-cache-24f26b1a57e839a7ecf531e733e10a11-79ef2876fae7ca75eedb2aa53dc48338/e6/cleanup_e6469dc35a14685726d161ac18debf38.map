{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/helpers/cleanup.ts"],"sourcesContent":["/**\n * Test Cleanup Utilities\n * \n * Utilities for cleaning up test data after tests run.\n * Ensures test isolation and prevents data leakage between tests.\n */\n\nimport { createClient } from '@supabase/supabase-js';\n\n/**\n * Get Supabase client for test cleanup\n * Uses service role key to bypass RLS for cleanup operations\n */\nfunction getCleanupClient() {\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  \n  if (!supabaseUrl || !supabaseServiceKey) {\n    throw new Error('Missing Supabase credentials for test cleanup');\n  }\n  \n  return createClient(supabaseUrl, supabaseServiceKey, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  });\n}\n\n/**\n * Clean up test guests by email pattern\n */\nexport async function cleanupTestGuests(emailPattern = 'test.user%@example.com'): Promise<void> {\n  const supabase = getCleanupClient();\n  \n  const { error } = await supabase\n    .from('guests')\n    .delete()\n    .like('email', emailPattern);\n  \n  if (error) {\n    console.error('Failed to cleanup test guests:', error);\n  }\n}\n\n/**\n * Clean up test guest groups by name pattern\n */\nexport async function cleanupTestGuestGroups(namePattern = 'Test Family%'): Promise<void> {\n  const supabase = getCleanupClient();\n  \n  const { error } = await supabase\n    .from('guest_groups')\n    .delete()\n    .like('name', namePattern);\n  \n  if (error) {\n    console.error('Failed to cleanup test guest groups:', error);\n  }\n}\n\n/**\n * Clean up test events by name pattern\n */\nexport async function cleanupTestEvents(namePattern = 'Test Event%'): Promise<void> {\n  const supabase = getCleanupClient();\n  \n  const { error } = await supabase\n    .from('events')\n    .delete()\n    .like('name', namePattern);\n  \n  if (error) {\n    console.error('Failed to cleanup test events:', error);\n  }\n}\n\n/**\n * Clean up test activities by name pattern\n */\nexport async function cleanupTestActivities(namePattern = 'Test Activity%'): Promise<void> {\n  const supabase = getCleanupClient();\n  \n  const { error } = await supabase\n    .from('activities')\n    .delete()\n    .like('name', namePattern);\n  \n  if (error) {\n    console.error('Failed to cleanup test activities:', error);\n  }\n}\n\n/**\n * Clean up test accommodations by name pattern\n */\nexport async function cleanupTestAccommodations(namePattern = 'Test Hotel%'): Promise<void> {\n  const supabase = getCleanupClient();\n  \n  const { error } = await supabase\n    .from('accommodations')\n    .delete()\n    .like('name', namePattern);\n  \n  if (error) {\n    console.error('Failed to cleanup test accommodations:', error);\n  }\n}\n\n/**\n * Clean up test room types by name pattern\n */\nexport async function cleanupTestRoomTypes(namePattern = 'Test Room%'): Promise<void> {\n  const supabase = getCleanupClient();\n  \n  const { error } = await supabase\n    .from('room_types')\n    .delete()\n    .like('name', namePattern);\n  \n  if (error) {\n    console.error('Failed to cleanup test room types:', error);\n  }\n}\n\n/**\n * Clean up test locations by name pattern\n */\nexport async function cleanupTestLocations(namePattern = 'Test Location%'): Promise<void> {\n  const supabase = getCleanupClient();\n  \n  const { error } = await supabase\n    .from('locations')\n    .delete()\n    .like('name', namePattern);\n  \n  if (error) {\n    console.error('Failed to cleanup test locations:', error);\n  }\n}\n\n/**\n * Clean up test sections by entity ID pattern\n */\nexport async function cleanupTestSections(entityIdPattern = 'test-entity%'): Promise<void> {\n  const supabase = getCleanupClient();\n  \n  const { error } = await supabase\n    .from('sections')\n    .delete()\n    .like('entity_id', entityIdPattern);\n  \n  if (error) {\n    console.error('Failed to cleanup test sections:', error);\n  }\n}\n\n/**\n * Clean up test content pages by slug pattern\n */\nexport async function cleanupTestContentPages(slugPattern = 'test-page%'): Promise<void> {\n  const supabase = getCleanupClient();\n  \n  const { error } = await supabase\n    .from('content_pages')\n    .delete()\n    .like('slug', slugPattern);\n  \n  if (error) {\n    console.error('Failed to cleanup test content pages:', error);\n  }\n}\n\n/**\n * Clean up test RSVPs by guest ID pattern\n */\nexport async function cleanupTestRSVPs(guestIdPattern = 'test-guest%'): Promise<void> {\n  const supabase = getCleanupClient();\n  \n  const { error } = await supabase\n    .from('rsvps')\n    .delete()\n    .like('guest_id', guestIdPattern);\n  \n  if (error) {\n    console.error('Failed to cleanup test RSVPs:', error);\n  }\n}\n\n/**\n * Clean up a specific entity by ID\n */\nexport async function cleanupById(table: string, id: string): Promise<void> {\n  const supabase = getCleanupClient();\n  \n  const { error } = await supabase\n    .from(table)\n    .delete()\n    .eq('id', id);\n  \n  if (error) {\n    console.error(`Failed to cleanup ${table} with id ${id}:`, error);\n  }\n}\n\n/**\n * Clean up multiple entities by IDs\n */\nexport async function cleanupByIds(table: string, ids: string[]): Promise<void> {\n  if (ids.length === 0) return;\n  \n  const supabase = getCleanupClient();\n  \n  const { error } = await supabase\n    .from(table)\n    .delete()\n    .in('id', ids);\n  \n  if (error) {\n    console.error(`Failed to cleanup ${table} with ids:`, error);\n  }\n}\n\n/**\n * Clean up all test data (use with caution!)\n * This runs all cleanup functions in the correct order to handle foreign key constraints\n */\nexport async function cleanupAllTestData(): Promise<void> {\n  console.log('ðŸ§¹ Cleaning up all test data...');\n  \n  // Clean up in order to respect foreign key constraints\n  await cleanupTestRSVPs();\n  await cleanupTestGuests();\n  await cleanupTestGuestGroups();\n  await cleanupTestActivities();\n  await cleanupTestEvents();\n  await cleanupTestRoomTypes();\n  await cleanupTestAccommodations();\n  await cleanupTestLocations();\n  await cleanupTestSections();\n  await cleanupTestContentPages();\n  \n  console.log('âœ… Test data cleanup complete');\n}\n\n/**\n * Create a cleanup tracker for tracking created entities during a test\n */\nexport class CleanupTracker {\n  private entities: Map<string, string[]> = new Map();\n  \n  /**\n   * Track an entity for cleanup\n   */\n  track(table: string, id: string): void {\n    const ids = this.entities.get(table) || [];\n    ids.push(id);\n    this.entities.set(table, ids);\n  }\n  \n  /**\n   * Track multiple entities for cleanup\n   */\n  trackMany(table: string, ids: string[]): void {\n    const existing = this.entities.get(table) || [];\n    this.entities.set(table, [...existing, ...ids]);\n  }\n  \n  /**\n   * Clean up all tracked entities\n   */\n  async cleanup(): Promise<void> {\n    // Clean up in reverse order of tracking (LIFO)\n    const tables = Array.from(this.entities.keys()).reverse();\n    \n    for (const table of tables) {\n      const ids = this.entities.get(table) || [];\n      if (ids.length > 0) {\n        await cleanupByIds(table, ids);\n      }\n    }\n    \n    this.entities.clear();\n  }\n  \n  /**\n   * Get all tracked entities\n   */\n  getTracked(): Map<string, string[]> {\n    return new Map(this.entities);\n  }\n  \n  /**\n   * Clear tracking without cleanup\n   */\n  clear(): void {\n    this.entities.clear();\n  }\n}\n\n/**\n * Create a cleanup tracker instance\n */\nexport function createCleanupTracker(): CleanupTracker {\n  return new CleanupTracker();\n}\n\n/**\n * Helper to run a test with automatic cleanup\n */\nexport async function withCleanup<T>(\n  fn: (tracker: CleanupTracker) => Promise<T>\n): Promise<T> {\n  const tracker = createCleanupTracker();\n  \n  try {\n    return await fn(tracker);\n  } finally {\n    await tracker.cleanup();\n  }\n}\n"],"names":["CleanupTracker","cleanupAllTestData","cleanupById","cleanupByIds","cleanupTestAccommodations","cleanupTestActivities","cleanupTestContentPages","cleanupTestEvents","cleanupTestGuestGroups","cleanupTestGuests","cleanupTestLocations","cleanupTestRSVPs","cleanupTestRoomTypes","cleanupTestSections","createCleanupTracker","withCleanup","getCleanupClient","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","supabaseServiceKey","SUPABASE_SERVICE_ROLE_KEY","Error","createClient","auth","autoRefreshToken","persistSession","emailPattern","supabase","error","from","delete","like","console","namePattern","entityIdPattern","slugPattern","guestIdPattern","table","id","eq","ids","length","in","log","track","entities","get","push","set","trackMany","existing","cleanup","tables","Array","keys","reverse","clear","getTracked","Map","fn","tracker"],"mappings":"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"}