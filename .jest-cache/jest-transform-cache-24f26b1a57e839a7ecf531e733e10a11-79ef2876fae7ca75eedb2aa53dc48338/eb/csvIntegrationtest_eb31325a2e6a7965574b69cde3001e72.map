{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/csvIntegration.test.ts"],"sourcesContent":["/**\n * Integration test for CSV import/export functionality.\n * Tests the complete workflow of exporting and importing guest data.\n */\n\nimport { exportToCSV, importFromCSV } from './guestService';\nimport type { Guest } from '@/schemas/guestSchemas';\n\n// Mock Supabase\njest.mock('@/lib/supabase', () => ({\n  supabase: {\n    from: jest.fn(() => ({\n      insert: jest.fn(() => ({\n        select: jest.fn(() => ({\n          single: jest.fn(),\n        })),\n      })),\n    })),\n  },\n}));\n\ndescribe('CSV Import/Export Integration', () => {\n  it('should handle complete export-import workflow with multiple guests', async () => {\n    const originalGuests: Guest[] = [\n      {\n        id: '123e4567-e89b-12d3-a456-426614174000',\n        groupId: '123e4567-e89b-12d3-a456-426614174001',\n        firstName: 'John',\n        lastName: 'Doe',\n        email: 'john@example.com',\n        phone: '+1234567890',\n        ageType: 'adult',\n        guestType: 'wedding_guest',\n        dietaryRestrictions: 'Vegetarian',\n        plusOneName: 'Jane Doe',\n        plusOneAttending: true,\n        arrivalDate: '2025-06-01',\n        departureDate: '2025-06-05',\n        airportCode: 'SJO',\n        flightNumber: 'AA123',\n        invitationSent: true,\n        invitationSentDate: '2025-01-15',\n        rsvpDeadline: '2025-05-01',\n        notes: 'VIP guest',\n        authMethod: 'email_matching',\n        createdAt: '2025-01-01T00:00:00Z',\n        updatedAt: '2025-01-01T00:00:00Z',\n      },\n      {\n        id: '223e4567-e89b-12d3-a456-426614174000',\n        groupId: '123e4567-e89b-12d3-a456-426614174001',\n        firstName: 'Alice',\n        lastName: 'Smith',\n        email: null,\n        phone: null,\n        ageType: 'child',\n        guestType: 'wedding_guest',\n        dietaryRestrictions: null,\n        plusOneName: null,\n        plusOneAttending: false,\n        arrivalDate: null,\n        departureDate: null,\n        airportCode: null,\n        flightNumber: null,\n        invitationSent: false,\n        invitationSentDate: null,\n        rsvpDeadline: null,\n        notes: null,\n        authMethod: 'email_matching',\n        createdAt: '2025-01-01T00:00:00Z',\n        updatedAt: '2025-01-01T00:00:00Z',\n      },\n      {\n        id: '323e4567-e89b-12d3-a456-426614174000',\n        groupId: '223e4567-e89b-12d3-a456-426614174001',\n        firstName: 'Bob',\n        lastName: 'Johnson',\n        email: 'bob@example.com',\n        phone: '+9876543210',\n        ageType: 'senior',\n        guestType: 'wedding_party',\n        dietaryRestrictions: 'Gluten-free, dairy-free',\n        plusOneName: null,\n        plusOneAttending: false,\n        arrivalDate: '2025-05-30',\n        departureDate: '2025-06-07',\n        airportCode: 'LIR',\n        flightNumber: 'UA456',\n        invitationSent: true,\n        invitationSentDate: '2025-01-10',\n        rsvpDeadline: '2025-04-30',\n        notes: 'Needs wheelchair assistance',\n        authMethod: 'email_matching',\n        createdAt: '2025-01-01T00:00:00Z',\n        updatedAt: '2025-01-01T00:00:00Z',\n      },\n    ];\n\n    // Step 1: Export to CSV\n    const exportResult = await exportToCSV(originalGuests);\n    expect(exportResult.success).toBe(true);\n    if (!exportResult.success) return;\n\n    // Verify CSV structure\n    const csvLines = exportResult.data.split('\\n');\n    expect(csvLines.length).toBe(4); // Header + 3 data rows\n\n    // Step 2: Mock database for import\n    const { supabase } = require('@/lib/supabase');\n    let callCount = 0;\n    supabase.from.mockReturnValue({\n      insert: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockImplementation(() => {\n            const guest = originalGuests[callCount];\n            callCount++;\n            return Promise.resolve({\n              data: {\n                id: `new-id-${callCount}`,\n                group_id: guest.groupId,\n                first_name: guest.firstName,\n                last_name: guest.lastName,\n                email: guest.email,\n                phone: guest.phone,\n                age_type: guest.ageType,\n                guest_type: guest.guestType,\n                dietary_restrictions: guest.dietaryRestrictions,\n                plus_one_name: guest.plusOneName,\n                plus_one_attending: guest.plusOneAttending,\n                arrival_date: guest.arrivalDate,\n                departure_date: guest.departureDate,\n                airport_code: guest.airportCode,\n                flight_number: guest.flightNumber,\n                invitation_sent: guest.invitationSent,\n                invitation_sent_date: guest.invitationSentDate,\n                rsvp_deadline: guest.rsvpDeadline,\n                notes: guest.notes,\n                created_at: '2025-01-25T00:00:00Z',\n                updated_at: '2025-01-25T00:00:00Z',\n              },\n              error: null,\n            });\n          }),\n        }),\n      }),\n    });\n\n    // Step 3: Import from CSV\n    const importResult = await importFromCSV(exportResult.data);\n    expect(importResult.success).toBe(true);\n    if (!importResult.success) return;\n\n    // Step 4: Verify all guests were imported\n    expect(importResult.data).toHaveLength(3);\n\n    // Step 5: Verify data integrity for each guest\n    for (let i = 0; i < originalGuests.length; i++) {\n      const original = originalGuests[i];\n      const imported = importResult.data[i];\n\n      expect(imported.groupId).toBe(original.groupId);\n      expect(imported.firstName).toBe(original.firstName);\n      expect(imported.lastName).toBe(original.lastName);\n      expect(imported.email).toBe(original.email);\n      expect(imported.phone).toBe(original.phone);\n      expect(imported.ageType).toBe(original.ageType);\n      expect(imported.guestType).toBe(original.guestType);\n      expect(imported.dietaryRestrictions).toBe(original.dietaryRestrictions);\n      expect(imported.plusOneName).toBe(original.plusOneName);\n      expect(imported.plusOneAttending).toBe(original.plusOneAttending);\n      expect(imported.arrivalDate).toBe(original.arrivalDate);\n      expect(imported.departureDate).toBe(original.departureDate);\n      expect(imported.airportCode).toBe(original.airportCode);\n      expect(imported.flightNumber).toBe(original.flightNumber);\n      expect(imported.invitationSent).toBe(original.invitationSent);\n      expect(imported.invitationSentDate).toBe(original.invitationSentDate);\n      expect(imported.rsvpDeadline).toBe(original.rsvpDeadline);\n      expect(imported.notes).toBe(original.notes);\n    }\n  });\n\n  it('should handle special characters in CSV fields', async () => {\n    const guestsWithSpecialChars: Guest[] = [\n      {\n        id: '123e4567-e89b-12d3-a456-426614174000',\n        groupId: '123e4567-e89b-12d3-a456-426614174001',\n        firstName: 'María',\n        lastName: 'García',\n        email: 'maria@example.com',\n        phone: null,\n        ageType: 'adult',\n        guestType: 'wedding_guest',\n        dietaryRestrictions: 'No shellfish, no \"raw\" fish',\n        plusOneName: null,\n        plusOneAttending: false,\n        arrivalDate: null,\n        departureDate: null,\n        airportCode: null,\n        flightNumber: null,\n        invitationSent: false,\n        invitationSentDate: null,\n        rsvpDeadline: null,\n        notes: 'Prefers Spanish, speaks limited English',\n        authMethod: 'email_matching',\n        createdAt: '2025-01-01T00:00:00Z',\n        updatedAt: '2025-01-01T00:00:00Z',\n      },\n    ];\n\n    // Export\n    const exportResult = await exportToCSV(guestsWithSpecialChars);\n    expect(exportResult.success).toBe(true);\n    if (!exportResult.success) return;\n\n    // Mock database\n    const { supabase } = require('@/lib/supabase');\n    supabase.from.mockReturnValue({\n      insert: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: {\n              id: 'new-id',\n              group_id: guestsWithSpecialChars[0].groupId,\n              first_name: guestsWithSpecialChars[0].firstName,\n              last_name: guestsWithSpecialChars[0].lastName,\n              email: guestsWithSpecialChars[0].email,\n              phone: guestsWithSpecialChars[0].phone,\n              age_type: guestsWithSpecialChars[0].ageType,\n              guest_type: guestsWithSpecialChars[0].guestType,\n              dietary_restrictions: guestsWithSpecialChars[0].dietaryRestrictions,\n              plus_one_name: guestsWithSpecialChars[0].plusOneName,\n              plus_one_attending: guestsWithSpecialChars[0].plusOneAttending,\n              arrival_date: guestsWithSpecialChars[0].arrivalDate,\n              departure_date: guestsWithSpecialChars[0].departureDate,\n              airport_code: guestsWithSpecialChars[0].airportCode,\n              flight_number: guestsWithSpecialChars[0].flightNumber,\n              invitation_sent: guestsWithSpecialChars[0].invitationSent,\n              invitation_sent_date: guestsWithSpecialChars[0].invitationSentDate,\n              rsvp_deadline: guestsWithSpecialChars[0].rsvpDeadline,\n              notes: guestsWithSpecialChars[0].notes,\n              created_at: '2025-01-25T00:00:00Z',\n              updated_at: '2025-01-25T00:00:00Z',\n            },\n            error: null,\n          }),\n        }),\n      }),\n    });\n\n    // Import\n    const importResult = await importFromCSV(exportResult.data);\n    expect(importResult.success).toBe(true);\n    if (!importResult.success) return;\n\n    // Verify special characters preserved\n    expect(importResult.data[0].firstName).toBe('María');\n    expect(importResult.data[0].lastName).toBe('García');\n    expect(importResult.data[0].dietaryRestrictions).toBe('No shellfish, no \"raw\" fish');\n    expect(importResult.data[0].notes).toBe('Prefers Spanish, speaks limited English');\n  });\n});\n"],"names":["jest","mock","supabase","from","fn","insert","select","single","describe","it","originalGuests","id","groupId","firstName","lastName","email","phone","ageType","guestType","dietaryRestrictions","plusOneName","plusOneAttending","arrivalDate","departureDate","airportCode","flightNumber","invitationSent","invitationSentDate","rsvpDeadline","notes","authMethod","createdAt","updatedAt","exportResult","exportToCSV","expect","success","toBe","csvLines","data","split","length","require","callCount","mockReturnValue","mockImplementation","guest","Promise","resolve","group_id","first_name","last_name","age_type","guest_type","dietary_restrictions","plus_one_name","plus_one_attending","arrival_date","departure_date","airport_code","flight_number","invitation_sent","invitation_sent_date","rsvp_deadline","created_at","updated_at","error","importResult","importFromCSV","toHaveLength","i","original","imported","guestsWithSpecialChars","mockResolvedValue"],"mappings":"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"}