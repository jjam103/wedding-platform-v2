{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/rsvpManagementService.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { z } from 'zod';\nimport type { Result } from '@/types';\nimport { ERROR_CODES } from '@/types';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\nconst supabase = createClient(supabaseUrl, supabaseKey);\n\n/**\n * RSVP View Model for management interface\n * Denormalized view with guest, event, and activity details\n */\nexport interface RSVPViewModel {\n  id: string;\n  guestId: string;\n  guestFirstName: string;\n  guestLastName: string;\n  guestEmail: string | null;\n  eventId: string | null;\n  eventName: string | null;\n  activityId: string | null;\n  activityName: string | null;\n  status: 'pending' | 'attending' | 'declined' | 'maybe';\n  guestCount: number | null;\n  dietaryNotes: string | null;\n  specialRequirements: string | null;\n  notes: string | null;\n  respondedAt: string | null;\n  createdAt: string;\n  updatedAt: string;\n}\n\n/**\n * RSVP Statistics\n */\nexport interface RSVPStatistics {\n  totalRSVPs: number;\n  byStatus: {\n    attending: number;\n    declined: number;\n    maybe: number;\n    pending: number;\n  };\n  totalGuestCount: number;\n}\n\n/**\n * RSVP Filters for querying\n */\nexport interface RSVPFilters {\n  eventId?: string;\n  activityId?: string;\n  status?: 'pending' | 'attending' | 'declined' | 'maybe';\n  guestId?: string;\n  searchQuery?: string;\n}\n\n/**\n * Pagination parameters\n */\nexport interface PaginationParams {\n  page: number;\n  limit: number;\n}\n\n/**\n * Paginated RSVP response\n */\nexport interface PaginatedRSVPResponse {\n  data: RSVPViewModel[];\n  pagination: {\n    page: number;\n    limit: number;\n    total: number;\n    totalPages: number;\n  };\n  statistics: RSVPStatistics;\n}\n\n/**\n * Schema for RSVP filters validation\n */\nconst rsvpFiltersSchema = z.object({\n  eventId: z.string().uuid().optional(),\n  activityId: z.string().uuid().optional(),\n  status: z.enum(['pending', 'attending', 'declined', 'maybe']).optional(),\n  guestId: z.string().uuid().optional(),\n  searchQuery: z.string().max(100).optional(),\n});\n\n/**\n * Schema for pagination validation\n */\nconst paginationSchema = z.object({\n  page: z.number().int().positive().default(1),\n  limit: z.number().int().positive().max(100).default(50),\n});\n\n/**\n * Schema for bulk update validation\n */\nconst bulkUpdateSchema = z.object({\n  rsvpIds: z.array(z.string().uuid()).min(1).max(100),\n  status: z.enum(['pending', 'attending', 'declined', 'maybe']),\n  notes: z.string().max(1000).optional(),\n});\n\n/**\n * Lists all RSVPs with filtering, pagination, and statistics.\n * \n * @param filters - Filter criteria for RSVPs\n * @param pagination - Pagination parameters\n * @returns Result containing paginated RSVPs with statistics\n * \n * **Validates: Requirements 6.2, 6.4, 6.5**\n * \n * @example\n * const result = await rsvpManagementService.listRSVPs(\n *   { eventId: 'event-123', status: 'attending' },\n *   { page: 1, limit: 50 }\n * );\n */\nexport async function listRSVPs(\n  filters: RSVPFilters = {},\n  pagination: PaginationParams = { page: 1, limit: 50 }\n): Promise<Result<PaginatedRSVPResponse>> {\n  try {\n    // 1. Validate filters\n    const filterValidation = rsvpFiltersSchema.safeParse(filters);\n    if (!filterValidation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Invalid filter parameters',\n          details: filterValidation.error.issues,\n        },\n      };\n    }\n\n    // 2. Validate pagination\n    const paginationValidation = paginationSchema.safeParse(pagination);\n    if (!paginationValidation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Invalid pagination parameters',\n          details: paginationValidation.error.issues,\n        },\n      };\n    }\n\n    const validFilters = filterValidation.data;\n    const validPagination = paginationValidation.data;\n\n    // 3. Build complex query with joins\n    let query = supabase\n      .from('rsvps')\n      .select(`\n        id,\n        guest_id,\n        event_id,\n        activity_id,\n        status,\n        guest_count,\n        dietary_notes,\n        special_requirements,\n        notes,\n        responded_at,\n        created_at,\n        updated_at,\n        guests!inner (\n          first_name,\n          last_name,\n          email\n        ),\n        events (\n          name\n        ),\n        activities (\n          name\n        )\n      `, { count: 'exact' });\n\n    // Apply filters\n    if (validFilters.eventId) {\n      query = query.eq('event_id', validFilters.eventId);\n    }\n    if (validFilters.activityId) {\n      query = query.eq('activity_id', validFilters.activityId);\n    }\n    if (validFilters.status) {\n      query = query.eq('status', validFilters.status);\n    }\n    if (validFilters.guestId) {\n      query = query.eq('guest_id', validFilters.guestId);\n    }\n\n    // Apply search query (searches guest name and email)\n    if (validFilters.searchQuery) {\n      const searchTerm = `%${validFilters.searchQuery}%`;\n      query = query.or(\n        `guests.first_name.ilike.${searchTerm},guests.last_name.ilike.${searchTerm},guests.email.ilike.${searchTerm}`\n      );\n    }\n\n    // Apply pagination\n    const from = (validPagination.page - 1) * validPagination.limit;\n    const to = from + validPagination.limit - 1;\n    query = query.range(from, to);\n\n    // Order by created_at descending\n    query = query.order('created_at', { ascending: false });\n\n    // Execute query\n    const { data, error, count } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    // 4. Transform to view model\n    const viewModels: RSVPViewModel[] = (data || []).map((rsvp: any) => ({\n      id: rsvp.id,\n      guestId: rsvp.guest_id,\n      guestFirstName: rsvp.guests?.first_name || '',\n      guestLastName: rsvp.guests?.last_name || '',\n      guestEmail: rsvp.guests?.email || null,\n      eventId: rsvp.event_id,\n      eventName: rsvp.events?.name || null,\n      activityId: rsvp.activity_id,\n      activityName: rsvp.activities?.name || null,\n      status: rsvp.status,\n      guestCount: rsvp.guest_count,\n      dietaryNotes: rsvp.dietary_notes,\n      specialRequirements: rsvp.special_requirements,\n      notes: rsvp.notes,\n      respondedAt: rsvp.responded_at,\n      createdAt: rsvp.created_at,\n      updatedAt: rsvp.updated_at,\n    }));\n\n    // 5. Calculate statistics\n    const statisticsResult = await getRSVPStatistics(validFilters);\n    const statistics = statisticsResult.success \n      ? statisticsResult.data \n      : {\n          totalRSVPs: count || 0,\n          byStatus: { attending: 0, declined: 0, maybe: 0, pending: 0 },\n          totalGuestCount: 0,\n        };\n\n    // 6. Build response\n    const totalPages = Math.ceil((count || 0) / validPagination.limit);\n\n    return {\n      success: true,\n      data: {\n        data: viewModels,\n        pagination: {\n          page: validPagination.page,\n          limit: validPagination.limit,\n          total: count || 0,\n          totalPages,\n        },\n        statistics,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Gets RSVP statistics for the given filters.\n * \n * @param filters - Filter criteria for RSVPs\n * @returns Result containing RSVP statistics\n * \n * **Validates: Requirements 6.5**\n * \n * @example\n * const result = await rsvpManagementService.getRSVPStatistics({\n *   eventId: 'event-123'\n * });\n */\nexport async function getRSVPStatistics(\n  filters: RSVPFilters = {}\n): Promise<Result<RSVPStatistics>> {\n  try {\n    // 1. Validate filters\n    const filterValidation = rsvpFiltersSchema.safeParse(filters);\n    if (!filterValidation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Invalid filter parameters',\n          details: filterValidation.error.issues,\n        },\n      };\n    }\n\n    const validFilters = filterValidation.data;\n\n    // 2. Build query\n    let query = supabase\n      .from('rsvps')\n      .select('status, guest_count');\n\n    // Apply filters\n    if (validFilters.eventId) {\n      query = query.eq('event_id', validFilters.eventId);\n    }\n    if (validFilters.activityId) {\n      query = query.eq('activity_id', validFilters.activityId);\n    }\n    if (validFilters.status) {\n      query = query.eq('status', validFilters.status);\n    }\n    if (validFilters.guestId) {\n      query = query.eq('guest_id', validFilters.guestId);\n    }\n\n    // Execute query\n    const { data, error } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    // 3. Calculate statistics\n    const statistics: RSVPStatistics = {\n      totalRSVPs: data?.length || 0,\n      byStatus: {\n        attending: 0,\n        declined: 0,\n        maybe: 0,\n        pending: 0,\n      },\n      totalGuestCount: 0,\n    };\n\n    if (data) {\n      for (const rsvp of data) {\n        // Count by status\n        if (rsvp.status in statistics.byStatus) {\n          statistics.byStatus[rsvp.status as keyof typeof statistics.byStatus]++;\n        }\n\n        // Sum guest counts (default to 1 if not specified)\n        if (rsvp.status === 'attending') {\n          statistics.totalGuestCount += rsvp.guest_count || 1;\n        }\n      }\n    }\n\n    return {\n      success: true,\n      data: statistics,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Bulk updates RSVP statuses with transaction handling.\n * \n * @param rsvpIds - Array of RSVP IDs to update\n * @param status - New status for all RSVPs\n * @param notes - Optional notes to add to all RSVPs\n * @returns Result containing count of updated RSVPs\n * \n * **Validates: Requirements 6.4**\n * \n * @example\n * const result = await rsvpManagementService.bulkUpdateRSVPs(\n *   ['rsvp-1', 'rsvp-2', 'rsvp-3'],\n *   'attending',\n *   'Bulk approved by admin'\n * );\n */\nexport async function bulkUpdateRSVPs(\n  rsvpIds: string[],\n  status: 'pending' | 'attending' | 'declined' | 'maybe',\n  notes?: string\n): Promise<Result<{ updatedCount: number }>> {\n  try {\n    // 1. Validate input\n    const validation = bulkUpdateSchema.safeParse({ rsvpIds, status, notes });\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Invalid bulk update parameters',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    const { rsvpIds: validIds, status: validStatus, notes: validNotes } = validation.data;\n\n    // 2. Prepare update data\n    const updateData: any = {\n      status: validStatus,\n      updated_at: new Date().toISOString(),\n    };\n\n    // Set responded_at if status is not pending\n    if (validStatus !== 'pending') {\n      updateData.responded_at = new Date().toISOString();\n    }\n\n    // Add notes if provided\n    if (validNotes) {\n      updateData.notes = validNotes;\n    }\n\n    // 3. Execute bulk update with transaction handling\n    // Note: Supabase doesn't support explicit transactions in the client library,\n    // but the update operation is atomic at the database level\n    const { data, error } = await supabase\n      .from('rsvps')\n      .update(updateData)\n      .in('id', validIds)\n      .select('id');\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    // 4. Return count of updated records\n    const updatedCount = data?.length || 0;\n\n    // Log if not all RSVPs were updated (some might not exist)\n    if (updatedCount < validIds.length) {\n      console.warn(\n        `Bulk update: ${updatedCount} of ${validIds.length} RSVPs updated. ` +\n        `${validIds.length - updatedCount} RSVPs not found.`\n      );\n    }\n\n    return {\n      success: true,\n      data: { updatedCount },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Exports RSVPs to CSV format.\n * \n * @param filters - Filter criteria for RSVPs to export\n * @returns Result containing CSV string\n * \n * **Validates: Requirements 6.4**\n * \n * @example\n * const result = await rsvpManagementService.exportRSVPsToCSV({\n *   eventId: 'event-123',\n *   status: 'attending'\n * });\n */\nexport async function exportRSVPsToCSV(\n  filters: RSVPFilters = {}\n): Promise<Result<string>> {\n  try {\n    // 1. Validate filters\n    const filterValidation = rsvpFiltersSchema.safeParse(filters);\n    if (!filterValidation.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.VALIDATION_ERROR,\n          message: 'Invalid filter parameters',\n          details: filterValidation.error.issues,\n        },\n      };\n    }\n\n    const validFilters = filterValidation.data;\n\n    // 2. Fetch all matching RSVPs (limit to 10,000 for performance)\n    const result = await listRSVPs(validFilters, { page: 1, limit: 10000 });\n\n    if (!result.success) {\n      return result;\n    }\n\n    const rsvps = result.data.data;\n\n    // 3. Build CSV header\n    const headers = [\n      'RSVP ID',\n      'Guest First Name',\n      'Guest Last Name',\n      'Guest Email',\n      'Event Name',\n      'Activity Name',\n      'Status',\n      'Guest Count',\n      'Dietary Notes',\n      'Special Requirements',\n      'Notes',\n      'Responded At',\n      'Created At',\n    ];\n\n    // 4. Build CSV rows\n    const rows = rsvps.map((rsvp) => [\n      rsvp.id,\n      rsvp.guestFirstName,\n      rsvp.guestLastName,\n      rsvp.guestEmail || '',\n      rsvp.eventName || '',\n      rsvp.activityName || '',\n      rsvp.status,\n      rsvp.guestCount?.toString() || '1',\n      rsvp.dietaryNotes || '',\n      rsvp.specialRequirements || '',\n      rsvp.notes || '',\n      rsvp.respondedAt || '',\n      rsvp.createdAt,\n    ]);\n\n    // 5. Format as CSV\n    const escapeCsvValue = (value: string): string => {\n      // Escape double quotes and wrap in quotes if contains comma, newline, or quote\n      if (value.includes(',') || value.includes('\\n') || value.includes('\"')) {\n        return `\"${value.replace(/\"/g, '\"\"')}\"`;\n      }\n      return value;\n    };\n\n    const csvLines = [\n      headers.map(escapeCsvValue).join(','),\n      ...rows.map((row) => row.map(escapeCsvValue).join(',')),\n    ];\n\n    const csv = csvLines.join('\\n');\n\n    return {\n      success: true,\n      data: csv,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n"],"names":["bulkUpdateRSVPs","exportRSVPsToCSV","getRSVPStatistics","listRSVPs","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","supabaseKey","NEXT_PUBLIC_SUPABASE_ANON_KEY","supabase","createClient","rsvpFiltersSchema","z","object","eventId","string","uuid","optional","activityId","status","enum","guestId","searchQuery","max","paginationSchema","page","number","int","positive","default","limit","bulkUpdateSchema","rsvpIds","array","min","notes","filters","pagination","filterValidation","safeParse","success","error","code","ERROR_CODES","VALIDATION_ERROR","message","details","issues","paginationValidation","validFilters","data","validPagination","query","from","select","count","eq","searchTerm","or","to","range","order","ascending","DATABASE_ERROR","viewModels","map","rsvp","id","guest_id","guestFirstName","guests","first_name","guestLastName","last_name","guestEmail","email","event_id","eventName","events","name","activity_id","activityName","activities","guestCount","guest_count","dietaryNotes","dietary_notes","specialRequirements","special_requirements","respondedAt","responded_at","createdAt","created_at","updatedAt","updated_at","statisticsResult","statistics","totalRSVPs","byStatus","attending","declined","maybe","pending","totalGuestCount","totalPages","Math","ceil","total","UNKNOWN_ERROR","Error","length","validation","validIds","validStatus","validNotes","updateData","Date","toISOString","update","in","updatedCount","console","warn","result","rsvps","headers","rows","toString","escapeCsvValue","value","includes","replace","csvLines","join","row","csv"],"mappings":"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"}