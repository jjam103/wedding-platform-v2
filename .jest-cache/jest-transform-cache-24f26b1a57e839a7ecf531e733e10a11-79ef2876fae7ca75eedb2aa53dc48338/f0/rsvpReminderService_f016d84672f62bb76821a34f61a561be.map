{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/rsvpReminderService.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport type { Result } from '@/types';\nimport { ERROR_CODES } from '@/types';\nimport { sendEmail } from './emailService';\nimport { executeCronJob, type CronJobResult } from './cronService';\n\n// Initialize Supabase client for database operations\n// Use a getter function to allow for testing\nlet supabaseInstance: ReturnType<typeof createClient> | null = null;\n\nfunction getSupabaseClient() {\n  if (!supabaseInstance) {\n    supabaseInstance = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    );\n  }\n  return supabaseInstance;\n}\n\n// Export for testing\nexport function __setSupabaseClient(client: any) {\n  supabaseInstance = client;\n}\n\n// Export for testing\nexport function __resetSupabaseClient() {\n  supabaseInstance = null;\n}\n\n/**\n * Guest with pending RSVP information.\n */\ninterface PendingRSVPGuest {\n  guest_id: string;\n  guest_name: string;\n  guest_email: string;\n  event_id?: string;\n  event_name?: string;\n  activity_id?: string;\n  activity_name?: string;\n  deadline: string;\n  days_until_deadline: number;\n}\n\n/**\n * Finds guests with pending RSVPs approaching their deadline.\n * \n * @param daysBeforeDeadline - Number of days before deadline to send reminder (default: 7)\n * @returns Result containing array of guests needing reminders\n * \n * Requirements: 6.8, 22.2, 22.3, 19.3\n */\nexport async function findPendingRSVPs(\n  daysBeforeDeadline: number = 7\n): Promise<Result<PendingRSVPGuest[]>> {\n  try {\n    const supabase = getSupabaseClient();\n    const now = new Date();\n    const reminderDate = new Date(now);\n    reminderDate.setDate(reminderDate.getDate() + daysBeforeDeadline);\n\n    // Find events with upcoming RSVP deadlines\n    const { data: events, error: eventsError } = await supabase\n      .from('events')\n      .select('id, name, rsvp_deadline')\n      .eq('rsvp_required', true)\n      .not('rsvp_deadline', 'is', null)\n      .gte('rsvp_deadline', now.toISOString().split('T')[0])\n      .lte('rsvp_deadline', reminderDate.toISOString().split('T')[0])\n      .eq('status', 'published');\n\n    if (eventsError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: 'Failed to fetch events with deadlines',\n          details: eventsError,\n        },\n      };\n    }\n\n    const pendingGuests: PendingRSVPGuest[] = [];\n\n    // For each event, find guests with pending RSVPs\n    for (const event of (events || []) as Array<{ id: string; name: string; rsvp_deadline: string }>) {\n      // Get all guests who should RSVP to this event\n      const { data: guests, error: guestsError } = await supabase\n        .from('guests')\n        .select('id, first_name, last_name, email')\n        .not('email', 'is', null)\n        .eq('invitation_sent', true);\n\n      if (guestsError) {\n        continue; // Skip this event on error\n      }\n\n      for (const guest of (guests || []) as Array<{ id: string; first_name: string; last_name: string; email: string }>) {\n        // Check if guest has pending RSVP for this event\n        const { data: rsvps, error: rsvpError } = await supabase\n          .from('rsvps')\n          .select('status')\n          .eq('guest_id', guest.id)\n          .eq('event_id', event.id);\n\n        if (rsvpError) {\n          continue; // Skip this guest on error\n        }\n\n        // If no RSVP or RSVP is pending, add to reminder list\n        if (!rsvps || rsvps.length === 0 || (rsvps as Array<{ status: string }>).some((r) => r.status === 'pending')) {\n          const deadline = new Date(event.rsvp_deadline!);\n          const daysUntil = Math.ceil((deadline.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n\n          pendingGuests.push({\n            guest_id: guest.id,\n            guest_name: `${guest.first_name} ${guest.last_name}`,\n            guest_email: guest.email!,\n            event_id: event.id,\n            event_name: event.name,\n            deadline: event.rsvp_deadline!,\n            days_until_deadline: daysUntil,\n          });\n        }\n      }\n    }\n\n    // Also check activities with RSVP deadlines\n    const { data: activities, error: activitiesError } = await supabase\n      .from('activities')\n      .select('id, name')\n      .eq('status', 'published');\n\n    if (!activitiesError && activities) {\n      for (const activity of activities as Array<{ id: string; name: string }>) {\n        // Get guests who should RSVP to this activity\n        const { data: guests, error: guestsError } = await supabase\n          .from('guests')\n          .select('id, first_name, last_name, email, rsvp_deadline')\n          .not('email', 'is', null)\n          .not('rsvp_deadline', 'is', null)\n          .gte('rsvp_deadline', now.toISOString().split('T')[0])\n          .lte('rsvp_deadline', reminderDate.toISOString().split('T')[0])\n          .eq('invitation_sent', true);\n\n        if (guestsError) {\n          continue;\n        }\n\n        for (const guest of (guests || []) as Array<{ id: string; first_name: string; last_name: string; email: string; rsvp_deadline: string }>) {\n          // Check if guest has pending RSVP for this activity\n          const { data: rsvps, error: rsvpError } = await supabase\n            .from('rsvps')\n            .select('status')\n            .eq('guest_id', guest.id)\n            .eq('activity_id', activity.id);\n\n          if (rsvpError) {\n            continue;\n          }\n\n          if (!rsvps || rsvps.length === 0 || (rsvps as Array<{ status: string }>).some((r) => r.status === 'pending')) {\n            const deadline = new Date(guest.rsvp_deadline!);\n            const daysUntil = Math.ceil((deadline.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n\n            pendingGuests.push({\n              guest_id: guest.id,\n              guest_name: `${guest.first_name} ${guest.last_name}`,\n              guest_email: guest.email!,\n              activity_id: activity.id,\n              activity_name: activity.name,\n              deadline: guest.rsvp_deadline!,\n              days_until_deadline: daysUntil,\n            });\n          }\n        }\n      }\n    }\n\n    return { success: true, data: pendingGuests };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Sends RSVP reminder email to a guest.\n * \n * @param guest - Guest information with pending RSVP\n * @returns Result indicating success or error\n * \n * Requirements: 6.8, 22.2, 22.3, 19.3\n */\nexport async function sendRSVPReminder(guest: PendingRSVPGuest): Promise<Result<void>> {\n  try {\n    const supabase = getSupabaseClient();\n    const eventOrActivity = guest.event_name || guest.activity_name || 'the event';\n    const deadlineDate = new Date(guest.deadline).toLocaleDateString('en-US', {\n      weekday: 'long',\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n    });\n\n    const subject = `RSVP Reminder: ${eventOrActivity} - ${guest.days_until_deadline} days left`;\n    \n    const html = `\n      <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n        <h2 style=\"color: #22c55e;\">RSVP Reminder</h2>\n        <p>Hi ${guest.guest_name},</p>\n        <p>This is a friendly reminder that your RSVP for <strong>${eventOrActivity}</strong> is still pending.</p>\n        <p><strong>Deadline:</strong> ${deadlineDate} (${guest.days_until_deadline} days from now)</p>\n        <p>Please take a moment to let us know if you'll be attending by visiting your guest portal.</p>\n        <p style=\"margin-top: 30px;\">\n          <a href=\"${process.env.NEXT_PUBLIC_APP_URL}/guest/rsvp\" \n             style=\"background-color: #22c55e; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">\n            Submit Your RSVP\n          </a>\n        </p>\n        <p style=\"margin-top: 30px; color: #6b7280; font-size: 14px;\">\n          If you have any questions, please don't hesitate to reach out.\n        </p>\n        <p style=\"color: #6b7280; font-size: 14px;\">Pura Vida! ðŸŒ´</p>\n      </div>\n    `;\n\n    const text = `\nHi ${guest.guest_name},\n\nThis is a friendly reminder that your RSVP for ${eventOrActivity} is still pending.\n\nDeadline: ${deadlineDate} (${guest.days_until_deadline} days from now)\n\nPlease take a moment to let us know if you'll be attending by visiting your guest portal:\n${process.env.NEXT_PUBLIC_APP_URL}/guest/rsvp\n\nIf you have any questions, please don't hesitate to reach out.\n\nPura Vida! ðŸŒ´\n    `;\n\n    const emailResult = await sendEmail({\n      to: guest.guest_email,\n      subject,\n      html,\n      text,\n    });\n\n    if (!emailResult.success) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.EMAIL_SERVICE_ERROR,\n          message: `Failed to send reminder to ${guest.guest_email}`,\n          details: emailResult.error,\n        },\n      };\n    }\n\n    // Log the reminder sent\n    await supabase.from('rsvp_reminders_sent').insert({\n      guest_id: guest.guest_id,\n      event_id: guest.event_id,\n      activity_id: guest.activity_id,\n      sent_at: new Date().toISOString(),\n      days_before_deadline: guest.days_until_deadline,\n    } as any);\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Processes all pending RSVP reminders.\n * This function should be called by a scheduled cron job.\n * \n * @param daysBeforeDeadline - Number of days before deadline to send reminder (default: 7)\n * @returns Result containing processing statistics\n * \n * Requirements: 6.8, 22.2, 22.3, 19.3\n * \n * @example\n * // Run daily to send reminders 7 days before deadline\n * await processRSVPReminders(7);\n */\nexport async function processRSVPReminders(\n  daysBeforeDeadline: number = 7\n): Promise<Result<CronJobResult>> {\n  return executeCronJob('rsvp_deadline_reminders', async () => {\n    // Find guests needing reminders\n    const pendingResult = await findPendingRSVPs(daysBeforeDeadline);\n\n    if (!pendingResult.success) {\n      throw new Error(pendingResult.error.message);\n    }\n\n    const pendingGuests = pendingResult.data;\n    let sent = 0;\n    let failed = 0;\n\n    // Send reminder to each guest\n    for (const guest of pendingGuests) {\n      const reminderResult = await sendRSVPReminder(guest);\n\n      if (reminderResult.success) {\n        sent++;\n      } else {\n        failed++;\n        console.error(`Failed to send reminder to ${guest.guest_email}:`, reminderResult.error);\n      }\n    }\n\n    return {\n      itemsProcessed: sent,\n      itemsFailed: failed,\n    };\n  });\n}\n\n/**\n * Gets RSVP reminder statistics.\n * \n * @param since - Optional start date for statistics (ISO string)\n * @returns Result containing reminder statistics\n */\nexport async function getReminderStats(\n  since?: string\n): Promise<\n  Result<{\n    totalReminders: number;\n    remindersByEvent: Record<string, number>;\n    remindersByActivity: Record<string, number>;\n  }>\n> {\n  try {\n    const supabase = getSupabaseClient();\n    let query = supabase.from('rsvp_reminders_sent').select('*');\n\n    if (since) {\n      query = query.gte('sent_at', since);\n    }\n\n    const { data: reminders, error } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: 'Failed to fetch reminder statistics',\n          details: error,\n        },\n      };\n    }\n\n    const remindersByEvent: Record<string, number> = {};\n    const remindersByActivity: Record<string, number> = {};\n\n    for (const reminder of (reminders || []) as Array<{ event_id?: string; activity_id?: string }>) {\n      if (reminder.event_id) {\n        remindersByEvent[reminder.event_id] = (remindersByEvent[reminder.event_id] || 0) + 1;\n      }\n      if (reminder.activity_id) {\n        remindersByActivity[reminder.activity_id] = (remindersByActivity[reminder.activity_id] || 0) + 1;\n      }\n    }\n\n    return {\n      success: true,\n      data: {\n        totalReminders: reminders?.length || 0,\n        remindersByEvent,\n        remindersByActivity,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n"],"names":["__resetSupabaseClient","__setSupabaseClient","findPendingRSVPs","getReminderStats","processRSVPReminders","sendRSVPReminder","supabaseInstance","getSupabaseClient","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","client","daysBeforeDeadline","supabase","now","Date","reminderDate","setDate","getDate","data","events","error","eventsError","from","select","eq","not","gte","toISOString","split","lte","success","code","ERROR_CODES","DATABASE_ERROR","message","details","pendingGuests","event","guests","guestsError","guest","rsvps","rsvpError","id","length","some","r","status","deadline","rsvp_deadline","daysUntil","Math","ceil","getTime","push","guest_id","guest_name","first_name","last_name","guest_email","email","event_id","event_name","name","days_until_deadline","activities","activitiesError","activity","activity_id","activity_name","UNKNOWN_ERROR","Error","eventOrActivity","deadlineDate","toLocaleDateString","weekday","year","month","day","subject","html","NEXT_PUBLIC_APP_URL","text","emailResult","sendEmail","to","EMAIL_SERVICE_ERROR","insert","sent_at","days_before_deadline","undefined","executeCronJob","pendingResult","sent","failed","reminderResult","console","itemsProcessed","itemsFailed","since","query","reminders","remindersByEvent","remindersByActivity","reminder","totalReminders"],"mappings":"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"}