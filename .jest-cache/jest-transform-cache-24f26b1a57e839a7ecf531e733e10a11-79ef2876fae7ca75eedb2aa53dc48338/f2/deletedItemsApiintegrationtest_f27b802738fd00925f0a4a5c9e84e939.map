{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/__tests__/integration/deletedItemsApi.integration.test.ts"],"sourcesContent":["/**\n * Integration Tests: Deleted Items API\n * \n * Tests deleted items API routes with real database operations.\n */\n\nimport { createClient } from '@supabase/supabase-js';\nimport { createContentPage, deleteContentPage } from '../../services/contentPagesService';\nimport { create as createEvent, deleteEvent } from '../../services/eventService';\nimport { create as createActivity, deleteActivity } from '../../services/activityService';\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ndescribe('Deleted Items API Integration Tests', () => {\n  beforeEach(async () => {\n    // Clean up test data\n    await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  afterAll(async () => {\n    // Final cleanup\n    await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  describe('GET /api/admin/deleted-items', () => {\n    it('should return all soft-deleted items', async () => {\n      // Create and soft delete items\n      const pageResult = await createContentPage({\n        title: 'Test Page',\n        status: 'draft',\n      });\n      expect(pageResult.success).toBe(true);\n      if (!pageResult.success) return;\n\n      await deleteContentPage(pageResult.data.id, { permanent: false });\n\n      const eventResult = await createEvent({\n        name: 'Test Event',\n        date: new Date().toISOString().split('T')[0],\n      });\n      expect(eventResult.success).toBe(true);\n      if (!eventResult.success) return;\n\n      await deleteEvent(eventResult.data.id, { permanent: false });\n\n      // Query deleted items\n      const { data: pages } = await supabase\n        .from('content_pages')\n        .select('id, title, deleted_at')\n        .not('deleted_at', 'is', null);\n\n      const { data: events } = await supabase\n        .from('events')\n        .select('id, name, deleted_at')\n        .not('deleted_at', 'is', null);\n\n      expect(pages).toHaveLength(1);\n      expect(events).toHaveLength(1);\n      expect(pages?.[0].title).toBe('Test Page');\n      expect(events?.[0].name).toBe('Test Event');\n\n      // Cleanup\n      await deleteContentPage(pageResult.data.id, { permanent: true });\n      await deleteEvent(eventResult.data.id, { permanent: true });\n    });\n\n    it('should filter deleted items by type', async () => {\n      // Create and soft delete items\n      const pageResult = await createContentPage({\n        title: 'Test Page',\n        status: 'draft',\n      });\n      expect(pageResult.success).toBe(true);\n      if (!pageResult.success) return;\n\n      await deleteContentPage(pageResult.data.id, { permanent: false });\n\n      const eventResult = await createEvent({\n        name: 'Test Event',\n        date: new Date().toISOString().split('T')[0],\n      });\n      expect(eventResult.success).toBe(true);\n      if (!eventResult.success) return;\n\n      await deleteEvent(eventResult.data.id, { permanent: false });\n\n      // Query only content pages\n      const { data: pages } = await supabase\n        .from('content_pages')\n        .select('id, title, deleted_at')\n        .not('deleted_at', 'is', null);\n\n      expect(pages).toHaveLength(1);\n      expect(pages?.[0].title).toBe('Test Page');\n\n      // Cleanup\n      await deleteContentPage(pageResult.data.id, { permanent: true });\n      await deleteEvent(eventResult.data.id, { permanent: true });\n    });\n  });\n\n  describe('POST /api/admin/deleted-items/[id]/restore', () => {\n    it('should restore soft-deleted content page', async () => {\n      // Create and soft delete\n      const createResult = await createContentPage({\n        title: 'Test Page',\n        status: 'draft',\n      });\n      expect(createResult.success).toBe(true);\n      if (!createResult.success) return;\n\n      const pageId = createResult.data.id;\n      await deleteContentPage(pageId, { permanent: false });\n\n      // Verify soft deleted\n      const { data: deletedPage } = await supabase\n        .from('content_pages')\n        .select('deleted_at')\n        .eq('id', pageId)\n        .single();\n\n      expect(deletedPage?.deleted_at).not.toBeNull();\n\n      // Restore via service (simulating API call)\n      const { restoreContentPage } = await import('../../services/contentPagesService');\n      const restoreResult = await restoreContentPage(pageId);\n      expect(restoreResult.success).toBe(true);\n\n      // Verify restored\n      const { data: restoredPage } = await supabase\n        .from('content_pages')\n        .select('deleted_at')\n        .eq('id', pageId)\n        .single();\n\n      expect(restoredPage?.deleted_at).toBeNull();\n\n      // Cleanup\n      await deleteContentPage(pageId, { permanent: true });\n    });\n\n    it('should restore soft-deleted event', async () => {\n      // Create and soft delete\n      const createResult = await createEvent({\n        name: 'Test Event',\n        date: new Date().toISOString().split('T')[0],\n      });\n      expect(createResult.success).toBe(true);\n      if (!createResult.success) return;\n\n      const eventId = createResult.data.id;\n      await deleteEvent(eventId, { permanent: false });\n\n      // Verify soft deleted\n      const { data: deletedEvent } = await supabase\n        .from('events')\n        .select('deleted_at')\n        .eq('id', eventId)\n        .single();\n\n      expect(deletedEvent?.deleted_at).not.toBeNull();\n\n      // Restore via service (simulating API call)\n      const { restoreEvent } = await import('../../services/eventService');\n      const restoreResult = await restoreEvent(eventId);\n      expect(restoreResult.success).toBe(true);\n\n      // Verify restored\n      const { data: restoredEvent } = await supabase\n        .from('events')\n        .select('deleted_at')\n        .eq('id', eventId)\n        .single();\n\n      expect(restoredEvent?.deleted_at).toBeNull();\n\n      // Cleanup\n      await deleteEvent(eventId, { permanent: true });\n    });\n  });\n\n  describe('DELETE /api/admin/deleted-items/[id]/permanent', () => {\n    it('should permanently delete soft-deleted content page', async () => {\n      // Create and soft delete\n      const createResult = await createContentPage({\n        title: 'Test Page',\n        status: 'draft',\n      });\n      expect(createResult.success).toBe(true);\n      if (!createResult.success) return;\n\n      const pageId = createResult.data.id;\n      await deleteContentPage(pageId, { permanent: false });\n\n      // Verify soft deleted\n      const { data: deletedPage } = await supabase\n        .from('content_pages')\n        .select('id')\n        .eq('id', pageId)\n        .single();\n\n      expect(deletedPage).not.toBeNull();\n\n      // Permanently delete\n      await deleteContentPage(pageId, { permanent: true });\n\n      // Verify permanently deleted\n      const { data: permanentlyDeleted } = await supabase\n        .from('content_pages')\n        .select('id')\n        .eq('id', pageId)\n        .single();\n\n      expect(permanentlyDeleted).toBeNull();\n    });\n\n    it('should permanently delete soft-deleted event', async () => {\n      // Create and soft delete\n      const createResult = await createEvent({\n        name: 'Test Event',\n        date: new Date().toISOString().split('T')[0],\n      });\n      expect(createResult.success).toBe(true);\n      if (!createResult.success) return;\n\n      const eventId = createResult.data.id;\n      await deleteEvent(eventId, { permanent: false });\n\n      // Verify soft deleted\n      const { data: deletedEvent } = await supabase\n        .from('events')\n        .select('id')\n        .eq('id', eventId)\n        .single();\n\n      expect(deletedEvent).not.toBeNull();\n\n      // Permanently delete\n      await deleteEvent(eventId, { permanent: true });\n\n      // Verify permanently deleted\n      const { data: permanentlyDeleted } = await supabase\n        .from('events')\n        .select('id')\n        .eq('id', eventId)\n        .single();\n\n      expect(permanentlyDeleted).toBeNull();\n    });\n  });\n});\n"],"names":["supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","describe","beforeEach","from","delete","neq","afterAll","it","pageResult","createContentPage","title","status","expect","success","toBe","deleteContentPage","data","id","permanent","eventResult","createEvent","name","date","Date","toISOString","split","deleteEvent","pages","select","not","events","toHaveLength","createResult","pageId","deletedPage","eq","single","deleted_at","toBeNull","restoreContentPage","restoreResult","restoredPage","eventId","deletedEvent","restoreEvent","restoredEvent","permanentlyDeleted"],"mappings":"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"}