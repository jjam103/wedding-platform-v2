{"version":3,"names":["GET","request","params","cov_1hqfg21hkf","f","s","slug","supabase","_authhelpersnextjs","createRouteHandlerClient","cookies","_headers","data","session","error","authError","auth","getSession","b","_server","NextResponse","json","success","code","message","status","guest","guestError","from","select","eq","user","email","single","slugValidation","_zod","z","string","min","safeParse","activityResult","_activityService","getBySlug","rsvpResult","_rsvpService","list","guest_id","id","activity_id","page","page_size","rsvpStatus","rsvps","length","attendingRsvps","currentAttendees","reduce","sum","rsvp","guest_count","capacityRemaining","capacity","netCost","costPerPerson","Math","max","hostSubsidy","capacityPercentage","isFull","isAlmostFull","console","path","url"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/guest/activities/[slug]/route.ts"],"sourcesContent":["import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\nimport * as activityService from '@/services/activityService';\nimport * as rsvpService from '@/services/rsvpService';\nimport { z } from 'zod';\n\n/**\n * GET /api/guest/activities/[slug]\n * \n * Gets a single activity by slug with RSVP status and capacity info.\n * \n * Requirements: 9.3, 9.4\n */\nexport async function GET(\n  request: Request,\n  { params }: { params: Promise<{ slug: string }> }\n) {\n  try {\n    // Await params for Next.js 15+\n    const { slug } = await params;\n    \n    // 1. AUTHENTICATION\n    const supabase = createRouteHandlerClient({ cookies });\n    const { data: { session }, error: authError } = await supabase.auth.getSession();\n    \n    if (authError || !session) {\n      return NextResponse.json(\n        { success: false, error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },\n        { status: 401 }\n      );\n    }\n    \n    // Get guest ID from session\n    const { data: guest, error: guestError } = await supabase\n      .from('guests')\n      .select('id, group_id')\n      .eq('email', session.user.email)\n      .single();\n    \n    if (guestError || !guest) {\n      return NextResponse.json(\n        { success: false, error: { code: 'NOT_FOUND', message: 'Guest not found' } },\n        { status: 404 }\n      );\n    }\n    \n    // 2. VALIDATION\n    const slugValidation = z.string().min(1).safeParse(slug);\n    \n    if (!slugValidation.success) {\n      return NextResponse.json(\n        { success: false, error: { code: 'VALIDATION_ERROR', message: 'Invalid slug' } },\n        { status: 400 }\n      );\n    }\n    \n    // 3. SERVICE CALL - Get activity by slug\n    const activityResult = await activityService.getBySlug(slugValidation.data);\n    \n    if (!activityResult.success) {\n      return NextResponse.json(activityResult, { status: 404 });\n    }\n    \n    // Get RSVP status for this activity\n    const rsvpResult = await rsvpService.list({\n      guest_id: guest.id,\n      activity_id: activityResult.data.id,\n      page: 1,\n      page_size: 1\n    });\n    \n    const rsvpStatus = rsvpResult.success && rsvpResult.data.rsvps.length > 0\n      ? rsvpResult.data.rsvps[0].status\n      : 'pending';\n    \n    // Get current attendee count from RSVPs\n    const { data: attendingRsvps } = await supabase\n      .from('rsvps')\n      .select('guest_count')\n      .eq('activity_id', activityResult.data.id)\n      .eq('status', 'attending');\n    \n    const currentAttendees = attendingRsvps\n      ? attendingRsvps.reduce((sum, rsvp) => sum + (rsvp.guest_count || 1), 0)\n      : 0;\n    \n    // Calculate capacity remaining\n    const capacityRemaining = activityResult.data.capacity\n      ? activityResult.data.capacity - currentAttendees\n      : null;\n    \n    // Calculate net cost (cost per person - host subsidy)\n    const netCost = activityResult.data.costPerPerson\n      ? Math.max(0, activityResult.data.costPerPerson - (activityResult.data.hostSubsidy || 0))\n      : 0;\n    \n    // Calculate capacity percentage\n    const capacityPercentage = activityResult.data.capacity\n      ? (currentAttendees / activityResult.data.capacity) * 100\n      : 0;\n    \n    // 4. RESPONSE\n    return NextResponse.json({\n      success: true,\n      data: {\n        ...activityResult.data,\n        rsvpStatus,\n        capacityRemaining,\n        capacityPercentage,\n        netCost,\n        isFull: capacityRemaining !== null && capacityRemaining <= 0,\n        isAlmostFull: capacityPercentage >= 90,\n      },\n    });\n    \n  } catch (error) {\n    console.error('API Error:', { path: request.url, error });\n    return NextResponse.json(\n      { success: false, error: { code: 'INTERNAL_ERROR', message: 'An unexpected error occurred' } },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}