{"version":3,"names":["POST","request","cov_2g1ff2h6r","f","s","userId","email","role","json","b","_server","NextResponse","error","status","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","supabaseSecretKey","SUPABASE_SECRET_KEY","console","createClient","Promise","resolve","then","_interop_require_wildcard","require","supabaseAdmin","auth","autoRefreshToken","persistSession","setTimeout","data","authUser","authError","admin","getUserById","retryAuthUser","retryAuthError","insertError","from","insert","id","details","message","success"],"sources":["/Users/jaron/Desktop/wedding-platform-v2/app/api/auth/create-user/route.ts"],"sourcesContent":["import { createAuthenticatedClient } from '@/lib/supabaseServer';\nimport { NextResponse } from 'next/server';\n\nexport async function POST(request: Request) {\n  try {\n    const { userId, email, role } = await request.json();\n\n    if (!userId || !email || !role) {\n      return NextResponse.json(\n        { error: 'Missing required fields' },\n        { status: 400 }\n      );\n    }\n\n    // Create Supabase client with secret key to bypass RLS\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n    const supabaseSecretKey = process.env.SUPABASE_SECRET_KEY;\n\n    if (!supabaseUrl || !supabaseSecretKey) {\n      console.error('Missing Supabase environment variables');\n      return NextResponse.json(\n        { error: 'Server configuration error' },\n        { status: 500 }\n      );\n    }\n\n    // Use secret key client to bypass RLS\n    const { createClient } = await import('@supabase/supabase-js');\n    const supabaseAdmin = createClient(supabaseUrl, supabaseSecretKey, {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    });\n\n    // Wait a moment for auth.users to be created\n    await new Promise(resolve => setTimeout(resolve, 1000));\n\n    // Verify user exists in auth.users first\n    const { data: authUser, error: authError } = await supabaseAdmin.auth.admin.getUserById(userId);\n    \n    if (authError || !authUser) {\n      console.error('User not found in auth.users:', authError);\n      // Try again after another delay\n      await new Promise(resolve => setTimeout(resolve, 2000));\n      const { data: retryAuthUser, error: retryAuthError } = await supabaseAdmin.auth.admin.getUserById(userId);\n      \n      if (retryAuthError || !retryAuthUser) {\n        return NextResponse.json(\n          { error: 'User not found in authentication system' },\n          { status: 404 }\n        );\n      }\n    }\n\n    // Insert user record\n    const { error: insertError } = await supabaseAdmin\n      .from('users')\n      .insert({\n        id: userId,\n        email: email,\n        role: role,\n      });\n\n    if (insertError) {\n      console.error('Error inserting user:', insertError);\n      return NextResponse.json(\n        { error: 'Failed to create user record', details: insertError.message },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({ success: true });\n  } catch (error) {\n    console.error('Unexpected error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}