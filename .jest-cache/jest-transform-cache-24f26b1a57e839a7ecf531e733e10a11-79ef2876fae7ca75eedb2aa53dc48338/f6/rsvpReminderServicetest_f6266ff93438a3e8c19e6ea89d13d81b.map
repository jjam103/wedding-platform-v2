{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/rsvpReminderService.test.ts"],"sourcesContent":["// Set up environment variables for tests\nprocess.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';\nprocess.env.SUPABASE_SERVICE_ROLE_KEY = 'test-service-role-key';\nprocess.env.NEXT_PUBLIC_APP_URL = 'https://test.example.com';\n\n// Mock email service\njest.mock('./emailService', () => ({\n  sendEmail: jest.fn(),\n}));\n\n// Mock cron service\njest.mock('./cronService', () => ({\n  executeCronJob: jest.fn((jobType: string, jobFunction: () => any) => jobFunction()),\n}));\n\n// Import after mocks are set up\nimport { findPendingRSVPs, sendRSVPReminder, __setSupabaseClient, __resetSupabaseClient } from './rsvpReminderService';\nimport * as emailService from './emailService';\n\n/**\n * Unit test for automated RSVP reminders\n * Validates: Requirements 23.3\n * \n * Tests that deadline approaching triggers reminder\n */\ndescribe('rsvpReminderService - Automated RSVP Reminders', () => {\n  let mockFromFn: jest.Mock;\n  \n  beforeEach(() => {\n    jest.clearAllMocks();\n    \n    // Set up the mock Supabase client\n    mockFromFn = jest.fn();\n    const mockSupabaseClient = {\n      from: mockFromFn,\n    };\n    \n    // Inject the mock client into the service\n    __setSupabaseClient(mockSupabaseClient as any);\n  });\n  \n  afterEach(() => {\n    __resetSupabaseClient();\n  });\n\n  describe('deadline approaching triggers reminder', () => {\n    it('should trigger reminder when deadline is within threshold', async () => {\n      // Setup: Event with deadline 5 days away (within 7-day threshold)\n      const futureDate = new Date();\n      futureDate.setDate(futureDate.getDate() + 5);\n      const deadlineStr = futureDate.toISOString().split('T')[0];\n\n      // Mock events query - needs to chain: select().eq().not().gte().lte().eq()\n      const mockEventsQuery = {\n        select: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockReturnThis(),\n        not: jest.fn().mockReturnThis(),\n        gte: jest.fn().mockReturnThis(),\n        lte: jest.fn().mockReturnThis(),\n      };\n      // The second eq() call (after lte) should resolve with data\n      (mockEventsQuery.eq as jest.Mock).mockReturnValueOnce(mockEventsQuery).mockResolvedValueOnce({\n        data: [\n          {\n            id: 'event-1',\n            name: 'Wedding Ceremony',\n            rsvp_deadline: deadlineStr,\n          },\n        ],\n        error: null,\n      });\n\n      // Mock guests query - needs to chain: select().not().eq()\n      const mockGuestsQuery = {\n        select: jest.fn().mockReturnThis(),\n        not: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockResolvedValue({\n          data: [\n            {\n              id: 'guest-1',\n              first_name: 'John',\n              last_name: 'Doe',\n              email: 'john@example.com',\n            },\n          ],\n          error: null,\n        }),\n      };\n\n      // Mock RSVPs query (no existing RSVP) - needs to chain: select().eq().eq()\n      const mockRsvpsQuery = {\n        select: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockReturnThis(),\n      };\n      // The second eq() call should resolve with empty data\n      (mockRsvpsQuery.eq as jest.Mock).mockReturnValueOnce(mockRsvpsQuery).mockResolvedValueOnce({\n        data: [],\n        error: null,\n      });\n\n      // Mock activities query - needs to chain: select().eq()\n      const mockActivitiesQuery = {\n        select: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockResolvedValue({\n          data: [],\n          error: null,\n        }),\n      };\n\n      // Set up the from() mock to return the right query chain in order\n      mockFromFn\n        .mockReturnValueOnce(mockEventsQuery)  // First call: events query\n        .mockReturnValueOnce(mockGuestsQuery)  // Second call: guests query\n        .mockReturnValueOnce(mockRsvpsQuery)   // Third call: rsvps query\n        .mockReturnValueOnce(mockActivitiesQuery); // Fourth call: activities query\n\n      // Act: Find pending RSVPs with 7-day threshold\n      const result = await findPendingRSVPs(7);\n\n      // Assert: Guest should be included in reminder list\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.length).toBe(1);\n        expect(result.data[0].guest_id).toBe('guest-1');\n        expect(result.data[0].guest_name).toBe('John Doe');\n        expect(result.data[0].event_name).toBe('Wedding Ceremony');\n        expect(result.data[0].days_until_deadline).toBeGreaterThanOrEqual(4);\n        expect(result.data[0].days_until_deadline).toBeLessThanOrEqual(6);\n      }\n    });\n\n    it('should not trigger reminder when deadline is beyond threshold', async () => {\n      // Setup: Event with deadline 10 days away (beyond 7-day threshold)\n      const futureDate = new Date();\n      futureDate.setDate(futureDate.getDate() + 10);\n      const deadlineStr = futureDate.toISOString().split('T')[0];\n\n      // Mock events query - should return empty because deadline is too far\n      const mockEventsQuery = {\n        select: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockReturnThis(),\n        not: jest.fn().mockReturnThis(),\n        gte: jest.fn().mockReturnThis(),\n        lte: jest.fn().mockReturnThis(),\n      };\n      // The second eq() call (after lte) should resolve with empty data\n      (mockEventsQuery.eq as jest.Mock).mockReturnValueOnce(mockEventsQuery).mockResolvedValueOnce({\n        data: [], // No events within threshold\n        error: null,\n      });\n\n      // Mock activities query\n      const mockActivitiesQuery = {\n        select: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockResolvedValue({\n          data: [],\n          error: null,\n        }),\n      };\n\n      mockFromFn\n        .mockReturnValueOnce(mockEventsQuery)\n        .mockReturnValueOnce(mockActivitiesQuery);\n\n      // Act: Find pending RSVPs with 7-day threshold\n      const result = await findPendingRSVPs(7);\n\n      // Assert: No guests should be included (deadline too far away)\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.length).toBe(0);\n      }\n    });\n\n    it('should not trigger reminder when guest has already responded', async () => {\n      // Setup: Event with deadline 5 days away\n      const futureDate = new Date();\n      futureDate.setDate(futureDate.getDate() + 5);\n      const deadlineStr = futureDate.toISOString().split('T')[0];\n\n      // Mock events query\n      const mockEventsQuery = {\n        select: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockReturnThis(),\n        not: jest.fn().mockReturnThis(),\n        gte: jest.fn().mockReturnThis(),\n        lte: jest.fn().mockReturnThis(),\n      };\n      // The second eq() call (after lte) should resolve with data\n      (mockEventsQuery.eq as jest.Mock).mockReturnValueOnce(mockEventsQuery).mockResolvedValueOnce({\n        data: [\n          {\n            id: 'event-1',\n            name: 'Wedding Ceremony',\n            rsvp_deadline: deadlineStr,\n          },\n        ],\n        error: null,\n      });\n\n      // Mock guests query\n      const mockGuestsQuery = {\n        select: jest.fn().mockReturnThis(),\n        not: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockResolvedValue({\n          data: [\n            {\n              id: 'guest-1',\n              first_name: 'John',\n              last_name: 'Doe',\n              email: 'john@example.com',\n            },\n          ],\n          error: null,\n        }),\n      };\n\n      // Mock RSVPs query (guest already responded with 'attending')\n      const mockRsvpsQuery = {\n        select: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockReturnThis(),\n      };\n      // The second eq() call should resolve with attending status\n      (mockRsvpsQuery.eq as jest.Mock).mockReturnValueOnce(mockRsvpsQuery).mockResolvedValueOnce({\n        data: [{ status: 'attending' }],\n        error: null,\n      });\n\n      // Mock activities query\n      const mockActivitiesQuery = {\n        select: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockResolvedValue({\n          data: [],\n          error: null,\n        }),\n      };\n\n      mockFromFn\n        .mockReturnValueOnce(mockEventsQuery)\n        .mockReturnValueOnce(mockGuestsQuery)\n        .mockReturnValueOnce(mockRsvpsQuery)\n        .mockReturnValueOnce(mockActivitiesQuery);\n\n      // Act: Find pending RSVPs\n      const result = await findPendingRSVPs(7);\n\n      // Assert: No guests should be included (already responded)\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.length).toBe(0);\n      }\n    });\n\n    it('should send reminder email when deadline is approaching', async () => {\n      const guest = {\n        guest_id: 'guest-1',\n        guest_name: 'John Doe',\n        guest_email: 'john@example.com',\n        event_id: 'event-1',\n        event_name: 'Wedding Ceremony',\n        deadline: '2025-02-15',\n        days_until_deadline: 7,\n      };\n\n      // Mock successful email send\n      (emailService.sendEmail as jest.Mock).mockResolvedValue({\n        success: true,\n        data: { id: 'email-123' },\n      });\n\n      // Mock database insert for logging - needs to chain: insert()\n      const mockInsertQuery = {\n        insert: jest.fn().mockResolvedValue({\n          data: { id: 'reminder-1' },\n          error: null,\n        }),\n      };\n\n      mockFromFn.mockReturnValue(mockInsertQuery);\n\n      // Act: Send reminder\n      const result = await sendRSVPReminder(guest);\n\n      // Assert: Reminder should be sent successfully\n      expect(result.success).toBe(true);\n      expect(emailService.sendEmail).toHaveBeenCalledWith(\n        expect.objectContaining({\n          to: 'john@example.com',\n          subject: expect.stringContaining('RSVP Reminder'),\n          subject: expect.stringContaining('Wedding Ceremony'),\n          subject: expect.stringContaining('7 days left'),\n        })\n      );\n    });\n  });\n});\n\n"],"names":["jest","mock","sendEmail","fn","executeCronJob","jobType","jobFunction","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","NEXT_PUBLIC_APP_URL","describe","mockFromFn","beforeEach","clearAllMocks","mockSupabaseClient","from","__setSupabaseClient","afterEach","__resetSupabaseClient","it","futureDate","Date","setDate","getDate","deadlineStr","toISOString","split","mockEventsQuery","select","mockReturnThis","eq","not","gte","lte","mockReturnValueOnce","mockResolvedValueOnce","data","id","name","rsvp_deadline","error","mockGuestsQuery","mockResolvedValue","first_name","last_name","email","mockRsvpsQuery","mockActivitiesQuery","result","findPendingRSVPs","expect","success","toBe","length","guest_id","guest_name","event_name","days_until_deadline","toBeGreaterThanOrEqual","toBeLessThanOrEqual","status","guest","guest_email","event_id","deadline","emailService","mockInsertQuery","insert","mockReturnValue","sendRSVPReminder","toHaveBeenCalledWith","objectContaining","to","subject","stringContaining"],"mappings":"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"}