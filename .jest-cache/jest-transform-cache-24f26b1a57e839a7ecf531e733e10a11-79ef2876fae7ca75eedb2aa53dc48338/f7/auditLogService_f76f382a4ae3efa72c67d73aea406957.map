{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/auditLogService.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport type { SupabaseClient } from '@supabase/supabase-js';\n\n/**\n * Result type for consistent error handling\n */\ntype Result<T> =\n  | { success: true; data: T }\n  | { success: false; error: { code: string; message: string; details?: unknown } };\n\n/**\n * Audit log entry structure\n */\nexport interface AuditLog {\n  id: string;\n  user_id: string | null;\n  user_email: string | null;\n  entity_type: string;\n  entity_id: string;\n  operation_type: 'create' | 'update' | 'delete';\n  old_data: Record<string, unknown> | null;\n  new_data: Record<string, unknown> | null;\n  ip_address: string | null;\n  user_agent: string | null;\n  created_at: string;\n}\n\n/**\n * Input for creating an audit log entry\n */\nexport interface CreateAuditLogInput {\n  user_id?: string | null;\n  user_email?: string | null;\n  entity_type: string;\n  entity_id: string;\n  operation_type: 'create' | 'update' | 'delete';\n  old_data?: Record<string, unknown> | null;\n  new_data?: Record<string, unknown> | null;\n  ip_address?: string | null;\n  user_agent?: string | null;\n}\n\n/**\n * Filters for querying audit logs\n */\nexport interface AuditLogFilters {\n  user_id?: string;\n  entity_type?: string;\n  entity_id?: string;\n  operation_type?: 'create' | 'update' | 'delete';\n  start_date?: Date;\n  end_date?: Date;\n  page?: number;\n  page_size?: number;\n}\n\n/**\n * Paginated audit log results\n */\nexport interface PaginatedAuditLogs {\n  logs: AuditLog[];\n  total: number;\n  page: number;\n  page_size: number;\n  total_pages: number;\n}\n\n/**\n * Creates an audit log entry for a data modification operation.\n * \n * @param supabase - Supabase client instance\n * @param input - Audit log data\n * @returns Result containing the created audit log or error details\n * \n * @example\n * const result = await auditLogService.create(supabase, {\n *   user_id: 'user-123',\n *   user_email: 'admin@example.com',\n *   entity_type: 'guest',\n *   entity_id: 'guest-456',\n *   operation_type: 'update',\n *   old_data: { first_name: 'John' },\n *   new_data: { first_name: 'Jane' },\n * });\n */\nexport async function create(\n  supabase: SupabaseClient,\n  input: CreateAuditLogInput\n): Promise<Result<AuditLog>> {\n  try {\n    // Validate required fields\n    if (!input.entity_type || !input.entity_id || !input.operation_type) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Missing required fields: entity_type, entity_id, and operation_type are required',\n        },\n      };\n    }\n\n    // Validate operation_type\n    if (!['create', 'update', 'delete'].includes(input.operation_type)) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid operation_type. Must be one of: create, update, delete',\n        },\n      };\n    }\n\n    // Insert audit log\n    const { data, error } = await supabase\n      .from('audit_logs')\n      .insert({\n        user_id: input.user_id || null,\n        user_email: input.user_email || null,\n        entity_type: input.entity_type,\n        entity_id: input.entity_id,\n        operation_type: input.operation_type,\n        old_data: input.old_data || null,\n        new_data: input.new_data || null,\n        ip_address: input.ip_address || null,\n        user_agent: input.user_agent || null,\n      })\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: 'Failed to create audit log',\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: data as AuditLog };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Retrieves audit logs with optional filtering and pagination.\n * Only accessible to super admins via RLS policies.\n * \n * @param supabase - Supabase client instance\n * @param filters - Optional filters for querying audit logs\n * @returns Result containing paginated audit logs or error details\n * \n * @example\n * const result = await auditLogService.list(supabase, {\n *   entity_type: 'guest',\n *   operation_type: 'update',\n *   page: 1,\n *   page_size: 50,\n * });\n */\nexport async function list(\n  supabase: SupabaseClient,\n  filters: AuditLogFilters = {}\n): Promise<Result<PaginatedAuditLogs>> {\n  try {\n    const page = filters.page || 1;\n    const page_size = filters.page_size || 50;\n    const from = (page - 1) * page_size;\n    const to = from + page_size - 1;\n\n    // Build query\n    let query = supabase\n      .from('audit_logs')\n      .select('*', { count: 'exact' });\n\n    // Apply filters\n    if (filters.user_id) {\n      query = query.eq('user_id', filters.user_id);\n    }\n    if (filters.entity_type) {\n      query = query.eq('entity_type', filters.entity_type);\n    }\n    if (filters.entity_id) {\n      query = query.eq('entity_id', filters.entity_id);\n    }\n    if (filters.operation_type) {\n      query = query.eq('operation_type', filters.operation_type);\n    }\n    if (filters.start_date) {\n      query = query.gte('created_at', filters.start_date.toISOString());\n    }\n    if (filters.end_date) {\n      query = query.lte('created_at', filters.end_date.toISOString());\n    }\n\n    // Apply pagination and ordering\n    query = query\n      .order('created_at', { ascending: false })\n      .range(from, to);\n\n    const { data, error, count } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: 'Failed to retrieve audit logs',\n          details: error,\n        },\n      };\n    }\n\n    const total = count || 0;\n    const total_pages = Math.ceil(total / page_size);\n\n    return {\n      success: true,\n      data: {\n        logs: (data as AuditLog[]) || [],\n        total,\n        page,\n        page_size,\n        total_pages,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Retrieves a single audit log entry by ID.\n * Only accessible to super admins via RLS policies.\n * \n * @param supabase - Supabase client instance\n * @param id - Audit log ID\n * @returns Result containing the audit log or error details\n */\nexport async function get(\n  supabase: SupabaseClient,\n  id: string\n): Promise<Result<AuditLog>> {\n  try {\n    const { data, error } = await supabase\n      .from('audit_logs')\n      .select('*')\n      .eq('id', id)\n      .single();\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        return {\n          success: false,\n          error: {\n            code: 'NOT_FOUND',\n            message: 'Audit log not found',\n          },\n        };\n      }\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: 'Failed to retrieve audit log',\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: data as AuditLog };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error occurred',\n      },\n    };\n  }\n}\n\n/**\n * Helper function to log a create operation.\n * \n * @param supabase - Supabase client instance\n * @param entity_type - Type of entity (e.g., 'guest', 'event', 'activity')\n * @param entity_id - ID of the created entity\n * @param new_data - The created entity data\n * @param user_id - Optional user ID\n * @param user_email - Optional user email\n * @returns Result containing the created audit log or error details\n */\nexport async function logCreate(\n  supabase: SupabaseClient,\n  entity_type: string,\n  entity_id: string,\n  new_data: Record<string, unknown>,\n  user_id?: string,\n  user_email?: string\n): Promise<Result<AuditLog>> {\n  return create(supabase, {\n    user_id,\n    user_email,\n    entity_type,\n    entity_id,\n    operation_type: 'create',\n    new_data,\n  });\n}\n\n/**\n * Helper function to log an update operation.\n * \n * @param supabase - Supabase client instance\n * @param entity_type - Type of entity (e.g., 'guest', 'event', 'activity')\n * @param entity_id - ID of the updated entity\n * @param old_data - The entity data before update\n * @param new_data - The entity data after update\n * @param user_id - Optional user ID\n * @param user_email - Optional user email\n * @returns Result containing the created audit log or error details\n */\nexport async function logUpdate(\n  supabase: SupabaseClient,\n  entity_type: string,\n  entity_id: string,\n  old_data: Record<string, unknown>,\n  new_data: Record<string, unknown>,\n  user_id?: string,\n  user_email?: string\n): Promise<Result<AuditLog>> {\n  return create(supabase, {\n    user_id,\n    user_email,\n    entity_type,\n    entity_id,\n    operation_type: 'update',\n    old_data,\n    new_data,\n  });\n}\n\n/**\n * Helper function to log a delete operation.\n * \n * @param supabase - Supabase client instance\n * @param entity_type - Type of entity (e.g., 'guest', 'event', 'activity')\n * @param entity_id - ID of the deleted entity\n * @param old_data - The entity data before deletion\n * @param user_id - Optional user ID\n * @param user_email - Optional user email\n * @returns Result containing the created audit log or error details\n */\nexport async function logDelete(\n  supabase: SupabaseClient,\n  entity_type: string,\n  entity_id: string,\n  old_data: Record<string, unknown>,\n  user_id?: string,\n  user_email?: string\n): Promise<Result<AuditLog>> {\n  return create(supabase, {\n    user_id,\n    user_email,\n    entity_type,\n    entity_id,\n    operation_type: 'delete',\n    old_data,\n  });\n}\n\nexport const auditLogService = {\n  create,\n  list,\n  get,\n  logCreate,\n  logUpdate,\n  logDelete,\n};\n"],"names":["auditLogService","create","get","list","logCreate","logDelete","logUpdate","supabase","input","entity_type","entity_id","operation_type","success","error","code","message","includes","data","from","insert","user_id","user_email","old_data","new_data","ip_address","user_agent","select","single","details","Error","filters","page","page_size","to","query","count","eq","start_date","gte","toISOString","end_date","lte","order","ascending","range","total","total_pages","Math","ceil","logs","id"],"mappings":";;;;;;;;;;;QAkYaA;eAAAA;;QA7SSC;eAAAA;;QAwKAC;eAAAA;;QArFAC;eAAAA;;QA2IAC;eAAAA;;QA6DAC;eAAAA;;QA/BAC;eAAAA;;;AA5Pf,eAAeL,OACpBM,QAAwB,EACxBC,KAA0B;IAE1B,IAAI;QACF,2BAA2B;QAC3B,IAAI,CAACA,MAAMC,WAAW,IAAI,CAACD,MAAME,SAAS,IAAI,CAACF,MAAMG,cAAc,EAAE;YACnE,OAAO;gBACLC,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;gBACX;YACF;QACF;QAEA,0BAA0B;QAC1B,IAAI,CAAC;YAAC;YAAU;YAAU;SAAS,CAACC,QAAQ,CAACR,MAAMG,cAAc,GAAG;YAClE,OAAO;gBACLC,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;gBACX;YACF;QACF;QAEA,mBAAmB;QACnB,MAAM,EAAEE,IAAI,EAAEJ,KAAK,EAAE,GAAG,MAAMN,SAC3BW,IAAI,CAAC,cACLC,MAAM,CAAC;YACNC,SAASZ,MAAMY,OAAO,IAAI;YAC1BC,YAAYb,MAAMa,UAAU,IAAI;YAChCZ,aAAaD,MAAMC,WAAW;YAC9BC,WAAWF,MAAME,SAAS;YAC1BC,gBAAgBH,MAAMG,cAAc;YACpCW,UAAUd,MAAMc,QAAQ,IAAI;YAC5BC,UAAUf,MAAMe,QAAQ,IAAI;YAC5BC,YAAYhB,MAAMgB,UAAU,IAAI;YAChCC,YAAYjB,MAAMiB,UAAU,IAAI;QAClC,GACCC,MAAM,GACNC,MAAM;QAET,IAAId,OAAO;YACT,OAAO;gBACLD,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;oBACTa,SAASf;gBACX;YACF;QACF;QAEA,OAAO;YAAED,SAAS;YAAMK,MAAMA;QAAiB;IACjD,EAAE,OAAOJ,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAASF,iBAAiBgB,QAAQhB,MAAME,OAAO,GAAG;YACpD;QACF;IACF;AACF;AAkBO,eAAeZ,KACpBI,QAAwB,EACxBuB,UAA2B,CAAC,CAAC;IAE7B,IAAI;QACF,MAAMC,OAAOD,QAAQC,IAAI,IAAI;QAC7B,MAAMC,YAAYF,QAAQE,SAAS,IAAI;QACvC,MAAMd,OAAO,AAACa,CAAAA,OAAO,CAAA,IAAKC;QAC1B,MAAMC,KAAKf,OAAOc,YAAY;QAE9B,cAAc;QACd,IAAIE,QAAQ3B,SACTW,IAAI,CAAC,cACLQ,MAAM,CAAC,KAAK;YAAES,OAAO;QAAQ;QAEhC,gBAAgB;QAChB,IAAIL,QAAQV,OAAO,EAAE;YACnBc,QAAQA,MAAME,EAAE,CAAC,WAAWN,QAAQV,OAAO;QAC7C;QACA,IAAIU,QAAQrB,WAAW,EAAE;YACvByB,QAAQA,MAAME,EAAE,CAAC,eAAeN,QAAQrB,WAAW;QACrD;QACA,IAAIqB,QAAQpB,SAAS,EAAE;YACrBwB,QAAQA,MAAME,EAAE,CAAC,aAAaN,QAAQpB,SAAS;QACjD;QACA,IAAIoB,QAAQnB,cAAc,EAAE;YAC1BuB,QAAQA,MAAME,EAAE,CAAC,kBAAkBN,QAAQnB,cAAc;QAC3D;QACA,IAAImB,QAAQO,UAAU,EAAE;YACtBH,QAAQA,MAAMI,GAAG,CAAC,cAAcR,QAAQO,UAAU,CAACE,WAAW;QAChE;QACA,IAAIT,QAAQU,QAAQ,EAAE;YACpBN,QAAQA,MAAMO,GAAG,CAAC,cAAcX,QAAQU,QAAQ,CAACD,WAAW;QAC9D;QAEA,gCAAgC;QAChCL,QAAQA,MACLQ,KAAK,CAAC,cAAc;YAAEC,WAAW;QAAM,GACvCC,KAAK,CAAC1B,MAAMe;QAEf,MAAM,EAAEhB,IAAI,EAAEJ,KAAK,EAAEsB,KAAK,EAAE,GAAG,MAAMD;QAErC,IAAIrB,OAAO;YACT,OAAO;gBACLD,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;oBACTa,SAASf;gBACX;YACF;QACF;QAEA,MAAMgC,QAAQV,SAAS;QACvB,MAAMW,cAAcC,KAAKC,IAAI,CAACH,QAAQb;QAEtC,OAAO;YACLpB,SAAS;YACTK,MAAM;gBACJgC,MAAM,AAAChC,QAAuB,EAAE;gBAChC4B;gBACAd;gBACAC;gBACAc;YACF;QACF;IACF,EAAE,OAAOjC,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAASF,iBAAiBgB,QAAQhB,MAAME,OAAO,GAAG;YACpD;QACF;IACF;AACF;AAUO,eAAeb,IACpBK,QAAwB,EACxB2C,EAAU;IAEV,IAAI;QACF,MAAM,EAAEjC,IAAI,EAAEJ,KAAK,EAAE,GAAG,MAAMN,SAC3BW,IAAI,CAAC,cACLQ,MAAM,CAAC,KACPU,EAAE,CAAC,MAAMc,IACTvB,MAAM;QAET,IAAId,OAAO;YACT,IAAIA,MAAMC,IAAI,KAAK,YAAY;gBAC7B,OAAO;oBACLF,SAAS;oBACTC,OAAO;wBACLC,MAAM;wBACNC,SAAS;oBACX;gBACF;YACF;YACA,OAAO;gBACLH,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;oBACTa,SAASf;gBACX;YACF;QACF;QAEA,OAAO;YAAED,SAAS;YAAMK,MAAMA;QAAiB;IACjD,EAAE,OAAOJ,OAAO;QACd,OAAO;YACLD,SAAS;YACTC,OAAO;gBACLC,MAAM;gBACNC,SAASF,iBAAiBgB,QAAQhB,MAAME,OAAO,GAAG;YACpD;QACF;IACF;AACF;AAaO,eAAeX,UACpBG,QAAwB,EACxBE,WAAmB,EACnBC,SAAiB,EACjBa,QAAiC,EACjCH,OAAgB,EAChBC,UAAmB;IAEnB,OAAOpB,OAAOM,UAAU;QACtBa;QACAC;QACAZ;QACAC;QACAC,gBAAgB;QAChBY;IACF;AACF;AAcO,eAAejB,UACpBC,QAAwB,EACxBE,WAAmB,EACnBC,SAAiB,EACjBY,QAAiC,EACjCC,QAAiC,EACjCH,OAAgB,EAChBC,UAAmB;IAEnB,OAAOpB,OAAOM,UAAU;QACtBa;QACAC;QACAZ;QACAC;QACAC,gBAAgB;QAChBW;QACAC;IACF;AACF;AAaO,eAAelB,UACpBE,QAAwB,EACxBE,WAAmB,EACnBC,SAAiB,EACjBY,QAAiC,EACjCF,OAAgB,EAChBC,UAAmB;IAEnB,OAAOpB,OAAOM,UAAU;QACtBa;QACAC;QACAZ;QACAC;QACAC,gBAAgB;QAChBW;IACF;AACF;AAEO,MAAMtB,kBAAkB;IAC7BC;IACAE;IACAD;IACAE;IACAE;IACAD;AACF"}