{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/capacityReportService.ts"],"sourcesContent":["/**\n * Capacity Report Service\n * \n * Handles capacity utilization reporting for activities and accommodations.\n * \n * Requirements: 15.3\n */\n\nimport { createClient } from '@supabase/supabase-js';\nimport type { Result } from '@/types';\nimport { ERROR_CODES } from '@/types';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\nconst supabase = createClient(supabaseUrl, supabaseKey);\n\n/**\n * Activity capacity utilization data.\n */\nexport interface ActivityCapacityReport {\n  activityId: string;\n  activityName: string;\n  capacity: number | null;\n  currentAttendees: number;\n  utilizationRate: number; // Percentage (0-100)\n  availableSpots: number | null;\n  status: 'available' | 'near_capacity' | 'at_capacity' | 'over_capacity' | 'unlimited';\n}\n\n/**\n * Accommodation occupancy data.\n */\nexport interface AccommodationOccupancyReport {\n  accommodationId: string;\n  accommodationName: string;\n  roomTypes: Array<{\n    roomTypeId: string;\n    roomTypeName: string;\n    totalRooms: number;\n    assignedRooms: number;\n    occupancyRate: number; // Percentage (0-100)\n    availableRooms: number;\n  }>;\n  totalRooms: number;\n  totalAssigned: number;\n  overallOccupancyRate: number;\n}\n\n/**\n * Comprehensive capacity utilization report.\n */\nexport interface CapacityUtilizationReport {\n  activities: ActivityCapacityReport[];\n  accommodations: AccommodationOccupancyReport[];\n  summary: {\n    totalActivities: number;\n    activitiesNearCapacity: number;\n    activitiesAtCapacity: number;\n    totalAccommodations: number;\n    averageOccupancyRate: number;\n  };\n}\n\n/**\n * Generates activity capacity utilization report.\n * \n * @param activityId - Optional activity ID to get report for specific activity\n * @returns Result containing activity capacity reports or error details\n * \n * Requirements: 15.3\n */\nexport async function getActivityCapacityReport(\n  activityId?: string\n): Promise<Result<ActivityCapacityReport[]>> {\n  try {\n    // Build query\n    let query = supabase\n      .from('activities')\n      .select('id, name, capacity')\n      .eq('status', 'published');\n\n    if (activityId) {\n      query = query.eq('id', activityId);\n    }\n\n    const { data: activities, error: activityError } = await query;\n\n    if (activityError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: activityError.message,\n          details: activityError,\n        },\n      };\n    }\n\n    const reports: ActivityCapacityReport[] = [];\n\n    // Calculate utilization for each activity\n    for (const activity of activities) {\n      // Get current attendee count\n      const { count: attendeeCount, error: rsvpError } = await supabase\n        .from('rsvps')\n        .select('*', { count: 'exact', head: true })\n        .eq('activity_id', activity.id)\n        .eq('status', 'attending');\n\n      if (rsvpError) {\n        return {\n          success: false,\n          error: {\n            code: ERROR_CODES.DATABASE_ERROR,\n            message: rsvpError.message,\n            details: rsvpError,\n          },\n        };\n      }\n\n      const currentAttendees = attendeeCount || 0;\n      const capacity = activity.capacity;\n\n      let utilizationRate = 0;\n      let availableSpots: number | null = null;\n      let status: ActivityCapacityReport['status'] = 'unlimited';\n\n      if (capacity !== null && capacity > 0) {\n        utilizationRate = (currentAttendees / capacity) * 100;\n        availableSpots = capacity - currentAttendees;\n\n        if (utilizationRate >= 100) {\n          status = 'at_capacity';\n        } else if (utilizationRate > 100) {\n          status = 'over_capacity';\n        } else if (utilizationRate >= 90) {\n          status = 'near_capacity';\n        } else {\n          status = 'available';\n        }\n      }\n\n      reports.push({\n        activityId: activity.id,\n        activityName: activity.name,\n        capacity,\n        currentAttendees,\n        utilizationRate: Math.round(utilizationRate * 100) / 100,\n        availableSpots,\n        status,\n      });\n    }\n\n    return {\n      success: true,\n      data: reports,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Generates accommodation occupancy report.\n * \n * @param accommodationId - Optional accommodation ID to get report for specific accommodation\n * @returns Result containing accommodation occupancy reports or error details\n * \n * Requirements: 15.3\n */\nexport async function getAccommodationOccupancyReport(\n  accommodationId?: string\n): Promise<Result<AccommodationOccupancyReport[]>> {\n  try {\n    // Build query\n    let query = supabase\n      .from('accommodations')\n      .select('id, name')\n      .eq('status', 'published');\n\n    if (accommodationId) {\n      query = query.eq('id', accommodationId);\n    }\n\n    const { data: accommodations, error: accommodationError } = await query;\n\n    if (accommodationError) {\n      return {\n        success: false,\n        error: {\n          code: ERROR_CODES.DATABASE_ERROR,\n          message: accommodationError.message,\n          details: accommodationError,\n        },\n      };\n    }\n\n    const reports: AccommodationOccupancyReport[] = [];\n\n    // Calculate occupancy for each accommodation\n    for (const accommodation of accommodations) {\n      // Get room types for this accommodation\n      const { data: roomTypes, error: roomTypeError } = await supabase\n        .from('room_types')\n        .select('id, name, total_rooms')\n        .eq('accommodation_id', accommodation.id)\n        .eq('status', 'published');\n\n      if (roomTypeError) {\n        return {\n          success: false,\n          error: {\n            code: ERROR_CODES.DATABASE_ERROR,\n            message: roomTypeError.message,\n            details: roomTypeError,\n          },\n        };\n      }\n\n      const roomTypeReports = [];\n      let totalRooms = 0;\n      let totalAssigned = 0;\n\n      for (const roomType of roomTypes) {\n        // Count assigned rooms for this room type\n        const { count: assignedCount, error: assignmentError } = await supabase\n          .from('room_assignments')\n          .select('room_type_id', { count: 'exact', head: true })\n          .eq('room_type_id', roomType.id);\n\n        if (assignmentError) {\n          return {\n            success: false,\n            error: {\n              code: ERROR_CODES.DATABASE_ERROR,\n              message: assignmentError.message,\n              details: assignmentError,\n            },\n          };\n        }\n\n        const assignedRooms = assignedCount || 0;\n        const occupancyRate = roomType.total_rooms > 0\n          ? (assignedRooms / roomType.total_rooms) * 100\n          : 0;\n        const availableRooms = roomType.total_rooms - assignedRooms;\n\n        roomTypeReports.push({\n          roomTypeId: roomType.id,\n          roomTypeName: roomType.name,\n          totalRooms: roomType.total_rooms,\n          assignedRooms,\n          occupancyRate: Math.round(occupancyRate * 100) / 100,\n          availableRooms,\n        });\n\n        totalRooms += roomType.total_rooms;\n        totalAssigned += assignedRooms;\n      }\n\n      const overallOccupancyRate = totalRooms > 0\n        ? (totalAssigned / totalRooms) * 100\n        : 0;\n\n      reports.push({\n        accommodationId: accommodation.id,\n        accommodationName: accommodation.name,\n        roomTypes: roomTypeReports,\n        totalRooms,\n        totalAssigned,\n        overallOccupancyRate: Math.round(overallOccupancyRate * 100) / 100,\n      });\n    }\n\n    return {\n      success: true,\n      data: reports,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n\n/**\n * Generates comprehensive capacity utilization report.\n * \n * @returns Result containing complete capacity utilization report or error details\n * \n * Requirements: 15.3\n */\nexport async function getCapacityUtilizationReport(): Promise<Result<CapacityUtilizationReport>> {\n  try {\n    // Get activity capacity reports\n    const activityResult = await getActivityCapacityReport();\n    if (!activityResult.success) {\n      return activityResult as Result<CapacityUtilizationReport>;\n    }\n\n    // Get accommodation occupancy reports\n    const accommodationResult = await getAccommodationOccupancyReport();\n    if (!accommodationResult.success) {\n      return accommodationResult as Result<CapacityUtilizationReport>;\n    }\n\n    const activities = activityResult.data;\n    const accommodations = accommodationResult.data;\n\n    // Calculate summary statistics\n    const activitiesNearCapacity = activities.filter(a => a.status === 'near_capacity').length;\n    const activitiesAtCapacity = activities.filter(a => a.status === 'at_capacity' || a.status === 'over_capacity').length;\n\n    const averageOccupancyRate = accommodations.length > 0\n      ? accommodations.reduce((sum, a) => sum + a.overallOccupancyRate, 0) / accommodations.length\n      : 0;\n\n    return {\n      success: true,\n      data: {\n        activities,\n        accommodations,\n        summary: {\n          totalActivities: activities.length,\n          activitiesNearCapacity,\n          activitiesAtCapacity,\n          totalAccommodations: accommodations.length,\n          averageOccupancyRate: Math.round(averageOccupancyRate * 100) / 100,\n        },\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: ERROR_CODES.UNKNOWN_ERROR,\n        message: error instanceof Error ? error.message : 'Unknown error',\n      },\n    };\n  }\n}\n"],"names":["getAccommodationOccupancyReport","getActivityCapacityReport","getCapacityUtilizationReport","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","supabaseKey","NEXT_PUBLIC_SUPABASE_ANON_KEY","supabase","createClient","activityId","query","from","select","eq","data","activities","error","activityError","success","code","ERROR_CODES","DATABASE_ERROR","message","details","reports","activity","count","attendeeCount","rsvpError","head","id","currentAttendees","capacity","utilizationRate","availableSpots","status","push","activityName","name","Math","round","UNKNOWN_ERROR","Error","accommodationId","accommodations","accommodationError","accommodation","roomTypes","roomTypeError","roomTypeReports","totalRooms","totalAssigned","roomType","assignedCount","assignmentError","assignedRooms","occupancyRate","total_rooms","availableRooms","roomTypeId","roomTypeName","overallOccupancyRate","accommodationName","activityResult","accommodationResult","activitiesNearCapacity","filter","a","length","activitiesAtCapacity","averageOccupancyRate","reduce","sum","summary","totalActivities","totalAccommodations"],"mappings":"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"}