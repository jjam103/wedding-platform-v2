{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/deletedItemsCleanupService.test.ts"],"sourcesContent":["/**\n * Unit Tests: Deleted Items Cleanup Service\n * \n * Tests cleanup logic and date filtering.\n */\n\nimport { cleanupOldDeletedItems } from './deletedItemsCleanupService';\nimport { createContentPage, deleteContentPage } from './contentPagesService';\nimport { create as createEvent, deleteEvent } from './eventService';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ndescribe('Deleted Items Cleanup Service', () => {\n  beforeEach(async () => {\n    // Clean up test data\n    await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  afterAll(async () => {\n    // Final cleanup\n    await supabase.from('events').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n    await supabase.from('content_pages').delete().neq('id', '00000000-0000-0000-0000-000000000000');\n  });\n\n  it('should not delete items less than 30 days old', async () => {\n    // Create and soft delete an item\n    const createResult = await createContentPage({\n      title: 'Recent Page',\n      status: 'draft',\n    });\n\n    expect(createResult.success).toBe(true);\n    if (!createResult.success) return;\n\n    const pageId = createResult.data.id;\n    await deleteContentPage(pageId, { permanent: false });\n\n    // Run cleanup\n    const cleanupResult = await cleanupOldDeletedItems();\n    expect(cleanupResult.success).toBe(true);\n\n    // Verify item still exists (soft deleted)\n    const { data: page } = await supabase\n      .from('content_pages')\n      .select('id, deleted_at')\n      .eq('id', pageId)\n      .single();\n\n    expect(page).not.toBeNull();\n    expect(page?.deleted_at).not.toBeNull();\n\n    // Cleanup\n    await deleteContentPage(pageId, { permanent: true });\n  });\n\n  it('should delete items older than 30 days', async () => {\n    // Create and soft delete an item\n    const createResult = await createContentPage({\n      title: 'Old Page',\n      status: 'draft',\n    });\n\n    expect(createResult.success).toBe(true);\n    if (!createResult.success) return;\n\n    const pageId = createResult.data.id;\n    await deleteContentPage(pageId, { permanent: false });\n\n    // Manually set deleted_at to 31 days ago\n    const thirtyOneDaysAgo = new Date();\n    thirtyOneDaysAgo.setDate(thirtyOneDaysAgo.getDate() - 31);\n\n    await supabase\n      .from('content_pages')\n      .update({ deleted_at: thirtyOneDaysAgo.toISOString() })\n      .eq('id', pageId);\n\n    // Run cleanup\n    const cleanupResult = await cleanupOldDeletedItems();\n    expect(cleanupResult.success).toBe(true);\n    expect(cleanupResult.data.contentPages).toBeGreaterThanOrEqual(1);\n\n    // Verify item is permanently deleted\n    const { data: page } = await supabase\n      .from('content_pages')\n      .select('id')\n      .eq('id', pageId)\n      .single();\n\n    expect(page).toBeNull();\n  });\n\n  it('should return cleanup statistics', async () => {\n    // Create and soft delete multiple items\n    const page1Result = await createContentPage({\n      title: 'Old Page 1',\n      status: 'draft',\n    });\n    const page2Result = await createContentPage({\n      title: 'Old Page 2',\n      status: 'draft',\n    });\n\n    expect(page1Result.success).toBe(true);\n    expect(page2Result.success).toBe(true);\n    if (!page1Result.success || !page2Result.success) return;\n\n    await deleteContentPage(page1Result.data.id, { permanent: false });\n    await deleteContentPage(page2Result.data.id, { permanent: false });\n\n    // Set deleted_at to 31 days ago\n    const thirtyOneDaysAgo = new Date();\n    thirtyOneDaysAgo.setDate(thirtyOneDaysAgo.getDate() - 31);\n\n    await supabase\n      .from('content_pages')\n      .update({ deleted_at: thirtyOneDaysAgo.toISOString() })\n      .in('id', [page1Result.data.id, page2Result.data.id]);\n\n    // Run cleanup\n    const cleanupResult = await cleanupOldDeletedItems();\n    expect(cleanupResult.success).toBe(true);\n    expect(cleanupResult.data.contentPages).toBeGreaterThanOrEqual(2);\n    expect(cleanupResult.data.total).toBeGreaterThanOrEqual(2);\n  });\n\n  it('should handle cleanup with no items to delete', async () => {\n    // Run cleanup with no old items\n    const cleanupResult = await cleanupOldDeletedItems();\n    expect(cleanupResult.success).toBe(true);\n    expect(cleanupResult.data.total).toBeGreaterThanOrEqual(0);\n  });\n\n  it('should clean up multiple entity types', async () => {\n    // Create and soft delete items of different types\n    const pageResult = await createContentPage({\n      title: 'Old Page',\n      status: 'draft',\n    });\n    const eventResult = await createEvent({\n      name: 'Old Event',\n      date: new Date().toISOString().split('T')[0],\n    });\n\n    expect(pageResult.success).toBe(true);\n    expect(eventResult.success).toBe(true);\n    if (!pageResult.success || !eventResult.success) return;\n\n    await deleteContentPage(pageResult.data.id, { permanent: false });\n    await deleteEvent(eventResult.data.id, { permanent: false });\n\n    // Set deleted_at to 31 days ago\n    const thirtyOneDaysAgo = new Date();\n    thirtyOneDaysAgo.setDate(thirtyOneDaysAgo.getDate() - 31);\n\n    await supabase\n      .from('content_pages')\n      .update({ deleted_at: thirtyOneDaysAgo.toISOString() })\n      .eq('id', pageResult.data.id);\n\n    await supabase\n      .from('events')\n      .update({ deleted_at: thirtyOneDaysAgo.toISOString() })\n      .eq('id', eventResult.data.id);\n\n    // Run cleanup\n    const cleanupResult = await cleanupOldDeletedItems();\n    expect(cleanupResult.success).toBe(true);\n    expect(cleanupResult.data.contentPages).toBeGreaterThanOrEqual(1);\n    expect(cleanupResult.data.events).toBeGreaterThanOrEqual(1);\n    expect(cleanupResult.data.total).toBeGreaterThanOrEqual(2);\n  });\n});\n"],"names":["supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","describe","beforeEach","from","delete","neq","afterAll","it","createResult","createContentPage","title","status","expect","success","toBe","pageId","data","id","deleteContentPage","permanent","cleanupResult","cleanupOldDeletedItems","page","select","eq","single","not","toBeNull","deleted_at","thirtyOneDaysAgo","Date","setDate","getDate","update","toISOString","contentPages","toBeGreaterThanOrEqual","page1Result","page2Result","in","total","pageResult","eventResult","createEvent","name","date","split","deleteEvent","events"],"mappings":"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"}