{"version":3,"sources":["/Users/jaron/Desktop/wedding-platform-v2/services/photoService.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { sanitizeInput, sanitizeRichText } from \"../utils/sanitization\";\nimport {\n  createPhotoSchema,\n  updatePhotoSchema,\n  moderatePhotoSchema,\n  batchUploadSchema,\n  photoFilterSchema,\n  type CreatePhotoDTO,\n  type UpdatePhotoDTO,\n  type ModeratePhotoDTO,\n  type BatchUploadDTO,\n  type PhotoFilterDTO,\n} from '../schemas/photoSchemas';\nimport { uploadToB2, isB2Healthy, initializeB2Client } from './b2Service';\n\ntype Result<T> = \n  | { success: true; data: T } \n  | { success: false; error: { code: string; message: string; details?: any } };\n\n// Initialize Supabase client - Pattern A (testable)\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\n// Initialize B2 client if credentials are available\nif (\n  process.env.B2_APPLICATION_KEY_ID &&\n  process.env.B2_APPLICATION_KEY &&\n  process.env.B2_BUCKET_NAME\n) {\n  // B2 uses S3-compatible API with region-specific endpoints\n  // Default to us-west-004 which is the most common B2 region\n  const region = 'us-west-004';\n  const endpoint = `https://s3.${region}.backblazeb2.com`;\n  \n  const b2Config = {\n    endpoint,\n    region,\n    accessKeyId: process.env.B2_APPLICATION_KEY_ID,\n    secretAccessKey: process.env.B2_APPLICATION_KEY,\n    bucket: process.env.B2_BUCKET_NAME,\n    cdnDomain: process.env.CLOUDFLARE_CDN_URL?.replace(/^https?:\\/\\//, '') || '',\n  };\n  \n  const initResult = initializeB2Client(b2Config);\n  if (!initResult.success) {\n    console.warn('Failed to initialize B2 client:', initResult.error.message);\n    console.warn('Photo uploads will use Supabase Storage only');\n  } else {\n    console.log('âœ“ B2 client initialized successfully');\n  }\n} else {\n  console.warn('B2 credentials not configured - using Supabase Storage only');\n}\n\ninterface Photo {\n  id: string;\n  uploader_id: string;\n  photo_url: string;\n  storage_type: 'b2' | 'supabase';\n  page_type: 'event' | 'activity' | 'accommodation' | 'memory';\n  page_id?: string;\n  caption?: string;\n  alt_text?: string;\n  moderation_status: 'pending' | 'approved' | 'rejected';\n  moderation_reason?: string;\n  display_order?: number;\n  created_at: string;\n  moderated_at?: string;\n  updated_at: string;\n}\n\n/**\n * Uploads a photo with automatic storage selection and failover.\n * Tries B2 first, falls back to Supabase Storage if B2 is unavailable.\n * \n * @param file - File buffer to upload\n * @param fileName - Original filename\n * @param contentType - MIME type\n * @param metadata - Photo metadata (uploader, page info, caption, etc.)\n * @returns Result containing the created photo record\n * \n * @example\n * const result = await uploadPhoto(\n *   fileBuffer,\n *   'wedding-photo.jpg',\n *   'image/jpeg',\n *   {\n *     uploader_id: 'user-123',\n *     page_type: 'memory',\n *     caption: 'Beautiful sunset ceremony'\n *   }\n * );\n */\nexport async function uploadPhoto(\n  file: Buffer,\n  fileName: string,\n  contentType: string,\n  metadata: Omit<CreatePhotoDTO, 'photo_url' | 'storage_type'>\n): Promise<Result<Photo>> {\n  try {\n    // 1. Validate metadata\n    const metadataValidation = createPhotoSchema.omit({ photo_url: true, storage_type: true }).safeParse(metadata);\n    if (!metadataValidation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid photo metadata',\n          details: metadataValidation.error.issues,\n        },\n      };\n    }\n\n    // 2. Sanitize text fields\n    const sanitizedMetadata = {\n      ...metadataValidation.data,\n      caption: metadataValidation.data.caption\n        ? sanitizeInput(metadataValidation.data.caption)\n        : undefined,\n      alt_text: metadataValidation.data.alt_text\n        ? sanitizeInput(metadataValidation.data.alt_text)\n        : undefined,\n    };\n\n    // 3. Check B2 health and attempt upload\n    const b2HealthResult = await isB2Healthy();\n    let photoUrl: string;\n    let storageType: 'b2' | 'supabase';\n\n    if (b2HealthResult.success && b2HealthResult.data) {\n      // Try B2 upload\n      const b2Result = await uploadToB2(file, fileName, contentType);\n      if (b2Result.success) {\n        photoUrl = b2Result.data.url;\n        storageType = 'b2';\n      } else {\n        // B2 failed, fallback to Supabase\n        const supabaseResult = await uploadToSupabaseStorage(file, fileName, contentType);\n        if (!supabaseResult.success) {\n          return supabaseResult;\n        }\n        photoUrl = supabaseResult.data.url;\n        storageType = 'supabase';\n      }\n    } else {\n      // B2 unhealthy, use Supabase directly\n      const supabaseResult = await uploadToSupabaseStorage(file, fileName, contentType);\n      if (!supabaseResult.success) {\n        return supabaseResult;\n      }\n      photoUrl = supabaseResult.data.url;\n      storageType = 'supabase';\n    }\n\n    // 4. Create photo record in database\n    const photoData: CreatePhotoDTO = {\n      ...sanitizedMetadata,\n      photo_url: photoUrl,\n      storage_type: storageType,\n    };\n\n    const { data, error } = await supabase\n      .from('photos')\n      .insert(photoData)\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error during photo upload',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Uploads a file to Supabase Storage as fallback.\n * \n * @param file - File buffer\n * @param fileName - Original filename\n * @param contentType - MIME type\n * @returns Result containing the storage URL\n */\nasync function uploadToSupabaseStorage(\n  file: Buffer,\n  fileName: string,\n  contentType: string\n): Promise<Result<{ url: string; key: string }>> {\n  try {\n    // Sanitize filename\n    const sanitizedFileName = sanitizeInput(fileName).replace(/[^a-zA-Z0-9._-]/g, '_');\n\n    const timestamp = Date.now();\n    const key = `photos/${timestamp}-${sanitizedFileName}`;\n\n    const { data, error } = await supabase.storage\n      .from('photos')\n      .upload(key, file, {\n        contentType,\n        cacheControl: '31536000', // 1 year\n      });\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'STORAGE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    // Get public URL\n    const { data: urlData } = supabase.storage\n      .from('photos')\n      .getPublicUrl(data.path);\n\n    return {\n      success: true,\n      data: {\n        url: urlData.publicUrl,\n        key: data.path,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'STORAGE_ERROR',\n        message: error instanceof Error ? error.message : 'Failed to upload to Supabase Storage',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Uploads multiple photos in batch.\n * \n * @param uploads - Array of photo uploads with file data and metadata\n * @returns Result containing array of created photo records\n */\nexport async function batchUploadPhotos(\n  uploads: Array<{\n    file: Buffer;\n    fileName: string;\n    contentType: string;\n    metadata: Omit<CreatePhotoDTO, 'photo_url' | 'storage_type'>;\n  }>\n): Promise<Result<Photo[]>> {\n  try {\n    if (uploads.length === 0) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'No photos provided for batch upload',\n        },\n      };\n    }\n\n    if (uploads.length > 50) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Batch upload limited to 50 photos at a time',\n        },\n      };\n    }\n\n    const results: Photo[] = [];\n    const errors: any[] = [];\n\n    for (const upload of uploads) {\n      const result = await uploadPhoto(\n        upload.file,\n        upload.fileName,\n        upload.contentType,\n        upload.metadata\n      );\n\n      if (result.success) {\n        results.push(result.data);\n      } else {\n        errors.push({\n          fileName: upload.fileName,\n          error: result.error,\n        });\n      }\n    }\n\n    if (errors.length > 0) {\n      return {\n        success: false,\n        error: {\n          code: 'BATCH_UPLOAD_PARTIAL_FAILURE',\n          message: `${errors.length} of ${uploads.length} photos failed to upload`,\n          details: { successful: results.length, failed: errors.length, errors },\n        },\n      };\n    }\n\n    return { success: true, data: results };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error during batch upload',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Gets a photo by ID.\n * \n * @param id - Photo ID\n * @returns Result containing the photo record\n */\nexport async function getPhoto(id: string): Promise<Result<Photo>> {\n  try {\n    const { data, error } = await supabase\n      .from('photos')\n      .select('*')\n      .eq('id', id)\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: error.code === 'PGRST116' ? 'NOT_FOUND' : 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Lists photos with filtering and pagination.\n * \n * @param filters - Filter criteria (page type, moderation status, etc.)\n * @returns Result containing array of photos and total count\n */\nexport async function listPhotos(\n  filters: PhotoFilterDTO\n): Promise<Result<{ photos: Photo[]; total: number }>> {\n  try {\n    // Validate filters\n    const validation = photoFilterSchema.safeParse(filters);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid filter parameters',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    const { page_type, page_id, moderation_status, uploader_id, limit, offset } = validation.data;\n\n    let query = supabase.from('photos').select('*', { count: 'exact' });\n\n    if (page_type) {\n      query = query.eq('page_type', page_type);\n    }\n    if (page_id) {\n      query = query.eq('page_id', page_id);\n    }\n    if (moderation_status) {\n      query = query.eq('moderation_status', moderation_status);\n    }\n    if (uploader_id) {\n      query = query.eq('uploader_id', uploader_id);\n    }\n\n    query = query\n      .order('created_at', { ascending: false })\n      .range(offset, offset + limit - 1);\n\n    const { data, error, count } = await query;\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return {\n      success: true,\n      data: {\n        photos: data || [],\n        total: count || 0,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Moderates a photo (approve or reject).\n * \n * @param id - Photo ID\n * @param moderation - Moderation decision and optional reason\n * @returns Result containing the updated photo\n */\nexport async function moderatePhoto(\n  id: string,\n  moderation: ModeratePhotoDTO\n): Promise<Result<Photo>> {\n  try {\n    // Validate moderation data\n    const validation = moderatePhotoSchema.safeParse(moderation);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid moderation data',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // Sanitize moderation reason\n    const sanitizedReason = validation.data.moderation_reason\n      ? sanitizeInput(validation.data.moderation_reason)\n      : undefined;\n\n    const { data, error } = await supabase\n      .from('photos')\n      .update({\n        moderation_status: validation.data.moderation_status,\n        moderation_reason: sanitizedReason,\n        moderated_at: new Date().toISOString(),\n      })\n      .eq('id', id)\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: error.code === 'PGRST116' ? 'NOT_FOUND' : 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Updates photo metadata (caption, alt text, display order).\n * \n * @param id - Photo ID\n * @param updates - Fields to update\n * @returns Result containing the updated photo\n */\nexport async function updatePhoto(\n  id: string,\n  updates: UpdatePhotoDTO\n): Promise<Result<Photo>> {\n  try {\n    // Validate updates\n    const validation = updatePhotoSchema.safeParse(updates);\n    if (!validation.success) {\n      return {\n        success: false,\n        error: {\n          code: 'VALIDATION_ERROR',\n          message: 'Invalid update data',\n          details: validation.error.issues,\n        },\n      };\n    }\n\n    // Sanitize text fields\n    const sanitizedUpdates = {\n      ...validation.data,\n      caption: validation.data.caption\n        ? sanitizeInput(validation.data.caption)\n        : undefined,\n      alt_text: validation.data.alt_text\n        ? sanitizeInput(validation.data.alt_text)\n        : undefined,\n    };\n\n    const { data, error } = await supabase\n      .from('photos')\n      .update(sanitizedUpdates)\n      .eq('id', id)\n      .select()\n      .single();\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: error.code === 'PGRST116' ? 'NOT_FOUND' : 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Deletes a photo.\n * \n * @param id - Photo ID\n * @returns Result indicating success or failure\n */\nexport async function deletePhoto(id: string): Promise<Result<void>> {\n  try {\n    const { error } = await supabase\n      .from('photos')\n      .delete()\n      .eq('id', id);\n\n    if (error) {\n      return {\n        success: false,\n        error: {\n          code: 'DATABASE_ERROR',\n          message: error.message,\n          details: error,\n        },\n      };\n    }\n\n    return { success: true, data: undefined };\n  } catch (error) {\n    return {\n      success: false,\n      error: {\n        code: 'UNKNOWN_ERROR',\n        message: error instanceof Error ? error.message : 'Unknown error',\n        details: error,\n      },\n    };\n  }\n}\n\n/**\n * Gets photos pending moderation.\n * \n * @param limit - Maximum number of photos to return\n * @returns Result containing array of pending photos\n */\nexport async function getPendingPhotos(limit: number = 50): Promise<Result<Photo[]>> {\n  return listPhotos({\n    moderation_status: 'pending',\n    limit,\n    offset: 0,\n  }).then(result => {\n    if (result.success) {\n      return { success: true, data: result.data.photos };\n    }\n    return result;\n  });\n}\n"],"names":["batchUploadPhotos","deletePhoto","getPendingPhotos","getPhoto","listPhotos","moderatePhoto","updatePhoto","uploadPhoto","supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","B2_APPLICATION_KEY_ID","B2_APPLICATION_KEY","B2_BUCKET_NAME","region","endpoint","b2Config","accessKeyId","secretAccessKey","bucket","cdnDomain","CLOUDFLARE_CDN_URL","replace","initResult","initializeB2Client","success","console","warn","error","message","log","file","fileName","contentType","metadata","metadataValidation","createPhotoSchema","omit","photo_url","storage_type","safeParse","code","details","issues","sanitizedMetadata","data","caption","sanitizeInput","undefined","alt_text","b2HealthResult","isB2Healthy","photoUrl","storageType","b2Result","uploadToB2","url","supabaseResult","uploadToSupabaseStorage","photoData","from","insert","select","single","Error","sanitizedFileName","timestamp","Date","now","key","storage","upload","cacheControl","urlData","getPublicUrl","path","publicUrl","uploads","length","results","errors","result","push","successful","failed","id","eq","filters","validation","photoFilterSchema","page_type","page_id","moderation_status","uploader_id","limit","offset","query","count","order","ascending","range","photos","total","moderation","moderatePhotoSchema","sanitizedReason","moderation_reason","update","moderated_at","toISOString","updates","updatePhotoSchema","sanitizedUpdates","delete","then"],"mappings":"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"}