
> destination-wedding-platform@0.1.0 test:e2e
> playwright test __tests__/e2e/auth/guestAuth.spec.ts --grep should show success message after requesting magic link

[dotenv@17.2.4] injecting env (24) from .env.e2e -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
[2m[WebServer] [22m
[2m[WebServer] [22m> destination-wedding-platform@0.1.0 dev
[2m[WebServer] [22m> next dev --webpack
[2m[WebServer] [22m
[2m[WebServer] [22m[1m[38;2;173;127;168mâ–² Next.js 16.1.1[39m[22m (webpack)
[2m[WebServer] [22m- Local:         http://localhost:3000
[2m[WebServer] [22m- Network:       http://192.168.7.238:3000
[2m[WebServer] [22m- Environments: .env.test
[2m[WebServer] [22m
[2m[WebServer] [22m[32m[1mâœ“[22m[39m Starting...
[2m[WebServer] [22m[33m[1mâš [22m[39m The "middleware" file convention is deprecated. Please use "proxy" instead. Learn more: https://nextjs.org/docs/messages/middleware-to-proxy
[2m[WebServer] [22m[32m[1mâœ“[22m[39m Ready in 1453ms
[2m[WebServer] [22m GET / [33m404[39m in 2.7s[2m (compile: 2.6s, render: 84ms)[22m
[2m[WebServer] [22m GET /index.html [33m404[39m in 120ms[2m (compile: 7ms, proxy.ts: 94ms, render: 19ms)[22m

ğŸš€ E2E Global Setup Starting...

ğŸ“Š Verifying test database connection...
[2m[WebServer] [22m GET / [32m200[39m in 773ms[2m (compile: 707ms, proxy.ts: 9ms, render: 57ms)[22m
âœ… Test database connected

ğŸ§¹ Cleaning up test data...
   Cleaning up leftover test data...
   Test data cleanup complete
âœ… Test data cleaned

ğŸ‘¤ Creating test guest...
   Created warmup guest: warmup@example.com (ID: c64485f7-a44c-4b83-9a10-a0a2255ec646)
   Created test guest: test@example.com (ID: 6c5f9f3c-8c55-4484-b5a1-6e8ea0bd720c)
âœ… Test guest created

ğŸ“¦ Creating comprehensive test data...
   Creating location hierarchy...
   Location hierarchy already exists
   Creating events...
   Events already exist
   Creating activities...
   Warning: Could not create comprehensive test data: Failed to create ceremony activity: Could not find the 'cost_per_guest' column of 'activities' in the schema cache
   Some E2E tests may fail due to missing data
âœ… Comprehensive test data created

ğŸŒ Verifying Next.js server...
âœ… Next.js server is running

ğŸ”¥ Warming up API routes...
   Warming up 3 guest auth routes with retry logic...
[2m[WebServer] [22m GET / [32m200[39m in 42ms[2m (compile: 3ms, proxy.ts: 13ms, render: 26ms)[22m
[2m[WebServer] [22m[API] Looking for guest with email: warmup@example.com
[2m[WebServer] [22m[API] Guest query result: {
[2m[WebServer] [22m  found: [33mtrue[39m,
[2m[WebServer] [22m  email: [32m'warmup@example.com'[39m,
[2m[WebServer] [22m  authMethod: [32m'email_matching'[39m,
[2m[WebServer] [22m  error: [90mundefined[39m
[2m[WebServer] [22m}
[2m[WebServer] [22m[API] Setting guest session cookie: {
[2m[WebServer] [22m  tokenPrefix: [32m'c739673e'[39m,
[2m[WebServer] [22m  cookieOptions: {
[2m[WebServer] [22m    httpOnly: [33mtrue[39m,
[2m[WebServer] [22m    secure: [33mfalse[39m,
[2m[WebServer] [22m    sameSite: [32m'lax'[39m,
[2m[WebServer] [22m    maxAge: [33m86400[39m,
[2m[WebServer] [22m    path: [32m'/'[39m
[2m[WebServer] [22m  },
[2m[WebServer] [22m  guestId: [32m'c64485f7-a44c-4b83-9a10-a0a2255ec646'[39m,
[2m[WebServer] [22m  sessionId: [32m'706dd689-f588-4809-b424-e22c4146bc24'[39m
[2m[WebServer] [22m}
   âœ… Route ready: /api/guest-auth/email-match (attempt 1/5, status: 200)
[2m[WebServer] [22m POST /api/guest-auth/email-match [32m200[39m in 840ms[2m (compile: 413ms, proxy.ts: 8ms, render: 419ms)[22m
[2m[WebServer] [22m[Magic Link Request] Processing request for email: warmup@example.com
[2m[WebServer] [22m[Magic Link Request] Looking for guest by email...
[2m[WebServer] [22m[Magic Link Request] Guest query result: {
[2m[WebServer] [22m  found: [33mtrue[39m,
[2m[WebServer] [22m  guestId: [32m'c64485f7-a44c-4b83-9a10-a0a2255ec646'[39m,
[2m[WebServer] [22m  authMethod: [32m'email_matching'[39m,
[2m[WebServer] [22m  error: [90mundefined[39m
[2m[WebServer] [22m}
[2m[WebServer] [22m[Magic Link Request] Guest has wrong auth method: email_matching
   âœ… Route ready: /api/guest-auth/magic-link/request (attempt 1/5, status: 400)
[2m[WebServer] [22m POST /api/guest-auth/magic-link/request [33m400[39m in 337ms[2m (compile: 161ms, proxy.ts: 6ms, render: 170ms)[22m
   âœ… Route ready: /api/guest-auth/magic-link/verify (attempt 1/5, status: 400)
[2m[WebServer] [22m POST /api/guest-auth/magic-link/verify [33m400[39m in 993ms[2m (compile: 810ms, proxy.ts: 15ms, render: 169ms)[22m
   âœ… Guest auth routes warmup complete
âœ… API routes warmed up

ğŸ” Setting up admin authentication...
   Attempting browser-based admin login: admin@example.com
   Created .auth directory: /Users/jaron/Desktop/wedding-platform-v2/.auth
   Navigating to http://localhost:3000/auth/login...
[2m[WebServer] [22m GET /auth/login [32m200[39m in 1103ms[2m (compile: 997ms, proxy.ts: 5ms, render: 102ms)[22m
   Page loaded, filling form...
   Form filled, submitting...
[2m[WebServer] [22m[Middleware] User authenticated: e7f5ae65-376e-4d05-a18c-10a91295727a
[2m[WebServer] [22m[Middleware] Admin user data query result: { userData: { role: 'owner', status: 'active' }, userError: null }
[2m[WebServer] [22m[Middleware] Access granted for admin role: owner
[2m[WebServer] [22m[33m[1mâš [22m[39m Fast Refresh had to perform a full reload. Read more: https://nextjs.org/docs/messages/fast-refresh-reload
[2m[WebServer] [22m GET /admin [32m200[39m in 826ms[2m (compile: 430ms, proxy.ts: 293ms, render: 103ms)[22m
   Current URL after submit: http://localhost:3000/admin
   âœ… Successfully logged in via browser
   âœ… Authentication state saved
âœ… Admin authentication saved

âœ¨ E2E Global Setup Complete!


Running 1 test using 1 worker

[dotenv@17.2.4] injecting env (0) from .env.e2e -- tip: âš™ï¸  override existing env vars with { override: true }
[Worker 0] Created test guest: {
  email: [32m'test-w0-1770449849288-7i43ezhl@example.com'[39m,
  id: [32m'11e88ba1-126e-432a-92f0-bea299e06fdc'[39m,
  authMethod: [32m'email_matching'[39m,
  groupId: [32m'c0155159-0c0b-4ce6-bf00-568cb2a12f67'[39m
}
[Worker 0] âœ… Verified guest exists: {
  email: [32m'test-w0-1770449849288-7i43ezhl@example.com'[39m,
  authMethod: [32m'email_matching'[39m
}
[2m[WebServer] [22m GET /auth/guest-login [32m200[39m in 554ms[2m (compile: 482ms, proxy.ts: 11ms, render: 61ms)[22m
[2m[WebServer] [22m[Magic Link Request] Processing request for email: test-w0-1770449849288-7i43ezhl@example.com
[2m[WebServer] [22m[Magic Link Request] Looking for guest by email...
[2m[WebServer] [22m[Magic Link Request] Guest query result: {
[2m[WebServer] [22m  found: [33mtrue[39m,
[2m[WebServer] [22m  guestId: [32m'11e88ba1-126e-432a-92f0-bea299e06fdc'[39m,
[2m[WebServer] [22m  authMethod: [32m'magic_link'[39m,
[2m[WebServer] [22m  error: [90mundefined[39m
[2m[WebServer] [22m}
[2m[WebServer] [22mMagic link for test-w0-1770449849288-7i43ezhl@example.com: http://localhost:3000/auth/guest-login/verify?token=08dacffc60245f5859ee701545c1be9c722f6720651f9d6a6a498e526d3b794c
[2m[WebServer] [22m POST /api/guest-auth/magic-link/request [32m200[39m in 418ms[2m (compile: 38ms, proxy.ts: 6ms, render: 374ms)[22m
  âœ“  1 [chromium] â€º __tests__/e2e/auth/guestAuth.spec.ts:362:7 â€º Guest Authentication â€º should show success message after requesting magic link (10.6s)

ğŸ§¹ E2E Global Teardown Starting...

ğŸ—‘ï¸  Cleaning up test data...
ğŸ§¹ Running comprehensive test cleanup...
âœ… Comprehensive cleanup complete
âœ… Test data cleaned

ğŸ”“ Removing authentication state...
   Removed: .auth/user.json
   Removed empty .auth directory
âœ… Authentication state removed

ğŸ“Š Execution Summary:
   Duration: 2.25s
   Errors: 0
   Status: âœ… Clean teardown

âœ¨ E2E Global Teardown Complete!


  1 passed (30.6s)

To open last HTML report run:
[36m[39m
[36m  npx playwright show-report[39m
[36m[39m
