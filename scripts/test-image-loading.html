<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Loading Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-image {
      max-width: 300px;
      height: auto;
      border: 2px solid #ddd;
      border-radius: 4px;
      margin: 10px 0;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .warning { background: #fff3cd; color: #856404; }
    h1 { color: #333; }
    h2 { color: #666; margin-top: 0; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
  </style>
</head>
<body>
  <h1>üñºÔ∏è Image Loading Diagnostic Test</h1>
  
  <div class="test-section">
    <h2>Test 1: Direct CDN URL</h2>
    <p>Testing a known working CDN URL:</p>
    <div id="test1-status" class="status info">Loading...</div>
    <img 
      id="test1-img"
      class="test-image"
      src="https://cdn.jamara.us/photos/1770094855401-IMG_0627.jpeg"
      alt="Test image 1"
    />
  </div>

  <div class="test-section">
    <h2>Test 2: Fetch API Test</h2>
    <p>Testing if the browser can fetch the image:</p>
    <div id="test2-status" class="status info">Testing...</div>
  </div>

  <div class="test-section">
    <h2>Test 3: CORS Headers</h2>
    <p>Checking CORS headers from CDN:</p>
    <div id="test3-status" class="status info">Testing...</div>
  </div>

  <div class="test-section">
    <h2>Test 4: Database Photos</h2>
    <p>Loading photos from database:</p>
    <div id="test4-status" class="status info">Loading...</div>
    <div id="test4-images"></div>
  </div>

  <div class="test-section">
    <h2>Console Output</h2>
    <p>Check browser console (F12) for detailed logs</p>
    <div id="console-output" class="status info"></div>
  </div>

  <script>
    const consoleOutput = document.getElementById('console-output');
    const originalLog = console.log;
    const originalError = console.error;
    
    // Capture console output
    console.log = function(...args) {
      originalLog.apply(console, args);
      consoleOutput.innerHTML += args.join(' ') + '<br>';
    };
    console.error = function(...args) {
      originalError.apply(console, args);
      consoleOutput.innerHTML += '<span style="color: red;">' + args.join(' ') + '</span><br>';
    };

    // Test 1: Direct image load
    const test1Img = document.getElementById('test1-img');
    const test1Status = document.getElementById('test1-status');
    
    test1Img.onload = function() {
      console.log('‚úÖ Test 1: Image loaded successfully');
      console.log('   Natural size:', this.naturalWidth, 'x', this.naturalHeight);
      test1Status.className = 'status success';
      test1Status.textContent = '‚úÖ Image loaded successfully (' + this.naturalWidth + 'x' + this.naturalHeight + ')';
    };
    
    test1Img.onerror = function(e) {
      console.error('‚ùå Test 1: Image failed to load');
      console.error('   Error event:', e);
      test1Status.className = 'status error';
      test1Status.textContent = '‚ùå Image failed to load';
    };

    // Test 2: Fetch API
    async function test2() {
      const test2Status = document.getElementById('test2-status');
      try {
        console.log('üß™ Test 2: Fetching image with Fetch API...');
        const response = await fetch('https://cdn.jamara.us/photos/1770094855401-IMG_0627.jpeg');
        console.log('   Status:', response.status, response.statusText);
        console.log('   Content-Type:', response.headers.get('content-type'));
        console.log('   CF-Cache-Status:', response.headers.get('cf-cache-status'));
        
        if (response.ok) {
          const blob = await response.blob();
          console.log('   Blob size:', blob.size, 'bytes');
          console.log('   Blob type:', blob.type);
          test2Status.className = 'status success';
          test2Status.innerHTML = '‚úÖ Fetch successful<br>' +
            'Status: ' + response.status + '<br>' +
            'Content-Type: ' + response.headers.get('content-type') + '<br>' +
            'Size: ' + blob.size + ' bytes';
        } else {
          throw new Error('HTTP ' + response.status);
        }
      } catch (error) {
        console.error('‚ùå Test 2: Fetch failed:', error);
        test2Status.className = 'status error';
        test2Status.textContent = '‚ùå Fetch failed: ' + error.message;
      }
    }

    // Test 3: CORS check
    async function test3() {
      const test3Status = document.getElementById('test3-status');
      try {
        console.log('üß™ Test 3: Checking CORS headers...');
        const response = await fetch('https://cdn.jamara.us/photos/1770094855401-IMG_0627.jpeg', {
          method: 'HEAD'
        });
        
        const corsHeaders = {
          'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
          'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
          'access-control-allow-headers': response.headers.get('access-control-allow-headers'),
        };
        
        console.log('   CORS headers:', corsHeaders);
        
        test3Status.className = 'status success';
        test3Status.innerHTML = '‚úÖ CORS check complete<br>' +
          'Access-Control-Allow-Origin: ' + (corsHeaders['access-control-allow-origin'] || 'Not set') + '<br>' +
          'Note: CORS headers are not required for images';
      } catch (error) {
        console.error('‚ùå Test 3: CORS check failed:', error);
        test3Status.className = 'status error';
        test3Status.textContent = '‚ùå CORS check failed: ' + error.message;
      }
    }

    // Test 4: Load from database
    async function test4() {
      const test4Status = document.getElementById('test4-status');
      const test4Images = document.getElementById('test4-images');
      
      try {
        console.log('üß™ Test 4: Loading photos from database...');
        
        // Note: This will fail if not running on the actual site
        // You'll need to run this from the actual admin page
        const response = await fetch('/api/admin/photos?moderation_status=approved&limit=5');
        
        if (!response.ok) {
          throw new Error('API returned ' + response.status);
        }
        
        const result = await response.json();
        console.log('   API response:', result);
        
        if (result.success && result.data.photos.length > 0) {
          console.log('   Found', result.data.photos.length, 'photos');
          
          test4Status.className = 'status success';
          test4Status.textContent = '‚úÖ Loaded ' + result.data.photos.length + ' photos from database';
          
          result.data.photos.forEach((photo, index) => {
            console.log('   Photo', index + 1, ':', photo.photo_url);
            
            const container = document.createElement('div');
            container.style.marginBottom = '20px';
            
            const url = document.createElement('div');
            url.textContent = 'URL: ' + photo.photo_url;
            url.style.fontSize = '12px';
            url.style.marginBottom = '5px';
            url.style.wordBreak = 'break-all';
            container.appendChild(url);
            
            const img = document.createElement('img');
            img.src = photo.photo_url;
            img.className = 'test-image';
            img.alt = photo.alt_text || 'Photo ' + (index + 1);
            
            const status = document.createElement('div');
            status.className = 'status info';
            status.textContent = 'Loading...';
            
            img.onload = function() {
              console.log('   ‚úÖ Photo', index + 1, 'loaded:', this.naturalWidth, 'x', this.naturalHeight);
              status.className = 'status success';
              status.textContent = '‚úÖ Loaded (' + this.naturalWidth + 'x' + this.naturalHeight + ')';
            };
            
            img.onerror = function(e) {
              console.error('   ‚ùå Photo', index + 1, 'failed to load');
              console.error('      Error:', e);
              status.className = 'status error';
              status.textContent = '‚ùå Failed to load';
            };
            
            container.appendChild(img);
            container.appendChild(status);
            test4Images.appendChild(container);
          });
        } else {
          test4Status.className = 'status warning';
          test4Status.textContent = '‚ö†Ô∏è No photos found in database';
        }
      } catch (error) {
        console.error('‚ùå Test 4: Database load failed:', error);
        test4Status.className = 'status error';
        test4Status.textContent = '‚ùå Database load failed: ' + error.message + ' (This test only works on the actual site)';
      }
    }

    // Run tests
    console.log('üöÄ Starting diagnostic tests...');
    test2();
    test3();
    test4();
  </script>
</body>
</html>
